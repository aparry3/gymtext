module.exports=[918622,(e,t,s)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},193695,(e,t,s)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},967255,(e,t,s)=>{t.exports=e.x("pg",()=>require("pg"))},166238,(e,t,s)=>{},791146,832821,437234,e=>{"use strict";e.i(166238),e.i(454188);var t=e.i(331612);let s=t.z.object({DATABASE_URL:t.z.string().min(1,"DATABASE_URL is required"),SESSION_ENCRYPTION_KEY:t.z.string().optional(),TWILIO_ACCOUNT_SID:t.z.string().min(1,"TWILIO_ACCOUNT_SID is required"),TWILIO_AUTH_TOKEN:t.z.string().min(1,"TWILIO_AUTH_TOKEN is required"),TWILIO_NUMBER:t.z.string().min(1,"TWILIO_NUMBER is required"),STRIPE_SECRET_KEY:t.z.string().min(1,"STRIPE_SECRET_KEY is required"),STRIPE_WEBHOOK_SECRET:t.z.string().optional(),OPENAI_API_KEY:t.z.string().min(1,"OPENAI_API_KEY is required"),GOOGLE_API_KEY:t.z.string().min(1,"GOOGLE_API_KEY is required"),XAI_API_KEY:t.z.string().optional(),PINECONE_API_KEY:t.z.string().min(1,"PINECONE_API_KEY is required"),PINECONE_INDEX:t.z.string().min(1,"PINECONE_INDEX is required"),CRON_SECRET:t.z.string().optional(),INNGEST_EVENT_KEY:t.z.string().optional(),INNGEST_SIGNING_KEY:t.z.string().optional(),NODE_ENV:t.z.enum(["development","test","production"]).default("development"),APP_ENV:t.z.enum(["development","staging","production"]).optional()}),r=null;function a(){return r||(r=function(){let e=s.safeParse(process.env);if(!e.success){let t=e.error.errors.map(e=>`  - ${e.path.join(".")}: ${e.message}`).join("\n");throw Error(`Server environment validation failed:
${t}

Ensure all required environment variables are set.`)}return e.data}()),r}function n(){let e=a();return{databaseUrl:e.DATABASE_URL,sessionEncryptionKey:e.SESSION_ENCRYPTION_KEY}}function i(){let e=a();return{accountSid:e.TWILIO_ACCOUNT_SID,authToken:e.TWILIO_AUTH_TOKEN,phoneNumber:e.TWILIO_NUMBER}}function u(){let e=a();return{secretKey:e.STRIPE_SECRET_KEY,webhookSecret:e.STRIPE_WEBHOOK_SECRET}}function o(){let e=a();return{openaiApiKey:e.OPENAI_API_KEY,googleApiKey:e.GOOGLE_API_KEY,xaiApiKey:e.XAI_API_KEY}}function l(){let e=a();return{nodeEnv:e.NODE_ENV,appEnv:e.APP_ENV,isDevelopment:"development"===e.NODE_ENV,isProduction:"production"===e.NODE_ENV,isTest:"test"===e.NODE_ENV}}e.s(["getAiSecrets",()=>o,"getDatabaseSecrets",()=>n,"getStripeSecrets",()=>u,"getTwilioSecrets",()=>i],832821),e.s(["getEnvironmentSettings",()=>l],437234),e.s([],791146)},94510,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){return await this.db.insertInto("messageQueues").values(e).returningAll().executeTakeFirstOrThrow()}async createMany(e){return 0===e.length?[]:await this.db.insertInto("messageQueues").values(e).returningAll().execute()}async findById(e){return await this.db.selectFrom("messageQueues").selectAll().where("id","=",e).executeTakeFirst()}async findByMessageId(e){return await this.db.selectFrom("messageQueues").selectAll().where("messageId","=",e).executeTakeFirst()}async findPendingByClient(e,t){return await this.db.selectFrom("messageQueues").selectAll().where("clientId","=",e).where("queueName","=",t).where("status","=","pending").orderBy("sequenceNumber","asc").execute()}async findAllPending(e){let t=this.db.selectFrom("messageQueues").selectAll().where("status","=","pending");return e.clientId&&(t=t.where("clientId","=",e.clientId)),await t.orderBy("createdAt","desc").limit(e.limit||100).offset(e.offset||0).execute()}async findAllPendingWithUserInfo(e){let t=this.db.selectFrom("messageQueues").innerJoin("users","users.id","messageQueues.clientId").select(["messageQueues.id","messageQueues.clientId","messageQueues.queueName","messageQueues.sequenceNumber","messageQueues.messageContent","messageQueues.mediaUrls","messageQueues.status","messageQueues.messageId","messageQueues.retryCount","messageQueues.maxRetries","messageQueues.timeoutMinutes","messageQueues.errorMessage","messageQueues.createdAt","messageQueues.sentAt","messageQueues.deliveredAt","users.name as userName","users.phoneNumber as userPhone"]).where("messageQueues.status","=","pending");return e.clientId&&(t=t.where("messageQueues.clientId","=",e.clientId)),await t.orderBy("messageQueues.createdAt","desc").limit(e.limit||100).execute()}async findNextPending(e,t){return await this.db.selectFrom("messageQueues").selectAll().where("clientId","=",e).where("queueName","=",t).where("status","=","pending").orderBy("sequenceNumber","asc").limit(1).executeTakeFirst()}async findStalled(e){return await this.db.selectFrom("messageQueues").selectAll().where("status","=","sent").where("sentAt","<",e).execute()}async updateStatus(e,t,s,r){return await this.db.updateTable("messageQueues").set({status:t,...s?.sentAt&&{sentAt:s.sentAt},...s?.deliveredAt&&{deliveredAt:s.deliveredAt},...r&&{errorMessage:r}}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async linkMessage(e,t){return await this.db.updateTable("messageQueues").set({messageId:t,status:"sent",sentAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementRetry(e){let t=await this.findById(e);if(!t)throw Error(`Queue entry ${e} not found`);return await this.db.updateTable("messageQueues").set({retryCount:t.retryCount+1}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async deleteCompleted(e,t){await this.db.deleteFrom("messageQueues").where("clientId","=",e).where("queueName","=",t).where("status","in",["delivered","failed"]).execute()}async getQueueStatus(e,t){let s=await this.db.selectFrom("messageQueues").select(["status"]).where("clientId","=",e).where("queueName","=",t).execute();return{total:s.length,pending:s.filter(e=>"pending"===e.status).length,sent:s.filter(e=>"sent"===e.status).length,delivered:s.filter(e=>"delivered"===e.status).length,failed:s.filter(e=>"failed"===e.status).length}}}e.s(["MessageQueueRepository",()=>s])},501261,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,t=50,s=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).offset(s).execute()}async findRecentByClientId(e,t=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).reverse()}async countByClientId(e){let t=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(t?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,t,s){return await this.db.updateTable("messages").set({deliveryStatus:t,deliveryError:s||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let t=await this.findById(e);if(!t)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(t.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,t){return await this.db.updateTable("messages").set({providerMessageId:t}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await s.executeTakeFirst(),a=Number(r?.count??0);return{messages:await t.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:a}}async getStats(e){let t=this.db.selectFrom("messages");e&&(t=t.where("clientId","=",e));let[s,r,a,n,i]=await Promise.all([t.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(s?.count??0),inbound:Number(r?.count??0),outbound:Number(a?.count??0),pending:Number(n?.count??0),failed:Number(i?.count??0)}}}e.s(["MessageRepository",()=>s])},221792,e=>{"use strict";var t=e.i(553573),s=e.i(163459),r=e.i(342845),a=e.i(904973),n=e.i(818385),i=e.i(588303),u=e.i(583020),o=e.i(304941),l=e.i(370312),d=e.i(40504),c=e.i(802579),m=e.i(225915),g=e.i(150373),p=e.i(804342),h=e.i(259207),E=e.i(348684),w=e.i(193695);e.i(650048);var I=e.i(219407),A=e.i(982099),v=e.i(501261),y=e.i(94510);let T=new v.MessageRepository,N=new y.MessageQueueRepository;async function f(e){try{let{searchParams:t}=new URL(e.url),s={};t.get("search")&&(s.search=t.get("search")),t.get("direction")&&(s.direction=t.get("direction")),t.get("status")&&(s.status=t.get("status")),t.get("clientId")&&(s.clientId=t.get("clientId"));let r=t.get("page")?parseInt(t.get("page"),10):1,a=t.get("pageSize")?parseInt(t.get("pageSize"),10):50,n=(r-1)*a,{messages:i,total:u}=await T.findAllWithUserInfo({limit:a,offset:n,direction:s.direction,status:s.status,search:s.search,clientId:s.clientId}),o=[];s.status&&"pending"!==s.status||(o=await N.findAllPendingWithUserInfo({limit:100,clientId:s.clientId}));let l=i.map(e=>({id:e.id,clientId:e.clientId,direction:e.direction,content:e.content,phoneFrom:e.phoneFrom,phoneTo:e.phoneTo,provider:e.provider,providerMessageId:e.providerMessageId,deliveryStatus:e.deliveryStatus,deliveryError:e.deliveryError,metadata:e.metadata,createdAt:e.createdAt,source:"message",userName:e.userName,userPhone:e.userPhone})),d=o.map(e=>({id:e.id,clientId:e.clientId,direction:"outbound",content:e.messageContent||"",phoneFrom:null,phoneTo:null,provider:null,providerMessageId:null,deliveryStatus:"pending",deliveryError:e.errorMessage,metadata:e.mediaUrls?{mediaUrls:e.mediaUrls}:null,createdAt:e.createdAt,source:"queue",queueName:e.queueName,sequenceNumber:e.sequenceNumber,userName:e.userName,userPhone:e.userPhone})),c=[...l,...d].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),m=await T.getStats(s.clientId);m.pending+=o.length;let g={messages:c,pagination:{page:r,limit:a,total:u+o.length,totalPages:Math.ceil((u+o.length)/a)},stats:m};return A.NextResponse.json({success:!0,data:g})}catch(e){return console.error("Error fetching admin messages:",e),A.NextResponse.json({success:!1,message:e instanceof Error?e.message:"An error occurred fetching messages"},{status:500})}}e.s(["GET",()=>f],712707);var x=e.i(712707);let R=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/messages/route",pathname:"/api/messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/admin/src/app/api/messages/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:b,workUnitAsyncStorage:_,serverHooks:S}=R;function O(){return(0,r.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:_})}async function P(e,t,r){R.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/messages/route";A=A.replace(/\/index$/,"")||"/";let v=await R.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:T,nextConfig:N,parsedUrl:f,isDraftMode:x,prerenderManifest:b,routerServerContext:_,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:P,clientReferenceManifest:C,serverActionsManifest:k}=v,F=(0,o.normalizeAppPath)(A),q=!!(b.dynamicRoutes[F]||b.routes[P]),M=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,f,!1):t.end("This page could not be found"),null);if(q&&!x){let e=!!b.routes[P],t=b.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await M();throw new w.NoFallbackError}}let D=null;!q||R.isDev||x||(D="/index"===(D=P)?"/":D);let U=!0===R.isDev||!q,Q=q&&!U;k&&C&&(0,i.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:C,serverActionsManifest:k,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:k})});let K=e.method||"GET",B=(0,n.getTracer)(),j=B.getActiveScopeSpan(),H={params:T,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,r)=>R.onRequestError(e,t,r,_)},sharedContext:{buildId:y}},$=new l.NodeNextRequest(e),z=new l.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let i=async e=>R.handle(L,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=B.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=s.get("next.route");if(r){let t=`${K} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${A}`)}),u=!!(0,a.getRequestMeta)(e,"minimalMode"),o=async a=>{var n,o;let l=async({previousCacheEntry:s})=>{try{if(!u&&S&&O&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let o=H.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let l=H.renderOpts.collectedTags;if(!q)return await (0,g.sendResponse)($,z,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[E.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:I.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:r}}}}catch(t){throw(null==s?void 0:s.isStale)&&await R.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:Q,isOnDemandRevalidate:S})},_),t}},d=await R.handleResponse({req:e,nextConfig:N,cacheKey:D,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:u});if(!q)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==I.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(o=d.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,p.fromNodeOutgoingHttpHeaders)(d.value.headers);return u&&q||c.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)($,z,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};j?await o(j):await B.withPropagatedContext(e.headers,()=>B.trace(c.BaseServerSpan.handleRequest,{spanName:`${K} ${A}`,kind:n.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},o))}catch(t){if(t instanceof w.NoFallbackError||await R.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:Q,isOnDemandRevalidate:S})}),q)throw t;return await (0,g.sendResponse)($,z,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>O,"routeModule",()=>R,"serverHooks",()=>S,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>_],221792)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__683f0d1d._.js.map