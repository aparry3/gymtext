module.exports=[201236,840936,e=>{"use strict";var t=e.i(46308),r=e.i(76421);class s extends t.BaseRepository{async insertFitnessPlan(e){let t=await this.db.insertInto("fitnessPlans").values({clientId:e.clientId,description:e.description,message:e.message,structured:e.structured?JSON.stringify(e.structured):null,startDate:e.startDate}).returningAll().executeTakeFirstOrThrow();return r.FitnessPlanModel.fromDB(t)}async getFitnessPlan(e){let t=await this.db.selectFrom("fitnessPlans").selectAll().where("id","=",e).executeTakeFirst();return t?r.FitnessPlanModel.fromDB(t):null}async getCurrentPlan(e){let t=await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",e).orderBy("createdAt","desc").executeTakeFirst();return t?r.FitnessPlanModel.fromDB(t):null}async getPlanHistory(e){return(await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",e).orderBy("createdAt","desc").execute()).map(r.FitnessPlanModel.fromDB)}async updateFitnessPlan(e,t){let s={updatedAt:new Date};void 0!==t.description&&(s.description=t.description),void 0!==t.message&&(s.message=t.message),void 0!==t.structured&&(s.structured=t.structured?JSON.stringify(t.structured):null);let c=await this.db.updateTable("fitnessPlans").set(s).where("id","=",e).returningAll().executeTakeFirst();return c?r.FitnessPlanModel.fromDB(c):null}async deleteFitnessPlan(e){return Number((await this.db.deleteFrom("fitnessPlans").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}}e.s(["FitnessPlanRepository",()=>s],840936),e.i(331950);var c=e.i(466405),i=e.i(36480);class n{static instance;fitnessPlanRepo;constructor(){this.fitnessPlanRepo=new s(i.postgresDb)}static getInstance(){return n.instance||(n.instance=new n),n.instance}async createFitnessPlan(e){let t=await c.fitnessPlanAgentService.generateFitnessPlan(e),s=r.FitnessPlanModel.fromFitnessPlanOverview(e,t);return console.log("[FitnessPlanService] Created plan:",s.description?.substring(0,200)),await this.fitnessPlanRepo.insertFitnessPlan(s)}async getCurrentPlan(e){return await this.fitnessPlanRepo.getCurrentPlan(e)}async getPlanById(e){return await this.fitnessPlanRepo.getFitnessPlan(e)}async getPlanHistory(e){return await this.fitnessPlanRepo.getPlanHistory(e)}async updateFitnessPlan(e,t){return await this.fitnessPlanRepo.updateFitnessPlan(e,t)}async deleteFitnessPlan(e){return await this.fitnessPlanRepo.deleteFitnessPlan(e)}}let a=n.getInstance();e.s(["FitnessPlanService",()=>n,"fitnessPlanService",0,a],201236)},517670,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async create(e){let t={...e,details:"string"==typeof e.details?e.details:JSON.stringify(e.details),structured:e.structured?"string"==typeof e.structured?e.structured:JSON.stringify(e.structured):null};return await this.db.insertInto("workoutInstances").values(t).returningAll().executeTakeFirstOrThrow()}async findByClientIdAndDateRange(e,t,r){return await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",t).where("date","<=",r).orderBy("date","asc").selectAll().execute()}async findByClientIdAndDate(e,t){let r=new Date(t),s=new Date(t);return s.setUTCDate(s.getUTCDate()+1),await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",r).where("date","<",s).selectAll().executeTakeFirst()}async getRecentWorkouts(e,t=10){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",e).orderBy("workoutInstances.date","desc").limit(t).execute()}async getRecentWorkoutsByDays(e,t=7){let r=new Date,s=new Date;return s.setDate(s.getDate()-t),await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",s).where("date","<=",r).orderBy("date","desc").selectAll().execute()}async getWorkoutByDate(e,t){return this.findByClientIdAndDate(e,t)}async update(e,t){let r={...t,updatedAt:new Date};return t.details&&(r.details="string"==typeof t.details?t.details:JSON.stringify(t.details)),void 0!==t.structured&&(r.structured=t.structured?"string"==typeof t.structured?t.structured:JSON.stringify(t.structured):null),await this.db.updateTable("workoutInstances").set(r).where("id","=",e).returningAll().executeTakeFirst()}async deleteOldWorkouts(e=90){let t=new Date;return t.setDate(t.getDate()-e),Number((await this.db.deleteFrom("workoutInstances").where("date","<",t).executeTakeFirst()).numDeletedRows)}async getWorkoutById(e){return await this.db.selectFrom("workoutInstances").selectAll().where("id","=",e).executeTakeFirst()}async getWorkoutsByMicrocycle(e,t){return await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("microcycleId","=",t).orderBy("date","asc").selectAll().execute()}async getWorkoutsByDateRange(e,t,r){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",e).where("workoutInstances.date",">=",t).where("workoutInstances.date","<=",r).orderBy("workoutInstances.date","asc").execute()}async delete(e){return Number((await this.db.deleteFrom("workoutInstances").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}async findUserIdsWithWorkoutsForUserDates(e){return 0===e.length?new Set:new Set((await this.db.selectFrom("workoutInstances").select("clientId").where(t=>{let r=e.map(({userId:e,startOfDay:r,endOfDay:s})=>t.and([t("clientId","=",e),t("date",">=",r),t("date","<",s)]));return t.or(r)}).execute()).map(e=>e.clientId))}}e.s(["WorkoutInstanceRepository",()=>r])},125720,881640,763800,108436,52396,e=>{"use strict";var t=e.i(517670),r=e.i(36480);e.i(331950);var s=e.i(520676),c=e.i(201236),i=e.i(823525),n=e.i(929492),a=e.i(995515);class o{db;constructor(e){this.db=e}async createMicrocycle(e){let t=await this.db.insertInto("microcycles").values({id:(0,n.v4)(),clientId:e.clientId,absoluteWeek:e.absoluteWeek,days:e.days,description:e.description,isDeload:e.isDeload,message:e.message,structured:e.structured?JSON.stringify(e.structured):null,startDate:e.startDate,endDate:e.endDate,isActive:e.isActive}).returningAll().executeTakeFirstOrThrow();return a.MicrocycleModel.fromDB(t)}async getActiveMicrocycle(e){let t=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("isActive","=",!0).orderBy("createdAt","desc").executeTakeFirst();return t?a.MicrocycleModel.fromDB(t):null}async getMicrocycleByAbsoluteWeek(e,t){let r=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("absoluteWeek","=",t).orderBy("updatedAt","desc").executeTakeFirst();return r?a.MicrocycleModel.fromDB(r):null}async deactivatePreviousMicrocycles(e){await this.db.updateTable("microcycles").set({isActive:!1}).where("clientId","=",e).where("isActive","=",!0).execute()}async updateMicrocycle(e,t){let r={};if(void 0!==t.days&&(r.days=t.days),void 0!==t.description&&(r.description=t.description),void 0!==t.isDeload&&(r.isDeload=t.isDeload),void 0!==t.message&&(r.message=t.message),void 0!==t.structured&&(r.structured=t.structured?JSON.stringify(t.structured):null),void 0!==t.isActive&&(r.isActive=t.isActive),void 0!==t.startDate&&(r.startDate=t.startDate),void 0!==t.endDate&&(r.endDate=t.endDate),void 0!==t.absoluteWeek&&(r.absoluteWeek=t.absoluteWeek),0===Object.keys(r).length)return this.getMicrocycleById(e);let s=await this.db.updateTable("microcycles").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirst();return s?a.MicrocycleModel.fromDB(s):null}async getMicrocycleById(e){let t=await this.db.selectFrom("microcycles").selectAll().where("id","=",e).executeTakeFirst();return t?a.MicrocycleModel.fromDB(t):null}async getRecentMicrocycles(e,t=5){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).map(e=>a.MicrocycleModel.fromDB(e))}async deleteMicrocycle(e){return(await this.db.deleteFrom("microcycles").where("id","=",e).executeTakeFirst()).numDeletedRows>0}async getAllMicrocycles(e){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).orderBy("absoluteWeek","asc").execute()).map(e=>a.MicrocycleModel.fromDB(e))}async getMicrocycleByDate(e,t){let r=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("startDate","<=",t).where("endDate",">=",t).orderBy("updatedAt","desc").executeTakeFirst();return r?a.MicrocycleModel.fromDB(r):null}}e.s(["MicrocycleRepository",()=>o],881640);var l=e.i(404650),u=e.i(565431);class d{static instance;microcycleRepo;userService;constructor(){this.microcycleRepo=new o(r.postgresDb),this.userService=u.UserService.getInstance()}static getInstance(){return d.instance||(d.instance=new d),d.instance}async getActiveMicrocycle(e){return await this.microcycleRepo.getActiveMicrocycle(e)}async isActiveMicrocycleCurrent(e,t="America/New_York"){let r=await this.microcycleRepo.getActiveMicrocycle(e);if(!r)return!1;let{startDate:s}=this.calculateWeekDates(t),c=new Date(s);c.setHours(0,0,0,0);let i=new Date(r.startDate);i.setHours(0,0,0,0);let n=new Date(r.endDate);return n.setHours(0,0,0,0),c>=i&&c<=n}async getAllMicrocycles(e){return await this.microcycleRepo.getAllMicrocycles(e)}async getMicrocycleByAbsoluteWeek(e,t){return await this.microcycleRepo.getMicrocycleByAbsoluteWeek(e,t)}async getMicrocycleByDate(e,t){return await this.microcycleRepo.getMicrocycleByDate(e,t)}async getMicrocycleById(e){return await this.microcycleRepo.getMicrocycleById(e)}async updateMicrocycleDays(e,t){return await this.microcycleRepo.updateMicrocycle(e,{days:t})}async updateMicrocycle(e,t){return await this.microcycleRepo.updateMicrocycle(e,t)}async createMicrocycleFromProgress(e,t,r){let s=await this.userService.getUser(e);if(!s)throw Error(`Client not found: ${e}`);let{days:c,description:i,isDeload:n,message:a,structure:o}=await this.generateMicrocycle(s,r.absoluteWeek),l=await this.microcycleRepo.createMicrocycle({clientId:e,absoluteWeek:r.absoluteWeek,days:c,description:i,isDeload:n,message:a,structured:o,startDate:r.weekStartDate,endDate:r.weekEndDate,isActive:!1});return console.log(`[MicrocycleService] Created microcycle for client ${e}, week ${r.absoluteWeek} (${r.weekStartDate.toISOString()} - ${r.weekEndDate.toISOString()})`),l}async generateMicrocycle(e,t){try{let r=await l.microcycleAgentService.generateMicrocycle(e,t);return console.log(`[MicrocycleService] Generated microcycle for week ${t}, isDeload=${r.isDeload}`),r}catch(e){throw console.error("[MicrocycleService] Failed to generate microcycle:",e),e}}calculateWeekDates(e="America/New_York"){let t=(0,i.now)(e).toJSDate();return{startDate:(0,i.startOfWeek)(t,e),endDate:(0,i.endOfWeek)(t,e)}}async deleteMicrocycleWithWorkouts(t){let r=await this.microcycleRepo.getMicrocycleById(t);if(!r)return{deleted:!1,deletedWorkoutsCount:0};let{workoutInstanceService:s}=await e.A(493820),c=await s.getWorkoutsByMicrocycle(r.clientId,t),i=0;for(let e of c)await s.deleteWorkout(e.id,r.clientId)&&i++;return{deleted:await this.microcycleRepo.deleteMicrocycle(t),deletedWorkoutsCount:i}}}let y=d.getInstance();e.s(["MicrocycleService",()=>d,"microcycleService",0,y],763800);class w{static instance;microcycleService;constructor(){this.microcycleService=d.getInstance()}static getInstance(){return w.instance||(w.instance=new w),w.instance}async getProgressForDate(e,t,r="America/New_York"){if(!e||!e.id)return null;let s=(0,i.parseDate)(e.startDate);if(!s)return null;let c=(0,i.startOfWeek)(s,r),n=(0,i.startOfWeek)(t,r),a=(0,i.diffInWeeks)(n,c,r)+1;if(a<1)return null;let o=await this.microcycleService.getMicrocycleByDate(e.clientId,t);return o||(o=await this.microcycleService.getMicrocycleByAbsoluteWeek(e.clientId,a)),{fitnessPlan:e,microcycle:o,absoluteWeek:a,dayOfWeek:(0,i.getWeekday)(t,r),weekStartDate:(0,i.startOfWeek)(t,r),weekEndDate:(0,i.endOfWeek)(t,r)}}async getCurrentProgress(e,t="America/New_York"){let r=(0,i.now)(t).toJSDate();return await this.getProgressForDate(e,r,t)}async getOrCreateMicrocycleForDate(e,t,r,s="America/New_York",c=!1){let i=await this.getProgressForDate(t,r,s);if(!i)throw Error(`Could not calculate progress for date ${r}`);if(i.microcycle&&!c)return{microcycle:i.microcycle,progress:i,wasCreated:!1};let n=await this.microcycleService.createMicrocycleFromProgress(e,t,i),a={...i,microcycle:n};return{microcycle:n,progress:a,wasCreated:!0}}}let k=w.getInstance();e.s(["ProgressService",()=>w,"progressService",0,k],108436);var h=e.i(46308),g=e.i(705590);class m extends h.BaseRepository{generateUniqueCode(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let r=0;r<5;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}async createShortLink(e){return await this.db.insertInto("shortLinks").values({code:e.code,targetPath:e.targetPath,clientId:e.clientId,expiresAt:e.expiresAt,createdAt:new Date,accessCount:0}).onConflict(t=>t.column("code").doUpdateSet({targetPath:e.targetPath,clientId:e.clientId,expiresAt:e.expiresAt,createdAt:new Date,accessCount:0,lastAccessedAt:null})).returningAll().executeTakeFirstOrThrow()}async findByCode(e){return await this.db.selectFrom("shortLinks").selectAll().where("code","=",e).executeTakeFirst()||null}async incrementAccessCount(e){await this.db.updateTable("shortLinks").set({accessCount:g.sql`access_count + 1`,lastAccessedAt:new Date}).where("id","=",e).execute()}async deleteExpiredLinks(){return Number((await this.db.deleteFrom("shortLinks").where("expiresAt","<",new Date).where("expiresAt","is not",null).executeTakeFirst()).numDeletedRows||0)}async deleteByClientId(e){return Number((await this.db.deleteFrom("shortLinks").where("clientId","=",e).executeTakeFirst()).numDeletedRows||0)}async findByClientId(e){return await this.db.selectFrom("shortLinks").selectAll().where("clientId","=",e).orderBy("createdAt","desc").execute()}}e.s(["ShortLinkRepository",()=>m],52396);var p=e.i(875559);class I{static instance;repository;DEFAULT_EXPIRY_DAYS=(0,p.getShortLinksConfig)().defaultExpiryDays;constructor(){this.repository=new m}static getInstance(){return I.instance||(I.instance=new I),I.instance}async createShortLink(e,t,r){let s=r?.code||this.repository.generateUniqueCode(),c=r?.expiresAt||new Date(Date.now()+24*this.DEFAULT_EXPIRY_DAYS*36e5),i=await this.repository.createShortLink({code:s,targetPath:t,clientId:e,expiresAt:c});return console.log(`[ShortLinkService] Created short link: ${s} -> ${t}`),i}async resolveShortLink(e){let t=await this.repository.findByCode(e);return t?null!==t.expiresAt&&new Date(t.expiresAt)<new Date?(console.log(`[ShortLinkService] Short link expired: ${e}`),{link:t,isExpired:!0}):(this.repository.incrementAccessCount(t.id).catch(t=>{console.error(`[ShortLinkService] Failed to increment access count for ${e}:`,t)}),console.log(`[ShortLinkService] Resolved short link: ${e} -> ${t.targetPath}`),{link:t,isExpired:!1}):(console.log(`[ShortLinkService] Short link not found: ${e}`),null)}async createWorkoutLink(e,t,r){let s=`/me?workout=${t}`;return this.createShortLink(e,s,r)}async createProfileLink(e,t){return this.createShortLink(e,"/me",t)}getFullUrl(e){let t=(0,p.getShortLinksConfig)().domain||"https://gtxt.ai";return`${t}/l/${e}`}async cleanupExpiredLinks(){try{let e=await this.repository.deleteExpiredLinks();return console.log(`[ShortLinkService] Cleaned up ${e} expired short links`),e}catch(e){return console.error("[ShortLinkService] Error cleaning up expired links:",e),0}}}let D=I.getInstance();class f{static instance;workoutRepo;fitnessPlanService;progressService;microcycleService;constructor(){this.workoutRepo=new t.WorkoutInstanceRepository(r.postgresDb),this.fitnessPlanService=c.FitnessPlanService.getInstance(),this.progressService=w.getInstance(),this.microcycleService=d.getInstance()}static getInstance(){return f.instance||(f.instance=new f),f.instance}async getRecentWorkouts(e,t=10){return await this.workoutRepo.getRecentWorkouts(e,t)}async getWorkoutsByDateRange(e,t,r){return await this.workoutRepo.getWorkoutsByDateRange(e,t,r)}async getWorkoutById(e,t){let r=await this.workoutRepo.getWorkoutById(e);return r&&r.clientId===t?r:null}async getWorkoutByIdInternal(e){return await this.workoutRepo.getWorkoutById(e)}async getWorkoutByUserIdAndDate(e,t){return await this.workoutRepo.findByClientIdAndDate(e,t)}async updateWorkoutMessage(e,t){return await this.workoutRepo.update(e,{message:t})}async createWorkout(e){return await this.workoutRepo.create(e)}async updateWorkout(e,t){return await this.workoutRepo.update(e,t)}async generateWorkoutForDate(e,t,r){try{let c=await this.fitnessPlanService.getCurrentPlan(e.id);if(!c)return console.log(`No fitness plan found for user ${e.id}`),null;if(!await this.progressService.getProgressForDate(c,t.toJSDate(),e.timezone))return console.log(`No progress found for user ${e.id} on ${t.toISODate()}`),null;let n=r??null;if(n||(n=(await this.progressService.getOrCreateMicrocycleForDate(e.id,c,t.toJSDate(),e.timezone)).microcycle),!n)return console.log(`Could not get/create microcycle for user ${e.id}`),null;let a=(0,i.getWeekday)(t.toJSDate(),e.timezone)-1,o=n.days?.[a];if(!o||"string"!=typeof o)return console.log(`No overview found for day index ${a} in microcycle ${n.id}`),null;let l=n.structured?.days?.[a],u=l?.activityType,{response:d,message:y,structure:w}=await s.workoutAgentService.generateWorkout(e,o,n.isDeload??!1,u),k=w?.title||"Workout",h={clientId:e.id,microcycleId:n.id,date:t.toJSDate(),sessionType:"workout",goal:o.substring(0,100),details:JSON.parse(JSON.stringify({theme:k})),description:d,message:y,structured:w,completedAt:null,createdAt:new Date,updatedAt:new Date},g=await this.createWorkout(h);console.log(`Generated and saved workout for user ${e.id} on ${t.toISODate()}`);try{let r=await D.createWorkoutLink(e.id,g.id),s=D.getFullUrl(r.code);if(console.log(`Created short link for workout ${g.id}: ${s}`),g.message){let r=(0,i.getDayOfWeekName)(t.toJSDate(),e.timezone);g.message=`${r}

${g.message}

(More details: ${s})`.replace(/\n{3,}/g,"\n\n").trim(),await this.updateWorkoutMessage(g.id,g.message)}}catch(e){console.error(`Failed to create short link for workout ${g.id}:`,e)}return g}catch(t){throw console.error(`Error generating workout for user ${e.id}:`,t),t}}mapThemeToSessionType(e){let t=e.toLowerCase();return t.includes("run")||t.includes("running")?"run":t.includes("metcon")||t.includes("hiit")||t.includes("conditioning")||t.includes("cardio")?"metcon":t.includes("lift")||t.includes("strength")||t.includes("upper")||t.includes("lower")||t.includes("push")||t.includes("pull")?"lift":t.includes("mobility")||t.includes("flexibility")||t.includes("stretch")?"mobility":t.includes("rest")||t.includes("recovery")||t.includes("deload")?"rest":"other"}async deleteWorkout(e,t){let r=await this.workoutRepo.getWorkoutById(e);return!!r&&r.clientId===t&&await this.workoutRepo.delete(e)}async getWorkoutsByMicrocycle(e,t){return await this.workoutRepo.getWorkoutsByMicrocycle(e,t)}}let A=f.getInstance();e.s(["WorkoutInstanceService",()=>f,"workoutInstanceService",0,A],125720)}];

//# sourceMappingURL=packages_shared_src_server_1ac97d59._.js.map