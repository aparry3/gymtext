module.exports=[973559,297934,13423,e=>{"use strict";e.i(454188);var r=e.i(331612),t=e.i(490773);r.z.object({id:r.z.string().uuid(),name:r.z.string(),email:r.z.string().email().nullable(),phoneNumber:r.z.string().transform(t.normalizeUSPhoneNumber).refine(t.validateUSPhoneNumber,{message:"Must be a valid US phone number"}),age:r.z.number().int().min(1).max(120).nullable(),gender:r.z.string().nullable(),stripeCustomerId:r.z.string().nullable(),preferredSendHour:r.z.number().int().min(0).max(23),timezone:r.z.string(),createdAt:r.z.date(),updatedAt:r.z.date()});let i=r.z.object({summary:r.z.string().nullish(),daysPerWeek:r.z.number().int().min(1).max(7),minutesPerSession:r.z.number().int().min(15).max(240),preferredTimes:r.z.array(r.z.enum(["morning","afternoon","evening"])).nullish(),schedule:r.z.string().nullish()}),s=r.z.object({id:r.z.string(),description:r.z.string(),startDate:r.z.string(),endDate:r.z.string().nullish(),location:r.z.string().nullish(),equipmentAvailable:r.z.array(r.z.string()).nullish(),equipmentUnavailable:r.z.array(r.z.string()).nullish()}),n=r.z.object({summary:r.z.string().nullish(),gymAccess:r.z.boolean(),gymType:r.z.enum(["commercial","home","community","none"]).nullish(),homeEquipment:r.z.array(r.z.string()).nullish(),limitations:r.z.array(r.z.string()).nullish(),temporaryChanges:r.z.array(s).nullish()}),a=r.z.object({value:r.z.number().positive(),unit:r.z.enum(["lbs","kg"]),date:r.z.string().nullish()}),l=r.z.object({summary:r.z.string().nullish(),height:r.z.number().positive().nullish(),weight:a.nullish(),bodyComposition:r.z.number().min(1).max(50).nullish(),fitnessLevel:r.z.enum(["sedentary","lightly_active","moderately_active","very_active"]).nullish()}),u=r.z.object({id:r.z.string(),type:r.z.enum(["injury","mobility","medical","preference"]),description:r.z.string(),severity:r.z.enum(["mild","moderate","severe"]).nullish(),affectedMovements:r.z.array(r.z.string()).nullish(),status:r.z.enum(["active","resolved"]),startDate:r.z.string().nullish(),endDate:r.z.string().nullish(),isTemporary:r.z.boolean().default(!1)}),o=r.z.object({type:r.z.literal("strength"),summary:r.z.string().nullish(),experience:r.z.enum(["beginner","intermediate","advanced"]),currentProgram:r.z.string().nullish(),keyLifts:r.z.record(r.z.string(),r.z.number()).nullish(),preferences:r.z.object({workoutStyle:r.z.string().nullish(),likedExercises:r.z.array(r.z.string()).nullish(),dislikedExercises:r.z.array(r.z.string()).nullish()}).nullish(),trainingFrequency:r.z.number().int().min(1).max(7)}),c=r.z.object({type:r.z.literal("cardio"),summary:r.z.string().nullish(),experience:r.z.enum(["beginner","intermediate","advanced"]),primaryActivities:r.z.array(r.z.string()),keyMetrics:r.z.object({weeklyDistance:r.z.number().positive().nullish(),longestSession:r.z.number().positive().nullish(),averagePace:r.z.string().nullish(),preferredIntensity:r.z.enum(["low","moderate","high"]).nullish()}).nullish(),preferences:r.z.object({indoor:r.z.boolean().nullish(),outdoor:r.z.boolean().nullish(),groupVsIndividual:r.z.enum(["group","individual","both"]).nullish(),timeOfDay:r.z.array(r.z.string()).nullish()}).nullish(),frequency:r.z.number().int().min(1).max(7).nullish()}),d=r.z.array(r.z.union([o,c])),h=r.z.object({summary:r.z.string().nullish(),primary:r.z.string(),timeline:r.z.number().int().min(1).max(104).nullish(),specific:r.z.string().nullish(),motivation:r.z.string().nullish()}),m=r.z.object({goals:h,experienceLevel:r.z.enum(["beginner","intermediate","advanced"]).nullish(),equipmentAccess:n.nullish(),availability:i.nullish(),constraints:r.z.array(u).nullish(),metrics:l.nullish(),activities:d.nullish()});r.z.object({name:r.z.string().nullish(),email:r.z.string().email().nullish(),phoneNumber:r.z.string().transform(t.normalizeUSPhoneNumber).refine(t.validateUSPhoneNumber,{message:"Must be a valid US phone number"}),age:r.z.number().int().min(1).max(120).nullish(),gender:r.z.string().nullish(),isActive:r.z.boolean().nullish().default(!0),isAdmin:r.z.boolean().nullish().default(!1),stripeCustomerId:r.z.string().nullish(),preferredSendHour:r.z.number().int().min(0).max(23).nullish(),timezone:r.z.string().nullish()}).partial(),m.partial(),r.z.object({field:r.z.string(),oldValue:r.z.unknown().nullable(),newValue:r.z.unknown().nullable(),timestamp:r.z.date()}),r.z.object({updates:m.partial(),source:r.z.enum(["chat","form","admin","api","system"]),reason:r.z.string().optional().nullable()});class p{static fromDb(e){return e?{...e}:void 0}static fromDbWithProfile(e){let{profile:r,...t}=e;return{...t,profile:r||null}}static validateUserData(e){if(!e.name||e.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(!e.phoneNumber||!(0,t.validateUSPhoneNumber)(e.phoneNumber))throw Error("Valid US phone number is required");if(e.email&&!this.isValidEmail(e.email))throw Error("Invalid email format")}static validateUserUpdates(e){if(e.name&&e.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(e.phoneNumber&&!(0,t.validateUSPhoneNumber)(e.phoneNumber))throw Error("Valid US phone number is required");if(e.email&&!this.isValidEmail(e.email))throw Error("Invalid email format");if(void 0!==e.preferredSendHour&&(e.preferredSendHour<0||e.preferredSendHour>23))throw Error("Preferred send hour must be between 0 and 23");if(void 0!==e.age&&null!==e.age&&(e.age<1||e.age>120))throw Error("Age must be between 1 and 120")}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}}e.s(["UserModel",()=>p],973559);var f=e.i(46308);e.i(943636);var b=e.i(68551),g=e.i(724826);e.i(823525);class w extends f.BaseRepository{async list(e){let{q:r,createdFrom:t,createdTo:i,page:s=1,pageSize:n=20,sort:a="createdAt:desc"}=e,[l,u]=a.split(":"),o=this.db.selectFrom("users").selectAll("users");if(r){let e=`%${r}%`;o=o.where(r=>r.or([r("users.name","ilike",e),r("users.email","ilike",e),r("users.phoneNumber","ilike",e)]))}t&&(o=o.where("users.createdAt",">=",new Date(t))),i&&(o=o.where("users.createdAt","<=",new Date(i))),!0===e.hasProfile?o=o.where(e=>e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===e.hasProfile&&(o=o.where(e=>e.not(e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let c=this.db.selectFrom("users");if(r){let e=`%${r}%`;c=c.where(r=>r.or([r("users.name","ilike",e),r("users.email","ilike",e),r("users.phoneNumber","ilike",e)]))}t&&(c=c.where("users.createdAt",">=",new Date(t))),i&&(c=c.where("users.createdAt","<=",new Date(i))),!0===e.hasProfile?c=c.where(e=>e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===e.hasProfile&&(c=c.where(e=>e.not(e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let d=await c.select(e=>e.fn.countAll().as("count")).executeTakeFirst(),h=Number(d?.count||0);return{users:(await o.orderBy(`users.${l}`,"asc"===u?"asc":"desc").offset((s-1)*n).limit(n).execute()).map(e=>p.fromDb(e)).filter(e=>void 0!==e),total:h}}async create(e){let r=await this.db.insertInto("users").values({name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,createdAt:new Date,updatedAt:new Date}).returningAll().executeTakeFirstOrThrow();return p.fromDb(r)}async findById(e){return p.fromDb(await this.db.selectFrom("users").where("id","=",e).selectAll().executeTakeFirst())}async findByPhoneNumber(e){return p.fromDb(await this.db.selectFrom("users").where("phoneNumber","=",e).selectAll().executeTakeFirst())}async findByEmail(e){return p.fromDb(await this.db.selectFrom("users").where("email","=",e).selectAll().executeTakeFirst())}async findByStripeCustomerId(e){return p.fromDb(await this.db.selectFrom("users").where("stripeCustomerId","=",e).selectAll().executeTakeFirst())}async update(e,r){return p.fromDb(await this.db.updateTable("users").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirst())}async findWithProfile(e){let r=await this.db.selectFrom("users").leftJoin("profiles",e=>e.onRef("profiles.clientId","=","users.id").on(e=>{let r=e.selectFrom("profiles as p2").select(e=>e.fn.max("p2.createdAt").as("maxCreated")).whereRef("p2.clientId","=","users.id");return e("profiles.createdAt","=",r)})).selectAll("users").select("profiles.profile").where("users.id","=",e).executeTakeFirst();if(r)return p.fromDbWithProfile(r)}async updatePreferences(e,r){return p.fromDb(await this.db.updateTable("users").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow())}async findUsersForHour(e){let r=await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute(),t=[],i=new Date;for(let s of(i.setUTCHours(e,0,0,0),r))try{(function(e,r){if(!g.IANAZone.isValidZone(r))throw Error(`Invalid IANA timezone: ${r}`);return b.DateTime.fromJSDate(e,{zone:"utc"}).setZone(r).hour})(i,s.timezone)>=s.preferredSendHour&&t.push(p.fromDb(s))}catch(e){console.error(`Error processing user ${s.id} timezone:`,e)}return t}async findUsersByTimezones(e){return 0===e.length?[]:(await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").where("timezone","in",e).selectAll("users").execute()).map(e=>p.fromDb(e)).filter(e=>void 0!==e)}async findActiveUsersWithPreferences(){return await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute()}async delete(e){return await this.db.deleteFrom("adminActivityLogs").where(r=>r.or([r("targetClientId","=",e),r("actorClientId","=",e)])).execute(),Number((await this.db.deleteFrom("users").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}generateReferralCode(){let e="ABCDEFGHJKMNPQRSTUVWXYZ23456789",r="";for(let t=0;t<6;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}async getOrCreateReferralCode(e){let r=await this.db.selectFrom("users").select(["id","referralCode"]).where("id","=",e).executeTakeFirst();if(!r)return null;if(r.referralCode)return r.referralCode;let t=0;for(;t<10;){let r=this.generateReferralCode();try{if(await this.db.updateTable("users").set({referralCode:r,updatedAt:new Date}).where("id","=",e).where("referralCode","is",null).returningAll().executeTakeFirst())return r;let t=await this.db.selectFrom("users").select("referralCode").where("id","=",e).executeTakeFirst();if(t?.referralCode)return t.referralCode}catch(e){if(++t>=10)throw console.error("Failed to generate unique referral code after 10 attempts"),e}}return null}async findByReferralCode(e){return p.fromDb(await this.db.selectFrom("users").where("referralCode","=",e.toUpperCase()).selectAll().executeTakeFirst())}}e.s(["UserRepository",()=>w],297934);var y=f,z=e.i(705590);class T extends y.BaseRepository{async create(e,r){let t={clientId:e,signupData:r?JSON.parse(JSON.stringify(r)):null,status:"pending",programMessagesSent:!1};return await this.db.insertInto("userOnboarding").values(t).returningAll().executeTakeFirstOrThrow()}async findByClientId(e){return await this.db.selectFrom("userOnboarding").selectAll().where("clientId","=",e).executeTakeFirst()??null}async updateStatus(e,r,t){return await this.db.updateTable("userOnboarding").set({status:r,errorMessage:t??null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markStarted(e){return await this.db.updateTable("userOnboarding").set({status:"in_progress",startedAt:z.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async updateCurrentStep(e,r){return await this.db.updateTable("userOnboarding").set({currentStep:r}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markCompleted(e){return await this.db.updateTable("userOnboarding").set({status:"completed",completedAt:z.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markMessagesSent(e){return await this.db.updateTable("userOnboarding").set({programMessagesSent:!0}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async hasMessagesSent(e){let r=await this.db.selectFrom("userOnboarding").select("programMessagesSent").where("clientId","=",e).executeTakeFirst();return r?.programMessagesSent??!1}async getSignupData(e){let r=await this.db.selectFrom("userOnboarding").select("signupData").where("clientId","=",e).executeTakeFirst();return r?.signupData??null}async clearSignupData(e){return await this.db.updateTable("userOnboarding").set({signupData:null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async delete(e){await this.db.deleteFrom("userOnboarding").where("clientId","=",e).execute()}}e.s(["OnboardingRepository",()=>T],13423)},39917,e=>{"use strict";class r{state="CLOSED";failureCount=0;successCount=0;lastFailureTime=null;options;constructor(e={}){this.options={failureThreshold:e.failureThreshold||5,resetTimeout:e.resetTimeout||6e4,monitoringPeriod:e.monitoringPeriod||6e4}}async execute(e){if("OPEN"===this.state)if(!this.shouldAttemptReset())return console.warn("Circuit breaker is OPEN, skipping execution"),null;else this.state="HALF_OPEN";try{let r=await e();return this.onSuccess(),r}catch(e){throw this.onFailure(),e}}onSuccess(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=3&&(this.state="CLOSED",this.successCount=0,console.info("Circuit breaker is now CLOSED")))}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state?(this.state="OPEN",console.warn("Circuit breaker is now OPEN due to failure in HALF_OPEN state")):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`))}shouldAttemptReset(){return null!==this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.options.resetTimeout}getState(){return this.state}getStats(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount,lastFailureTime:this.lastFailureTime}}}e.s(["CircuitBreaker",()=>r])},565431,e=>{"use strict";var r=e.i(973559),t=e.i(297934),i=e.i(13423),s=e.i(39917),n=e.i(823525);class a{static instance;userRepository;onboardingRepository;circuitBreaker;constructor(){this.userRepository=new t.UserRepository,this.onboardingRepository=new i.OnboardingRepository,this.circuitBreaker=new s.CircuitBreaker({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4})}static getInstance(){return a.instance||(a.instance=new a),a.instance}async createUser(e){let t=await this.circuitBreaker.execute(async()=>{if(await this.userRepository.findByPhoneNumber(e.phoneNumber))throw Error("User already exists with this phone number");let t={name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null};r.UserModel.validateUserData(t);let i=await this.userRepository.create(t);if(!i)throw Error("Failed to create user");return i});if(!t)throw Error("Failed to create user");return t}async getUserById(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findById(e))||void 0}async getUserByPhone(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findByPhoneNumber(e))||void 0}async getUser(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findWithProfile(e))}async getUsersForHour(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findUsersForHour(e))||[]}async getUsersForWeeklyMessage(e){return await this.circuitBreaker.execute(async()=>{let r=new Date;r.setUTCHours(e,0,0,0);let t=(0,n.getTimezonesAtLocalTime)(r,17,7);return await this.userRepository.findUsersByTimezones(t)})||[]}async updateUser(e,t){let i=await this.circuitBreaker.execute(async()=>(r.UserModel.validateUserUpdates(t),await this.userRepository.update(e,t)));if(!i)throw Error("Failed to update user");return i}async updatePreferences(e,r){let t=await this.circuitBreaker.execute(async()=>await this.userRepository.updatePreferences(e,r));if(!t)throw Error("Failed to update preferences");return t}async listUsersForAdmin(e){let r=await this.circuitBreaker.execute(async()=>{let{page:r=1,pageSize:t=20,sort:i={field:"createdAt",direction:"desc"},...s}=e,n={q:s.search,hasProfile:s.hasProfile,createdFrom:s.createdAfter,createdTo:s.createdBefore,page:r,pageSize:t,sort:`${i.field}:${i.direction}`},{users:a,total:l}=await this.userRepository.list(n),u=a.map(e=>this.transformToAdminUser(e));return{users:u,pagination:{page:r,limit:t,total:l,totalPages:Math.ceil(l/t)},stats:await this.calculateUserStats()}});if(!r)throw Error("Failed to fetch users");return r}async getUserForAdmin(e){let r=await this.circuitBreaker.execute(async()=>{let r=await this.userRepository.findWithProfile(e);if(!r)throw Error("User not found");let t=this.transformToAdminUser(r),i=await this.onboardingRepository.getSignupData(e);return{user:t,profile:r.profile||null,signupData:i,recentActivity:{totalMessages:0,totalWorkouts:0}}});if(!r)throw Error("Failed to fetch user");return r}async deleteUser(e){return await this.circuitBreaker.execute(async()=>!!await this.userRepository.findById(e)&&await this.userRepository.delete(e))||!1}transformToAdminUser(e){let r=!!e.profile;return{...e,hasProfile:r,profileSummary:void 0,stats:{totalWorkouts:0,isActiveToday:!1}}}async calculateUserStats(){let e=(await this.userRepository.list({pageSize:1e3})).users,r=e.length,t=e.filter(e=>e.email).length;return{totalUsers:r,withEmail:t,withProfile:e.filter(e=>e.profile).length,activeToday:0}}}let l=a.getInstance();e.s(["UserService",()=>a,"userService",0,l])}];

//# sourceMappingURL=packages_shared_src_server_c293dfc2._.js.map