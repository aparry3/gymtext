{"version":3,"sources":["../../../../../packages/shared/src/shared/types/user/schemas.ts","../../../../../packages/shared/src/server/models/user.ts","../../../../../packages/shared/src/server/repositories/userRepository.ts","../../../../../packages/shared/src/server/utils/timezone.ts","../../../../../packages/shared/src/server/repositories/onboardingRepository.ts","../../../../../packages/shared/src/server/utils/circuitBreaker.ts","../../../../../packages/shared/src/server/services/user/userService.ts"],"sourcesContent":["import { z } from 'zod';\nimport { normalizeUSPhoneNumber, validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\n// Base user schema\nexport const UserSchema = z.object({\n  id: z.string().uuid(),\n  name: z.string(),\n  email: z.string().email().nullable(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullable(),\n  gender: z.string().nullable(),\n  stripeCustomerId: z.string().nullable(),\n  preferredSendHour: z.number().int().min(0).max(23),\n  timezone: z.string(),\n  createdAt: z.date(),\n  updatedAt: z.date(),\n});\n\n// NEW - Simplified Availability Schema\nexport const AvailabilitySchema = z.object({\n  summary: z.string().nullish(), // Brief overview of schedule and availability\n  daysPerWeek: z.number().int().min(1).max(7),\n  minutesPerSession: z.number().int().min(15).max(240),\n  preferredTimes: z.array(z.enum(['morning', 'afternoon', 'evening'])).nullish(),\n  schedule: z.string().nullish(),\n});\n\n// NEW - Temporary Environment Change Schema\nexport const TemporaryEnvironmentChangeSchema = z.object({\n  id: z.string(),\n  description: z.string(),\n  startDate: z.string(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for indefinite\n  location: z.string().nullish(), // \"beach\", \"hotel\", \"home\", etc.\n  equipmentAvailable: z.array(z.string()).nullish(),\n  equipmentUnavailable: z.array(z.string()).nullish(),\n});\n\n// NEW - Equipment Access Schema\nexport const EquipmentAccessSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of equipment situation\n  gymAccess: z.boolean(),\n  gymType: z.enum(['commercial', 'home', 'community', 'none']).nullish(),\n  homeEquipment: z.array(z.string()).nullish(),\n  limitations: z.array(z.string()).nullish(),\n  temporaryChanges: z.array(TemporaryEnvironmentChangeSchema).nullish(),\n});\n\n// Weight schema for metrics (kept but simplified)\nexport const WeightSchema = z.object({\n  value: z.number().positive(),\n  unit: z.enum(['lbs', 'kg']),\n  date: z.string().nullish(),\n});\n\n// NEW - Simplified User Metrics Schema\nexport const UserMetricsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of physical stats and fitness level\n  height: z.number().positive().nullish(),\n  weight: WeightSchema.nullish(),\n  bodyComposition: z.number().min(1).max(50).nullish(),\n  fitnessLevel: z.enum(['sedentary', 'lightly_active', 'moderately_active', 'very_active']).nullish(),\n});\n\n// NEW - Simplified Constraint Schema\nexport const ConstraintSchema = z.object({\n  id: z.string(),\n  type: z.enum(['injury', 'mobility', 'medical', 'preference']),\n  description: z.string(),\n  severity: z.enum(['mild', 'moderate', 'severe']).nullish(),\n  affectedMovements: z.array(z.string()).nullish(),\n  status: z.enum(['active', 'resolved']),\n  startDate: z.string().nullish(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for chronic\n  isTemporary: z.boolean().default(false),\n});\n\n// NEW - Simplified Strength Data Schema\nexport const StrengthDataSchema = z.object({\n  type: z.literal('strength'),\n  summary: z.string().nullish(), // Brief overview of strength training background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  currentProgram: z.string().nullish(),\n  keyLifts: z.record(z.string(), z.number()).nullish(),\n  preferences: z.object({\n    workoutStyle: z.string().nullish(),\n    likedExercises: z.array(z.string()).nullish(),\n    dislikedExercises: z.array(z.string()).nullish(),\n  }).nullish(),\n  trainingFrequency: z.number().int().min(1).max(7),\n});\n\n// NEW - Simplified Cardio Data Schema (replaces running, cycling, general)\nexport const CardioDataSchema = z.object({\n  type: z.literal('cardio'),\n  summary: z.string().nullish(), // Brief overview of cardio activities and background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  primaryActivities: z.array(z.string()),\n  keyMetrics: z.object({\n    weeklyDistance: z.number().positive().nullish(),\n    longestSession: z.number().positive().nullish(),\n    averagePace: z.string().nullish(),\n    preferredIntensity: z.enum(['low', 'moderate', 'high']).nullish(),\n  }).nullish(),\n  preferences: z.object({\n    indoor: z.boolean().nullish(),\n    outdoor: z.boolean().nullish(),\n    groupVsIndividual: z.enum(['group', 'individual', 'both']).nullish(),\n    timeOfDay: z.array(z.string()).nullish(),\n  }).nullish(),\n  frequency: z.number().int().min(1).max(7).nullish(),\n});\n\n// NEW - Simplified Activity Data Schema (only strength + cardio)\nexport const ActivityDataSchema = z.array(z.union([\n  StrengthDataSchema,\n  CardioDataSchema,\n]));\n\n// NEW - Simplified Goals Schema\nexport const GoalsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of fitness goals and motivation\n  primary: z.string(),\n  timeline: z.number().int().min(1).max(104).nullish(), // 1-104 weeks\n  specific: z.string().nullish(),\n  motivation: z.string().nullish(),\n});\n\n// THE ONLY FITNESS PROFILE SCHEMA - COMPLETE REPLACEMENT\nexport const FitnessProfileSchema = z.object({\n  goals: GoalsSchema,\n\n  // Overall experience level - single source of truth for fitness experience\n  // Can be derived from primary activity or set explicitly\n  experienceLevel: z.enum(['beginner', 'intermediate', 'advanced']).nullish(),\n\n  equipmentAccess: EquipmentAccessSchema.nullish(),\n  availability: AvailabilitySchema.nullish(),\n  constraints: z.array(ConstraintSchema).nullish(),\n  metrics: UserMetricsSchema.nullish(),\n\n  activities: ActivityDataSchema.nullish(),\n});\n\n// Schema for creating a new user\nexport const CreateUserSchema = z.object({\n  name: z.string().nullish(),\n  email: z.string().email().nullish(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullish(),\n  gender: z.string().nullish(),\n  isActive: z.boolean().nullish().default(true),\n  isAdmin: z.boolean().nullish().default(false),\n  stripeCustomerId: z.string().nullish(),\n  preferredSendHour: z.number().int().min(0).max(23).nullish(),\n  timezone: z.string().nullish(),\n});\n\n// Schema for updating a user\nexport const UpdateUserSchema = CreateUserSchema.partial();\n\n// Schema for creating/updating fitness profile\nexport const CreateFitnessProfileSchema = FitnessProfileSchema.partial();\n\n// Profile update patch schema (for tracking changes)\nexport const ProfileUpdatePatchSchema = z.object({\n  field: z.string(),\n  oldValue: z.unknown().nullable(),\n  newValue: z.unknown().nullable(),\n  timestamp: z.date(),\n});\n\n// Profile update request schema (for API endpoints)\nexport const ProfileUpdateRequestSchema = z.object({\n  updates: FitnessProfileSchema.partial(),\n  source: z.enum(['chat', 'form', 'admin', 'api', 'system']),\n  reason: z.string().optional().nullable(),\n});\n\n// Zod-inferred types (for validation)\nexport type FitnessProfile = z.infer<typeof FitnessProfileSchema>;\n\n// Activity-specific data types (only strength + cardio)\nexport type ActivityData = z.infer<typeof ActivityDataSchema>;\nexport type StrengthData = z.infer<typeof StrengthDataSchema>;\nexport type CardioData = z.infer<typeof CardioDataSchema>;\nexport type EquipmentAccess = z.infer<typeof EquipmentAccessSchema>;\nexport type Availability = z.infer<typeof AvailabilitySchema>;\nexport type Goals = z.infer<typeof GoalsSchema>;\nexport type UserMetrics = z.infer<typeof UserMetricsSchema>;\nexport type Constraint = z.infer<typeof ConstraintSchema>;\nexport type TemporaryEnvironmentChange = z.infer<typeof TemporaryEnvironmentChangeSchema>;\n","// Re-export types from shared (Zod schemas and inferred types)\nexport * from '@/shared/types/user';\n\n// Import Kysely DB types\nimport type { Users } from './_types';\nimport { Insertable, Selectable, Updateable } from 'kysely';\n\n// Kysely-based types (using database schema)\nexport type User = Selectable<Users>;\nexport type NewUser = Insertable<Users>;\nexport type UserUpdate = Updateable<Users>;\n\n// Import what we need for the UserModel class\nimport type { FitnessProfile } from '@/shared/types/user';\nimport { validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\nexport type CreateUserData = Omit<NewUser, 'id' | 'createdAt' | 'updatedAt'>;\nexport type CreateFitnessProfileData = Partial<FitnessProfile>;\n\nexport type UserWithProfile = User & {\n  profile?: string | null; // Joined from profiles table\n}\n\n/**\n * UserModel - Domain logic and validation only\n * No direct repository access - Services orchestrate repository calls\n */\nexport class UserModel {\n  static fromDb(user?: User): UserWithProfile | undefined {\n    return user ? { ...user } : undefined;\n  }\n\n  /**\n   * Convert DB result with joined profile to UserWithProfile\n   * Used when fetching user with profiles table joined\n   */\n  static fromDbWithProfile(dbResult: any): UserWithProfile { // eslint-disable-line @typescript-eslint/no-explicit-any\n    const { profile, ...userData } = dbResult;\n    return {\n      ...userData,\n      profile: profile || null,\n    };\n  }\n\n  /**\n   * Validates user data for creation\n   * @param userData - User data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserData(userData: CreateUserData): void {\n    if (!userData.name || userData.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (!userData.phoneNumber || !validateUSPhoneNumber(userData.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (userData.email && !this.isValidEmail(userData.email)) {\n      throw new Error('Invalid email format');\n    }\n  }\n\n  /**\n   * Validates user update data\n   * @param updates - Update data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserUpdates(updates: Partial<User>): void {\n    if (updates.name && updates.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (updates.phoneNumber && !validateUSPhoneNumber(updates.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (updates.email && !this.isValidEmail(updates.email)) {\n      throw new Error('Invalid email format');\n    }\n\n    if (updates.preferredSendHour !== undefined && (updates.preferredSendHour < 0 || updates.preferredSendHour > 23)) {\n      throw new Error('Preferred send hour must be between 0 and 23');\n    }\n\n    if (updates.age !== undefined && updates.age !== null && (updates.age < 1 || updates.age > 120)) {\n      throw new Error('Age must be between 1 and 120');\n    }\n  }\n\n  private static isValidEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n}\n","import { BaseRepository } from '@/server/repositories/baseRepository';\nimport {\n  type User,\n  type UserWithProfile,\n  type CreateUserData,\n  UserModel\n} from '@/server/models/user';\nimport { getLocalHourForTimezone } from '@/server/utils/timezone';\n\nexport class UserRepository extends BaseRepository {\n  async list(params: {\n    q?: string;\n    status?: string;\n    hasProfile?: boolean;\n    hasPlan?: boolean;\n    createdFrom?: string;\n    createdTo?: string;\n    page?: number;\n    pageSize?: number;\n    sort?: string;\n  }): Promise<{ users: UserWithProfile[]; total: number; }> {\n    const {\n      q,\n      createdFrom,\n      createdTo,\n      page = 1,\n      pageSize = 20,\n      sort = 'createdAt:desc',\n    } = params;\n\n    const [sortField, sortDir] = sort.split(':');\n\n    let query = this.db\n      .selectFrom('users')\n      .selectAll('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      query = query.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n\n    if (createdFrom) {\n      query = query.where('users.createdAt', '>=', new Date(createdFrom));\n    }\n    if (createdTo) {\n      query = query.where('users.createdAt', '<=', new Date(createdTo));\n    }\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      query = query.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      query = query.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    let countBuilder = this.db\n      .selectFrom('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      countBuilder = countBuilder.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n    if (createdFrom) countBuilder = countBuilder.where('users.createdAt', '>=', new Date(createdFrom));\n    if (createdTo) countBuilder = countBuilder.where('users.createdAt', '<=', new Date(createdTo));\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    const totalResult = await countBuilder\n      .select((eb) => eb.fn.countAll<number>().as('count'))\n      .executeTakeFirst();\n    const total = Number(totalResult?.count || 0);\n\n    const usersRows = await query\n      // @ts-expect-error dynamic orderBy\n      .orderBy(`users.${sortField}`, sortDir === 'asc' ? 'asc' : 'desc')\n      .offset((page - 1) * pageSize)\n      .limit(pageSize)\n      .execute();\n\n    const users: UserWithProfile[] = usersRows.map((u) => (UserModel.fromDb(u))).filter((u) => u !== undefined);\n\n    return { users, total };\n  }\n\n  async create(userData: CreateUserData): Promise<UserWithProfile | undefined> {\n    const user = await this.db\n    .insertInto('users')\n    .values({\n      name: userData.name,\n      phoneNumber: userData.phoneNumber,\n      age: userData.age || null,\n      gender: userData.gender || null,\n      email: userData.email || null,\n      stripeCustomerId: userData.stripeCustomerId || null,\n      timezone: userData.timezone,\n      preferredSendHour: userData.preferredSendHour,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    })\n    .returningAll()\n    .executeTakeFirstOrThrow()\n    return UserModel.fromDb(user);\n  }\n\n  async findById(id: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('id', '=', id)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByPhoneNumber(phoneNumber: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('phoneNumber', '=', phoneNumber)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByEmail(email: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('email', '=', email)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByStripeCustomerId(stripeCustomerId: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('stripeCustomerId', '=', stripeCustomerId)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async update(id: string, userData: Partial<CreateUserData>): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...userData,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst());\n  }\n\n  /**\n   * Find user with latest profile\n   * Performs LEFT JOIN with profiles table to get most recent profile\n   */\n  async findWithProfile(userId: string): Promise<UserWithProfile | undefined> {\n    const result = await this.db\n      .selectFrom('users')\n      .leftJoin('profiles', (join) =>\n        join\n          .onRef('profiles.clientId', '=', 'users.id')\n          .on((eb) => {\n            // Only join the most recent profile for this user\n            const subquery = eb\n              .selectFrom('profiles as p2')\n              .select((eb) => eb.fn.max('p2.createdAt').as('maxCreated'))\n              .whereRef('p2.clientId', '=', 'users.id');\n\n            return eb('profiles.createdAt', '=', subquery);\n          })\n      )\n      .selectAll('users')\n      .select('profiles.profile')\n      .where('users.id', '=', userId)\n      .executeTakeFirst();\n\n    if (!result) {\n      return undefined;\n    }\n\n    return UserModel.fromDbWithProfile(result);\n  }\n\n  async updatePreferences(userId: string, preferences: {\n    preferredSendHour?: number;\n    timezone?: string;\n    name?: string;\n  }): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...preferences,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', userId)\n      .returningAll()\n      .executeTakeFirstOrThrow());\n  }\n\n  async findUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    // This query finds all users with active subscriptions whose local hour is at or past their preferred send hour\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    // Note: This returns candidates - the caller should also filter by workout existence to avoid duplicates\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n\n    // Filter users whose local hour is at or past their preferred send hour\n    const matchingUsers: UserWithProfile[] = [];\n    const currentUtcDate = new Date();\n    currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n    for (const user of users) {\n      try {\n        const localHour = getLocalHourForTimezone(currentUtcDate, user.timezone);\n        if (localHour >= user.preferredSendHour) {\n          matchingUsers.push(UserModel.fromDb(user)!);\n        }\n      } catch (error) {\n        console.error(`Error processing user ${user.id} timezone:`, error);\n        // Skip users with invalid timezone data\n      }\n    }\n\n    return matchingUsers;\n  }\n\n  async findUsersByTimezones(timezones: string[]): Promise<UserWithProfile[]> {\n    // Return empty array if no timezones provided\n    if (timezones.length === 0) {\n      return [];\n    }\n\n    // Query users with active subscriptions in the specified timezones\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .where('timezone', 'in', timezones)\n      .selectAll('users')\n      .execute();\n\n    return users.map(u => UserModel.fromDb(u)).filter(u => u !== undefined) as UserWithProfile[];\n  }\n\n  async findActiveUsersWithPreferences(): Promise<User[]> {\n    return await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n  }\n\n  async delete(id: string): Promise<boolean> {\n    // First, clean up admin_activity_logs which has no FK constraint\n    // Delete where user is the target or the actor\n    await this.db\n      .deleteFrom('adminActivityLogs')\n      .where((eb) => eb.or([\n        eb('targetClientId', '=', id),\n        eb('actorClientId', '=', id)\n      ]))\n      .execute();\n\n    // Now delete the user - CASCADE will handle all other related tables:\n    // profile_updates, subscriptions, conversations, messages, fitness_plans,\n    // microcycles, workout_instances, user_onboarding, profiles, short_links, message_queues\n    const result = await this.db\n      .deleteFrom('users')\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows) > 0;\n  }\n\n  // ============================================\n  // Referral Code Methods\n  // ============================================\n\n  /**\n   * Generate a random 6-character referral code\n   * Uses uppercase letters and numbers, excluding confusing characters (O/0, I/1, L)\n   */\n  generateReferralCode(): string {\n    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';\n    let code = '';\n    for (let i = 0; i < 6; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  /**\n   * Get or create a referral code for a user\n   * If the user already has a code, returns it; otherwise generates and saves a new one\n   */\n  async getOrCreateReferralCode(userId: string): Promise<string | null> {\n    // First check if user already has a code\n    const user = await this.db\n      .selectFrom('users')\n      .select(['id', 'referralCode'])\n      .where('id', '=', userId)\n      .executeTakeFirst();\n\n    if (!user) {\n      return null;\n    }\n\n    if (user.referralCode) {\n      return user.referralCode;\n    }\n\n    // Generate a new code with retry logic for uniqueness\n    let attempts = 0;\n    const maxAttempts = 10;\n\n    while (attempts < maxAttempts) {\n      const newCode = this.generateReferralCode();\n\n      try {\n        const updated = await this.db\n          .updateTable('users')\n          .set({ referralCode: newCode, updatedAt: new Date() })\n          .where('id', '=', userId)\n          .where('referralCode', 'is', null) // Only update if still null (race condition protection)\n          .returningAll()\n          .executeTakeFirst();\n\n        if (updated) {\n          return newCode;\n        }\n\n        // If no rows updated, the user might have gotten a code from another request\n        const refreshedUser = await this.db\n          .selectFrom('users')\n          .select('referralCode')\n          .where('id', '=', userId)\n          .executeTakeFirst();\n\n        if (refreshedUser?.referralCode) {\n          return refreshedUser.referralCode;\n        }\n      } catch (error) {\n        // Unique constraint violation - try again with a new code\n        attempts++;\n        if (attempts >= maxAttempts) {\n          console.error(`Failed to generate unique referral code after ${maxAttempts} attempts`);\n          throw error;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Find a user by their referral code\n   * Used to validate referral codes during signup\n   */\n  async findByReferralCode(code: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('referralCode', '=', code.toUpperCase())\n      .selectAll()\n      .executeTakeFirst());\n  }\n}","/**\n * Timezone utilities for handling IANA timezone validation and conversions\n */\nimport { DateTime, IANAZone } from 'luxon';\nimport { now } from '@/shared/utils/date';\n\n// Common IANA timezones for UI selection\nexport const COMMON_TIMEZONES = [\n  // Americas\n  'America/New_York',\n  'America/Chicago',\n  'America/Denver',\n  'America/Los_Angeles',\n  'America/Toronto',\n  'America/Vancouver',\n  'America/Mexico_City',\n  'America/Sao_Paulo',\n  \n  // Europe\n  'Europe/London',\n  'Europe/Paris',\n  'Europe/Berlin',\n  'Europe/Madrid',\n  'Europe/Rome',\n  'Europe/Amsterdam',\n  'Europe/Stockholm',\n  'Europe/Moscow',\n  \n  // Asia Pacific\n  'Asia/Tokyo',\n  'Asia/Shanghai',\n  'Asia/Hong_Kong',\n  'Asia/Singapore',\n  'Asia/Seoul',\n  'Asia/Mumbai',\n  'Asia/Dubai',\n  'Australia/Sydney',\n  'Australia/Melbourne',\n  'Pacific/Auckland',\n] as const;\n\nexport type CommonTimezone = typeof COMMON_TIMEZONES[number];\n\n/**\n * Validates if a string is a valid IANA timezone identifier\n */\nexport function isValidIANATimezone(timezone: string): boolean {\n  return IANAZone.isValidZone(timezone);\n}\n\n/**\n * Gets the local hour for a given UTC date in a specific timezone\n */\nexport function getLocalHourForTimezone(utcDate: Date, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const dt = DateTime.fromJSDate(utcDate, { zone: 'utc' }).setZone(timezone);\n  return dt.hour;\n}\n\n/**\n * Converts a preferred local hour to UTC hour for a given timezone\n * Returns the UTC hour when it's the specified local hour in the given timezone\n */\nexport function convertPreferredHourToUTC(localHour: number, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  if (localHour < 0 || localHour > 23) {\n    throw new Error(`Invalid hour: ${localHour}. Must be between 0 and 23`);\n  }\n  \n  // Get current date in the target timezone\n  const nowDt = now(timezone);\n  // Set to the desired local hour\n  const targetTime = nowDt.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n  // Convert to UTC and get the hour\n  const utcTime = targetTime.setZone('utc');\n  return utcTime.hour;\n}\n\n/**\n * Gets all UTC hours when it's the specified local hour in the given timezone\n * This accounts for DST transitions where a local hour might occur at different UTC hours\n */\nexport function getAllUTCHoursForLocalHour(localHour: number, timezone: string): number[] {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const hours = new Set<number>();\n  const nowDt = now();\n\n  // Check for the next 365 days to cover all DST transitions\n  for (let i = 0; i < 365; i++) {\n    const date = nowDt.plus({ days: i }).setZone(timezone);\n    const targetTime = date.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n    const utcTime = targetTime.setZone('utc');\n    hours.add(utcTime.hour);\n  }\n  \n  return Array.from(hours).sort((a, b) => a - b);\n}\n\n/**\n * Formats a timezone identifier for display in UI\n * Example: \"America/New_York\" -> \"New York (EST/EDT)\"\n */\nexport function formatTimezoneForDisplay(timezone: string): string {\n  if (!isValidIANATimezone(timezone)) {\n    return timezone;\n  }\n  \n  try {\n    const nowDt = now(timezone);\n    const offset = nowDt.toFormat('ZZZ'); // e.g., \"EST\" or \"-05:00\"\n    \n    // Extract city name from timezone\n    const parts = timezone.split('/');\n    const city = parts[parts.length - 1].replace(/_/g, ' ');\n    \n    return `${city} (${offset})`;\n  } catch {\n    return timezone;\n  }\n}\n\nexport function getCommonTimezones(): readonly string[] {\n  return COMMON_TIMEZONES;\n}","import { BaseRepository } from './baseRepository';\nimport { sql } from 'kysely';\nimport type { UserOnboarding } from '../models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type OnboardingRecord = Selectable<UserOnboarding>;\nexport type NewOnboardingRecord = Insertable<UserOnboarding>;\nexport type OnboardingUpdate = Updateable<UserOnboarding>;\n\nexport interface SignupData {\n  // Formatted text for LLM (backward compatible)\n  fitnessGoals?: string;\n  currentExercise?: string;\n  injuries?: string;\n  environment?: string;\n\n  // Structured data from MultiStepSignupForm (for analytics/reporting)\n  primaryGoals?: ('strength' | 'endurance' | 'weight_loss' | 'general_fitness')[];\n  goalsElaboration?: string;\n  experienceLevel?: 'beginner' | 'intermediate' | 'advanced';\n  desiredDaysPerWeek?: '3_per_week' | '4_per_week' | '5_per_week' | '6_per_week';\n  availabilityElaboration?: string;\n  trainingLocation?: 'home' | 'commercial_gym' | 'bodyweight';\n  equipment?: string[];\n  acceptedRisks?: boolean;\n}\n\nexport type OnboardingStatus = 'pending' | 'in_progress' | 'completed' | 'failed';\n\n/**\n * OnboardingRepository\n *\n * Manages user onboarding state and signup data\n */\nexport class OnboardingRepository extends BaseRepository {\n  /**\n   * Create an onboarding record for a client\n   */\n  async create(clientId: string, signupData?: SignupData): Promise<OnboardingRecord> {\n    const record: NewOnboardingRecord = {\n      clientId,\n      signupData: signupData ? JSON.parse(JSON.stringify(signupData)) : null,\n      status: 'pending',\n      programMessagesSent: false,\n    };\n\n    return await this.db\n      .insertInto('userOnboarding')\n      .values(record)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find onboarding record by client ID\n   */\n  async findByClientId(clientId: string): Promise<OnboardingRecord | null> {\n    return await this.db\n      .selectFrom('userOnboarding')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Update onboarding status\n   */\n  async updateStatus(\n    clientId: string,\n    status: OnboardingStatus,\n    errorMessage?: string\n  ): Promise<OnboardingRecord> {\n    const update: OnboardingUpdate = {\n      status,\n      errorMessage: errorMessage ?? null,\n    };\n\n    return await this.db\n      .updateTable('userOnboarding')\n      .set(update)\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as started\n   */\n  async markStarted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'in_progress',\n        startedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Update current step (for progress tracking)\n   */\n  async updateCurrentStep(clientId: string, stepNumber: number): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ currentStep: stepNumber })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as completed\n   */\n  async markCompleted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'completed',\n        completedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark final program messages as sent\n   */\n  async markMessagesSent(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ programMessagesSent: true })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Check if messages have been sent\n   */\n  async hasMessagesSent(clientId: string): Promise<boolean> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('programMessagesSent')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.programMessagesSent ?? false;\n  }\n\n  /**\n   * Get signup data\n   */\n  async getSignupData(clientId: string): Promise<SignupData | null> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('signupData')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.signupData as SignupData ?? null;\n  }\n\n  /**\n   * Clear signup data (cleanup after profile creation)\n   */\n  async clearSignupData(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ signupData: null })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Delete onboarding record (full cleanup)\n   */\n  async delete(clientId: string): Promise<void> {\n    await this.db\n      .deleteFrom('userOnboarding')\n      .where('clientId', '=', clientId)\n      .execute();\n  }\n}\n","export enum CircuitState {\n  CLOSED = 'CLOSED',\n  OPEN = 'OPEN',\n  HALF_OPEN = 'HALF_OPEN'\n}\n\ninterface CircuitBreakerOptions {\n  failureThreshold: number;\n  resetTimeout: number;\n  monitoringPeriod: number;\n}\n\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failureCount: number = 0;\n  private successCount: number = 0;\n  private lastFailureTime: number | null = null;\n  private readonly options: CircuitBreakerOptions;\n\n  constructor(options: Partial<CircuitBreakerOptions> = {}) {\n    this.options = {\n      failureThreshold: options.failureThreshold || 5,\n      resetTimeout: options.resetTimeout || 60000, // 60 seconds\n      monitoringPeriod: options.monitoringPeriod || 60000 // 60 seconds\n    };\n  }\n\n  async execute<T>(fn: () => Promise<T>): Promise<T | null> {\n    if (this.state === CircuitState.OPEN) {\n      if (this.shouldAttemptReset()) {\n        this.state = CircuitState.HALF_OPEN;\n      } else {\n        console.warn('Circuit breaker is OPEN, skipping execution');\n        return null;\n      }\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.failureCount = 0;\n    if (this.state === CircuitState.HALF_OPEN) {\n      this.successCount++;\n      if (this.successCount >= 3) {\n        this.state = CircuitState.CLOSED;\n        this.successCount = 0;\n        console.info('Circuit breaker is now CLOSED');\n      }\n    }\n  }\n\n  private onFailure(): void {\n    this.failureCount++;\n    this.lastFailureTime = Date.now();\n    \n    if (this.state === CircuitState.HALF_OPEN) {\n      this.state = CircuitState.OPEN;\n      console.warn('Circuit breaker is now OPEN due to failure in HALF_OPEN state');\n    } else if (this.failureCount >= this.options.failureThreshold) {\n      this.state = CircuitState.OPEN;\n      console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`);\n    }\n  }\n\n  private shouldAttemptReset(): boolean {\n    return (\n      this.lastFailureTime !== null &&\n      Date.now() - this.lastFailureTime >= this.options.resetTimeout\n    );\n  }\n\n  getState(): CircuitState {\n    return this.state;\n  }\n\n  getStats() {\n    return {\n      state: this.state,\n      failureCount: this.failureCount,\n      successCount: this.successCount,\n      lastFailureTime: this.lastFailureTime\n    };\n  }\n}","import { UserModel, CreateUserData, UserWithProfile, User } from '@/server/models/user';\nimport { UserRepository } from '@/server/repositories/userRepository';\nimport { OnboardingRepository } from '@/server/repositories/onboardingRepository';\nimport { CircuitBreaker } from '@/server/utils/circuitBreaker';\nimport type { AdminUser, AdminUsersResponse, AdminUserDetailResponse, UserFilters, UserSort, Pagination } from '@/shared/types/admin';\nimport { getTimezonesAtLocalTime } from '@/shared/utils/date';\n\nexport interface CreateUserRequest {\n  name: string;\n  phoneNumber: string;\n  age?: number;\n  gender?: string;\n  timezone: string;\n  preferredSendHour: number;\n  email?: string;\n  stripeCustomerId?: string;\n}\n\nexport class UserService {\n  private static instance: UserService;\n  private userRepository: UserRepository;\n  private onboardingRepository: OnboardingRepository;\n  private circuitBreaker: CircuitBreaker;\n\n  private constructor() {\n    this.userRepository = new UserRepository();\n    this.onboardingRepository = new OnboardingRepository();\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeout: 60000, // 1 minute\n      monitoringPeriod: 60000 // 1 minute\n    });\n  }\n\n  public static getInstance(): UserService {\n    if (!UserService.instance) {\n      UserService.instance = new UserService();\n    }\n    return UserService.instance;\n  }\n\n  async createUser(request: CreateUserRequest): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute<UserWithProfile>(async (): Promise<UserWithProfile> => {\n      // Check if user already exists using repository\n      const existingUser = await this.userRepository.findByPhoneNumber(request.phoneNumber);\n      if (existingUser) {\n        throw new Error('User already exists with this phone number');\n      }\n\n      // Prepare user data\n      const userData: CreateUserData = {\n        name: request.name,\n        phoneNumber: request.phoneNumber,\n        age: request.age || null,\n        gender: request.gender || null,\n        timezone: request.timezone,\n        preferredSendHour: request.preferredSendHour,\n        email: request.email || null,\n        stripeCustomerId: request.stripeCustomerId || null,\n      };\n\n      // Validate user data using domain model\n      UserModel.validateUserData(userData);\n\n      // Create the user using repository\n      const user = await this.userRepository.create(userData);\n      if (!user) {\n        throw new Error('Failed to create user');\n      }\n\n      return user;\n    });\n    \n    if (!result) {\n      throw new Error('Failed to create user');\n    }\n    \n    return result;\n  }\n\n  async getUserById(id: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findById(id);\n    });\n    return result || undefined;\n  }\n\n  async getUserByPhone(phoneNumber: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findByPhoneNumber(phoneNumber);\n    });\n    return result || undefined;\n  }\n\n  async getUser(userId: string): Promise<UserWithProfile | undefined | null> {\n    return await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findWithProfile(userId);\n    });\n  }\n\n  async getUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findUsersForHour(currentUtcHour);\n    });\n    return result || [];\n  }\n\n  async getUsersForWeeklyMessage(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Business logic: Weekly messages are sent at 5pm on Sundays\n      const targetLocalHour = 17; // 5pm\n      const sunday = 7; // Luxon weekday (7 = Sunday)\n\n      // Calculate current UTC date\n      const currentUtcDate = new Date();\n      currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n      // Get all timezones that are currently at 5pm on Sunday\n      const matchingTimezones = getTimezonesAtLocalTime(\n        currentUtcDate,\n        targetLocalHour,\n        sunday\n      );\n\n      // Query users in those timezones\n      return await this.userRepository.findUsersByTimezones(matchingTimezones);\n    });\n    return result || [];\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Validate updates using domain model\n      UserModel.validateUserUpdates(updates);\n      \n      // Update using repository\n      return await this.userRepository.update(id, updates);\n    });\n    \n    if (!result) {\n      throw new Error('Failed to update user');\n    }\n    \n    return result;\n  }\n\n  async updatePreferences(userId: string, preferences: { preferredSendHour?: number; timezone?: string; name?: string }): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.updatePreferences(userId, preferences);\n    });\n\n    if (!result) {\n      throw new Error('Failed to update preferences');\n    }\n\n    return result;\n  }\n\n  // Admin-specific methods\n  async listUsersForAdmin(filters: UserFilters & { page?: number; pageSize?: number; sort?: UserSort }): Promise<AdminUsersResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const { page = 1, pageSize = 20, sort = { field: 'createdAt', direction: 'desc' }, ...restFilters } = filters;\n      \n      // Convert admin filters to repository filters\n      const repoParams = {\n        q: restFilters.search,\n        hasProfile: restFilters.hasProfile,\n        createdFrom: restFilters.createdAfter,\n        createdTo: restFilters.createdBefore,\n        page,\n        pageSize,\n        sort: `${sort.field}:${sort.direction}`\n      };\n\n      const { users, total } = await this.userRepository.list(repoParams);\n      \n      // Transform users to AdminUser format\n      const adminUsers: AdminUser[] = users.map(user => this.transformToAdminUser(user));\n      \n      // Calculate stats\n      const stats = await this.calculateUserStats();\n\n      const pagination: Pagination = {\n        page,\n        limit: pageSize,\n        total,\n        totalPages: Math.ceil(total / pageSize)\n      };\n\n      return {\n        users: adminUsers,\n        pagination,\n        stats\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch users');\n    }\n\n    return result;\n  }\n\n  async getUserForAdmin(id: string): Promise<AdminUserDetailResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const user = await this.userRepository.findWithProfile(id);\n      if (!user) {\n        throw new Error('User not found');\n      }\n\n      const adminUser = this.transformToAdminUser(user);\n\n      // Fetch signup data from onboarding\n      const signupData = await this.onboardingRepository.getSignupData(id);\n\n      return {\n        user: adminUser,\n        profile: user.profile || null,\n        signupData,\n        recentActivity: {\n          totalMessages: 0,\n          totalWorkouts: 0\n        }\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch user');\n    }\n\n    return result;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Verify user exists first\n      const user = await this.userRepository.findById(id);\n      if (!user) {\n        return false;\n      }\n\n      // Delete user and all cascaded data\n      return await this.userRepository.delete(id);\n    });\n\n    return result || false;\n  }\n\n  private transformToAdminUser(user: UserWithProfile): AdminUser {\n    const hasProfile = Boolean(user.profile);\n\n    return {\n      ...user,\n      hasProfile,\n      profileSummary: undefined, // Profile summary now comes from markdown profile parsing if needed\n      stats: {\n        totalWorkouts: 0,\n        isActiveToday: false\n      }\n    };\n  }\n\n  private async calculateUserStats() {\n    // Get basic counts from repository\n    const allUsersResult = await this.userRepository.list({ pageSize: 1000 });\n    const users = allUsersResult.users;\n\n    const totalUsers = users.length;\n    const withEmail = users.filter(u => u.email).length;\n    // Count users with profiles by checking profile\n    const withProfile = users.filter(u => u.profile).length;\n    const activeToday = 0; // TODO: Implement active user tracking\n\n    return {\n      totalUsers,\n      withEmail,\n      withProfile,\n      activeToday\n    };\n  }\n}\n\n// Export singleton instance\nexport const userService = UserService.getInstance();"],"names":[],"mappings":"qDAAA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAG0B,EAAA,CAAC,CAAC,MAAM,CAAC,CACjC,GAAI,EAAA,CAAC,CAAC,MAAM,GAAG,IAAI,GACnB,KAAM,EAAA,CAAC,CAAC,MAAM,GACd,MAAO,EAAA,CAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ,GAClC,YAAa,EAAA,CAAC,CAAC,MAAM,GAClB,SAAS,CAAC,EAAA,sBAAsB,EAChC,MAAM,CAAC,EAAA,qBAAqB,CAAE,CAAE,QAAS,iCAAkC,GAC9E,IAAK,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,QAAQ,GAC9C,OAAQ,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAC3B,iBAAkB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GACrC,kBAAmB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAC/C,SAAU,EAAA,CAAC,CAAC,MAAM,GAClB,UAAW,EAAA,CAAC,CAAC,IAAI,GACjB,UAAW,EAAA,CAAC,CAAC,IAAI,EACnB,GAGO,IAAM,EAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,CACzC,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,YAAa,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,GACzC,kBAAmB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,IAAI,GAAG,CAAC,KAChD,eAAgB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,UAAW,YAAa,UAAU,GAAG,OAAO,GAC5E,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,EAC9B,GAGa,EAAmC,EAAA,CAAC,CAAC,MAAM,CAAC,CACvD,GAAI,EAAA,CAAC,CAAC,MAAM,GACZ,YAAa,EAAA,CAAC,CAAC,MAAM,GACrB,UAAW,EAAA,CAAC,CAAC,MAAM,GACnB,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC5B,mBAAoB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GAC/C,qBAAsB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,EACnD,GAGa,EAAwB,EAAA,CAAC,CAAC,MAAM,CAAC,CAC5C,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,UAAW,EAAA,CAAC,CAAC,OAAO,GACpB,QAAS,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,aAAc,OAAQ,YAAa,OAAO,EAAE,OAAO,GACpE,cAAe,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GAC1C,YAAa,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GACxC,iBAAkB,EAAA,CAAC,CAAC,KAAK,CAAC,GAAkC,OAAO,EACrE,GAGa,EAAe,EAAA,CAAC,CAAC,MAAM,CAAC,CACnC,MAAO,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAC1B,KAAM,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,MAAO,KAAK,EAC1B,KAAM,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,EAC1B,GAGa,EAAoB,EAAA,CAAC,CAAC,MAAM,CAAC,CACxC,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,OAAQ,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,GACrC,OAAQ,EAAa,OAAO,GAC5B,gBAAiB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO,GAClD,aAAc,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,YAAa,iBAAkB,oBAAqB,cAAc,EAAE,OAAO,EACnG,GAGa,EAAmB,EAAA,CAAC,CAAC,MAAM,CAAC,CACvC,GAAI,EAAA,CAAC,CAAC,MAAM,GACZ,KAAM,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,SAAU,WAAY,UAAW,aAAa,EAC5D,YAAa,EAAA,CAAC,CAAC,MAAM,GACrB,SAAU,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,OAAQ,WAAY,SAAS,EAAE,OAAO,GACxD,kBAAmB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GAC9C,OAAQ,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,SAAU,WAAW,EACrC,UAAW,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC7B,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,YAAa,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,EAAC,EACnC,GAGa,EAAqB,EAAA,CAAC,CAAC,MAAM,CAAC,CACzC,KAAM,EAAA,CAAC,CAAC,OAAO,CAAC,YAChB,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,WAAY,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,WAAY,eAAgB,WAAW,EAC3D,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAClC,SAAU,EAAA,CAAC,CAAC,MAAM,CAAC,EAAA,CAAC,CAAC,MAAM,GAAI,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GAClD,YAAa,EAAA,CAAC,CAAC,MAAM,CAAC,CACpB,aAAc,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAChC,eAAgB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,GAC3C,kBAAmB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,EAChD,GAAG,OAAO,GACV,kBAAmB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,EACjD,GAGa,EAAmB,EAAA,CAAC,CAAC,MAAM,CAAC,CACvC,KAAM,EAAA,CAAC,CAAC,OAAO,CAAC,UAChB,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,WAAY,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,WAAY,eAAgB,WAAW,EAC3D,kBAAmB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IACnC,WAAY,EAAA,CAAC,CAAC,MAAM,CAAC,CACnB,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,GAC7C,eAAgB,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO,GAC7C,YAAa,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC/B,mBAAoB,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,MAAO,WAAY,OAAO,EAAE,OAAO,EACjE,GAAG,OAAO,GACV,YAAa,EAAA,CAAC,CAAC,MAAM,CAAC,CACpB,OAAQ,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,GAC3B,QAAS,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,GAC5B,kBAAmB,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,QAAS,aAAc,OAAO,EAAE,OAAO,GAClE,UAAW,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,OAAO,EACxC,GAAG,OAAO,GACV,UAAW,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,OAAO,EACnD,GAGa,EAAqB,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,KAAK,CAAC,CAChD,EACA,EACD,GAGY,EAAc,EAAA,CAAC,CAAC,MAAM,CAAC,CAClC,QAAS,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC3B,QAAS,EAAA,CAAC,CAAC,MAAM,GACjB,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,OAAO,GAClD,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC5B,WAAY,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,EAChC,GAGa,EAAuB,EAAA,CAAC,CAAC,MAAM,CAAC,CAC3C,MAAO,EAIP,gBAAiB,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,WAAY,eAAgB,WAAW,EAAE,OAAO,GAEzE,gBAAiB,EAAsB,OAAO,GAC9C,aAAc,EAAmB,OAAO,GACxC,YAAa,EAAA,CAAC,CAAC,KAAK,CAAC,GAAkB,OAAO,GAC9C,QAAS,EAAkB,OAAO,GAElC,WAAY,EAAmB,OAAO,EACxC,GAGgC,AAgBA,EAhBA,CAAC,CAAC,MAAM,CAAC,CACvC,KAAM,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GACxB,MAAO,EAAA,CAAC,CAAC,MAAM,GAAG,KAAK,GAAG,OAAO,GACjC,YAAa,EAAA,CAAC,CAAC,MAAM,GAClB,SAAS,CAAC,EAAA,sBAAsB,EAChC,MAAM,CAAC,EAAA,qBAAqB,CAAE,CAAE,QAAS,iCAAkC,GAC9E,IAAK,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,OAAO,GAC7C,OAAQ,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GAC1B,SAAU,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,GAAG,OAAO,EAAC,GACxC,QAAS,EAAA,CAAC,CAAC,OAAO,GAAG,OAAO,GAAG,OAAO,CAAC,IACvC,iBAAkB,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,GACpC,kBAAmB,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO,GAC1D,SAAU,EAAA,CAAC,CAAC,MAAM,GAAG,OAAO,EAC9B,GAGiD,OAAO,GAGd,EAAqB,OAAO,GAG9B,EAAA,CAAC,CAAC,MAAM,CAAC,CAC/C,MAAO,EAAA,CAAC,CAAC,MAAM,GACf,SAAU,EAAA,CAAC,CAAC,OAAO,GAAG,QAAQ,GAC9B,SAAU,EAAA,CAAC,CAAC,OAAO,GAAG,QAAQ,GAC9B,UAAW,EAAA,CAAC,CAAC,IAAI,EACnB,GAG0C,EAAA,CAAC,CAAC,MAAM,CAAC,CACjD,QAAS,EAAqB,OAAO,GACrC,OAAQ,EAAA,CAAC,CAAC,IAAI,CAAC,CAAC,OAAQ,OAAQ,QAAS,MAAO,SAAS,EACzD,OAAQ,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,EACxC,EC1JO,OAAM,EACX,OAAO,OAAO,CAAW,CAA+B,CACtD,OAAO,EAAO,CAAE,GAAG,CAAI,AAAC,OAAI,CAC9B,CAMA,OAAO,kBAAkB,CAAa,CAAmB,CACvD,GAAM,CAAE,SAAO,CAAE,GAAG,EAAU,CAAG,EACjC,MAAO,CACL,GAAG,CAAQ,CACX,QAAS,GAAW,IACtB,CACF,CAOA,OAAO,iBAAiB,CAAwB,CAAQ,CACtD,GAAI,CAAC,EAAS,IAAI,EAAI,EAAS,IAAI,CAAC,IAAI,GAAG,MAAM,CAAG,EAClD,CADqD,KAC/C,AAAI,MAAM,gDAGlB,GAAI,CAAC,EAAS,WAAW,EAAI,CAAC,CAAA,EAAA,EAAA,qBAAA,AAAqB,EAAC,EAAS,WAAW,EACtE,CADyE,KACnE,AAAI,MAAM,qCAGlB,GAAI,EAAS,KAAK,EAAI,CAAC,IAAI,CAAC,YAAY,CAAC,EAAS,KAAK,EACrD,CADwD,KAClD,AAAI,MAAM,uBAEpB,CAOA,OAAO,oBAAoB,CAAsB,CAAQ,CACvD,GAAI,EAAQ,IAAI,EAAI,EAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,CAAG,EAC/C,CADkD,KAC5C,AAAI,MAAM,gDAGlB,GAAI,EAAQ,WAAW,EAAI,CAAC,CAAA,EAAA,EAAA,qBAAA,AAAqB,EAAC,EAAQ,WAAW,EACnE,CADsE,KAChE,AAAI,MAAM,qCAGlB,GAAI,EAAQ,KAAK,EAAI,CAAC,IAAI,CAAC,YAAY,CAAC,EAAQ,KAAK,EACnD,CADsD,KAC5C,AAAJ,MAAU,wBAGlB,GAAI,KAA8B,MAAtB,OAAmC,UAAlB,GAAmB,EAAQ,iBAAiB,CAAG,GAAK,EAAQ,iBAAiB,CAAG,EAAA,CAAE,CAC7G,EADgH,IAC1G,AAAI,MAAM,gDAGlB,QAAoB,IAAhB,EAAQ,GAAG,EAAkC,OAAhB,CAAwB,CAAhB,GAAG,GAAc,EAAQ,GAAG,CAAG,GAAK,EAAQ,GAAG,CAAG,GAAA,CAAG,CAC5F,EAD+F,IACzF,AAAI,MAAM,gCAEpB,CAEA,OAAe,aAAa,CAAa,CAAW,CAElD,MADmB,AACZ,6BAAW,IAAI,CAAC,EACzB,CACF,iCC9FA,IAAA,EAAA,EAAA,CAAA,CAAA,OCGA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,CAAA,CAAA,ODKO,OAAM,UAAuB,EAAA,cAAc,CAChD,MAAM,KAAK,CAUV,CAAyD,CACxD,GAAM,GACJ,CAAC,aACD,CAAW,WACX,CAAS,MACT,EAAO,CAAC,UACR,EAAW,EAAE,MACb,EAAO,gBAAgB,CACxB,CAAG,EAEE,CAAC,EAAW,EAAQ,CAAG,EAAK,KAAK,CAAC,KAEpC,EAAQ,IAAI,CAAC,EAAE,CAChB,UAAU,CAAC,SACX,SAAS,CAAC,SAEb,GAAI,EAAG,CACL,IAAM,EAAO,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CACrB,EAAQ,EAAM,KAAK,CAAC,AAAC,GAAO,EAAG,EAAE,CAAC,CAChC,EAAG,aAAc,QAAS,GAC1B,EAAG,cAAe,QAAS,GAC3B,EAAG,oBAAqB,QAAS,GAClC,EACH,CAEI,IACF,EAAQ,EAAM,KADC,AACI,CAAC,kBAAmB,KAAM,IAAI,KAAK,GAAA,EAEpD,GACF,GAAQ,EAAM,GADD,EACM,CAAC,kBAAmB,KAAM,IAAI,KAAK,GAAA,GAI9B,IAAtB,EAAO,AAAqB,UAAX,CACnB,EAAQ,EAAM,KAAK,CAAC,AAAC,GACnB,EAAG,MAAM,CACP,EAAG,UAAU,CAAC,YACX,QAAQ,CAAC,oBAAqB,IAAK,YACnC,MAAM,CAAC,kBAGiB,IAAtB,EAAO,CAAsB,SAAZ,GAC1B,EAAQ,EAAM,KAAK,CAAC,AAAC,GACnB,EAAG,GAAG,CACJ,EAAG,MAAM,CACP,EAAG,UAAU,CAAC,YACX,QAAQ,CAAC,oBAAqB,IAAK,YACnC,MAAM,CAAC,iBAAA,EAMlB,IAAI,EAAe,IAAI,CAAC,EAAE,CACvB,UAAU,CAAC,SAEd,GAAI,EAAG,CACL,IAAM,EAAO,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CACrB,EAAe,EAAa,KAAK,CAAE,AAAD,GAAQ,EAAG,EAAE,CAAC,CAC9C,EAAG,aAAc,QAAS,GAC1B,EAAG,cAAe,QAAS,GAC3B,EAAG,oBAAqB,QAAS,GAClC,EACH,CACI,IAAa,EAAe,EAAa,KAAK,CAAC,kBAAmB,KAAM,IAAI,KAAK,GAAA,EACjF,IAAW,EAAe,EAAa,KAAK,CAAC,kBAAmB,KAAM,IAAI,KAAK,GAAA,GAGzD,IAAtB,EAA4B,AAArB,UAAU,CACnB,EAAe,EAAa,KAAK,CAAC,AAAC,GACjC,EAAG,MAAM,CACP,EAAG,UAAU,CAAC,YACX,QAAQ,CAAC,oBAAqB,IAAK,YACnC,MAAM,CAAC,kBAGiB,IAAtB,EAAO,CAAsB,SAAZ,GAC1B,EAAe,EAAa,KAAK,CAAC,AAAC,GACjC,EAAG,GAAG,CACJ,EAAG,MAAM,CACP,EAAG,UAAU,CAAC,YACX,QAAQ,CAAC,oBAAqB,IAAK,YACnC,MAAM,CAAC,iBAAA,EAMlB,IAAM,EAAc,MAAM,EACvB,MAAM,CAAC,AAAC,GAAO,EAAG,EAAE,CAAC,QAAQ,GAAW,EAAE,CAAC,UAC3C,gBAAgB,GACb,EAAQ,OAAO,GAAa,OAAS,GAW3C,MAAO,CAAE,MAFwB,CAPf,MAAM,EAErB,GADD,IACQ,CAAC,CAAC,MAAM,EAAE,EAAA,CAAW,CAAc,QAAZ,EAAoB,MAAQ,CADxB,OAElC,MAAM,CAAC,CAAC,EAAO,CAAC,EAAI,GACpB,KAAK,CAAC,GACN,OAAO,EAAA,EAEiC,GAAG,CAAC,AAAC,GAAO,EAAU,MAAM,CAAC,IAAK,MAAM,CAAC,AAAC,QAAY,IAAN,SAE3E,CAAM,CACxB,CAEA,MAAM,OAAO,CAAwB,CAAwC,CAC3E,IAAM,EAAO,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,MAAM,CAAC,CACN,KAAM,EAAS,IAAI,CACnB,YAAa,EAAS,WAAW,CACjC,IAAK,EAAS,GAAG,EAAI,KACrB,OAAQ,EAAS,MAAM,EAAI,KAC3B,MAAO,EAAS,KAAK,EAAI,KACzB,iBAAkB,EAAS,gBAAgB,EAAI,KAC/C,SAAU,EAAS,QAAQ,CAC3B,kBAAmB,EAAS,iBAAiB,CAC7C,UAAW,IAAI,KACf,UAAW,IAAI,IACjB,GACC,YAAY,GACZ,uBAAuB,GACxB,OAAO,EAAU,MAAM,CAAC,EAC1B,CAEA,MAAM,SAAS,CAAU,CAAwC,CAC/D,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,KAAM,IAAK,GACjB,SAAS,GACT,gBAAgB,GACrB,CAEA,MAAM,kBAAkB,CAAmB,CAAwC,CACjF,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,cAAe,IAAK,GAC1B,SAAS,GACT,gBAAgB,GACrB,CAEA,MAAM,YAAY,CAAa,CAAwC,CACrE,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,QAAS,IAAK,GACpB,SAAS,GACT,gBAAgB,GACrB,CAEA,MAAM,uBAAuB,CAAwB,CAAwC,CAC3F,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,mBAAoB,IAAK,GAC/B,SAAS,GACT,gBAAgB,GACrB,CAEA,MAAM,OAAO,CAAU,CAAE,CAAiC,CAAwC,CAChG,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,WAAW,CAAC,SACZ,GAAG,CAAC,CACH,GAAG,CAAQ,CACX,UAAW,IAAI,IACjB,GACC,KAAK,CAAC,KAAM,IAAK,GACjB,YAAY,GACZ,gBAAgB,GACrB,CAMA,MAAM,gBAAgB,CAAc,CAAwC,CAC1E,IAAM,EAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,QAAQ,CAAC,WAAY,AAAC,GACrB,EACG,KAAK,CAAC,oBAAqB,IAAK,YAChC,EAAE,CAAC,AAAC,IAEH,IAAM,EAAW,EACd,UAAU,CAAC,kBACX,MAAM,CAAE,AAAD,GAAQ,EAAG,EAAE,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC,eAC5C,QAAQ,CAAC,cAAe,IAAK,YAEhC,OAAO,EAAG,qBAAsB,IAAK,EACvC,IAEH,SAAS,CAAC,SACV,MAAM,CAAC,oBACP,KAAK,CAAC,WAAY,IAAK,GACvB,gBAAgB,GAEnB,GAAK,CAAD,CAIJ,MAJa,CAIN,EAAU,iBAAiB,CAAC,EACrC,CAEA,MAAM,kBAAkB,CAAc,CAAE,CAIvC,CAAwC,CACvC,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,WAAW,CAAC,SACZ,GAAG,CAAC,CACH,GAAG,CAAW,CACd,UAAW,IAAI,IACjB,GACC,KAAK,CAAC,KAAM,IAAK,GACjB,YAAY,GACZ,uBAAuB,GAC5B,CAEA,MAAM,iBAAiB,CAAsB,CAA8B,CAIzE,IAAM,EAAQ,MAAM,IAAI,CAAC,EAAE,CACxB,UAAU,CAAC,SACX,SAAS,CAAC,gBAAiB,WAAY,0BACvC,KAAK,CAAC,uBAAwB,IAAK,UACnC,SAAS,CAAC,SACV,OAAO,GAGJ,EAAmC,EAAE,CACrC,EAAiB,IAAI,KAG3B,IAAK,IAAM,KAFX,EAAe,WAAW,CAAC,EAAgB,EAAG,EAAG,GAE9B,GACjB,GADwB,AACpB,CCzMH,AD2MK,AADc,SC1MV,CAAwB,CAAa,CAAE,CAAgB,EACrE,IAAI,AAPG,CAOF,CAPE,QAAQ,CAAC,WAAW,CAOF,AAPG,GAQ1B,MAAU,AAAJ,EAD4B,IAClB,CAAC,uBAAuB,EAAE,EAAA,CAAU,EAItD,OAAO,AADI,EAAA,QAAQ,CAAC,UAAU,CAAC,EAAS,CAAE,KAAM,KAAM,GAAG,OAAO,CAAC,GACvD,IAAI,AAChB,GDmMkD,EAAgB,EAAK,QAAQ,GACtD,EAAK,iBAAiB,EAAE,AACvC,EAAc,IAAI,CAAC,EAAU,MAAM,CAAC,GAExC,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,CAAC,sBAAsB,EAAE,EAAK,EAAE,CAAC,UAAU,CAAC,CAAE,EAE9D,CAGF,OAAO,CACT,CAEA,MAAM,qBAAqB,CAAmB,CAA8B,QAE1E,AAAyB,GAAG,CAAxB,EAAU,MAAM,CACX,EAAE,CAaJ,CARO,MAAM,IAAI,CAAC,EAAE,CACxB,UAAU,CAAC,SACX,SAAS,CAAC,gBAAiB,WAAY,0BACvC,KAAK,CAAC,uBAAwB,IAAK,UACnC,KAAK,CAAC,WAAY,KAAM,GACxB,SAAS,CAAC,SACV,OAAO,EAAA,EAEG,GAAG,CAAC,GAAK,EAAU,MAAM,CAAC,IAAI,MAAM,CAAC,GAAK,AAAM,WAC/D,CAEA,MAAM,gCAAkD,CACtD,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,SACX,SAAS,CAAC,gBAAiB,WAAY,0BACvC,KAAK,CAAC,uBAAwB,IAAK,UACnC,SAAS,CAAC,SACV,OAAO,EACZ,CAEA,MAAM,OAAO,CAAU,CAAoB,CAmBzC,OAhBA,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,qBACX,KAAK,CAAC,AAAC,GAAO,EAAG,EAAE,CAAC,CACnB,EAAG,iBAAkB,IAAK,GAC1B,EAAG,gBAAiB,IAAK,GAC1B,GACA,OAAO,GAUH,OAAO,CALC,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,KAAK,CAAC,KAAM,IAAK,GACjB,gBAAgB,EAAA,EAEE,cAAc,EAAI,CACzC,CAUA,sBAA+B,CAC7B,IAAM,EAAQ,kCACV,EAAO,GACX,IAAK,IAAI,EAAI,EAAG,EAAI,EAAG,IAAK,AAC1B,GAAQ,EAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,GAAK,EAAM,MAAM,GAE9D,OAAO,CACT,CAMA,MAAM,wBAAwB,CAAc,CAA0B,CAEpE,IAAM,EAAO,MAAM,IAAI,CAAC,EAAE,CACvB,UAAU,CAAC,SACX,MAAM,CAAC,CAAC,KAAM,eAAe,EAC7B,KAAK,CAAC,KAAM,IAAK,GACjB,gBAAgB,GAEnB,GAAI,CAAC,EACH,IADS,GACF,KAGT,GAAI,EAAK,YAAY,CACnB,CADqB,MACd,EAAK,YAAY,CAI1B,IAAI,EAAW,EAGf,KAAO,MAAwB,CAC7B,IADgB,AACV,EAAU,IAAI,CAAC,oBAAoB,GAEzC,GAAI,CASF,GARgB,CAQZ,KARkB,IAQT,AARa,CAAC,EAAE,CAC1B,WAAW,CAAC,SACZ,GAAG,CAAC,CAAE,aAAc,EAAS,UAAW,IAAI,IAAO,GACnD,KAAK,CAAC,KAAM,IAAK,GACjB,KAAK,CAAC,eAAgB,KAAM,MAAM,AAClC,YAAY,GACZ,gBAAgB,GAGjB,OAAO,EAIT,IAAM,EAAgB,MAAM,CATiE,GAS7D,CAAC,EAAE,CAChC,UAAU,CAAC,SACX,MAAM,CAAC,gBACP,KAAK,CAAC,KAAM,IAAK,GACjB,gBAAgB,GAEnB,GAAI,GAAe,aACjB,CAD+B,MACxB,EAAc,YAEzB,AAFqC,CAEnC,MAAO,EAAO,CAGd,KAAI,GA/BY,GAiCd,MAFc,AACd,QAAQ,KADmB,AACd,CAAC,CAAC,8CAA8C,EAAE,YAAY,AACrE,CAEV,CACF,CAEA,MAN0F,CAAC,AAMpF,IACT,CAMA,MAAM,mBAAmB,CAAY,CAAwC,CAC3E,OAAO,EAAU,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,eAAgB,IAAK,EAAK,WAAW,IAC3C,SAAS,GACT,gBAAgB,GACrB,CACF,8CExZA,EAAA,EAAA,CAAA,CAAA,OAiCO,OAAM,UAA6B,EAAA,cAAc,CAItD,MAAM,OAAO,CAAgB,CAAE,CAAuB,CAA6B,CACjF,IAAM,EAA8B,CAClC,WACA,WAAY,EAAa,KAAK,KAAK,CAAC,KAAK,SAAS,CAAC,IAAe,KAClE,OAAQ,UACR,qBAAqB,CACvB,EAEA,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,kBACX,MAAM,CAAC,GACP,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,eAAe,CAAgB,CAAoC,CACvE,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,kBACX,SAAS,GACT,KAAK,CAAC,WAAY,IAAK,GACvB,gBAAgB,IAAM,IAC3B,CAKA,MAAM,aACJ,CAAgB,CAChB,CAAwB,CACxB,CAAqB,CACM,CAM3B,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAP2B,AAO1B,QANL,EACA,aAAc,GAAgB,IAChC,GAKG,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,YAAY,CAAgB,CAA6B,CAC7D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAAC,CACH,OAAQ,cACR,UAAW,EAAA,GAAG,CAAC,iBAAiB,CAAC,AACnC,GACC,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,kBAAkB,CAAgB,CAAE,CAAkB,CAA6B,CACvF,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAAC,CAAE,YAAa,CAAW,GAC9B,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,cAAc,CAAgB,CAA6B,CAC/D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAAC,CACH,OAAQ,YACR,YAAa,EAAA,GAAG,CAAC,iBAAiB,CAAC,AACrC,GACC,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,iBAAiB,CAAgB,CAA6B,CAClE,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAAC,CAAE,qBAAqB,CAAK,GAChC,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,gBAAgB,CAAgB,CAAoB,CACxD,IAAM,EAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,MAAM,CAAC,uBACP,KAAK,CAAC,WAAY,IAAK,GACvB,gBAAgB,GAEnB,OAAO,GAAQ,sBAAuB,CACxC,CAKA,MAAM,cAAc,CAAgB,CAA8B,CAChE,IAAM,EAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,MAAM,CAAC,cACP,KAAK,CAAC,WAAY,IAAK,GACvB,gBAAgB,GAEnB,OAAO,GAAQ,YAA4B,IAC7C,CAKA,MAAM,gBAAgB,CAAgB,CAA6B,CACjE,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,kBACZ,GAAG,CAAC,CAAE,WAAY,IAAK,GACvB,KAAK,CAAC,WAAY,IAAK,GACvB,YAAY,GACZ,uBAAuB,EAC5B,CAKA,MAAM,OAAO,CAAgB,CAAiB,CAC5C,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,kBACX,KAAK,CAAC,WAAY,IAAK,GACvB,OAAO,EACZ,CACF,kEC9KO,OAAM,EACH,MAAA,QAA0C,CAC1C,aAAuB,CAAE,CACzB,aAAuB,CAAE,CACzB,gBAAiC,IAAK,CAC7B,OAA+B,AAEhD,aAAY,EAA0C,CAAC,CAAC,CAAE,CACxD,IAAI,CAAC,OAAO,CAAG,CACb,iBAAkB,EAAQ,gBAAgB,EAAI,EAC9C,aAAc,EAAQ,YAAY,EAAI,IACtC,iBAAkB,EAAQ,gBAAgB,EAAI,GAChD,CACF,CAEA,CAJwD,KAIlD,QAJ+D,AAIpD,CAAoB,CAAqB,CACxD,GAAc,QAAwB,CAAlC,IAAI,CAAC,KAAK,CACZ,IAAI,IAAI,CAAC,kBAAkB,GAIzB,CAJ6B,MAG7B,QAAQ,IAAI,CAAC,+CACN,UAHP,IAAI,CAAC,KAAK,CAAA,YAOd,GAAI,CACF,IAAM,EAAS,MAAM,IAErB,OADA,IAAI,CAAC,SAAS,GACP,CACT,CAAE,MAAO,EAAO,CAEd,MADA,IAAI,CAAC,SAAS,GACR,CACR,CACF,CAEQ,WAAkB,CACxB,IAAI,CAAC,YAAY,CAAG,EACN,aAA6B,CAAvC,IAAI,CAAC,KAAK,GACZ,IAAI,CAAC,YAAY,GACb,IAAI,CAAC,YAAY,EAAI,GAAG,CAC1B,IAAI,CAAC,KAAK,CAAA,SACV,IAAI,CAAC,YAAY,CAAG,EACpB,QAAQ,IAAI,CAAC,kCAGnB,CAEQ,WAAkB,CACxB,IAAI,CAAC,YAAY,GACjB,IAAI,CAAC,eAAe,CAAG,KAAK,GAAG,GAEjB,aAA6B,CAAvC,IAAI,CAAC,KAAK,EACZ,IAAI,CAAC,KAAK,CAAA,OACV,QAAQ,IAAI,CAAC,kEACJ,IAAI,CAAC,YAAY,EAAI,IAAI,CAAC,OAAO,CAAC,gBAAgB,EAAE,CAC7D,IAAI,CAAC,KAAK,CAAA,OACV,QAAQ,IAAI,CAAC,CAAC,kCAAkC,EAAE,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,EAElF,CAEQ,oBAA8B,CACpC,OAC2B,OAAzB,IAAI,CAAC,eAAe,EACpB,KAAK,GAAG,GAAK,IAAI,CAAC,eAAe,EAAI,IAAI,CAAC,OAAO,CAAC,YAAY,AAElE,CAEA,UAAyB,CACvB,OAAO,IAAI,CAAC,KAAK,AACnB,CAEA,UAAW,CACT,MAAO,CACL,MAAO,IAAI,CAAC,KAAK,CACjB,aAAc,IAAI,CAAC,YAAY,CAC/B,aAAc,IAAI,CAAC,YAAY,CAC/B,gBAAiB,IAAI,CAAC,eAAe,AACvC,CACF,CACF,wDC3FA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEA,EAAA,EAAA,CAAA,CAAA,OAaO,OAAM,EACX,OAAe,QAAsB,CAC7B,cAA+B,CAC/B,oBAA2C,CAC3C,cAA+B,AAEvC,cAAsB,CACpB,IAAI,CAAC,cAAc,CAAG,IAAI,EAAA,cAAc,CACxC,IAAI,CAAC,oBAAoB,CAAG,IAAI,EAAA,oBAAoB,CACpD,IAAI,CAAC,cAAc,CAAG,IAAI,EAAA,cAAc,CAAC,CACvC,iBAAkB,EAClB,aAAc,IACd,iBAAkB,GACpB,EACF,CAEA,AAJ4B,OAId,IAJyB,SAIE,CAIvC,OAHI,AAAC,EAAY,QAAQ,EAAE,CACzB,EAAY,QAAQ,CAAG,IAAI,CAAA,EAEtB,EAAY,QAAQ,AAC7B,CAEA,MAAM,WAAW,CAA0B,CAA4B,CACrE,IAAM,EAAS,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAkB,UAGhE,GADqB,CACjB,KADuB,IAAI,CAAC,IACd,UAD4B,CAAC,iBAAiB,CAAC,EAAQ,WAAW,EAElF,MAAM,AAAI,MAAM,8CAIlB,IAAM,EAA2B,CAC/B,KAAM,EAAQ,IAAI,CAClB,YAAa,EAAQ,WAAW,CAChC,IAAK,EAAQ,GAAG,EAAI,KACpB,OAAQ,EAAQ,MAAM,EAAI,KAC1B,SAAU,EAAQ,QAAQ,CAC1B,kBAAmB,EAAQ,iBAAiB,CAC5C,MAAO,EAAQ,KAAK,EAAI,KACxB,iBAAkB,EAAQ,gBAAgB,EAAI,IAChD,EAGA,EAAA,SAAS,CAAC,gBAAgB,CAAC,GAG3B,IAAM,EAAO,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,GAC9C,GAAI,CAAC,EACH,IADS,EACH,AAAI,MAAM,yBAGlB,OAAO,CACT,GAEA,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,yBAGlB,OAAO,CACT,CAEA,MAAM,YAAY,CAAU,CAA6B,CAIvD,OAHe,AAGR,MAHc,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SACxC,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,UAE3B,CACnB,CAEA,MAAM,eAAe,CAAmB,CAA6B,CAInE,OAHe,AAGR,MAHc,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SACxC,MAAM,IAAI,CAAC,cAAc,CAAC,iBAAiB,CAAC,UAEpC,CACnB,CAEA,MAAM,QAAQ,CAAc,CAA+C,CACzE,OAAO,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SAChC,MAAM,IAAI,CAAC,cAAc,CAAC,eAAe,CAAC,GAErD,CAEA,MAAM,gBAAgB,CAAsB,CAA8B,CAIxE,OAAO,AAHQ,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SACxC,MAAM,IAAI,CAAC,cAAc,CAAC,gBAAgB,CAAC,KAEnC,EAAE,AACrB,CAEA,MAAM,yBAAyB,CAAsB,CAA8B,CAoBjF,OAnBe,AAmBR,MAnBc,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,UAM/C,IAAM,EAAiB,IAAI,KAC3B,EAAe,WAAW,CAAC,EAAgB,EAAG,EAAG,GAGjD,IAAM,EAAoB,CAAA,EAAA,EAAA,uBAAA,AAAuB,EAC/C,EATsB,GACT,CADa,EAe5B,AAdkB,IADgB,GAe3B,CALL,KAKW,IAAI,CAAC,OAJhB,IAV6C,GAcf,CAAC,oBAAoB,CAAC,EACxD,IACiB,EAAE,AACrB,CAEA,MAAM,WAAW,CAAU,CAAE,CAAsB,CAAiB,CAClE,IAAM,EAAS,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,UAE/C,EAAA,SAAS,CAAC,mBAAmB,CAAC,GAGvB,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,EAAI,KAG9C,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,yBAGlB,OAAO,CACT,CAEA,MAAM,kBAAkB,CAAc,CAAE,CAA6E,CAA4B,CAC/I,IAAM,EAAS,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SACxC,MAAM,IAAI,CAAC,cAAc,CAAC,iBAAiB,CAAC,EAAQ,IAG7D,GAAI,CAAC,EACH,MAAM,AAAI,AADC,MACK,gCAGlB,OAAO,CACT,CAGA,MAAM,kBAAkB,CAA4E,CAA+B,CACjI,IAAM,EAAS,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,UAC/C,GAAM,MAAE,EAAO,CAAC,UAAE,EAAW,EAAE,MAAE,EAAO,CAAE,MAAO,YAAa,UAAW,MAAO,CAAC,CAAE,GAAG,EAAa,CAAG,EAGhG,EAAa,CACjB,EAAG,EAAY,MAAM,CACrB,WAAY,EAAY,UAAU,CAClC,YAAa,EAAY,YAAY,CACrC,UAAW,EAAY,aAAa,MACpC,EACA,WACA,KAAM,CAAA,EAAG,EAAK,KAAK,CAAC,CAAC,EAAE,EAAK,SAAS,CAAA,CACvC,AADyC,EAGnC,OAAE,CAAK,OAAE,CAAK,CAAE,CAAG,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,GAGlD,EAA0B,EAAM,GAAG,CAAC,GAAQ,IAAI,CAAC,oBAAoB,CAAC,IAY5E,MAAO,CACL,MAAO,EACP,WAT6B,MAC7B,EACA,MAAO,QACP,EACA,WAAY,KAAK,IAAI,CAAC,EAAQ,EAChC,EAKE,MAZY,MAAM,IAAI,CAAC,kBAAkB,EAa3C,CACF,GAEA,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,yBAGlB,OAAO,CACT,CAEA,MAAM,gBAAgB,CAAU,CAAoC,CAClE,IAAM,EAAS,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,UAC/C,IAAM,EAAO,MAAM,IAAI,CAAC,cAAc,CAAC,eAAe,CAAC,GACvD,GAAI,CAAC,EACH,IADS,EACH,AAAI,MAAM,kBAGlB,IAAM,EAAY,IAAI,CAAC,oBAAoB,CAAC,GAGtC,EAAa,MAAM,IAAI,CAAC,oBAAoB,CAAC,aAAa,CAAC,GAEjE,MAAO,CACL,KAAM,EACN,QAAS,EAAK,OAAO,EAAI,gBACzB,EACA,eAAgB,CACd,cAAe,EACf,cAAe,CACjB,CACF,CACF,GAEA,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,wBAGlB,OAAO,CACT,CAEA,MAAM,WAAW,CAAU,CAAoB,CAY7C,OAXe,AAWR,MAXc,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,SAG/C,CAAI,CAAC,AADQ,MAAM,AACR,IADY,CAAC,cAAc,CAAC,QAAQ,CAAC,IAMzC,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,MAGzB,CACnB,CAEQ,qBAAqB,CAAqB,CAAa,CAC7D,IAAM,GAAa,CAAQ,EAAK,OAAO,CAEvC,MAAO,CACL,GAAG,CAAI,YACP,EACA,eAAgB,OAChB,MAAO,CACL,cAAe,EACf,eAAe,CACjB,CACF,CACF,CAEA,MAAc,oBAAqB,CAGjC,IAAM,EAAQ,CADS,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAE,SAAU,GAAK,EAAA,EAC1C,KAAK,CAE5B,EAAa,EAAM,MAAM,CACzB,EAAY,EAAM,MAAM,CAAC,GAAK,EAAE,KAAK,EAAE,MAAM,CAKnD,MAAO,YACL,YACA,EACA,YANkB,EAAM,MAAM,CAAC,GAAK,EAAE,OAAO,EAAE,MAAM,CAOrD,YANkB,CAOpB,CACF,CARyB,AAS3B,CAGO,IAAM,EAAc,EAAY,WAAW,mBAZgB"}