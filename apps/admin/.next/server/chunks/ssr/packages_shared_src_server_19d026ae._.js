module.exports=[570844,187244,307348,a=>{"use strict";a.i(458093);var b=a.i(647727);function c(a){if(!a||"string"!=typeof a)return null;let b=a.replace(/\D/g,"");if(!b)return null;if(10===b.length){if(b[0]>="2"&&b[0]<="9")return`+1${b}`}else if(11===b.length&&b.startsWith("1")){if(b[1]>="2"&&b[1]<="9")return`+${b}`}else if(a.startsWith("+1")&&11===b.length&&b.startsWith("1")&&b[1]>="2"&&b[1]<="9")return a;return null}function d(a){return!!a&&"string"==typeof a&&/^\+1[2-9]\d{2}[2-9]\d{6}$/.test(a)}b.z.object({id:b.z.string().uuid(),name:b.z.string(),email:b.z.string().email().nullable(),phoneNumber:b.z.string().transform(c).refine(d,{message:"Must be a valid US phone number"}),age:b.z.number().int().min(1).max(120).nullable(),gender:b.z.string().nullable(),stripeCustomerId:b.z.string().nullable(),preferredSendHour:b.z.number().int().min(0).max(23),timezone:b.z.string(),createdAt:b.z.date(),updatedAt:b.z.date()});let e=b.z.object({summary:b.z.string().nullish(),daysPerWeek:b.z.number().int().min(1).max(7),minutesPerSession:b.z.number().int().min(15).max(240),preferredTimes:b.z.array(b.z.enum(["morning","afternoon","evening"])).nullish(),schedule:b.z.string().nullish()}),f=b.z.object({id:b.z.string(),description:b.z.string(),startDate:b.z.string(),endDate:b.z.string().nullish(),location:b.z.string().nullish(),equipmentAvailable:b.z.array(b.z.string()).nullish(),equipmentUnavailable:b.z.array(b.z.string()).nullish()}),g=b.z.object({summary:b.z.string().nullish(),gymAccess:b.z.boolean(),gymType:b.z.enum(["commercial","home","community","none"]).nullish(),homeEquipment:b.z.array(b.z.string()).nullish(),limitations:b.z.array(b.z.string()).nullish(),temporaryChanges:b.z.array(f).nullish()}),h=b.z.object({value:b.z.number().positive(),unit:b.z.enum(["lbs","kg"]),date:b.z.string().nullish()}),i=b.z.object({summary:b.z.string().nullish(),height:b.z.number().positive().nullish(),weight:h.nullish(),bodyComposition:b.z.number().min(1).max(50).nullish(),fitnessLevel:b.z.enum(["sedentary","lightly_active","moderately_active","very_active"]).nullish()}),j=b.z.object({id:b.z.string(),type:b.z.enum(["injury","mobility","medical","preference"]),description:b.z.string(),severity:b.z.enum(["mild","moderate","severe"]).nullish(),affectedMovements:b.z.array(b.z.string()).nullish(),status:b.z.enum(["active","resolved"]),startDate:b.z.string().nullish(),endDate:b.z.string().nullish(),isTemporary:b.z.boolean().default(!1)}),k=b.z.object({type:b.z.literal("strength"),summary:b.z.string().nullish(),experience:b.z.enum(["beginner","intermediate","advanced"]),currentProgram:b.z.string().nullish(),keyLifts:b.z.record(b.z.string(),b.z.number()).nullish(),preferences:b.z.object({workoutStyle:b.z.string().nullish(),likedExercises:b.z.array(b.z.string()).nullish(),dislikedExercises:b.z.array(b.z.string()).nullish()}).nullish(),trainingFrequency:b.z.number().int().min(1).max(7)}),l=b.z.object({type:b.z.literal("cardio"),summary:b.z.string().nullish(),experience:b.z.enum(["beginner","intermediate","advanced"]),primaryActivities:b.z.array(b.z.string()),keyMetrics:b.z.object({weeklyDistance:b.z.number().positive().nullish(),longestSession:b.z.number().positive().nullish(),averagePace:b.z.string().nullish(),preferredIntensity:b.z.enum(["low","moderate","high"]).nullish()}).nullish(),preferences:b.z.object({indoor:b.z.boolean().nullish(),outdoor:b.z.boolean().nullish(),groupVsIndividual:b.z.enum(["group","individual","both"]).nullish(),timeOfDay:b.z.array(b.z.string()).nullish()}).nullish(),frequency:b.z.number().int().min(1).max(7).nullish()}),m=b.z.array(b.z.union([k,l])),n=b.z.object({summary:b.z.string().nullish(),primary:b.z.string(),timeline:b.z.number().int().min(1).max(104).nullish(),specific:b.z.string().nullish(),motivation:b.z.string().nullish()}),o=b.z.object({goals:n,experienceLevel:b.z.enum(["beginner","intermediate","advanced"]).nullish(),equipmentAccess:g.nullish(),availability:e.nullish(),constraints:b.z.array(j).nullish(),metrics:i.nullish(),activities:m.nullish()});b.z.object({name:b.z.string().nullish(),email:b.z.string().email().nullish(),phoneNumber:b.z.string().transform(c).refine(d,{message:"Must be a valid US phone number"}),age:b.z.number().int().min(1).max(120).nullish(),gender:b.z.string().nullish(),isActive:b.z.boolean().nullish().default(!0),isAdmin:b.z.boolean().nullish().default(!1),stripeCustomerId:b.z.string().nullish(),preferredSendHour:b.z.number().int().min(0).max(23).nullish(),timezone:b.z.string().nullish()}).partial(),o.partial(),b.z.object({field:b.z.string(),oldValue:b.z.unknown().nullable(),newValue:b.z.unknown().nullable(),timestamp:b.z.date()}),b.z.object({updates:o.partial(),source:b.z.enum(["chat","form","admin","api","system"]),reason:b.z.string().optional().nullable()});class p{static fromDb(a){return a?{...a}:void 0}static fromDbWithProfile(a){let{profile:b,...c}=a;return{...c,profile:b||null}}static validateUserData(a){if(!a.name||a.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(!a.phoneNumber||!d(a.phoneNumber))throw Error("Valid US phone number is required");if(a.email&&!this.isValidEmail(a.email))throw Error("Invalid email format")}static validateUserUpdates(a){if(a.name&&a.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(a.phoneNumber&&!d(a.phoneNumber))throw Error("Valid US phone number is required");if(a.email&&!this.isValidEmail(a.email))throw Error("Invalid email format");if(void 0!==a.preferredSendHour&&(a.preferredSendHour<0||a.preferredSendHour>23))throw Error("Preferred send hour must be between 0 and 23");if(void 0!==a.age&&null!==a.age&&(a.age<1||a.age>120))throw Error("Age must be between 1 and 120")}static isValidEmail(a){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)}}a.s(["UserModel",()=>p],570844);var q=a.i(449083);a.i(687045);var r=a.i(577329),s=a.i(482265);a.i(239496);class t extends q.BaseRepository{async list(a){let{q:b,createdFrom:c,createdTo:d,page:e=1,pageSize:f=20,sort:g="createdAt:desc"}=a,[h,i]=g.split(":"),j=this.db.selectFrom("users").selectAll("users");if(b){let a=`%${b}%`;j=j.where(b=>b.or([b("users.name","ilike",a),b("users.email","ilike",a),b("users.phoneNumber","ilike",a)]))}c&&(j=j.where("users.createdAt",">=",new Date(c))),d&&(j=j.where("users.createdAt","<=",new Date(d))),!0===a.hasProfile?j=j.where(a=>a.exists(a.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===a.hasProfile&&(j=j.where(a=>a.not(a.exists(a.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let k=this.db.selectFrom("users");if(b){let a=`%${b}%`;k=k.where(b=>b.or([b("users.name","ilike",a),b("users.email","ilike",a),b("users.phoneNumber","ilike",a)]))}c&&(k=k.where("users.createdAt",">=",new Date(c))),d&&(k=k.where("users.createdAt","<=",new Date(d))),!0===a.hasProfile?k=k.where(a=>a.exists(a.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===a.hasProfile&&(k=k.where(a=>a.not(a.exists(a.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let l=await k.select(a=>a.fn.countAll().as("count")).executeTakeFirst(),m=Number(l?.count||0);return{users:(await j.orderBy(`users.${h}`,"asc"===i?"asc":"desc").offset((e-1)*f).limit(f).execute()).map(a=>p.fromDb(a)).filter(a=>void 0!==a),total:m}}async create(a){let b=await this.db.insertInto("users").values({name:a.name,phoneNumber:a.phoneNumber,age:a.age||null,gender:a.gender||null,email:a.email||null,stripeCustomerId:a.stripeCustomerId||null,timezone:a.timezone,preferredSendHour:a.preferredSendHour,createdAt:new Date,updatedAt:new Date}).returningAll().executeTakeFirstOrThrow();return p.fromDb(b)}async findById(a){return p.fromDb(await this.db.selectFrom("users").where("id","=",a).selectAll().executeTakeFirst())}async findByPhoneNumber(a){return p.fromDb(await this.db.selectFrom("users").where("phoneNumber","=",a).selectAll().executeTakeFirst())}async findByEmail(a){return p.fromDb(await this.db.selectFrom("users").where("email","=",a).selectAll().executeTakeFirst())}async findByStripeCustomerId(a){return p.fromDb(await this.db.selectFrom("users").where("stripeCustomerId","=",a).selectAll().executeTakeFirst())}async update(a,b){return p.fromDb(await this.db.updateTable("users").set({...b,updatedAt:new Date}).where("id","=",a).returningAll().executeTakeFirst())}async findWithProfile(a){let b=await this.db.selectFrom("users").leftJoin("profiles",a=>a.onRef("profiles.clientId","=","users.id").on(a=>{let b=a.selectFrom("profiles as p2").select(a=>a.fn.max("p2.createdAt").as("maxCreated")).whereRef("p2.clientId","=","users.id");return a("profiles.createdAt","=",b)})).selectAll("users").select("profiles.profile").where("users.id","=",a).executeTakeFirst();if(b)return p.fromDbWithProfile(b)}async updatePreferences(a,b){return p.fromDb(await this.db.updateTable("users").set({...b,updatedAt:new Date}).where("id","=",a).returningAll().executeTakeFirstOrThrow())}async findUsersForHour(a){let b=await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute(),c=[],d=new Date;for(let e of(d.setUTCHours(a,0,0,0),b))try{(function(a,b){if(!s.IANAZone.isValidZone(b))throw Error(`Invalid IANA timezone: ${b}`);return r.DateTime.fromJSDate(a,{zone:"utc"}).setZone(b).hour})(d,e.timezone)>=e.preferredSendHour&&c.push(p.fromDb(e))}catch(a){console.error(`Error processing user ${e.id} timezone:`,a)}return c}async findUsersByTimezones(a){return 0===a.length?[]:(await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").where("timezone","in",a).selectAll("users").execute()).map(a=>p.fromDb(a)).filter(a=>void 0!==a)}async findActiveUsersWithPreferences(){return await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute()}async delete(a){return await this.db.deleteFrom("adminActivityLogs").where(b=>b.or([b("targetClientId","=",a),b("actorClientId","=",a)])).execute(),Number((await this.db.deleteFrom("users").where("id","=",a).executeTakeFirst()).numDeletedRows)>0}generateReferralCode(){let a="ABCDEFGHJKMNPQRSTUVWXYZ23456789",b="";for(let c=0;c<6;c++)b+=a.charAt(Math.floor(Math.random()*a.length));return b}async getOrCreateReferralCode(a){let b=await this.db.selectFrom("users").select(["id","referralCode"]).where("id","=",a).executeTakeFirst();if(!b)return null;if(b.referralCode)return b.referralCode;let c=0;for(;c<10;){let b=this.generateReferralCode();try{if(await this.db.updateTable("users").set({referralCode:b,updatedAt:new Date}).where("id","=",a).where("referralCode","is",null).returningAll().executeTakeFirst())return b;let c=await this.db.selectFrom("users").select("referralCode").where("id","=",a).executeTakeFirst();if(c?.referralCode)return c.referralCode}catch(a){if(++c>=10)throw console.error("Failed to generate unique referral code after 10 attempts"),a}}return null}async findByReferralCode(a){return p.fromDb(await this.db.selectFrom("users").where("referralCode","=",a.toUpperCase()).selectAll().executeTakeFirst())}}a.s(["UserRepository",()=>t],187244);var u=q,v=a.i(640796);class w extends u.BaseRepository{async create(a,b){let c={clientId:a,signupData:b?JSON.parse(JSON.stringify(b)):null,status:"pending",programMessagesSent:!1};return await this.db.insertInto("userOnboarding").values(c).returningAll().executeTakeFirstOrThrow()}async findByClientId(a){return await this.db.selectFrom("userOnboarding").selectAll().where("clientId","=",a).executeTakeFirst()??null}async updateStatus(a,b,c){return await this.db.updateTable("userOnboarding").set({status:b,errorMessage:c??null}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async markStarted(a){return await this.db.updateTable("userOnboarding").set({status:"in_progress",startedAt:v.sql`CURRENT_TIMESTAMP`}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async updateCurrentStep(a,b){return await this.db.updateTable("userOnboarding").set({currentStep:b}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async markCompleted(a){return await this.db.updateTable("userOnboarding").set({status:"completed",completedAt:v.sql`CURRENT_TIMESTAMP`}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async markMessagesSent(a){return await this.db.updateTable("userOnboarding").set({programMessagesSent:!0}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async hasMessagesSent(a){let b=await this.db.selectFrom("userOnboarding").select("programMessagesSent").where("clientId","=",a).executeTakeFirst();return b?.programMessagesSent??!1}async getSignupData(a){let b=await this.db.selectFrom("userOnboarding").select("signupData").where("clientId","=",a).executeTakeFirst();return b?.signupData??null}async clearSignupData(a){return await this.db.updateTable("userOnboarding").set({signupData:null}).where("clientId","=",a).returningAll().executeTakeFirstOrThrow()}async delete(a){await this.db.deleteFrom("userOnboarding").where("clientId","=",a).execute()}}a.s(["OnboardingRepository",()=>w],307348)},672221,a=>{"use strict";class b{state="CLOSED";failureCount=0;successCount=0;lastFailureTime=null;options;constructor(a={}){this.options={failureThreshold:a.failureThreshold||5,resetTimeout:a.resetTimeout||6e4,monitoringPeriod:a.monitoringPeriod||6e4}}async execute(a){if("OPEN"===this.state)if(!this.shouldAttemptReset())return console.warn("Circuit breaker is OPEN, skipping execution"),null;else this.state="HALF_OPEN";try{let b=await a();return this.onSuccess(),b}catch(a){throw this.onFailure(),a}}onSuccess(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=3&&(this.state="CLOSED",this.successCount=0,console.info("Circuit breaker is now CLOSED")))}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state?(this.state="OPEN",console.warn("Circuit breaker is now OPEN due to failure in HALF_OPEN state")):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`))}shouldAttemptReset(){return null!==this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.options.resetTimeout}getState(){return this.state}getStats(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount,lastFailureTime:this.lastFailureTime}}}a.s(["CircuitBreaker",()=>b])},608635,a=>{"use strict";var b=a.i(570844),c=a.i(187244),d=a.i(307348),e=a.i(672221),f=a.i(239496);class g{static instance;userRepository;onboardingRepository;circuitBreaker;constructor(){this.userRepository=new c.UserRepository,this.onboardingRepository=new d.OnboardingRepository,this.circuitBreaker=new e.CircuitBreaker({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4})}static getInstance(){return g.instance||(g.instance=new g),g.instance}async createUser(a){let c=await this.circuitBreaker.execute(async()=>{if(await this.userRepository.findByPhoneNumber(a.phoneNumber))throw Error("User already exists with this phone number");let c={name:a.name,phoneNumber:a.phoneNumber,age:a.age||null,gender:a.gender||null,timezone:a.timezone,preferredSendHour:a.preferredSendHour,email:a.email||null,stripeCustomerId:a.stripeCustomerId||null};b.UserModel.validateUserData(c);let d=await this.userRepository.create(c);if(!d)throw Error("Failed to create user");return d});if(!c)throw Error("Failed to create user");return c}async getUserById(a){return await this.circuitBreaker.execute(async()=>await this.userRepository.findById(a))||void 0}async getUserByPhone(a){return await this.circuitBreaker.execute(async()=>await this.userRepository.findByPhoneNumber(a))||void 0}async getUser(a){return await this.circuitBreaker.execute(async()=>await this.userRepository.findWithProfile(a))}async getUsersForHour(a){return await this.circuitBreaker.execute(async()=>await this.userRepository.findUsersForHour(a))||[]}async getUsersForWeeklyMessage(a){return await this.circuitBreaker.execute(async()=>{let b=new Date;b.setUTCHours(a,0,0,0);let c=(0,f.getTimezonesAtLocalTime)(b,17,7);return await this.userRepository.findUsersByTimezones(c)})||[]}async updateUser(a,c){let d=await this.circuitBreaker.execute(async()=>(b.UserModel.validateUserUpdates(c),await this.userRepository.update(a,c)));if(!d)throw Error("Failed to update user");return d}async updatePreferences(a,b){let c=await this.circuitBreaker.execute(async()=>await this.userRepository.updatePreferences(a,b));if(!c)throw Error("Failed to update preferences");return c}async listUsersForAdmin(a){let b=await this.circuitBreaker.execute(async()=>{let{page:b=1,pageSize:c=20,sort:d={field:"createdAt",direction:"desc"},...e}=a,f={q:e.search,hasProfile:e.hasProfile,createdFrom:e.createdAfter,createdTo:e.createdBefore,page:b,pageSize:c,sort:`${d.field}:${d.direction}`},{users:g,total:h}=await this.userRepository.list(f),i=g.map(a=>this.transformToAdminUser(a));return{users:i,pagination:{page:b,limit:c,total:h,totalPages:Math.ceil(h/c)},stats:await this.calculateUserStats()}});if(!b)throw Error("Failed to fetch users");return b}async getUserForAdmin(a){let b=await this.circuitBreaker.execute(async()=>{let b=await this.userRepository.findWithProfile(a);if(!b)throw Error("User not found");let c=this.transformToAdminUser(b),d=await this.onboardingRepository.getSignupData(a);return{user:c,profile:b.profile||null,signupData:d,recentActivity:{totalMessages:0,totalWorkouts:0}}});if(!b)throw Error("Failed to fetch user");return b}async deleteUser(a){return await this.circuitBreaker.execute(async()=>!!await this.userRepository.findById(a)&&await this.userRepository.delete(a))||!1}transformToAdminUser(a){let b=!!a.profile;return{...a,hasProfile:b,profileSummary:void 0,stats:{totalWorkouts:0,isActiveToday:!1}}}async calculateUserStats(){let a=(await this.userRepository.list({pageSize:1e3})).users,b=a.length,c=a.filter(a=>a.email).length;return{totalUsers:b,withEmail:c,withProfile:a.filter(a=>a.profile).length,activeToday:0}}}let h=g.getInstance();a.s(["UserService",()=>g,"userService",0,h])}];

//# sourceMappingURL=packages_shared_src_server_19d026ae._.js.map