module.exports=[598410,87621,a=>{"use strict";var b=a.i(449083),c=a.i(997239);class d extends b.BaseRepository{async insertFitnessPlan(a){let b=await this.db.insertInto("fitnessPlans").values({clientId:a.clientId,description:a.description,message:a.message,structured:a.structured?JSON.stringify(a.structured):null,startDate:a.startDate}).returningAll().executeTakeFirstOrThrow();return c.FitnessPlanModel.fromDB(b)}async getFitnessPlan(a){let b=await this.db.selectFrom("fitnessPlans").selectAll().where("id","=",a).executeTakeFirst();return b?c.FitnessPlanModel.fromDB(b):null}async getCurrentPlan(a){let b=await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",a).orderBy("createdAt","desc").executeTakeFirst();return b?c.FitnessPlanModel.fromDB(b):null}async getPlanHistory(a){return(await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",a).orderBy("createdAt","desc").execute()).map(c.FitnessPlanModel.fromDB)}async updateFitnessPlan(a,b){let d={updatedAt:new Date};void 0!==b.description&&(d.description=b.description),void 0!==b.message&&(d.message=b.message),void 0!==b.structured&&(d.structured=b.structured?JSON.stringify(b.structured):null);let e=await this.db.updateTable("fitnessPlans").set(d).where("id","=",a).returningAll().executeTakeFirst();return e?c.FitnessPlanModel.fromDB(e):null}async deleteFitnessPlan(a){return Number((await this.db.deleteFrom("fitnessPlans").where("id","=",a).executeTakeFirst()).numDeletedRows)>0}}a.s(["FitnessPlanRepository",()=>d],87621),a.i(534113);var e=a.i(163516),f=a.i(964081);class g{static instance;fitnessPlanRepo;constructor(){this.fitnessPlanRepo=new d(f.postgresDb)}static getInstance(){return g.instance||(g.instance=new g),g.instance}async createFitnessPlan(a){let b=await e.fitnessPlanAgentService.generateFitnessPlan(a),d=c.FitnessPlanModel.fromFitnessPlanOverview(a,b);return console.log("[FitnessPlanService] Created plan:",d.description?.substring(0,200)),await this.fitnessPlanRepo.insertFitnessPlan(d)}async getCurrentPlan(a){return await this.fitnessPlanRepo.getCurrentPlan(a)}async getPlanById(a){return await this.fitnessPlanRepo.getFitnessPlan(a)}async getPlanHistory(a){return await this.fitnessPlanRepo.getPlanHistory(a)}async updateFitnessPlan(a,b){return await this.fitnessPlanRepo.updateFitnessPlan(a,b)}async deleteFitnessPlan(a){return await this.fitnessPlanRepo.deleteFitnessPlan(a)}}let h=g.getInstance();a.s(["FitnessPlanService",()=>g,"fitnessPlanService",0,h],598410)},635582,a=>{"use strict";var b=a.i(449083);class c extends b.BaseRepository{async create(a){let b={...a,details:"string"==typeof a.details?a.details:JSON.stringify(a.details),structured:a.structured?"string"==typeof a.structured?a.structured:JSON.stringify(a.structured):null};return await this.db.insertInto("workoutInstances").values(b).returningAll().executeTakeFirstOrThrow()}async findByClientIdAndDateRange(a,b,c){return await this.db.selectFrom("workoutInstances").where("clientId","=",a).where("date",">=",b).where("date","<=",c).orderBy("date","asc").selectAll().execute()}async findByClientIdAndDate(a,b){let c=new Date(b),d=new Date(b);return d.setUTCDate(d.getUTCDate()+1),await this.db.selectFrom("workoutInstances").where("clientId","=",a).where("date",">=",c).where("date","<",d).selectAll().executeTakeFirst()}async getRecentWorkouts(a,b=10){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",a).orderBy("workoutInstances.date","desc").limit(b).execute()}async getRecentWorkoutsByDays(a,b=7){let c=new Date,d=new Date;return d.setDate(d.getDate()-b),await this.db.selectFrom("workoutInstances").where("clientId","=",a).where("date",">=",d).where("date","<=",c).orderBy("date","desc").selectAll().execute()}async getWorkoutByDate(a,b){return this.findByClientIdAndDate(a,b)}async update(a,b){let c={...b,updatedAt:new Date};return b.details&&(c.details="string"==typeof b.details?b.details:JSON.stringify(b.details)),void 0!==b.structured&&(c.structured=b.structured?"string"==typeof b.structured?b.structured:JSON.stringify(b.structured):null),await this.db.updateTable("workoutInstances").set(c).where("id","=",a).returningAll().executeTakeFirst()}async deleteOldWorkouts(a=90){let b=new Date;return b.setDate(b.getDate()-a),Number((await this.db.deleteFrom("workoutInstances").where("date","<",b).executeTakeFirst()).numDeletedRows)}async getWorkoutById(a){return await this.db.selectFrom("workoutInstances").selectAll().where("id","=",a).executeTakeFirst()}async getWorkoutsByMicrocycle(a,b){return await this.db.selectFrom("workoutInstances").where("clientId","=",a).where("microcycleId","=",b).orderBy("date","asc").selectAll().execute()}async getWorkoutsByDateRange(a,b,c){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",a).where("workoutInstances.date",">=",b).where("workoutInstances.date","<=",c).orderBy("workoutInstances.date","asc").execute()}async delete(a){return Number((await this.db.deleteFrom("workoutInstances").where("id","=",a).executeTakeFirst()).numDeletedRows)>0}async findUserIdsWithWorkoutsForUserDates(a){return 0===a.length?new Set:new Set((await this.db.selectFrom("workoutInstances").select("clientId").where(b=>{let c=a.map(({userId:a,startOfDay:c,endOfDay:d})=>b.and([b("clientId","=",a),b("date",">=",c),b("date","<",d)]));return b.or(c)}).execute()).map(a=>a.clientId))}}a.s(["WorkoutInstanceRepository",()=>c])},901251,894697,408842,312528,465740,a=>{"use strict";var b=a.i(635582),c=a.i(964081);a.i(534113);var d=a.i(187361),e=a.i(598410),f=a.i(239496),g=a.i(527833),h=a.i(938987);class i{db;constructor(a){this.db=a}async createMicrocycle(a){let b=await this.db.insertInto("microcycles").values({id:(0,g.v4)(),clientId:a.clientId,absoluteWeek:a.absoluteWeek,days:a.days,description:a.description,isDeload:a.isDeload,message:a.message,structured:a.structured?JSON.stringify(a.structured):null,startDate:a.startDate,endDate:a.endDate,isActive:a.isActive}).returningAll().executeTakeFirstOrThrow();return h.MicrocycleModel.fromDB(b)}async getActiveMicrocycle(a){let b=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",a).where("isActive","=",!0).orderBy("createdAt","desc").executeTakeFirst();return b?h.MicrocycleModel.fromDB(b):null}async getMicrocycleByAbsoluteWeek(a,b){let c=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",a).where("absoluteWeek","=",b).orderBy("updatedAt","desc").executeTakeFirst();return c?h.MicrocycleModel.fromDB(c):null}async deactivatePreviousMicrocycles(a){await this.db.updateTable("microcycles").set({isActive:!1}).where("clientId","=",a).where("isActive","=",!0).execute()}async updateMicrocycle(a,b){let c={};if(void 0!==b.days&&(c.days=b.days),void 0!==b.description&&(c.description=b.description),void 0!==b.isDeload&&(c.isDeload=b.isDeload),void 0!==b.message&&(c.message=b.message),void 0!==b.structured&&(c.structured=b.structured?JSON.stringify(b.structured):null),void 0!==b.isActive&&(c.isActive=b.isActive),void 0!==b.startDate&&(c.startDate=b.startDate),void 0!==b.endDate&&(c.endDate=b.endDate),void 0!==b.absoluteWeek&&(c.absoluteWeek=b.absoluteWeek),0===Object.keys(c).length)return this.getMicrocycleById(a);let d=await this.db.updateTable("microcycles").set({...c,updatedAt:new Date}).where("id","=",a).returningAll().executeTakeFirst();return d?h.MicrocycleModel.fromDB(d):null}async getMicrocycleById(a){let b=await this.db.selectFrom("microcycles").selectAll().where("id","=",a).executeTakeFirst();return b?h.MicrocycleModel.fromDB(b):null}async getRecentMicrocycles(a,b=5){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",a).orderBy("createdAt","desc").limit(b).execute()).map(a=>h.MicrocycleModel.fromDB(a))}async deleteMicrocycle(a){return(await this.db.deleteFrom("microcycles").where("id","=",a).executeTakeFirst()).numDeletedRows>0}async getAllMicrocycles(a){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",a).orderBy("absoluteWeek","asc").execute()).map(a=>h.MicrocycleModel.fromDB(a))}async getMicrocycleByDate(a,b){let c=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",a).where("startDate","<=",b).where("endDate",">=",b).orderBy("updatedAt","desc").executeTakeFirst();return c?h.MicrocycleModel.fromDB(c):null}}a.s(["MicrocycleRepository",()=>i],894697);var j=a.i(242357),k=a.i(608635);class l{static instance;microcycleRepo;userService;constructor(){this.microcycleRepo=new i(c.postgresDb),this.userService=k.UserService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async getActiveMicrocycle(a){return await this.microcycleRepo.getActiveMicrocycle(a)}async isActiveMicrocycleCurrent(a,b="America/New_York"){let c=await this.microcycleRepo.getActiveMicrocycle(a);if(!c)return!1;let{startDate:d}=this.calculateWeekDates(b),e=new Date(d);e.setHours(0,0,0,0);let f=new Date(c.startDate);f.setHours(0,0,0,0);let g=new Date(c.endDate);return g.setHours(0,0,0,0),e>=f&&e<=g}async getAllMicrocycles(a){return await this.microcycleRepo.getAllMicrocycles(a)}async getMicrocycleByAbsoluteWeek(a,b){return await this.microcycleRepo.getMicrocycleByAbsoluteWeek(a,b)}async getMicrocycleByDate(a,b){return await this.microcycleRepo.getMicrocycleByDate(a,b)}async getMicrocycleById(a){return await this.microcycleRepo.getMicrocycleById(a)}async updateMicrocycleDays(a,b){return await this.microcycleRepo.updateMicrocycle(a,{days:b})}async updateMicrocycle(a,b){return await this.microcycleRepo.updateMicrocycle(a,b)}async createMicrocycleFromProgress(a,b,c){let d=await this.userService.getUser(a);if(!d)throw Error(`Client not found: ${a}`);let{days:e,description:f,isDeload:g,message:h,structure:i}=await this.generateMicrocycle(d,c.absoluteWeek),j=await this.microcycleRepo.createMicrocycle({clientId:a,absoluteWeek:c.absoluteWeek,days:e,description:f,isDeload:g,message:h,structured:i,startDate:c.weekStartDate,endDate:c.weekEndDate,isActive:!1});return console.log(`[MicrocycleService] Created microcycle for client ${a}, week ${c.absoluteWeek} (${c.weekStartDate.toISOString()} - ${c.weekEndDate.toISOString()})`),j}async generateMicrocycle(a,b){try{let c=await j.microcycleAgentService.generateMicrocycle(a,b);return console.log(`[MicrocycleService] Generated microcycle for week ${b}, isDeload=${c.isDeload}`),c}catch(a){throw console.error("[MicrocycleService] Failed to generate microcycle:",a),a}}calculateWeekDates(a="America/New_York"){let b=(0,f.now)(a).toJSDate();return{startDate:(0,f.startOfWeek)(b,a),endDate:(0,f.endOfWeek)(b,a)}}async deleteMicrocycleWithWorkouts(b){let c=await this.microcycleRepo.getMicrocycleById(b);if(!c)return{deleted:!1,deletedWorkoutsCount:0};let{workoutInstanceService:d}=await a.A(540881),e=await d.getWorkoutsByMicrocycle(c.clientId,b),f=0;for(let a of e)await d.deleteWorkout(a.id,c.clientId)&&f++;return{deleted:await this.microcycleRepo.deleteMicrocycle(b),deletedWorkoutsCount:f}}}let m=l.getInstance();a.s(["MicrocycleService",()=>l,"microcycleService",0,m],408842);class n{static instance;microcycleService;constructor(){this.microcycleService=l.getInstance()}static getInstance(){return n.instance||(n.instance=new n),n.instance}async getProgressForDate(a,b,c="America/New_York"){if(!a||!a.id)return null;let d=(0,f.parseDate)(a.startDate);if(!d)return null;let e=(0,f.startOfWeek)(d,c),g=(0,f.startOfWeek)(b,c),h=(0,f.diffInWeeks)(g,e,c)+1;if(h<1)return null;let i=await this.microcycleService.getMicrocycleByDate(a.clientId,b);return i||(i=await this.microcycleService.getMicrocycleByAbsoluteWeek(a.clientId,h)),{fitnessPlan:a,microcycle:i,absoluteWeek:h,dayOfWeek:(0,f.getWeekday)(b,c),weekStartDate:(0,f.startOfWeek)(b,c),weekEndDate:(0,f.endOfWeek)(b,c)}}async getCurrentProgress(a,b="America/New_York"){let c=(0,f.now)(b).toJSDate();return await this.getProgressForDate(a,c,b)}async getOrCreateMicrocycleForDate(a,b,c,d="America/New_York",e=!1){let f=await this.getProgressForDate(b,c,d);if(!f)throw Error(`Could not calculate progress for date ${c}`);if(f.microcycle&&!e)return{microcycle:f.microcycle,progress:f,wasCreated:!1};let g=await this.microcycleService.createMicrocycleFromProgress(a,b,f),h={...f,microcycle:g};return{microcycle:g,progress:h,wasCreated:!0}}}let o=n.getInstance();a.s(["ProgressService",()=>n,"progressService",0,o],312528);var p=a.i(449083),q=a.i(640796);class r extends p.BaseRepository{generateUniqueCode(){let a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",b="";for(let c=0;c<5;c++)b+=a.charAt(Math.floor(Math.random()*a.length));return b}async createShortLink(a){return await this.db.insertInto("shortLinks").values({code:a.code,targetPath:a.targetPath,clientId:a.clientId,expiresAt:a.expiresAt,createdAt:new Date,accessCount:0}).onConflict(b=>b.column("code").doUpdateSet({targetPath:a.targetPath,clientId:a.clientId,expiresAt:a.expiresAt,createdAt:new Date,accessCount:0,lastAccessedAt:null})).returningAll().executeTakeFirstOrThrow()}async findByCode(a){return await this.db.selectFrom("shortLinks").selectAll().where("code","=",a).executeTakeFirst()||null}async incrementAccessCount(a){await this.db.updateTable("shortLinks").set({accessCount:q.sql`access_count + 1`,lastAccessedAt:new Date}).where("id","=",a).execute()}async deleteExpiredLinks(){return Number((await this.db.deleteFrom("shortLinks").where("expiresAt","<",new Date).where("expiresAt","is not",null).executeTakeFirst()).numDeletedRows||0)}async deleteByClientId(a){return Number((await this.db.deleteFrom("shortLinks").where("clientId","=",a).executeTakeFirst()).numDeletedRows||0)}async findByClientId(a){return await this.db.selectFrom("shortLinks").selectAll().where("clientId","=",a).orderBy("createdAt","desc").execute()}}a.s(["ShortLinkRepository",()=>r],465740);var s=a.i(555977);class t{static instance;repository;DEFAULT_EXPIRY_DAYS=(0,s.getShortLinksConfig)().defaultExpiryDays;constructor(){this.repository=new r}static getInstance(){return t.instance||(t.instance=new t),t.instance}async createShortLink(a,b,c){let d=c?.code||this.repository.generateUniqueCode(),e=c?.expiresAt||new Date(Date.now()+24*this.DEFAULT_EXPIRY_DAYS*36e5),f=await this.repository.createShortLink({code:d,targetPath:b,clientId:a,expiresAt:e});return console.log(`[ShortLinkService] Created short link: ${d} -> ${b}`),f}async resolveShortLink(a){let b=await this.repository.findByCode(a);return b?null!==b.expiresAt&&new Date(b.expiresAt)<new Date?(console.log(`[ShortLinkService] Short link expired: ${a}`),{link:b,isExpired:!0}):(this.repository.incrementAccessCount(b.id).catch(b=>{console.error(`[ShortLinkService] Failed to increment access count for ${a}:`,b)}),console.log(`[ShortLinkService] Resolved short link: ${a} -> ${b.targetPath}`),{link:b,isExpired:!1}):(console.log(`[ShortLinkService] Short link not found: ${a}`),null)}async createWorkoutLink(a,b,c){let d=`/me?workout=${b}`;return this.createShortLink(a,d,c)}async createProfileLink(a,b){return this.createShortLink(a,"/me",b)}getFullUrl(a){let b=(0,s.getShortLinksConfig)().domain||"https://gtxt.ai";return`${b}/l/${a}`}async cleanupExpiredLinks(){try{let a=await this.repository.deleteExpiredLinks();return console.log(`[ShortLinkService] Cleaned up ${a} expired short links`),a}catch(a){return console.error("[ShortLinkService] Error cleaning up expired links:",a),0}}}let u=t.getInstance();class v{static instance;workoutRepo;fitnessPlanService;progressService;microcycleService;constructor(){this.workoutRepo=new b.WorkoutInstanceRepository(c.postgresDb),this.fitnessPlanService=e.FitnessPlanService.getInstance(),this.progressService=n.getInstance(),this.microcycleService=l.getInstance()}static getInstance(){return v.instance||(v.instance=new v),v.instance}async getRecentWorkouts(a,b=10){return await this.workoutRepo.getRecentWorkouts(a,b)}async getWorkoutsByDateRange(a,b,c){return await this.workoutRepo.getWorkoutsByDateRange(a,b,c)}async getWorkoutById(a,b){let c=await this.workoutRepo.getWorkoutById(a);return c&&c.clientId===b?c:null}async getWorkoutByIdInternal(a){return await this.workoutRepo.getWorkoutById(a)}async getWorkoutByUserIdAndDate(a,b){return await this.workoutRepo.findByClientIdAndDate(a,b)}async updateWorkoutMessage(a,b){return await this.workoutRepo.update(a,{message:b})}async createWorkout(a){return await this.workoutRepo.create(a)}async updateWorkout(a,b){return await this.workoutRepo.update(a,b)}async generateWorkoutForDate(a,b,c){try{let e=await this.fitnessPlanService.getCurrentPlan(a.id);if(!e)return console.log(`No fitness plan found for user ${a.id}`),null;if(!await this.progressService.getProgressForDate(e,b.toJSDate(),a.timezone))return console.log(`No progress found for user ${a.id} on ${b.toISODate()}`),null;let g=c??null;if(g||(g=(await this.progressService.getOrCreateMicrocycleForDate(a.id,e,b.toJSDate(),a.timezone)).microcycle),!g)return console.log(`Could not get/create microcycle for user ${a.id}`),null;let h=(0,f.getWeekday)(b.toJSDate(),a.timezone)-1,i=g.days?.[h];if(!i||"string"!=typeof i)return console.log(`No overview found for day index ${h} in microcycle ${g.id}`),null;let j=g.structured?.days?.[h],k=j?.activityType,{response:l,message:m,structure:n}=await d.workoutAgentService.generateWorkout(a,i,g.isDeload??!1,k),o=n?.title||"Workout",p={clientId:a.id,microcycleId:g.id,date:b.toJSDate(),sessionType:"workout",goal:i.substring(0,100),details:JSON.parse(JSON.stringify({theme:o})),description:l,message:m,structured:n,completedAt:null,createdAt:new Date,updatedAt:new Date},q=await this.createWorkout(p);console.log(`Generated and saved workout for user ${a.id} on ${b.toISODate()}`);try{let c=await u.createWorkoutLink(a.id,q.id),d=u.getFullUrl(c.code);if(console.log(`Created short link for workout ${q.id}: ${d}`),q.message){let c=(0,f.getDayOfWeekName)(b.toJSDate(),a.timezone);q.message=`${c}

${q.message}

(More details: ${d})`.replace(/\n{3,}/g,"\n\n").trim(),await this.updateWorkoutMessage(q.id,q.message)}}catch(a){console.error(`Failed to create short link for workout ${q.id}:`,a)}return q}catch(b){throw console.error(`Error generating workout for user ${a.id}:`,b),b}}mapThemeToSessionType(a){let b=a.toLowerCase();return b.includes("run")||b.includes("running")?"run":b.includes("metcon")||b.includes("hiit")||b.includes("conditioning")||b.includes("cardio")?"metcon":b.includes("lift")||b.includes("strength")||b.includes("upper")||b.includes("lower")||b.includes("push")||b.includes("pull")?"lift":b.includes("mobility")||b.includes("flexibility")||b.includes("stretch")?"mobility":b.includes("rest")||b.includes("recovery")||b.includes("deload")?"rest":"other"}async deleteWorkout(a,b){let c=await this.workoutRepo.getWorkoutById(a);return!!c&&c.clientId===b&&await this.workoutRepo.delete(a)}async getWorkoutsByMicrocycle(a,b){return await this.workoutRepo.getWorkoutsByMicrocycle(a,b)}}let w=v.getInstance();a.s(["WorkoutInstanceService",()=>v,"workoutInstanceService",0,w],901251)}];

//# sourceMappingURL=packages_shared_src_server_2e8ab77f._.js.map