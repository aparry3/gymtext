{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/env.ts"],"sourcesContent":["/**\n * Server Environment Variables\n *\n * THE ONLY place in the codebase that validates server-side secrets.\n * App config overrides are handled by shared/config.\n */\nimport { z } from 'zod';\n\n// =============================================================================\n// Zod Schema - Server Secrets Only\n// =============================================================================\n\nconst ServerEnvSchema = z.object({\n  // -------------------------------------------------------------------------\n  // Database\n  // -------------------------------------------------------------------------\n  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),\n  SESSION_ENCRYPTION_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Twilio\n  // -------------------------------------------------------------------------\n  TWILIO_ACCOUNT_SID: z.string().min(1, 'TWILIO_ACCOUNT_SID is required'),\n  TWILIO_AUTH_TOKEN: z.string().min(1, 'TWILIO_AUTH_TOKEN is required'),\n  TWILIO_NUMBER: z.string().min(1, 'TWILIO_NUMBER is required'),\n\n  // -------------------------------------------------------------------------\n  // Stripe\n  // -------------------------------------------------------------------------\n  STRIPE_SECRET_KEY: z.string().min(1, 'STRIPE_SECRET_KEY is required'),\n  STRIPE_WEBHOOK_SECRET: z.string().optional(), // Optional for development\n\n  // -------------------------------------------------------------------------\n  // AI - validated but LangChain reads these directly from process.env\n  // -------------------------------------------------------------------------\n  OPENAI_API_KEY: z.string().min(1, 'OPENAI_API_KEY is required'),\n  GOOGLE_API_KEY: z.string().min(1, 'GOOGLE_API_KEY is required'),\n  XAI_API_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Pinecone\n  // -------------------------------------------------------------------------\n  PINECONE_API_KEY: z.string().min(1, 'PINECONE_API_KEY is required'),\n  PINECONE_INDEX: z.string().min(1, 'PINECONE_INDEX is required'),\n\n  // -------------------------------------------------------------------------\n  // Background Jobs\n  // -------------------------------------------------------------------------\n  CRON_SECRET: z.string().optional(),\n  INNGEST_EVENT_KEY: z.string().optional(),\n  INNGEST_SIGNING_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Environment (for server-side env detection)\n  // -------------------------------------------------------------------------\n  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),\n  APP_ENV: z.enum(['development', 'staging', 'production']).optional(),\n});\n\n// =============================================================================\n// Validation\n// =============================================================================\n\nfunction validateServerEnv() {\n  const result = ServerEnvSchema.safeParse(process.env);\n\n  if (!result.success) {\n    const errors = result.error.errors\n      .map((e) => `  - ${e.path.join('.')}: ${e.message}`)\n      .join('\\n');\n\n    throw new Error(\n      `Server environment validation failed:\\n${errors}\\n\\n` +\n        `Ensure all required environment variables are set.`\n    );\n  }\n\n  return result.data;\n}\n\n// Singleton - validated once at startup\nlet _serverEnv: z.infer<typeof ServerEnvSchema> | null = null;\n\n/**\n * Get validated server environment variables.\n * Caches the result for subsequent calls.\n */\nexport function getServerEnv() {\n  if (!_serverEnv) {\n    _serverEnv = validateServerEnv();\n  }\n  return _serverEnv;\n}\n\n/**\n * Reset env cache (useful for testing).\n */\nexport function resetServerEnv() {\n  _serverEnv = null;\n}\n\n// Export type\nexport type ServerEnv = z.infer<typeof ServerEnvSchema>;\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AACD;AAAA;;AAEA,gFAAgF;AAChF,mCAAmC;AACnC,gFAAgF;AAEhF,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IAC/B,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,cAAc,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAChC,wBAAwB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE3C,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,oBAAoB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACtC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,eAAe,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAEjC,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,uBAAuB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE1C,4EAA4E;IAC5E,qEAAqE;IACrE,4EAA4E;IAC5E,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAEhC,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,kBAAkB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACpC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAElC,4EAA4E;IAC5E,kBAAkB;IAClB,4EAA4E;IAC5E,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,qBAAqB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAExC,4EAA4E;IAC5E,8CAA8C;IAC9C,4EAA4E;IAC5E,UAAU,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAQ;KAAa,EAAE,OAAO,CAAC;IAChE,SAAS,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAW;KAAa,EAAE,QAAQ;AACpE;AAEA,gFAAgF;AAChF,aAAa;AACb,gFAAgF;AAEhF,SAAS;IACP,MAAM,SAAS,gBAAgB,SAAS,CAAC,QAAQ,GAAG;IAEpD,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,SAAS,OAAO,KAAK,CAAC,MAAM,CAC/B,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,EAAE,OAAO,EAAE,EAClD,IAAI,CAAC;QAER,MAAM,IAAI,MACR,CAAC,uCAAuC,EAAE,OAAO,IAAI,CAAC,GACpD,CAAC,kDAAkD,CAAC;IAE1D;IAEA,OAAO,OAAO,IAAI;AACpB;AAEA,wCAAwC;AACxC,IAAI,aAAqD;AAMlD,SAAS;IACd,IAAI,CAAC,YAAY;QACf,aAAa;IACf;IACA,OAAO;AACT;AAKO,SAAS;IACd,aAAa;AACf"}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/secrets.ts"],"sourcesContent":["/**\n * Server Secrets\n *\n * Grouped accessors for secret environment variables.\n * All secrets are validated at import time via getServerEnv().\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Database Secrets\n// =============================================================================\n\nexport function getDatabaseSecrets() {\n  const env = getServerEnv();\n  return {\n    databaseUrl: env.DATABASE_URL,\n    sessionEncryptionKey: env.SESSION_ENCRYPTION_KEY,\n  };\n}\n\n// =============================================================================\n// Twilio Secrets\n// =============================================================================\n\nexport function getTwilioSecrets() {\n  const env = getServerEnv();\n  return {\n    accountSid: env.TWILIO_ACCOUNT_SID,\n    authToken: env.TWILIO_AUTH_TOKEN,\n    phoneNumber: env.TWILIO_NUMBER,\n  };\n}\n\n// =============================================================================\n// Stripe Secrets\n// =============================================================================\n\nexport function getStripeSecrets() {\n  const env = getServerEnv();\n  return {\n    secretKey: env.STRIPE_SECRET_KEY,\n    // webhookSecret may be undefined in development, but required for webhook route\n    webhookSecret: env.STRIPE_WEBHOOK_SECRET!,\n  };\n}\n\n// =============================================================================\n// AI Secrets\n// Note: LangChain auto-reads OPENAI_API_KEY and GOOGLE_API_KEY from process.env.\n// We expose them here for cases where direct access is needed (e.g., GoogleGenAI SDK).\n// =============================================================================\n\nexport function getAiSecrets() {\n  const env = getServerEnv();\n  return {\n    openaiApiKey: env.OPENAI_API_KEY,\n    googleApiKey: env.GOOGLE_API_KEY,\n    xaiApiKey: env.XAI_API_KEY,\n  };\n}\n\n// =============================================================================\n// Pinecone Secrets\n// =============================================================================\n\nexport function getPineconeSecrets() {\n  const env = getServerEnv();\n  return {\n    apiKey: env.PINECONE_API_KEY,\n    indexName: env.PINECONE_INDEX,\n  };\n}\n\n// =============================================================================\n// Background Job Secrets\n// =============================================================================\n\nexport function getCronSecrets() {\n  const env = getServerEnv();\n  return {\n    cronSecret: env.CRON_SECRET,\n    inngestEventKey: env.INNGEST_EVENT_KEY,\n    inngestSigningKey: env.INNGEST_SIGNING_KEY,\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,aAAa,IAAI,YAAY;QAC7B,sBAAsB,IAAI,sBAAsB;IAClD;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,kBAAkB;QAClC,WAAW,IAAI,iBAAiB;QAChC,aAAa,IAAI,aAAa;IAChC;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,WAAW,IAAI,iBAAiB;QAChC,gFAAgF;QAChF,eAAe,IAAI,qBAAqB;IAC1C;AACF;AAQO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,cAAc,IAAI,cAAc;QAChC,cAAc,IAAI,cAAc;QAChC,WAAW,IAAI,WAAW;IAC5B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,QAAQ,IAAI,gBAAgB;QAC5B,WAAW,IAAI,cAAc;IAC/B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,WAAW;QAC3B,iBAAiB,IAAI,iBAAiB;QACtC,mBAAmB,IAAI,mBAAmB;IAC5C;AACF"}},
    {"offset": {"line": 202, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/settings.ts"],"sourcesContent":["/**\n * Server Settings\n *\n * Non-secret server-only settings.\n * For app config (admin, urls, etc.), use shared/config instead.\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Environment Detection\n// =============================================================================\n\nexport function getEnvironmentSettings() {\n  const env = getServerEnv();\n  return {\n    nodeEnv: env.NODE_ENV,\n    appEnv: env.APP_ENV,\n    isDevelopment: env.NODE_ENV === 'development',\n    isProduction: env.NODE_ENV === 'production',\n    isTest: env.NODE_ENV === 'test',\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,SAAS,IAAI,QAAQ;QACrB,QAAQ,IAAI,OAAO;QACnB,eAAe,IAAI,QAAQ,KAAK;QAChC,cAAc,IAAI,QAAQ,KAAK;QAC/B,QAAQ,IAAI,QAAQ,KAAK;IAC3B;AACF"}},
    {"offset": {"line": 227, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/index.ts"],"sourcesContent":["/**\n * Server Configuration\n *\n * This module protects server-only config from client bundles.\n * Any attempt to import this from client code will fail at build time.\n */\nimport 'server-only';\n\n// Re-export everything\nexport * from './env';\nexport * from './secrets';\nexport * from './settings';\n"],"names":[],"mappings":"AAAA;;;;;CAKC;AACD;AAEA,uBAAuB;AACvB;AACA;AACA"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/factory.ts"],"sourcesContent":["/**\n * Database Connection Factory\n *\n * Creates Kysely database instances on-demand. Supports multiple\n * connection strings for environment switching (sandbox/production).\n *\n * Uses internal caching to reuse pools for the same connection string.\n */\nimport { Kysely, PostgresDialect, CamelCasePlugin } from 'kysely';\nimport { Pool } from 'pg';\nimport type { DB } from '@/server/models/_types';\n\n// Cache pools by connection string to avoid creating new pools for same env\nconst poolCache = new Map<string, Pool>();\nconst dbCache = new Map<string, Kysely<DB>>();\n\n/**\n * Create or retrieve a cached database connection\n * @param connectionString - PostgreSQL connection string\n * @returns Kysely database instance\n */\nexport function createDatabase(connectionString: string): Kysely<DB> {\n  // Return cached instance if available\n  if (dbCache.has(connectionString)) {\n    return dbCache.get(connectionString)!;\n  }\n\n  // Create or get cached pool\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10, // Maximum number of clients in the pool\n    });\n    poolCache.set(connectionString, pool);\n  }\n\n  // Create Kysely instance\n  const db = new Kysely<DB>({\n    dialect: new PostgresDialect({ pool }),\n    plugins: [new CamelCasePlugin()],\n  });\n\n  dbCache.set(connectionString, db);\n  return db;\n}\n\n/**\n * Get the pool for a connection string (for direct pool access if needed)\n * @param connectionString - PostgreSQL connection string\n * @returns Pool instance\n */\nexport function getPool(connectionString: string): Pool {\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10,\n    });\n    poolCache.set(connectionString, pool);\n  }\n  return pool;\n}\n\n/**\n * Close all cached pools (for graceful shutdown)\n */\nexport async function closeAllPools(): Promise<void> {\n  const pools = Array.from(poolCache.values());\n  await Promise.all(pools.map(pool => pool.end()));\n  poolCache.clear();\n  dbCache.clear();\n}\n\n/**\n * Get all active pool connection strings (for debugging)\n */\nexport function getActiveConnections(): string[] {\n  return Array.from(poolCache.keys());\n}\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;;;AACD;AAAA;AAAA;AACA;;;AAGA,4EAA4E;AAC5E,MAAM,YAAY,IAAI;AACtB,MAAM,UAAU,IAAI;AAOb,SAAS,eAAe,gBAAwB;IACrD,sCAAsC;IACtC,IAAI,QAAQ,GAAG,CAAC,mBAAmB;QACjC,OAAO,QAAQ,GAAG,CAAC;IACrB;IAEA,4BAA4B;IAC5B,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IAEA,yBAAyB;IACzB,MAAM,KAAK,IAAI,+MAAM,CAAK;QACxB,SAAS,IAAI,4PAAe,CAAC;YAAE;QAAK;QACpC,SAAS;YAAC,IAAI,oQAAe;SAAG;IAClC;IAEA,QAAQ,GAAG,CAAC,kBAAkB;IAC9B,OAAO;AACT;AAOO,SAAS,QAAQ,gBAAwB;IAC9C,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IACA,OAAO;AACT;AAKO,eAAe;IACpB,MAAM,QAAQ,MAAM,IAAI,CAAC,UAAU,MAAM;IACzC,MAAM,QAAQ,GAAG,CAAC,MAAM,GAAG,CAAC,CAAA,OAAQ,KAAK,GAAG;IAC5C,UAAU,KAAK;IACf,QAAQ,KAAK;AACf;AAKO,SAAS;IACd,OAAO,MAAM,IAAI,CAAC,UAAU,IAAI;AAClC"}},
    {"offset": {"line": 328, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/postgres.ts"],"sourcesContent":["/**\n * PostgreSQL Connection\n *\n * This module provides the default database connection using the\n * DATABASE_URL environment variable. For environment switching\n * (sandbox/production), use the factory functions instead.\n */\nimport { getDatabaseSecrets } from '@/server/config';\nimport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';\n\n// Get the database URL from validated server config\nconst { databaseUrl } = getDatabaseSecrets();\n\n// Create default database instance using factory\nexport const postgresDb = createDatabase(databaseUrl);\n\n// Export default pool for direct access if needed\nexport const pool = getPool(databaseUrl);\n\n// Re-export factory functions for environment switching\nexport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;;;AACD;AAAA;AACA;;;AAEA,oDAAoD;AACpD,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,gLAAkB;AAGnC,MAAM,aAAa,IAAA,6LAAc,EAAC;AAGlC,MAAM,OAAO,IAAA,sLAAO,EAAC"}},
    {"offset": {"line": 354, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/baseRepository.ts"],"sourcesContent":["import { Kysely } from 'kysely';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { DB } from '../models/_types';\n\n/**\n * Base Repository\n *\n * Provides database access for all repositories.\n *\n * Supports two patterns:\n * 1. Default singleton (backward compatible): new UserRepository()\n * 2. Explicit db injection (for context switching): new UserRepository(ctx.db)\n *\n * For the admin app with environment switching, always pass ctx.db explicitly.\n */\nexport abstract class BaseRepository {\n  protected db: Kysely<DB>;\n\n  /**\n   * Create a repository instance\n   * @param db - Optional database instance. If not provided, uses the default singleton.\n   */\n  constructor(db: Kysely<DB> = postgresDb) {\n    this.db = db;\n  }\n}\n\n/**\n * Type for the database instance (for type exports)\n */\nexport type DatabaseInstance = Kysely<DB>;"],"names":[],"mappings":";;;;AACA;;AAcO,MAAe;IACV,GAAe;IAEzB;;;GAGC,GACD,YAAY,KAAiB,0MAAU,CAAE;QACvC,IAAI,CAAC,EAAE,GAAG;IACZ;AACF"}},
    {"offset": {"line": 373, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/pageVisitRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { NewPageVisit, PageVisit } from '@/server/models/pageVisit';\n\nexport class PageVisitRepository extends BaseRepository {\n  /**\n   * Record a new page visit\n   */\n  async record(visit: NewPageVisit): Promise<PageVisit> {\n    const result = await this.db\n      .insertInto('pageVisits')\n      .values(visit)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Get visits within a date range\n   */\n  async getVisitsByDateRange(\n    startDate: Date,\n    endDate: Date,\n    options?: { source?: string; limit?: number }\n  ): Promise<PageVisit[]> {\n    let query = this.db\n      .selectFrom('pageVisits')\n      .selectAll()\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .orderBy('createdAt', 'desc');\n\n    if (options?.source) {\n      query = query.where('source', '=', options.source);\n    }\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    return query.execute();\n  }\n\n  /**\n   * Get aggregated visit counts by source\n   */\n  async getVisitCountsBySource(\n    startDate: Date,\n    endDate: Date\n  ): Promise<{ source: string | null; count: number }[]> {\n    const results = await this.db\n      .selectFrom('pageVisits')\n      .select(['source'])\n      .select((eb) => eb.fn.count('id').as('count'))\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .groupBy('source')\n      .orderBy('count', 'desc')\n      .execute();\n\n    return results.map((r) => ({\n      source: r.source,\n      count: Number(r.count),\n    }));\n  }\n\n  /**\n   * Get total visit count for a date range\n   */\n  async getTotalVisits(startDate: Date, endDate: Date): Promise<number> {\n    const result = await this.db\n      .selectFrom('pageVisits')\n      .select((eb) => eb.fn.count('id').as('count'))\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .executeTakeFirst();\n\n    return Number(result?.count ?? 0);\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,4BAA4B,yLAAc;IACrD;;GAEC,GACD,MAAM,OAAO,KAAmB,EAAsB;QACpD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,MAAM,CAAC,OACP,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,qBACJ,SAAe,EACf,OAAa,EACb,OAA6C,EACvB;QACtB,IAAI,QAAQ,IAAI,CAAC,EAAE,CAChB,UAAU,CAAC,cACX,SAAS,GACT,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,OAAO,CAAC,aAAa;QAExB,IAAI,SAAS,QAAQ;YACnB,QAAQ,MAAM,KAAK,CAAC,UAAU,KAAK,QAAQ,MAAM;QACnD;QAEA,IAAI,SAAS,OAAO;YAClB,QAAQ,MAAM,KAAK,CAAC,QAAQ,KAAK;QACnC;QAEA,OAAO,MAAM,OAAO;IACtB;IAEA;;GAEC,GACD,MAAM,uBACJ,SAAe,EACf,OAAa,EACwC;QACrD,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,cACX,MAAM,CAAC;YAAC;SAAS,EACjB,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,UACpC,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,OAAO,CAAC,UACR,OAAO,CAAC,SAAS,QACjB,OAAO;QAEV,OAAO,QAAQ,GAAG,CAAC,CAAC,IAAM,CAAC;gBACzB,QAAQ,EAAE,MAAM;gBAChB,OAAO,OAAO,EAAE,KAAK;YACvB,CAAC;IACH;IAEA;;GAEC,GACD,MAAM,eAAe,SAAe,EAAE,OAAa,EAAmB;QACpE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,UACpC,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;AACF"}},
    {"offset": {"line": 420, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/apps/web/src/app/api/track/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { PageVisitRepository } from '@/server/repositories/pageVisitRepository';\n\n/**\n * POST /api/track\n *\n * Record a page visit for analytics.\n * Called by middleware for centralized tracking.\n *\n * Request body:\n * - page: string - Normalized page path (e.g., /me?workout=:id)\n * - source?: string - Marketing source attribution\n *\n * Headers are extracted for visitor metadata:\n * - x-forwarded-for / x-real-ip: Visitor IP\n * - user-agent: Browser/device info\n * - referer: Referring page\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { page, source } = body;\n\n    if (!page || typeof page !== 'string') {\n      return NextResponse.json({ success: false }, { status: 400 });\n    }\n\n    // Extract visitor metadata from headers\n    const ipAddress =\n      request.headers.get('x-forwarded-for')?.split(',')[0].trim() ??\n      request.headers.get('x-real-ip') ??\n      null;\n    const userAgent = request.headers.get('user-agent') ?? null;\n    const referrer = request.headers.get('referer') ?? null;\n\n    // Fire-and-forget: record the visit but don't wait for it\n    const repository = new PageVisitRepository();\n    repository\n      .record({\n        page,\n        ipAddress,\n        userAgent,\n        referrer,\n        source: source ?? null,\n        utmSource: null,\n        utmMedium: null,\n        utmCampaign: null,\n        utmContent: null,\n        utmTerm: null,\n      })\n      .catch((err) => console.error('[Tracking] Error recording page visit:', err));\n\n    // Return immediately\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error('[Tracking] Error in track endpoint:', error);\n    return NextResponse.json({ success: false }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAiBO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG;QAEzB,IAAI,CAAC,QAAQ,OAAO,SAAS,UAAU;YACrC,OAAO,uTAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAAM,GAAG;gBAAE,QAAQ;YAAI;QAC7D;QAEA,wCAAwC;QACxC,MAAM,YACJ,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,CAAC,UACtD,QAAQ,OAAO,CAAC,GAAG,CAAC,gBACpB;QACF,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;QACvD,MAAM,WAAW,QAAQ,OAAO,CAAC,GAAG,CAAC,cAAc;QAEnD,0DAA0D;QAC1D,MAAM,aAAa,IAAI,mMAAmB;QAC1C,WACG,MAAM,CAAC;YACN;YACA;YACA;YACA;YACA,QAAQ,UAAU;YAClB,WAAW;YACX,WAAW;YACX,aAAa;YACb,YAAY;YACZ,SAAS;QACX,GACC,KAAK,CAAC,CAAC,MAAQ,QAAQ,KAAK,CAAC,0CAA0C;QAE1E,qBAAqB;QACrB,OAAO,uTAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,OAAO,uTAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAM,GAAG;YAAE,QAAQ;QAAI;IAC7D;AACF"}}]
}