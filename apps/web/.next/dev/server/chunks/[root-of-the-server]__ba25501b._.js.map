{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/env.ts"],"sourcesContent":["/**\n * Server Environment Variables\n *\n * THE ONLY place in the codebase that validates server-side secrets.\n * App config overrides are handled by shared/config.\n */\nimport { z } from 'zod';\n\n// =============================================================================\n// Zod Schema - Server Secrets Only\n// =============================================================================\n\nconst ServerEnvSchema = z.object({\n  // -------------------------------------------------------------------------\n  // Database\n  // -------------------------------------------------------------------------\n  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),\n  SESSION_ENCRYPTION_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Twilio\n  // -------------------------------------------------------------------------\n  TWILIO_ACCOUNT_SID: z.string().min(1, 'TWILIO_ACCOUNT_SID is required'),\n  TWILIO_AUTH_TOKEN: z.string().min(1, 'TWILIO_AUTH_TOKEN is required'),\n  TWILIO_NUMBER: z.string().min(1, 'TWILIO_NUMBER is required'),\n\n  // -------------------------------------------------------------------------\n  // Stripe\n  // -------------------------------------------------------------------------\n  STRIPE_SECRET_KEY: z.string().min(1, 'STRIPE_SECRET_KEY is required'),\n  STRIPE_WEBHOOK_SECRET: z.string().optional(), // Optional for development\n\n  // -------------------------------------------------------------------------\n  // AI - validated but LangChain reads these directly from process.env\n  // -------------------------------------------------------------------------\n  OPENAI_API_KEY: z.string().min(1, 'OPENAI_API_KEY is required'),\n  GOOGLE_API_KEY: z.string().min(1, 'GOOGLE_API_KEY is required'),\n  XAI_API_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Pinecone\n  // -------------------------------------------------------------------------\n  PINECONE_API_KEY: z.string().min(1, 'PINECONE_API_KEY is required'),\n  PINECONE_INDEX: z.string().min(1, 'PINECONE_INDEX is required'),\n\n  // -------------------------------------------------------------------------\n  // Background Jobs\n  // -------------------------------------------------------------------------\n  CRON_SECRET: z.string().optional(),\n  INNGEST_EVENT_KEY: z.string().optional(),\n  INNGEST_SIGNING_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Environment (for server-side env detection)\n  // -------------------------------------------------------------------------\n  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),\n  APP_ENV: z.enum(['development', 'staging', 'production']).optional(),\n});\n\n// =============================================================================\n// Validation\n// =============================================================================\n\nfunction validateServerEnv() {\n  const result = ServerEnvSchema.safeParse(process.env);\n\n  if (!result.success) {\n    const errors = result.error.errors\n      .map((e) => `  - ${e.path.join('.')}: ${e.message}`)\n      .join('\\n');\n\n    throw new Error(\n      `Server environment validation failed:\\n${errors}\\n\\n` +\n        `Ensure all required environment variables are set.`\n    );\n  }\n\n  return result.data;\n}\n\n// Singleton - validated once at startup\nlet _serverEnv: z.infer<typeof ServerEnvSchema> | null = null;\n\n/**\n * Get validated server environment variables.\n * Caches the result for subsequent calls.\n */\nexport function getServerEnv() {\n  if (!_serverEnv) {\n    _serverEnv = validateServerEnv();\n  }\n  return _serverEnv;\n}\n\n/**\n * Reset env cache (useful for testing).\n */\nexport function resetServerEnv() {\n  _serverEnv = null;\n}\n\n// Export type\nexport type ServerEnv = z.infer<typeof ServerEnvSchema>;\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AACD;AAAA;;AAEA,gFAAgF;AAChF,mCAAmC;AACnC,gFAAgF;AAEhF,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IAC/B,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,cAAc,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAChC,wBAAwB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE3C,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,oBAAoB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACtC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,eAAe,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAEjC,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,uBAAuB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE1C,4EAA4E;IAC5E,qEAAqE;IACrE,4EAA4E;IAC5E,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAEhC,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,kBAAkB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACpC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAElC,4EAA4E;IAC5E,kBAAkB;IAClB,4EAA4E;IAC5E,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,qBAAqB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAExC,4EAA4E;IAC5E,8CAA8C;IAC9C,4EAA4E;IAC5E,UAAU,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAQ;KAAa,EAAE,OAAO,CAAC;IAChE,SAAS,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAW;KAAa,EAAE,QAAQ;AACpE;AAEA,gFAAgF;AAChF,aAAa;AACb,gFAAgF;AAEhF,SAAS;IACP,MAAM,SAAS,gBAAgB,SAAS,CAAC,QAAQ,GAAG;IAEpD,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,SAAS,OAAO,KAAK,CAAC,MAAM,CAC/B,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,EAAE,OAAO,EAAE,EAClD,IAAI,CAAC;QAER,MAAM,IAAI,MACR,CAAC,uCAAuC,EAAE,OAAO,IAAI,CAAC,GACpD,CAAC,kDAAkD,CAAC;IAE1D;IAEA,OAAO,OAAO,IAAI;AACpB;AAEA,wCAAwC;AACxC,IAAI,aAAqD;AAMlD,SAAS;IACd,IAAI,CAAC,YAAY;QACf,aAAa;IACf;IACA,OAAO;AACT;AAKO,SAAS;IACd,aAAa;AACf"}},
    {"offset": {"line": 167, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/secrets.ts"],"sourcesContent":["/**\n * Server Secrets\n *\n * Grouped accessors for secret environment variables.\n * All secrets are validated at import time via getServerEnv().\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Database Secrets\n// =============================================================================\n\nexport function getDatabaseSecrets() {\n  const env = getServerEnv();\n  return {\n    databaseUrl: env.DATABASE_URL,\n    sessionEncryptionKey: env.SESSION_ENCRYPTION_KEY,\n  };\n}\n\n// =============================================================================\n// Twilio Secrets\n// =============================================================================\n\nexport function getTwilioSecrets() {\n  const env = getServerEnv();\n  return {\n    accountSid: env.TWILIO_ACCOUNT_SID,\n    authToken: env.TWILIO_AUTH_TOKEN,\n    phoneNumber: env.TWILIO_NUMBER,\n  };\n}\n\n// =============================================================================\n// Stripe Secrets\n// =============================================================================\n\nexport function getStripeSecrets() {\n  const env = getServerEnv();\n  return {\n    secretKey: env.STRIPE_SECRET_KEY,\n    // webhookSecret may be undefined in development, but required for webhook route\n    webhookSecret: env.STRIPE_WEBHOOK_SECRET!,\n  };\n}\n\n// =============================================================================\n// AI Secrets\n// Note: LangChain auto-reads OPENAI_API_KEY and GOOGLE_API_KEY from process.env.\n// We expose them here for cases where direct access is needed (e.g., GoogleGenAI SDK).\n// =============================================================================\n\nexport function getAiSecrets() {\n  const env = getServerEnv();\n  return {\n    openaiApiKey: env.OPENAI_API_KEY,\n    googleApiKey: env.GOOGLE_API_KEY,\n    xaiApiKey: env.XAI_API_KEY,\n  };\n}\n\n// =============================================================================\n// Pinecone Secrets\n// =============================================================================\n\nexport function getPineconeSecrets() {\n  const env = getServerEnv();\n  return {\n    apiKey: env.PINECONE_API_KEY,\n    indexName: env.PINECONE_INDEX,\n  };\n}\n\n// =============================================================================\n// Background Job Secrets\n// =============================================================================\n\nexport function getCronSecrets() {\n  const env = getServerEnv();\n  return {\n    cronSecret: env.CRON_SECRET,\n    inngestEventKey: env.INNGEST_EVENT_KEY,\n    inngestSigningKey: env.INNGEST_SIGNING_KEY,\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,aAAa,IAAI,YAAY;QAC7B,sBAAsB,IAAI,sBAAsB;IAClD;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,kBAAkB;QAClC,WAAW,IAAI,iBAAiB;QAChC,aAAa,IAAI,aAAa;IAChC;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,WAAW,IAAI,iBAAiB;QAChC,gFAAgF;QAChF,eAAe,IAAI,qBAAqB;IAC1C;AACF;AAQO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,cAAc,IAAI,cAAc;QAChC,cAAc,IAAI,cAAc;QAChC,WAAW,IAAI,WAAW;IAC5B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,QAAQ,IAAI,gBAAgB;QAC5B,WAAW,IAAI,cAAc;IAC/B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,WAAW;QAC3B,iBAAiB,IAAI,iBAAiB;QACtC,mBAAmB,IAAI,mBAAmB;IAC5C;AACF"}},
    {"offset": {"line": 238, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/settings.ts"],"sourcesContent":["/**\n * Server Settings\n *\n * Non-secret server-only settings.\n * For app config (admin, urls, etc.), use shared/config instead.\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Environment Detection\n// =============================================================================\n\nexport function getEnvironmentSettings() {\n  const env = getServerEnv();\n  return {\n    nodeEnv: env.NODE_ENV,\n    appEnv: env.APP_ENV,\n    isDevelopment: env.NODE_ENV === 'development',\n    isProduction: env.NODE_ENV === 'production',\n    isTest: env.NODE_ENV === 'test',\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,SAAS,IAAI,QAAQ;QACrB,QAAQ,IAAI,OAAO;QACnB,eAAe,IAAI,QAAQ,KAAK;QAChC,cAAc,IAAI,QAAQ,KAAK;QAC/B,QAAQ,IAAI,QAAQ,KAAK;IAC3B;AACF"}},
    {"offset": {"line": 263, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/index.ts"],"sourcesContent":["/**\n * Server Configuration\n *\n * This module protects server-only config from client bundles.\n * Any attempt to import this from client code will fail at build time.\n */\nimport 'server-only';\n\n// Re-export everything\nexport * from './env';\nexport * from './secrets';\nexport * from './settings';\n"],"names":[],"mappings":"AAAA;;;;;CAKC;AACD;AAEA,uBAAuB;AACvB;AACA;AACA"}},
    {"offset": {"line": 288, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/factory.ts"],"sourcesContent":["/**\n * Database Connection Factory\n *\n * Creates Kysely database instances on-demand. Supports multiple\n * connection strings for environment switching (sandbox/production).\n *\n * Uses internal caching to reuse pools for the same connection string.\n */\nimport { Kysely, PostgresDialect, CamelCasePlugin } from 'kysely';\nimport { Pool } from 'pg';\nimport type { DB } from '@/server/models/_types';\n\n// Cache pools by connection string to avoid creating new pools for same env\nconst poolCache = new Map<string, Pool>();\nconst dbCache = new Map<string, Kysely<DB>>();\n\n/**\n * Create or retrieve a cached database connection\n * @param connectionString - PostgreSQL connection string\n * @returns Kysely database instance\n */\nexport function createDatabase(connectionString: string): Kysely<DB> {\n  // Return cached instance if available\n  if (dbCache.has(connectionString)) {\n    return dbCache.get(connectionString)!;\n  }\n\n  // Create or get cached pool\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10, // Maximum number of clients in the pool\n    });\n    poolCache.set(connectionString, pool);\n  }\n\n  // Create Kysely instance\n  const db = new Kysely<DB>({\n    dialect: new PostgresDialect({ pool }),\n    plugins: [new CamelCasePlugin()],\n  });\n\n  dbCache.set(connectionString, db);\n  return db;\n}\n\n/**\n * Get the pool for a connection string (for direct pool access if needed)\n * @param connectionString - PostgreSQL connection string\n * @returns Pool instance\n */\nexport function getPool(connectionString: string): Pool {\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10,\n    });\n    poolCache.set(connectionString, pool);\n  }\n  return pool;\n}\n\n/**\n * Close all cached pools (for graceful shutdown)\n */\nexport async function closeAllPools(): Promise<void> {\n  const pools = Array.from(poolCache.values());\n  await Promise.all(pools.map(pool => pool.end()));\n  poolCache.clear();\n  dbCache.clear();\n}\n\n/**\n * Get all active pool connection strings (for debugging)\n */\nexport function getActiveConnections(): string[] {\n  return Array.from(poolCache.keys());\n}\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;;;AACD;AAAA;AAAA;AACA;;;AAGA,4EAA4E;AAC5E,MAAM,YAAY,IAAI;AACtB,MAAM,UAAU,IAAI;AAOb,SAAS,eAAe,gBAAwB;IACrD,sCAAsC;IACtC,IAAI,QAAQ,GAAG,CAAC,mBAAmB;QACjC,OAAO,QAAQ,GAAG,CAAC;IACrB;IAEA,4BAA4B;IAC5B,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IAEA,yBAAyB;IACzB,MAAM,KAAK,IAAI,+MAAM,CAAK;QACxB,SAAS,IAAI,4PAAe,CAAC;YAAE;QAAK;QACpC,SAAS;YAAC,IAAI,oQAAe;SAAG;IAClC;IAEA,QAAQ,GAAG,CAAC,kBAAkB;IAC9B,OAAO;AACT;AAOO,SAAS,QAAQ,gBAAwB;IAC9C,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IACA,OAAO;AACT;AAKO,eAAe;IACpB,MAAM,QAAQ,MAAM,IAAI,CAAC,UAAU,MAAM;IACzC,MAAM,QAAQ,GAAG,CAAC,MAAM,GAAG,CAAC,CAAA,OAAQ,KAAK,GAAG;IAC5C,UAAU,KAAK;IACf,QAAQ,KAAK;AACf;AAKO,SAAS;IACd,OAAO,MAAM,IAAI,CAAC,UAAU,IAAI;AAClC"}},
    {"offset": {"line": 364, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/postgres.ts"],"sourcesContent":["/**\n * PostgreSQL Connection\n *\n * This module provides the default database connection using the\n * DATABASE_URL environment variable. For environment switching\n * (sandbox/production), use the factory functions instead.\n */\nimport { getDatabaseSecrets } from '@/server/config';\nimport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';\n\n// Get the database URL from validated server config\nconst { databaseUrl } = getDatabaseSecrets();\n\n// Create default database instance using factory\nexport const postgresDb = createDatabase(databaseUrl);\n\n// Export default pool for direct access if needed\nexport const pool = getPool(databaseUrl);\n\n// Re-export factory functions for environment switching\nexport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;;;AACD;AAAA;AACA;;;AAEA,oDAAoD;AACpD,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,gLAAkB;AAGnC,MAAM,aAAa,IAAA,6LAAc,EAAC;AAGlC,MAAM,OAAO,IAAA,sLAAO,EAAC"}},
    {"offset": {"line": 390, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/baseRepository.ts"],"sourcesContent":["import { Kysely } from 'kysely';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { DB } from '../models/_types';\n\n/**\n * Base Repository\n *\n * Provides database access for all repositories.\n *\n * Supports two patterns:\n * 1. Default singleton (backward compatible): new UserRepository()\n * 2. Explicit db injection (for context switching): new UserRepository(ctx.db)\n *\n * For the admin app with environment switching, always pass ctx.db explicitly.\n */\nexport abstract class BaseRepository {\n  protected db: Kysely<DB>;\n\n  /**\n   * Create a repository instance\n   * @param db - Optional database instance. If not provided, uses the default singleton.\n   */\n  constructor(db: Kysely<DB> = postgresDb) {\n    this.db = db;\n  }\n}\n\n/**\n * Type for the database instance (for type exports)\n */\nexport type DatabaseInstance = Kysely<DB>;"],"names":[],"mappings":";;;;AACA;;AAcO,MAAe;IACV,GAAe;IAEzB;;;GAGC,GACD,YAAY,KAAiB,0MAAU,CAAE;QACvC,IAAI,CAAC,EAAE,GAAG;IACZ;AACF"}},
    {"offset": {"line": 409, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/referralRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { Referral, NewReferral } from '../models/referral';\nimport { sql } from 'kysely';\n\n/**\n * Repository for managing referrals\n * Handles storage and retrieval of referral relationships\n */\nexport class ReferralRepository extends BaseRepository {\n  /**\n   * Create a new referral record\n   * Called when a referee signs up using a referral code\n   */\n  async create(referrerId: string, refereeId: string): Promise<Referral> {\n    const result = await this.db\n      .insertInto('referrals')\n      .values({\n        referrerId,\n        refereeId,\n        creditApplied: false,\n        creditAmountCents: 0,\n        createdAt: new Date(),\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Find a referral by referee ID\n   * Used by webhook to find the referral when crediting the referrer\n   */\n  async findByRefereeId(refereeId: string): Promise<Referral | null> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .selectAll()\n      .where('refereeId', '=', refereeId)\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Find all referrals for a referrer\n   * Used for displaying referral stats on the /me page\n   */\n  async findByReferrerId(referrerId: string): Promise<Referral[]> {\n    return await this.db\n      .selectFrom('referrals')\n      .selectAll()\n      .where('referrerId', '=', referrerId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n  }\n\n  /**\n   * Mark a referral as credited\n   * Called after successfully applying credit to the referrer's Stripe account\n   */\n  async markCreditApplied(id: string, amountCents: number): Promise<Referral> {\n    const result = await this.db\n      .updateTable('referrals')\n      .set({\n        creditApplied: true,\n        creditAmountCents: amountCents,\n        creditedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Count credits earned by a referrer\n   * Only counts referrals where credit was actually applied\n   */\n  async countCreditsEarned(referrerId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select(sql<number>`count(*)`.as('count'))\n      .where('referrerId', '=', referrerId)\n      .where('creditApplied', '=', true)\n      .executeTakeFirst();\n\n    return Number(result?.count || 0);\n  }\n\n  /**\n   * Count total referrals by a referrer (regardless of credit status)\n   */\n  async countByReferrer(referrerId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select(sql<number>`count(*)`.as('count'))\n      .where('referrerId', '=', referrerId)\n      .executeTakeFirst();\n\n    return Number(result?.count || 0);\n  }\n\n  /**\n   * Check if a user has already been referred\n   * Each user can only be referred once\n   */\n  async hasBeenReferred(refereeId: string): Promise<boolean> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select('id')\n      .where('refereeId', '=', refereeId)\n      .executeTakeFirst();\n\n    return !!result;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAMO,MAAM,2BAA2B,yLAAc;IACpD;;;GAGC,GACD,MAAM,OAAO,UAAkB,EAAE,SAAiB,EAAqB;QACrE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC;YACN;YACA;YACA,eAAe;YACf,mBAAmB;YACnB,WAAW,IAAI;QACjB,GACC,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,gBAAgB,SAAiB,EAA4B;QACjE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,SAAS,GACT,KAAK,CAAC,aAAa,KAAK,WACxB,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;;GAGC,GACD,MAAM,iBAAiB,UAAkB,EAAuB;QAC9D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,aACX,SAAS,GACT,KAAK,CAAC,cAAc,KAAK,YACzB,OAAO,CAAC,aAAa,QACrB,OAAO;IACZ;IAEA;;;GAGC,GACD,MAAM,kBAAkB,EAAU,EAAE,WAAmB,EAAqB;QAC1E,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,WAAW,CAAC,aACZ,GAAG,CAAC;YACH,eAAe;YACf,mBAAmB;YACnB,YAAY,IAAI;QAClB,GACC,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,mBAAmB,UAAkB,EAAmB;QAC5D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,2NAAG,AAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,UAChC,KAAK,CAAC,cAAc,KAAK,YACzB,KAAK,CAAC,iBAAiB,KAAK,MAC5B,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;IAEA;;GAEC,GACD,MAAM,gBAAgB,UAAkB,EAAmB;QACzD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,2NAAG,AAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,UAChC,KAAK,CAAC,cAAc,KAAK,YACzB,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;IAEA;;;GAGC,GACD,MAAM,gBAAgB,SAAiB,EAAoB;QACzD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,MACP,KAAK,CAAC,aAAa,KAAK,WACxB,gBAAgB;QAEnB,OAAO,CAAC,CAAC;IACX;AACF"}},
    {"offset": {"line": 480, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/utils/phoneUtils.ts"],"sourcesContent":["/**\n * Centralized phone number utilities for US-based phone numbers\n * \n * GymText assumes all users are US-based, so all phone numbers\n * should be normalized to +1XXXXXXXXXX format.\n */\n\n/**\n * Normalizes a phone number input to US E.164 format (+1XXXXXXXXXX)\n * \n * Supported input formats:\n * - 3392223571 → +13392223571 (10 digits, adds +1 prefix)\n * - 13392223571 → +13392223571 (11 digits starting with 1, adds + prefix)\n * - +13392223571 → +13392223571 (already formatted, no change)\n * \n * @param input - Phone number in various formats\n * @returns Normalized phone number or null if invalid\n */\nexport function normalizeUSPhoneNumber(input: string | null | undefined): string | null {\n  if (!input || typeof input !== 'string') {\n    return null;\n  }\n  \n  // Remove all non-numeric characters\n  const digits = input.replace(/\\D/g, '');\n  \n  if (!digits) {\n    return null;\n  }\n  \n  // Handle different input formats\n  if (digits.length === 10) {\n    // US number without country code: 3392223571\n    // Validate that it starts with a valid area code (2-9 for first digit)\n    if (digits[0] >= '2' && digits[0] <= '9') {\n      return `+1${digits}`;\n    }\n  } else if (digits.length === 11 && digits.startsWith('1')) {\n    // US number with country code: 13392223571\n    // Validate that area code starts with valid digit (2-9 for 4th digit)\n    if (digits[1] >= '2' && digits[1] <= '9') {\n      return `+${digits}`;\n    }\n  } else if (input.startsWith('+1') && digits.length === 11 && digits.startsWith('1')) {\n    // Already formatted: +13392223571\n    // Validate format\n    if (digits[1] >= '2' && digits[1] <= '9') {\n      return input;\n    }\n  }\n  \n  // Invalid format or length\n  return null;\n}\n\n/**\n * Validates that a phone number is a properly formatted US phone number\n * \n * @param phone - Phone number to validate\n * @returns true if valid US phone number, false otherwise\n */\nexport function validateUSPhoneNumber(phone: string | null | undefined): boolean {\n  if (!phone || typeof phone !== 'string') {\n    return false;\n  }\n  \n  // Must be in E.164 format for US: +1XXXXXXXXXX\n  // Area code (first 3 digits after +1) must start with 2-9\n  // Exchange code (next 3 digits) must start with 2-9\n  const e164USRegex = /^\\+1[2-9]\\d{2}[2-9]\\d{6}$/;\n  return e164USRegex.test(phone);\n}\n\n/**\n * Checks if a phone number is a US phone number (starts with +1)\n * \n * @param phone - Phone number to check\n * @returns true if starts with +1, false otherwise\n */\nexport function isUSPhoneNumber(phone: string): boolean {\n  return typeof phone === 'string' && phone.startsWith('+1');\n}\n\n/**\n * Formats a US phone number for display purposes\n * +13392223571 → (339) 222-3571\n * \n * @param phone - Normalized US phone number (+1XXXXXXXXXX)\n * @returns Formatted phone number or original input if invalid\n */\nexport function formatUSPhoneForDisplay(phone: string): string {\n  if (!validateUSPhoneNumber(phone)) {\n    return phone;\n  }\n  \n  // Remove +1 and format as (XXX) XXX-XXXX\n  const digits = phone.slice(2); // Remove +1\n  return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n}\n\n/**\n * Type guard for normalized phone numbers\n */\nexport type NormalizedUSPhone = string & { __brand: 'NormalizedUSPhone' };\n\n/**\n * Creates a branded type for validated US phone numbers\n * \n * @param phone - Phone number to validate and brand\n * @returns Branded phone number if valid, null otherwise\n */\nexport function createNormalizedUSPhone(phone: string): NormalizedUSPhone | null {\n  if (validateUSPhoneNumber(phone)) {\n    return phone as NormalizedUSPhone;\n  }\n  return null;\n}"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;;;;;;;;CAUC;;;;;;;;;;;;AACM,SAAS,uBAAuB,KAAgC;IACrE,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,OAAO;IACT;IAEA,oCAAoC;IACpC,MAAM,SAAS,MAAM,OAAO,CAAC,OAAO;IAEpC,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,OAAO,MAAM,KAAK,IAAI;QACxB,6CAA6C;QAC7C,uEAAuE;QACvE,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO,CAAC,EAAE,EAAE,QAAQ;QACtB;IACF,OAAO,IAAI,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACzD,2CAA2C;QAC3C,sEAAsE;QACtE,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO,CAAC,CAAC,EAAE,QAAQ;QACrB;IACF,OAAO,IAAI,MAAM,UAAU,CAAC,SAAS,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACnF,kCAAkC;QAClC,kBAAkB;QAClB,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO;QACT;IACF;IAEA,2BAA2B;IAC3B,OAAO;AACT;AAQO,SAAS,sBAAsB,KAAgC;IACpE,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,OAAO;IACT;IAEA,+CAA+C;IAC/C,0DAA0D;IAC1D,oDAAoD;IACpD,MAAM,cAAc;IACpB,OAAO,YAAY,IAAI,CAAC;AAC1B;AAQO,SAAS,gBAAgB,KAAa;IAC3C,OAAO,OAAO,UAAU,YAAY,MAAM,UAAU,CAAC;AACvD;AASO,SAAS,wBAAwB,KAAa;IACnD,IAAI,CAAC,sBAAsB,QAAQ;QACjC,OAAO;IACT;IAEA,yCAAyC;IACzC,MAAM,SAAS,MAAM,KAAK,CAAC,IAAI,YAAY;IAC3C,OAAO,CAAC,CAAC,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,EAAE,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,CAAC,EAAE,OAAO,KAAK,CAAC,IAAI;AAC3E;AAaO,SAAS,wBAAwB,KAAa;IACnD,IAAI,sBAAsB,QAAQ;QAChC,OAAO;IACT;IACA,OAAO;AACT"}},
    {"offset": {"line": 570, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/user/schemas.ts"],"sourcesContent":["import { z } from 'zod';\nimport { normalizeUSPhoneNumber, validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\n// Base user schema\nexport const UserSchema = z.object({\n  id: z.string().uuid(),\n  name: z.string(),\n  email: z.string().email().nullable(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullable(),\n  gender: z.string().nullable(),\n  stripeCustomerId: z.string().nullable(),\n  preferredSendHour: z.number().int().min(0).max(23),\n  timezone: z.string(),\n  createdAt: z.date(),\n  updatedAt: z.date(),\n});\n\n// NEW - Simplified Availability Schema\nexport const AvailabilitySchema = z.object({\n  summary: z.string().nullish(), // Brief overview of schedule and availability\n  daysPerWeek: z.number().int().min(1).max(7),\n  minutesPerSession: z.number().int().min(15).max(240),\n  preferredTimes: z.array(z.enum(['morning', 'afternoon', 'evening'])).nullish(),\n  schedule: z.string().nullish(),\n});\n\n// NEW - Temporary Environment Change Schema\nexport const TemporaryEnvironmentChangeSchema = z.object({\n  id: z.string(),\n  description: z.string(),\n  startDate: z.string(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for indefinite\n  location: z.string().nullish(), // \"beach\", \"hotel\", \"home\", etc.\n  equipmentAvailable: z.array(z.string()).nullish(),\n  equipmentUnavailable: z.array(z.string()).nullish(),\n});\n\n// NEW - Equipment Access Schema\nexport const EquipmentAccessSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of equipment situation\n  gymAccess: z.boolean(),\n  gymType: z.enum(['commercial', 'home', 'community', 'none']).nullish(),\n  homeEquipment: z.array(z.string()).nullish(),\n  limitations: z.array(z.string()).nullish(),\n  temporaryChanges: z.array(TemporaryEnvironmentChangeSchema).nullish(),\n});\n\n// Weight schema for metrics (kept but simplified)\nexport const WeightSchema = z.object({\n  value: z.number().positive(),\n  unit: z.enum(['lbs', 'kg']),\n  date: z.string().nullish(),\n});\n\n// NEW - Simplified User Metrics Schema\nexport const UserMetricsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of physical stats and fitness level\n  height: z.number().positive().nullish(),\n  weight: WeightSchema.nullish(),\n  bodyComposition: z.number().min(1).max(50).nullish(),\n  fitnessLevel: z.enum(['sedentary', 'lightly_active', 'moderately_active', 'very_active']).nullish(),\n});\n\n// NEW - Simplified Constraint Schema\nexport const ConstraintSchema = z.object({\n  id: z.string(),\n  type: z.enum(['injury', 'mobility', 'medical', 'preference']),\n  description: z.string(),\n  severity: z.enum(['mild', 'moderate', 'severe']).nullish(),\n  affectedMovements: z.array(z.string()).nullish(),\n  status: z.enum(['active', 'resolved']),\n  startDate: z.string().nullish(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for chronic\n  isTemporary: z.boolean().default(false),\n});\n\n// NEW - Simplified Strength Data Schema\nexport const StrengthDataSchema = z.object({\n  type: z.literal('strength'),\n  summary: z.string().nullish(), // Brief overview of strength training background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  currentProgram: z.string().nullish(),\n  keyLifts: z.record(z.string(), z.number()).nullish(),\n  preferences: z.object({\n    workoutStyle: z.string().nullish(),\n    likedExercises: z.array(z.string()).nullish(),\n    dislikedExercises: z.array(z.string()).nullish(),\n  }).nullish(),\n  trainingFrequency: z.number().int().min(1).max(7),\n});\n\n// NEW - Simplified Cardio Data Schema (replaces running, cycling, general)\nexport const CardioDataSchema = z.object({\n  type: z.literal('cardio'),\n  summary: z.string().nullish(), // Brief overview of cardio activities and background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  primaryActivities: z.array(z.string()),\n  keyMetrics: z.object({\n    weeklyDistance: z.number().positive().nullish(),\n    longestSession: z.number().positive().nullish(),\n    averagePace: z.string().nullish(),\n    preferredIntensity: z.enum(['low', 'moderate', 'high']).nullish(),\n  }).nullish(),\n  preferences: z.object({\n    indoor: z.boolean().nullish(),\n    outdoor: z.boolean().nullish(),\n    groupVsIndividual: z.enum(['group', 'individual', 'both']).nullish(),\n    timeOfDay: z.array(z.string()).nullish(),\n  }).nullish(),\n  frequency: z.number().int().min(1).max(7).nullish(),\n});\n\n// NEW - Simplified Activity Data Schema (only strength + cardio)\nexport const ActivityDataSchema = z.array(z.union([\n  StrengthDataSchema,\n  CardioDataSchema,\n]));\n\n// NEW - Simplified Goals Schema\nexport const GoalsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of fitness goals and motivation\n  primary: z.string(),\n  timeline: z.number().int().min(1).max(104).nullish(), // 1-104 weeks\n  specific: z.string().nullish(),\n  motivation: z.string().nullish(),\n});\n\n// THE ONLY FITNESS PROFILE SCHEMA - COMPLETE REPLACEMENT\nexport const FitnessProfileSchema = z.object({\n  goals: GoalsSchema,\n\n  // Overall experience level - single source of truth for fitness experience\n  // Can be derived from primary activity or set explicitly\n  experienceLevel: z.enum(['beginner', 'intermediate', 'advanced']).nullish(),\n\n  equipmentAccess: EquipmentAccessSchema.nullish(),\n  availability: AvailabilitySchema.nullish(),\n  constraints: z.array(ConstraintSchema).nullish(),\n  metrics: UserMetricsSchema.nullish(),\n\n  activities: ActivityDataSchema.nullish(),\n});\n\n// Schema for creating a new user\nexport const CreateUserSchema = z.object({\n  name: z.string().nullish(),\n  email: z.string().email().nullish(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullish(),\n  gender: z.string().nullish(),\n  isActive: z.boolean().nullish().default(true),\n  isAdmin: z.boolean().nullish().default(false),\n  stripeCustomerId: z.string().nullish(),\n  preferredSendHour: z.number().int().min(0).max(23).nullish(),\n  timezone: z.string().nullish(),\n});\n\n// Schema for updating a user\nexport const UpdateUserSchema = CreateUserSchema.partial();\n\n// Schema for creating/updating fitness profile\nexport const CreateFitnessProfileSchema = FitnessProfileSchema.partial();\n\n// Profile update patch schema (for tracking changes)\nexport const ProfileUpdatePatchSchema = z.object({\n  field: z.string(),\n  oldValue: z.unknown().nullable(),\n  newValue: z.unknown().nullable(),\n  timestamp: z.date(),\n});\n\n// Profile update request schema (for API endpoints)\nexport const ProfileUpdateRequestSchema = z.object({\n  updates: FitnessProfileSchema.partial(),\n  source: z.enum(['chat', 'form', 'admin', 'api', 'system']),\n  reason: z.string().optional().nullable(),\n});\n\n// Zod-inferred types (for validation)\nexport type FitnessProfile = z.infer<typeof FitnessProfileSchema>;\n\n// Activity-specific data types (only strength + cardio)\nexport type ActivityData = z.infer<typeof ActivityDataSchema>;\nexport type StrengthData = z.infer<typeof StrengthDataSchema>;\nexport type CardioData = z.infer<typeof CardioDataSchema>;\nexport type EquipmentAccess = z.infer<typeof EquipmentAccessSchema>;\nexport type Availability = z.infer<typeof AvailabilitySchema>;\nexport type Goals = z.infer<typeof GoalsSchema>;\nexport type UserMetrics = z.infer<typeof UserMetricsSchema>;\nexport type Constraint = z.infer<typeof ConstraintSchema>;\nexport type TemporaryEnvironmentChange = z.infer<typeof TemporaryEnvironmentChangeSchema>;\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AACA;;;AAGO,MAAM,aAAa,0MAAC,CAAC,MAAM,CAAC;IACjC,IAAI,0MAAC,CAAC,MAAM,GAAG,IAAI;IACnB,MAAM,0MAAC,CAAC,MAAM;IACd,OAAO,0MAAC,CAAC,MAAM,GAAG,KAAK,GAAG,QAAQ;IAClC,aAAa,0MAAC,CAAC,MAAM,GAClB,SAAS,CAAC,sLAAsB,EAChC,MAAM,CAAC,qLAAqB,EAAE;QAAE,SAAS;IAAkC;IAC9E,KAAK,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,QAAQ;IAC9C,QAAQ,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAC3B,kBAAkB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACrC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;IAC/C,UAAU,0MAAC,CAAC,MAAM;IAClB,WAAW,0MAAC,CAAC,IAAI;IACjB,WAAW,0MAAC,CAAC,IAAI;AACnB;AAGO,MAAM,qBAAqB,0MAAC,CAAC,MAAM,CAAC;IACzC,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,aAAa,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;IACzC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,IAAI,GAAG,CAAC;IAChD,gBAAgB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAW;QAAa;KAAU,GAAG,OAAO;IAC5E,UAAU,0MAAC,CAAC,MAAM,GAAG,OAAO;AAC9B;AAGO,MAAM,mCAAmC,0MAAC,CAAC,MAAM,CAAC;IACvD,IAAI,0MAAC,CAAC,MAAM;IACZ,aAAa,0MAAC,CAAC,MAAM;IACrB,WAAW,0MAAC,CAAC,MAAM;IACnB,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,UAAU,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC5B,oBAAoB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IAC/C,sBAAsB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;AACnD;AAGO,MAAM,wBAAwB,0MAAC,CAAC,MAAM,CAAC;IAC5C,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,WAAW,0MAAC,CAAC,OAAO;IACpB,SAAS,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAc;QAAQ;QAAa;KAAO,EAAE,OAAO;IACpE,eAAe,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IAC1C,aAAa,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IACxC,kBAAkB,0MAAC,CAAC,KAAK,CAAC,kCAAkC,OAAO;AACrE;AAGO,MAAM,eAAe,0MAAC,CAAC,MAAM,CAAC;IACnC,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAC1B,MAAM,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAO;KAAK;IAC1B,MAAM,0MAAC,CAAC,MAAM,GAAG,OAAO;AAC1B;AAGO,MAAM,oBAAoB,0MAAC,CAAC,MAAM,CAAC;IACxC,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,QAAQ,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO;IACrC,QAAQ,aAAa,OAAO;IAC5B,iBAAiB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO;IAClD,cAAc,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAa;QAAkB;QAAqB;KAAc,EAAE,OAAO;AACnG;AAGO,MAAM,mBAAmB,0MAAC,CAAC,MAAM,CAAC;IACvC,IAAI,0MAAC,CAAC,MAAM;IACZ,MAAM,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAU;QAAY;QAAW;KAAa;IAC5D,aAAa,0MAAC,CAAC,MAAM;IACrB,UAAU,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAQ;QAAY;KAAS,EAAE,OAAO;IACxD,mBAAmB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IAC9C,QAAQ,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAU;KAAW;IACrC,WAAW,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC7B,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,aAAa,0MAAC,CAAC,OAAO,GAAG,OAAO,CAAC;AACnC;AAGO,MAAM,qBAAqB,0MAAC,CAAC,MAAM,CAAC;IACzC,MAAM,0MAAC,CAAC,OAAO,CAAC;IAChB,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,YAAY,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAY;QAAgB;KAAW;IAC3D,gBAAgB,0MAAC,CAAC,MAAM,GAAG,OAAO;IAClC,UAAU,0MAAC,CAAC,MAAM,CAAC,0MAAC,CAAC,MAAM,IAAI,0MAAC,CAAC,MAAM,IAAI,OAAO;IAClD,aAAa,0MAAC,CAAC,MAAM,CAAC;QACpB,cAAc,0MAAC,CAAC,MAAM,GAAG,OAAO;QAChC,gBAAgB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;QAC3C,mBAAmB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IAChD,GAAG,OAAO;IACV,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;AACjD;AAGO,MAAM,mBAAmB,0MAAC,CAAC,MAAM,CAAC;IACvC,MAAM,0MAAC,CAAC,OAAO,CAAC;IAChB,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,YAAY,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAY;QAAgB;KAAW;IAC3D,mBAAmB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM;IACnC,YAAY,0MAAC,CAAC,MAAM,CAAC;QACnB,gBAAgB,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO;QAC7C,gBAAgB,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO;QAC7C,aAAa,0MAAC,CAAC,MAAM,GAAG,OAAO;QAC/B,oBAAoB,0MAAC,CAAC,IAAI,CAAC;YAAC;YAAO;YAAY;SAAO,EAAE,OAAO;IACjE,GAAG,OAAO;IACV,aAAa,0MAAC,CAAC,MAAM,CAAC;QACpB,QAAQ,0MAAC,CAAC,OAAO,GAAG,OAAO;QAC3B,SAAS,0MAAC,CAAC,OAAO,GAAG,OAAO;QAC5B,mBAAmB,0MAAC,CAAC,IAAI,CAAC;YAAC;YAAS;YAAc;SAAO,EAAE,OAAO;QAClE,WAAW,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO;IACxC,GAAG,OAAO;IACV,WAAW,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,GAAG,OAAO;AACnD;AAGO,MAAM,qBAAqB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,KAAK,CAAC;IAChD;IACA;CACD;AAGM,MAAM,cAAc,0MAAC,CAAC,MAAM,CAAC;IAClC,SAAS,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC3B,SAAS,0MAAC,CAAC,MAAM;IACjB,UAAU,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,OAAO;IAClD,UAAU,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC5B,YAAY,0MAAC,CAAC,MAAM,GAAG,OAAO;AAChC;AAGO,MAAM,uBAAuB,0MAAC,CAAC,MAAM,CAAC;IAC3C,OAAO;IAEP,2EAA2E;IAC3E,yDAAyD;IACzD,iBAAiB,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAY;QAAgB;KAAW,EAAE,OAAO;IAEzE,iBAAiB,sBAAsB,OAAO;IAC9C,cAAc,mBAAmB,OAAO;IACxC,aAAa,0MAAC,CAAC,KAAK,CAAC,kBAAkB,OAAO;IAC9C,SAAS,kBAAkB,OAAO;IAElC,YAAY,mBAAmB,OAAO;AACxC;AAGO,MAAM,mBAAmB,0MAAC,CAAC,MAAM,CAAC;IACvC,MAAM,0MAAC,CAAC,MAAM,GAAG,OAAO;IACxB,OAAO,0MAAC,CAAC,MAAM,GAAG,KAAK,GAAG,OAAO;IACjC,aAAa,0MAAC,CAAC,MAAM,GAClB,SAAS,CAAC,sLAAsB,EAChC,MAAM,CAAC,qLAAqB,EAAE;QAAE,SAAS;IAAkC;IAC9E,KAAK,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,KAAK,OAAO;IAC7C,QAAQ,0MAAC,CAAC,MAAM,GAAG,OAAO;IAC1B,UAAU,0MAAC,CAAC,OAAO,GAAG,OAAO,GAAG,OAAO,CAAC;IACxC,SAAS,0MAAC,CAAC,OAAO,GAAG,OAAO,GAAG,OAAO,CAAC;IACvC,kBAAkB,0MAAC,CAAC,MAAM,GAAG,OAAO;IACpC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,OAAO;IAC1D,UAAU,0MAAC,CAAC,MAAM,GAAG,OAAO;AAC9B;AAGO,MAAM,mBAAmB,iBAAiB,OAAO;AAGjD,MAAM,6BAA6B,qBAAqB,OAAO;AAG/D,MAAM,2BAA2B,0MAAC,CAAC,MAAM,CAAC;IAC/C,OAAO,0MAAC,CAAC,MAAM;IACf,UAAU,0MAAC,CAAC,OAAO,GAAG,QAAQ;IAC9B,UAAU,0MAAC,CAAC,OAAO,GAAG,QAAQ;IAC9B,WAAW,0MAAC,CAAC,IAAI;AACnB;AAGO,MAAM,6BAA6B,0MAAC,CAAC,MAAM,CAAC;IACjD,SAAS,qBAAqB,OAAO;IACrC,QAAQ,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAQ;QAAQ;QAAS;QAAO;KAAS;IACzD,QAAQ,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ;AACxC"}},
    {"offset": {"line": 813, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/user/index.ts"],"sourcesContent":["export * from './schemas';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 820, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/user.ts"],"sourcesContent":["// Re-export types from shared (Zod schemas and inferred types)\nexport * from '@/shared/types/user';\n\n// Import Kysely DB types\nimport type { Users } from './_types';\nimport { Insertable, Selectable, Updateable } from 'kysely';\n\n// Kysely-based types (using database schema)\nexport type User = Selectable<Users>;\nexport type NewUser = Insertable<Users>;\nexport type UserUpdate = Updateable<Users>;\n\n// Import what we need for the UserModel class\nimport type { FitnessProfile } from '@/shared/types/user';\nimport { validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\nexport type CreateUserData = Omit<NewUser, 'id' | 'createdAt' | 'updatedAt'>;\nexport type CreateFitnessProfileData = Partial<FitnessProfile>;\n\nexport type UserWithProfile = User & {\n  profile?: string | null; // Joined from profiles table\n}\n\n/**\n * UserModel - Domain logic and validation only\n * No direct repository access - Services orchestrate repository calls\n */\nexport class UserModel {\n  static fromDb(user?: User): UserWithProfile | undefined {\n    return user ? { ...user } : undefined;\n  }\n\n  /**\n   * Convert DB result with joined profile to UserWithProfile\n   * Used when fetching user with profiles table joined\n   */\n  static fromDbWithProfile(dbResult: any): UserWithProfile { // eslint-disable-line @typescript-eslint/no-explicit-any\n    const { profile, ...userData } = dbResult;\n    return {\n      ...userData,\n      profile: profile || null,\n    };\n  }\n\n  /**\n   * Validates user data for creation\n   * @param userData - User data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserData(userData: CreateUserData): void {\n    if (!userData.name || userData.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (!userData.phoneNumber || !validateUSPhoneNumber(userData.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (userData.email && !this.isValidEmail(userData.email)) {\n      throw new Error('Invalid email format');\n    }\n  }\n\n  /**\n   * Validates user update data\n   * @param updates - Update data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserUpdates(updates: Partial<User>): void {\n    if (updates.name && updates.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (updates.phoneNumber && !validateUSPhoneNumber(updates.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (updates.email && !this.isValidEmail(updates.email)) {\n      throw new Error('Invalid email format');\n    }\n\n    if (updates.preferredSendHour !== undefined && (updates.preferredSendHour < 0 || updates.preferredSendHour > 23)) {\n      throw new Error('Preferred send hour must be between 0 and 23');\n    }\n\n    if (updates.age !== undefined && updates.age !== null && (updates.age < 1 || updates.age > 120)) {\n      throw new Error('Age must be between 1 and 120');\n    }\n  }\n\n  private static isValidEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n}\n"],"names":[],"mappings":"AAAA,+DAA+D;;;;;AAC/D;AAaA;;;AAaO,MAAM;IACX,OAAO,OAAO,IAAW,EAA+B;QACtD,OAAO,OAAO;YAAE,GAAG,IAAI;QAAC,IAAI;IAC9B;IAEA;;;GAGC,GACD,OAAO,kBAAkB,QAAa,EAAmB;QACvD,MAAM,EAAE,OAAO,EAAE,GAAG,UAAU,GAAG;QACjC,OAAO;YACL,GAAG,QAAQ;YACX,SAAS,WAAW;QACtB;IACF;IAEA;;;;GAIC,GACD,OAAO,iBAAiB,QAAwB,EAAQ;QACtD,IAAI,CAAC,SAAS,IAAI,IAAI,SAAS,IAAI,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;YACrD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,CAAC,SAAS,WAAW,IAAI,CAAC,IAAA,qLAAqB,EAAC,SAAS,WAAW,GAAG;YACzE,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,SAAS,KAAK,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,SAAS,KAAK,GAAG;YACxD,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;;;GAIC,GACD,OAAO,oBAAoB,OAAsB,EAAQ;QACvD,IAAI,QAAQ,IAAI,IAAI,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;YAClD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,WAAW,IAAI,CAAC,IAAA,qLAAqB,EAAC,QAAQ,WAAW,GAAG;YACtE,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,KAAK,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,QAAQ,KAAK,GAAG;YACtD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,iBAAiB,KAAK,aAAa,CAAC,QAAQ,iBAAiB,GAAG,KAAK,QAAQ,iBAAiB,GAAG,EAAE,GAAG;YAChH,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,GAAG,KAAK,aAAa,QAAQ,GAAG,KAAK,QAAQ,CAAC,QAAQ,GAAG,GAAG,KAAK,QAAQ,GAAG,GAAG,GAAG,GAAG;YAC/F,MAAM,IAAI,MAAM;QAClB;IACF;IAEA,OAAe,aAAa,KAAa,EAAW;QAClD,MAAM,aAAa;QACnB,OAAO,WAAW,IAAI,CAAC;IACzB;AACF"}},
    {"offset": {"line": 890, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/utils/date.ts"],"sourcesContent":["/**\n * Date & Time Utilities\n *\n * Single source of truth for all date/time operations across the application.\n * Handles timezone conversions, formatting for UI/AI/API, and date comparisons.\n *\n * Uses Luxon for timezone-aware operations.\n *\n * @example\n * ```typescript\n * import { formatForUI, formatForAI, parseDate } from '@/shared/utils/date';\n *\n * // Format for UI display\n * const displayDate = formatForUI(new Date(), 'short');\n *\n * // Format for AI prompts\n * const aiDate = formatForAI(new Date(), 'America/New_York');\n *\n * // Parse safely\n * const parsed = parseDate('2025-01-20');\n * ```\n */\n\nimport { DateTime, IANAZone } from 'luxon';\n\nexport type DayOfWeek =\n  | \"MONDAY\"\n  | \"TUESDAY\"\n  | \"WEDNESDAY\"\n  | \"THURSDAY\"\n  | \"FRIDAY\"\n  | \"SATURDAY\"\n  | \"SUNDAY\";\n\nexport const DAY_NAMES = [\n  \"MONDAY\",\n  \"TUESDAY\",\n  \"WEDNESDAY\",\n  \"THURSDAY\",\n  \"FRIDAY\",\n  \"SATURDAY\",\n  \"SUNDAY\",\n] as DayOfWeek[];\n/**\n * Date format types for different use cases\n */\nexport type DateFormatType =\n  | 'short'      // \"Jan 20, 2025\"\n  | 'long'       // \"January 20, 2025\"\n  | 'time'       // \"2:30 PM\"\n  | 'datetime'   // \"Jan 20, 2025, 2:30 PM\"\n  | 'relative';  // \"2 days ago\"\n\n// ==========================================\n// Construction & Parsing\n// ==========================================\n\n/**\n * Safely parse a date value into a Date object\n * Handles Date objects, ISO strings, SQL dates, timestamps, and invalid values\n *\n * PostgreSQL stores dates as 'date' type (e.g., '2025-11-06') without timezone info.\n * When JavaScript parses these as `new Date('2025-11-06')`, it interprets them as\n * UTC midnight and then converts to local timezone, causing off-by-one-day bugs.\n * This function ensures SQL dates are always interpreted as UTC to avoid timezone shifts.\n */\nexport function parseDate(value: Date | string | number | null | undefined): Date | null {\n  if (!value) return null;\n\n  if (value instanceof Date) {\n    return isNaN(value.getTime()) ? null : value;\n  }\n\n  if (typeof value === 'string') {\n    // If it already has time component (ISO 8601), parse directly\n    if (value.includes('T')) {\n      const date = new Date(value);\n      return isNaN(date.getTime()) ? null : date;\n    }\n\n    // SQL date format (YYYY-MM-DD) - add UTC midnight to prevent timezone shifts\n    const date = new Date(value + 'T00:00:00Z');\n    return isNaN(date.getTime()) ? null : date;\n  }\n\n  if (typeof value === 'number') {\n    const date = new Date(value);\n    return isNaN(date.getTime()) ? null : date;\n  }\n\n  return null;\n}\n\n/**\n * Get current date/time in a specific timezone\n * @param timezone - IANA timezone (e.g., \"America/New_York\")\n * @returns Luxon DateTime in the specified timezone\n */\nexport function now(timezone?: string): DateTime {\n  if (timezone && isValidTimezone(timezone)) {\n    return DateTime.now().setZone(timezone);\n  }\n  return DateTime.now();\n}\n\n/**\n * Get today's date (start of day) in a specific timezone\n * @param timezone - IANA timezone (e.g., \"America/New_York\")\n * @returns Date object representing midnight of today in the specified timezone\n */\nexport function today(timezone?: string): Date {\n  return now(timezone).startOf('day').toJSDate();\n}\n\n/**\n * Get start of day for a date in a specific timezone\n */\nexport function startOfDay(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to startOfDay');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.startOf('day').toJSDate();\n}\n\n/**\n * Get end of day for a date in a specific timezone\n */\nexport function endOfDay(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to endOfDay');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.endOf('day').toJSDate();\n}\n\n// ==========================================\n// Timezone Operations\n// ==========================================\n\n/**\n * Validate if a string is a valid IANA timezone\n */\nexport function isValidTimezone(timezone: string): boolean {\n  return IANAZone.isValidZone(timezone);\n}\n\n/**\n * Convert a Date to a specific timezone\n * @returns Luxon DateTime in the target timezone\n */\nexport function convertToTimezone(date: Date | string, timezone: string): DateTime {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to convertToTimezone');\n  }\n\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  return DateTime.fromJSDate(parsed, { zone: 'utc' }).setZone(timezone);\n}\n\n/**\n * Convert a local date/time in a timezone to UTC\n */\nexport function convertToUTC(localDate: Date | string, timezone: string): Date {\n  const parsed = parseDate(localDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to convertToUTC');\n  }\n\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  return DateTime.fromJSDate(parsed, { zone: timezone }).toUTC().toJSDate();\n}\n\n/**\n * Get the local hour for a given UTC date in a specific timezone\n */\nexport function getLocalHour(utcDate: Date | string, timezone: string): number {\n  const dt = convertToTimezone(utcDate, timezone);\n  return dt.hour;\n}\n\n// ==========================================\n// Formatting for UI\n// ==========================================\n\n/**\n * Format date for UI display with consistent formatting\n * @param date - Date to format\n * @param format - Format type (short, long, time, datetime, relative)\n * @param timezone - Optional timezone for localization\n * @returns Formatted date string\n */\nexport function formatForUI(\n  date: Date | string | null | undefined,\n  format: DateFormatType = 'short',\n  timezone?: string\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  switch (format) {\n    case 'short':\n      return dt.toLocaleString({ month: 'short', day: 'numeric', year: 'numeric' });\n\n    case 'long':\n      return dt.toLocaleString({ month: 'long', day: 'numeric', year: 'numeric' });\n\n    case 'time':\n      return dt.toLocaleString(DateTime.TIME_SIMPLE);\n\n    case 'datetime':\n      return dt.toLocaleString(DateTime.DATETIME_MED);\n\n    case 'relative':\n      return formatRelative(parsed);\n\n    default:\n      return dt.toLocaleString({ month: 'short', day: 'numeric', year: 'numeric' });\n  }\n}\n\n/**\n * Format date as relative time (e.g., \"2 days ago\", \"in 3 hours\")\n */\nexport function formatRelative(date: Date | string): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  const dt = DateTime.fromJSDate(parsed);\n  const nowDt = DateTime.now();\n  const diff = dt.diff(nowDt, ['years', 'months', 'days', 'hours', 'minutes']).toObject();\n\n  // Future dates\n  if (dt > nowDt) {\n    if (Math.abs(diff.years || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.years || 0))} year${Math.abs(diff.years || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.months || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.months || 0))} month${Math.abs(diff.months || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.days || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.days || 0))} day${Math.abs(diff.days || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.hours || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.hours || 0))} hour${Math.abs(diff.hours || 0) !== 1 ? 's' : ''}`;\n    }\n    return `in ${Math.round(Math.abs(diff.minutes || 0))} minute${Math.abs(diff.minutes || 0) !== 1 ? 's' : ''}`;\n  }\n\n  // Past dates\n  if (Math.abs(diff.years || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.years || 0))} year${Math.abs(diff.years || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.months || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.months || 0))} month${Math.abs(diff.months || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.days || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.days || 0))} day${Math.abs(diff.days || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.hours || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.hours || 0))} hour${Math.abs(diff.hours || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.minutes || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.minutes || 0))} minute${Math.abs(diff.minutes || 0) !== 1 ? 's' : ''} ago`;\n  }\n  return 'just now';\n}\n\n// ==========================================\n// Formatting for AI/LLM\n// ==========================================\n\n/**\n * Format date for AI prompts with consistent, human-readable format\n * @param date - Date to format\n * @param timezone - User's timezone for context\n * @returns Human-readable date string (e.g., \"Monday, January 20, 2025\")\n */\nexport function formatForAI(date: Date | string, timezone: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toLocaleString({\n    weekday: 'long',\n    month: 'long',\n    day: 'numeric',\n    year: 'numeric',\n  });\n}\n\n/**\n * Format date for AI with custom pattern\n * @param date - Date to format\n * @param timezone - User's timezone\n * @param includeDay - Whether to include day of week\n * @returns Formatted string\n */\nexport function formatForAICustom(\n  date: Date | string,\n  timezone: string,\n  options: { includeDay?: boolean; includeYear?: boolean } = {}\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  const { includeDay = true, includeYear = true } = options;\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  const formatOptions: Intl.DateTimeFormatOptions = {\n    month: 'long',\n    day: 'numeric',\n  };\n\n  if (includeDay) {\n    formatOptions.weekday = 'long';\n  }\n\n  if (includeYear) {\n    formatOptions.year = 'numeric';\n  }\n\n  return dt.toLocaleString(formatOptions);\n}\n\n// ==========================================\n// Formatting for API\n// ==========================================\n\n/**\n * Format date for API responses (ISO 8601 string)\n * @param date - Date to format\n * @returns ISO 8601 string\n */\nexport function formatForAPI(date: Date | string | null | undefined): string | null {\n  const parsed = parseDate(date);\n  if (!parsed) return null;\n  return parsed.toISOString();\n}\n\n/**\n * Format date for database storage\n * Ensures consistent Date object format\n */\nexport function formatForDatabase(date: Date | string | null | undefined): Date | null {\n  return parseDate(date);\n}\n\n// ==========================================\n// Comparison & Validation\n// ==========================================\n\n/**\n * Check if a value is a valid date\n */\nexport function isValidDate(value: unknown): boolean {\n  const parsed = parseDate(value as Date | string);\n  return parsed !== null;\n}\n\n/**\n * Check if two dates are on the same day\n * @param timezone - Optional timezone for comparison (uses date's timezone if not provided)\n */\nexport function isSameDay(date1: Date | string, date2: Date | string, timezone?: string): boolean {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return false;\n\n  let dt1 = DateTime.fromJSDate(parsed1);\n  let dt2 = DateTime.fromJSDate(parsed2);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt1 = dt1.setZone(timezone);\n    dt2 = dt2.setZone(timezone);\n  }\n\n  return dt1.hasSame(dt2, 'day');\n}\n\n/**\n * Check if a date is today\n * @param timezone - Timezone to check against (defaults to system timezone)\n */\nexport function isToday(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.hasSame(nowDt, 'day');\n}\n\n/**\n * Check if a date is in the past\n */\nexport function isPast(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt < nowDt;\n}\n\n/**\n * Check if a date is in the future\n */\nexport function isFuture(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt > nowDt;\n}\n\n/**\n * Get difference between two dates in days\n */\nexport function diffInDays(date1: Date | string, date2: Date | string): number {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return 0;\n\n  const dt1 = DateTime.fromJSDate(parsed1);\n  const dt2 = DateTime.fromJSDate(parsed2);\n\n  return Math.round(dt1.diff(dt2, 'days').days);\n}\n\n// ==========================================\n// Utility Methods\n// ==========================================\n\n/**\n * Add days to a date\n */\nexport function addDays(date: Date | string, days: number, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to addDays');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ days }).toJSDate();\n}\n\n/**\n * Subtract days from a date\n */\nexport function subtractDays(date: Date | string, days: number, timezone?: string): Date {\n  return addDays(date, -days, timezone);\n}\n\n/**\n * Get day of week as DayOfWeek type\n * @param date - Optional date to check (defaults to current date/time)\n * @param timezone - Timezone to use (required)\n * @returns DayOfWeek string (e.g., \"MONDAY\", \"TUESDAY\")\n */\nexport function getDayOfWeek(date: Date | string | undefined, timezone: string): DayOfWeek {\n  let dt: DateTime;\n\n  if (date === undefined) {\n    // Use current date/time in the specified timezone\n    dt = now(timezone);\n  } else {\n    const parsed = parseDate(date);\n    if (!parsed) {\n      throw new Error('Invalid date provided to getDayOfWeek');\n    }\n    dt = DateTime.fromJSDate(parsed);\n    if (timezone && isValidTimezone(timezone)) {\n      dt = dt.setZone(timezone);\n    }\n  }\n\n  // Luxon weekday is 1-7 (Monday-Sunday), DAY_NAMES is 0-indexed (Monday-Sunday)\n  return DAY_NAMES[dt.weekday - 1];\n}\n\n/**\n * Get day of week in Luxon format (1 = Monday, 7 = Sunday)\n * @param date - Date to check\n * @param timezone - Timezone to convert to\n * @returns Weekday number (1-7)\n */\nexport function getWeekday(date: Date | string, timezone?: string): number {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getWeekday');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.weekday; // 1=Monday, 7=Sunday\n}\n\n/**\n * Check if a UTC date is a specific weekday in a user's timezone\n * @param utcDate - UTC date to check\n * @param timezone - User's timezone\n * @param weekday - Weekday to check (1=Monday, 7=Sunday)\n * @returns true if the date is the specified weekday in the user's timezone\n */\nexport function isWeekdayInTimezone(\n  utcDate: Date | string,\n  timezone: string,\n  weekday: number\n): boolean {\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  if (weekday < 1 || weekday > 7) {\n    throw new Error(`Invalid weekday: ${weekday}. Must be 1-7 (1=Monday, 7=Sunday)`);\n  }\n\n  const parsed = parseDate(utcDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to isWeekdayInTimezone');\n  }\n\n  const dt = DateTime.fromJSDate(parsed, { zone: 'utc' }).setZone(timezone);\n  return dt.weekday === weekday;\n}\n\n/**\n * Get all IANA timezones that are currently at a specific local time\n *\n * Filters the complete list of IANA timezones (~600) to find which ones\n * are currently at the target local hour and optional weekday.\n *\n * @param utcDate - Current UTC date/time\n * @param targetLocalHour - Target local hour (0-23)\n * @param weekday - Optional weekday filter (1=Monday, 7=Sunday)\n * @returns Array of timezone strings that match the criteria\n *\n * @example\n * // Find timezones where it's 5pm (17:00) on a Sunday\n * const utcNow = new Date();\n * const timezones = getTimezonesAtLocalTime(utcNow, 17, 7);\n * // Returns: ['America/New_York', 'America/Toronto', ...] if it's Sunday 5pm there\n */\nexport function getTimezonesAtLocalTime(\n  utcDate: Date | string,\n  targetLocalHour: number,\n  weekday?: number\n): string[] {\n  const parsed = parseDate(utcDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getTimezonesAtLocalTime');\n  }\n\n  if (targetLocalHour < 0 || targetLocalHour > 23) {\n    throw new Error(`Invalid target hour: ${targetLocalHour}. Must be 0-23`);\n  }\n\n  if (weekday !== undefined && (weekday < 1 || weekday > 7)) {\n    throw new Error(`Invalid weekday: ${weekday}. Must be 1-7 (1=Monday, 7=Sunday)`);\n  }\n\n  const matchingTimezones: string[] = [];\n\n  // Get all IANA timezones (browser/Node.js built-in)\n  const allTimezones = Intl.supportedValuesOf('timeZone');\n\n  for (const timezone of allTimezones) {\n    try {\n      // Check if this timezone is at the target local hour\n      const localHour = getLocalHour(parsed, timezone);\n      if (localHour !== targetLocalHour) {\n        continue;\n      }\n\n      // If weekday is specified, check if it matches\n      if (weekday !== undefined) {\n        const isMatchingWeekday = isWeekdayInTimezone(parsed, timezone, weekday);\n        if (!isMatchingWeekday) {\n          continue;\n        }\n      }\n\n      matchingTimezones.push(timezone);\n    } catch {\n      // Skip invalid timezones\n      continue;\n    }\n  }\n\n  return matchingTimezones;\n}\n\n/**\n * Get start of week for a date in a specific timezone\n * Week starts on Monday (ISO week)\n */\nexport function startOfWeek(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to startOfWeek');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.startOf('week').toJSDate();\n}\n\n/**\n * Get end of week for a date in a specific timezone\n * Week ends on Sunday (ISO week)\n */\nexport function endOfWeek(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to endOfWeek');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.endOf('week').toJSDate();\n}\n\n/**\n * Add weeks to a date\n */\nexport function addWeeks(date: Date | string, weeks: number, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to addWeeks');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ weeks }).toJSDate();\n}\n\n/**\n * Subtract weeks from a date\n */\nexport function subtractWeeks(date: Date | string, weeks: number, timezone?: string): Date {\n  return addWeeks(date, -weeks, timezone);\n}\n\n/**\n * Get the start of the next week (next Monday)\n */\nexport function getNextWeekStart(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getNextWeekStart');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ weeks: 1 }).startOf('week').toJSDate();\n}\n\n/**\n * Get difference between two dates in weeks\n */\nexport function diffInWeeks(date1: Date | string, date2: Date | string, timezone?: string): number {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return 0;\n\n  let dt1 = DateTime.fromJSDate(parsed1);\n  let dt2 = DateTime.fromJSDate(parsed2);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt1 = dt1.setZone(timezone);\n    dt2 = dt2.setZone(timezone);\n  }\n\n  return Math.floor(dt1.diff(dt2, 'weeks').weeks);\n}\n\n/**\n * Get day of week name (e.g., \"Monday\", \"Tuesday\")\n */\nexport function getDayOfWeekName(date: Date | string, timezone?: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getDayOfWeekName');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toFormat('EEEE');\n}\n\n/**\n * Get ISO date string (YYYY-MM-DD) in a specific timezone\n * Useful for API calls and date comparisons\n */\nexport function toISODate(date: Date | string, timezone?: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to toISODate');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toISODate() || '';\n}\n\n/**\n * Simple date formatter for display purposes\n *\n * Use this to display dates in a consistent format across the UI.\n * Defaults to UTC timezone to prevent display shifts for SQL dates.\n *\n * @param date - Date to format\n * @param options - Intl.DateTimeFormat options (timeZone defaults to UTC)\n * @returns Formatted date string\n *\n * @example\n * formatDate(workout.date)  // \"11/6/2025\"\n * formatDate(workout.date, { weekday: 'long', month: 'long', day: 'numeric' })  // \"Wednesday, November 6\"\n */\nexport function formatDate(\n  date: Date | string | null | undefined,\n  options?: Intl.DateTimeFormatOptions\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  return parsed.toLocaleDateString('en-US', {\n    timeZone: 'UTC',\n    ...options\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1452, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/timezone.ts"],"sourcesContent":["/**\n * Timezone utilities for handling IANA timezone validation and conversions\n */\nimport { DateTime, IANAZone } from 'luxon';\nimport { now } from '@/shared/utils/date';\n\n// Common IANA timezones for UI selection\nexport const COMMON_TIMEZONES = [\n  // Americas\n  'America/New_York',\n  'America/Chicago',\n  'America/Denver',\n  'America/Los_Angeles',\n  'America/Toronto',\n  'America/Vancouver',\n  'America/Mexico_City',\n  'America/Sao_Paulo',\n  \n  // Europe\n  'Europe/London',\n  'Europe/Paris',\n  'Europe/Berlin',\n  'Europe/Madrid',\n  'Europe/Rome',\n  'Europe/Amsterdam',\n  'Europe/Stockholm',\n  'Europe/Moscow',\n  \n  // Asia Pacific\n  'Asia/Tokyo',\n  'Asia/Shanghai',\n  'Asia/Hong_Kong',\n  'Asia/Singapore',\n  'Asia/Seoul',\n  'Asia/Mumbai',\n  'Asia/Dubai',\n  'Australia/Sydney',\n  'Australia/Melbourne',\n  'Pacific/Auckland',\n] as const;\n\nexport type CommonTimezone = typeof COMMON_TIMEZONES[number];\n\n/**\n * Validates if a string is a valid IANA timezone identifier\n */\nexport function isValidIANATimezone(timezone: string): boolean {\n  return IANAZone.isValidZone(timezone);\n}\n\n/**\n * Gets the local hour for a given UTC date in a specific timezone\n */\nexport function getLocalHourForTimezone(utcDate: Date, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const dt = DateTime.fromJSDate(utcDate, { zone: 'utc' }).setZone(timezone);\n  return dt.hour;\n}\n\n/**\n * Converts a preferred local hour to UTC hour for a given timezone\n * Returns the UTC hour when it's the specified local hour in the given timezone\n */\nexport function convertPreferredHourToUTC(localHour: number, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  if (localHour < 0 || localHour > 23) {\n    throw new Error(`Invalid hour: ${localHour}. Must be between 0 and 23`);\n  }\n  \n  // Get current date in the target timezone\n  const nowDt = now(timezone);\n  // Set to the desired local hour\n  const targetTime = nowDt.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n  // Convert to UTC and get the hour\n  const utcTime = targetTime.setZone('utc');\n  return utcTime.hour;\n}\n\n/**\n * Gets all UTC hours when it's the specified local hour in the given timezone\n * This accounts for DST transitions where a local hour might occur at different UTC hours\n */\nexport function getAllUTCHoursForLocalHour(localHour: number, timezone: string): number[] {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const hours = new Set<number>();\n  const nowDt = now();\n\n  // Check for the next 365 days to cover all DST transitions\n  for (let i = 0; i < 365; i++) {\n    const date = nowDt.plus({ days: i }).setZone(timezone);\n    const targetTime = date.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n    const utcTime = targetTime.setZone('utc');\n    hours.add(utcTime.hour);\n  }\n  \n  return Array.from(hours).sort((a, b) => a - b);\n}\n\n/**\n * Formats a timezone identifier for display in UI\n * Example: \"America/New_York\" -> \"New York (EST/EDT)\"\n */\nexport function formatTimezoneForDisplay(timezone: string): string {\n  if (!isValidIANATimezone(timezone)) {\n    return timezone;\n  }\n  \n  try {\n    const nowDt = now(timezone);\n    const offset = nowDt.toFormat('ZZZ'); // e.g., \"EST\" or \"-05:00\"\n    \n    // Extract city name from timezone\n    const parts = timezone.split('/');\n    const city = parts[parts.length - 1].replace(/_/g, ' ');\n    \n    return `${city} (${offset})`;\n  } catch {\n    return timezone;\n  }\n}\n\nexport function getCommonTimezones(): readonly string[] {\n  return COMMON_TIMEZONES;\n}"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;;;AACD;AAAA;AAAA;AACA;;;AAGO,MAAM,mBAAmB;IAC9B,WAAW;IACX;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,SAAS;IACT;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,eAAe;IACf;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAOM,SAAS,oBAAoB,QAAgB;IAClD,OAAO,wPAAQ,CAAC,WAAW,CAAC;AAC9B;AAKO,SAAS,wBAAwB,OAAa,EAAE,QAAgB;IACrE,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IAEA,MAAM,KAAK,+OAAQ,CAAC,UAAU,CAAC,SAAS;QAAE,MAAM;IAAM,GAAG,OAAO,CAAC;IACjE,OAAO,GAAG,IAAI;AAChB;AAMO,SAAS,0BAA0B,SAAiB,EAAE,QAAgB;IAC3E,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IACA,IAAI,YAAY,KAAK,YAAY,IAAI;QACnC,MAAM,IAAI,MAAM,CAAC,cAAc,EAAE,UAAU,0BAA0B,CAAC;IACxE;IAEA,0CAA0C;IAC1C,MAAM,QAAQ,IAAA,6JAAG,EAAC;IAClB,gCAAgC;IAChC,MAAM,aAAa,MAAM,GAAG,CAAC;QAAE,MAAM;QAAW,QAAQ;QAAG,QAAQ;QAAG,aAAa;IAAE;IACrF,kCAAkC;IAClC,MAAM,UAAU,WAAW,OAAO,CAAC;IACnC,OAAO,QAAQ,IAAI;AACrB;AAMO,SAAS,2BAA2B,SAAiB,EAAE,QAAgB;IAC5E,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IAEA,MAAM,QAAQ,IAAI;IAClB,MAAM,QAAQ,IAAA,6JAAG;IAEjB,2DAA2D;IAC3D,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,IAAK;QAC5B,MAAM,OAAO,MAAM,IAAI,CAAC;YAAE,MAAM;QAAE,GAAG,OAAO,CAAC;QAC7C,MAAM,aAAa,KAAK,GAAG,CAAC;YAAE,MAAM;YAAW,QAAQ;YAAG,QAAQ;YAAG,aAAa;QAAE;QACpF,MAAM,UAAU,WAAW,OAAO,CAAC;QACnC,MAAM,GAAG,CAAC,QAAQ,IAAI;IACxB;IAEA,OAAO,MAAM,IAAI,CAAC,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI;AAC9C;AAMO,SAAS,yBAAyB,QAAgB;IACvD,IAAI,CAAC,oBAAoB,WAAW;QAClC,OAAO;IACT;IAEA,IAAI;QACF,MAAM,QAAQ,IAAA,6JAAG,EAAC;QAClB,MAAM,SAAS,MAAM,QAAQ,CAAC,QAAQ,0BAA0B;QAEhE,kCAAkC;QAClC,MAAM,QAAQ,SAAS,KAAK,CAAC;QAC7B,MAAM,OAAO,KAAK,CAAC,MAAM,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC,MAAM;QAEnD,OAAO,GAAG,KAAK,EAAE,EAAE,OAAO,CAAC,CAAC;IAC9B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 1583, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/userRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport {\n  type User,\n  type UserWithProfile,\n  type CreateUserData,\n  UserModel\n} from '@/server/models/user';\nimport { getLocalHourForTimezone } from '@/server/utils/timezone';\n\nexport class UserRepository extends BaseRepository {\n  async list(params: {\n    q?: string;\n    status?: string;\n    hasProfile?: boolean;\n    hasPlan?: boolean;\n    createdFrom?: string;\n    createdTo?: string;\n    page?: number;\n    pageSize?: number;\n    sort?: string;\n  }): Promise<{ users: UserWithProfile[]; total: number; }> {\n    const {\n      q,\n      createdFrom,\n      createdTo,\n      page = 1,\n      pageSize = 20,\n      sort = 'createdAt:desc',\n    } = params;\n\n    const [sortField, sortDir] = sort.split(':');\n\n    let query = this.db\n      .selectFrom('users')\n      .selectAll('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      query = query.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n\n    if (createdFrom) {\n      query = query.where('users.createdAt', '>=', new Date(createdFrom));\n    }\n    if (createdTo) {\n      query = query.where('users.createdAt', '<=', new Date(createdTo));\n    }\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      query = query.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      query = query.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    let countBuilder = this.db\n      .selectFrom('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      countBuilder = countBuilder.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n    if (createdFrom) countBuilder = countBuilder.where('users.createdAt', '>=', new Date(createdFrom));\n    if (createdTo) countBuilder = countBuilder.where('users.createdAt', '<=', new Date(createdTo));\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    const totalResult = await countBuilder\n      .select((eb) => eb.fn.countAll<number>().as('count'))\n      .executeTakeFirst();\n    const total = Number(totalResult?.count || 0);\n\n    const usersRows = await query\n      // @ts-expect-error dynamic orderBy\n      .orderBy(`users.${sortField}`, sortDir === 'asc' ? 'asc' : 'desc')\n      .offset((page - 1) * pageSize)\n      .limit(pageSize)\n      .execute();\n\n    const users: UserWithProfile[] = usersRows.map((u) => (UserModel.fromDb(u))).filter((u) => u !== undefined);\n\n    return { users, total };\n  }\n\n  async create(userData: CreateUserData): Promise<UserWithProfile | undefined> {\n    const user = await this.db\n    .insertInto('users')\n    .values({\n      name: userData.name,\n      phoneNumber: userData.phoneNumber,\n      age: userData.age || null,\n      gender: userData.gender || null,\n      email: userData.email || null,\n      stripeCustomerId: userData.stripeCustomerId || null,\n      timezone: userData.timezone,\n      preferredSendHour: userData.preferredSendHour,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    })\n    .returningAll()\n    .executeTakeFirstOrThrow()\n    return UserModel.fromDb(user);\n  }\n\n  async findById(id: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('id', '=', id)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByPhoneNumber(phoneNumber: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('phoneNumber', '=', phoneNumber)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByEmail(email: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('email', '=', email)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByStripeCustomerId(stripeCustomerId: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('stripeCustomerId', '=', stripeCustomerId)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async update(id: string, userData: Partial<CreateUserData>): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...userData,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst());\n  }\n\n  /**\n   * Find user with latest profile\n   * Performs LEFT JOIN with profiles table to get most recent profile\n   */\n  async findWithProfile(userId: string): Promise<UserWithProfile | undefined> {\n    const result = await this.db\n      .selectFrom('users')\n      .leftJoin('profiles', (join) =>\n        join\n          .onRef('profiles.clientId', '=', 'users.id')\n          .on((eb) => {\n            // Only join the most recent profile for this user\n            const subquery = eb\n              .selectFrom('profiles as p2')\n              .select((eb) => eb.fn.max('p2.createdAt').as('maxCreated'))\n              .whereRef('p2.clientId', '=', 'users.id');\n\n            return eb('profiles.createdAt', '=', subquery);\n          })\n      )\n      .selectAll('users')\n      .select('profiles.profile')\n      .where('users.id', '=', userId)\n      .executeTakeFirst();\n\n    if (!result) {\n      return undefined;\n    }\n\n    return UserModel.fromDbWithProfile(result);\n  }\n\n  async updatePreferences(userId: string, preferences: {\n    preferredSendHour?: number;\n    timezone?: string;\n    name?: string;\n  }): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...preferences,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', userId)\n      .returningAll()\n      .executeTakeFirstOrThrow());\n  }\n\n  async findUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    // This query finds all users with active subscriptions whose local hour is at or past their preferred send hour\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    // Note: This returns candidates - the caller should also filter by workout existence to avoid duplicates\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n\n    // Filter users whose local hour is at or past their preferred send hour\n    const matchingUsers: UserWithProfile[] = [];\n    const currentUtcDate = new Date();\n    currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n    for (const user of users) {\n      try {\n        const localHour = getLocalHourForTimezone(currentUtcDate, user.timezone);\n        if (localHour >= user.preferredSendHour) {\n          matchingUsers.push(UserModel.fromDb(user)!);\n        }\n      } catch (error) {\n        console.error(`Error processing user ${user.id} timezone:`, error);\n        // Skip users with invalid timezone data\n      }\n    }\n\n    return matchingUsers;\n  }\n\n  async findUsersByTimezones(timezones: string[]): Promise<UserWithProfile[]> {\n    // Return empty array if no timezones provided\n    if (timezones.length === 0) {\n      return [];\n    }\n\n    // Query users with active subscriptions in the specified timezones\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .where('timezone', 'in', timezones)\n      .selectAll('users')\n      .execute();\n\n    return users.map(u => UserModel.fromDb(u)).filter(u => u !== undefined) as UserWithProfile[];\n  }\n\n  async findActiveUsersWithPreferences(): Promise<User[]> {\n    return await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n  }\n\n  async delete(id: string): Promise<boolean> {\n    // First, clean up admin_activity_logs which has no FK constraint\n    // Delete where user is the target or the actor\n    await this.db\n      .deleteFrom('adminActivityLogs')\n      .where((eb) => eb.or([\n        eb('targetClientId', '=', id),\n        eb('actorClientId', '=', id)\n      ]))\n      .execute();\n\n    // Now delete the user - CASCADE will handle all other related tables:\n    // profile_updates, subscriptions, conversations, messages, fitness_plans,\n    // microcycles, workout_instances, user_onboarding, profiles, short_links, message_queues\n    const result = await this.db\n      .deleteFrom('users')\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows) > 0;\n  }\n\n  // ============================================\n  // Referral Code Methods\n  // ============================================\n\n  /**\n   * Generate a random 6-character referral code\n   * Uses uppercase letters and numbers, excluding confusing characters (O/0, I/1, L)\n   */\n  generateReferralCode(): string {\n    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';\n    let code = '';\n    for (let i = 0; i < 6; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  /**\n   * Get or create a referral code for a user\n   * If the user already has a code, returns it; otherwise generates and saves a new one\n   */\n  async getOrCreateReferralCode(userId: string): Promise<string | null> {\n    // First check if user already has a code\n    const user = await this.db\n      .selectFrom('users')\n      .select(['id', 'referralCode'])\n      .where('id', '=', userId)\n      .executeTakeFirst();\n\n    if (!user) {\n      return null;\n    }\n\n    if (user.referralCode) {\n      return user.referralCode;\n    }\n\n    // Generate a new code with retry logic for uniqueness\n    let attempts = 0;\n    const maxAttempts = 10;\n\n    while (attempts < maxAttempts) {\n      const newCode = this.generateReferralCode();\n\n      try {\n        const updated = await this.db\n          .updateTable('users')\n          .set({ referralCode: newCode, updatedAt: new Date() })\n          .where('id', '=', userId)\n          .where('referralCode', 'is', null) // Only update if still null (race condition protection)\n          .returningAll()\n          .executeTakeFirst();\n\n        if (updated) {\n          return newCode;\n        }\n\n        // If no rows updated, the user might have gotten a code from another request\n        const refreshedUser = await this.db\n          .selectFrom('users')\n          .select('referralCode')\n          .where('id', '=', userId)\n          .executeTakeFirst();\n\n        if (refreshedUser?.referralCode) {\n          return refreshedUser.referralCode;\n        }\n      } catch (error) {\n        // Unique constraint violation - try again with a new code\n        attempts++;\n        if (attempts >= maxAttempts) {\n          console.error(`Failed to generate unique referral code after ${maxAttempts} attempts`);\n          throw error;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Find a user by their referral code\n   * Used to validate referral codes during signup\n   */\n  async findByReferralCode(code: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('referralCode', '=', code.toUpperCase())\n      .selectAll()\n      .executeTakeFirst());\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;AAMA;;;;AAEO,MAAM,uBAAuB,yLAAc;IAChD,MAAM,KAAK,MAUV,EAAyD;QACxD,MAAM,EACJ,CAAC,EACD,WAAW,EACX,SAAS,EACT,OAAO,CAAC,EACR,WAAW,EAAE,EACb,OAAO,gBAAgB,EACxB,GAAG;QAEJ,MAAM,CAAC,WAAW,QAAQ,GAAG,KAAK,KAAK,CAAC;QAExC,IAAI,QAAQ,IAAI,CAAC,EAAE,CAChB,UAAU,CAAC,SACX,SAAS,CAAC;QAEb,IAAI,GAAG;YACL,MAAM,OAAO,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YACrB,QAAQ,MAAM,KAAK,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC;oBAChC,GAAG,cAAc,SAAS;oBAC1B,GAAG,eAAe,SAAS;oBAC3B,GAAG,qBAAqB,SAAS;iBAClC;QACH;QAEA,IAAI,aAAa;YACf,QAAQ,MAAM,KAAK,CAAC,mBAAmB,MAAM,IAAI,KAAK;QACxD;QACA,IAAI,WAAW;YACb,QAAQ,MAAM,KAAK,CAAC,mBAAmB,MAAM,IAAI,KAAK;QACxD;QAEA,2DAA2D;QAC3D,IAAI,OAAO,UAAU,KAAK,MAAM;YAC9B,QAAQ,MAAM,KAAK,CAAC,CAAC,KACnB,GAAG,MAAM,CACP,GAAG,UAAU,CAAC,YACX,QAAQ,CAAC,qBAAqB,KAAK,YACnC,MAAM,CAAC;QAGhB,OAAO,IAAI,OAAO,UAAU,KAAK,OAAO;YACtC,QAAQ,MAAM,KAAK,CAAC,CAAC,KACnB,GAAG,GAAG,CACJ,GAAG,MAAM,CACP,GAAG,UAAU,CAAC,YACX,QAAQ,CAAC,qBAAqB,KAAK,YACnC,MAAM,CAAC;QAIlB;QAEA,IAAI,eAAe,IAAI,CAAC,EAAE,CACvB,UAAU,CAAC;QAEd,IAAI,GAAG;YACL,MAAM,OAAO,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YACrB,eAAe,aAAa,KAAK,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC;oBAC9C,GAAG,cAAc,SAAS;oBAC1B,GAAG,eAAe,SAAS;oBAC3B,GAAG,qBAAqB,SAAS;iBAClC;QACH;QACA,IAAI,aAAa,eAAe,aAAa,KAAK,CAAC,mBAAmB,MAAM,IAAI,KAAK;QACrF,IAAI,WAAW,eAAe,aAAa,KAAK,CAAC,mBAAmB,MAAM,IAAI,KAAK;QAEnF,2DAA2D;QAC3D,IAAI,OAAO,UAAU,KAAK,MAAM;YAC9B,eAAe,aAAa,KAAK,CAAC,CAAC,KACjC,GAAG,MAAM,CACP,GAAG,UAAU,CAAC,YACX,QAAQ,CAAC,qBAAqB,KAAK,YACnC,MAAM,CAAC;QAGhB,OAAO,IAAI,OAAO,UAAU,KAAK,OAAO;YACtC,eAAe,aAAa,KAAK,CAAC,CAAC,KACjC,GAAG,GAAG,CACJ,GAAG,MAAM,CACP,GAAG,UAAU,CAAC,YACX,QAAQ,CAAC,qBAAqB,KAAK,YACnC,MAAM,CAAC;QAIlB;QAEA,MAAM,cAAc,MAAM,aACvB,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,QAAQ,GAAW,EAAE,CAAC,UAC3C,gBAAgB;QACnB,MAAM,QAAQ,OAAO,aAAa,SAAS;QAE3C,MAAM,YAAY,MAAM,KACtB,mCAAmC;SAClC,OAAO,CAAC,CAAC,MAAM,EAAE,WAAW,EAAE,YAAY,QAAQ,QAAQ,QAC1D,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,UACpB,KAAK,CAAC,UACN,OAAO;QAEV,MAAM,QAA2B,UAAU,GAAG,CAAC,CAAC,IAAO,oLAAS,CAAC,MAAM,CAAC,IAAK,MAAM,CAAC,CAAC,IAAM,MAAM;QAEjG,OAAO;YAAE;YAAO;QAAM;IACxB;IAEA,MAAM,OAAO,QAAwB,EAAwC;QAC3E,MAAM,OAAO,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,MAAM,CAAC;YACN,MAAM,SAAS,IAAI;YACnB,aAAa,SAAS,WAAW;YACjC,KAAK,SAAS,GAAG,IAAI;YACrB,QAAQ,SAAS,MAAM,IAAI;YAC3B,OAAO,SAAS,KAAK,IAAI;YACzB,kBAAkB,SAAS,gBAAgB,IAAI;YAC/C,UAAU,SAAS,QAAQ;YAC3B,mBAAmB,SAAS,iBAAiB;YAC7C,WAAW,IAAI;YACf,WAAW,IAAI;QACjB,GACC,YAAY,GACZ,uBAAuB;QACxB,OAAO,oLAAS,CAAC,MAAM,CAAC;IAC1B;IAEA,MAAM,SAAS,EAAU,EAAwC;QAC/D,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,MAAM,KAAK,IACjB,SAAS,GACT,gBAAgB;IACrB;IAEA,MAAM,kBAAkB,WAAmB,EAAwC;QACjF,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,eAAe,KAAK,aAC1B,SAAS,GACT,gBAAgB;IACrB;IAEA,MAAM,YAAY,KAAa,EAAwC;QACrE,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,SAAS,KAAK,OACpB,SAAS,GACT,gBAAgB;IACrB;IAEA,MAAM,uBAAuB,gBAAwB,EAAwC;QAC3F,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,oBAAoB,KAAK,kBAC/B,SAAS,GACT,gBAAgB;IACrB;IAEA,MAAM,OAAO,EAAU,EAAE,QAAiC,EAAwC;QAChG,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,WAAW,CAAC,SACZ,GAAG,CAAC;YACH,GAAG,QAAQ;YACX,WAAW,IAAI;QACjB,GACC,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,gBAAgB;IACrB;IAEA;;;GAGC,GACD,MAAM,gBAAgB,MAAc,EAAwC;QAC1E,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,QAAQ,CAAC,YAAY,CAAC,OACrB,KACG,KAAK,CAAC,qBAAqB,KAAK,YAChC,EAAE,CAAC,CAAC;gBACH,kDAAkD;gBAClD,MAAM,WAAW,GACd,UAAU,CAAC,kBACX,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC,eAC5C,QAAQ,CAAC,eAAe,KAAK;gBAEhC,OAAO,GAAG,sBAAsB,KAAK;YACvC,IAEH,SAAS,CAAC,SACV,MAAM,CAAC,oBACP,KAAK,CAAC,YAAY,KAAK,QACvB,gBAAgB;QAEnB,IAAI,CAAC,QAAQ;YACX,OAAO;QACT;QAEA,OAAO,oLAAS,CAAC,iBAAiB,CAAC;IACrC;IAEA,MAAM,kBAAkB,MAAc,EAAE,WAIvC,EAAwC;QACvC,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,WAAW,CAAC,SACZ,GAAG,CAAC;YACH,GAAG,WAAW;YACd,WAAW,IAAI;QACjB,GACC,KAAK,CAAC,MAAM,KAAK,QACjB,YAAY,GACZ,uBAAuB;IAC5B;IAEA,MAAM,iBAAiB,cAAsB,EAA8B;QACzE,gHAAgH;QAChH,8FAA8F;QAC9F,yGAAyG;QACzG,MAAM,QAAQ,MAAM,IAAI,CAAC,EAAE,CACxB,UAAU,CAAC,SACX,SAAS,CAAC,iBAAiB,YAAY,0BACvC,KAAK,CAAC,wBAAwB,KAAK,UACnC,SAAS,CAAC,SACV,OAAO;QAEV,wEAAwE;QACxE,MAAM,gBAAmC,EAAE;QAC3C,MAAM,iBAAiB,IAAI;QAC3B,eAAe,WAAW,CAAC,gBAAgB,GAAG,GAAG;QAEjD,KAAK,MAAM,QAAQ,MAAO;YACxB,IAAI;gBACF,MAAM,YAAY,IAAA,qLAAuB,EAAC,gBAAgB,KAAK,QAAQ;gBACvE,IAAI,aAAa,KAAK,iBAAiB,EAAE;oBACvC,cAAc,IAAI,CAAC,oLAAS,CAAC,MAAM,CAAC;gBACtC;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,CAAC,sBAAsB,EAAE,KAAK,EAAE,CAAC,UAAU,CAAC,EAAE;YAC5D,wCAAwC;YAC1C;QACF;QAEA,OAAO;IACT;IAEA,MAAM,qBAAqB,SAAmB,EAA8B;QAC1E,8CAA8C;QAC9C,IAAI,UAAU,MAAM,KAAK,GAAG;YAC1B,OAAO,EAAE;QACX;QAEA,mEAAmE;QACnE,8FAA8F;QAC9F,MAAM,QAAQ,MAAM,IAAI,CAAC,EAAE,CACxB,UAAU,CAAC,SACX,SAAS,CAAC,iBAAiB,YAAY,0BACvC,KAAK,CAAC,wBAAwB,KAAK,UACnC,KAAK,CAAC,YAAY,MAAM,WACxB,SAAS,CAAC,SACV,OAAO;QAEV,OAAO,MAAM,GAAG,CAAC,CAAA,IAAK,oLAAS,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,CAAA,IAAK,MAAM;IAC/D;IAEA,MAAM,iCAAkD;QACtD,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,SACX,SAAS,CAAC,iBAAiB,YAAY,0BACvC,KAAK,CAAC,wBAAwB,KAAK,UACnC,SAAS,CAAC,SACV,OAAO;IACZ;IAEA,MAAM,OAAO,EAAU,EAAoB;QACzC,iEAAiE;QACjE,+CAA+C;QAC/C,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,qBACX,KAAK,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC;gBACnB,GAAG,kBAAkB,KAAK;gBAC1B,GAAG,iBAAiB,KAAK;aAC1B,GACA,OAAO;QAEV,sEAAsE;QACtE,0EAA0E;QAC1E,yFAAyF;QACzF,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,SACX,KAAK,CAAC,MAAM,KAAK,IACjB,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;IAEA,+CAA+C;IAC/C,wBAAwB;IACxB,+CAA+C;IAE/C;;;GAGC,GACD,uBAA+B;QAC7B,MAAM,QAAQ;QACd,IAAI,OAAO;QACX,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;YAC1B,QAAQ,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;QAC9D;QACA,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,wBAAwB,MAAc,EAA0B;QACpE,yCAAyC;QACzC,MAAM,OAAO,MAAM,IAAI,CAAC,EAAE,CACvB,UAAU,CAAC,SACX,MAAM,CAAC;YAAC;YAAM;SAAe,EAC7B,KAAK,CAAC,MAAM,KAAK,QACjB,gBAAgB;QAEnB,IAAI,CAAC,MAAM;YACT,OAAO;QACT;QAEA,IAAI,KAAK,YAAY,EAAE;YACrB,OAAO,KAAK,YAAY;QAC1B;QAEA,sDAAsD;QACtD,IAAI,WAAW;QACf,MAAM,cAAc;QAEpB,MAAO,WAAW,YAAa;YAC7B,MAAM,UAAU,IAAI,CAAC,oBAAoB;YAEzC,IAAI;gBACF,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,WAAW,CAAC,SACZ,GAAG,CAAC;oBAAE,cAAc;oBAAS,WAAW,IAAI;gBAAO,GACnD,KAAK,CAAC,MAAM,KAAK,QACjB,KAAK,CAAC,gBAAgB,MAAM,MAAM,wDAAwD;iBAC1F,YAAY,GACZ,gBAAgB;gBAEnB,IAAI,SAAS;oBACX,OAAO;gBACT;gBAEA,6EAA6E;gBAC7E,MAAM,gBAAgB,MAAM,IAAI,CAAC,EAAE,CAChC,UAAU,CAAC,SACX,MAAM,CAAC,gBACP,KAAK,CAAC,MAAM,KAAK,QACjB,gBAAgB;gBAEnB,IAAI,eAAe,cAAc;oBAC/B,OAAO,cAAc,YAAY;gBACnC;YACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D;gBACA,IAAI,YAAY,aAAa;oBAC3B,QAAQ,KAAK,CAAC,CAAC,8CAA8C,EAAE,YAAY,SAAS,CAAC;oBACrF,MAAM;gBACR;YACF;QACF;QAEA,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,mBAAmB,IAAY,EAAwC;QAC3E,OAAO,oLAAS,CAAC,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,CAClC,UAAU,CAAC,SACX,KAAK,CAAC,gBAAgB,KAAK,KAAK,WAAW,IAC3C,SAAS,GACT,gBAAgB;IACrB;AACF"}},
    {"offset": {"line": 1816, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/schema.ts"],"sourcesContent":["import { z } from 'zod';\n\n// ============================================================================\n// Environment Detection (for smart defaults)\n// ============================================================================\nconst isDev = process.env.NODE_ENV === 'development';\nconst isProd = process.env.NODE_ENV === 'production';\n\n// ============================================================================\n// Context Configuration (migrated from context.config.ts)\n// ============================================================================\nexport const ContextConfigSchema = z.object({\n  messageHistoryLimit: z.number().int().positive().default(5),\n  includeSystemMessages: z.boolean().default(true),\n  maxContextTokens: z.number().int().positive().default(1000),\n  reserveTokensForResponse: z.number().int().positive().default(1500),\n  conversationGapMinutes: z.number().int().positive().default(30),\n  enableCaching: z.boolean().default(true),\n  // Longer cache in production\n  cacheTTLSeconds: z.number().int().nonnegative().default(isProd ? 600 : 300),\n});\n\n// ============================================================================\n// Chat Configuration\n// ============================================================================\nexport const ChatConfigSchema = z.object({\n  smsMaxLength: z.number().int().positive().default(1600),\n  contextMinutes: z.number().int().positive().default(10),\n});\n\n// ============================================================================\n// Messaging Configuration\n// ============================================================================\nexport const MessagingProviderSchema = z.enum(['twilio', 'local']);\n\nexport const MessagingConfigSchema = z.object({\n  // Use local provider in development, twilio in production\n  provider: MessagingProviderSchema.default(isDev ? 'local' : 'twilio'),\n});\n\n// ============================================================================\n// Feature Flags\n// ============================================================================\nexport const FeatureFlagsSchema = z.object({\n  // Enable agent logging in development by default\n  agentLogging: z.boolean().default(isDev),\n  enableConversationStorage: z.boolean().default(true),\n});\n\n// ============================================================================\n// Conversation Configuration\n// ============================================================================\nexport const ConversationConfigSchema = z.object({\n  timeoutMinutes: z.number().int().positive().default(30),\n  maxLength: z.number().int().positive().default(100),\n  inactiveThresholdDays: z.number().int().positive().default(7),\n});\n\n// ============================================================================\n// Short Links Configuration\n// ============================================================================\nexport const ShortLinksConfigSchema = z.object({\n  defaultExpiryDays: z.number().int().positive().default(7),\n  domain: z.string().optional(),\n});\n\n// ============================================================================\n// Stripe Configuration (non-secret)\n// ============================================================================\nexport const StripeConfigSchema = z.object({\n  priceId: z.string().min(1),\n});\n\n// ============================================================================\n// Admin Configuration\n// ============================================================================\nexport const AdminConfigSchema = z.object({\n  phoneNumbers: z.array(z.string()).default([]),\n  maxRequestsPerWindow: z.number().int().positive().default(3),\n  rateLimitWindowMinutes: z.number().int().positive().default(15),\n  codeExpiryMinutes: z.number().int().positive().default(10),\n  codeLength: z.number().int().positive().default(6),\n  devBypassCode: z.string().optional(),\n});\n\n// ============================================================================\n// Application URLs\n// ============================================================================\nexport const UrlsConfigSchema = z.object({\n  baseUrl: z.string().optional(),\n  publicBaseUrl: z.string().optional(),\n});\n\n// ============================================================================\n// Root Configuration Schema\n// ============================================================================\nexport const AppConfigSchema = z.object({\n  environment: z.enum(['development', 'staging', 'production']),\n  context: ContextConfigSchema,\n  chat: ChatConfigSchema,\n  messaging: MessagingConfigSchema,\n  features: FeatureFlagsSchema,\n  conversation: ConversationConfigSchema,\n  shortLinks: ShortLinksConfigSchema,\n  stripe: StripeConfigSchema,\n  admin: AdminConfigSchema,\n  urls: UrlsConfigSchema,\n});\n\n// Export types inferred from schemas\nexport type AppConfig = z.infer<typeof AppConfigSchema>;\nexport type ContextConfig = z.infer<typeof ContextConfigSchema>;\nexport type ChatConfig = z.infer<typeof ChatConfigSchema>;\nexport type MessagingConfig = z.infer<typeof MessagingConfigSchema>;\nexport type MessagingProvider = z.infer<typeof MessagingProviderSchema>;\nexport type FeatureFlags = z.infer<typeof FeatureFlagsSchema>;\nexport type ConversationConfig = z.infer<typeof ConversationConfigSchema>;\nexport type ShortLinksConfig = z.infer<typeof ShortLinksConfigSchema>;\nexport type StripeConfig = z.infer<typeof StripeConfigSchema>;\nexport type AdminConfig = z.infer<typeof AdminConfigSchema>;\nexport type UrlsConfig = z.infer<typeof UrlsConfigSchema>;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1919, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/loader.ts"],"sourcesContent":["import { AppConfigSchema, type AppConfig, type MessagingProvider } from './schema';\n\nexport type Environment = 'development' | 'staging' | 'production';\n\n/**\n * Determine current environment.\n * APP_ENV can override NODE_ENV (useful for staging which isn't a Node concept).\n */\nexport function getEnvironment(): Environment {\n  const appEnv = process.env.APP_ENV;\n  const nodeEnv = process.env.NODE_ENV;\n\n  if (appEnv === 'staging') return 'staging';\n  if (nodeEnv === 'production') return 'production';\n  return 'development';\n}\n\n/**\n * Parse comma-separated phone numbers from env var.\n */\nfunction parsePhoneNumbers(envValue: string | undefined): string[] {\n  if (!envValue) return [];\n  return envValue\n    .split(',')\n    .map((num) => num.trim())\n    .filter((num) => num.length > 0);\n}\n\n/**\n * Parse optional integer from env var.\n */\nfunction parseOptionalInt(value: string | undefined): number | undefined {\n  if (!value) return undefined;\n  const parsed = parseInt(value, 10);\n  return isNaN(parsed) ? undefined : parsed;\n}\n\n/**\n * Parse optional boolean from env var.\n * Treats 'true' as true, 'false' as false, undefined as undefined.\n */\nfunction parseOptionalBool(value: string | undefined): boolean | undefined {\n  if (value === undefined) return undefined;\n  return value === 'true';\n}\n\n/**\n * Load and validate configuration.\n * Builds config from env vars, letting Zod schemas handle defaults.\n * Throws on validation failure (fail-fast).\n */\nexport function loadConfig(): AppConfig {\n  const env = getEnvironment();\n\n  // Build raw config from env vars - undefined values let Zod defaults apply\n  const rawConfig = {\n    environment: env,\n    context: {\n      messageHistoryLimit: parseOptionalInt(process.env.CONTEXT_MESSAGE_HISTORY_LIMIT),\n      includeSystemMessages: parseOptionalBool(process.env.CONTEXT_INCLUDE_SYSTEM_MESSAGES),\n      maxContextTokens: parseOptionalInt(process.env.CONTEXT_MAX_TOKENS),\n      reserveTokensForResponse: parseOptionalInt(process.env.CONTEXT_RESERVE_TOKENS),\n      conversationGapMinutes: parseOptionalInt(process.env.CONTEXT_CONVERSATION_GAP_MINUTES),\n      enableCaching: parseOptionalBool(process.env.CONTEXT_ENABLE_CACHING),\n      cacheTTLSeconds: parseOptionalInt(process.env.CONTEXT_CACHE_TTL),\n    },\n    chat: {\n      smsMaxLength: parseOptionalInt(process.env.SMS_MAX_LENGTH),\n      contextMinutes: parseOptionalInt(process.env.CHAT_CONTEXT_MINUTES),\n    },\n    messaging: {\n      provider: process.env.MESSAGING_PROVIDER as MessagingProvider | undefined,\n    },\n    features: {\n      agentLogging: parseOptionalBool(process.env.AGENT_LOGGING),\n      enableConversationStorage: parseOptionalBool(process.env.ENABLE_CONVERSATION_STORAGE),\n    },\n    conversation: {\n      timeoutMinutes: parseOptionalInt(process.env.CONVERSATION_TIMEOUT_MINUTES),\n      maxLength: parseOptionalInt(process.env.MAX_CONVERSATION_LENGTH),\n      inactiveThresholdDays: parseOptionalInt(process.env.INACTIVE_THRESHOLD_DAYS),\n    },\n    shortLinks: {\n      defaultExpiryDays: parseOptionalInt(process.env.SHORT_LINK_DEFAULT_EXPIRY_DAYS),\n      domain: process.env.SHORT_LINK_DOMAIN,\n    },\n    stripe: {\n      priceId: process.env.STRIPE_PRICE_ID,\n    },\n    admin: {\n      phoneNumbers: process.env.ADMIN_PHONE_NUMBERS\n        ? parsePhoneNumbers(process.env.ADMIN_PHONE_NUMBERS)\n        : undefined,\n      devBypassCode: process.env.DEV_BYPASS_CODE,\n    },\n    urls: {\n      baseUrl: process.env.BASE_URL,\n      publicBaseUrl: process.env.NEXT_PUBLIC_BASE_URL,\n    },\n  };\n\n  // Validate with Zod - applies defaults and throws on failure\n  const result = AppConfigSchema.safeParse(rawConfig);\n\n  if (!result.success) {\n    const errors = result.error.errors\n      .map((e) => `  - ${e.path.join('.')}: ${e.message}`)\n      .join('\\n');\n\n    throw new Error(\n      `Configuration validation failed:\\n${errors}\\n\\n` +\n        `Environment: ${env}\\n` +\n        `Check your environment variables.`\n    );\n  }\n\n  return result.data;\n}\n\n// Singleton config instance\nlet _config: AppConfig | null = null;\n\n/**\n * Get the validated application config.\n * Caches the result for subsequent calls.\n */\nexport function getConfig(): AppConfig {\n  if (!_config) {\n    _config = loadConfig();\n  }\n  return _config;\n}\n\n/**\n * Reset config cache (useful for testing).\n */\nexport function resetConfig(): void {\n  _config = null;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2028, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/public.ts"],"sourcesContent":["/**\n * Public Configuration\n *\n * Safe for client-side usage. All NEXT_PUBLIC_* values are validated here.\n */\nimport { z } from 'zod';\n\n// =============================================================================\n// Public Environment Schema\n// =============================================================================\n\nconst PublicEnvSchema = z.object({\n  NEXT_PUBLIC_BASE_URL: z.string().optional(),\n  NEXT_PUBLIC_ANALYTICS_WRITE_KEY: z.string().optional(),\n  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().optional(),\n});\n\ntype PublicEnv = z.infer<typeof PublicEnvSchema>;\n\n// =============================================================================\n// Validation & Caching\n// =============================================================================\n\nlet _publicEnv: PublicEnv | null = null;\n\nfunction getPublicEnv(): PublicEnv {\n  if (!_publicEnv) {\n    const result = PublicEnvSchema.safeParse({\n      NEXT_PUBLIC_BASE_URL: process.env.NEXT_PUBLIC_BASE_URL,\n      NEXT_PUBLIC_ANALYTICS_WRITE_KEY: process.env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY,\n      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,\n    });\n\n    if (!result.success) {\n      console.warn('Public environment validation warnings:', result.error.errors);\n    }\n\n    _publicEnv = result.data ?? {};\n  }\n  return _publicEnv;\n}\n\n/**\n * Reset env cache (useful for testing).\n */\nexport function resetPublicEnv(): void {\n  _publicEnv = null;\n}\n\n// =============================================================================\n// URL Settings\n// =============================================================================\n\nexport function getPublicUrls() {\n  const env = getPublicEnv();\n  return {\n    baseUrl: env.NEXT_PUBLIC_BASE_URL,\n  };\n}\n\n// =============================================================================\n// Analytics Config\n// =============================================================================\n\nexport function getAnalyticsConfig() {\n  const env = getPublicEnv();\n  return {\n    writeKey: env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY,\n    isEnabled: Boolean(env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY),\n  };\n}\n\n// =============================================================================\n// Public Stripe Config\n// =============================================================================\n\nexport function getPublicStripeConfig() {\n  const env = getPublicEnv();\n  return {\n    publishableKey: env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,\n  };\n}\n\n// =============================================================================\n// Environment Detection (client-safe)\n// =============================================================================\n\n/**\n * Check if running in production environment.\n * Safe for use in client components.\n */\nexport function isProductionEnvironment(): boolean {\n  return process.env.NODE_ENV === 'production';\n}\n\n/**\n * Check if running in development environment.\n * Safe for use in client components.\n */\nexport function isDevelopmentEnvironment(): boolean {\n  return process.env.NODE_ENV === 'development';\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;AACD;AAAA;;AAEA,gFAAgF;AAChF,4BAA4B;AAC5B,gFAAgF;AAEhF,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IAC/B,sBAAsB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACzC,iCAAiC,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACpD,oCAAoC,0MAAC,CAAC,MAAM,GAAG,QAAQ;AACzD;AAIA,gFAAgF;AAChF,uBAAuB;AACvB,gFAAgF;AAEhF,IAAI,aAA+B;AAEnC,SAAS;IACP,IAAI,CAAC,YAAY;QACf,MAAM,SAAS,gBAAgB,SAAS,CAAC;YACvC,oBAAoB;YACpB,iCAAiC,QAAQ,GAAG,CAAC,+BAA+B;YAC5E,kCAAkC;QACpC;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACnB,QAAQ,IAAI,CAAC,2CAA2C,OAAO,KAAK,CAAC,MAAM;QAC7E;QAEA,aAAa,OAAO,IAAI,IAAI,CAAC;IAC/B;IACA,OAAO;AACT;AAKO,SAAS;IACd,aAAa;AACf;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,SAAS,IAAI,oBAAoB;IACnC;AACF;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,UAAU,IAAI,+BAA+B;QAC7C,WAAW,QAAQ,IAAI,+BAA+B;IACxD;AACF;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,gBAAgB,IAAI,kCAAkC;IACxD;AACF;AAUO,SAAS;IACd,OAAO,oDAAyB;AAClC;AAMO,SAAS;IACd,OAAO,oDAAyB;AAClC"}},
    {"offset": {"line": 2107, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/index.ts"],"sourcesContent":["/**\n * Application Configuration\n *\n * This module provides type-safe, validated configuration for the application.\n * Config values are loaded once at startup and cached.\n *\n * Usage:\n *   import { config } from '@/shared/config';\n *   console.log(config.chat.smsMaxLength);\n *\n * Or use section accessors:\n *   import { getChatConfig, getFeatureFlags } from '@/shared/config';\n *   const { smsMaxLength } = getChatConfig();\n */\n\nexport { getConfig, loadConfig, resetConfig, getEnvironment } from './loader';\nexport type { Environment } from './loader';\nexport * from './schema';\nexport * from './public';\n\nimport { getConfig } from './loader';\nimport type {\n  AppConfig,\n  ContextConfig,\n  ChatConfig,\n  MessagingConfig,\n  FeatureFlags,\n  ConversationConfig,\n  ShortLinksConfig,\n  StripeConfig,\n  AdminConfig,\n  UrlsConfig,\n} from './schema';\n\n// ============================================================================\n// Lazy config getter to avoid issues during build/module loading\n// ============================================================================\n\nlet _cachedConfig: AppConfig | null = null;\n\nfunction getCachedConfig(): AppConfig {\n  if (!_cachedConfig) {\n    _cachedConfig = getConfig();\n  }\n  return _cachedConfig;\n}\n\n/**\n * The validated application configuration.\n * Use this for direct property access: config.chat.smsMaxLength\n *\n * Note: This is a getter that lazily loads config on first access.\n */\nexport const config = new Proxy({} as AppConfig, {\n  get(_target, prop) {\n    return getCachedConfig()[prop as keyof AppConfig];\n  },\n});\n\n// ============================================================================\n// Convenience accessors for individual config sections\n// These match the existing getContextConfig() pattern\n// ============================================================================\n\nexport function getContextConfig(): ContextConfig {\n  return getConfig().context;\n}\n\nexport function getChatConfig(): ChatConfig {\n  return getConfig().chat;\n}\n\nexport function getMessagingConfig(): MessagingConfig {\n  return getConfig().messaging;\n}\n\nexport function getFeatureFlags(): FeatureFlags {\n  return getConfig().features;\n}\n\nexport function getConversationConfig(): ConversationConfig {\n  return getConfig().conversation;\n}\n\nexport function getShortLinksConfig(): ShortLinksConfig {\n  return getConfig().shortLinks;\n}\n\nexport function getStripeConfig(): StripeConfig {\n  return getConfig().stripe;\n}\n\nexport function getAdminConfig(): AdminConfig {\n  return getConfig().admin;\n}\n\nexport function getUrlsConfig(): UrlsConfig {\n  return getConfig().urls;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;CAaC;;;;;;;;;;;;;;;;;;;;;;AAED;AAEA;AACA;;;;;AAgBA,+EAA+E;AAC/E,iEAAiE;AACjE,+EAA+E;AAE/E,IAAI,gBAAkC;AAEtC,SAAS;IACP,IAAI,CAAC,eAAe;QAClB,gBAAgB,IAAA,sKAAS;IAC3B;IACA,OAAO;AACT;AAQO,MAAM,SAAS,IAAI,MAAM,CAAC,GAAgB;IAC/C,KAAI,OAAO,EAAE,IAAI;QACf,OAAO,iBAAiB,CAAC,KAAwB;IACnD;AACF;AAOO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,OAAO;AAC5B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,IAAI;AACzB;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,SAAS;AAC9B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,QAAQ;AAC7B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,YAAY;AACjC;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,UAAU;AAC/B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,MAAM;AAC3B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,KAAK;AAC1B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,IAAI;AACzB"}},
    {"offset": {"line": 2195, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/referral.ts"],"sourcesContent":["/**\n * Referral Model\n *\n * Represents a referral relationship between two users.\n * Tracks when a user signs up via another user's referral link\n * and whether the referrer has been credited.\n */\n\nimport { Selectable, Insertable, Updateable } from 'kysely';\nimport { Referrals } from './_types';\n\n/**\n * Type for selecting referrals from the database\n */\nexport type Referral = Selectable<Referrals>;\n\n/**\n * Type for inserting referrals into the database\n */\nexport type NewReferral = Insertable<Referrals>;\n\n/**\n * Type for updating referrals in the database\n */\nexport type ReferralUpdate = Updateable<Referrals>;\n\n/**\n * Stats about a user's referral activity\n */\nexport interface ReferralStats {\n  /** User's unique referral code */\n  referralCode: string;\n  /** Full referral link URL */\n  referralLink: string;\n  /** Number of completed referrals */\n  completedReferrals: number;\n  /** Number of credits earned (referrals where credit was applied) */\n  creditsEarned: number;\n  /** Number of credits remaining until max (12 - earned) */\n  creditsRemaining: number;\n}\n\n/**\n * Maximum number of referral credits a user can earn\n */\nexport const MAX_REFERRAL_CREDITS = 12;\n\n/**\n * Amount credited per referral in cents ($19.99)\n */\nexport const REFERRAL_CREDIT_AMOUNT_CENTS = 1999;\n"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;;;AAuCM,MAAM,uBAAuB;AAK7B,MAAM,+BAA+B"}},
    {"offset": {"line": 2213, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/referral/referralService.ts"],"sourcesContent":["import Stripe from 'stripe';\nimport { ReferralRepository } from '@/server/repositories/referralRepository';\nimport { UserRepository } from '@/server/repositories/userRepository';\nimport { getStripeSecrets } from '@/server/config';\nimport { getUrlsConfig } from '@/shared/config';\nimport {\n  ReferralStats,\n  MAX_REFERRAL_CREDITS,\n  REFERRAL_CREDIT_AMOUNT_CENTS,\n} from '@/server/models/referral';\n\nconst { secretKey } = getStripeSecrets();\nconst stripe = new Stripe(secretKey, {\n  apiVersion: '2023-10-16',\n});\n\n// Stripe coupon ID for referee's first month free\nconst REFERRAL_COUPON_ID = 'REFERRAL_FREE_MONTH';\n\nexport interface ValidateReferralResult {\n  valid: boolean;\n  referrerId?: string;\n  referrerName?: string;\n  error?: string;\n}\n\nexport interface CreditReferrerResult {\n  success: boolean;\n  creditId?: string;\n  error?: string;\n}\n\n/**\n * ReferralService\n *\n * Manages the referral program where users can share their referral code.\n * When someone signs up with a referral code:\n * - The referee (new user) gets their first month free via Stripe coupon\n * - The referrer gets a credit applied when the referee's payment succeeds\n *\n * Users can earn up to 12 free months via referrals.\n */\nexport class ReferralService {\n  private static instance: ReferralService;\n  private referralRepo: ReferralRepository;\n  private userRepo: UserRepository;\n\n  private constructor() {\n    this.referralRepo = new ReferralRepository();\n    this.userRepo = new UserRepository();\n  }\n\n  public static getInstance(): ReferralService {\n    if (!ReferralService.instance) {\n      ReferralService.instance = new ReferralService();\n    }\n    return ReferralService.instance;\n  }\n\n  /**\n   * Get or create a user's referral code\n   */\n  async getOrCreateReferralCode(userId: string): Promise<string | null> {\n    return this.userRepo.getOrCreateReferralCode(userId);\n  }\n\n  /**\n   * Get referral stats for displaying on the /me page\n   */\n  async getReferralStats(userId: string): Promise<ReferralStats | null> {\n    const referralCode = await this.userRepo.getOrCreateReferralCode(userId);\n    if (!referralCode) {\n      return null;\n    }\n\n    const { publicBaseUrl, baseUrl } = getUrlsConfig();\n    const resolvedBaseUrl = publicBaseUrl || baseUrl;\n    const referralLink = `${resolvedBaseUrl}/r/${referralCode}`;\n\n    const completedReferrals = await this.referralRepo.countByReferrer(userId);\n    const creditsEarned = await this.referralRepo.countCreditsEarned(userId);\n    const creditsRemaining = Math.max(0, MAX_REFERRAL_CREDITS - creditsEarned);\n\n    return {\n      referralCode,\n      referralLink,\n      completedReferrals,\n      creditsEarned,\n      creditsRemaining,\n    };\n  }\n\n  /**\n   * Validate a referral code before signup\n   * Checks that the code exists and prevents self-referral\n   */\n  async validateReferralCode(\n    code: string,\n    signupPhone?: string\n  ): Promise<ValidateReferralResult> {\n    if (!code || code.length !== 6) {\n      return { valid: false, error: 'Invalid referral code format' };\n    }\n\n    const referrer = await this.userRepo.findByReferralCode(code.toUpperCase());\n    if (!referrer) {\n      return { valid: false, error: 'Referral code not found' };\n    }\n\n    // Prevent self-referral\n    if (signupPhone && referrer.phoneNumber === signupPhone) {\n      return { valid: false, error: 'Cannot use your own referral code' };\n    }\n\n    return {\n      valid: true,\n      referrerId: referrer.id,\n      referrerName: referrer.name,\n    };\n  }\n\n  /**\n   * Complete a referral when a referee signs up\n   * Creates the referral record in the database\n   */\n  async completeReferral(\n    referralCode: string,\n    refereeUserId: string\n  ): Promise<void> {\n    const referrer = await this.userRepo.findByReferralCode(\n      referralCode.toUpperCase()\n    );\n    if (!referrer) {\n      console.error(\n        `[ReferralService] Cannot complete referral: code ${referralCode} not found`\n      );\n      return;\n    }\n\n    // Check if referee has already been referred\n    const alreadyReferred = await this.referralRepo.hasBeenReferred(refereeUserId);\n    if (alreadyReferred) {\n      console.log(\n        `[ReferralService] User ${refereeUserId} has already been referred, skipping`\n      );\n      return;\n    }\n\n    await this.referralRepo.create(referrer.id, refereeUserId);\n    console.log(\n      `[ReferralService] Referral completed: ${referrer.id} -> ${refereeUserId}`\n    );\n  }\n\n  /**\n   * Apply credit to the referrer's Stripe account\n   * Called by webhook when referee's payment succeeds\n   */\n  async creditReferrer(refereeUserId: string): Promise<CreditReferrerResult> {\n    // Find the referral for this referee\n    const referral = await this.referralRepo.findByRefereeId(refereeUserId);\n    if (!referral) {\n      console.log(\n        `[ReferralService] No referral found for referee ${refereeUserId}`\n      );\n      return { success: true }; // Not an error, just no referral\n    }\n\n    // Check if credit already applied\n    if (referral.creditApplied) {\n      console.log(\n        `[ReferralService] Credit already applied for referral ${referral.id}`\n      );\n      return { success: true };\n    }\n\n    // Check if referrer can still earn credits\n    const creditsEarned = await this.referralRepo.countCreditsEarned(\n      referral.referrerId\n    );\n    if (creditsEarned >= MAX_REFERRAL_CREDITS) {\n      console.log(\n        `[ReferralService] Referrer ${referral.referrerId} has reached max credits (${MAX_REFERRAL_CREDITS})`\n      );\n      // Still mark the referral, but don't apply credit\n      return { success: true };\n    }\n\n    // Get referrer's Stripe customer ID\n    const referrer = await this.userRepo.findById(referral.referrerId);\n    if (!referrer?.stripeCustomerId) {\n      console.error(\n        `[ReferralService] Referrer ${referral.referrerId} has no Stripe customer ID`\n      );\n      return { success: false, error: 'Referrer has no Stripe customer' };\n    }\n\n    try {\n      // Create invoice credit in Stripe\n      const credit = await stripe.customers.createBalanceTransaction(\n        referrer.stripeCustomerId,\n        {\n          amount: -REFERRAL_CREDIT_AMOUNT_CENTS, // Negative = credit\n          currency: 'usd',\n          description: 'Referral credit - 1 free month',\n        }\n      );\n\n      // Mark referral as credited\n      await this.referralRepo.markCreditApplied(\n        referral.id,\n        REFERRAL_CREDIT_AMOUNT_CENTS\n      );\n\n      console.log(\n        `[ReferralService] Applied $${(REFERRAL_CREDIT_AMOUNT_CENTS / 100).toFixed(2)} credit to referrer ${referrer.id}`\n      );\n\n      return { success: true, creditId: credit.id };\n    } catch (error) {\n      console.error('[ReferralService] Failed to apply credit:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Get or create the Stripe coupon for referee's first month free\n   */\n  async getRefereeCouponId(): Promise<string> {\n    try {\n      // Try to retrieve existing coupon\n      await stripe.coupons.retrieve(REFERRAL_COUPON_ID);\n      return REFERRAL_COUPON_ID;\n    } catch {\n      // Create if doesn't exist\n      await stripe.coupons.create({\n        id: REFERRAL_COUPON_ID,\n        amount_off: REFERRAL_CREDIT_AMOUNT_CENTS,\n        currency: 'usd',\n        duration: 'once',\n        name: 'Referral - First Month Free',\n      });\n      console.log('[ReferralService] Created referral coupon in Stripe');\n      return REFERRAL_COUPON_ID;\n    }\n  }\n\n  /**\n   * Check if a user can still earn referral credits\n   */\n  async canEarnCredits(userId: string): Promise<boolean> {\n    const creditsEarned = await this.referralRepo.countCreditsEarned(userId);\n    return creditsEarned < MAX_REFERRAL_CREDITS;\n  }\n}\n\nexport const referralService = ReferralService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2417, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/sessionCrypto.ts"],"sourcesContent":["import crypto from 'crypto';\nimport { getDatabaseSecrets } from '@/server/config';\n\n/**\n * Session crypto utilities for encrypting and decrypting user IDs in session cookies\n * Uses AES-256-GCM for authenticated encryption\n */\n\nconst ALGORITHM = 'aes-256-gcm';\nconst IV_LENGTH = 16; // For GCM mode\nconst AUTH_TAG_LENGTH = 16;\nconst KEY_LENGTH = 32; // 256 bits\n\n/**\n * Get the encryption key from config\n * In production, this should be a strong random key stored securely\n */\nfunction getEncryptionKey(): Buffer {\n  const { sessionEncryptionKey } = getDatabaseSecrets();\n\n  if (!sessionEncryptionKey) {\n    // For development, use a default key (NOT for production!)\n    console.warn('SESSION_ENCRYPTION_KEY not set, using development key');\n    return crypto.scryptSync('gymtext-dev-key', 'salt', KEY_LENGTH);\n  }\n\n  // If key is hex-encoded, decode it\n  if (sessionEncryptionKey.length === KEY_LENGTH * 2) {\n    return Buffer.from(sessionEncryptionKey, 'hex');\n  }\n\n  // Otherwise, derive key from string\n  return crypto.scryptSync(sessionEncryptionKey, 'salt', KEY_LENGTH);\n}\n\n/**\n * Encrypt a user ID for use in a session cookie\n * Returns a base64-encoded string containing IV + authTag + encrypted data\n */\nexport function encryptUserId(userId: string): string {\n  try {\n    const key = getEncryptionKey();\n    const iv = crypto.randomBytes(IV_LENGTH);\n\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n\n    let encrypted = cipher.update(userId, 'utf8', 'hex');\n    encrypted += cipher.final('hex');\n\n    const authTag = cipher.getAuthTag();\n\n    // Combine IV + authTag + encrypted data\n    const combined = Buffer.concat([\n      iv,\n      authTag,\n      Buffer.from(encrypted, 'hex')\n    ]);\n\n    return combined.toString('base64');\n  } catch (error) {\n    console.error('Error encrypting user ID:', error);\n    throw new Error('Failed to encrypt session');\n  }\n}\n\n/**\n * Decrypt a user ID from a session cookie\n * Returns the user ID or null if decryption fails\n */\nexport function decryptUserId(encryptedData: string): string | null {\n  try {\n    const key = getEncryptionKey();\n    const combined = Buffer.from(encryptedData, 'base64');\n\n    // Extract IV, authTag, and encrypted data\n    const iv = combined.subarray(0, IV_LENGTH);\n    const authTag = combined.subarray(IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH);\n    const encrypted = combined.subarray(IV_LENGTH + AUTH_TAG_LENGTH);\n\n    const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n    decipher.setAuthTag(authTag);\n\n    let decrypted = decipher.update(encrypted.toString('hex'), 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n\n    return decrypted;\n  } catch (error) {\n    console.error('Error decrypting user ID:', error);\n    return null;\n  }\n}\n\n/**\n * Generate a secure random encryption key for SESSION_ENCRYPTION_KEY\n * This is a utility function for generating a new key - run once and store securely\n */\nexport function generateEncryptionKey(): string {\n  return crypto.randomBytes(KEY_LENGTH).toString('hex');\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAAA;;;AAEA;;;CAGC,GAED,MAAM,YAAY;AAClB,MAAM,YAAY,IAAI,eAAe;AACrC,MAAM,kBAAkB;AACxB,MAAM,aAAa,IAAI,WAAW;AAElC;;;CAGC,GACD,SAAS;IACP,MAAM,EAAE,oBAAoB,EAAE,GAAG,IAAA,gLAAkB;IAEnD,IAAI,CAAC,sBAAsB;QACzB,2DAA2D;QAC3D,QAAQ,IAAI,CAAC;QACb,OAAO,gHAAM,CAAC,UAAU,CAAC,mBAAmB,QAAQ;IACtD;IAEA,mCAAmC;IACnC,IAAI,qBAAqB,MAAM,KAAK,aAAa,GAAG;QAClD,OAAO,OAAO,IAAI,CAAC,sBAAsB;IAC3C;IAEA,oCAAoC;IACpC,OAAO,gHAAM,CAAC,UAAU,CAAC,sBAAsB,QAAQ;AACzD;AAMO,SAAS,cAAc,MAAc;IAC1C,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;QAE9B,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,WAAW,KAAK;QAErD,IAAI,YAAY,OAAO,MAAM,CAAC,QAAQ,QAAQ;QAC9C,aAAa,OAAO,KAAK,CAAC;QAE1B,MAAM,UAAU,OAAO,UAAU;QAEjC,wCAAwC;QACxC,MAAM,WAAW,OAAO,MAAM,CAAC;YAC7B;YACA;YACA,OAAO,IAAI,CAAC,WAAW;SACxB;QAED,OAAO,SAAS,QAAQ,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,MAAM,IAAI,MAAM;IAClB;AACF;AAMO,SAAS,cAAc,aAAqB;IACjD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,WAAW,OAAO,IAAI,CAAC,eAAe;QAE5C,0CAA0C;QAC1C,MAAM,KAAK,SAAS,QAAQ,CAAC,GAAG;QAChC,MAAM,UAAU,SAAS,QAAQ,CAAC,WAAW,YAAY;QACzD,MAAM,YAAY,SAAS,QAAQ,CAAC,YAAY;QAEhD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,WAAW,KAAK;QACzD,SAAS,UAAU,CAAC;QAEpB,IAAI,YAAY,SAAS,MAAM,CAAC,UAAU,QAAQ,CAAC,QAAQ,OAAO;QAClE,aAAa,SAAS,KAAK,CAAC;QAE5B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;IACT;AACF;AAMO,SAAS;IACd,OAAO,gHAAM,CAAC,WAAW,CAAC,YAAY,QAAQ,CAAC;AACjD"}},
    {"offset": {"line": 2499, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/authMiddleware.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport { decryptUserId } from './sessionCrypto';\n\n/**\n * Authorization result from checking request credentials\n */\nexport interface AuthResult {\n  isAuthorized: boolean;\n  isAdmin: boolean;\n  userId: string | null;\n  error?: string;\n}\n\n/**\n * Check if a request is authorized to access a specific user's data\n *\n * Authorization rules:\n * - Admin (gt_admin cookie) can access any user\n * - Regular user (gt_user_session cookie) can only access their own data\n *\n * @param request - The Next.js request object\n * @param requestedUserId - The user ID being requested\n * @returns AuthResult with authorization status\n */\nexport function checkAuthorization(\n  request: NextRequest,\n  requestedUserId: string\n): AuthResult {\n  // Check if user is admin\n  const isAdmin = request.cookies.get('gt_admin')?.value === 'ok';\n\n  if (isAdmin) {\n    return {\n      isAuthorized: true,\n      isAdmin: true,\n      userId: null, // Admin doesn't have a specific user ID\n    };\n  }\n\n  // Check if user has a valid session\n  const userSession = request.cookies.get('gt_user_session')?.value;\n\n  if (!userSession) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: null,\n      error: 'No authentication credentials provided',\n    };\n  }\n\n  // Decrypt the user ID from session\n  const authenticatedUserId = decryptUserId(userSession);\n\n  if (!authenticatedUserId) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: null,\n      error: 'Invalid session token',\n    };\n  }\n\n  // Check if the authenticated user matches the requested user\n  if (authenticatedUserId !== requestedUserId) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: authenticatedUserId,\n      error: 'Unauthorized to access this user data',\n    };\n  }\n\n  return {\n    isAuthorized: true,\n    isAdmin: false,\n    userId: authenticatedUserId,\n  };\n}\n\n/**\n * Get the authenticated user ID from the session cookie\n * Returns null if not authenticated\n */\nexport function getAuthenticatedUserId(request: NextRequest): string | null {\n  const userSession = request.cookies.get('gt_user_session')?.value;\n\n  if (!userSession) {\n    return null;\n  }\n\n  return decryptUserId(userSession);\n}\n\n/**\n * Check if the request has admin authentication\n * Returns true if gt_admin cookie is set to 'ok'\n */\nexport function isAdminAuthenticated(request: NextRequest): boolean {\n  const adminCookie = request.cookies.get('gt_admin')?.value;\n  return adminCookie === 'ok';\n}\n"],"names":[],"mappings":";;;;;;;;AACA;;AAuBO,SAAS,mBACd,OAAoB,EACpB,eAAuB;IAEvB,yBAAyB;IACzB,MAAM,UAAU,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa,UAAU;IAE3D,IAAI,SAAS;QACX,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;QACV;IACF;IAEA,oCAAoC;IACpC,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;IAE5D,IAAI,CAAC,aAAa;QAChB,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,mCAAmC;IACnC,MAAM,sBAAsB,IAAA,gLAAa,EAAC;IAE1C,IAAI,CAAC,qBAAqB;QACxB,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,6DAA6D;IAC7D,IAAI,wBAAwB,iBAAiB;QAC3C,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,OAAO;QACL,cAAc;QACd,SAAS;QACT,QAAQ;IACV;AACF;AAMO,SAAS,uBAAuB,OAAoB;IACzD,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;IAE5D,IAAI,CAAC,aAAa;QAChB,OAAO;IACT;IAEA,OAAO,IAAA,gLAAa,EAAC;AACvB;AAMO,SAAS,qBAAqB,OAAoB;IACvD,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;IACrD,OAAO,gBAAgB;AACzB"}},
    {"offset": {"line": 2569, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/apps/web/src/app/api/users/%5Bid%5D/referral/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { referralService } from '@/server/services/referral/referralService';\nimport { checkAuthorization } from '@/server/utils/authMiddleware';\n\n/**\n * GET /api/users/[id]/referral\n *\n * Get referral stats for a user\n * Returns their referral code, link, and credit stats\n *\n * Response:\n * {\n *   referralCode: string,\n *   referralLink: string,\n *   completedReferrals: number,\n *   creditsEarned: number,\n *   creditsRemaining: number\n * }\n */\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: userId } = await params;\n\n    // Check authorization\n    const auth = checkAuthorization(request, userId);\n    if (!auth.isAuthorized) {\n      return NextResponse.json(\n        { success: false, message: auth.error || 'Unauthorized' },\n        { status: 403 }\n      );\n    }\n\n    const stats = await referralService.getReferralStats(userId);\n    if (!stats) {\n      return NextResponse.json(\n        { success: false, message: 'User not found' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: stats,\n    });\n  } catch (error) {\n    console.error('Error fetching referral stats:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        message: 'Internal server error',\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAiBO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,IAAI,MAAM,EAAE,GAAG,MAAM;QAE7B,sBAAsB;QACtB,MAAM,OAAO,IAAA,sLAAkB,EAAC,SAAS;QACzC,IAAI,CAAC,KAAK,YAAY,EAAE;YACtB,OAAO,uTAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS,KAAK,KAAK,IAAI;YAAe,GACxD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,MAAM,mMAAe,CAAC,gBAAgB,CAAC;QACrD,IAAI,CAAC,OAAO;YACV,OAAO,uTAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAiB,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,uTAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,uTAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,SAAS;QACX,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}