{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/env.ts"],"sourcesContent":["/**\n * Server Environment Variables\n *\n * THE ONLY place in the codebase that validates server-side secrets.\n * App config overrides are handled by shared/config.\n */\nimport { z } from 'zod';\n\n// =============================================================================\n// Zod Schema - Server Secrets Only\n// =============================================================================\n\nconst ServerEnvSchema = z.object({\n  // -------------------------------------------------------------------------\n  // Database\n  // -------------------------------------------------------------------------\n  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),\n  SESSION_ENCRYPTION_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Twilio\n  // -------------------------------------------------------------------------\n  TWILIO_ACCOUNT_SID: z.string().min(1, 'TWILIO_ACCOUNT_SID is required'),\n  TWILIO_AUTH_TOKEN: z.string().min(1, 'TWILIO_AUTH_TOKEN is required'),\n  TWILIO_NUMBER: z.string().min(1, 'TWILIO_NUMBER is required'),\n\n  // -------------------------------------------------------------------------\n  // Stripe\n  // -------------------------------------------------------------------------\n  STRIPE_SECRET_KEY: z.string().min(1, 'STRIPE_SECRET_KEY is required'),\n  STRIPE_WEBHOOK_SECRET: z.string().optional(), // Optional for development\n\n  // -------------------------------------------------------------------------\n  // AI - validated but LangChain reads these directly from process.env\n  // -------------------------------------------------------------------------\n  OPENAI_API_KEY: z.string().min(1, 'OPENAI_API_KEY is required'),\n  GOOGLE_API_KEY: z.string().min(1, 'GOOGLE_API_KEY is required'),\n  XAI_API_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Pinecone\n  // -------------------------------------------------------------------------\n  PINECONE_API_KEY: z.string().min(1, 'PINECONE_API_KEY is required'),\n  PINECONE_INDEX: z.string().min(1, 'PINECONE_INDEX is required'),\n\n  // -------------------------------------------------------------------------\n  // Background Jobs\n  // -------------------------------------------------------------------------\n  CRON_SECRET: z.string().optional(),\n  INNGEST_EVENT_KEY: z.string().optional(),\n  INNGEST_SIGNING_KEY: z.string().optional(),\n\n  // -------------------------------------------------------------------------\n  // Environment (for server-side env detection)\n  // -------------------------------------------------------------------------\n  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),\n  APP_ENV: z.enum(['development', 'staging', 'production']).optional(),\n});\n\n// =============================================================================\n// Validation\n// =============================================================================\n\nfunction validateServerEnv() {\n  const result = ServerEnvSchema.safeParse(process.env);\n\n  if (!result.success) {\n    const errors = result.error.errors\n      .map((e) => `  - ${e.path.join('.')}: ${e.message}`)\n      .join('\\n');\n\n    throw new Error(\n      `Server environment validation failed:\\n${errors}\\n\\n` +\n        `Ensure all required environment variables are set.`\n    );\n  }\n\n  return result.data;\n}\n\n// Singleton - validated once at startup\nlet _serverEnv: z.infer<typeof ServerEnvSchema> | null = null;\n\n/**\n * Get validated server environment variables.\n * Caches the result for subsequent calls.\n */\nexport function getServerEnv() {\n  if (!_serverEnv) {\n    _serverEnv = validateServerEnv();\n  }\n  return _serverEnv;\n}\n\n/**\n * Reset env cache (useful for testing).\n */\nexport function resetServerEnv() {\n  _serverEnv = null;\n}\n\n// Export type\nexport type ServerEnv = z.infer<typeof ServerEnvSchema>;\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AACD;AAAA;;AAEA,gFAAgF;AAChF,mCAAmC;AACnC,gFAAgF;AAEhF,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IAC/B,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,cAAc,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAChC,wBAAwB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE3C,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,oBAAoB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACtC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,eAAe,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAEjC,4EAA4E;IAC5E,SAAS;IACT,4EAA4E;IAC5E,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACrC,uBAAuB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAE1C,4EAA4E;IAC5E,qEAAqE;IACrE,4EAA4E;IAC5E,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAClC,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAEhC,4EAA4E;IAC5E,WAAW;IACX,4EAA4E;IAC5E,kBAAkB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IACpC,gBAAgB,0MAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG;IAElC,4EAA4E;IAC5E,kBAAkB;IAClB,4EAA4E;IAC5E,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAChC,mBAAmB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACtC,qBAAqB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAExC,4EAA4E;IAC5E,8CAA8C;IAC9C,4EAA4E;IAC5E,UAAU,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAQ;KAAa,EAAE,OAAO,CAAC;IAChE,SAAS,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAe;QAAW;KAAa,EAAE,QAAQ;AACpE;AAEA,gFAAgF;AAChF,aAAa;AACb,gFAAgF;AAEhF,SAAS;IACP,MAAM,SAAS,gBAAgB,SAAS,CAAC,QAAQ,GAAG;IAEpD,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,SAAS,OAAO,KAAK,CAAC,MAAM,CAC/B,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,EAAE,OAAO,EAAE,EAClD,IAAI,CAAC;QAER,MAAM,IAAI,MACR,CAAC,uCAAuC,EAAE,OAAO,IAAI,CAAC,GACpD,CAAC,kDAAkD,CAAC;IAE1D;IAEA,OAAO,OAAO,IAAI;AACpB;AAEA,wCAAwC;AACxC,IAAI,aAAqD;AAMlD,SAAS;IACd,IAAI,CAAC,YAAY;QACf,aAAa;IACf;IACA,OAAO;AACT;AAKO,SAAS;IACd,aAAa;AACf"}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/secrets.ts"],"sourcesContent":["/**\n * Server Secrets\n *\n * Grouped accessors for secret environment variables.\n * All secrets are validated at import time via getServerEnv().\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Database Secrets\n// =============================================================================\n\nexport function getDatabaseSecrets() {\n  const env = getServerEnv();\n  return {\n    databaseUrl: env.DATABASE_URL,\n    sessionEncryptionKey: env.SESSION_ENCRYPTION_KEY,\n  };\n}\n\n// =============================================================================\n// Twilio Secrets\n// =============================================================================\n\nexport function getTwilioSecrets() {\n  const env = getServerEnv();\n  return {\n    accountSid: env.TWILIO_ACCOUNT_SID,\n    authToken: env.TWILIO_AUTH_TOKEN,\n    phoneNumber: env.TWILIO_NUMBER,\n  };\n}\n\n// =============================================================================\n// Stripe Secrets\n// =============================================================================\n\nexport function getStripeSecrets() {\n  const env = getServerEnv();\n  return {\n    secretKey: env.STRIPE_SECRET_KEY,\n    // webhookSecret may be undefined in development, but required for webhook route\n    webhookSecret: env.STRIPE_WEBHOOK_SECRET!,\n  };\n}\n\n// =============================================================================\n// AI Secrets\n// Note: LangChain auto-reads OPENAI_API_KEY and GOOGLE_API_KEY from process.env.\n// We expose them here for cases where direct access is needed (e.g., GoogleGenAI SDK).\n// =============================================================================\n\nexport function getAiSecrets() {\n  const env = getServerEnv();\n  return {\n    openaiApiKey: env.OPENAI_API_KEY,\n    googleApiKey: env.GOOGLE_API_KEY,\n    xaiApiKey: env.XAI_API_KEY,\n  };\n}\n\n// =============================================================================\n// Pinecone Secrets\n// =============================================================================\n\nexport function getPineconeSecrets() {\n  const env = getServerEnv();\n  return {\n    apiKey: env.PINECONE_API_KEY,\n    indexName: env.PINECONE_INDEX,\n  };\n}\n\n// =============================================================================\n// Background Job Secrets\n// =============================================================================\n\nexport function getCronSecrets() {\n  const env = getServerEnv();\n  return {\n    cronSecret: env.CRON_SECRET,\n    inngestEventKey: env.INNGEST_EVENT_KEY,\n    inngestSigningKey: env.INNGEST_SIGNING_KEY,\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,aAAa,IAAI,YAAY;QAC7B,sBAAsB,IAAI,sBAAsB;IAClD;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,kBAAkB;QAClC,WAAW,IAAI,iBAAiB;QAChC,aAAa,IAAI,aAAa;IAChC;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,WAAW,IAAI,iBAAiB;QAChC,gFAAgF;QAChF,eAAe,IAAI,qBAAqB;IAC1C;AACF;AAQO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,cAAc,IAAI,cAAc;QAChC,cAAc,IAAI,cAAc;QAChC,WAAW,IAAI,WAAW;IAC5B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,QAAQ,IAAI,gBAAgB;QAC5B,WAAW,IAAI,cAAc;IAC/B;AACF;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,YAAY,IAAI,WAAW;QAC3B,iBAAiB,IAAI,iBAAiB;QACtC,mBAAmB,IAAI,mBAAmB;IAC5C;AACF"}},
    {"offset": {"line": 202, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/settings.ts"],"sourcesContent":["/**\n * Server Settings\n *\n * Non-secret server-only settings.\n * For app config (admin, urls, etc.), use shared/config instead.\n */\nimport { getServerEnv } from './env';\n\n// =============================================================================\n// Environment Detection\n// =============================================================================\n\nexport function getEnvironmentSettings() {\n  const env = getServerEnv();\n  return {\n    nodeEnv: env.NODE_ENV,\n    appEnv: env.APP_ENV,\n    isDevelopment: env.NODE_ENV === 'development',\n    isProduction: env.NODE_ENV === 'production',\n    isTest: env.NODE_ENV === 'test',\n  };\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACD;;AAMO,SAAS;IACd,MAAM,MAAM,IAAA,sKAAY;IACxB,OAAO;QACL,SAAS,IAAI,QAAQ;QACrB,QAAQ,IAAI,OAAO;QACnB,eAAe,IAAI,QAAQ,KAAK;QAChC,cAAc,IAAI,QAAQ,KAAK;QAC/B,QAAQ,IAAI,QAAQ,KAAK;IAC3B;AACF"}},
    {"offset": {"line": 227, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/config/index.ts"],"sourcesContent":["/**\n * Server Configuration\n *\n * This module protects server-only config from client bundles.\n * Any attempt to import this from client code will fail at build time.\n */\nimport 'server-only';\n\n// Re-export everything\nexport * from './env';\nexport * from './secrets';\nexport * from './settings';\n"],"names":[],"mappings":"AAAA;;;;;CAKC;AACD;AAEA,uBAAuB;AACvB;AACA;AACA"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/factory.ts"],"sourcesContent":["/**\n * Database Connection Factory\n *\n * Creates Kysely database instances on-demand. Supports multiple\n * connection strings for environment switching (sandbox/production).\n *\n * Uses internal caching to reuse pools for the same connection string.\n */\nimport { Kysely, PostgresDialect, CamelCasePlugin } from 'kysely';\nimport { Pool } from 'pg';\nimport type { DB } from '@/server/models/_types';\n\n// Cache pools by connection string to avoid creating new pools for same env\nconst poolCache = new Map<string, Pool>();\nconst dbCache = new Map<string, Kysely<DB>>();\n\n/**\n * Create or retrieve a cached database connection\n * @param connectionString - PostgreSQL connection string\n * @returns Kysely database instance\n */\nexport function createDatabase(connectionString: string): Kysely<DB> {\n  // Return cached instance if available\n  if (dbCache.has(connectionString)) {\n    return dbCache.get(connectionString)!;\n  }\n\n  // Create or get cached pool\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10, // Maximum number of clients in the pool\n    });\n    poolCache.set(connectionString, pool);\n  }\n\n  // Create Kysely instance\n  const db = new Kysely<DB>({\n    dialect: new PostgresDialect({ pool }),\n    plugins: [new CamelCasePlugin()],\n  });\n\n  dbCache.set(connectionString, db);\n  return db;\n}\n\n/**\n * Get the pool for a connection string (for direct pool access if needed)\n * @param connectionString - PostgreSQL connection string\n * @returns Pool instance\n */\nexport function getPool(connectionString: string): Pool {\n  let pool = poolCache.get(connectionString);\n  if (!pool) {\n    pool = new Pool({\n      connectionString,\n      max: 10,\n    });\n    poolCache.set(connectionString, pool);\n  }\n  return pool;\n}\n\n/**\n * Close all cached pools (for graceful shutdown)\n */\nexport async function closeAllPools(): Promise<void> {\n  const pools = Array.from(poolCache.values());\n  await Promise.all(pools.map(pool => pool.end()));\n  poolCache.clear();\n  dbCache.clear();\n}\n\n/**\n * Get all active pool connection strings (for debugging)\n */\nexport function getActiveConnections(): string[] {\n  return Array.from(poolCache.keys());\n}\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;;;AACD;AAAA;AAAA;AACA;;;AAGA,4EAA4E;AAC5E,MAAM,YAAY,IAAI;AACtB,MAAM,UAAU,IAAI;AAOb,SAAS,eAAe,gBAAwB;IACrD,sCAAsC;IACtC,IAAI,QAAQ,GAAG,CAAC,mBAAmB;QACjC,OAAO,QAAQ,GAAG,CAAC;IACrB;IAEA,4BAA4B;IAC5B,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IAEA,yBAAyB;IACzB,MAAM,KAAK,IAAI,+MAAM,CAAK;QACxB,SAAS,IAAI,4PAAe,CAAC;YAAE;QAAK;QACpC,SAAS;YAAC,IAAI,oQAAe;SAAG;IAClC;IAEA,QAAQ,GAAG,CAAC,kBAAkB;IAC9B,OAAO;AACT;AAOO,SAAS,QAAQ,gBAAwB;IAC9C,IAAI,OAAO,UAAU,GAAG,CAAC;IACzB,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd;YACA,KAAK;QACP;QACA,UAAU,GAAG,CAAC,kBAAkB;IAClC;IACA,OAAO;AACT;AAKO,eAAe;IACpB,MAAM,QAAQ,MAAM,IAAI,CAAC,UAAU,MAAM;IACzC,MAAM,QAAQ,GAAG,CAAC,MAAM,GAAG,CAAC,CAAA,OAAQ,KAAK,GAAG;IAC5C,UAAU,KAAK;IACf,QAAQ,KAAK;AACf;AAKO,SAAS;IACd,OAAO,MAAM,IAAI,CAAC,UAAU,IAAI;AAClC"}},
    {"offset": {"line": 328, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/postgres/postgres.ts"],"sourcesContent":["/**\n * PostgreSQL Connection\n *\n * This module provides the default database connection using the\n * DATABASE_URL environment variable. For environment switching\n * (sandbox/production), use the factory functions instead.\n */\nimport { getDatabaseSecrets } from '@/server/config';\nimport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';\n\n// Get the database URL from validated server config\nconst { databaseUrl } = getDatabaseSecrets();\n\n// Create default database instance using factory\nexport const postgresDb = createDatabase(databaseUrl);\n\n// Export default pool for direct access if needed\nexport const pool = getPool(databaseUrl);\n\n// Re-export factory functions for environment switching\nexport { createDatabase, getPool, closeAllPools, getActiveConnections } from './factory';"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;;;AACD;AAAA;AACA;;;AAEA,oDAAoD;AACpD,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,gLAAkB;AAGnC,MAAM,aAAa,IAAA,6LAAc,EAAC;AAGlC,MAAM,OAAO,IAAA,sLAAO,EAAC"}},
    {"offset": {"line": 354, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/baseRepository.ts"],"sourcesContent":["import { Kysely } from 'kysely';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { DB } from '../models/_types';\n\n/**\n * Base Repository\n *\n * Provides database access for all repositories.\n *\n * Supports two patterns:\n * 1. Default singleton (backward compatible): new UserRepository()\n * 2. Explicit db injection (for context switching): new UserRepository(ctx.db)\n *\n * For the admin app with environment switching, always pass ctx.db explicitly.\n */\nexport abstract class BaseRepository {\n  protected db: Kysely<DB>;\n\n  /**\n   * Create a repository instance\n   * @param db - Optional database instance. If not provided, uses the default singleton.\n   */\n  constructor(db: Kysely<DB> = postgresDb) {\n    this.db = db;\n  }\n}\n\n/**\n * Type for the database instance (for type exports)\n */\nexport type DatabaseInstance = Kysely<DB>;"],"names":[],"mappings":";;;;AACA;;AAcO,MAAe;IACV,GAAe;IAEzB;;;GAGC,GACD,YAAY,KAAiB,0MAAU,CAAE;QACvC,IAAI,CAAC,EAAE,GAAG;IACZ;AACF"}},
    {"offset": {"line": 373, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/plan/schema.ts"],"sourcesContent":["import { z } from \"zod\";\n\n// ============================================================================\n// Plan Structure Schemas (for structured plan representation)\n// ============================================================================\n\n/**\n * Schedule template for weekly rhythm\n */\nexport const PlanScheduleTemplateSchema = z.array(\n  z.object({\n    day: z.string(), // e.g. \"Monday\"\n    focus: z.string().default(''),\n    rationale: z.string().default('')\n  })\n).describe(\"The ideal/default weekly rhythm\");\n\n/**\n * Complete plan structure (program blueprint)\n */\nexport const PlanStructureSchema = z.object({\n  name: z.string().describe(\"e.g. 'Strength + Lean Build Phase'\"),\n  type: z.string().describe(\"e.g. 'Powerbuilding'\").default(''),\n\n  // Core Strategy\n  coreStrategy: z.string().default(''),\n\n  // How You Progress\n  progressionStrategy: z.array(z.string()).default([]),\n\n  // When We Adjust\n  adjustmentStrategy: z.string().default(''),\n\n  // Conditioning Guidelines\n  conditioning: z.array(z.string()).default([]),\n\n  // Schedule\n  scheduleTemplate: PlanScheduleTemplateSchema.default([]),\n\n  // Metadata\n  durationWeeks: z.number().default(-1),\n  frequencyPerWeek: z.number().default(-1)\n});\n\nexport type PlanStructure = z.infer<typeof PlanStructureSchema>;\n\n// ============================================================================\n// Fitness Plan LLM Output Schema\n// ============================================================================\n\n/* -----------------------------\n   FITNESS PLAN SCHEMA\n\n   Simplified schema that stores:\n   - description: Structured text plan (split, frequency, goals, deload rules, etc.)\n   - message: Brief SMS-friendly summary (optional)\n   - structured: Parsed plan data for UI rendering (stored separately)\n\n   Plans are ongoing by default - no fixed duration.\n----------------------------- */\nexport const _FitnessPlanSchema = z.object({\n  description: z.string({\n    description: \"Structured text fitness plan containing split, frequency, deload rules, goals, and progression principles\"\n  }),\n  message: z.string({\n    description: \"Brief summary of the fitness plan for SMS messages\"\n  }).nullish()\n});\n\nexport type FitnessPlanSchemaType = z.infer<typeof _FitnessPlanSchema>;\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AASO,MAAM,6BAA6B,0MAAC,CAAC,KAAK,CAC/C,0MAAC,CAAC,MAAM,CAAC;IACP,KAAK,0MAAC,CAAC,MAAM;IACb,OAAO,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC1B,WAAW,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;AAChC,IACA,QAAQ,CAAC;AAKJ,MAAM,sBAAsB,0MAAC,CAAC,MAAM,CAAC;IAC1C,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,wBAAwB,OAAO,CAAC;IAE1D,gBAAgB;IAChB,cAAc,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAEjC,mBAAmB;IACnB,qBAAqB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE;IAEnD,iBAAiB;IACjB,oBAAoB,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAEvC,0BAA0B;IAC1B,cAAc,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE;IAE5C,WAAW;IACX,kBAAkB,2BAA2B,OAAO,CAAC,EAAE;IAEvD,WAAW;IACX,eAAe,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC;IACnC,kBAAkB,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC;AACxC;AAkBO,MAAM,qBAAqB,0MAAC,CAAC,MAAM,CAAC;IACzC,aAAa,0MAAC,CAAC,MAAM,CAAC;QACpB,aAAa;IACf;IACA,SAAS,0MAAC,CAAC,MAAM,CAAC;QAChB,aAAa;IACf,GAAG,OAAO;AACZ"}},
    {"offset": {"line": 418, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/plan/index.ts"],"sourcesContent":["export * from './schema';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 425, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/fitnessPlan.ts"],"sourcesContent":["import type { FitnessPlans } from './_types';\nimport { Insertable, Selectable, Updateable } from 'kysely';\nimport { _FitnessPlanSchema, type PlanStructure } from '@/shared/types/plan';\nimport { UserWithProfile } from './user';\n\n// Re-export schema types from shared\nexport * from '@/shared/types/plan';\n\nexport type FitnessPlanDB = Selectable<FitnessPlans>;\nexport type NewFitnessPlan = Insertable<FitnessPlans>;\nexport type FitnessPlanUpdate = Updateable<FitnessPlans>;\n\n/**\n * Simplified FitnessPlan type\n *\n * Stores:\n * - description: Structured text plan (contains split, frequency, goals, deload rules, etc.)\n * - message: Brief summary for SMS (optional)\n * - structured: Parsed structured plan data for UI rendering\n *\n * Plans are ongoing by default - no fixed duration.\n * All versions are kept (query latest by created_at).\n */\nexport interface FitnessPlan {\n  id?: string;\n  clientId: string;\n  description: string;  // Structured text plan\n  message?: string | null;\n  structured?: PlanStructure | null;  // Parsed structured plan data\n  startDate: Date;\n  createdAt?: Date;\n  updatedAt?: Date;\n}\n\n/**\n * Overview returned by fitness plan agent\n */\nexport interface FitnessPlanOverview {\n  description: string;  // Structured text plan\n  message?: string;     // SMS-friendly summary\n  structure?: PlanStructure; // Structured plan data\n}\n\nexport class FitnessPlanModel implements FitnessPlan {\n  id: string;\n  clientId: string;\n  description: string;\n  message: string | null;\n  structured: PlanStructure | null;\n  startDate: Date;\n  createdAt: Date;\n  updatedAt: Date;\n\n  constructor(\n    id: string,\n    clientId: string,\n    description: string,\n    message: string | null,\n    structured: PlanStructure | null,\n    startDate: Date,\n    createdAt: Date,\n    updatedAt: Date\n  ) {\n    this.id = id;\n    this.clientId = clientId;\n    this.description = description;\n    this.message = message;\n    this.structured = structured;\n    this.startDate = startDate;\n    this.createdAt = createdAt;\n    this.updatedAt = updatedAt;\n  }\n\n  public static fromDB(fitnessPlan: FitnessPlanDB): FitnessPlan {\n    return {\n      id: fitnessPlan.id,\n      clientId: fitnessPlan.clientId,\n      description: fitnessPlan.description || '',\n      message: fitnessPlan.message,\n      structured: fitnessPlan.structured as PlanStructure | null,\n      startDate: new Date(fitnessPlan.startDate as unknown as string | number | Date),\n      createdAt: new Date(fitnessPlan.createdAt as unknown as string | number | Date),\n      updatedAt: new Date(fitnessPlan.updatedAt as unknown as string | number | Date),\n    };\n  }\n\n  public static fromFitnessPlanOverview(\n    user: UserWithProfile,\n    fitnessPlanOverview: FitnessPlanOverview\n  ): FitnessPlan {\n    return {\n      clientId: user.id,\n      description: fitnessPlanOverview.description,\n      message: fitnessPlanOverview.message || null,\n      structured: fitnessPlanOverview.structure || null,\n      startDate: new Date(),\n    };\n  }\n\n  public static schema = _FitnessPlanSchema;\n}\n"],"names":[],"mappings":";;;;AAEA;AAAA;;;AAyCO,MAAM;IACX,GAAW;IACX,SAAiB;IACjB,YAAoB;IACpB,QAAuB;IACvB,WAAiC;IACjC,UAAgB;IAChB,UAAgB;IAChB,UAAgB;IAEhB,YACE,EAAU,EACV,QAAgB,EAChB,WAAmB,EACnB,OAAsB,EACtB,UAAgC,EAChC,SAAe,EACf,SAAe,EACf,SAAe,CACf;QACA,IAAI,CAAC,EAAE,GAAG;QACV,IAAI,CAAC,QAAQ,GAAG;QAChB,IAAI,CAAC,WAAW,GAAG;QACnB,IAAI,CAAC,OAAO,GAAG;QACf,IAAI,CAAC,UAAU,GAAG;QAClB,IAAI,CAAC,SAAS,GAAG;QACjB,IAAI,CAAC,SAAS,GAAG;QACjB,IAAI,CAAC,SAAS,GAAG;IACnB;IAEA,OAAc,OAAO,WAA0B,EAAe;QAC5D,OAAO;YACL,IAAI,YAAY,EAAE;YAClB,UAAU,YAAY,QAAQ;YAC9B,aAAa,YAAY,WAAW,IAAI;YACxC,SAAS,YAAY,OAAO;YAC5B,YAAY,YAAY,UAAU;YAClC,WAAW,IAAI,KAAK,YAAY,SAAS;YACzC,WAAW,IAAI,KAAK,YAAY,SAAS;YACzC,WAAW,IAAI,KAAK,YAAY,SAAS;QAC3C;IACF;IAEA,OAAc,wBACZ,IAAqB,EACrB,mBAAwC,EAC3B;QACb,OAAO;YACL,UAAU,KAAK,EAAE;YACjB,aAAa,oBAAoB,WAAW;YAC5C,SAAS,oBAAoB,OAAO,IAAI;YACxC,YAAY,oBAAoB,SAAS,IAAI;YAC7C,WAAW,IAAI;QACjB;IACF;IAEA,OAAc,SAAS,sLAAkB,CAAC;AAC5C"}},
    {"offset": {"line": 479, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/fitnessPlanRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport {\n  FitnessPlanModel,\n  type FitnessPlan,\n} from '@/server/models/fitnessPlan';\n\n/**\n * Repository for fitness plan database operations\n *\n * Plans are now simple structured text - no more JSON mesocycles array\n */\nexport class FitnessPlanRepository extends BaseRepository {\n  /**\n   * Insert a new fitness plan\n   */\n  async insertFitnessPlan(fitnessPlan: FitnessPlan): Promise<FitnessPlan> {\n    const result = await this.db\n      .insertInto('fitnessPlans')\n      .values({\n        clientId: fitnessPlan.clientId,\n        description: fitnessPlan.description,\n        message: fitnessPlan.message,\n        structured: fitnessPlan.structured ? JSON.stringify(fitnessPlan.structured) : null,\n        startDate: fitnessPlan.startDate,\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return FitnessPlanModel.fromDB(result);\n  }\n\n  /**\n   * Get a fitness plan by ID\n   */\n  async getFitnessPlan(id: string): Promise<FitnessPlan | null> {\n    const result = await this.db\n      .selectFrom('fitnessPlans')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    if (!result) return null;\n    return FitnessPlanModel.fromDB(result);\n  }\n\n  /**\n   * Get the current (latest) fitness plan for a user\n   */\n  async getCurrentPlan(userId: string): Promise<FitnessPlan | null> {\n    const result = await this.db\n      .selectFrom('fitnessPlans')\n      .selectAll()\n      .where('clientId', '=', userId)\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst();\n\n    if (!result) return null;\n    return FitnessPlanModel.fromDB(result);\n  }\n\n  /**\n   * Get all fitness plans for a user (for history)\n   * Returns plans ordered by creation date (newest first)\n   */\n  async getPlanHistory(userId: string): Promise<FitnessPlan[]> {\n    const results = await this.db\n      .selectFrom('fitnessPlans')\n      .selectAll()\n      .where('clientId', '=', userId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n\n    return results.map(FitnessPlanModel.fromDB);\n  }\n\n  /**\n   * Update a fitness plan\n   */\n  async updateFitnessPlan(\n    id: string,\n    updates: Partial<Pick<FitnessPlan, 'description' | 'message' | 'structured'>>\n  ): Promise<FitnessPlan | null> {\n    const updateData: Record<string, unknown> = {\n      updatedAt: new Date(),\n    };\n\n    if (updates.description !== undefined) {\n      updateData.description = updates.description;\n    }\n    if (updates.message !== undefined) {\n      updateData.message = updates.message;\n    }\n    if (updates.structured !== undefined) {\n      updateData.structured = updates.structured ? JSON.stringify(updates.structured) : null;\n    }\n\n    const result = await this.db\n      .updateTable('fitnessPlans')\n      .set(updateData)\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst();\n\n    if (!result) return null;\n    return FitnessPlanModel.fromDB(result);\n  }\n\n  /**\n   * Delete a fitness plan by ID\n   */\n  async deleteFitnessPlan(id: string): Promise<boolean> {\n    const result = await this.db\n      .deleteFrom('fitnessPlans')\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows) > 0;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAUO,MAAM,8BAA8B,yLAAc;IACvD;;GAEC,GACD,MAAM,kBAAkB,WAAwB,EAAwB;QACtE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,gBACX,MAAM,CAAC;YACN,UAAU,YAAY,QAAQ;YAC9B,aAAa,YAAY,WAAW;YACpC,SAAS,YAAY,OAAO;YAC5B,YAAY,YAAY,UAAU,GAAG,KAAK,SAAS,CAAC,YAAY,UAAU,IAAI;YAC9E,WAAW,YAAY,SAAS;QAClC,GACC,YAAY,GACZ,uBAAuB;QAE1B,OAAO,kMAAgB,CAAC,MAAM,CAAC;IACjC;IAEA;;GAEC,GACD,MAAM,eAAe,EAAU,EAA+B;QAC5D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,gBACX,SAAS,GACT,KAAK,CAAC,MAAM,KAAK,IACjB,gBAAgB;QAEnB,IAAI,CAAC,QAAQ,OAAO;QACpB,OAAO,kMAAgB,CAAC,MAAM,CAAC;IACjC;IAEA;;GAEC,GACD,MAAM,eAAe,MAAc,EAA+B;QAChE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,gBACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,QACvB,OAAO,CAAC,aAAa,QACrB,gBAAgB;QAEnB,IAAI,CAAC,QAAQ,OAAO;QACpB,OAAO,kMAAgB,CAAC,MAAM,CAAC;IACjC;IAEA;;;GAGC,GACD,MAAM,eAAe,MAAc,EAA0B;QAC3D,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,gBACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,QACvB,OAAO,CAAC,aAAa,QACrB,OAAO;QAEV,OAAO,QAAQ,GAAG,CAAC,kMAAgB,CAAC,MAAM;IAC5C;IAEA;;GAEC,GACD,MAAM,kBACJ,EAAU,EACV,OAA6E,EAChD;QAC7B,MAAM,aAAsC;YAC1C,WAAW,IAAI;QACjB;QAEA,IAAI,QAAQ,WAAW,KAAK,WAAW;YACrC,WAAW,WAAW,GAAG,QAAQ,WAAW;QAC9C;QACA,IAAI,QAAQ,OAAO,KAAK,WAAW;YACjC,WAAW,OAAO,GAAG,QAAQ,OAAO;QACtC;QACA,IAAI,QAAQ,UAAU,KAAK,WAAW;YACpC,WAAW,UAAU,GAAG,QAAQ,UAAU,GAAG,KAAK,SAAS,CAAC,QAAQ,UAAU,IAAI;QACpF;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,WAAW,CAAC,gBACZ,GAAG,CAAC,YACJ,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,gBAAgB;QAEnB,IAAI,CAAC,QAAQ,OAAO;QACpB,OAAO,kMAAgB,CAAC,MAAM,CAAC;IACjC;IAEA;;GAEC,GACD,MAAM,kBAAkB,EAAU,EAAoB;QACpD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,gBACX,KAAK,CAAC,MAAM,KAAK,IACjB,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;AACF"}},
    {"offset": {"line": 677, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/models.ts"],"sourcesContent":["import { ChatGoogleGenerativeAI } from \"@langchain/google-genai\";\nimport { ChatOpenAI } from \"@langchain/openai\";\nimport { GoogleGenAI } from \"@google/genai\";\nimport type { StructuredToolInterface } from \"@langchain/core/tools\";\nimport { getAiSecrets } from \"@/server/config\";\n\n/**\n * Options for model initialization\n */\nexport interface ModelOptions {\n  tools?: StructuredToolInterface[];\n}\n\n/**\n * Configuration for image generation models\n */\nexport interface ImageModelConfig {\n  model?: 'gemini-2.5-flash-image';\n  aspectRatio?: \"1:1\" | \"2:3\" | \"3:2\" | \"3:4\" | \"4:3\" | \"4:5\" | \"5:4\" | \"9:16\" | \"16:9\" | \"21:9\";\n  imageSize?: \"1K\" | \"2K\" | \"4K\";\n}\n\n/**\n * Result from image generation\n */\nexport interface ImageGenerationResult {\n  imageData: string;\n  mimeType: string;\n  text?: string;\n}\n\n/**\n * A model that can invoke prompts and return responses\n */\nexport interface InvokableModel<T = unknown> {\n  invoke(input: unknown): Promise<T>;\n}\n\n/**\n * Initialize the model with structured output using the provided schema\n *\n * @param outputSchema - Optional Zod schema for structured output. If provided, returns T. If undefined, returns string.\n * @param config - Optional agent configuration\n * @param options - Optional model options (e.g., tools)\n * @returns Model that returns structured output (T), plain text (string), or model with tools bound\n */\nexport const initializeModel = <T = string>(outputSchema?: unknown, config?: { model?: string; temperature?: number; maxTokens?: number }, options?: ModelOptions): InvokableModel<T> => {\n    const { model = 'gpt-5-nano', temperature = 1, maxTokens = 16000 } = config || {};\n\n    if (model.startsWith('gemini')) {\n      const llm = new ChatGoogleGenerativeAI({\n        model: model,\n        temperature,\n        maxOutputTokens: maxTokens,\n      })\n      if (options?.tools) {\n        return llm.bindTools(options.tools) as unknown as InvokableModel<T>;\n      }\n      if (outputSchema) {\n        return llm.withStructuredOutput(outputSchema) as unknown as InvokableModel<T>;\n      }\n      // When no schema provided, wrap LLM to auto-extract .content from AIMessage\n      return {\n        invoke: async (input: unknown): Promise<T> => {\n          const response = await llm.invoke(input as Parameters<typeof llm.invoke>[0]);\n          const content = typeof response.content === 'string'\n            ? response.content\n            : String(response.content);\n          return content as T;\n        }\n      };\n    } else {\n      const llm = new ChatOpenAI({\n        model: model,\n        temperature: model !== 'gpt-5-nano' ? temperature : 1,\n        maxCompletionTokens: maxTokens,\n        reasoningEffort: 'low',\n      })\n      if (options?.tools) {\n        return llm.bindTools(options.tools) as unknown as InvokableModel<T>;\n      }\n      if (outputSchema) {\n        return llm.withStructuredOutput(outputSchema) as unknown as InvokableModel<T>;\n      }\n      // When no schema provided, wrap LLM to auto-extract .content from AIMessage\n      return {\n        invoke: async (input: unknown): Promise<T> => {\n          const response = await llm.invoke(input as Parameters<typeof llm.invoke>[0]);\n          const content = typeof response.content === 'string'\n            ? response.content\n            : String(response.content);\n          return content as T;\n        }\n      };\n    }\n  };\n\n/**\n * Initialize an image generation model with the provided configuration\n * Uses Google's Gemini image model via the @google/genai SDK\n *\n * @param config - Optional configuration for aspect ratio, image size, etc.\n * @returns Model with invoke() method that generates images from text prompts\n */\nexport const initializeImageModel = (config?: ImageModelConfig) => {\n  const { model = 'gemini-2.5-flash-image', aspectRatio = '3:4', imageSize = '2K' } = config || {};\n\n  const { googleApiKey } = getAiSecrets();\n  const googleGenAI = new GoogleGenAI({ apiKey: googleApiKey });\n\n  return {\n    invoke: async (prompt: string): Promise<ImageGenerationResult> => {\n      const response = await googleGenAI.models.generateContent({\n        model,\n        contents: prompt,\n        config: {\n          responseModalities: [\"TEXT\", \"IMAGE\"],\n          imageConfig: { aspectRatio, imageSize },\n        },\n      });\n\n      // Extract image data from response\n      const parts = response.candidates?.[0]?.content?.parts;\n      let imageData: string | undefined;\n      let mimeType = \"image/png\";\n      let text: string | undefined;\n\n      if (parts) {\n        for (const part of parts) {\n          if (\"text\" in part && part.text) text = part.text;\n          if (\"inlineData\" in part && part.inlineData) {\n            imageData = part.inlineData.data;\n            mimeType = part.inlineData.mimeType ?? \"image/png\";\n          }\n        }\n      }\n\n      if (!imageData) throw new Error(\"No image data returned from model\");\n\n      return { imageData, mimeType, text };\n    }\n  };\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AAAA;AACA;AAEA;AAAA;;;;;AA0CO,MAAM,kBAAkB,CAAa,cAAwB,QAAuE;IACvI,MAAM,EAAE,QAAQ,YAAY,EAAE,cAAc,CAAC,EAAE,YAAY,KAAK,EAAE,GAAG,UAAU,CAAC;IAEhF,IAAI,MAAM,UAAU,CAAC,WAAW;QAC9B,MAAM,MAAM,IAAI,2YAAsB,CAAC;YACrC,OAAO;YACP;YACA,iBAAiB;QACnB;QACA,IAAI,SAAS,OAAO;YAClB,OAAO,IAAI,SAAS,CAAC,QAAQ,KAAK;QACpC;QACA,IAAI,cAAc;YAChB,OAAO,IAAI,oBAAoB,CAAC;QAClC;QACA,4EAA4E;QAC5E,OAAO;YACL,QAAQ,OAAO;gBACb,MAAM,WAAW,MAAM,IAAI,MAAM,CAAC;gBAClC,MAAM,UAAU,OAAO,SAAS,OAAO,KAAK,WACxC,SAAS,OAAO,GAChB,OAAO,SAAS,OAAO;gBAC3B,OAAO;YACT;QACF;IACF,OAAO;QACL,MAAM,MAAM,IAAI,mXAAU,CAAC;YACzB,OAAO;YACP,aAAa,UAAU,eAAe,cAAc;YACpD,qBAAqB;YACrB,iBAAiB;QACnB;QACA,IAAI,SAAS,OAAO;YAClB,OAAO,IAAI,SAAS,CAAC,QAAQ,KAAK;QACpC;QACA,IAAI,cAAc;YAChB,OAAO,IAAI,oBAAoB,CAAC;QAClC;QACA,4EAA4E;QAC5E,OAAO;YACL,QAAQ,OAAO;gBACb,MAAM,WAAW,MAAM,IAAI,MAAM,CAAC;gBAClC,MAAM,UAAU,OAAO,SAAS,OAAO,KAAK,WACxC,SAAS,OAAO,GAChB,OAAO,SAAS,OAAO;gBAC3B,OAAO;YACT;QACF;IACF;AACF;AASK,MAAM,uBAAuB,CAAC;IACnC,MAAM,EAAE,QAAQ,wBAAwB,EAAE,cAAc,KAAK,EAAE,YAAY,IAAI,EAAE,GAAG,UAAU,CAAC;IAE/F,MAAM,EAAE,YAAY,EAAE,GAAG,IAAA,0KAAY;IACrC,MAAM,cAAc,IAAI,2OAAW,CAAC;QAAE,QAAQ;IAAa;IAE3D,OAAO;QACL,QAAQ,OAAO;YACb,MAAM,WAAW,MAAM,YAAY,MAAM,CAAC,eAAe,CAAC;gBACxD;gBACA,UAAU;gBACV,QAAQ;oBACN,oBAAoB;wBAAC;wBAAQ;qBAAQ;oBACrC,aAAa;wBAAE;wBAAa;oBAAU;gBACxC;YACF;YAEA,mCAAmC;YACnC,MAAM,QAAQ,SAAS,UAAU,EAAE,CAAC,EAAE,EAAE,SAAS;YACjD,IAAI;YACJ,IAAI,WAAW;YACf,IAAI;YAEJ,IAAI,OAAO;gBACT,KAAK,MAAM,QAAQ,MAAO;oBACxB,IAAI,UAAU,QAAQ,KAAK,IAAI,EAAE,OAAO,KAAK,IAAI;oBACjD,IAAI,gBAAgB,QAAQ,KAAK,UAAU,EAAE;wBAC3C,YAAY,KAAK,UAAU,CAAC,IAAI;wBAChC,WAAW,KAAK,UAAU,CAAC,QAAQ,IAAI;oBACzC;gBACF;YACF;YAEA,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;YAEhC,OAAO;gBAAE;gBAAW;gBAAU;YAAK;QACrC;IACF;AACF"}},
    {"offset": {"line": 788, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/utils.ts"],"sourcesContent":["import type { Message } from './types';\n\n/**\n * Configuration for building messages\n */\nexport interface BuildMessagesConfig {\n  systemPrompt: string;\n  userPrompt: string;\n  context?: string[];\n  previousMessages?: Message[];\n}\n\n/**\n * Build the message array for LLM invocation\n * Order: [SYSTEM, ...CONTEXT, ...PREVIOUS, USER]\n *\n * Context messages are added as user role messages between system and conversation history\n *\n * @param config - Message building configuration\n * @returns Array of messages ready for LLM invocation\n */\nexport function buildMessages(config: BuildMessagesConfig): Message[] {\n  const { systemPrompt, userPrompt, context = [], previousMessages = [] } = config;\n\n  // Build context messages (as user messages per existing pattern)\n  const contextMessages: Message[] = context\n    .filter(content => content && content.trim().length > 0)\n    .map(content => ({\n      role: 'user' as const,\n      content,\n    }));\n\n  return [\n    { role: 'system', content: systemPrompt },\n    ...contextMessages,\n    ...previousMessages,\n    { role: 'user', content: userPrompt },\n  ];\n}\n\n/**\n * Build a continuation message for the agentic loop\n * Used after tool execution to prompt the model to continue\n *\n * Provides type-aware instructions and warns about automated messages\n * to help the model generate natural, non-repetitive responses.\n *\n * @param toolType - Type of the last tool executed ('query' or 'action')\n * @param toolMessages - Messages generated by tool execution (will be sent after response)\n * @returns Continuation message content\n */\nexport function buildLoopContinuationMessage(\n  toolType: 'query' | 'action',\n  toolMessages: string[]\n): string {\n  let messageContext = '';\n  if (toolMessages.length > 0) {\n    messageContext = `\n[AUTOMATED MESSAGES]\nThe following messages will be sent to the user immediately after your response:\n${toolMessages.map((m) => `- \"${m.substring(0, 100)}${m.length > 100 ? '...' : ''}\"`).join('\\n')}\n`;\n  }\n\n  if (toolType === 'query') {\n    // QUERY tool - user asked for information\n    return `[SYSTEM: TOOL COMPLETE - QUERY]\n${messageContext}\n[INSTRUCTION]\nThe user asked a question and you retrieved the answer.\n- Provide a brief, natural intro to the information (e.g., \"Here's your workout for today:\" or \"Today you've got [type]:\")\n- DO NOT say \"Done\" or \"Complete\" - this was a question, not a request for action\n- If [AUTOMATED MESSAGES] are listed, they contain the detailed response. Just provide a smooth lead-in.\n- If there was an error, explain it simply.\n- Keep it conversational and SMS-style (1-2 sentences max).\n`;\n  }\n\n  // ACTION tool - user requested a change\n  return `[SYSTEM: TOOL COMPLETE - ACTION]\n${messageContext}\n[INSTRUCTION]\nThe user requested a change and it has been processed.\n- Briefly confirm what was done in a natural way\n- If [AUTOMATED MESSAGES] are listed, DO NOT repeat their content. Just provide a brief confirmation.\n- If you called make_modification with a message, that acknowledgment was already sent. Focus on the result now.\n- If the action failed, explain the issue simply.\n- Keep it conversational and SMS-style (1-2 sentences max).\n`;\n}\n"],"names":[],"mappings":";;;;;;AAqBO,SAAS,cAAc,MAA2B;IACvD,MAAM,EAAE,YAAY,EAAE,UAAU,EAAE,UAAU,EAAE,EAAE,mBAAmB,EAAE,EAAE,GAAG;IAE1E,iEAAiE;IACjE,MAAM,kBAA6B,QAChC,MAAM,CAAC,CAAA,UAAW,WAAW,QAAQ,IAAI,GAAG,MAAM,GAAG,GACrD,GAAG,CAAC,CAAA,UAAW,CAAC;YACf,MAAM;YACN;QACF,CAAC;IAEH,OAAO;QACL;YAAE,MAAM;YAAU,SAAS;QAAa;WACrC;WACA;QACH;YAAE,MAAM;YAAQ,SAAS;QAAW;KACrC;AACH;AAaO,SAAS,6BACd,QAA4B,EAC5B,YAAsB;IAEtB,IAAI,iBAAiB;IACrB,IAAI,aAAa,MAAM,GAAG,GAAG;QAC3B,iBAAiB,CAAC;;;AAGtB,EAAE,aAAa,GAAG,CAAC,CAAC,IAAM,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC,GAAG,OAAO,EAAE,MAAM,GAAG,MAAM,QAAQ,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM;AACjG,CAAC;IACC;IAEA,IAAI,aAAa,SAAS;QACxB,0CAA0C;QAC1C,OAAO,CAAC;AACZ,EAAE,eAAe;;;;;;;;AAQjB,CAAC;IACC;IAEA,wCAAwC;IACxC,OAAO,CAAC;AACV,EAAE,eAAe;;;;;;;;AAQjB,CAAC;AACD"}},
    {"offset": {"line": 852, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/subAgentExecutor.ts"],"sourcesContent":["import type { SubAgentBatch, SubAgentConfig, ConfigurableAgent } from './types';\n\n/**\n * Configuration for subAgent execution\n */\nexport interface SubAgentExecutorConfig {\n  batches: SubAgentBatch[];\n  /** String input passed to each subAgent (typically parent agent's response) */\n  input: string;\n  previousResults: Record<string, unknown>;\n  parentName: string;\n}\n\n/**\n * Type guard to check if entry is an extended SubAgentConfig\n */\nfunction isSubAgentConfig(entry: unknown): entry is SubAgentConfig {\n  return entry !== null &&\n    typeof entry === 'object' &&\n    'agent' in entry &&\n    typeof (entry as SubAgentConfig).agent?.invoke === 'function';\n}\n\n/**\n * Execute subAgent batches\n *\n * - Batches run sequentially (array order)\n * - Agents within a batch run in parallel (object keys)\n * - Each batch receives results from previous batches\n * - Supports extended config with transform and condition per agent\n * - Fails fast if any agent throws\n *\n * @param config - Executor configuration\n * @returns Combined results from all subAgents (excluding 'response' key)\n */\nexport async function executeSubAgents(\n  config: SubAgentExecutorConfig\n): Promise<Record<string, unknown>> {\n  const { batches, input, previousResults, parentName } = config;\n\n  // Main result for condition/transform functions\n  const mainResult = previousResults.response;\n\n  const accumulatedResults: Record<string, unknown> = { ...previousResults };\n\n  for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {\n    const batch = batches[batchIndex];\n    const batchKeys = Object.keys(batch);\n\n    console.log(`[${parentName}] Executing batch ${batchIndex + 1}/${batches.length}: [${batchKeys.join(', ')}]`);\n\n    const batchStartTime = Date.now();\n\n    // Execute all agents in this batch in parallel (fail fast)\n    const batchPromises = batchKeys.map(async (key) => {\n      const entry = batch[key];\n\n      // Determine agent, condition, and transform based on entry type\n      let agent: ConfigurableAgent<unknown>;\n      let condition: ((r: unknown) => boolean) | undefined;\n      let transform: ((r: unknown) => string) | undefined;\n\n      if (isSubAgentConfig(entry)) {\n        // Extended config: { agent, transform?, condition? }\n        agent = entry.agent;\n        condition = entry.condition;\n        transform = entry.transform;\n      } else {\n        // Simple config: bare agent\n        agent = entry as ConfigurableAgent<unknown>;\n      }\n\n      // Check condition - skip if condition returns false\n      if (condition && !condition(mainResult)) {\n        console.log(`[${parentName}:${key}] Skipped (condition not met)`);\n        return { key, result: null, skipped: true };\n      }\n\n      // Determine input: use transform if provided, otherwise default input\n      const agentInput = transform\n        ? transform(mainResult)\n        : input;\n\n      const startTime = Date.now();\n      console.log(`[${parentName}:${key}] Starting`);\n\n      const result = await agent.invoke(agentInput);\n\n      console.log(`[${parentName}:${key}] Completed in ${Date.now() - startTime}ms`);\n\n      return { key, result, skipped: false };\n    });\n\n    // Wait for all agents in batch (will throw on first failure)\n    const batchResults = await Promise.all(batchPromises);\n\n    console.log(`[${parentName}] Batch ${batchIndex + 1} completed in ${Date.now() - batchStartTime}ms`);\n\n    // Accumulate results, flattening { response: X } to just X, skip nulls from conditions\n    for (const { key, result, skipped } of batchResults) {\n      if (skipped) continue;\n      const hasResponse = result && typeof result === 'object' && 'response' in result;\n      accumulatedResults[key] = hasResponse ? (result as { response: unknown }).response : result;\n    }\n  }\n\n  // Remove the 'response' key as it will be added by the caller\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const { response: _responseKey, ...subAgentResults } = accumulatedResults;\n  return subAgentResults;\n}\n"],"names":[],"mappings":";;;;AAaA;;CAEC,GACD,SAAS,iBAAiB,KAAc;IACtC,OAAO,UAAU,QACf,OAAO,UAAU,YACjB,WAAW,SACX,OAAO,AAAC,MAAyB,KAAK,EAAE,WAAW;AACvD;AAcO,eAAe,iBACpB,MAA8B;IAE9B,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,eAAe,EAAE,UAAU,EAAE,GAAG;IAExD,gDAAgD;IAChD,MAAM,aAAa,gBAAgB,QAAQ;IAE3C,MAAM,qBAA8C;QAAE,GAAG,eAAe;IAAC;IAEzE,IAAK,IAAI,aAAa,GAAG,aAAa,QAAQ,MAAM,EAAE,aAAc;QAClE,MAAM,QAAQ,OAAO,CAAC,WAAW;QACjC,MAAM,YAAY,OAAO,IAAI,CAAC;QAE9B,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,WAAW,kBAAkB,EAAE,aAAa,EAAE,CAAC,EAAE,QAAQ,MAAM,CAAC,GAAG,EAAE,UAAU,IAAI,CAAC,MAAM,CAAC,CAAC;QAE5G,MAAM,iBAAiB,KAAK,GAAG;QAE/B,2DAA2D;QAC3D,MAAM,gBAAgB,UAAU,GAAG,CAAC,OAAO;YACzC,MAAM,QAAQ,KAAK,CAAC,IAAI;YAExB,gEAAgE;YAChE,IAAI;YACJ,IAAI;YACJ,IAAI;YAEJ,IAAI,iBAAiB,QAAQ;gBAC3B,qDAAqD;gBACrD,QAAQ,MAAM,KAAK;gBACnB,YAAY,MAAM,SAAS;gBAC3B,YAAY,MAAM,SAAS;YAC7B,OAAO;gBACL,4BAA4B;gBAC5B,QAAQ;YACV;YAEA,oDAAoD;YACpD,IAAI,aAAa,CAAC,UAAU,aAAa;gBACvC,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,EAAE,IAAI,6BAA6B,CAAC;gBAChE,OAAO;oBAAE;oBAAK,QAAQ;oBAAM,SAAS;gBAAK;YAC5C;YAEA,sEAAsE;YACtE,MAAM,aAAa,YACf,UAAU,cACV;YAEJ,MAAM,YAAY,KAAK,GAAG;YAC1B,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,EAAE,IAAI,UAAU,CAAC;YAE7C,MAAM,SAAS,MAAM,MAAM,MAAM,CAAC;YAElC,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,EAAE,IAAI,eAAe,EAAE,KAAK,GAAG,KAAK,UAAU,EAAE,CAAC;YAE7E,OAAO;gBAAE;gBAAK;gBAAQ,SAAS;YAAM;QACvC;QAEA,6DAA6D;QAC7D,MAAM,eAAe,MAAM,QAAQ,GAAG,CAAC;QAEvC,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,WAAW,QAAQ,EAAE,aAAa,EAAE,cAAc,EAAE,KAAK,GAAG,KAAK,eAAe,EAAE,CAAC;QAEnG,uFAAuF;QACvF,KAAK,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,aAAc;YACnD,IAAI,SAAS;YACb,MAAM,cAAc,UAAU,OAAO,WAAW,YAAY,cAAc;YAC1E,kBAAkB,CAAC,IAAI,GAAG,cAAc,AAAC,OAAiC,QAAQ,GAAG;QACvF;IACF;IAEA,8DAA8D;IAC9D,6DAA6D;IAC7D,MAAM,EAAE,UAAU,YAAY,EAAE,GAAG,iBAAiB,GAAG;IACvD,OAAO;AACT"}},
    {"offset": {"line": 929, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/toolExecutor.ts"],"sourcesContent":["import type { StructuredToolInterface } from '@langchain/core/tools';\nimport type { Message, ToolExecutionResult } from './types';\nimport { buildLoopContinuationMessage } from './utils';\n\n/**\n * Configuration for tool loop execution\n */\nexport interface ToolLoopConfig {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  model: any;\n  messages: Message[];\n  tools: StructuredToolInterface[];\n  name: string;\n  maxIterations: number;\n}\n\n/**\n * Result from tool loop execution\n */\nexport interface ToolLoopResult {\n  response: string;\n  messages: string[];\n  toolCalls: ToolCallRecord[];\n}\n\n/**\n * Record of a tool call for observability\n */\nexport interface ToolCallRecord {\n  name: string;\n  args: Record<string, unknown>;\n  result: string;\n  durationMs: number;\n}\n\n// Tool execution priority (lower = first)\n// Profile updates should happen before modifications\nconst TOOL_PRIORITY: Record<string, number> = {\n  'update_profile': 1,\n  'get_workout': 2,\n  'make_modification': 3,\n};\n\n/**\n * Execute an agentic tool loop\n *\n * Continues until model returns a response without tool calls\n * or max iterations is reached.\n *\n * @param config - Tool loop configuration\n * @returns Final response string and accumulated messages\n */\nexport async function executeToolLoop(config: ToolLoopConfig): Promise<ToolLoopResult> {\n  const { model, messages, tools, name, maxIterations } = config;\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const conversationHistory: any[] = [...messages];\n  const toolCalls: ToolCallRecord[] = [];\n  const accumulatedMessages: string[] = [];\n  let lastToolType: 'query' | 'action' = 'action';\n\n  for (let iteration = 1; iteration <= maxIterations; iteration++) {\n    console.log(`[${name}] Tool loop iteration ${iteration}`);\n\n    const result = await model.invoke(conversationHistory);\n\n    // Check for tool calls\n    if (!result.tool_calls || result.tool_calls.length === 0) {\n      // No tool calls - return the response\n      const response = typeof result.content === 'string'\n        ? result.content\n        : String(result.content);\n\n      console.log(`[${name}] Tool loop completed after ${iteration} iteration(s)`);\n\n      return {\n        response,\n        messages: accumulatedMessages,\n        toolCalls,\n      };\n    }\n\n    // Sort tool calls by priority\n    const sortedToolCalls = [...result.tool_calls].sort(\n      (a: { name: string }, b: { name: string }) =>\n        (TOOL_PRIORITY[a.name] ?? 99) - (TOOL_PRIORITY[b.name] ?? 99)\n    );\n\n    console.log(`[${name}] ${sortedToolCalls.length} tool call(s): ${sortedToolCalls.map((tc: { name: string }) => tc.name).join(', ')}`);\n\n    // Track messages from tools for this iteration\n    const iterationMessages: string[] = [];\n\n    // Execute each tool call in priority order\n    for (let i = 0; i < sortedToolCalls.length; i++) {\n      const toolCall = sortedToolCalls[i];\n      const callId = `call_${iteration}_${i}`;\n\n      // Find the tool\n      const selectedTool = tools.find(t => t.name === toolCall.name);\n      if (!selectedTool) {\n        console.error(`[${name}] Tool not found: ${toolCall.name}`);\n        continue;\n      }\n\n      const toolStartTime = Date.now();\n\n      try {\n        console.log(`[${name}] Executing tool: ${toolCall.name}`);\n\n        const toolResult = await (selectedTool as { invoke: (args: unknown) => Promise<ToolExecutionResult> }).invoke(toolCall.args);\n\n        const durationMs = Date.now() - toolStartTime;\n\n        // Track tool type for continuation message\n        lastToolType = toolResult.toolType || 'action';\n\n        // Accumulate messages if present\n        if (toolResult.messages && toolResult.messages.length > 0) {\n          accumulatedMessages.push(...toolResult.messages);\n          iterationMessages.push(...toolResult.messages);\n          console.log(`[${name}] Accumulated ${toolResult.messages.length} message(s) from ${toolCall.name}`);\n        }\n\n        // Record tool call for observability\n        toolCalls.push({\n          name: toolCall.name,\n          args: toolCall.args as Record<string, unknown>,\n          result: toolResult.response,\n          durationMs,\n        });\n\n        // Add to conversation history\n        conversationHistory.push({\n          role: 'assistant',\n          content: '',\n          tool_calls: [{\n            id: callId,\n            type: 'function',\n            function: { name: toolCall.name, arguments: JSON.stringify(toolCall.args) },\n          }],\n        });\n        conversationHistory.push({\n          role: 'tool',\n          content: toolResult.response,\n          tool_call_id: callId,\n        });\n\n        console.log(`[${name}] ${toolCall.name} complete in ${durationMs}ms`);\n      } catch (error) {\n        console.error(`[${name}] Tool error (${toolCall.name}):`, error);\n\n        // Add error to conversation history so model knows it failed\n        conversationHistory.push({\n          role: 'tool',\n          content: `Error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n          tool_call_id: callId,\n        });\n\n        accumulatedMessages.push(\n          \"I tried to help but encountered an issue. Please try again!\"\n        );\n      }\n    }\n\n    // Add continuation message for next iteration\n    conversationHistory.push({\n      role: 'user',\n      content: buildLoopContinuationMessage(lastToolType, iterationMessages),\n    });\n\n    console.log(`[${name}] All tools complete, continuing loop`);\n  }\n\n  // Max iterations reached\n  console.warn(`[${name}] Max iterations (${maxIterations}) reached`);\n\n  return {\n    response: accumulatedMessages.length > 0\n      ? accumulatedMessages[accumulatedMessages.length - 1]\n      : \"I'm here to help! What would you like to know?\",\n    messages: accumulatedMessages,\n    toolCalls,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1053, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/schema.ts"],"sourcesContent":["import { z } from 'zod';\n\n// ============================================================================\n// Environment Detection (for smart defaults)\n// ============================================================================\nconst isDev = process.env.NODE_ENV === 'development';\nconst isProd = process.env.NODE_ENV === 'production';\n\n// ============================================================================\n// Context Configuration (migrated from context.config.ts)\n// ============================================================================\nexport const ContextConfigSchema = z.object({\n  messageHistoryLimit: z.number().int().positive().default(5),\n  includeSystemMessages: z.boolean().default(true),\n  maxContextTokens: z.number().int().positive().default(1000),\n  reserveTokensForResponse: z.number().int().positive().default(1500),\n  conversationGapMinutes: z.number().int().positive().default(30),\n  enableCaching: z.boolean().default(true),\n  // Longer cache in production\n  cacheTTLSeconds: z.number().int().nonnegative().default(isProd ? 600 : 300),\n});\n\n// ============================================================================\n// Chat Configuration\n// ============================================================================\nexport const ChatConfigSchema = z.object({\n  smsMaxLength: z.number().int().positive().default(1600),\n  contextMinutes: z.number().int().positive().default(10),\n});\n\n// ============================================================================\n// Messaging Configuration\n// ============================================================================\nexport const MessagingProviderSchema = z.enum(['twilio', 'local']);\n\nexport const MessagingConfigSchema = z.object({\n  // Use local provider in development, twilio in production\n  provider: MessagingProviderSchema.default(isDev ? 'local' : 'twilio'),\n});\n\n// ============================================================================\n// Feature Flags\n// ============================================================================\nexport const FeatureFlagsSchema = z.object({\n  // Enable agent logging in development by default\n  agentLogging: z.boolean().default(isDev),\n  enableConversationStorage: z.boolean().default(true),\n});\n\n// ============================================================================\n// Conversation Configuration\n// ============================================================================\nexport const ConversationConfigSchema = z.object({\n  timeoutMinutes: z.number().int().positive().default(30),\n  maxLength: z.number().int().positive().default(100),\n  inactiveThresholdDays: z.number().int().positive().default(7),\n});\n\n// ============================================================================\n// Short Links Configuration\n// ============================================================================\nexport const ShortLinksConfigSchema = z.object({\n  defaultExpiryDays: z.number().int().positive().default(7),\n  domain: z.string().optional(),\n});\n\n// ============================================================================\n// Stripe Configuration (non-secret)\n// ============================================================================\nexport const StripeConfigSchema = z.object({\n  priceId: z.string().min(1),\n});\n\n// ============================================================================\n// Admin Configuration\n// ============================================================================\nexport const AdminConfigSchema = z.object({\n  phoneNumbers: z.array(z.string()).default([]),\n  maxRequestsPerWindow: z.number().int().positive().default(3),\n  rateLimitWindowMinutes: z.number().int().positive().default(15),\n  codeExpiryMinutes: z.number().int().positive().default(10),\n  codeLength: z.number().int().positive().default(6),\n  devBypassCode: z.string().optional(),\n});\n\n// ============================================================================\n// Application URLs\n// ============================================================================\nexport const UrlsConfigSchema = z.object({\n  baseUrl: z.string().optional(),\n  publicBaseUrl: z.string().optional(),\n});\n\n// ============================================================================\n// Root Configuration Schema\n// ============================================================================\nexport const AppConfigSchema = z.object({\n  environment: z.enum(['development', 'staging', 'production']),\n  context: ContextConfigSchema,\n  chat: ChatConfigSchema,\n  messaging: MessagingConfigSchema,\n  features: FeatureFlagsSchema,\n  conversation: ConversationConfigSchema,\n  shortLinks: ShortLinksConfigSchema,\n  stripe: StripeConfigSchema,\n  admin: AdminConfigSchema,\n  urls: UrlsConfigSchema,\n});\n\n// Export types inferred from schemas\nexport type AppConfig = z.infer<typeof AppConfigSchema>;\nexport type ContextConfig = z.infer<typeof ContextConfigSchema>;\nexport type ChatConfig = z.infer<typeof ChatConfigSchema>;\nexport type MessagingConfig = z.infer<typeof MessagingConfigSchema>;\nexport type MessagingProvider = z.infer<typeof MessagingProviderSchema>;\nexport type FeatureFlags = z.infer<typeof FeatureFlagsSchema>;\nexport type ConversationConfig = z.infer<typeof ConversationConfigSchema>;\nexport type ShortLinksConfig = z.infer<typeof ShortLinksConfigSchema>;\nexport type StripeConfig = z.infer<typeof StripeConfigSchema>;\nexport type AdminConfig = z.infer<typeof AdminConfigSchema>;\nexport type UrlsConfig = z.infer<typeof UrlsConfigSchema>;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1156, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/loader.ts"],"sourcesContent":["import { AppConfigSchema, type AppConfig, type MessagingProvider } from './schema';\n\nexport type Environment = 'development' | 'staging' | 'production';\n\n/**\n * Determine current environment.\n * APP_ENV can override NODE_ENV (useful for staging which isn't a Node concept).\n */\nexport function getEnvironment(): Environment {\n  const appEnv = process.env.APP_ENV;\n  const nodeEnv = process.env.NODE_ENV;\n\n  if (appEnv === 'staging') return 'staging';\n  if (nodeEnv === 'production') return 'production';\n  return 'development';\n}\n\n/**\n * Parse comma-separated phone numbers from env var.\n */\nfunction parsePhoneNumbers(envValue: string | undefined): string[] {\n  if (!envValue) return [];\n  return envValue\n    .split(',')\n    .map((num) => num.trim())\n    .filter((num) => num.length > 0);\n}\n\n/**\n * Parse optional integer from env var.\n */\nfunction parseOptionalInt(value: string | undefined): number | undefined {\n  if (!value) return undefined;\n  const parsed = parseInt(value, 10);\n  return isNaN(parsed) ? undefined : parsed;\n}\n\n/**\n * Parse optional boolean from env var.\n * Treats 'true' as true, 'false' as false, undefined as undefined.\n */\nfunction parseOptionalBool(value: string | undefined): boolean | undefined {\n  if (value === undefined) return undefined;\n  return value === 'true';\n}\n\n/**\n * Load and validate configuration.\n * Builds config from env vars, letting Zod schemas handle defaults.\n * Throws on validation failure (fail-fast).\n */\nexport function loadConfig(): AppConfig {\n  const env = getEnvironment();\n\n  // Build raw config from env vars - undefined values let Zod defaults apply\n  const rawConfig = {\n    environment: env,\n    context: {\n      messageHistoryLimit: parseOptionalInt(process.env.CONTEXT_MESSAGE_HISTORY_LIMIT),\n      includeSystemMessages: parseOptionalBool(process.env.CONTEXT_INCLUDE_SYSTEM_MESSAGES),\n      maxContextTokens: parseOptionalInt(process.env.CONTEXT_MAX_TOKENS),\n      reserveTokensForResponse: parseOptionalInt(process.env.CONTEXT_RESERVE_TOKENS),\n      conversationGapMinutes: parseOptionalInt(process.env.CONTEXT_CONVERSATION_GAP_MINUTES),\n      enableCaching: parseOptionalBool(process.env.CONTEXT_ENABLE_CACHING),\n      cacheTTLSeconds: parseOptionalInt(process.env.CONTEXT_CACHE_TTL),\n    },\n    chat: {\n      smsMaxLength: parseOptionalInt(process.env.SMS_MAX_LENGTH),\n      contextMinutes: parseOptionalInt(process.env.CHAT_CONTEXT_MINUTES),\n    },\n    messaging: {\n      provider: process.env.MESSAGING_PROVIDER as MessagingProvider | undefined,\n    },\n    features: {\n      agentLogging: parseOptionalBool(process.env.AGENT_LOGGING),\n      enableConversationStorage: parseOptionalBool(process.env.ENABLE_CONVERSATION_STORAGE),\n    },\n    conversation: {\n      timeoutMinutes: parseOptionalInt(process.env.CONVERSATION_TIMEOUT_MINUTES),\n      maxLength: parseOptionalInt(process.env.MAX_CONVERSATION_LENGTH),\n      inactiveThresholdDays: parseOptionalInt(process.env.INACTIVE_THRESHOLD_DAYS),\n    },\n    shortLinks: {\n      defaultExpiryDays: parseOptionalInt(process.env.SHORT_LINK_DEFAULT_EXPIRY_DAYS),\n      domain: process.env.SHORT_LINK_DOMAIN,\n    },\n    stripe: {\n      priceId: process.env.STRIPE_PRICE_ID,\n    },\n    admin: {\n      phoneNumbers: process.env.ADMIN_PHONE_NUMBERS\n        ? parsePhoneNumbers(process.env.ADMIN_PHONE_NUMBERS)\n        : undefined,\n      devBypassCode: process.env.DEV_BYPASS_CODE,\n    },\n    urls: {\n      baseUrl: process.env.BASE_URL,\n      publicBaseUrl: process.env.NEXT_PUBLIC_BASE_URL,\n    },\n  };\n\n  // Validate with Zod - applies defaults and throws on failure\n  const result = AppConfigSchema.safeParse(rawConfig);\n\n  if (!result.success) {\n    const errors = result.error.errors\n      .map((e) => `  - ${e.path.join('.')}: ${e.message}`)\n      .join('\\n');\n\n    throw new Error(\n      `Configuration validation failed:\\n${errors}\\n\\n` +\n        `Environment: ${env}\\n` +\n        `Check your environment variables.`\n    );\n  }\n\n  return result.data;\n}\n\n// Singleton config instance\nlet _config: AppConfig | null = null;\n\n/**\n * Get the validated application config.\n * Caches the result for subsequent calls.\n */\nexport function getConfig(): AppConfig {\n  if (!_config) {\n    _config = loadConfig();\n  }\n  return _config;\n}\n\n/**\n * Reset config cache (useful for testing).\n */\nexport function resetConfig(): void {\n  _config = null;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1265, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/public.ts"],"sourcesContent":["/**\n * Public Configuration\n *\n * Safe for client-side usage. All NEXT_PUBLIC_* values are validated here.\n */\nimport { z } from 'zod';\n\n// =============================================================================\n// Public Environment Schema\n// =============================================================================\n\nconst PublicEnvSchema = z.object({\n  NEXT_PUBLIC_BASE_URL: z.string().optional(),\n  NEXT_PUBLIC_ANALYTICS_WRITE_KEY: z.string().optional(),\n  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().optional(),\n});\n\ntype PublicEnv = z.infer<typeof PublicEnvSchema>;\n\n// =============================================================================\n// Validation & Caching\n// =============================================================================\n\nlet _publicEnv: PublicEnv | null = null;\n\nfunction getPublicEnv(): PublicEnv {\n  if (!_publicEnv) {\n    const result = PublicEnvSchema.safeParse({\n      NEXT_PUBLIC_BASE_URL: process.env.NEXT_PUBLIC_BASE_URL,\n      NEXT_PUBLIC_ANALYTICS_WRITE_KEY: process.env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY,\n      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,\n    });\n\n    if (!result.success) {\n      console.warn('Public environment validation warnings:', result.error.errors);\n    }\n\n    _publicEnv = result.data ?? {};\n  }\n  return _publicEnv;\n}\n\n/**\n * Reset env cache (useful for testing).\n */\nexport function resetPublicEnv(): void {\n  _publicEnv = null;\n}\n\n// =============================================================================\n// URL Settings\n// =============================================================================\n\nexport function getPublicUrls() {\n  const env = getPublicEnv();\n  return {\n    baseUrl: env.NEXT_PUBLIC_BASE_URL,\n  };\n}\n\n// =============================================================================\n// Analytics Config\n// =============================================================================\n\nexport function getAnalyticsConfig() {\n  const env = getPublicEnv();\n  return {\n    writeKey: env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY,\n    isEnabled: Boolean(env.NEXT_PUBLIC_ANALYTICS_WRITE_KEY),\n  };\n}\n\n// =============================================================================\n// Public Stripe Config\n// =============================================================================\n\nexport function getPublicStripeConfig() {\n  const env = getPublicEnv();\n  return {\n    publishableKey: env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,\n  };\n}\n\n// =============================================================================\n// Environment Detection (client-safe)\n// =============================================================================\n\n/**\n * Check if running in production environment.\n * Safe for use in client components.\n */\nexport function isProductionEnvironment(): boolean {\n  return process.env.NODE_ENV === 'production';\n}\n\n/**\n * Check if running in development environment.\n * Safe for use in client components.\n */\nexport function isDevelopmentEnvironment(): boolean {\n  return process.env.NODE_ENV === 'development';\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;AACD;AAAA;;AAEA,gFAAgF;AAChF,4BAA4B;AAC5B,gFAAgF;AAEhF,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IAC/B,sBAAsB,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACzC,iCAAiC,0MAAC,CAAC,MAAM,GAAG,QAAQ;IACpD,oCAAoC,0MAAC,CAAC,MAAM,GAAG,QAAQ;AACzD;AAIA,gFAAgF;AAChF,uBAAuB;AACvB,gFAAgF;AAEhF,IAAI,aAA+B;AAEnC,SAAS;IACP,IAAI,CAAC,YAAY;QACf,MAAM,SAAS,gBAAgB,SAAS,CAAC;YACvC,oBAAoB;YACpB,iCAAiC,QAAQ,GAAG,CAAC,+BAA+B;YAC5E,kCAAkC;QACpC;QAEA,IAAI,CAAC,OAAO,OAAO,EAAE;YACnB,QAAQ,IAAI,CAAC,2CAA2C,OAAO,KAAK,CAAC,MAAM;QAC7E;QAEA,aAAa,OAAO,IAAI,IAAI,CAAC;IAC/B;IACA,OAAO;AACT;AAKO,SAAS;IACd,aAAa;AACf;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,SAAS,IAAI,oBAAoB;IACnC;AACF;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,UAAU,IAAI,+BAA+B;QAC7C,WAAW,QAAQ,IAAI,+BAA+B;IACxD;AACF;AAMO,SAAS;IACd,MAAM,MAAM;IACZ,OAAO;QACL,gBAAgB,IAAI,kCAAkC;IACxD;AACF;AAUO,SAAS;IACd,OAAO,oDAAyB;AAClC;AAMO,SAAS;IACd,OAAO,oDAAyB;AAClC"}},
    {"offset": {"line": 1344, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/config/index.ts"],"sourcesContent":["/**\n * Application Configuration\n *\n * This module provides type-safe, validated configuration for the application.\n * Config values are loaded once at startup and cached.\n *\n * Usage:\n *   import { config } from '@/shared/config';\n *   console.log(config.chat.smsMaxLength);\n *\n * Or use section accessors:\n *   import { getChatConfig, getFeatureFlags } from '@/shared/config';\n *   const { smsMaxLength } = getChatConfig();\n */\n\nexport { getConfig, loadConfig, resetConfig, getEnvironment } from './loader';\nexport type { Environment } from './loader';\nexport * from './schema';\nexport * from './public';\n\nimport { getConfig } from './loader';\nimport type {\n  AppConfig,\n  ContextConfig,\n  ChatConfig,\n  MessagingConfig,\n  FeatureFlags,\n  ConversationConfig,\n  ShortLinksConfig,\n  StripeConfig,\n  AdminConfig,\n  UrlsConfig,\n} from './schema';\n\n// ============================================================================\n// Lazy config getter to avoid issues during build/module loading\n// ============================================================================\n\nlet _cachedConfig: AppConfig | null = null;\n\nfunction getCachedConfig(): AppConfig {\n  if (!_cachedConfig) {\n    _cachedConfig = getConfig();\n  }\n  return _cachedConfig;\n}\n\n/**\n * The validated application configuration.\n * Use this for direct property access: config.chat.smsMaxLength\n *\n * Note: This is a getter that lazily loads config on first access.\n */\nexport const config = new Proxy({} as AppConfig, {\n  get(_target, prop) {\n    return getCachedConfig()[prop as keyof AppConfig];\n  },\n});\n\n// ============================================================================\n// Convenience accessors for individual config sections\n// These match the existing getContextConfig() pattern\n// ============================================================================\n\nexport function getContextConfig(): ContextConfig {\n  return getConfig().context;\n}\n\nexport function getChatConfig(): ChatConfig {\n  return getConfig().chat;\n}\n\nexport function getMessagingConfig(): MessagingConfig {\n  return getConfig().messaging;\n}\n\nexport function getFeatureFlags(): FeatureFlags {\n  return getConfig().features;\n}\n\nexport function getConversationConfig(): ConversationConfig {\n  return getConfig().conversation;\n}\n\nexport function getShortLinksConfig(): ShortLinksConfig {\n  return getConfig().shortLinks;\n}\n\nexport function getStripeConfig(): StripeConfig {\n  return getConfig().stripe;\n}\n\nexport function getAdminConfig(): AdminConfig {\n  return getConfig().admin;\n}\n\nexport function getUrlsConfig(): UrlsConfig {\n  return getConfig().urls;\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;CAaC;;;;;;;;;;;;;;;;;;;;;;AAED;AAEA;AACA;;;;;AAgBA,+EAA+E;AAC/E,iEAAiE;AACjE,+EAA+E;AAE/E,IAAI,gBAAkC;AAEtC,SAAS;IACP,IAAI,CAAC,eAAe;QAClB,gBAAgB,IAAA,sKAAS;IAC3B;IACA,OAAO;AACT;AAQO,MAAM,SAAS,IAAI,MAAM,CAAC,GAAgB;IAC/C,KAAI,OAAO,EAAE,IAAI;QACf,OAAO,iBAAiB,CAAC,KAAwB;IACnD;AACF;AAOO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,OAAO;AAC5B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,IAAI;AACzB;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,SAAS;AAC9B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,QAAQ;AAC7B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,YAAY;AACjC;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,UAAU;AAC/B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,MAAM;AAC3B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,KAAK;AAC1B;AAEO,SAAS;IACd,OAAO,IAAA,sKAAS,IAAG,IAAI;AACzB"}},
    {"offset": {"line": 1432, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/logger.ts"],"sourcesContent":["import * as fs from 'fs/promises';\nimport * as path from 'path';\nimport type { Message } from './types';\nimport { getFeatureFlags } from '@/shared/config';\n\nconst LOGS_DIR = path.join(process.cwd(), '_logs');\n\n/**\n * Check if agent logging is enabled via config\n */\nfunction isLoggingEnabled(): boolean {\n  return getFeatureFlags().agentLogging;\n}\n\n/**\n * Generate a timestamp string for filenames\n * Format: YYYY-MM-DD_HHmmss-mmm (includes milliseconds to avoid collisions)\n */\nfunction generateTimestamp(): string {\n  const now = new Date();\n  const date = now.toISOString().split('T')[0];\n  const time = now.toTimeString().split(' ')[0].replace(/:/g, '');\n  const ms = now.getMilliseconds().toString().padStart(3, '0');\n  return `${date}_${time}-${ms}`;\n}\n\n/**\n * Ensure the logs directory exists\n */\nasync function ensureLogsDir(): Promise<void> {\n  try {\n    await fs.mkdir(LOGS_DIR, { recursive: true });\n  } catch {\n    // Directory might already exist, ignore\n  }\n}\n\n/**\n * Format a message for human-readable text output\n */\nfunction formatMessageForText(msg: Message): string {\n  const roleLabel = msg.role.toUpperCase();\n  const content = msg.content || '';\n\n  // Detect context messages (they start with [CONTEXT:)\n  const isContext = msg.role === 'user' && content.startsWith('[CONTEXT:');\n  const label = isContext ? `[USER - CONTEXT]` : `[${roleLabel}]`;\n\n  return `${label}\\n${content}`;\n}\n\n/**\n * Generate human-readable text log content\n */\nfunction generateTextLog(\n  agentName: string,\n  timestamp: string,\n  input: string,\n  messages: Message[],\n  output: unknown\n): string {\n  const separator = '='.repeat(80);\n  const lines: string[] = [\n    separator,\n    `AGENT: ${agentName}`,\n    `TIMESTAMP: ${timestamp}`,\n    `INPUT: ${input}`,\n    separator,\n    '',\n    '--- MESSAGES ARRAY ---',\n    '',\n  ];\n\n  // Add each message\n  messages.forEach((msg) => {\n    lines.push(formatMessageForText(msg));\n    lines.push('');\n  });\n\n  lines.push('--- OUTPUT ---');\n  lines.push(typeof output === 'string' ? output : JSON.stringify(output, null, 2));\n  lines.push(separator);\n\n  return lines.join('\\n');\n}\n\n/**\n * Generate JSON log content\n */\nfunction generateJsonLog(\n  agentName: string,\n  timestamp: string,\n  input: string,\n  messages: Message[],\n  output: unknown\n): string {\n  return JSON.stringify(\n    {\n      timestamp,\n      agentName,\n      input,\n      messages,\n      output,\n    },\n    null,\n    2\n  );\n}\n\n/**\n * Log an agent invocation to files\n *\n * This function is fire-and-forget - it does not block agent execution\n * and silently catches any errors to prevent logging from affecting the agent.\n *\n * @param agentName - Name of the agent\n * @param input - Raw input string passed to the agent\n * @param messages - Built messages array (system, context, previous, user)\n * @param output - Agent output (string or structured data)\n */\nexport function logAgentInvocation(\n  agentName: string,\n  input: string,\n  messages: Message[],\n  output: unknown\n): void {\n  // Skip if logging is disabled\n  if (!isLoggingEnabled()) {\n    return;\n  }\n\n  // Fire-and-forget async logging\n  (async () => {\n    try {\n      await ensureLogsDir();\n\n      const timestamp = generateTimestamp();\n      const isoTimestamp = new Date().toISOString();\n      const baseFilename = `${agentName}_${timestamp}`;\n\n      // Write both JSON and TXT files in parallel\n      await Promise.all([\n        fs.writeFile(\n          path.join(LOGS_DIR, `${baseFilename}.json`),\n          generateJsonLog(agentName, isoTimestamp, input, messages, output),\n          'utf-8'\n        ),\n        fs.writeFile(\n          path.join(LOGS_DIR, `${baseFilename}.txt`),\n          generateTextLog(agentName, isoTimestamp, input, messages, output),\n          'utf-8'\n        ),\n      ]);\n    } catch (error) {\n      // Silently ignore logging errors to not affect agent execution\n      console.error('[AgentLogger] Failed to write log:', error);\n    }\n  })();\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;;;;AAEA,MAAM,WAAW,yGAAS,CAAC,QAAQ,GAAG,IAAI;AAE1C;;CAEC,GACD,SAAS;IACP,OAAO,IAAA,2LAAe,IAAG,YAAY;AACvC;AAEA;;;CAGC,GACD,SAAS;IACP,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,IAAI,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;IAC5C,MAAM,OAAO,IAAI,YAAY,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM;IAC5D,MAAM,KAAK,IAAI,eAAe,GAAG,QAAQ,GAAG,QAAQ,CAAC,GAAG;IACxD,OAAO,GAAG,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,IAAI;AAChC;AAEA;;CAEC,GACD,eAAe;IACb,IAAI;QACF,MAAM,8HAAQ,CAAC,UAAU;YAAE,WAAW;QAAK;IAC7C,EAAE,OAAM;IACN,wCAAwC;IAC1C;AACF;AAEA;;CAEC,GACD,SAAS,qBAAqB,GAAY;IACxC,MAAM,YAAY,IAAI,IAAI,CAAC,WAAW;IACtC,MAAM,UAAU,IAAI,OAAO,IAAI;IAE/B,sDAAsD;IACtD,MAAM,YAAY,IAAI,IAAI,KAAK,UAAU,QAAQ,UAAU,CAAC;IAC5D,MAAM,QAAQ,YAAY,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,EAAE,UAAU,CAAC,CAAC;IAE/D,OAAO,GAAG,MAAM,EAAE,EAAE,SAAS;AAC/B;AAEA;;CAEC,GACD,SAAS,gBACP,SAAiB,EACjB,SAAiB,EACjB,KAAa,EACb,QAAmB,EACnB,MAAe;IAEf,MAAM,YAAY,IAAI,MAAM,CAAC;IAC7B,MAAM,QAAkB;QACtB;QACA,CAAC,OAAO,EAAE,WAAW;QACrB,CAAC,WAAW,EAAE,WAAW;QACzB,CAAC,OAAO,EAAE,OAAO;QACjB;QACA;QACA;QACA;KACD;IAED,mBAAmB;IACnB,SAAS,OAAO,CAAC,CAAC;QAChB,MAAM,IAAI,CAAC,qBAAqB;QAChC,MAAM,IAAI,CAAC;IACb;IAEA,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC,OAAO,WAAW,WAAW,SAAS,KAAK,SAAS,CAAC,QAAQ,MAAM;IAC9E,MAAM,IAAI,CAAC;IAEX,OAAO,MAAM,IAAI,CAAC;AACpB;AAEA;;CAEC,GACD,SAAS,gBACP,SAAiB,EACjB,SAAiB,EACjB,KAAa,EACb,QAAmB,EACnB,MAAe;IAEf,OAAO,KAAK,SAAS,CACnB;QACE;QACA;QACA;QACA;QACA;IACF,GACA,MACA;AAEJ;AAaO,SAAS,mBACd,SAAiB,EACjB,KAAa,EACb,QAAmB,EACnB,MAAe;IAEf,8BAA8B;IAC9B,IAAI,CAAC,oBAAoB;QACvB;IACF;IAEA,gCAAgC;IAChC,CAAC;QACC,IAAI;YACF,MAAM;YAEN,MAAM,YAAY;YAClB,MAAM,eAAe,IAAI,OAAO,WAAW;YAC3C,MAAM,eAAe,GAAG,UAAU,CAAC,EAAE,WAAW;YAEhD,4CAA4C;YAC5C,MAAM,QAAQ,GAAG,CAAC;gBAChB,kIAAY,CACV,yGAAS,CAAC,UAAU,GAAG,aAAa,KAAK,CAAC,GAC1C,gBAAgB,WAAW,cAAc,OAAO,UAAU,SAC1D;gBAEF,kIAAY,CACV,yGAAS,CAAC,UAAU,GAAG,aAAa,IAAI,CAAC,GACzC,gBAAgB,WAAW,cAAc,OAAO,UAAU,SAC1D;aAEH;QACH,EAAE,OAAO,OAAO;YACd,+DAA+D;YAC/D,QAAQ,KAAK,CAAC,sCAAsC;QACtD;IACF,CAAC;AACH"}},
    {"offset": {"line": 1541, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/promptRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { Prompt, NewPrompt, PromptRole, PromptPair } from '@/server/models/prompt';\n\n/**\n * PromptRepository - Data access layer for agent prompts\n *\n * Insert-only design for versioning: each update creates a new row,\n * providing full audit trail and ability to revert.\n */\nexport class PromptRepository extends BaseRepository {\n  /**\n   * Get both system and user prompts for an agent (most recent of each)\n   */\n  async getPromptPair(id: string): Promise<PromptPair | null> {\n    const prompts = await this.db\n      .selectFrom('prompts')\n      .where('id', '=', id)\n      .orderBy('createdAt', 'desc')\n      .selectAll()\n      .execute();\n\n    if (prompts.length === 0) return null;\n\n    // Get the most recent of each role\n    const system = prompts.find((p) => p.role === 'system');\n    const user = prompts.find((p) => p.role === 'user');\n\n    if (!system) return null;\n\n    return {\n      systemPrompt: system.value,\n      userPrompt: user?.value ?? null,\n    };\n  }\n\n  /**\n   * Get the most recent system prompt for an agent\n   */\n  async getSystemPrompt(id: string): Promise<string | null> {\n    const prompt = await this.db\n      .selectFrom('prompts')\n      .where('id', '=', id)\n      .where('role', '=', 'system')\n      .orderBy('createdAt', 'desc')\n      .limit(1)\n      .select('value')\n      .executeTakeFirst();\n\n    return prompt?.value ?? null;\n  }\n\n  /**\n   * Get the most recent user prompt for an agent (if exists)\n   */\n  async getUserPrompt(id: string): Promise<string | null> {\n    const prompt = await this.db\n      .selectFrom('prompts')\n      .where('id', '=', id)\n      .where('role', '=', 'user')\n      .orderBy('createdAt', 'desc')\n      .limit(1)\n      .select('value')\n      .executeTakeFirst();\n\n    return prompt?.value ?? null;\n  }\n\n  /**\n   * Get the most recent context prompt for an agent (if exists)\n   */\n  async getContextPrompt(id: string): Promise<string | null> {\n    const prompt = await this.db\n      .selectFrom('prompts')\n      .where('id', '=', id)\n      .where('role', '=', 'context')\n      .orderBy('createdAt', 'desc')\n      .limit(1)\n      .select('value')\n      .executeTakeFirst();\n\n    return prompt?.value ?? null;\n  }\n\n  /**\n   * Create a new prompt version (insert-only)\n   */\n  async createPrompt(newPrompt: NewPrompt): Promise<Prompt> {\n    return this.db\n      .insertInto('prompts')\n      .values(newPrompt)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Bulk insert prompts (for seeding)\n   */\n  async createPrompts(prompts: NewPrompt[]): Promise<void> {\n    if (prompts.length === 0) return;\n    await this.db.insertInto('prompts').values(prompts).execute();\n  }\n\n  /**\n   * Get prompt history for an agent and role\n   */\n  async getPromptHistory(\n    id: string,\n    role: PromptRole,\n    limit: number = 10\n  ): Promise<Prompt[]> {\n    return this.db\n      .selectFrom('prompts')\n      .where('id', '=', id)\n      .where('role', '=', role)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .selectAll()\n      .execute();\n  }\n\n  /**\n   * Get all unique prompt IDs (for listing available agents)\n   */\n  async getAllPromptIds(): Promise<string[]> {\n    const results = await this.db\n      .selectFrom('prompts')\n      .select('id')\n      .distinct()\n      .execute();\n\n    return results.map((r) => r.id);\n  }\n}\n\nexport const promptRepository = new PromptRepository();\n"],"names":[],"mappings":";;;;;;AAAA;;AASO,MAAM,yBAAyB,yLAAc;IAClD;;GAEC,GACD,MAAM,cAAc,EAAU,EAA8B;QAC1D,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,WACX,KAAK,CAAC,MAAM,KAAK,IACjB,OAAO,CAAC,aAAa,QACrB,SAAS,GACT,OAAO;QAEV,IAAI,QAAQ,MAAM,KAAK,GAAG,OAAO;QAEjC,mCAAmC;QACnC,MAAM,SAAS,QAAQ,IAAI,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;QAC9C,MAAM,OAAO,QAAQ,IAAI,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;QAE5C,IAAI,CAAC,QAAQ,OAAO;QAEpB,OAAO;YACL,cAAc,OAAO,KAAK;YAC1B,YAAY,MAAM,SAAS;QAC7B;IACF;IAEA;;GAEC,GACD,MAAM,gBAAgB,EAAU,EAA0B;QACxD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,WACX,KAAK,CAAC,MAAM,KAAK,IACjB,KAAK,CAAC,QAAQ,KAAK,UACnB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,GACN,MAAM,CAAC,SACP,gBAAgB;QAEnB,OAAO,QAAQ,SAAS;IAC1B;IAEA;;GAEC,GACD,MAAM,cAAc,EAAU,EAA0B;QACtD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,WACX,KAAK,CAAC,MAAM,KAAK,IACjB,KAAK,CAAC,QAAQ,KAAK,QACnB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,GACN,MAAM,CAAC,SACP,gBAAgB;QAEnB,OAAO,QAAQ,SAAS;IAC1B;IAEA;;GAEC,GACD,MAAM,iBAAiB,EAAU,EAA0B;QACzD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,WACX,KAAK,CAAC,MAAM,KAAK,IACjB,KAAK,CAAC,QAAQ,KAAK,WACnB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,GACN,MAAM,CAAC,SACP,gBAAgB;QAEnB,OAAO,QAAQ,SAAS;IAC1B;IAEA;;GAEC,GACD,MAAM,aAAa,SAAoB,EAAmB;QACxD,OAAO,IAAI,CAAC,EAAE,CACX,UAAU,CAAC,WACX,MAAM,CAAC,WACP,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;GAEC,GACD,MAAM,cAAc,OAAoB,EAAiB;QACvD,IAAI,QAAQ,MAAM,KAAK,GAAG;QAC1B,MAAM,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,WAAW,MAAM,CAAC,SAAS,OAAO;IAC7D;IAEA;;GAEC,GACD,MAAM,iBACJ,EAAU,EACV,IAAgB,EAChB,QAAgB,EAAE,EACC;QACnB,OAAO,IAAI,CAAC,EAAE,CACX,UAAU,CAAC,WACX,KAAK,CAAC,MAAM,KAAK,IACjB,KAAK,CAAC,QAAQ,KAAK,MACnB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,OACN,SAAS,GACT,OAAO;IACZ;IAEA;;GAEC,GACD,MAAM,kBAAqC;QACzC,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,WACX,MAAM,CAAC,MACP,QAAQ,GACR,OAAO;QAEV,OAAO,QAAQ,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;IAChC;AACF;AAEO,MAAM,mBAAmB,IAAI"}},
    {"offset": {"line": 1610, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/prompts/promptService.ts"],"sourcesContent":["import { promptRepository } from '@/server/repositories/promptRepository';\nimport type { PromptPair } from '@/server/models/prompt';\n\ninterface CacheEntry<T> {\n  data: T;\n  expiresAt: number;\n}\n\nconst CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\n/**\n * PromptService - Manages prompt retrieval with caching\n *\n * Features:\n * - TTL-based in-memory cache (5 minutes)\n * - Throws if prompt not found (all prompts must be seeded)\n * - Singleton pattern for consistent cache state\n */\nexport class PromptService {\n  private static instance: PromptService;\n  private cache: Map<string, CacheEntry<PromptPair>> = new Map();\n  private contextCache: Map<string, CacheEntry<string>> = new Map();\n\n  private constructor() {}\n\n  public static getInstance(): PromptService {\n    if (!PromptService.instance) {\n      PromptService.instance = new PromptService();\n    }\n    return PromptService.instance;\n  }\n\n  /**\n   * Get prompts for an agent, using cache when available\n   *\n   * @throws Error if prompt not found (prompts must be seeded)\n   */\n  async getPrompts(agentId: string): Promise<PromptPair> {\n    // Check cache first\n    const cached = this.cache.get(agentId);\n    if (cached && cached.expiresAt > Date.now()) {\n      return cached.data;\n    }\n\n    // Fetch from database\n    const prompts = await promptRepository.getPromptPair(agentId);\n\n    if (!prompts) {\n      throw new Error(\n        `Prompt not found for agent '${agentId}'. ` +\n          `All prompts must be seeded before use. Run the prompt seeding migration.`\n      );\n    }\n\n    // Update cache\n    this.cache.set(agentId, {\n      data: prompts,\n      expiresAt: Date.now() + CACHE_TTL_MS,\n    });\n\n    return prompts;\n  }\n\n  /**\n   * Get context prompt for an agent, using cache when available\n   *\n   * @returns The context prompt value, or null if not found\n   */\n  async getContextPrompt(agentId: string): Promise<string | null> {\n    const cacheKey = `${agentId}:context`;\n\n    // Check cache first\n    const cached = this.contextCache.get(cacheKey);\n    if (cached && cached.expiresAt > Date.now()) {\n      return cached.data;\n    }\n\n    // Fetch from database\n    const value = await promptRepository.getContextPrompt(agentId);\n\n    if (value !== null) {\n      // Update cache\n      this.contextCache.set(cacheKey, {\n        data: value,\n        expiresAt: Date.now() + CACHE_TTL_MS,\n      });\n    }\n\n    return value;\n  }\n\n  /**\n   * Invalidate cache for a specific agent (useful after updates)\n   */\n  invalidateCache(agentId: string): void {\n    this.cache.delete(agentId);\n    this.contextCache.delete(`${agentId}:context`);\n  }\n\n  /**\n   * Clear entire cache (useful for testing or force refresh)\n   */\n  clearCache(): void {\n    this.cache.clear();\n    this.contextCache.clear();\n  }\n}\n\nexport const promptService = PromptService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;;AAQA,MAAM,eAAe,IAAI,KAAK,MAAM,YAAY;AAUzC,MAAM;IACX,OAAe,SAAwB;IAC/B,QAA6C,IAAI,MAAM;IACvD,eAAgD,IAAI,MAAM;IAElE,aAAsB,CAAC;IAEvB,OAAc,cAA6B;QACzC,IAAI,CAAC,cAAc,QAAQ,EAAE;YAC3B,cAAc,QAAQ,GAAG,IAAI;QAC/B;QACA,OAAO,cAAc,QAAQ;IAC/B;IAEA;;;;GAIC,GACD,MAAM,WAAW,OAAe,EAAuB;QACrD,oBAAoB;QACpB,MAAM,SAAS,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAC9B,IAAI,UAAU,OAAO,SAAS,GAAG,KAAK,GAAG,IAAI;YAC3C,OAAO,OAAO,IAAI;QACpB;QAEA,sBAAsB;QACtB,MAAM,UAAU,MAAM,6LAAgB,CAAC,aAAa,CAAC;QAErD,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,MACR,CAAC,4BAA4B,EAAE,QAAQ,GAAG,CAAC,GACzC,CAAC,wEAAwE,CAAC;QAEhF;QAEA,eAAe;QACf,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,SAAS;YACtB,MAAM;YACN,WAAW,KAAK,GAAG,KAAK;QAC1B;QAEA,OAAO;IACT;IAEA;;;;GAIC,GACD,MAAM,iBAAiB,OAAe,EAA0B;QAC9D,MAAM,WAAW,GAAG,QAAQ,QAAQ,CAAC;QAErC,oBAAoB;QACpB,MAAM,SAAS,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC;QACrC,IAAI,UAAU,OAAO,SAAS,GAAG,KAAK,GAAG,IAAI;YAC3C,OAAO,OAAO,IAAI;QACpB;QAEA,sBAAsB;QACtB,MAAM,QAAQ,MAAM,6LAAgB,CAAC,gBAAgB,CAAC;QAEtD,IAAI,UAAU,MAAM;YAClB,eAAe;YACf,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,UAAU;gBAC9B,MAAM;gBACN,WAAW,KAAK,GAAG,KAAK;YAC1B;QACF;QAEA,OAAO;IACT;IAEA;;GAEC,GACD,gBAAgB,OAAe,EAAQ;QACrC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;QAClB,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,GAAG,QAAQ,QAAQ,CAAC;IAC/C;IAEA;;GAEC,GACD,aAAmB;QACjB,IAAI,CAAC,KAAK,CAAC,KAAK;QAChB,IAAI,CAAC,YAAY,CAAC,KAAK;IACzB;AACF;AAEO,MAAM,gBAAgB,cAAc,WAAW"}},
    {"offset": {"line": 1692, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/createAgent.ts"],"sourcesContent":["import type { ZodSchema } from 'zod';\nimport { initializeModel, type InvokableModel } from './models';\nimport type {\n  AgentDefinition,\n  ModelConfig,\n  ConfigurableAgent,\n  InferSchemaOutput,\n  AgentComposedOutput,\n  SubAgentBatch,\n} from './types';\nimport { buildMessages } from './utils';\nimport { executeSubAgents } from './subAgentExecutor';\nimport { executeToolLoop } from './toolExecutor';\nimport { logAgentInvocation } from './logger';\nimport { promptService } from '@/server/services/prompts/promptService';\n\n/**\n * Create a configurable agent from a definition and model config\n *\n * This factory function creates agents declaratively, supporting:\n * - Structured output via Zod schemas\n * - Optional userPrompt transformer for input strings\n * - Pre-computed context messages\n * - Tool-based agents with agentic loops\n * - Composed agents with parallel/sequential subAgents\n * - Database-backed prompts (fetched if systemPrompt not provided)\n *\n * @param definition - The agent's declarative configuration\n * @param config - Optional model configuration\n * @returns A Promise resolving to a ConfigurableAgent that can be invoked with a string\n *\n * @example\n * ```typescript\n * // Agent with DB-stored prompts (systemPrompt fetched from database)\n * const messageAgent = await createAgent({\n *   name: 'workout-message',\n *   context: [`<Profile>${user.profile}</Profile>`],\n *   schema: MessageSchema,\n * }, { model: 'gpt-5-nano' });\n *\n * await messageAgent.invoke('Generate a motivational workout message');\n *\n * // Agent with explicit systemPrompt (legacy pattern, bypasses DB)\n * const workoutAgent = await createAgent({\n *   name: 'workout',\n *   systemPrompt: SYSTEM_PROMPT,\n *   userPrompt: (input) => `Create workout based on: ${input}`,\n *   context: [profileContext, historyContext],\n *   subAgents: [\n *     { structured: structuredAgent, message: messageAgent },\n *     { validation: validationAgent }\n *   ]\n * }, { model: 'gpt-5.1' });\n *\n * await workoutAgent.invoke('upper body strength');\n * ```\n */\nexport async function createAgent<\n  TSchema extends ZodSchema | undefined = undefined,\n  TSubAgents extends SubAgentBatch[] | undefined = undefined\n>(\n  definition: AgentDefinition<TSchema>,\n  config?: ModelConfig\n): Promise<ConfigurableAgent<AgentComposedOutput<InferSchemaOutput<TSchema>, TSubAgents>>> {\n\n  const {\n    name,\n    systemPrompt: providedSystemPrompt,\n    userPrompt: providedUserPrompt,\n    context = [],\n    previousMessages = [],\n    tools,\n    schema,\n    subAgents = [],\n  } = definition;\n\n  // Fetch prompts from database if systemPrompt not provided directly\n  let systemPrompt = providedSystemPrompt;\n  let dbUserPrompt: string | null = null;\n\n  if (!systemPrompt) {\n    const prompts = await promptService.getPrompts(name);\n    systemPrompt = prompts.systemPrompt;\n    dbUserPrompt = prompts.userPrompt;\n  }\n\n  const { maxIterations = 5 } = config || {};\n\n  // Determine if this is a tool-based agent\n  const isToolAgent = tools && tools.length > 0;\n\n  // Initialize the model appropriately\n  // Tools and schema are mutually exclusive - tools take precedence\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const model: InvokableModel<any> = isToolAgent\n    ? initializeModel(undefined, config, { tools })\n    : initializeModel(schema, config);\n\n  const invoke = async (input: string): Promise<AgentComposedOutput<InferSchemaOutput<TSchema>, TSubAgents>> => {\n    const startTime = Date.now();\n    console.log(`[${name}] Starting execution`);\n\n    try {\n      // Determine the final user message:\n      // 1. If userPrompt function provided, use it to transform input\n      // 2. Else if DB user prompt exists, prepend it to input\n      // 3. Else input IS the user message directly\n      let evaluatedUserPrompt: string;\n\n      if (providedUserPrompt) {\n        evaluatedUserPrompt = providedUserPrompt(input);\n      } else if (dbUserPrompt) {\n        // DB user prompt is a template that precedes the actual user input\n        evaluatedUserPrompt = `${dbUserPrompt}\\n\\n${input}`;\n      } else {\n        evaluatedUserPrompt = input;\n      }\n\n      // Build messages with context and previous conversation history\n      const messages = buildMessages({\n        systemPrompt,\n        userPrompt: evaluatedUserPrompt,\n        context,\n        previousMessages,\n      });\n\n      // Execute main agent\n      let mainResult: InferSchemaOutput<TSchema>;\n      let accumulatedMessages: string[] = [];\n\n      if (isToolAgent) {\n        const toolResult = await executeToolLoop({\n          model,\n          messages,\n          tools: tools!,\n          name,\n          maxIterations,\n        });\n        mainResult = toolResult.response as InferSchemaOutput<TSchema>;\n        accumulatedMessages = toolResult.messages;\n      } else {\n        mainResult = await model.invoke(messages) as InferSchemaOutput<TSchema>;\n      }\n\n      // Log the agent invocation (fire-and-forget, won't block execution)\n      logAgentInvocation(name, input, messages, mainResult);\n\n      console.log(`[${name}] Main agent completed in ${Date.now() - startTime}ms`);\n\n      // If no subAgents, return main result wrapped in response (with messages if any)\n      if (!subAgents || subAgents.length === 0) {\n        return {\n          response: mainResult,\n          ...(accumulatedMessages.length > 0 ? { messages: accumulatedMessages } : {}),\n        } as AgentComposedOutput<InferSchemaOutput<TSchema>, TSubAgents>;\n      }\n\n      // Execute subAgents with the main response as their input\n      // Convert mainResult to string if needed for subAgent invocation\n      const responseString = typeof mainResult === 'string'\n        ? mainResult\n        : JSON.stringify(mainResult);\n\n      const subAgentResults = await executeSubAgents({\n        batches: subAgents,\n        input: responseString,\n        previousResults: { response: mainResult },\n        parentName: name,\n      });\n\n      console.log(`[${name}] Total execution time: ${Date.now() - startTime}ms`);\n\n      // Combine main result with subAgent results (and messages if any)\n      return {\n        response: mainResult,\n        ...(accumulatedMessages.length > 0 ? { messages: accumulatedMessages } : {}),\n        ...subAgentResults,\n      } as AgentComposedOutput<InferSchemaOutput<TSchema>, TSubAgents>;\n\n    } catch (error) {\n      console.error(`[${name}] Execution failed:`, error);\n      throw error;\n    }\n  };\n\n  return {\n    invoke,\n    name,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1813, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/promptIds.ts"],"sourcesContent":["/**\n * Agent Prompt IDs\n *\n * Use these constants in createAgent calls and migrations.\n * TypeScript will catch typos at compile time.\n */\n\n// Core agents requiring system + optional user prompts\nexport const PROMPT_IDS = {\n  // Chat\n  CHAT_GENERATE: 'chat:generate',\n\n  // Profile\n  PROFILE_FITNESS: 'profile:fitness',\n  PROFILE_STRUCTURED: 'profile:structured',\n  PROFILE_USER: 'profile:user',\n\n  // Plans\n  PLAN_GENERATE: 'plan:generate',\n  PLAN_STRUCTURED: 'plan:structured',\n  PLAN_MESSAGE: 'plan:message',\n  PLAN_MODIFY: 'plan:modify',\n\n  // Workouts\n  WORKOUT_GENERATE: 'workout:generate',\n  WORKOUT_STRUCTURED: 'workout:structured',\n  WORKOUT_MESSAGE: 'workout:message',\n  WORKOUT_MODIFY: 'workout:modify',\n\n  // Microcycles\n  MICROCYCLE_GENERATE: 'microcycle:generate',\n  MICROCYCLE_STRUCTURED: 'microcycle:structured',\n  MICROCYCLE_MESSAGE: 'microcycle:message',\n  MICROCYCLE_MODIFY: 'microcycle:modify',\n\n  // Modifications\n  MODIFICATIONS_ROUTER: 'modifications:router',\n} as const;\n\n// Context prompts (role='context')\nexport const CONTEXT_IDS = {\n  // Day format\n  WORKOUT_FORMAT_TRAINING: 'workout:message:format:training',\n  WORKOUT_FORMAT_ACTIVE_RECOVERY: 'workout:message:format:active_recovery',\n  WORKOUT_FORMAT_REST: 'workout:message:format:rest',\n\n  // Experience levels - Microcycles\n  MICROCYCLE_EXP_BEGINNER: 'microcycle:generate:experience:beginner',\n  MICROCYCLE_EXP_INTERMEDIATE: 'microcycle:generate:experience:intermediate',\n  MICROCYCLE_EXP_ADVANCED: 'microcycle:generate:experience:advanced',\n\n  // Experience levels - Workouts\n  WORKOUT_EXP_BEGINNER: 'workout:generate:experience:beginner',\n  WORKOUT_EXP_INTERMEDIATE: 'workout:generate:experience:intermediate',\n  WORKOUT_EXP_ADVANCED: 'workout:generate:experience:advanced',\n} as const;\n\n// Prompt roles\nexport const PROMPT_ROLES = {\n  SYSTEM: 'system',\n  USER: 'user',\n  CONTEXT: 'context',\n} as const;\n\nexport type PromptId = (typeof PROMPT_IDS)[keyof typeof PROMPT_IDS];\nexport type ContextId = (typeof CONTEXT_IDS)[keyof typeof CONTEXT_IDS];\nexport type PromptRole = (typeof PROMPT_ROLES)[keyof typeof PROMPT_ROLES];\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED,uDAAuD;;;;;;;;;AAChD,MAAM,aAAa;IACxB,OAAO;IACP,eAAe;IAEf,UAAU;IACV,iBAAiB;IACjB,oBAAoB;IACpB,cAAc;IAEd,QAAQ;IACR,eAAe;IACf,iBAAiB;IACjB,cAAc;IACd,aAAa;IAEb,WAAW;IACX,kBAAkB;IAClB,oBAAoB;IACpB,iBAAiB;IACjB,gBAAgB;IAEhB,cAAc;IACd,qBAAqB;IACrB,uBAAuB;IACvB,oBAAoB;IACpB,mBAAmB;IAEnB,gBAAgB;IAChB,sBAAsB;AACxB;AAGO,MAAM,cAAc;IACzB,aAAa;IACb,yBAAyB;IACzB,gCAAgC;IAChC,qBAAqB;IAErB,kCAAkC;IAClC,yBAAyB;IACzB,6BAA6B;IAC7B,yBAAyB;IAEzB,+BAA+B;IAC/B,sBAAsB;IACtB,0BAA0B;IAC1B,sBAAsB;AACxB;AAGO,MAAM,eAAe;IAC1B,QAAQ;IACR,MAAM;IACN,SAAS;AACX"}},
    {"offset": {"line": 1875, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/agents/index.ts"],"sourcesContent":["/**\n * Configurable Agent System\n *\n * A declarative, composable way to define AI agents.\n * This is the primary way to create agents in the codebase.\n *\n * @example\n * ```typescript\n * import { createAgent } from '@/server/agents';\n *\n * const myAgent = createAgent({\n *   name: 'my-agent',\n *   systemPrompt: 'You are a helpful assistant.',\n *   userPrompt: (input) => `Help with: ${input}`,\n *   schema: OutputSchema,\n * }, {\n *   model: 'gpt-5-nano',\n *   maxTokens: 4000,\n * });\n *\n * const result = await myAgent.invoke('something');\n * // result.response contains the schema-typed output\n * ```\n */\n\n// ============================================\n// Main Agent Factory\n// ============================================\nexport { createAgent } from './createAgent';\n\n// ============================================\n// Prompt IDs (use these in createAgent calls)\n// ============================================\nexport { PROMPT_IDS, CONTEXT_IDS, PROMPT_ROLES } from './promptIds';\nexport type { PromptId, ContextId, PromptRole } from './promptIds';\n\n// ============================================\n// Model Initialization\n// ============================================\nexport { initializeModel, initializeImageModel } from './models';\nexport type { ModelOptions, ImageModelConfig, ImageGenerationResult, InvokableModel } from './models';\n\n// ============================================\n// Types\n// ============================================\nexport type {\n  // Base agent types\n  AgentConfig,\n  AgentDeps,\n  Agent,\n  ToolType,\n  ToolResult,\n\n  // Configurable agent types\n  AgentDefinition,\n  ModelConfig,\n  ConfigurableAgent,\n  SubAgentBatch,\n  SubAgentEntry,\n  SubAgentConfig,\n  ModelId,\n\n  // Output types\n  InferSchemaOutput,\n  AgentComposedOutput,\n\n  // Message types\n  Message,\n  ToolCall,\n  ToolExecutionResult,\n} from './types';\n\n// ============================================\n// Utilities\n// ============================================\nexport { buildMessages, buildLoopContinuationMessage } from './utils';\nexport type { BuildMessagesConfig } from './utils';\n\n// ============================================\n// Executors (for advanced use cases)\n// ============================================\nexport { executeSubAgents } from './subAgentExecutor';\nexport type { SubAgentExecutorConfig } from './subAgentExecutor';\n\nexport { executeToolLoop } from './toolExecutor';\nexport type { ToolLoopConfig, ToolLoopResult, ToolCallRecord } from './toolExecutor';\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;CAuBC,GAED,+CAA+C;AAC/C,qBAAqB;AACrB,+CAA+C;;AAC/C;AAEA,+CAA+C;AAC/C,8CAA8C;AAC9C,+CAA+C;AAC/C;AAGA,+CAA+C;AAC/C,uBAAuB;AACvB,+CAA+C;AAC/C;AAiCA,+CAA+C;AAC/C,YAAY;AACZ,+CAA+C;AAC/C;AAGA,+CAA+C;AAC/C,qCAAqC;AACrC,+CAA+C;AAC/C;AAGA"}},
    {"offset": {"line": 1930, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/workoutStructure.ts"],"sourcesContent":["import { z } from \"zod\";\n\n/**\n * Workout Structure Schemas\n *\n * These schemas define the structured workout format used for:\n * - LLM-generated workout outputs\n * - UI rendering of workout details\n * - Storing structured workout data\n */\n\n/**\n * Intensity descriptor for exercises\n * Default values used to ensure no nulls reach the UI.\n */\nexport const IntensitySchema = z.object({\n  type: z.enum([\"RPE\", \"RIR\", \"Percentage\", \"Zone\", \"HeartRate\", \"Pace\", \"Other\"]).default(\"Other\"),\n  value: z.string().describe(\"e.g., '7-8', '2', '75%', 'Zone 2', '150bpm'\").default(''),\n  description: z.string().describe(\"Context for the user\").default('')\n});\n\n/**\n * Individual workout activity/exercise\n * Flexible schema for Lifting, Cardio, and Hybrid sessions.\n */\nexport const WorkoutActivitySchema = z.object({\n  id: z.string().default(''),\n  name: z.string().describe(\"e.g. 'Back Squat' or 'Zone 2 Run'\"),\n  type: z.enum([\"Strength\", \"Cardio\", \"Plyometric\", \"Mobility\", \"Rest\", \"Other\"]).default(\"Strength\"),\n\n  // Metrics (Strings used for flexibility: \"4\", \"3-4\", \"AMRAP\")\n  sets: z.string().describe(\"e.g. '4' or '3-4'\").default(''),\n  reps: z.string().describe(\"e.g. '6-8' or '4 min'\").default(''),\n\n  // Cardio/Duration Specific\n  duration: z.string().describe(\"e.g. '45 min'\").default(''),\n  distance: z.string().describe(\"e.g. '5km'\").default(''),\n\n  // Common\n  rest: z.string().describe(\"e.g. '2-3 min'\").default(''),\n  intensity: IntensitySchema.default({ type: \"Other\", value: \"\", description: \"\" }),\n  tempo: z.string().describe(\"e.g. '3-0-1'\").default(''),\n\n  // Execution & Grouping\n  notes: z.string().describe(\"Execution cues\").default(''),\n  tags: z.array(z.string()).default([]),\n  supersetId: z.string().default('')\n});\n\n/**\n * Section of a workout (e.g., Warm Up, Main Lift, Cooldown)\n */\nexport const WorkoutSectionSchema = z.object({\n  title: z.string().describe(\"e.g. 'Warm Up', 'Main Lift'\"),\n  overview: z.string().describe(\"Brief goal of this section\").default(''),\n  exercises: z.array(WorkoutActivitySchema).default([])\n});\n\n/**\n * Complete workout structure\n */\nexport const WorkoutStructureSchema = z.object({\n  title: z.string().describe(\"Concise workout name, 2-4 words max (e.g. 'Pull A', 'Upper Strength', 'Leg Day')\"),\n  focus: z.string().describe(\"Brief focus area, 1-3 words (e.g. 'Back & Biceps', 'Quads', 'Push')\").default(''),\n  description: z.string().default(''),\n\n  // Optional flair\n  quote: z.object({\n    text: z.string().default(''),\n    author: z.string().default('')\n  }).default({ text: '', author: '' }),\n\n  // The actual programming\n  sections: z.array(WorkoutSectionSchema).default([]),\n\n  // Metadata\n  estimatedDurationMin: z.number().describe(\"Estimated minutes\").default(-1),\n  intensityLevel: z.enum([\"Low\", \"Moderate\", \"High\", \"Severe\"]).default(\"Moderate\")\n});\n\n// Inferred types\nexport type WorkoutStructure = z.infer<typeof WorkoutStructureSchema>;\nexport type WorkoutActivity = z.infer<typeof WorkoutActivitySchema>;\nexport type WorkoutSection = z.infer<typeof WorkoutSectionSchema>;\nexport type Intensity = z.infer<typeof IntensitySchema>;\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;;AAeO,MAAM,kBAAkB,0MAAC,CAAC,MAAM,CAAC;IACtC,MAAM,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAO;QAAO;QAAc;QAAQ;QAAa;QAAQ;KAAQ,EAAE,OAAO,CAAC;IACzF,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,+CAA+C,OAAO,CAAC;IAClF,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,wBAAwB,OAAO,CAAC;AACnE;AAMO,MAAM,wBAAwB,0MAAC,CAAC,MAAM,CAAC;IAC5C,IAAI,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IACvB,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,MAAM,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAY;QAAU;QAAc;QAAY;QAAQ;KAAQ,EAAE,OAAO,CAAC;IAExF,8DAA8D;IAC9D,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,qBAAqB,OAAO,CAAC;IACvD,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,yBAAyB,OAAO,CAAC;IAE3D,2BAA2B;IAC3B,UAAU,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,iBAAiB,OAAO,CAAC;IACvD,UAAU,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,cAAc,OAAO,CAAC;IAEpD,SAAS;IACT,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,kBAAkB,OAAO,CAAC;IACpD,WAAW,gBAAgB,OAAO,CAAC;QAAE,MAAM;QAAS,OAAO;QAAI,aAAa;IAAG;IAC/E,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,gBAAgB,OAAO,CAAC;IAEnD,uBAAuB;IACvB,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,kBAAkB,OAAO,CAAC;IACrD,MAAM,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,OAAO,CAAC,EAAE;IACpC,YAAY,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;AACjC;AAKO,MAAM,uBAAuB,0MAAC,CAAC,MAAM,CAAC;IAC3C,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,UAAU,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,8BAA8B,OAAO,CAAC;IACpE,WAAW,0MAAC,CAAC,KAAK,CAAC,uBAAuB,OAAO,CAAC,EAAE;AACtD;AAKO,MAAM,yBAAyB,0MAAC,CAAC,MAAM,CAAC;IAC7C,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,uEAAuE,OAAO,CAAC;IAC1G,aAAa,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAEhC,iBAAiB;IACjB,OAAO,0MAAC,CAAC,MAAM,CAAC;QACd,MAAM,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;QACzB,QAAQ,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC7B,GAAG,OAAO,CAAC;QAAE,MAAM;QAAI,QAAQ;IAAG;IAElC,yBAAyB;IACzB,UAAU,0MAAC,CAAC,KAAK,CAAC,sBAAsB,OAAO,CAAC,EAAE;IAElD,WAAW;IACX,sBAAsB,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC,qBAAqB,OAAO,CAAC,CAAC;IACxE,gBAAgB,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAO;QAAY;QAAQ;KAAS,EAAE,OAAO,CAAC;AACxE"}},
    {"offset": {"line": 2018, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/geminiSchema.ts"],"sourcesContent":["import { z } from \"zod\";\n\n/**\n * Gemini-compatible workout schemas\n *\n * Gemini's structured output doesn't support union types (e.g., string | null)\n * or .nullable().optional() combinations. This schema uses sentinel values instead:\n * - Empty string \"\" for unset string values\n * - -1 for unset numeric values (sets, reps, duration, RPE, percentageRM, etc.)\n * - Empty arrays [] for unset array values\n *\n * Post-processing will convert these sentinel values back to null for compatibility.\n */\n\n// Gemini-compatible workout block item schema\nexport const GeminiWorkoutBlockItemSchema = z.object({\n  type: z.enum(['prep', 'compound', 'secondary', 'accessory', 'core', 'cardio', 'cooldown'])\n    .describe(\"Type of exercise in the workout\"),\n  exercise: z.string().describe(\"Specific, actionable exercise name that a user can immediately perform (e.g., 'Band Pull-Aparts', 'Cat-Cow Stretch', 'Scapular Wall Slides'). Never use vague terms like 'mobility sequence' or 'dynamic warmup'.\"),\n  sets: z.number().describe(\"Number of sets (use -1 if not applicable)\"),\n  reps: z.string().describe(\"Number of reps (can be range like '6-8' or number like '10', use empty string if not applicable)\"),\n  durationSec: z.number().describe(\"Duration in seconds (use -1 if not applicable)\"),\n  durationMin: z.number().describe(\"Duration in minutes (use -1 if not applicable)\"),\n  RPE: z.number().describe(\"Rate of Perceived Exertion (1-10 scale, use -1 if not applicable)\"),\n  rir: z.number().describe(\"Reps in Reserve (typically 0-5, use -1 if not applicable)\"),\n  percentageRM: z.number().describe(\"Percentage of 1 Rep Max (0-100 scale, use -1 if not applicable)\"),\n  restSec: z.number().describe(\"Rest between sets in seconds (use -1 if not applicable)\"),\n  restText: z.string().describe(\"Readable rest instruction (e.g., '90s between supersets', use empty string if not applicable)\"),\n  equipment: z.string().describe(\"Equipment used (barbell, DB, band, etc., use empty string if not applicable)\"),\n  pattern: z.string().describe(\"Movement pattern label (e.g., 'horizontal_press', use empty string if not applicable)\"),\n  tempo: z.string().describe(\"Tempo prescription (e.g., '3-1-1', use empty string if not applicable)\"),\n  cues: z.array(z.string()).describe(\"Key coaching cues (use empty array if none)\"),\n  tags: z.array(z.string()).describe(\"Semantic tags for filtering/substitution (use empty array if none)\"),\n  notes: z.string().describe(\"Additional notes for the exercise (use empty string if no notes)\")\n}).strict();\n\n// Gemini-compatible workout work item schema (mid-level: straight, superset, or circuit)\nexport const GeminiWorkoutWorkItemSchema = z.object({\n  structureType: z.enum(['straight', 'superset', 'circuit'])\n    .describe(\"Defines how the exercises are grouped (straight = single exercise, superset = 2 exercises alternated, circuit = 3+ exercises)\"),\n  exercises: z.array(GeminiWorkoutBlockItemSchema).min(1)\n    .describe(\"One or more exercises (1 = straight, 2 = superset, 3+ = circuit)\"),\n  restBetweenExercisesSec: z.number()\n    .describe(\"Rest between exercises inside the superset/circuit in seconds (use -1 if not applicable)\"),\n  restAfterSetSec: z.number()\n    .describe(\"Rest between rounds or sets of this work item in seconds (use -1 if not applicable)\"),\n  rounds: z.number()\n    .describe(\"Number of times the group is repeated (for circuits, use -1 if not applicable)\"),\n  notes: z.string()\n    .describe(\"Extra details about the grouping (use empty string if no notes)\")\n}).strict();\n\nexport const GeminiWorkoutBlockSchema = z.object({\n  name: z.string().describe(\"Name of the workout block (e.g., 'Warm-Up', 'Main Lift', 'Accessory')\"),\n  goal: z.string().describe(\"Purpose of this block (use empty string if not applicable)\"),\n  durationMin: z.number().describe(\"Estimated duration in minutes (use -1 if not applicable)\"),\n  notes: z.string().describe(\"General notes for this block (use empty string if no notes)\"),\n  work: z.array(GeminiWorkoutWorkItemSchema)\n    .describe(\"The list of work items (straight, superset, or circuit) within this block\")\n}).strict();\n\nexport const GeminiWorkoutModificationSchema = z.object({\n  condition: z.string().describe(\"Condition that triggers this modification (e.g., 'injury.lower_back.active')\"),\n  replace: z.object({\n    exercise: z.string().describe(\"Exercise to replace\"),\n    with: z.string().describe(\"Replacement exercise\")\n  }).describe(\"Exercise replacement details (use empty strings if not applicable)\"),\n  adjustment: z.string().describe(\"Adjustment to make (e.g., 'reduce weight by 20%', use empty string if not applicable)\"),\n  note: z.string().describe(\"Explanation for the modification\")\n}).strict();\n\n// Gemini-compatible session context schema\nexport const GeminiWorkoutSessionContextSchema = z.object({\n  phaseName: z.string().describe(\"Name of the training phase (use empty string if not applicable)\"),\n  weekNumber: z.number().describe(\"Week number in the program (use -1 if not applicable)\"),\n  dayIndex: z.number().describe(\"Day index in the microcycle (use -1 if not applicable)\"),\n  goal: z.string().describe(\"Goal of the session (use empty string if not applicable)\"),\n  durationEstimateMin: z.number().describe(\"Estimated duration in minutes (use -1 if not applicable)\"),\n  environment: z.string().describe(\"Training environment (e.g., 'gym', 'home', use empty string if not applicable)\"),\n  clientConstraints: z.object({\n    timeAvailable: z.number().describe(\"Time available in minutes (use -1 if not applicable)\"),\n    equipmentAvailable: z.array(z.string()).describe(\"Available equipment (use empty array if not specified)\"),\n    injuries: z.array(z.string()).describe(\"Current injuries or limitations (use empty array if none)\"),\n    preferences: z.array(z.string()).describe(\"Client preferences (use empty array if not specified)\")\n  }).describe(\"Client-specific constraints for the session\")\n}).strict();\n\n// Gemini-compatible target metrics schema\nexport const GeminiWorkoutTargetMetricsSchema = z.object({\n  totalVolume: z.number().describe(\"Total volume in kg (use -1 if not applicable)\"),\n  totalReps: z.number().describe(\"Total reps across all exercises (use -1 if not applicable)\"),\n  totalSets: z.number().describe(\"Total sets across all exercises (use -1 if not applicable)\"),\n  totalDistance: z.number().describe(\"Total distance in km (use -1 if not applicable)\"),\n  totalDuration: z.number().describe(\"Total duration in minutes (use -1 if not applicable)\"),\n  averageRPE: z.number().describe(\"Average RPE across workout (use -1 if not applicable)\"),\n  averageIntensity: z.number().describe(\"Average intensity across workout (use -1 if not applicable)\")\n}).strict();\n\n// Gemini-compatible workout summary schema\nexport const GeminiWorkoutSummarySchema = z.object({\n  adaptations: z.array(z.string()).describe(\"Expected adaptations from this workout (use empty array if not specified)\"),\n  coachingNotes: z.string().describe(\"Coaching notes for the client (use empty string if no notes)\"),\n  progressionNotes: z.string().describe(\"Notes on progression strategy (use empty string if no notes)\"),\n  recoveryFocus: z.string().describe(\"Recovery focus areas (use empty string if not specified)\")\n}).strict();\n\n// Gemini-compatible enhanced workout instance schema\nexport const GeminiEnhancedWorkoutInstanceSchema = z.object({\n  theme: z.string().describe(\"Overall theme of the workout (e.g., 'Upper Push', 'Lower Power')\"),\n  sessionContext: GeminiWorkoutSessionContextSchema.describe(\"Metadata and context about the session\"),\n  blocks: z.array(GeminiWorkoutBlockSchema).describe(\"Structured blocks of the workout\"),\n  modifications: z.array(GeminiWorkoutModificationSchema).describe(\"Modifications for special conditions (use empty array if none)\"),\n  targetMetrics: GeminiWorkoutTargetMetricsSchema.describe(\"Target metrics for the workout\"),\n  summary: GeminiWorkoutSummarySchema.describe(\"Summary and meta reflections about the workout\"),\n  notes: z.string().describe(\"Additional notes for the workout (use empty string if no notes)\")\n}).strict();\n\n// Gemini schema with modifications tracking (for substitute/replace operations)\nexport const GeminiUpdatedWorkoutInstanceSchema = GeminiEnhancedWorkoutInstanceSchema.extend({\n  modificationsApplied: z.array(z.string()).describe(\"List of specific changes made to the workout (e.g., 'Replaced Barbell Bench Press with Dumbbell Bench Press due to no barbell available')\")\n}).strict();\n\n// Type exports\nexport type GeminiWorkoutBlockItem = z.infer<typeof GeminiWorkoutBlockItemSchema>;\nexport type GeminiWorkoutWorkItem = z.infer<typeof GeminiWorkoutWorkItemSchema>;\nexport type GeminiWorkoutBlock = z.infer<typeof GeminiWorkoutBlockSchema>;\nexport type GeminiWorkoutModification = z.infer<typeof GeminiWorkoutModificationSchema>;\nexport type GeminiWorkoutSessionContext = z.infer<typeof GeminiWorkoutSessionContextSchema>;\nexport type GeminiWorkoutTargetMetrics = z.infer<typeof GeminiWorkoutTargetMetricsSchema>;\nexport type GeminiWorkoutSummary = z.infer<typeof GeminiWorkoutSummarySchema>;\nexport type GeminiEnhancedWorkoutInstance = z.infer<typeof GeminiEnhancedWorkoutInstanceSchema>;\nexport type GeminiUpdatedWorkoutInstance = z.infer<typeof GeminiUpdatedWorkoutInstanceSchema>;\n\n/**\n * Converts Gemini sentinel values to null for compatibility with existing types\n * - Empty strings  null\n * - -1 values  null (for optional numeric fields)\n * - Empty arrays  null (for optional array fields)\n * - Empty replace objects  null\n * - Invalid numeric ranges  null (e.g., RPE > 10, percentageRM > 100)\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function convertGeminiToStandard<T extends Record<string, any>>(geminiOutput: T): any {\n  if (Array.isArray(geminiOutput)) {\n    return geminiOutput.map(convertGeminiToStandard);\n  }\n\n  if (geminiOutput && typeof geminiOutput === 'object') {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const result: any = {};\n\n    for (const [key, value] of Object.entries(geminiOutput)) {\n      // Handle empty strings\n      if (value === \"\") {\n        result[key] = null;\n      }\n      // Handle numeric sentinel value (-1 for optional fields)\n      else if (value === -1) {\n        result[key] = null;\n      }\n      // Validate RPE range (1-10)\n      else if (key === 'RPE' && typeof value === 'number') {\n        result[key] = (value >= 1 && value <= 10) ? value : null;\n      }\n      // Validate percentageRM range (0-100)\n      else if (key === 'percentageRM' && typeof value === 'number') {\n        result[key] = (value >= 0 && value <= 100) ? value : null;\n      }\n      // Validate rir (typically 0-5, but allow up to 10 for flexibility)\n      else if (key === 'rir' && typeof value === 'number') {\n        result[key] = (value >= 0 && value <= 10) ? value : null;\n      }\n      // Validate sets (should be positive)\n      else if (key === 'sets' && typeof value === 'number') {\n        result[key] = (value > 0) ? value : null;\n      }\n      // Validate duration fields (should be positive)\n      else if ((key === 'durationSec' || key === 'durationMin') && typeof value === 'number') {\n        result[key] = (value > 0) ? value : null;\n      }\n      // Validate rest fields (should be positive)\n      else if ((key === 'restSec' || key === 'restAfterSetSec' || key === 'restBetweenExercisesSec') && typeof value === 'number') {\n        result[key] = (value > 0) ? value : null;\n      }\n      // Validate rounds (should be positive)\n      else if (key === 'rounds' && typeof value === 'number') {\n        result[key] = (value > 0) ? value : null;\n      }\n      // Handle empty arrays (for optional array fields)\n      else if (Array.isArray(value) && value.length === 0 &&\n               (key === 'cues' || key === 'tags' || key === 'modifications' ||\n                key === 'adaptations' || key === 'equipmentAvailable' ||\n                key === 'injuries' || key === 'preferences')) {\n        result[key] = null;\n      }\n      // Handle empty replace objects\n      else if (key === 'replace' && typeof value === 'object' &&\n               value.exercise === \"\" && value.with === \"\") {\n        result[key] = null;\n      }\n      // Recursively process objects and arrays\n      else if (typeof value === 'object' && value !== null) {\n        result[key] = convertGeminiToStandard(value);\n      }\n      // Keep other values as-is\n      else {\n        result[key] = value;\n      }\n    }\n\n    return result;\n  }\n\n  return geminiOutput;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2184, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/openAISchema.ts"],"sourcesContent":["import { z } from \"zod\";\n\n/* \n   Lowest-level: individual exercise\n */\nexport const _WorkoutBlockItemSchema = z.object({\n  type: z.enum(['prep', 'compound', 'secondary', 'accessory', 'core', 'cardio', 'cooldown'])\n    .describe(\"Category of the movement or its role in the session.\"),\n  exercise: z.string().describe(\"Explicit exercise name (e.g., 'Barbell Back Squat').\"),\n  sets: z.number().nullish().describe(\"Number of sets.\"),\n  reps: z.string().nullish().describe(\"Reps (can be a range or a single value).\"),\n  durationSec: z.number().nullish().describe(\"Exercise duration in seconds.\"),\n  durationMin: z.number().nullish().describe(\"Exercise duration in minutes.\"),\n  RPE: z.number().min(1).max(10).nullish().describe(\"Rate of Perceived Exertion 110.\"),\n  rir: z.number().nullish().describe(\"Reps in Reserve (autoregulation measure).\"),\n  percentageRM: z.number().min(0).max(100).nullish().describe(\"Percent of 1RM load.\"),\n  restSec: z.number().nullish().describe(\"Rest between sets in seconds.\"),\n  restText: z.string().nullish().describe(\"Readable rest instruction, e.g. '90s between supersets'.\"),\n  equipment: z.string().nullish().describe(\"Equipment used (barbell, DB, band, etc.).\"),\n  pattern: z.string().nullish().describe(\"Movement pattern label (e.g., 'horizontal_press').\"),\n  tempo: z.string().nullish().describe(\"Tempo prescription, e.g. '3-1-1'.\"),\n  cues: z.array(z.string()).nullish().describe(\"Key coaching cues.\"),\n  tags: z.array(z.string()).nullish().describe(\"Semantic tags for filtering/substitution.\"),\n  notes: z.string().nullish().describe(\"Extra details or special instructions.\")\n}).strict();\n\n/* \n   Mid-level: a work item (straight, superset, or circuit)\n */\nexport const _WorkoutWorkItemSchema = z.object({\n  structureType: z.enum(['straight', 'superset', 'circuit']).default('straight')\n    .describe(\"Defines how the exercises are grouped.\"),\n  exercises: z.array(_WorkoutBlockItemSchema)\n    .min(1)\n    .describe(\"One or more exercises (1 = straight, 2 = superset, 3+ = circuit).\"),\n  restBetweenExercisesSec: z.number().nullish()\n    .describe(\"Rest between exercises inside the superset/circuit.\"),\n  restAfterSetSec: z.number().nullish()\n    .describe(\"Rest between rounds or sets of this work item.\"),\n  rounds: z.number().nullish().describe(\"Number of times the group is repeated (for circuits).\"),\n  notes: z.string().nullish().describe(\"Extra details about the grouping.\")\n}).strict();\n\n/* \n   Block level: a section of the workout\n */\nexport const _WorkoutBlockSchema = z.object({\n  name: z.string().describe(\"Name of the workout block (e.g., 'Warm-Up', 'Main Lift').\"),\n  goal: z.string().nullish().describe(\"Purpose of this block.\"),\n  durationMin: z.number().nullish().describe(\"Estimated duration in minutes.\"),\n  notes: z.string().nullish().describe(\"General notes for this block.\"),\n  work: z.array(_WorkoutWorkItemSchema)\n    .describe(\"The list of work items (straight, superset, or circuit) within this block.\")\n}).strict();\n\n/* \n   Modifications (injury/equipment/etc.)\n */\nexport const _WorkoutModificationSchema = z.object({\n  condition: z.string().describe(\"Trigger condition, e.g. 'injury.shoulder.active'.\"),\n  replace: z.object({\n    exercise: z.string().describe(\"Original exercise to replace.\"),\n    with: z.string().describe(\"Substitute exercise.\")\n  }).nullish(),\n  adjustment: z.string().nullish().describe(\"Other adjustments (e.g., reduce weight 20%).\"),\n  note: z.string().describe(\"Reason or context for this modification.\")\n}).strict();\n\n/* \n   Optional metadata/context about the session\n */\nexport const _WorkoutSessionContextSchema = z.object({\n  phaseName: z.string().nullish(),\n  weekNumber: z.number().nullish(),\n  dayIndex: z.number().nullish(),\n  goal: z.string().nullish(),\n  durationEstimateMin: z.number().nullish(),\n  environment: z.string().nullish(),\n  clientConstraints: z.object({\n    timeAvailable: z.number().nullish(),\n    equipmentAvailable: z.array(z.string()).nullish(),\n    injuries: z.array(z.string()).nullish(),\n    preferences: z.array(z.string()).nullish()\n  }).nullish()\n}).nullish();\n\n/* \n   Target metrics for analytics or progress\n */\nexport const _WorkoutTargetMetricsSchema = z.object({\n  totalVolume: z.number().nullish(),\n  totalReps: z.number().nullish(),\n  totalSets: z.number().nullish(),\n  totalDuration: z.number().nullish(),\n  averageRPE: z.number().nullish(),\n  averageIntensity: z.number().nullish()\n}).nullish();\n\n/* \n   Summary / meta reflections\n */\nexport const _WorkoutSummarySchema = z.object({\n  adaptations: z.array(z.string()).nullish(),\n  coachingNotes: z.string().nullish(),\n  progressionNotes: z.string().nullish(),\n  recoveryFocus: z.string().nullish()\n}).nullish();\n\n/* \n   Full enhanced workout instance\n */\nexport const _EnhancedWorkoutInstanceSchema = z.object({\n  theme: z.string().describe(\"Theme of the workout (e.g., 'Upper Push', 'Lower Power').\"),\n  sessionContext: _WorkoutSessionContextSchema,\n  blocks: z.array(_WorkoutBlockSchema),\n  modifications: z.array(_WorkoutModificationSchema).nullish(),\n  targetMetrics: _WorkoutTargetMetricsSchema,\n  summary: _WorkoutSummarySchema,\n  notes: z.string().nullish()\n}).strict();\n\n\n// Updated workout instance schema with modifications tracking\nexport const _UpdatedWorkoutInstanceSchema = _EnhancedWorkoutInstanceSchema.extend({\n  modificationsApplied: z.array(z.string()).describe(\"List of specific changes made to the workout (e.g., 'Replaced Barbell Bench Press with Dumbbell Bench Press due to no barbell available')\")\n}).strict();\n\n// Legacy schema for backward compatibility\nexport const _WorkoutInstanceSchema = z.object({\n  sessionType: z.enum([\"run\",\"lift\",\"metcon\",\"mobility\",\"rest\",\"other\"]).describe(\"Primary modality\"),\n  details: z.array(\n    z.object({\n      label: z.string().describe(\"Name of the block (e.g. Warm-up)\"),\n      activities: z.array(z.string()).describe(\"Ordered list of exercise descriptions\")\n    }).strict()\n  ).min(1).describe(\"Sequential blocks in the workout\"),\n\n  targets: z.array(\n    z.object({\n      key: z.string().describe(\"Metric / target field name\"),\n      value: z.number().describe(\"Numeric value for the key\")\n    }).strict()\n  ).describe(\"Numeric targets such as distanceKm, volumeKg\")\n   .nullish()\n}).strict()\n\nexport type WorkoutBlockItem = z.infer<typeof _WorkoutBlockItemSchema>;\nexport type WorkoutBlock = z.infer<typeof _WorkoutBlockSchema>;\nexport type WorkoutModification = z.infer<typeof _WorkoutModificationSchema>;\nexport type EnhancedWorkoutInstance = z.infer<typeof _EnhancedWorkoutInstanceSchema> & { date: Date };\nexport type UpdatedWorkoutInstance = z.infer<typeof _UpdatedWorkoutInstanceSchema> & { date: Date };\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2326, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/formattedSchema.ts"],"sourcesContent":["import { z } from 'zod';\n\n/**\n * Formatted Workout Schema\n *\n * Replaces complex JSON schemas with a simple formatted text output.\n * See _claude_docs/workouts/WORKOUT_FORMAT_SPEC.md for format specification.\n */\n\nexport const FormattedWorkoutSchema = z.object({\n  formatted: z.string()\n    .min(100)\n    .describe(`\n      Formatted workout text using extended markdown format.\n\n      REQUIRED STRUCTURE:\n      # {Theme} - {Focus}\n\n      ## Session Overview\n      **Duration:** ~{X} minutes\n      **RPE Target:** {X-Y}\n      **Focus:** {focus areas}\n\n      ---\n\n      ## {Emoji} Block 1: {Block Name}\n      **Goal:** {Purpose}\n\n      {Work items with exercises, sets, reps, RPE, cues, etc.}\n\n      ---\n\n      ## Coaching Notes\n      - {Notes for user}\n\n      FORMAT EXAMPLES:\n\n      Straight sets:\n      1. **Barbell Bench Press** [COMPOUND]\n         - 4 x 5 reps @ 80% 1RM\n         - RPE: 8 | RIR: 2\n         - Rest: 3-4 min\n         - *Cues: Retract scapula, leg drive*\n         - **Progression:** +5lbs from last week\n\n      Supersets:\n      **A. Superset (3 rounds, 90s rest between rounds):**\n         1a. **Incline DB Press** [SECONDARY]\n             - 10-12 reps @ RPE 7\n             - *Cue: Full ROM, control eccentric*\n\n         1b. **Cable Face Pulls** [ACCESSORY]\n             - 15 reps\n             - *Cue: Pull to forehead level*\n\n      Circuits:\n      **B. Circuit (2 rounds, 60s rest):**\n         2a. **Dips** - 8-10 reps @ RPE 8\n         2b. **Lateral Raises** - 12 reps per side\n         2c. **Tricep Pushdowns** - 15 reps\n\n      Cardio:\n      1. **Easy Run**\n         - Duration: 40 min\n         - Pace: 9:30-10:00 /mile\n         - Heart Rate: Zone 2 (130-145 bpm)\n         - *Cues: Relax shoulders, land midfoot*\n\n      IMPORTANT FORMATTING RULES:\n      - Use markdown headers (# for title, ## for blocks)\n      - Use --- to separate blocks\n      - Use **bold** for exercise names\n      - Use [TYPE] tags: [PREP], [COMPOUND], [SECONDARY], [ACCESSORY], [CORE], [CARDIO], [COOLDOWN]\n      - Use emojis for visual hierarchy\n      - Use *italic* for coaching cues\n      - Use bullet points (-) for lists\n      - Include RPE, sets, reps, rest periods as appropriate\n      - Add coaching notes and modifications sections\n      - Be comprehensive - include ALL exercises and details\n      - Adapt format to workout type (strength, cardio, metcon, etc.)\n    `)\n}).strict();\n\nexport type FormattedWorkout = z.infer<typeof FormattedWorkoutSchema>;\n\n/**\n * Enhanced workout with formatted text\n */\nexport const EnhancedFormattedWorkoutSchema = FormattedWorkoutSchema.extend({\n  theme: z.string().describe(\"Workout theme/title (e.g., 'Upper Push', 'Easy Run')\"),\n}).strict();\n\nexport type EnhancedFormattedWorkout = z.infer<typeof EnhancedFormattedWorkoutSchema>;\n\n/**\n * Updated workout with modifications tracking\n */\nexport const UpdatedFormattedWorkoutSchema = EnhancedFormattedWorkoutSchema.extend({\n  modificationsApplied: z.array(z.string())\n    .describe(\"List of specific changes made (e.g., 'Replaced Barbell Bench Press with Dumbbell Bench Press due to no barbell available')\")\n}).strict();\n\nexport type UpdatedFormattedWorkout = z.infer<typeof UpdatedFormattedWorkoutSchema>;\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AASO,MAAM,yBAAyB,0MAAC,CAAC,MAAM,CAAC;IAC7C,WAAW,0MAAC,CAAC,MAAM,GAChB,GAAG,CAAC,KACJ,QAAQ,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAoEX,CAAC;AACL,GAAG,MAAM;AAOF,MAAM,iCAAiC,uBAAuB,MAAM,CAAC;IAC1E,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AAC7B,GAAG,MAAM;AAOF,MAAM,gCAAgC,+BAA+B,MAAM,CAAC;IACjF,sBAAsB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IACnC,QAAQ,CAAC;AACd,GAAG,MAAM"}},
    {"offset": {"line": 2418, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/sessionTypes.ts"],"sourcesContent":["/**\n * Maps LLM-generated session types to database-compatible session types\n *\n * Database expects: 'strength', 'cardio', 'mobility', 'recovery', 'assessment', 'deload'\n * LLM generates: 'run', 'lift', 'metcon', 'mobility', 'rest', 'other'\n */\n\nexport const SESSION_TYPE_MAP: Record<string, string> = {\n  // LLM type -> DB type\n  'lift': 'strength',\n  'run': 'cardio',\n  'metcon': 'cardio', // metabolic conditioning is a form of cardio\n  'mobility': 'mobility', // no change needed\n  'rest': 'recovery',\n  'other': 'recovery', // default catch-all maps to recovery\n} as const;\n\n// Valid database session types\nexport const DB_SESSION_TYPES = [\n  'strength',\n  'cardio',\n  'mobility',\n  'recovery',\n  'assessment',\n  'deload'\n] as const;\n\nexport type DBSessionType = typeof DB_SESSION_TYPES[number];\n\n// LLM session types (from schema)\nexport const LLM_SESSION_TYPES = [\n  'run',\n  'lift',\n  'metcon',\n  'mobility',\n  'rest',\n  'other'\n] as const;\n\nexport type LLMSessionType = typeof LLM_SESSION_TYPES[number];\n\n/**\n * Maps an LLM session type to a database-compatible session type\n * @param llmSessionType The session type from LLM\n * @returns The corresponding database session type\n */\nexport function mapSessionType(llmSessionType: string): DBSessionType {\n  const mapped = SESSION_TYPE_MAP[llmSessionType];\n\n  if (!mapped) {\n    // If we get an unmapped type, default to 'recovery'\n    console.warn(`Unknown LLM session type: ${llmSessionType}, defaulting to 'recovery'`);\n    return 'recovery';\n  }\n\n  return mapped as DBSessionType;\n}\n\n/**\n * Validates if a session type is valid for the database\n * @param sessionType The session type to validate\n * @returns True if valid for database\n */\nexport function isValidDBSessionType(sessionType: string): sessionType is DBSessionType {\n  return DB_SESSION_TYPES.includes(sessionType as DBSessionType);\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;AAEM,MAAM,mBAA2C;IACtD,sBAAsB;IACtB,QAAQ;IACR,OAAO;IACP,UAAU;IACV,YAAY;IACZ,QAAQ;IACR,SAAS;AACX;AAGO,MAAM,mBAAmB;IAC9B;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,MAAM,oBAAoB;IAC/B;IACA;IACA;IACA;IACA;IACA;CACD;AASM,SAAS,eAAe,cAAsB;IACnD,MAAM,SAAS,gBAAgB,CAAC,eAAe;IAE/C,IAAI,CAAC,QAAQ;QACX,oDAAoD;QACpD,QAAQ,IAAI,CAAC,CAAC,0BAA0B,EAAE,eAAe,0BAA0B,CAAC;QACpF,OAAO;IACT;IAEA,OAAO;AACT;AAOO,SAAS,qBAAqB,WAAmB;IACtD,OAAO,iBAAiB,QAAQ,CAAC;AACnC"}},
    {"offset": {"line": 2476, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/workout/index.ts"],"sourcesContent":["/**\n * Centralized workout schema exports\n *\n * This module provides all workout schemas and utilities for both Gemini and OpenAI models.\n * Use getWorkoutSchemas() to automatically select the appropriate schemas based on the model.\n */\n\nimport { z } from 'zod';\n\n// ============================================================================\n// Workout Structure Schemas (for structured workout output)\n// ============================================================================\nexport {\n  IntensitySchema,\n  WorkoutActivitySchema,\n  WorkoutSectionSchema,\n  WorkoutStructureSchema,\n  type WorkoutStructure,\n  type WorkoutActivity,\n  type WorkoutSection,\n  type Intensity,\n} from './workoutStructure';\n\n// ============================================================================\n// Gemini Schema Exports (use sentinel values instead of null)\n// ============================================================================\nexport {\n  GeminiWorkoutBlockItemSchema,\n  GeminiWorkoutWorkItemSchema,\n  GeminiWorkoutBlockSchema,\n  GeminiWorkoutModificationSchema,\n  GeminiWorkoutSessionContextSchema,\n  GeminiWorkoutTargetMetricsSchema,\n  GeminiWorkoutSummarySchema,\n  GeminiEnhancedWorkoutInstanceSchema,\n  GeminiUpdatedWorkoutInstanceSchema,\n  convertGeminiToStandard,\n  type GeminiWorkoutBlockItem,\n  type GeminiWorkoutWorkItem,\n  type GeminiWorkoutBlock,\n  type GeminiWorkoutModification,\n  type GeminiWorkoutSessionContext,\n  type GeminiWorkoutTargetMetrics,\n  type GeminiWorkoutSummary,\n  type GeminiEnhancedWorkoutInstance,\n  type GeminiUpdatedWorkoutInstance,\n} from './geminiSchema';\n\n// ============================================================================\n// OpenAI Schema Exports (use nullable/optional for flexibility)\n// ============================================================================\nexport {\n  _WorkoutBlockItemSchema,\n  _WorkoutWorkItemSchema,\n  _WorkoutBlockSchema,\n  _WorkoutModificationSchema,\n  _WorkoutSessionContextSchema,\n  _WorkoutTargetMetricsSchema,\n  _WorkoutSummarySchema,\n  _EnhancedWorkoutInstanceSchema,\n  _UpdatedWorkoutInstanceSchema,\n  _WorkoutInstanceSchema,\n  type WorkoutBlockItem,\n  type WorkoutBlock,\n  type WorkoutModification,\n  type EnhancedWorkoutInstance,\n  type UpdatedWorkoutInstance,\n} from './openAISchema';\n\n// ============================================================================\n// Formatted Text Schema Exports (replaces complex JSON)\n// ============================================================================\nexport {\n  FormattedWorkoutSchema,\n  EnhancedFormattedWorkoutSchema,\n  UpdatedFormattedWorkoutSchema,\n  type FormattedWorkout,\n  type EnhancedFormattedWorkout,\n  type UpdatedFormattedWorkout,\n} from './formattedSchema';\n\n// ============================================================================\n// Session Type Exports\n// ============================================================================\nexport {\n  SESSION_TYPE_MAP,\n  DB_SESSION_TYPES,\n  LLM_SESSION_TYPES,\n  mapSessionType,\n  isValidDBSessionType,\n  type DBSessionType,\n  type LLMSessionType,\n} from './sessionTypes';\n\n// ============================================================================\n// Schema Selection Utilities\n// ============================================================================\n\nimport {\n  GeminiEnhancedWorkoutInstanceSchema,\n  GeminiUpdatedWorkoutInstanceSchema,\n} from './geminiSchema';\nimport {\n  _EnhancedWorkoutInstanceSchema,\n  _UpdatedWorkoutInstanceSchema,\n} from './openAISchema';\n\n/**\n * Supported model types for workout generation\n */\nexport type WorkoutModelType = 'gpt-5-nano' | 'gemini-2.5-flash' | 'gpt-4o' | 'gemini-2.5-flash-lite' | string;\n\n/**\n * Schema bundle returned by getWorkoutSchemas\n */\nexport interface WorkoutSchemas {\n  enhanced: z.ZodTypeAny;\n  updated: z.ZodTypeAny;\n  isGemini: boolean;\n}\n\n/**\n * Determines if a model is a Gemini model based on its name\n * @param model - The model identifier\n * @returns true if the model is a Gemini model\n */\nexport function isGeminiModel(model?: string): boolean {\n  return model?.startsWith('gemini') || false;\n}\n\n/**\n * Returns the appropriate workout schemas based on the model type\n *\n * @param model - The model identifier (e.g., 'gemini-2.5-flash-lite', 'gpt-5-nano')\n * @returns Object containing the appropriate schemas for the model\n *\n * @example\n * ```typescript\n * const schemas = getWorkoutSchemas('gemini-2.5-flash-lite');\n * // Use schemas.enhanced for EnhancedWorkoutInstance\n * // Use schemas.updated for UpdatedWorkoutInstance (with modificationsApplied)\n * ```\n */\nexport function getWorkoutSchemas(model?: WorkoutModelType): WorkoutSchemas {\n  const useGemini = isGeminiModel(model);\n\n  if (useGemini) {\n    return {\n      enhanced: GeminiEnhancedWorkoutInstanceSchema,\n      updated: GeminiUpdatedWorkoutInstanceSchema,\n      isGemini: true,\n    };\n  } else {\n    return {\n      enhanced: _EnhancedWorkoutInstanceSchema,\n      updated: _UpdatedWorkoutInstanceSchema,\n      isGemini: false,\n    };\n  }\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AAID,+EAA+E;AAC/E,4DAA4D;AAC5D,+EAA+E;AAC/E;AAWA,+EAA+E;AAC/E,8DAA8D;AAC9D,+EAA+E;AAC/E;AAsBA,+EAA+E;AAC/E,gEAAgE;AAChE,+EAA+E;AAC/E;AAkBA,+EAA+E;AAC/E,wDAAwD;AACxD,+EAA+E;AAC/E;AASA,+EAA+E;AAC/E,uBAAuB;AACvB,+EAA+E;AAC/E;;;;;;;;AA0CO,SAAS,cAAc,KAAc;IAC1C,OAAO,OAAO,WAAW,aAAa;AACxC;AAeO,SAAS,kBAAkB,KAAwB;IACxD,MAAM,YAAY,cAAc;IAEhC,IAAI,WAAW;QACb,OAAO;YACL,UAAU,gNAAmC;YAC7C,SAAS,+MAAkC;YAC3C,UAAU;QACZ;IACF,OAAO;QACL,OAAO;YACL,UAAU,2MAA8B;YACxC,SAAS,0MAA6B;YACtC,UAAU;QACZ;IACF;AACF"}},
    {"offset": {"line": 2537, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/workout.ts"],"sourcesContent":["import type { JsonValue, WorkoutInstances } from './_types';\nimport { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type WorkoutInstance = Selectable<WorkoutInstances>;\nexport type NewWorkoutInstance = Insertable<WorkoutInstances>;\nexport type WorkoutInstanceUpdate = Updateable<WorkoutInstances>;\n\n// Re-export everything from shared workout types\nexport * from '@/shared/types/workout';\n\nexport class WorkoutInstanceModel implements NewWorkoutInstance {\n  clientId: string;\n  microcycleId: string | null | undefined;\n  sessionType: string;\n  createdAt: Date | string | undefined;\n  date: Date | string;\n  id: string | undefined;\n  updatedAt: Date | string | undefined;\n  goal: string | null | undefined;\n  details: JsonValue;\n  completedAt: Date | string | null | undefined;\n\n  constructor(workoutInstance: NewWorkoutInstance) {\n    this.clientId = workoutInstance.clientId;\n    this.createdAt = workoutInstance.createdAt;\n    this.date = workoutInstance.date;\n    this.id = workoutInstance.id;\n    this.microcycleId = workoutInstance.microcycleId;\n    this.sessionType = workoutInstance.sessionType;\n    this.details = workoutInstance.details!; // Details is required in DB\n    this.goal = workoutInstance.goal;\n    this.completedAt = workoutInstance.completedAt;\n  }\n}\n"],"names":[],"mappings":";;;;AAOA,iDAAiD;AACjD;;AAEO,MAAM;IACX,SAAiB;IACjB,aAAwC;IACxC,YAAoB;IACpB,UAAqC;IACrC,KAAoB;IACpB,GAAuB;IACvB,UAAqC;IACrC,KAAgC;IAChC,QAAmB;IACnB,YAA8C;IAE9C,YAAY,eAAmC,CAAE;QAC/C,IAAI,CAAC,QAAQ,GAAG,gBAAgB,QAAQ;QACxC,IAAI,CAAC,SAAS,GAAG,gBAAgB,SAAS;QAC1C,IAAI,CAAC,IAAI,GAAG,gBAAgB,IAAI;QAChC,IAAI,CAAC,EAAE,GAAG,gBAAgB,EAAE;QAC5B,IAAI,CAAC,YAAY,GAAG,gBAAgB,YAAY;QAChD,IAAI,CAAC,WAAW,GAAG,gBAAgB,WAAW;QAC9C,IAAI,CAAC,OAAO,GAAG,gBAAgB,OAAO,EAAG,4BAA4B;QACrE,IAAI,CAAC,IAAI,GAAG,gBAAgB,IAAI;QAChC,IAAI,CAAC,WAAW,GAAG,gBAAgB,WAAW;IAChD;AACF"}},
    {"offset": {"line": 2651, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/prompts/workouts.ts"],"sourcesContent":["/**\n * Workouts Prompts - All prompts related to workout generation and modification\n */\n\nimport { z } from 'zod';\nimport type { UserWithProfile } from '@/server/models/user';\n\n// =============================================================================\n// Generate Prompts\n// =============================================================================\n\nexport const DAILY_WORKOUT_SYSTEM_PROMPT = `\nYou are an expert Strength & Conditioning Coach. Your task is to generate the specific session details for a single day based on a provided \"Day Outline.\"\n\nYour output must be **clean, professional Markdown text**.\n\n============================================================\n# INPUT ANALYSIS\n============================================================\nYou will receive:\n1. **Client Profile:** Equipment access, injuries, preferences, and any experience-level guidance.\n2. **Day Outline:** The plan for today (Focus, Patterns, Intensity, Progression, and/or Recovery guidance).\n3. **IsDeload:** Boolean flag.\n\n============================================================\n# SESSION TYPE (CRITICAL)\n============================================================\nBefore writing the output, classify the day into EXACTLY ONE of:\n\n- **TRAINING** (strength, hypertrophy, conditioning intervals, sport-specific training)\n- **ACTIVE_RECOVERY** (optional easy cardio, light recreation, mobility-focused movement)\n- **REST** (no training; optional gentle movement only)\n\nUse these rules:\n- If the outline includes \"rest day\", \"full rest\", \"off\", or indicates no session  **REST**\n- If the outline includes \"active recovery\", \"optional easy cardio\", \"easy cardio\", \"recreation\", \"recovery\", or intensity described as \"easy / could do more / not a grind\"  **ACTIVE_RECOVERY**\n- Otherwise  **TRAINING**\n\nThis classification controls the ENTIRE output structure.\n\n============================================================\n# GENERATION RULES\n============================================================\n\n## 1. Interpret the Session Structure\n- **Single Session:** Output one main block using the correct template for the Session Type.\n- **Double Session (AM/PM):** Clearly separate the output into \"## AM SESSION\" and \"## PM SESSION\".\n  - Each session must use the correct template for its Session Type.\n- **CRITICAL:** ACTIVE_RECOVERY and REST must NOT be forced into a workout-style structure.\n\n## 2. Format MUST match Session Type\n### A) TRAINING\nUse the structured workout format (Warmup / Workout / Cooldown or Cooldown / Conditioning).\n- Strength/Lifting: list exercises with sets, reps, rest, and a brief cue.\n- Cardio/Run/Swim (hard sessions): describe the protocol clearly (intervals, pacing cues, total time).\n- Classes/Anchors: do not invent a workout. Provide \"Pre-Class Prep\" and \"Focus Cues\" only.\n\n### B) ACTIVE_RECOVERY (CRITICAL: NOT a workout)\nActive recovery days must NOT resemble training sessions.\n- DO NOT use \"Warmup\", \"Workout\", or \"Cooldown\" headers.\n- DO NOT break a walk/bike into phases.\n- DO NOT list numbered exercises or main lift/supporting lift.\n- Keep it simple and permissive: options + time ranges + easy effort cues + optional mobility.\n\n### C) REST (CRITICAL: minimal)\nRest days must be extremely simple.\n- No workout structure.\n- Optional gentle walk and/or light stretching.\n- Emphasize recovery behaviors (sleep, hydration, easy movement).\n\n## 3. Equipment & Constraints\n- **CRITICAL:** Only program activities that fit the Client's equipment and constraints.\n- If Client has \"Dumbbells only,\" do not program Barbell Squats.\n- If Client has \"Planet Fitness,\" use Smith Machine or Machines.\n- For ACTIVE_RECOVERY / REST, prefer universally accessible options (walk, easy bike, gentle mobility).\n\n## 4. Progression Logic\n- TRAINING:\n  - **Peak Phase:** Lower reps, higher intensity, cues to push safely.\n  - **Volume Phase:** Higher reps, focus on quality and control.\n  - **Deload:** Clearly state \"Reduce weight by ~30% today\" or \"Easy effort.\"\n- ACTIVE_RECOVERY / REST:\n  - Do not prescribe progression or tracking metrics.\n  - Keep it easy and restorative; user should feel better after.\n\n============================================================\n# OUTPUT FORMAT (MANDATORY TEMPLATES)\n============================================================\n\nStrictly NO emojis. Use standard Markdown headers and lists.\n\n------------------------------------------------------------\nA) TRAINING TEMPLATE\n------------------------------------------------------------\n# [Day Name] - [Focus Title]\n*[One sentence motivational overview]*\n\n## Warmup\n* [Movement] - [Duration/Reps]\n* [Movement] - [Duration/Reps]\n\n## Workout\n**1. Exercise Name**\n* **Sets:** X\n* **Reps:** Y\n* **Rest:** (e.g., 60120s)\n* **How hard should it feel:** [Beginner-friendly cue if needed]\n* *Cue: [Specific form tip]*\n\n**(Repeat for other exercises...)**\n\n## Cooldown / Conditioning\n* [Activity/Stretch]\n\n------------------------------------------------------------\nB) ACTIVE_RECOVERY TEMPLATE (NO workout structure)\n------------------------------------------------------------\n# [Day Name] - Active Recovery\n*[One sentence: move, recover, feel better than when you started]*\n\n## Choose One (Optional)\n- **Walk**  2040 minutes (easy pace; you can hold a full conversation)\n- **Easy bike**  2030 minutes (light effort; legs never burn)\n- **Light recreation**  2040 minutes (fun, casual, not competitive)\n\n## Optional Mobility (510 minutes)\nPick 24:\n- Calves  2030s each side\n- Hamstrings  2030s each side\n- Quads  2030s each side\n- Hip flexors  2030s each side\n- Chest / upper back  2030s each side\n\n## If Youre Tired or Sore\nMake this a lighter day:\n- **515 minute easy walk**\n- **12 gentle stretches**\n- Prioritize **sleep, hydration, and good meals**\n\n------------------------------------------------------------\nC) REST TEMPLATE (minimal)\n------------------------------------------------------------\n# [Day Name] - Rest Day\n*[One sentence: recovery + adapt]*\n\n- **Optional easy walk**  515 minutes\n- **Optional gentle stretching**  5 minutes (only if you feel stiff)\n- Focus today on **sleep, hydration, and nutrition**\n\nNo training today.\n\n============================================================\n# DOUBLE SESSION\n============================================================\nIf the outline clearly specifies AM/PM sessions:\n- Use \"## AM SESSION\" and \"## PM SESSION\"\n- Apply the correct template to each session.\n- If either session is ACTIVE_RECOVERY or REST, it must follow the non-workout template.\n\n============================================================\n# FINAL CHECK\n============================================================\nBefore responding, verify:\n- The session type template is followed exactly.\n- ACTIVE_RECOVERY and REST do NOT look like workouts.\n- Output is clean Markdown and includes no emojis.\n`;\n\n// =============================================================================\n// Modify Prompts\n// =============================================================================\n\nexport const ModifyWorkoutGenerationOutputSchema = z.object({\n  overview: z.string().describe('Full workout text after modifications (or original if unchanged)'),\n  wasModified: z.boolean().describe('Whether the workout was actually modified'),\n  modifications: z.string().default('').describe('Explanation of what changed and why (empty string if wasModified is false)'),\n});\n\nexport type ModifyWorkoutGenerationOutput = z.infer<typeof ModifyWorkoutGenerationOutputSchema>;\n\nexport const MODIFY_WORKOUT_SYSTEM_PROMPT = `\nYou are a **certified strength & conditioning coach** responsible for MODIFYING an already-planned workout for a specific day.\nYour output is consumed by downstream systems and will be shown directly to the end user.\n\nYou will be given:\n- The user's CURRENT WORKOUT for a specific day (including blocks, exercises, sets/reps/RIR, and notes).\n- The user's PROFILE, which may include:\n  - Training history and experience\n  - Preferences (liked/disliked exercises, style, session length)\n  - Equipment access (home, gym, travel, bodyweight-only, etc.)\n  - Injuries, limitations, or pain history\n  - Scheduling constraints and context\n- A USER REQUEST describing a constraint or preference for this specific session (e.g., equipment unavailable, travelling, bodyweight only, pain/discomfort, time constraints, fatigue).\n\nYour job has TWO responsibilities:\n\n============================================================\n# SECTION 1  WORKOUT MODIFICATION LOGIC (Reasoning Rules)\n============================================================\n\nBefore producing ANY output, you MUST determine whether and how to modify the existing workout using the following logic rules.\nThese rules govern *how you think*, NOT how you format output.\n\n------------------------------------------------------------\n## 1. PRESERVE TRAINING INTENT\n------------------------------------------------------------\n\n1.1. Understand the original session:\n- Identify primary movement patterns (e.g., horizontal push, vertical push, squat, hinge, lunge, core, conditioning).\n- Identify primary muscles/emphasis (e.g., chest/shoulders/triceps vs posterior chain).\n- Identify the role of each block:\n  - Main strength\n  - Hypertrophy\n  - Accessory / movement quality\n  - Core / stability\n  - Conditioning / energy systems\n- Identify effort targets:\n  - Sets\n  - Reps\n  - RIR (reps in reserve) or intensity cues\n  - Rough difficulty and fatigue expectations\n\n1.2. When modifying:\n- Keep the SAME basic movement pattern (e.g., horizontal push  another horizontal push).\n- Keep a SIMILAR effort level (RIR and approximate rep range).\n- Keep a SIMILAR role in the session:\n  - A heavy main lift must remain a challenging primary movement.\n  - Accessories should remain secondary work, not become the main stressor.\n- Preserve overall session structure and flow (block order and intent) unless time/fatigue constraints require trimming.\n\n------------------------------------------------------------\n## 2. USE THE USER PROFILE + BUILT-IN SUBSTITUTIONS\n------------------------------------------------------------\n\n2.1. Use the user profile:\n- Respect equipment access:\n  - Do not prescribe equipment the profile explicitly says they do not have.\n  - Prefer equipment they do have and are comfortable using.\n- Respect injuries and limitations:\n  - Avoid movements or positions that conflict with injury history.\n  - Prefer historically tolerated patterns and ranges of motion.\n- Respect strong preferences when possible:\n  - If the user strongly dislikes an exercise and there is a viable alternative with the same intent, favor the alternative.\n  - Favor exercises and styles the user enjoys when they fit the training intent.\n\n2.2. Use built-in substitutions first:\n- If the workout text already lists \"Substitutions\" for an exercise or block:\n  - Prefer these options as the first choice, because they were curated for the same intent.\n- When using a listed substitution:\n  - Keep the same sets/reps/RIR unless explicitly instructed otherwise in the workout text.\n  - Keep the same block goal and general cues where possible.\n\n------------------------------------------------------------\n## 3-9. [Additional modification rules...]\n------------------------------------------------------------\n\n[The full modification logic continues with sections on constraints, substitution logic, bodyweight scenarios, time constraints, pain handling, structure maintenance, and communication style]\n\n============================================================\n# SECTION 2  OUTPUT FORMAT RULES (JSON Structure)\n============================================================\n\nAfter completing all reasoning in Section 1, you MUST output a single JSON object:\n\n{\n  \"overview\": \"...\",\n  \"wasModified\": true/false,\n  \"modifications\": \"...\"\n}\n\nThe overview field contains the FULL workout text after modifications.\nThe wasModified field is a boolean indicating if changes were made.\nThe modifications field explains what changed (empty string if wasModified is false).\n`;\n\nexport const modifyWorkoutUserPrompt = (\n  user: UserWithProfile,\n  workoutOverview: string,\n  changesRequested: string) => `\nYou are given the following context about the user's training session.\n\n<WorkoutOverview>\n${workoutOverview}\n</WorkoutOverview>\n\n${user.profile ? `<Fitness Profile>\\n${user.profile.trim()}\\n</Fitness Profile>` : ''}\n\n<ChangesRequested>\n${changesRequested}\n</ChangesRequested>\n\nTask:\nUsing the workout overview, fitness profile, and requested changes above, decide whether the workout needs to be modified.\n- Follow the reasoning and modification rules from the system instructions.\n- Preserve the original training intent and structure as much as possible.\n- Apply substitutions or adjustments only when needed based on the user's request and profile.\n\nOutput Format (MANDATORY):\nReturn a SINGLE JSON object, with no extra text before or after.\n\nIf the workout WAS modified, respond with:\n{\n  \"overview\": \"FULL UPDATED WORKOUT TEXT...\",\n  \"wasModified\": true,\n  \"modifications\": \"Short explanation of what changed and why.\"\n}\n\nIf the workout was NOT modified, respond with:\n{\n  \"overview\": \"ORIGINAL WORKOUT TEXT (unchanged)...\",\n  \"wasModified\": false,\n  \"modifications\": \"\"\n}\n\nDo NOT include any additional fields or commentary outside this JSON object.\n`.trim();\n\n// =============================================================================\n// Message (SMS) Prompts\n// =============================================================================\n\nexport const WORKOUT_SMS_FORMATTER_SYSTEM_PROMPT = `\nYou are a fitness coach who reformats ANY session description into a clean, concise SMS workout message.\n\nYour job:\n- Take a full session description (title, overview, options, warmup, main lifts, circuits, conditioning, cooldown, notes, etc.).\n- Output a SHORT, runnable SMS version.\n- Preserve the intent of the session, especially when the session is recovery-based.\n\n=====================================================\nSESSION TYPE (CRITICAL)\n=====================================================\nBefore formatting, classify the session into EXACTLY ONE type:\n\n1) TRAINING\n- Strength/hypertrophy workouts, structured conditioning, intervals, circuits, lifting days.\n\n2) ACTIVE_RECOVERY\n- Active recovery, optional easy cardio, recreation, easy movement + light stretching.\n\n3) REST\n- Full rest day; optional gentle walk or stretching only.\n\nThis classification STRICTLY controls the SMS structure.\n\n=====================================================\nGLOBAL OUTPUT SHAPE (ALWAYS)\n=====================================================\nYour SMS MUST follow this exact shape:\n\n1) First line: a short focus line (25 words, no label)\n\n2) Exactly one blank line (no spaces)\n\n3) Then the body content (no more than 4 total lines)\n\nRules:\n- Never output lines containing only whitespace.\n- Never add multiple consecutive blank lines.\n- Never add commentary or explanations beyond what the rules allow.\n\n=====================================================\nFORMAT RULES BY SESSION TYPE\n=====================================================\n\nFollow the formatting rules provided in the <DayFormatRules> context.\nThe day format context specifies exactly how to format output based on session type.\n\n=====================================================\nBULLET LINE FORMATS\n=====================================================\n- Training: \"- BB Bench Press: 4x8-10\"\n- Time-based: \"- Easy activity: ~30m\"\n\nAbbreviations:\n- Barbell -> BB\n- Dumbbell -> DB\n- Overhead Press -> OHP\n- Romanian Deadlift -> RDL\n- Single-Leg -> SL\n\nSupersets use \"SS1\", \"SS2\".\nCircuits use \"C1\", \"C2\".\n\n=====================================================\nFINAL CHECK (CRITICAL)\n=====================================================\nBefore responding, verify:\n- ACTIVE_RECOVERY has NO headers.\n- ACTIVE_RECOVERY has at most 2 bullets.\n- ACTIVE_RECOVERY reads as permissive, not prescriptive.\n- Output matches blank-line rules exactly.\n` as const;\n\nexport function workoutSmsUserPrompt(workoutDescription: string) {\n  return `\nFormat the workout below into a clean SMS message following the system rules.\n\n<WORKOUT>\n${workoutDescription}\n</WORKOUT>\n\nReturn ONLY the formatted SMS message.\n  `.trim();\n}\n\n// =============================================================================\n// Structured Prompts\n// =============================================================================\n\nexport const STRUCTURED_WORKOUT_SYSTEM_PROMPT = `You are a workout data extraction specialist. Your task is to parse a workout description into a structured format.\n\nEXTRACTION RULES:\n1. Extract a SHORT title (2-4 words maximum). Examples: \"Pull A\", \"Upper Strength\", \"Leg Day\", \"HIIT Cardio\"\n   - DO NOT include day names (Monday, Tuesday, etc.) in the title\n   - DO NOT include prefixes like \"Session Type:\", \"Focus:\", etc.\n   - DO NOT include long muscle group lists in the title\n2. Identify focus as a brief phrase (1-3 words). Examples: \"Back & Biceps\", \"Quads\", \"Push Muscles\"\n3. Parse each section (Warmup, Main Workout, Conditioning, Cooldown) into the sections array\n4. For each exercise in a section, extract:\n   - id: Generate a unique short id (e.g., \"ex1\", \"ex2\")\n   - name: The exercise name (e.g., \"Back Squat\", \"Zone 2 Run\")\n   - type: Strength, Cardio, Plyometric, Mobility, Rest, or Other\n   - sets: Number of sets as string (e.g., \"4\", \"3-4\")\n   - reps: Reps or duration (e.g., \"6-8\", \"4 min\", \"AMRAP\")\n   - duration: For timed exercises (e.g., \"45 min\")\n   - distance: For cardio (e.g., \"5km\")\n   - rest: Rest between sets (e.g., \"2-3 min\")\n   - intensity: Object with type (RPE, RIR, Percentage, Zone, HeartRate, Pace, Other), value, and description\n   - tempo: Lifting tempo if specified (e.g., \"3-0-1\")\n   - notes: Execution cues or form tips\n   - tags: Relevant tags (e.g., [\"compound\", \"lower body\"])\n   - supersetId: If part of a superset, use matching id (e.g., \"ss1\")\n5. Estimate total duration in minutes\n6. Assess overall intensity level: Low, Moderate, High, or Severe\n\nDEFAULTS:\n- Use empty string (\"\") for text fields that cannot be determined\n- Use -1 for estimatedDurationMin if unknown\n- Use \"Moderate\" for intensityLevel if unclear\n- Use empty arrays ([]) for sections, exercises, or tags if none found\n\nExtract ALL exercises mentioned, including those in supersets or circuits.`;\n\nexport const structuredWorkoutUserPrompt = (description: string): string => `Parse the following workout into structured format:\n\n${description}`;\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;;;;;AAED;AAAA;;AAOO,MAAM,8BAA8B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2J5C,CAAC;AAMM,MAAM,sCAAsC,0MAAC,CAAC,MAAM,CAAC;IAC1D,UAAU,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC9B,aAAa,0MAAC,CAAC,OAAO,GAAG,QAAQ,CAAC;IAClC,eAAe,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,IAAI,QAAQ,CAAC;AACjD;AAIO,MAAM,+BAA+B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6F7C,CAAC;AAEM,MAAM,0BAA0B,CACrC,MACA,iBACA,mBAA6B,CAAC;;;;AAIhC,EAAE,gBAAgB;;;AAGlB,EAAE,KAAK,OAAO,GAAG,CAAC,mBAAmB,EAAE,KAAK,OAAO,CAAC,IAAI,GAAG,oBAAoB,CAAC,GAAG,GAAG;;;AAGtF,EAAE,iBAAiB;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2BnB,CAAC,CAAC,IAAI;AAMC,MAAM,sCAAsC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuEpD,CAAC;AAEM,SAAS,qBAAqB,kBAA0B;IAC7D,OAAO,CAAC;;;;AAIV,EAAE,mBAAmB;;;;EAInB,CAAC,CAAC,IAAI;AACR;AAMO,MAAM,mCAAmC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;0EAgCyB,CAAC;AAEpE,MAAM,8BAA8B,CAAC,cAAgC,CAAC;;AAE7E,EAAE,aAAa"}},
    {"offset": {"line": 3090, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/types.ts"],"sourcesContent":["import type { WorkoutInstance, Microcycle } from '@/server/models';\nimport type { ExperienceLevel, SnippetType } from './builders/experienceLevel';\n\n/**\n * Context types that can be requested from the ContextService\n */\nexport enum ContextType {\n  USER = 'user',\n  USER_PROFILE = 'userProfile',\n  FITNESS_PLAN = 'fitnessPlan',\n  DAY_OVERVIEW = 'dayOverview',\n  CURRENT_WORKOUT = 'currentWorkout',\n  DATE_CONTEXT = 'dateContext',\n  TRAINING_META = 'trainingMeta',\n  CURRENT_MICROCYCLE = 'currentMicrocycle',\n  EXPERIENCE_LEVEL = 'experienceLevel',\n  DAY_FORMAT = 'dayFormat',\n}\n\n/**\n * Optional extras that callers can provide to supplement/override auto-fetched data\n */\nexport interface ContextExtras {\n  // Caller-provided data (cannot be auto-fetched)\n  dayOverview?: string;\n\n  // Training metadata (from orchestration context)\n  isDeload?: boolean;\n  absoluteWeek?: number;\n  currentWeek?: number;\n\n  // Override auto-fetched data\n  workout?: WorkoutInstance | null;\n  microcycle?: Microcycle | null;\n  planText?: string;\n\n  // Date override\n  date?: Date;\n\n  // Experience level context\n  experienceLevel?: ExperienceLevel;\n  snippetType?: SnippetType;\n\n  // Activity type for day format context\n  activityType?: 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST';\n}\n\n/**\n * Internal data structure built from user + extras + fetched data\n * Passed to individual builders\n */\nexport interface ResolvedContextData {\n  userName?: string | null;\n  userGender?: string | null;\n  userAge?: number | null;\n  profile?: string | null;\n  planText?: string | null;\n  dayOverview?: string;\n  workout?: WorkoutInstance | null;\n  microcycle?: Microcycle | null;\n  timezone?: string;\n  date?: Date;\n  isDeload?: boolean;\n  absoluteWeek?: number;\n  currentWeek?: number;\n  experienceLevel?: ExperienceLevel | null;\n  snippetType?: SnippetType;\n  activityType?: 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST';\n  dayFormatTemplate?: string | null;\n  experienceSnippet?: string | null;\n}\n"],"names":[],"mappings":";;;;AAMO,IAAA,AAAK,qCAAA;;;;;;;;;;;WAAA"}},
    {"offset": {"line": 3111, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/experienceLevel.ts"],"sourcesContent":["/**\n * Experience Level Context Builder\n *\n * Provides language and content guidance for AI agents based on user experience level.\n * Snippets are stored in the prompts table and fetched dynamically.\n *\n * Used in two locations:\n * 1. Microcycle generation (weekly structure, intent, progression logic)\n * 2. Workout generation (daily exercises, cues, and communication style)\n *\n * Intent summary for each experience level:\n * - **Beginner:** Learn movements, build habits, stay confident\n * - **Intermediate:** Build strength and muscle with structure, without overwhelm\n * - **Advanced:** Optimize performance, manage fatigue, and pursue specific strength goals\n */\n\nimport { promptService } from '@/server/services/prompts/promptService';\n\n// =============================================================================\n// Types\n// =============================================================================\n\n/**\n * Types of context snippets available\n */\nexport enum SnippetType {\n  MICROCYCLE = 'microcycle',\n  WORKOUT = 'workout',\n}\n\n/**\n * User experience levels\n */\nexport type ExperienceLevel = 'beginner' | 'intermediate' | 'advanced';\n\n// =============================================================================\n// Prompt ID Mapping\n// =============================================================================\n\n/**\n * Maps snippet type and experience level to prompt IDs in the database\n */\nconst EXPERIENCE_PROMPT_MAP: Record<SnippetType, Record<ExperienceLevel, string>> = {\n  [SnippetType.MICROCYCLE]: {\n    beginner: 'microcycle:generate:experience:beginner',\n    intermediate: 'microcycle:generate:experience:intermediate',\n    advanced: 'microcycle:generate:experience:advanced',\n  },\n  [SnippetType.WORKOUT]: {\n    beginner: 'workout:generate:experience:beginner',\n    intermediate: 'workout:generate:experience:intermediate',\n    advanced: 'workout:generate:experience:advanced',\n  },\n};\n\n// =============================================================================\n// Fetch Function\n// =============================================================================\n\n/**\n * Fetch experience level snippet from database\n *\n * @param experienceLevel - User's experience level (beginner, intermediate, advanced)\n * @param snippetType - Type of snippet to return (microcycle or workout)\n * @returns The snippet content or null if not found\n */\nexport const fetchExperienceLevelSnippet = async (\n  experienceLevel: ExperienceLevel | null | undefined,\n  snippetType: SnippetType\n): Promise<string | null> => {\n  if (!experienceLevel) {\n    return null;\n  }\n\n  const promptId = EXPERIENCE_PROMPT_MAP[snippetType]?.[experienceLevel];\n  if (!promptId) {\n    return null;\n  }\n\n  try {\n    return await promptService.getContextPrompt(promptId);\n  } catch (error) {\n    console.warn(`[experienceLevel] Could not fetch snippet for ${experienceLevel}/${snippetType}:`, error);\n    return null;\n  }\n};\n\n// =============================================================================\n// Builder Function\n// =============================================================================\n\n/**\n * Build experience level context string\n *\n * Formats the pre-fetched snippet with XML tags for agent context.\n *\n * @param snippet - The pre-fetched snippet content\n * @param experienceLevel - User's experience level (for XML attributes)\n * @param snippetType - Type of snippet (for XML attributes)\n * @returns Formatted context string with XML tags, or empty string if no snippet\n *\n * @example\n * ```typescript\n * const snippet = await fetchExperienceLevelSnippet('beginner', SnippetType.WORKOUT);\n * const context = buildExperienceLevelContext(snippet, 'beginner', SnippetType.WORKOUT);\n * // Returns: <ExperienceLevelContext level=\"beginner\" type=\"workout\">...</ExperienceLevelContext>\n * ```\n */\nexport const buildExperienceLevelContext = (\n  snippet: string | null | undefined,\n  experienceLevel: ExperienceLevel | null | undefined,\n  snippetType: SnippetType\n): string => {\n  if (!snippet || !experienceLevel) {\n    return '';\n  }\n\n  return `<ExperienceLevelContext level=\"${experienceLevel}\" type=\"${snippetType}\">\n${snippet.trim()}\n</ExperienceLevelContext>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;CAcC;;;;;;;;AAED;;AASO,IAAA,AAAK,qCAAA;;;WAAA;;AAUZ,gFAAgF;AAChF,oBAAoB;AACpB,gFAAgF;AAEhF;;CAEC,GACD,MAAM,wBAA8E;IAClF,cAAwB,EAAE;QACxB,UAAU;QACV,cAAc;QACd,UAAU;IACZ;IACA,WAAqB,EAAE;QACrB,UAAU;QACV,cAAc;QACd,UAAU;IACZ;AACF;AAaO,MAAM,8BAA8B,OACzC,iBACA;IAEA,IAAI,CAAC,iBAAiB;QACpB,OAAO;IACT;IAEA,MAAM,WAAW,qBAAqB,CAAC,YAAY,EAAE,CAAC,gBAAgB;IACtE,IAAI,CAAC,UAAU;QACb,OAAO;IACT;IAEA,IAAI;QACF,OAAO,MAAM,8LAAa,CAAC,gBAAgB,CAAC;IAC9C,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,CAAC,8CAA8C,EAAE,gBAAgB,CAAC,EAAE,YAAY,CAAC,CAAC,EAAE;QACjG,OAAO;IACT;AACF;AAuBO,MAAM,8BAA8B,CACzC,SACA,iBACA;IAEA,IAAI,CAAC,WAAW,CAAC,iBAAiB;QAChC,OAAO;IACT;IAEA,OAAO,CAAC,+BAA+B,EAAE,gBAAgB,QAAQ,EAAE,YAAY;AACjF,EAAE,QAAQ,IAAI,GAAG;yBACQ,CAAC;AAC1B"}},
    {"offset": {"line": 3184, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/user.ts"],"sourcesContent":["/**\n * Build user context string with basic user information\n *\n * @param user - User object with name, optional gender, and optional age\n * @returns Formatted context string with XML tags\n */\nexport const buildUserContext = (user: { name?: string | null; gender?: string | null; age?: number | null } | null | undefined): string => {\n  if (!user) {\n    return '<User>No user information available</User>';\n  }\n\n  const parts: string[] = [];\n\n  if (user.name) {\n    parts.push(`<Name>${user.name}</Name>`);\n  }\n\n  if (user.gender) {\n    parts.push(`<Gender>${user.gender}</Gender>`);\n  }\n\n  if (user.age) {\n    parts.push(`<Age>${user.age}</Age>`);\n  }\n\n  if (parts.length === 0) {\n    return '<User>No user information available</User>';\n  }\n\n  return `<User>\\n${parts.join('\\n')}\\n</User>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,mBAAmB,CAAC;IAC/B,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IAEA,MAAM,QAAkB,EAAE;IAE1B,IAAI,KAAK,IAAI,EAAE;QACb,MAAM,IAAI,CAAC,CAAC,MAAM,EAAE,KAAK,IAAI,CAAC,OAAO,CAAC;IACxC;IAEA,IAAI,KAAK,MAAM,EAAE;QACf,MAAM,IAAI,CAAC,CAAC,QAAQ,EAAE,KAAK,MAAM,CAAC,SAAS,CAAC;IAC9C;IAEA,IAAI,KAAK,GAAG,EAAE;QACZ,MAAM,IAAI,CAAC,CAAC,KAAK,EAAE,KAAK,GAAG,CAAC,MAAM,CAAC;IACrC;IAEA,IAAI,MAAM,MAAM,KAAK,GAAG;QACtB,OAAO;IACT;IAEA,OAAO,CAAC,QAAQ,EAAE,MAAM,IAAI,CAAC,MAAM,SAAS,CAAC;AAC/C"}},
    {"offset": {"line": 3216, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/userProfile.ts"],"sourcesContent":["/**\n * Build user profile context string\n *\n * @param profile - User's markdown profile (pre-fetched from user object)\n * @returns Formatted context string with XML tags\n */\nexport const buildUserProfileContext = (profile: string | null | undefined): string => {\n  if (!profile || profile.trim().length === 0) {\n    return '<UserProfile>No profile available</UserProfile>';\n  }\n  return `<UserProfile>${profile.trim()}</UserProfile>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,0BAA0B,CAAC;IACtC,IAAI,CAAC,WAAW,QAAQ,IAAI,GAAG,MAAM,KAAK,GAAG;QAC3C,OAAO;IACT;IACA,OAAO,CAAC,aAAa,EAAE,QAAQ,IAAI,GAAG,cAAc,CAAC;AACvD"}},
    {"offset": {"line": 3235, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/fitnessPlan.ts"],"sourcesContent":["/**\n * Build fitness plan context string\n *\n * @param planText - Fitness plan description text\n * @returns Formatted context string with XML tags\n */\nexport const buildFitnessPlanContext = (planText: string | null | undefined): string => {\n  if (!planText || planText.trim().length === 0) {\n    return '<FitnessPlan>No fitness plan available</FitnessPlan>';\n  }\n  return `<FitnessPlan>${planText.trim()}</FitnessPlan>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,0BAA0B,CAAC;IACtC,IAAI,CAAC,YAAY,SAAS,IAAI,GAAG,MAAM,KAAK,GAAG;QAC7C,OAAO;IACT;IACA,OAAO,CAAC,aAAa,EAAE,SAAS,IAAI,GAAG,cAAc,CAAC;AACxD"}},
    {"offset": {"line": 3254, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/dayOverview.ts"],"sourcesContent":["/**\n * Build day overview context string\n *\n * @param dayOverview - Day instruction/overview from microcycle\n * @returns Formatted context string with XML tags\n */\nexport const buildDayOverviewContext = (dayOverview: string | undefined): string => {\n  if (!dayOverview || dayOverview.trim().length === 0) {\n    return '<DayOverview>No day instruction provided</DayOverview>';\n  }\n  return `<DayOverview>${dayOverview.trim()}</DayOverview>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,0BAA0B,CAAC;IACtC,IAAI,CAAC,eAAe,YAAY,IAAI,GAAG,MAAM,KAAK,GAAG;QACnD,OAAO;IACT;IACA,OAAO,CAAC,aAAa,EAAE,YAAY,IAAI,GAAG,cAAc,CAAC;AAC3D"}},
    {"offset": {"line": 3273, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/workout.ts"],"sourcesContent":["import type { WorkoutInstance } from '@/server/models';\n\n/**\n * Build current workout context string\n *\n * @param workout - Current workout instance (optional)\n * @returns Formatted context string with XML tags\n */\nexport const buildWorkoutContext = (workout: WorkoutInstance | null | undefined): string => {\n  if (!workout) {\n    return '<CurrentWorkout>No workout scheduled</CurrentWorkout>';\n  }\n\n  // Include workout description or session type\n  const description = workout.description || workout.sessionType || 'Workout';\n\n  return `<CurrentWorkout>${description}</CurrentWorkout>`;\n};\n"],"names":[],"mappings":";;;;AAQO,MAAM,sBAAsB,CAAC;IAClC,IAAI,CAAC,SAAS;QACZ,OAAO;IACT;IAEA,8CAA8C;IAC9C,MAAM,cAAc,QAAQ,WAAW,IAAI,QAAQ,WAAW,IAAI;IAElE,OAAO,CAAC,gBAAgB,EAAE,YAAY,iBAAiB,CAAC;AAC1D"}},
    {"offset": {"line": 3289, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/utils/date.ts"],"sourcesContent":["/**\n * Date & Time Utilities\n *\n * Single source of truth for all date/time operations across the application.\n * Handles timezone conversions, formatting for UI/AI/API, and date comparisons.\n *\n * Uses Luxon for timezone-aware operations.\n *\n * @example\n * ```typescript\n * import { formatForUI, formatForAI, parseDate } from '@/shared/utils/date';\n *\n * // Format for UI display\n * const displayDate = formatForUI(new Date(), 'short');\n *\n * // Format for AI prompts\n * const aiDate = formatForAI(new Date(), 'America/New_York');\n *\n * // Parse safely\n * const parsed = parseDate('2025-01-20');\n * ```\n */\n\nimport { DateTime, IANAZone } from 'luxon';\n\nexport type DayOfWeek =\n  | \"MONDAY\"\n  | \"TUESDAY\"\n  | \"WEDNESDAY\"\n  | \"THURSDAY\"\n  | \"FRIDAY\"\n  | \"SATURDAY\"\n  | \"SUNDAY\";\n\nexport const DAY_NAMES = [\n  \"MONDAY\",\n  \"TUESDAY\",\n  \"WEDNESDAY\",\n  \"THURSDAY\",\n  \"FRIDAY\",\n  \"SATURDAY\",\n  \"SUNDAY\",\n] as DayOfWeek[];\n/**\n * Date format types for different use cases\n */\nexport type DateFormatType =\n  | 'short'      // \"Jan 20, 2025\"\n  | 'long'       // \"January 20, 2025\"\n  | 'time'       // \"2:30 PM\"\n  | 'datetime'   // \"Jan 20, 2025, 2:30 PM\"\n  | 'relative';  // \"2 days ago\"\n\n// ==========================================\n// Construction & Parsing\n// ==========================================\n\n/**\n * Safely parse a date value into a Date object\n * Handles Date objects, ISO strings, SQL dates, timestamps, and invalid values\n *\n * PostgreSQL stores dates as 'date' type (e.g., '2025-11-06') without timezone info.\n * When JavaScript parses these as `new Date('2025-11-06')`, it interprets them as\n * UTC midnight and then converts to local timezone, causing off-by-one-day bugs.\n * This function ensures SQL dates are always interpreted as UTC to avoid timezone shifts.\n */\nexport function parseDate(value: Date | string | number | null | undefined): Date | null {\n  if (!value) return null;\n\n  if (value instanceof Date) {\n    return isNaN(value.getTime()) ? null : value;\n  }\n\n  if (typeof value === 'string') {\n    // If it already has time component (ISO 8601), parse directly\n    if (value.includes('T')) {\n      const date = new Date(value);\n      return isNaN(date.getTime()) ? null : date;\n    }\n\n    // SQL date format (YYYY-MM-DD) - add UTC midnight to prevent timezone shifts\n    const date = new Date(value + 'T00:00:00Z');\n    return isNaN(date.getTime()) ? null : date;\n  }\n\n  if (typeof value === 'number') {\n    const date = new Date(value);\n    return isNaN(date.getTime()) ? null : date;\n  }\n\n  return null;\n}\n\n/**\n * Get current date/time in a specific timezone\n * @param timezone - IANA timezone (e.g., \"America/New_York\")\n * @returns Luxon DateTime in the specified timezone\n */\nexport function now(timezone?: string): DateTime {\n  if (timezone && isValidTimezone(timezone)) {\n    return DateTime.now().setZone(timezone);\n  }\n  return DateTime.now();\n}\n\n/**\n * Get today's date (start of day) in a specific timezone\n * @param timezone - IANA timezone (e.g., \"America/New_York\")\n * @returns Date object representing midnight of today in the specified timezone\n */\nexport function today(timezone?: string): Date {\n  return now(timezone).startOf('day').toJSDate();\n}\n\n/**\n * Get start of day for a date in a specific timezone\n */\nexport function startOfDay(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to startOfDay');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.startOf('day').toJSDate();\n}\n\n/**\n * Get end of day for a date in a specific timezone\n */\nexport function endOfDay(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to endOfDay');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.endOf('day').toJSDate();\n}\n\n// ==========================================\n// Timezone Operations\n// ==========================================\n\n/**\n * Validate if a string is a valid IANA timezone\n */\nexport function isValidTimezone(timezone: string): boolean {\n  return IANAZone.isValidZone(timezone);\n}\n\n/**\n * Convert a Date to a specific timezone\n * @returns Luxon DateTime in the target timezone\n */\nexport function convertToTimezone(date: Date | string, timezone: string): DateTime {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to convertToTimezone');\n  }\n\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  return DateTime.fromJSDate(parsed, { zone: 'utc' }).setZone(timezone);\n}\n\n/**\n * Convert a local date/time in a timezone to UTC\n */\nexport function convertToUTC(localDate: Date | string, timezone: string): Date {\n  const parsed = parseDate(localDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to convertToUTC');\n  }\n\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  return DateTime.fromJSDate(parsed, { zone: timezone }).toUTC().toJSDate();\n}\n\n/**\n * Get the local hour for a given UTC date in a specific timezone\n */\nexport function getLocalHour(utcDate: Date | string, timezone: string): number {\n  const dt = convertToTimezone(utcDate, timezone);\n  return dt.hour;\n}\n\n// ==========================================\n// Formatting for UI\n// ==========================================\n\n/**\n * Format date for UI display with consistent formatting\n * @param date - Date to format\n * @param format - Format type (short, long, time, datetime, relative)\n * @param timezone - Optional timezone for localization\n * @returns Formatted date string\n */\nexport function formatForUI(\n  date: Date | string | null | undefined,\n  format: DateFormatType = 'short',\n  timezone?: string\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  switch (format) {\n    case 'short':\n      return dt.toLocaleString({ month: 'short', day: 'numeric', year: 'numeric' });\n\n    case 'long':\n      return dt.toLocaleString({ month: 'long', day: 'numeric', year: 'numeric' });\n\n    case 'time':\n      return dt.toLocaleString(DateTime.TIME_SIMPLE);\n\n    case 'datetime':\n      return dt.toLocaleString(DateTime.DATETIME_MED);\n\n    case 'relative':\n      return formatRelative(parsed);\n\n    default:\n      return dt.toLocaleString({ month: 'short', day: 'numeric', year: 'numeric' });\n  }\n}\n\n/**\n * Format date as relative time (e.g., \"2 days ago\", \"in 3 hours\")\n */\nexport function formatRelative(date: Date | string): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  const dt = DateTime.fromJSDate(parsed);\n  const nowDt = DateTime.now();\n  const diff = dt.diff(nowDt, ['years', 'months', 'days', 'hours', 'minutes']).toObject();\n\n  // Future dates\n  if (dt > nowDt) {\n    if (Math.abs(diff.years || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.years || 0))} year${Math.abs(diff.years || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.months || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.months || 0))} month${Math.abs(diff.months || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.days || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.days || 0))} day${Math.abs(diff.days || 0) !== 1 ? 's' : ''}`;\n    }\n    if (Math.abs(diff.hours || 0) >= 1) {\n      return `in ${Math.round(Math.abs(diff.hours || 0))} hour${Math.abs(diff.hours || 0) !== 1 ? 's' : ''}`;\n    }\n    return `in ${Math.round(Math.abs(diff.minutes || 0))} minute${Math.abs(diff.minutes || 0) !== 1 ? 's' : ''}`;\n  }\n\n  // Past dates\n  if (Math.abs(diff.years || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.years || 0))} year${Math.abs(diff.years || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.months || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.months || 0))} month${Math.abs(diff.months || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.days || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.days || 0))} day${Math.abs(diff.days || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.hours || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.hours || 0))} hour${Math.abs(diff.hours || 0) !== 1 ? 's' : ''} ago`;\n  }\n  if (Math.abs(diff.minutes || 0) >= 1) {\n    return `${Math.round(Math.abs(diff.minutes || 0))} minute${Math.abs(diff.minutes || 0) !== 1 ? 's' : ''} ago`;\n  }\n  return 'just now';\n}\n\n// ==========================================\n// Formatting for AI/LLM\n// ==========================================\n\n/**\n * Format date for AI prompts with consistent, human-readable format\n * @param date - Date to format\n * @param timezone - User's timezone for context\n * @returns Human-readable date string (e.g., \"Monday, January 20, 2025\")\n */\nexport function formatForAI(date: Date | string, timezone: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toLocaleString({\n    weekday: 'long',\n    month: 'long',\n    day: 'numeric',\n    year: 'numeric',\n  });\n}\n\n/**\n * Format date for AI with custom pattern\n * @param date - Date to format\n * @param timezone - User's timezone\n * @param includeDay - Whether to include day of week\n * @returns Formatted string\n */\nexport function formatForAICustom(\n  date: Date | string,\n  timezone: string,\n  options: { includeDay?: boolean; includeYear?: boolean } = {}\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  const { includeDay = true, includeYear = true } = options;\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  const formatOptions: Intl.DateTimeFormatOptions = {\n    month: 'long',\n    day: 'numeric',\n  };\n\n  if (includeDay) {\n    formatOptions.weekday = 'long';\n  }\n\n  if (includeYear) {\n    formatOptions.year = 'numeric';\n  }\n\n  return dt.toLocaleString(formatOptions);\n}\n\n// ==========================================\n// Formatting for API\n// ==========================================\n\n/**\n * Format date for API responses (ISO 8601 string)\n * @param date - Date to format\n * @returns ISO 8601 string\n */\nexport function formatForAPI(date: Date | string | null | undefined): string | null {\n  const parsed = parseDate(date);\n  if (!parsed) return null;\n  return parsed.toISOString();\n}\n\n/**\n * Format date for database storage\n * Ensures consistent Date object format\n */\nexport function formatForDatabase(date: Date | string | null | undefined): Date | null {\n  return parseDate(date);\n}\n\n// ==========================================\n// Comparison & Validation\n// ==========================================\n\n/**\n * Check if a value is a valid date\n */\nexport function isValidDate(value: unknown): boolean {\n  const parsed = parseDate(value as Date | string);\n  return parsed !== null;\n}\n\n/**\n * Check if two dates are on the same day\n * @param timezone - Optional timezone for comparison (uses date's timezone if not provided)\n */\nexport function isSameDay(date1: Date | string, date2: Date | string, timezone?: string): boolean {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return false;\n\n  let dt1 = DateTime.fromJSDate(parsed1);\n  let dt2 = DateTime.fromJSDate(parsed2);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt1 = dt1.setZone(timezone);\n    dt2 = dt2.setZone(timezone);\n  }\n\n  return dt1.hasSame(dt2, 'day');\n}\n\n/**\n * Check if a date is today\n * @param timezone - Timezone to check against (defaults to system timezone)\n */\nexport function isToday(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.hasSame(nowDt, 'day');\n}\n\n/**\n * Check if a date is in the past\n */\nexport function isPast(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt < nowDt;\n}\n\n/**\n * Check if a date is in the future\n */\nexport function isFuture(date: Date | string, timezone?: string): boolean {\n  const parsed = parseDate(date);\n  if (!parsed) return false;\n\n  const nowDt = now(timezone);\n  let dt = DateTime.fromJSDate(parsed);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt > nowDt;\n}\n\n/**\n * Get difference between two dates in days\n */\nexport function diffInDays(date1: Date | string, date2: Date | string): number {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return 0;\n\n  const dt1 = DateTime.fromJSDate(parsed1);\n  const dt2 = DateTime.fromJSDate(parsed2);\n\n  return Math.round(dt1.diff(dt2, 'days').days);\n}\n\n// ==========================================\n// Utility Methods\n// ==========================================\n\n/**\n * Add days to a date\n */\nexport function addDays(date: Date | string, days: number, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to addDays');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ days }).toJSDate();\n}\n\n/**\n * Subtract days from a date\n */\nexport function subtractDays(date: Date | string, days: number, timezone?: string): Date {\n  return addDays(date, -days, timezone);\n}\n\n/**\n * Get day of week as DayOfWeek type\n * @param date - Optional date to check (defaults to current date/time)\n * @param timezone - Timezone to use (required)\n * @returns DayOfWeek string (e.g., \"MONDAY\", \"TUESDAY\")\n */\nexport function getDayOfWeek(date: Date | string | undefined, timezone: string): DayOfWeek {\n  let dt: DateTime;\n\n  if (date === undefined) {\n    // Use current date/time in the specified timezone\n    dt = now(timezone);\n  } else {\n    const parsed = parseDate(date);\n    if (!parsed) {\n      throw new Error('Invalid date provided to getDayOfWeek');\n    }\n    dt = DateTime.fromJSDate(parsed);\n    if (timezone && isValidTimezone(timezone)) {\n      dt = dt.setZone(timezone);\n    }\n  }\n\n  // Luxon weekday is 1-7 (Monday-Sunday), DAY_NAMES is 0-indexed (Monday-Sunday)\n  return DAY_NAMES[dt.weekday - 1];\n}\n\n/**\n * Get day of week in Luxon format (1 = Monday, 7 = Sunday)\n * @param date - Date to check\n * @param timezone - Timezone to convert to\n * @returns Weekday number (1-7)\n */\nexport function getWeekday(date: Date | string, timezone?: string): number {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getWeekday');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.weekday; // 1=Monday, 7=Sunday\n}\n\n/**\n * Check if a UTC date is a specific weekday in a user's timezone\n * @param utcDate - UTC date to check\n * @param timezone - User's timezone\n * @param weekday - Weekday to check (1=Monday, 7=Sunday)\n * @returns true if the date is the specified weekday in the user's timezone\n */\nexport function isWeekdayInTimezone(\n  utcDate: Date | string,\n  timezone: string,\n  weekday: number\n): boolean {\n  if (!isValidTimezone(timezone)) {\n    throw new Error(`Invalid timezone: ${timezone}`);\n  }\n\n  if (weekday < 1 || weekday > 7) {\n    throw new Error(`Invalid weekday: ${weekday}. Must be 1-7 (1=Monday, 7=Sunday)`);\n  }\n\n  const parsed = parseDate(utcDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to isWeekdayInTimezone');\n  }\n\n  const dt = DateTime.fromJSDate(parsed, { zone: 'utc' }).setZone(timezone);\n  return dt.weekday === weekday;\n}\n\n/**\n * Get all IANA timezones that are currently at a specific local time\n *\n * Filters the complete list of IANA timezones (~600) to find which ones\n * are currently at the target local hour and optional weekday.\n *\n * @param utcDate - Current UTC date/time\n * @param targetLocalHour - Target local hour (0-23)\n * @param weekday - Optional weekday filter (1=Monday, 7=Sunday)\n * @returns Array of timezone strings that match the criteria\n *\n * @example\n * // Find timezones where it's 5pm (17:00) on a Sunday\n * const utcNow = new Date();\n * const timezones = getTimezonesAtLocalTime(utcNow, 17, 7);\n * // Returns: ['America/New_York', 'America/Toronto', ...] if it's Sunday 5pm there\n */\nexport function getTimezonesAtLocalTime(\n  utcDate: Date | string,\n  targetLocalHour: number,\n  weekday?: number\n): string[] {\n  const parsed = parseDate(utcDate);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getTimezonesAtLocalTime');\n  }\n\n  if (targetLocalHour < 0 || targetLocalHour > 23) {\n    throw new Error(`Invalid target hour: ${targetLocalHour}. Must be 0-23`);\n  }\n\n  if (weekday !== undefined && (weekday < 1 || weekday > 7)) {\n    throw new Error(`Invalid weekday: ${weekday}. Must be 1-7 (1=Monday, 7=Sunday)`);\n  }\n\n  const matchingTimezones: string[] = [];\n\n  // Get all IANA timezones (browser/Node.js built-in)\n  const allTimezones = Intl.supportedValuesOf('timeZone');\n\n  for (const timezone of allTimezones) {\n    try {\n      // Check if this timezone is at the target local hour\n      const localHour = getLocalHour(parsed, timezone);\n      if (localHour !== targetLocalHour) {\n        continue;\n      }\n\n      // If weekday is specified, check if it matches\n      if (weekday !== undefined) {\n        const isMatchingWeekday = isWeekdayInTimezone(parsed, timezone, weekday);\n        if (!isMatchingWeekday) {\n          continue;\n        }\n      }\n\n      matchingTimezones.push(timezone);\n    } catch {\n      // Skip invalid timezones\n      continue;\n    }\n  }\n\n  return matchingTimezones;\n}\n\n/**\n * Get start of week for a date in a specific timezone\n * Week starts on Monday (ISO week)\n */\nexport function startOfWeek(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to startOfWeek');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.startOf('week').toJSDate();\n}\n\n/**\n * Get end of week for a date in a specific timezone\n * Week ends on Sunday (ISO week)\n */\nexport function endOfWeek(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to endOfWeek');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.endOf('week').toJSDate();\n}\n\n/**\n * Add weeks to a date\n */\nexport function addWeeks(date: Date | string, weeks: number, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to addWeeks');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ weeks }).toJSDate();\n}\n\n/**\n * Subtract weeks from a date\n */\nexport function subtractWeeks(date: Date | string, weeks: number, timezone?: string): Date {\n  return addWeeks(date, -weeks, timezone);\n}\n\n/**\n * Get the start of the next week (next Monday)\n */\nexport function getNextWeekStart(date: Date | string, timezone?: string): Date {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getNextWeekStart');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.plus({ weeks: 1 }).startOf('week').toJSDate();\n}\n\n/**\n * Get difference between two dates in weeks\n */\nexport function diffInWeeks(date1: Date | string, date2: Date | string, timezone?: string): number {\n  const parsed1 = parseDate(date1);\n  const parsed2 = parseDate(date2);\n\n  if (!parsed1 || !parsed2) return 0;\n\n  let dt1 = DateTime.fromJSDate(parsed1);\n  let dt2 = DateTime.fromJSDate(parsed2);\n\n  if (timezone && isValidTimezone(timezone)) {\n    dt1 = dt1.setZone(timezone);\n    dt2 = dt2.setZone(timezone);\n  }\n\n  return Math.floor(dt1.diff(dt2, 'weeks').weeks);\n}\n\n/**\n * Get day of week name (e.g., \"Monday\", \"Tuesday\")\n */\nexport function getDayOfWeekName(date: Date | string, timezone?: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to getDayOfWeekName');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toFormat('EEEE');\n}\n\n/**\n * Get ISO date string (YYYY-MM-DD) in a specific timezone\n * Useful for API calls and date comparisons\n */\nexport function toISODate(date: Date | string, timezone?: string): string {\n  const parsed = parseDate(date);\n  if (!parsed) {\n    throw new Error('Invalid date provided to toISODate');\n  }\n\n  let dt = DateTime.fromJSDate(parsed);\n  if (timezone && isValidTimezone(timezone)) {\n    dt = dt.setZone(timezone);\n  }\n\n  return dt.toISODate() || '';\n}\n\n/**\n * Simple date formatter for display purposes\n *\n * Use this to display dates in a consistent format across the UI.\n * Defaults to UTC timezone to prevent display shifts for SQL dates.\n *\n * @param date - Date to format\n * @param options - Intl.DateTimeFormat options (timeZone defaults to UTC)\n * @returns Formatted date string\n *\n * @example\n * formatDate(workout.date)  // \"11/6/2025\"\n * formatDate(workout.date, { weekday: 'long', month: 'long', day: 'numeric' })  // \"Wednesday, November 6\"\n */\nexport function formatDate(\n  date: Date | string | null | undefined,\n  options?: Intl.DateTimeFormatOptions\n): string {\n  const parsed = parseDate(date);\n  if (!parsed) return 'Invalid date';\n\n  return parsed.toLocaleDateString('en-US', {\n    timeZone: 'UTC',\n    ...options\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3851, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/dateContext.ts"],"sourcesContent":["import { formatForAI } from '@/shared/utils/date';\n\n/**\n * Build date/timezone context string\n *\n * @param timezone - User's timezone (IANA format)\n * @param date - Date to format (defaults to now)\n * @returns Formatted context string with XML tags\n */\nexport const buildDateContext = (\n  timezone: string | undefined,\n  date: Date | undefined\n): string => {\n  const effectiveTimezone = timezone || 'America/New_York';\n  const effectiveDate = date || new Date();\n\n  const formattedDate = formatForAI(effectiveDate, effectiveTimezone);\n\n  return `<DateContext>\nToday is ${formattedDate}.\nTimezone: ${effectiveTimezone}\n</DateContext>`;\n};\n"],"names":[],"mappings":";;;;AAAA;;AASO,MAAM,mBAAmB,CAC9B,UACA;IAEA,MAAM,oBAAoB,YAAY;IACtC,MAAM,gBAAgB,QAAQ,IAAI;IAElC,MAAM,gBAAgB,IAAA,qKAAW,EAAC,eAAe;IAEjD,OAAO,CAAC;SACD,EAAE,cAAc;UACf,EAAE,kBAAkB;cAChB,CAAC;AACf"}},
    {"offset": {"line": 3870, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/trainingMeta.ts"],"sourcesContent":["/**\n * Training metadata input for context builder\n */\nexport interface TrainingMetaInput {\n  isDeload?: boolean;\n  absoluteWeek?: number;\n  currentWeek?: number;\n}\n\n/**\n * Build training metadata context string\n *\n * @param data - Training metadata (isDeload, week numbers)\n * @returns Formatted context string with XML tags, or empty string if no data\n */\nexport const buildTrainingMetaContext = (data: TrainingMetaInput): string => {\n  const parts: string[] = [];\n\n  if (data.isDeload !== undefined) {\n    parts.push(`Is Deload Week: ${data.isDeload}`);\n  }\n\n  if (data.absoluteWeek !== undefined) {\n    parts.push(`Absolute Week: ${data.absoluteWeek}`);\n  }\n\n  if (data.currentWeek !== undefined) {\n    parts.push(`Current Week: ${data.currentWeek}`);\n  }\n\n  if (parts.length === 0) {\n    return '';\n  }\n\n  return `<TrainingMeta>${parts.join(' | ')}</TrainingMeta>`;\n};\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AAaM,MAAM,2BAA2B,CAAC;IACvC,MAAM,QAAkB,EAAE;IAE1B,IAAI,KAAK,QAAQ,KAAK,WAAW;QAC/B,MAAM,IAAI,CAAC,CAAC,gBAAgB,EAAE,KAAK,QAAQ,EAAE;IAC/C;IAEA,IAAI,KAAK,YAAY,KAAK,WAAW;QACnC,MAAM,IAAI,CAAC,CAAC,eAAe,EAAE,KAAK,YAAY,EAAE;IAClD;IAEA,IAAI,KAAK,WAAW,KAAK,WAAW;QAClC,MAAM,IAAI,CAAC,CAAC,cAAc,EAAE,KAAK,WAAW,EAAE;IAChD;IAEA,IAAI,MAAM,MAAM,KAAK,GAAG;QACtB,OAAO;IACT;IAEA,OAAO,CAAC,cAAc,EAAE,MAAM,IAAI,CAAC,OAAO,eAAe,CAAC;AAC5D"}},
    {"offset": {"line": 3896, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/microcycle.ts"],"sourcesContent":["import type { Microcycle } from '@/server/models';\n\n/**\n * Build current microcycle context string\n *\n * @param microcycle - Current microcycle data\n * @returns Formatted context string with XML tags\n */\nexport const buildMicrocycleContext = (microcycle: Microcycle | null | undefined): string => {\n  if (!microcycle) {\n    return '<CurrentMicrocycle>No microcycle available</CurrentMicrocycle>';\n  }\n\n  // Format days array for context\n  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];\n  const daysFormatted = (microcycle.days || [])\n    .map((day, index) => `${dayNames[index]}: ${day}`)\n    .join('\\n');\n\n  return `<CurrentMicrocycle>\nWeek Overview: ${microcycle.description || 'N/A'}\nIs Deload: ${microcycle.isDeload}\nAbsolute Week: ${microcycle.absoluteWeek}\nDays:\n${daysFormatted}\n</CurrentMicrocycle>`;\n};\n"],"names":[],"mappings":";;;;AAQO,MAAM,yBAAyB,CAAC;IACrC,IAAI,CAAC,YAAY;QACf,OAAO;IACT;IAEA,gCAAgC;IAChC,MAAM,WAAW;QAAC;QAAU;QAAW;QAAa;QAAY;QAAU;QAAY;KAAS;IAC/F,MAAM,gBAAgB,CAAC,WAAW,IAAI,IAAI,EAAE,EACzC,GAAG,CAAC,CAAC,KAAK,QAAU,GAAG,QAAQ,CAAC,MAAM,CAAC,EAAE,EAAE,KAAK,EAChD,IAAI,CAAC;IAER,OAAO,CAAC;eACK,EAAE,WAAW,WAAW,IAAI,MAAM;WACtC,EAAE,WAAW,QAAQ,CAAC;eAClB,EAAE,WAAW,YAAY,CAAC;;AAEzC,EAAE,cAAc;oBACI,CAAC;AACrB"}},
    {"offset": {"line": 3927, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/dayFormat.ts"],"sourcesContent":["/**\n * Day Format Context Builder\n *\n * Provides formatting rules for different day types (TRAINING, ACTIVE_RECOVERY, REST).\n * Format templates are stored in the prompts table and fetched dynamically.\n */\n\nimport { promptService } from '@/server/services/prompts/promptService';\n\nexport type DayActivityType = 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST';\n\n// Map activity types to prompt IDs\nconst ACTIVITY_TYPE_PROMPT_MAP: Record<DayActivityType, string> = {\n  TRAINING: 'workout:message:format:training',\n  ACTIVE_RECOVERY: 'workout:message:format:active_recovery',\n  REST: 'workout:message:format:rest',\n};\n\n/**\n * Fetch day format prompt from database\n *\n * @param activityType - The type of day (TRAINING, ACTIVE_RECOVERY, REST)\n * @returns The format template string or null if not found\n */\nexport const fetchDayFormat = async (\n  activityType: DayActivityType | null | undefined\n): Promise<string | null> => {\n  if (!activityType) {\n    return null;\n  }\n\n  const promptId = ACTIVITY_TYPE_PROMPT_MAP[activityType];\n  if (!promptId) {\n    return null;\n  }\n\n  try {\n    return await promptService.getContextPrompt(promptId);\n  } catch (error) {\n    console.warn(`[dayFormat] Could not fetch format for ${activityType}:`, error);\n    return null;\n  }\n};\n\n/**\n * Build day format context string\n *\n * @param formatTemplate - The pre-fetched format template\n * @param activityType - The type of day (for labeling)\n * @returns Formatted context string with XML tags\n */\nexport const buildDayFormatContext = (\n  formatTemplate: string | null | undefined,\n  activityType: DayActivityType | null | undefined\n): string => {\n  if (!formatTemplate || !activityType) {\n    return '';\n  }\n\n  return `<DayFormatRules type=\"${activityType}\">\n${formatTemplate.trim()}\n</DayFormatRules>`;\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AAED;;AAIA,mCAAmC;AACnC,MAAM,2BAA4D;IAChE,UAAU;IACV,iBAAiB;IACjB,MAAM;AACR;AAQO,MAAM,iBAAiB,OAC5B;IAEA,IAAI,CAAC,cAAc;QACjB,OAAO;IACT;IAEA,MAAM,WAAW,wBAAwB,CAAC,aAAa;IACvD,IAAI,CAAC,UAAU;QACb,OAAO;IACT;IAEA,IAAI;QACF,OAAO,MAAM,8LAAa,CAAC,gBAAgB,CAAC;IAC9C,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,CAAC,uCAAuC,EAAE,aAAa,CAAC,CAAC,EAAE;QACxE,OAAO;IACT;AACF;AASO,MAAM,wBAAwB,CACnC,gBACA;IAEA,IAAI,CAAC,kBAAkB,CAAC,cAAc;QACpC,OAAO;IACT;IAEA,OAAO,CAAC,sBAAsB,EAAE,aAAa;AAC/C,EAAE,eAAe,IAAI,GAAG;iBACP,CAAC;AAClB"}},
    {"offset": {"line": 3973, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/builders/index.ts"],"sourcesContent":["export { buildUserContext } from './user';\nexport { buildUserProfileContext } from './userProfile';\nexport { buildFitnessPlanContext } from './fitnessPlan';\nexport { buildDayOverviewContext } from './dayOverview';\nexport { buildWorkoutContext } from './workout';\nexport { buildDateContext } from './dateContext';\nexport { buildTrainingMetaContext, type TrainingMetaInput } from './trainingMeta';\nexport { buildMicrocycleContext } from './microcycle';\nexport {\n  buildExperienceLevelContext,\n  fetchExperienceLevelSnippet,\n  SnippetType,\n  type ExperienceLevel,\n} from './experienceLevel';\nexport {\n  buildDayFormatContext,\n  fetchDayFormat,\n  type DayActivityType,\n} from './dayFormat';\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA"}},
    {"offset": {"line": 3998, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/contextService.ts"],"sourcesContent":["import type { UserWithProfile } from '@/server/models';\nimport type { FitnessPlanService } from '@/server/services/training/fitnessPlanService';\nimport type { WorkoutInstanceService } from '@/server/services/training/workoutInstanceService';\nimport type { MicrocycleService } from '@/server/services/training/microcycleService';\nimport type { ProfileRepository } from '@/server/repositories/profileRepository';\nimport { ContextType, type ContextExtras, type ResolvedContextData } from './types';\nimport { SnippetType } from './builders/experienceLevel';\nimport * as builders from './builders';\nimport { today } from '@/shared/utils/date';\n\n/**\n * Dependencies for ContextService\n */\nexport interface ContextServiceDeps {\n  fitnessPlanService: FitnessPlanService;\n  workoutInstanceService: WorkoutInstanceService;\n  microcycleService: MicrocycleService;\n  profileRepository: ProfileRepository;\n}\n\n/**\n * ContextService - Builds context arrays for createAgent\n *\n * Orchestrates fetching context data from domain services and formats\n * it into strings for the agent's context array.\n *\n * @example\n * ```typescript\n * const context = await contextService.getContext(\n *   user,\n *   [ContextType.USER_PROFILE, ContextType.DAY_OVERVIEW, ContextType.TRAINING_META],\n *   { dayOverview: input.dayOverview, isDeload: input.isDeload }\n * );\n *\n * const agent = createAgent({\n *   name: 'workout-generate',\n *   systemPrompt: SYSTEM_PROMPT,\n *   context,\n * }, config);\n * ```\n */\nexport class ContextService {\n  private static instance: ContextService;\n  private deps: ContextServiceDeps;\n\n  private constructor(deps: ContextServiceDeps) {\n    this.deps = deps;\n  }\n\n  /**\n   * Initialize the singleton with dependencies\n   * Must be called before getInstance()\n   */\n  public static initialize(deps: ContextServiceDeps): ContextService {\n    if (!ContextService.instance) {\n      ContextService.instance = new ContextService(deps);\n    }\n    return ContextService.instance;\n  }\n\n  /**\n   * Get the singleton instance\n   * Throws if not initialized\n   */\n  public static getInstance(): ContextService {\n    if (!ContextService.instance) {\n      throw new Error('ContextService not initialized. Call initialize() first.');\n    }\n    return ContextService.instance;\n  }\n\n  /**\n   * Build context array for createAgent\n   *\n   * Determines which services need to be called based on requested context types,\n   * fetches data in parallel, and builds formatted context strings.\n   *\n   * @param user - User with profile\n   * @param types - Array of context types to include\n   * @param extras - Optional caller-provided data (supplements/overrides auto-fetched data)\n   * @returns Array of formatted context strings ready for createAgent\n   */\n  async getContext(\n    user: UserWithProfile,\n    types: ContextType[],\n    extras: ContextExtras = {}\n  ): Promise<string[]> {\n    // Determine which services need to be called\n    const needsFitnessPlan = types.includes(ContextType.FITNESS_PLAN) && !extras.planText;\n    const needsWorkout = types.includes(ContextType.CURRENT_WORKOUT) && extras.workout === undefined;\n    const needsMicrocycle = types.includes(ContextType.CURRENT_MICROCYCLE) && extras.microcycle === undefined;\n    const needsExperienceLevel = types.includes(ContextType.EXPERIENCE_LEVEL) && extras.experienceLevel === undefined;\n    const needsDayFormat = types.includes(ContextType.DAY_FORMAT) && extras.activityType !== undefined;\n    const needsExperienceSnippet = types.includes(ContextType.EXPERIENCE_LEVEL);\n\n    // Fetch required data in parallel (phase 1: data that doesn't depend on other fetches)\n    const targetDate = extras.date || today(user.timezone);\n    const [fitnessPlan, workout, microcycle, structuredProfile, dayFormatTemplate] = await Promise.all([\n      needsFitnessPlan ? this.deps.fitnessPlanService.getCurrentPlan(user.id) : null,\n      needsWorkout ? this.deps.workoutInstanceService.getWorkoutByUserIdAndDate(user.id, targetDate) : null,\n      needsMicrocycle ? this.deps.microcycleService.getMicrocycleByDate(user.id, targetDate) : null,\n      needsExperienceLevel ? this.deps.profileRepository.getCurrentStructuredProfile(user.id) : null,\n      needsDayFormat ? builders.fetchDayFormat(extras.activityType) : null,\n    ]);\n\n    // Resolve experience level (needed for experience snippet fetch)\n    const resolvedExperienceLevel = extras.experienceLevel ?? structuredProfile?.experienceLevel ?? null;\n    const resolvedSnippetType = extras.snippetType || SnippetType.WORKOUT;\n\n    // Phase 2: fetch experience snippet (depends on resolved experience level)\n    const experienceSnippet = needsExperienceSnippet && resolvedExperienceLevel\n      ? await builders.fetchExperienceLevelSnippet(resolvedExperienceLevel, resolvedSnippetType)\n      : null;\n\n    // Build resolved data object\n    const data: ResolvedContextData = {\n      userName: user.name,\n      userGender: user.gender,\n      userAge: user.age,\n      profile: user.profile,\n      planText: extras.planText ?? fitnessPlan?.description,\n      dayOverview: extras.dayOverview,\n      workout: extras.workout ?? workout,\n      microcycle: extras.microcycle ?? microcycle,\n      timezone: user.timezone || 'America/New_York',\n      date: targetDate,\n      isDeload: extras.isDeload,\n      absoluteWeek: extras.absoluteWeek,\n      currentWeek: extras.currentWeek,\n      experienceLevel: resolvedExperienceLevel,\n      snippetType: resolvedSnippetType,\n      activityType: extras.activityType,\n      dayFormatTemplate: dayFormatTemplate,\n      experienceSnippet: experienceSnippet,\n    };\n\n    // Build context strings for each requested type\n    return types\n      .map(type => this.buildContextForType(type, data))\n      .filter(ctx => ctx && ctx.trim().length > 0);\n  }\n\n  /**\n   * Build a single context string by type\n   */\n  private buildContextForType(type: ContextType, data: ResolvedContextData): string {\n    switch (type) {\n      case ContextType.USER:\n        return builders.buildUserContext({ name: data.userName, gender: data.userGender, age: data.userAge });\n      case ContextType.USER_PROFILE:\n        return builders.buildUserProfileContext(data.profile);\n      case ContextType.FITNESS_PLAN:\n        return builders.buildFitnessPlanContext(data.planText);\n      case ContextType.DAY_OVERVIEW:\n        return builders.buildDayOverviewContext(data.dayOverview);\n      case ContextType.CURRENT_WORKOUT:\n        return builders.buildWorkoutContext(data.workout);\n      case ContextType.DATE_CONTEXT:\n        return builders.buildDateContext(data.timezone, data.date);\n      case ContextType.TRAINING_META:\n        return builders.buildTrainingMetaContext({\n          isDeload: data.isDeload,\n          absoluteWeek: data.absoluteWeek,\n          currentWeek: data.currentWeek,\n        });\n      case ContextType.CURRENT_MICROCYCLE:\n        return builders.buildMicrocycleContext(data.microcycle);\n      case ContextType.EXPERIENCE_LEVEL:\n        return builders.buildExperienceLevelContext(\n          data.experienceSnippet,\n          data.experienceLevel,\n          data.snippetType || SnippetType.WORKOUT\n        );\n      case ContextType.DAY_FORMAT:\n        return builders.buildDayFormatContext(data.dayFormatTemplate, data.activityType);\n      default:\n        return '';\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4140, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/context/index.ts"],"sourcesContent":["// Main exports\nexport { ContextService, type ContextServiceDeps } from './contextService';\nexport { ContextType, type ContextExtras, type ResolvedContextData } from './types';\n\n// Re-export builders for direct use when needed\n// Note: SnippetType, ExperienceLevel, and EXPERIENCE_SNIPPETS are exported via builders\nexport * from './builders';\n"],"names":[],"mappings":"AAAA,eAAe;;AACf;AACA;AAEA,gDAAgD;AAChD,wFAAwF;AACxF"}},
    {"offset": {"line": 4197, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/training/workoutAgentService.ts"],"sourcesContent":["import { createAgent, PROMPT_IDS, type ConfigurableAgent } from '@/server/agents';\nimport { WorkoutStructureSchema, type WorkoutStructure } from '@/server/models/workout';\nimport { ModifyWorkoutGenerationOutputSchema } from '@/server/services/agents/prompts/workouts';\nimport type { WorkoutGenerateOutput, ModifyWorkoutOutput } from '@/server/services/agents/types/workouts';\nimport { ContextService, ContextType, SnippetType } from '@/server/services/context';\nimport type { UserWithProfile } from '@/server/models/user';\nimport type { WorkoutInstance } from '@/server/models/workout';\nimport type { ActivityType } from '@/shared/types/microcycle/schema';\n\n/**\n * WorkoutAgentService - Handles all workout-related AI operations\n *\n * Responsibilities:\n * - Fetches context via ContextService\n * - Creates and invokes agents for workout generation/modification\n * - Returns structured results\n *\n * @example\n * ```typescript\n * const result = await workoutAgentService.generateWorkout(user, dayOverview, isDeload);\n * const { response, message, structure } = result;\n * ```\n */\nexport class WorkoutAgentService {\n  private static instance: WorkoutAgentService;\n\n  // Lazy-initialized sub-agents (promises cached after first creation)\n  private messageAgentPromise: Promise<ConfigurableAgent<{ response: string }>> | null = null;\n  private structuredAgentPromise: Promise<ConfigurableAgent<{ response: WorkoutStructure }>> | null = null;\n\n  private constructor() {}\n\n  /**\n   * Lazy-load ContextService to avoid module-load-time initialization\n   */\n  private getContextService(): ContextService {\n    return ContextService.getInstance();\n  }\n\n  public static getInstance(): WorkoutAgentService {\n    if (!WorkoutAgentService.instance) {\n      WorkoutAgentService.instance = new WorkoutAgentService();\n    }\n    return WorkoutAgentService.instance;\n  }\n\n  /**\n   * Get the message sub-agent (lazy-initialized for basic use, or with context)\n   * Prompts fetched from DB based on agent name\n   *\n   * @param user - Optional user for context-aware agent (required when activityType is provided)\n   * @param activityType - Optional activity type for day format context injection\n   */\n  public async getMessageAgent(\n    user?: UserWithProfile,\n    activityType?: ActivityType\n  ): Promise<ConfigurableAgent<{ response: string }>> {\n    // If activityType is provided, create a new agent with day format context\n    if (activityType && user) {\n      const dayFormatContext = await this.getContextService().getContext(\n        user,\n        [ContextType.DAY_FORMAT],\n        { activityType }\n      );\n      return createAgent({\n        name: PROMPT_IDS.WORKOUT_MESSAGE,\n        context: dayFormatContext,\n      }, { model: 'gpt-5-nano' });\n    }\n\n    // Otherwise, use the cached singleton\n    if (!this.messageAgentPromise) {\n      this.messageAgentPromise = createAgent({\n        name: PROMPT_IDS.WORKOUT_MESSAGE,\n      }, { model: 'gpt-5-nano' });\n    }\n    return this.messageAgentPromise;\n  }\n\n  /**\n   * Get the structured sub-agent (lazy-initialized)\n   * Prompts fetched from DB based on agent name\n   */\n  public async getStructuredAgent(): Promise<ConfigurableAgent<{ response: WorkoutStructure }>> {\n    if (!this.structuredAgentPromise) {\n      this.structuredAgentPromise = createAgent({\n        name: PROMPT_IDS.WORKOUT_STRUCTURED,\n        schema: WorkoutStructureSchema,\n      }, { model: 'gpt-5-nano', maxTokens: 32000 });\n    }\n    return this.structuredAgentPromise;\n  }\n\n  /**\n   * Generate a workout for a specific day\n   *\n   * @param user - User with profile\n   * @param dayOverview - Day overview from microcycle (e.g., \"Upper body push focus\")\n   * @param isDeload - Whether this is a deload week\n   * @param activityType - Optional activity type for day format context (TRAINING, ACTIVE_RECOVERY, REST)\n   * @returns WorkoutGenerateOutput with response, message, and structure\n   */\n  async generateWorkout(\n    user: UserWithProfile,\n    dayOverview: string,\n    isDeload: boolean = false,\n    activityType?: ActivityType\n  ): Promise<WorkoutGenerateOutput> {\n    // Build context using ContextService\n    const context = await this.getContextService().getContext(\n      user,\n      [\n        ContextType.USER_PROFILE,\n        ContextType.EXPERIENCE_LEVEL,\n        ContextType.DAY_OVERVIEW,\n        ContextType.TRAINING_META,\n      ],\n      {\n        dayOverview,\n        isDeload,\n        snippetType: SnippetType.WORKOUT,\n      }\n    );\n\n    // Get sub-agents (message agent with day format context if activityType provided)\n    const [messageAgent, structuredAgent] = await Promise.all([\n      this.getMessageAgent(user, activityType),\n      this.getStructuredAgent(),\n    ]);\n\n    // Create main agent with context (prompts fetched from DB)\n    const agent = await createAgent({\n      name: PROMPT_IDS.WORKOUT_GENERATE,\n      context,\n      subAgents: [{ message: messageAgent, structure: structuredAgent }],\n    }, { model: 'gpt-5.1' });\n\n    // Empty input - DB user prompt provides the instructions\n    return agent.invoke('') as Promise<WorkoutGenerateOutput>;\n  }\n\n  /**\n   * Modify an existing workout based on user constraints/requests\n   *\n   * @param user - User with profile\n   * @param workout - Current workout instance to modify\n   * @param changeRequest - User's modification request (e.g., \"I hurt my shoulder\")\n   * @returns ModifyWorkoutOutput with response, message, and structure\n   */\n  async modifyWorkout(\n    user: UserWithProfile,\n    workout: WorkoutInstance,\n    changeRequest: string\n  ): Promise<ModifyWorkoutOutput> {\n    // Build context for modification - uses workout\n    const context = await this.getContextService().getContext(\n      user,\n      [\n        ContextType.USER_PROFILE,\n        ContextType.CURRENT_WORKOUT,\n      ],\n      { workout }\n    );\n\n    // Get sub-agents (lazy-initialized)\n    const [messageAgent, structuredAgent] = await Promise.all([\n      this.getMessageAgent(),\n      this.getStructuredAgent(),\n    ]);\n\n    // Transform to extract overview from JSON response for sub-agents\n    const extractOverview = (mainResult: unknown): string => {\n      const jsonString = typeof mainResult === 'string' ? mainResult : JSON.stringify(mainResult);\n      try {\n        const parsed = JSON.parse(jsonString);\n        return parsed.overview || jsonString;\n      } catch {\n        return jsonString;\n      }\n    };\n\n    // Prompts fetched from DB based on agent name\n    const agent = await createAgent({\n      name: PROMPT_IDS.WORKOUT_MODIFY,\n      context,\n      schema: ModifyWorkoutGenerationOutputSchema,\n      subAgents: [{\n        message: { agent: messageAgent, transform: extractOverview },\n        structure: { agent: structuredAgent, transform: extractOverview },\n      }],\n    }, { model: 'gpt-5-mini' });\n\n    // Pass changeRequest directly as the message - it's the user's request, not context\n    return agent.invoke(changeRequest) as Promise<ModifyWorkoutOutput>;\n  }\n}\n\nexport const workoutAgentService = WorkoutAgentService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4380, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/microcycle/schema.ts"],"sourcesContent":["import { z } from \"zod\";\n\n// ============================================================================\n// Microcycle Structure Schemas (for structured microcycle representation)\n// ============================================================================\n\n/**\n * Activity type enum for microcycle days\n */\nexport const ActivityTypeEnum = z.enum([\"TRAINING\", \"ACTIVE_RECOVERY\", \"REST\"]);\nexport type ActivityType = z.infer<typeof ActivityTypeEnum>;\n\n/**\n * Individual day within a microcycle\n */\nexport const MicrocycleDaySchema = z.object({\n  day: z.enum([\"Monday\", \"Tuesday\", \"Wednesday\", \"Thursday\", \"Friday\", \"Saturday\", \"Sunday\"]),\n  focus: z.string().default(''),\n  activityType: ActivityTypeEnum.default(\"TRAINING\"),\n  notes: z.string().default('')\n});\n\n/**\n * Complete microcycle structure (weekly rhythm)\n */\nexport const MicrocycleStructureSchema = z.object({\n  weekNumber: z.number().default(-1),\n  phase: z.string().default(''),\n  overview: z.string().default(''),\n  days: z.array(MicrocycleDaySchema).length(7), // LLM must provide exactly 7 days\n  isDeload: z.boolean().default(false)\n});\n\nexport type MicrocycleStructure = z.infer<typeof MicrocycleStructureSchema>;\nexport type MicrocycleDay = z.infer<typeof MicrocycleDaySchema>;\n\n// ============================================================================\n// Microcycle Generation Schema (for LLM output)\n// ============================================================================\n\n/**\n * Schema for microcycle generation output\n *\n * Simplified structure:\n * - overview: Description of the week's focus and goals\n * - isDeload: Whether this is a deload week\n * - days: Array of 7 day descriptions (strings)\n */\nexport const _MicrocycleGenerationSchema = z.object({\n  overview: z.string({\n    description: \"Overview of the week's training focus, objectives, and progression context\"\n  }),\n  isDeload: z.boolean({\n    description: \"Whether this is a deload week (reduced volume/intensity)\"\n  }).default(false),\n  days: z.array(z.string(), {\n    description: \"Array of 7 day descriptions (day 1 through day 7). Each string describes the session for that day including theme, focus, volume/intensity targets, and conditioning if applicable.\"\n  }).length(7, \"Must have exactly 7 days\")\n});\n\nexport type MicrocycleGenerationOutput = z.infer<typeof _MicrocycleGenerationSchema>;\n\n/**\n * Full microcycle pattern\n */\nexport interface MicrocyclePattern {\n  overview: string;\n  isDeload: boolean;\n  days: string[];\n  message?: string;\n}\n\n/**\n * Updated microcycle pattern with modification tracking\n */\nexport interface UpdatedMicrocyclePattern extends MicrocyclePattern {\n  modificationsApplied?: string[];\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;;AASO,MAAM,mBAAmB,0MAAC,CAAC,IAAI,CAAC;IAAC;IAAY;IAAmB;CAAO;AAMvE,MAAM,sBAAsB,0MAAC,CAAC,MAAM,CAAC;IAC1C,KAAK,0MAAC,CAAC,IAAI,CAAC;QAAC;QAAU;QAAW;QAAa;QAAY;QAAU;QAAY;KAAS;IAC1F,OAAO,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC1B,cAAc,iBAAiB,OAAO,CAAC;IACvC,OAAO,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;AAC5B;AAKO,MAAM,4BAA4B,0MAAC,CAAC,MAAM,CAAC;IAChD,YAAY,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC;IAChC,OAAO,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC1B,UAAU,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC;IAC7B,MAAM,0MAAC,CAAC,KAAK,CAAC,qBAAqB,MAAM,CAAC;IAC1C,UAAU,0MAAC,CAAC,OAAO,GAAG,OAAO,CAAC;AAChC;AAiBO,MAAM,8BAA8B,0MAAC,CAAC,MAAM,CAAC;IAClD,UAAU,0MAAC,CAAC,MAAM,CAAC;QACjB,aAAa;IACf;IACA,UAAU,0MAAC,CAAC,OAAO,CAAC;QAClB,aAAa;IACf,GAAG,OAAO,CAAC;IACX,MAAM,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI;QACxB,aAAa;IACf,GAAG,MAAM,CAAC,GAAG;AACf"}},
    {"offset": {"line": 4434, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/microcycle/index.ts"],"sourcesContent":["export * from './schema';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 4441, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/microcycle.ts"],"sourcesContent":["import { Microcycles } from '@/server/models/_types';\n\n// Re-export schema types from shared\nexport * from '@/shared/types/microcycle';\n\n// Import for local use\nimport type { MicrocycleStructure } from '@/shared/types/microcycle';\n\n/**\n * Simplified Microcycle interface\n *\n * Changes from previous version:\n * - Uses `days` array instead of 7 separate day columns\n * - Uses `absoluteWeek` instead of mesocycleIndex + weekNumber\n * - No mesocycle dependency\n */\nexport interface Microcycle {\n  id: string;\n  clientId: string;\n  absoluteWeek: number;  // Week from plan start (1-indexed)\n  days: string[];        // Ordered array of day overviews [day1, day2, ..., day7]\n  description?: string | null;\n  isDeload: boolean;\n  message?: string | null;\n  structured?: MicrocycleStructure | null;  // Parsed structured microcycle data\n  startDate: Date;\n  endDate: Date;\n  isActive: boolean;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport class MicrocycleModel {\n  static fromDB(row: Microcycles): Microcycle {\n    return {\n      id: row.id as unknown as string,\n      clientId: row.clientId as unknown as string,\n      absoluteWeek: row.absoluteWeek as unknown as number,\n      days: (row.days as unknown as string[] | null) ?? [],\n      description: (row.description as unknown as string | null) ?? null,\n      isDeload: (row.isDeload as unknown as boolean) ?? false,\n      message: (row.message as unknown as string | null) ?? null,\n      structured: row.structured as MicrocycleStructure | null,\n      startDate: new Date(row.startDate as unknown as string | number | Date),\n      endDate: new Date(row.endDate as unknown as string | number | Date),\n      isActive: (row.isActive as unknown as boolean) ?? true,\n      createdAt: new Date(row.createdAt as unknown as string | number | Date),\n      updatedAt: new Date(row.updatedAt as unknown as string | number | Date),\n    };\n  }\n\n  static toDB(microcycle: Omit<Microcycle, 'id' | 'createdAt' | 'updatedAt'>): Omit<Microcycles, 'id' | 'createdAt' | 'updatedAt'> {\n    return {\n      clientId: microcycle.clientId,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      absoluteWeek: microcycle.absoluteWeek as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      days: microcycle.days as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      description: microcycle.description as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      isDeload: microcycle.isDeload as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      message: microcycle.message as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      structured: microcycle.structured as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      startDate: microcycle.startDate as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      endDate: microcycle.endDate as any,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      isActive: microcycle.isActive as any,\n    };\n  }\n}\n"],"names":[],"mappings":";;;;AAEA,qCAAqC;AACrC;;AA6BO,MAAM;IACX,OAAO,OAAO,GAAgB,EAAc;QAC1C,OAAO;YACL,IAAI,IAAI,EAAE;YACV,UAAU,IAAI,QAAQ;YACtB,cAAc,IAAI,YAAY;YAC9B,MAAM,AAAC,IAAI,IAAI,IAAmC,EAAE;YACpD,aAAa,AAAC,IAAI,WAAW,IAAiC;YAC9D,UAAU,AAAC,IAAI,QAAQ,IAA2B;YAClD,SAAS,AAAC,IAAI,OAAO,IAAiC;YACtD,YAAY,IAAI,UAAU;YAC1B,WAAW,IAAI,KAAK,IAAI,SAAS;YACjC,SAAS,IAAI,KAAK,IAAI,OAAO;YAC7B,UAAU,AAAC,IAAI,QAAQ,IAA2B;YAClD,WAAW,IAAI,KAAK,IAAI,SAAS;YACjC,WAAW,IAAI,KAAK,IAAI,SAAS;QACnC;IACF;IAEA,OAAO,KAAK,UAA8D,EAAuD;QAC/H,OAAO;YACL,UAAU,WAAW,QAAQ;YAC7B,8DAA8D;YAC9D,cAAc,WAAW,YAAY;YACrC,8DAA8D;YAC9D,MAAM,WAAW,IAAI;YACrB,8DAA8D;YAC9D,aAAa,WAAW,WAAW;YACnC,8DAA8D;YAC9D,UAAU,WAAW,QAAQ;YAC7B,8DAA8D;YAC9D,SAAS,WAAW,OAAO;YAC3B,8DAA8D;YAC9D,YAAY,WAAW,UAAU;YACjC,8DAA8D;YAC9D,WAAW,WAAW,SAAS;YAC/B,8DAA8D;YAC9D,SAAS,WAAW,OAAO;YAC3B,8DAA8D;YAC9D,UAAU,WAAW,QAAQ;QAC/B;IACF;AACF"}},
    {"offset": {"line": 4494, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/prompts/microcycles.ts"],"sourcesContent":["/**\n * Microcycles Prompts - All prompts related to microcycle generation and modification\n */\n\nimport { z } from 'zod';\nimport { DAY_NAMES } from '@/shared/utils/date';\n\n// =============================================================================\n// Generate Prompts\n// =============================================================================\n\nexport const MicrocycleGenerationOutputSchema = z.object({\n  overview: z.string({\n    description: 'Comprehensive weekly overview including week number, theme, objective, split, volume/intensity trends, conditioning plan, and rest day placement'\n  }),\n  isDeload: z.boolean().default(false).describe('Whether this is a deload/recovery week with reduced volume and intensity'),\n  days: z.array(z.string(), {\n    description: 'Exactly 7 day overview strings in order: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday'\n  }).length(7)\n});\n\nexport type MicrocycleGenerationOutput = z.infer<typeof MicrocycleGenerationOutputSchema>;\n\nexport const MICROCYCLE_SYSTEM_PROMPT = `\nYou are an expert Strength & Conditioning Programming Manager.\n\nYour job has TWO responsibilities:\n1. **Reasoning:** Analyze the provided \"Fitness Plan Blueprint\" and \"Week Number\" to derive the specific Cycle Phase (e.g., Hypertrophy, Peak, Deload) internally to inform your decision-making.\n2. **Formatting:** Output a strict JSON object with exactly three fields: \\`overview\\`, \\`isDeload\\`, and \\`days\\`.\n\nYou MUST NOT:\n- Add specific exercises or sets/reps (those are generated by a downstream agent).\n- Deviate from the Blueprint's \"Weekly Schedule Template\" unless accommodating a specific user injury/constraint.\n\n============================================================\n# SECTION 1  WEEKLY PATTERN GENERATION LOGIC\n============================================================\n\nYou will receive:\n- A **Fitness Plan Blueprint** (containing the Schedule Template and Progression Strategy).\n- A **User Profile** (containing Anchors and Notes).\n- The **Absolute Week Number**.\n\nYour reasoning MUST follow these rules:\n\n------------------------------------------------------------\n## 1. DERIVE THE PHASE (Internal Logic)\n------------------------------------------------------------\nDo not just guess the intensity. Read the \"Progression Strategy\" in the Plan.\n- **Calculate the Phase:** If the plan says \"4-week blocks (3 up, 1 deload)\" and it is Week 7, you must calculate: \"Week 7 is Week 3 of Block 2 => **Peak Intensity**\".\n- **Apply to Output:** This calculation determines the \"Progression Directive\" you write for each day.\n\n------------------------------------------------------------\n## 2. MAP THE SCHEDULE (The \"Skeleton\")\n------------------------------------------------------------\nMap the Blueprint's \"Weekly Schedule Template\" to this specific week (1-7).\n- **Anchors:** If Day 2 is \"User Anchor - Yoga,\" you MUST output that. Do not overwrite it with lifting.\n- **Double Sessions:** If the Blueprint calls for AM/PM (e.g., \"AM: Run, PM: Lift\"), your output for that day must clearly separate them.\n\n------------------------------------------------------------\n## 3. EXPAND EACH DAY (The \"Instructions\")\n------------------------------------------------------------\nFor each day string, you must include these sections:\n\n1. **Header:** \\`Monday - [Session Type]\\`\n2. **Focus/Objective:** Specific goal for this microcycle.\n3. **Structure:**\n   - If Single Session: \"Standard\"\n   - If Double: \"AM: [Focus] / PM: [Focus]\"\n4. **Primary Patterns:** (e.g., Squat, Hinge, Lunge, Push, Pull, Carry, Gait).\n5. **Progression Directive:**\n   - **CRITICAL:** Specific instructions for the downstream generator based on your internal phase calculation.\n   - *Example (Peak):* \"Push for top singles. Drop accessory volume.\"\n   - *Example (Vol):* \"Keep RPE 7, focus on time under tension.\"\n6. **Intensity/RPE:** Target RIR or RPE.\n7. **Conditioning:** (If applicable).\n8. **Rest Details:** (If Rest Day).\n\n============================================================\n# SECTION 2  OUTPUT FORMAT RULES (STRICT JSON)\n============================================================\n\nYour output MUST be a JSON object with overview, isDeload, and days fields.\nThe days array MUST have exactly 7 entries (Monday to Sunday).\n`;\n\ninterface MicrocycleUserPromptParams {\n  planText: string;\n  clientProfile: string;\n  absoluteWeek: number;\n}\n\nexport const microcycleUserPrompt = ({\n  planText,\n  clientProfile,\n  absoluteWeek,\n}: MicrocycleUserPromptParams) => {\n  return `\nGenerate the Weekly Training Pattern for **Week ${absoluteWeek}**.\n\nYou MUST:\n1. Read the **Progression Strategy** in the Fitness Plan to determine what \"Phase\" Week ${absoluteWeek} falls into (e.g., Accumulation, Peak, or Deload).\n2. Generate the JSON with \\`overview\\`, \\`isDeload\\`, and \\`days\\`.\n3. Respect all **Fixed Anchors** (e.g., Classes) defined in the Plan.\n4. If the Plan specifies **Double Sessions** (AM/PM) for specific days, format the Day String to reflect that.\n\n<FitnessPlan>\n${planText}\n</FitnessPlan>\n\n<ClientProfile>\n${clientProfile || 'No additional user notes'}\n</ClientProfile>\n\n<Context>\nCurrent Week: ${absoluteWeek}\n</Context>\n`.trim();\n};\n\n// =============================================================================\n// Modify Prompts\n// =============================================================================\n\nexport const ModifyMicrocycleOutputSchema = MicrocycleGenerationOutputSchema.extend({\n  wasModified: z.boolean().describe(\n    'Whether the microcycle was actually modified in response to the change request. ' +\n    'False if the current plan already satisfies the request or no changes were needed.'\n  ),\n  modifications: z.string().default('').describe(\n    'Explanation of what changed and why (empty string if wasModified is false). ' +\n    'When wasModified is true, describe specific changes made to the weekly pattern.'\n  )\n});\n\nexport type ModifyMicrocycleOutput = z.infer<typeof ModifyMicrocycleOutputSchema>;\n\nexport const MICROCYCLE_MODIFY_SYSTEM_PROMPT = `\nYou are an expert Strength & Conditioning Programming Manager specializing in **Adaptive Periodization**.\n\nYour goal is to modify an existing weekly microcycle based on user feedback while maintaining the **structural integrity and physiological balance** of the plan.\n\nYou will receive the following context:\n- <User> - Basic user information (name, gender)\n- <UserProfile> - The user's fitness profile\n- <CurrentMicrocycle> - The 7-day schedule as it stands\n- <DateContext> - Today's date including day of week\n\nThe user's change request will be provided as the message.\n\nYou must output a JSON object with: \\`overview\\`, \\`isDeload\\`, \\`days\\`, \\`wasModified\\`, \\`modifications\\`.\n\n============================================================\n# MODIFICATION PRIMITIVES\n============================================================\n\nChoose the correct tactic based on the User Request:\n\n### A. SHIFT (Scheduling Conflicts)\n*User: \"I can't train Thursday. Move it to Saturday.\"*\n- **Action:** Move the Thursday content to Saturday.\n- **Ripple Effect:** If Saturday was a rest day, it is now a training day.\n\n### B. MERGE (Time Constraints)\n*User: \"I missed Monday, add it to Tuesday.\"*\n- **Action:** Combine key patterns from both days.\n- **Prioritization:** Keep the **Compound Lifts** (Squat, Hinge, Push, Pull). Cut isolation/accessory work.\n\n### C. PRUNE (Reduced Frequency)\n*User: \"I only have 2 days left this week.\"*\n- **Action:** Delete the lowest priority sessions (usually Isolation, Mobility, or Conditioning).\n\n### D. ADAPT (Injury/Equipment)\n*User: \"No barbell available\" or \"Back hurts.\"*\n- **Action:** Keep the *Structure* but change the *Primary Patterns* and *Directive*.\n`;\n\n// Note: For modifyMicrocycle, the changeRequest is passed directly to invoke()\n// No static user prompt needed - the user's change request IS the message\n\n// =============================================================================\n// Message Prompts\n// =============================================================================\n\nexport const MICROCYCLE_MESSAGE_SYSTEM_PROMPT = `\nYou are a fitness coach texting your client about their upcoming training week.\n\nYour job is to turn a structured weekly training plan into a short, friendly **SMS message** that summarizes the week in simple, everyday language.\n\nYou are writing TO the client  warm, clear, and personal.\n\n---\n\n## FORBIDDEN TERMS (Never Use)\nClients do NOT understand these. Replace them with everyday language:\n\n- hypertrophy  build muscle\n- microcycle  week\n- RIR / RPE  effort\n- volume  work\n- intensity  weight or effort\n- progressive overload  building up\n- deload  recovery week\n- conditioning  cardio\n\n## SESSION NAME SIMPLIFICATION (STRICT)\nTranslate technical session names into plain English:\n\n- Push  Chest & Shoulders\n- Pull  Back & Arms\n- Upper  Upper Body\n- Lower  Lower Body\n- Rest / Off  Rest Day\n- Deload  Recovery Day\n\n## MESSAGE REQUIREMENTS\n\n### FORMAT\n- Total length **160320 characters** (may be split into two SMS messages joined with \"\\\\n\\\\n\").\n- Use line breaks for the day list.\n- Abbreviate days (Mon, Tue, etc.).\n- Output ONLY the final SMS message text (no JSON, no explanations).\n`;\n\nexport const microcycleMessageUserPrompt = (microcycle: MicrocycleGenerationOutput) => {\n  const daysFormatted = microcycle.days\n    .map((day, index) => `${DAY_NAMES[index]}:\\n${day}`)\n    .join('\\n\\n');\n\n  return `\nGenerate a weekly breakdown SMS message based on the following structured microcycle pattern.\n\nFocus on summarizing the week's training theme and providing a clear, easy-to-read breakdown of training days and rest days for the client.\n\nWEEKLY OVERVIEW:\n${microcycle.overview}\n\nIS DELOAD WEEK: ${microcycle.isDeload}\n\nDAILY BREAKDOWNS:\n\n${daysFormatted}\n\nOutput only the message text (no JSON wrapper) as specified in your system instructions.\n`.trim();\n};\n\n// =============================================================================\n// Structured Prompts\n// =============================================================================\n\nexport const STRUCTURED_MICROCYCLE_SYSTEM_PROMPT = `You are a training program data extraction specialist. Your task is to parse a weekly microcycle overview into a structured format.\n\nEXTRACTION RULES:\n1. Extract the week number from context (provided in input)\n2. Identify the training phase (e.g., \"Strength\", \"Hypertrophy\", \"Deload\", \"Peak\")\n3. Extract the overall weekly overview/goals\n4. Parse EXACTLY 7 days (Monday through Sunday):\n   - day: Day name (enum: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday)\n   - focus: Primary training focus for the day (e.g., \"Upper Body Push\", \"Lower Body\", \"Mobility\")\n   - activityType: TRAINING, ACTIVE_RECOVERY, or REST\n     - TRAINING: Strength, hypertrophy, conditioning, sport-specific training days\n     - ACTIVE_RECOVERY: Light cardio, mobility work, easy recreation days\n     - REST: Full rest days with no structured activity\n   - notes: Any specific instructions or modifications\n5. Determine if this is a deload week (reduced volume/intensity)\n\nOUTPUT FORMAT:\nYou MUST provide exactly 7 days in order: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday.\n\nDEFAULTS:\n- Use empty string (\"\") for text fields that cannot be determined\n- Use -1 for weekNumber if not provided\n- Use false for isDeload if unclear\n- Use \"TRAINING\" as default activityType if unclear`;\n\nexport const structuredMicrocycleUserPrompt = (\n  overview: string,\n  days: string[],\n  absoluteWeek: number,\n  isDeload: boolean\n): string => `Parse the following microcycle into structured format:\n\nWeek Number: ${absoluteWeek}\nIs Deload: ${isDeload}\n\nWeekly Overview:\n${overview}\n\nDay Overviews:\n${days.map((day, i) => {\n  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];\n  return `${dayNames[i]}: ${day}`;\n}).join('\\n\\n')}`;\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;;;;;;;AAED;AAAA;AACA;;;AAMO,MAAM,mCAAmC,0MAAC,CAAC,MAAM,CAAC;IACvD,UAAU,0MAAC,CAAC,MAAM,CAAC;QACjB,aAAa;IACf;IACA,UAAU,0MAAC,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC;IAC9C,MAAM,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI;QACxB,aAAa;IACf,GAAG,MAAM,CAAC;AACZ;AAIO,MAAM,2BAA2B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6DzC,CAAC;AAQM,MAAM,uBAAuB,CAAC,EACnC,QAAQ,EACR,aAAa,EACb,YAAY,EACe;IAC3B,OAAO,CAAC;gDACsC,EAAE,aAAa;;;wFAGyB,EAAE,aAAa;;;;;;AAMvG,EAAE,SAAS;;;;AAIX,EAAE,iBAAiB,2BAA2B;;;;cAIhC,EAAE,aAAa;;AAE7B,CAAC,CAAC,IAAI;AACN;AAMO,MAAM,+BAA+B,iCAAiC,MAAM,CAAC;IAClF,aAAa,0MAAC,CAAC,OAAO,GAAG,QAAQ,CAC/B,qFACA;IAEF,eAAe,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,IAAI,QAAQ,CAC5C,iFACA;AAEJ;AAIO,MAAM,kCAAkC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsChD,CAAC;AASM,MAAM,mCAAmC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsCjD,CAAC;AAEM,MAAM,8BAA8B,CAAC;IAC1C,MAAM,gBAAgB,WAAW,IAAI,CAClC,GAAG,CAAC,CAAC,KAAK,QAAU,GAAG,mKAAS,CAAC,MAAM,CAAC,GAAG,EAAE,KAAK,EAClD,IAAI,CAAC;IAER,OAAO,CAAC;;;;;;AAMV,EAAE,WAAW,QAAQ,CAAC;;gBAEN,EAAE,WAAW,QAAQ,CAAC;;;;AAItC,EAAE,cAAc;;;AAGhB,CAAC,CAAC,IAAI;AACN;AAMO,MAAM,sCAAsC,CAAC;;;;;;;;;;;;;;;;;;;;;;;mDAuBD,CAAC;AAE7C,MAAM,iCAAiC,CAC5C,UACA,MACA,cACA,WACW,CAAC;;aAED,EAAE,aAAa;WACjB,EAAE,SAAS;;;AAGtB,EAAE,SAAS;;;AAGX,EAAE,KAAK,GAAG,CAAC,CAAC,KAAK;QACf,MAAM,WAAW;YAAC;YAAU;YAAW;YAAa;YAAY;YAAU;YAAY;SAAS;QAC/F,OAAO,GAAG,QAAQ,CAAC,EAAE,CAAC,EAAE,EAAE,KAAK;IACjC,GAAG,IAAI,CAAC,SAAS"}},
    {"offset": {"line": 4765, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/training/microcycleAgentService.ts"],"sourcesContent":["import { createAgent, PROMPT_IDS, type ConfigurableAgent } from '@/server/agents';\nimport { MicrocycleStructureSchema, type MicrocycleStructure } from '@/server/models/microcycle';\nimport {\n  MicrocycleGenerationOutputSchema,\n  microcycleMessageUserPrompt,\n  structuredMicrocycleUserPrompt,\n  ModifyMicrocycleOutputSchema,\n  type MicrocycleGenerationOutput,\n} from '@/server/services/agents/prompts/microcycles';\nimport type { MicrocycleGenerateOutput, ModifyMicrocycleOutput } from '@/server/services/agents/types/microcycles';\nimport type { Microcycle } from '@/server/models/microcycle';\nimport { ContextService, ContextType, SnippetType } from '@/server/services/context';\nimport { DAY_NAMES } from '@/shared/utils/date';\nimport type { UserWithProfile } from '@/server/models/user';\n\nconst MAX_RETRIES = 3;\n\n/**\n * Validates that all 7 day strings are non-empty\n */\nconst validateDays = (days: string[]): boolean => {\n  return days.length === 7 && days.every(day => day && day.trim().length > 0);\n};\n\n/**\n * MicrocycleAgentService - Handles all microcycle-related AI operations\n *\n * Responsibilities:\n * - Fetches context via ContextService\n * - Creates and invokes agents for microcycle generation\n * - Includes retry logic for validation\n * - Returns structured results\n *\n * @example\n * ```typescript\n * const result = await microcycleAgentService.generateMicrocycle(user, planText, absoluteWeek, isDeload);\n * const { days, description, isDeload, message, structure } = result;\n * ```\n */\nexport class MicrocycleAgentService {\n  private static instance: MicrocycleAgentService;\n\n  // Lazy-initialized sub-agents (promises cached after first creation)\n  private messageAgentPromise: Promise<ConfigurableAgent<{ response: string }>> | null = null;\n  private structuredAgentPromise: Promise<ConfigurableAgent<{ response: MicrocycleStructure }>> | null = null;\n\n  private constructor() {}\n\n  /**\n   * Lazy-load ContextService to avoid module-load-time initialization\n   */\n  private getContextService(): ContextService {\n    return ContextService.getInstance();\n  }\n\n  public static getInstance(): MicrocycleAgentService {\n    if (!MicrocycleAgentService.instance) {\n      MicrocycleAgentService.instance = new MicrocycleAgentService();\n    }\n    return MicrocycleAgentService.instance;\n  }\n\n  /**\n   * Get the message sub-agent (lazy-initialized)\n   * System prompt fetched from DB, userPrompt transforms JSON data\n   */\n  public async getMessageAgent(): Promise<ConfigurableAgent<{ response: string }>> {\n    if (!this.messageAgentPromise) {\n      this.messageAgentPromise = createAgent({\n        name: PROMPT_IDS.MICROCYCLE_MESSAGE,\n        userPrompt: (input: string) => {\n          const data = JSON.parse(input) as MicrocycleGenerationOutput;\n          return microcycleMessageUserPrompt(data);\n        },\n      }, { model: 'gpt-5-nano' });\n    }\n    return this.messageAgentPromise;\n  }\n\n  /**\n   * Get the structured sub-agent (lazy-initialized)\n   * System prompt fetched from DB, userPrompt transforms JSON data\n   */\n  public async getStructuredAgent(): Promise<ConfigurableAgent<{ response: MicrocycleStructure }>> {\n    if (!this.structuredAgentPromise) {\n      this.structuredAgentPromise = createAgent({\n        name: PROMPT_IDS.MICROCYCLE_STRUCTURED,\n        userPrompt: (input: string) => {\n          const data = JSON.parse(input) as MicrocycleGenerationOutput & { absoluteWeek?: number };\n          return structuredMicrocycleUserPrompt(\n            data.overview,\n            data.days,\n            data.absoluteWeek ?? 1,\n            data.isDeload\n          );\n        },\n        schema: MicrocycleStructureSchema,\n      }, { model: 'gpt-5-nano', maxTokens: 32000 });\n    }\n    return this.structuredAgentPromise;\n  }\n\n  /**\n   * Generate a weekly microcycle training pattern\n   *\n   * Includes retry logic (MAX_RETRIES = 3) with validation to ensure all 7 days are generated.\n   * The agent determines isDeload based on the plan's Progression Strategy and absolute week.\n   * Fitness plan is automatically fetched by the context service.\n   *\n   * @param user - User with profile\n   * @param absoluteWeek - Week number from plan start (1-indexed)\n   * @returns Object with days, description, isDeload, message, and structure (matching legacy format)\n   */\n  async generateMicrocycle(\n    user: UserWithProfile,\n    absoluteWeek: number\n  ): Promise<{\n    days: string[];\n    description: string;\n    isDeload: boolean;\n    message: string;\n    structure?: MicrocycleStructure;\n  }> {\n    // Build context using ContextService\n    // FITNESS_PLAN is auto-fetched by context service\n    // isDeload is determined by agent from plan's Progression Strategy\n    const context = await this.getContextService().getContext(\n      user,\n      [\n        ContextType.FITNESS_PLAN,\n        ContextType.USER_PROFILE,\n        ContextType.EXPERIENCE_LEVEL,\n        ContextType.TRAINING_META,\n      ],\n      {\n        absoluteWeek,\n        snippetType: SnippetType.MICROCYCLE,\n      }\n    );\n\n    // Get sub-agents (lazy-initialized)\n    const [messageAgent, structuredAgent] = await Promise.all([\n      this.getMessageAgent(),\n      this.getStructuredAgent(),\n    ]);\n\n    // Transform to inject absoluteWeek into the JSON for structured agent\n    const injectWeekNumber = (mainResult: unknown): string => {\n      const jsonString = typeof mainResult === 'string' ? mainResult : JSON.stringify(mainResult);\n      try {\n        const parsed = JSON.parse(jsonString);\n        return JSON.stringify({ ...parsed, absoluteWeek });\n      } catch {\n        return jsonString;\n      }\n    };\n\n    // Create main agent with context (prompts fetched from DB)\n    const agent = await createAgent({\n      name: PROMPT_IDS.MICROCYCLE_GENERATE,\n      context,\n      schema: MicrocycleGenerationOutputSchema,\n      subAgents: [{\n        message: messageAgent,\n        structure: { agent: structuredAgent, transform: injectWeekNumber },\n      }],\n    }, { model: 'gpt-5.1' });\n\n    // Execute with retry logic\n    let lastError: Error | null = null;\n\n    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n      try {\n        if (attempt > 1) {\n          console.log(`[microcycle-generate] Retry attempt ${attempt}/${MAX_RETRIES} for week ${absoluteWeek}`);\n        }\n\n        // Pass just the dynamic data - DB user prompt provides instructions\n        const result = await agent.invoke(\n          `Absolute Week: ${absoluteWeek}`\n        ) as MicrocycleGenerateOutput;\n\n        // Validate that all 7 days are present and non-empty\n        if (!validateDays(result.response.days)) {\n          const emptyDayIndices = result.response.days\n            .map((day, index) => (!day || day.trim().length === 0) ? index : -1)\n            .filter(index => index !== -1);\n\n          const missingDays = emptyDayIndices.map(index => DAY_NAMES[index]);\n\n          throw new Error(\n            `Microcycle generate validation failed: Missing or empty days for ${missingDays.join(', ')}. ` +\n            `Expected all 7 days to be present and non-empty.`\n          );\n        }\n\n        console.log(`[microcycle-generate] Successfully generated day overviews and message for week ${absoluteWeek}${attempt > 1 ? ` (after ${attempt} attempts)` : ''}`);\n\n        // Map to legacy format expected by MicrocycleService\n        return {\n          days: result.response.days,\n          description: result.response.overview,\n          isDeload: result.response.isDeload,\n          message: result.message,\n          structure: result.structure,\n        };\n      } catch (error) {\n        lastError = error instanceof Error ? error : new Error(String(error));\n        console.error(`[microcycle-generate] Attempt ${attempt}/${MAX_RETRIES} failed for week ${absoluteWeek}:`, lastError.message);\n\n        // If this was the last attempt, break out\n        if (attempt === MAX_RETRIES) {\n          break;\n        }\n      }\n    }\n\n    // All retries exhausted\n    throw new Error(\n      `Failed to generate microcycle pattern for week ${absoluteWeek} after ${MAX_RETRIES} attempts. ` +\n      `Last error: ${lastError?.message || 'Unknown error'}`\n    );\n  }\n\n  /**\n   * Modify an existing microcycle based on user constraints/requests\n   *\n   * Includes retry logic (MAX_RETRIES = 3) with validation to ensure all 7 days are present.\n   *\n   * @param user - User with profile\n   * @param currentMicrocycle - Current microcycle to modify\n   * @param changeRequest - User's modification request (passed directly to invoke)\n   * @returns Object with days, description, isDeload, message, structure, wasModified, modifications (matching legacy format)\n   */\n  async modifyMicrocycle(\n    user: UserWithProfile,\n    currentMicrocycle: Microcycle,\n    changeRequest: string\n  ): Promise<{\n    days: string[];\n    description: string;\n    isDeload: boolean;\n    message: string;\n    structure?: MicrocycleStructure;\n    wasModified: boolean;\n    modifications: string;\n  }> {\n    // Get absoluteWeek from the current microcycle\n    const absoluteWeek = currentMicrocycle.absoluteWeek;\n\n    // Build context using ContextService\n    const context = await this.getContextService().getContext(\n      user,\n      [\n        ContextType.USER,\n        ContextType.USER_PROFILE,\n        ContextType.CURRENT_MICROCYCLE,\n        ContextType.DATE_CONTEXT,\n      ],\n      { microcycle: currentMicrocycle }\n    );\n\n    // Get sub-agents (lazy-initialized)\n    const [messageAgent, structuredAgent] = await Promise.all([\n      this.getMessageAgent(),\n      this.getStructuredAgent(),\n    ]);\n\n    // Transform to inject absoluteWeek into the JSON for structured agent\n    const injectWeekNumber = (mainResult: unknown): string => {\n      const jsonString = typeof mainResult === 'string' ? mainResult : JSON.stringify(mainResult);\n      try {\n        const parsed = JSON.parse(jsonString);\n        return JSON.stringify({ ...parsed, absoluteWeek });\n      } catch {\n        return jsonString;\n      }\n    };\n\n    // Prompts fetched from DB based on agent name\n    const agent = await createAgent({\n      name: PROMPT_IDS.MICROCYCLE_MODIFY,\n      context,\n      schema: ModifyMicrocycleOutputSchema,\n      subAgents: [{\n        message: messageAgent,\n        structure: { agent: structuredAgent, transform: injectWeekNumber },\n      }],\n    }, { model: 'gpt-5.1' });\n\n    // Execute with retry logic\n    let lastError: Error | null = null;\n\n    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n      try {\n        if (attempt > 1) {\n          console.log(`[microcycle-modify] Retry attempt ${attempt}/${MAX_RETRIES} for week ${absoluteWeek}`);\n        }\n\n        // Pass changeRequest directly as the message - it's the user's request, not context\n        const result = await agent.invoke(changeRequest) as ModifyMicrocycleOutput;\n\n        // Validate that all 7 days are present and non-empty\n        if (!validateDays(result.response.days)) {\n          const emptyDayIndices = result.response.days\n            .map((day, index) => (!day || day.trim().length === 0) ? index : -1)\n            .filter(index => index !== -1);\n\n          const missingDays = emptyDayIndices.map(index => DAY_NAMES[index]);\n\n          throw new Error(\n            `Microcycle modify validation failed: Missing or empty days for ${missingDays.join(', ')}. ` +\n            `Expected all 7 days to be present and non-empty.`\n          );\n        }\n\n        console.log(`[microcycle-modify] Successfully modified day overviews and message for week ${absoluteWeek}${attempt > 1 ? ` (after ${attempt} attempts)` : ''}`);\n\n        // Map to legacy format expected by WorkoutModificationService\n        return {\n          days: result.response.days,\n          description: result.response.overview,\n          isDeload: result.response.isDeload,\n          message: result.message,\n          structure: result.structure,\n          wasModified: result.response.wasModified,\n          modifications: result.response.modifications,\n        };\n      } catch (error) {\n        lastError = error instanceof Error ? error : new Error(String(error));\n        console.error(`[microcycle-modify] Attempt ${attempt}/${MAX_RETRIES} failed for week ${absoluteWeek}:`, lastError.message);\n\n        // If this was the last attempt, break out\n        if (attempt === MAX_RETRIES) {\n          break;\n        }\n      }\n    }\n\n    // All retries exhausted\n    throw new Error(\n      `Failed to modify microcycle pattern for week ${absoluteWeek} after ${MAX_RETRIES} attempts. ` +\n      `Last error: ${lastError?.message || 'Unknown error'}`\n    );\n  }\n}\n\nexport const microcycleAgentService = MicrocycleAgentService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5040, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/prompts/plans.ts"],"sourcesContent":["/**\n * Plans Prompts - All prompts related to fitness plan generation and modification\n */\n\nimport { z } from 'zod';\n\n// =============================================================================\n// Generate Prompts\n// =============================================================================\n\nexport const FITNESS_PLAN_SYSTEM_PROMPT = `\nYou are an expert **Strength & Conditioning Periodization Architect**.\n\nYour goal is to design a high-level **Training Blueprint** (Fitness Plan) for a user based on their specific profile, constraints, and goal hierarchy. You adhere strictly to NASM OPT Model principles regarding frequency and recovery.\n\nYou will receive the user's information in the following context tags:\n- <User> - Basic user information (name, gender)\n- <UserProfile> - The user's fitness profile with goals, constraints, and preferences\n\n============================================================\n# SECTION 1  FIRST PRINCIPLES PROGRAMMING LOGIC\n============================================================\n\n## 1. ANCHOR VS. HABIT DISCRIMINATION (CRITICAL)\n- **True Fixed Anchors:** Look for \"Fixed Anchors\" or \"External Obligations\" in the profile (e.g., \"Soccer Practice,\" \"Yoga Class\"). **Lock these in.**\n- **Historical Habits:** If the profile says \"Currently lifts 3x/week\" or \"Usually runs,\" these are **Baseline Data**, NOT Constraints.\n  - *Action:* You are the Architect. You may completely restructure their split if it better serves their Primary Goal, unless the user explicitly said \"I MUST keep my running schedule.\"\n\n## 2. GOAL HIERARCHY & ARCHETYPE\n- **Strength/Hypertrophy Focus:** 70-100% Lifting.\n- **Endurance Focus:** 60%+ Cardio, 30-40% Lifting.\n- **Hybrid (Concurrent):** ~50/50 split. *CRITICAL: Manage interference effect.* (e.g., Separate Heavy Legs and Sprinting by 24h).\n\n============================================================\n# SECTION 2  NASM SPLIT ARCHITECTURE LOGIC\n============================================================\n\nSelect the split based strictly on the user's available days/week and goal.\n\n## 3 DAYS / WEEK (The Efficiency Model)\n- **Strategy A (Default): Full Body Split.**\n  - *Logic:* High frequency (hit every muscle 3x/week). Superior for metabolic demand and general strength.\n  - *Structure:* Day 1 (Full Body A), Day 3 (Full Body B), Day 5 (Full Body C).\n- **Strategy B (Heavy Lifting Focus): Rotating Upper/Lower.**\n  - *Logic:* Allows for Phase 4 (Max Strength) intensity without burnout.\n  - *Structure:* Rotates weekly (Week 1: U/L/U, Week 2: L/U/L).\n- **Strategy C (Advanced Aesthetics): Modified PPL.**\n  - *Logic:* Only for Phase 3 advanced users who need massive intra-session volume. Warn about low frequency (1x/week).\n\n## 4 DAYS / WEEK (The NASM \"Sweet Spot\")\n- **Strategy A (Default): Upper/Lower Split.**\n  - *Logic:* Optimal balance for Phases 3 & 4. Hits every muscle 2x/week. Built-in recovery days.\n  - *Structure:* Mon (Upper), Tue (Lower), Thu (Upper), Fri (Lower).\n- **Strategy B (Bodybuilding Focus): Synergistic/Body Part.**\n  - *Logic:* For bringing up lagging parts or pure aesthetics.\n  - *Structure:* Day 1 (Chest/Tri), Day 2 (Back/Bi), Day 4 (Legs), Day 5 (Shoulders/Abs).\n\n## 5 DAYS / WEEK (Volume & Specialization)\n- **Strategy A (Athletics/Strength): Hybrid Split (Upper/Lower + PPL OR PPL + Upper/Lower).**\n  - *Logic:* Hits muscles ~1.5-2x/week. Ideal for DUP (Daily Undulating Periodization).\n  - *Structure:* Days 1-2 (Strength/Power), Days 4-6 (Hypertrophy PPL).\n- **Strategy B (Maximum Hypertrophy): The \"Bro Split\" (Classic Body Part).**\n  - *Logic:* 1x frequency, max volume per session. Requires high intensity to justify 6 days rest per muscle.\n  - *Structure:* Chest, Back, Legs, Shoulders, Arms (1 day each).\n\n## 6 DAYS / WEEK (Advanced Frequency)\n- **Strategy A (Default): Push-Pull-Legs (PPL).**\n  - *Logic:* Functional synergy. Grouping muscles by movement pattern.\n  - *Structure:* Push A, Pull A, Legs A, Push B, Pull B, Legs B, Rest.\n- **Strategy B (High Density): The \"Arnold\" (Antagonist) Split.**\n  - *Logic:* Pairs opposing muscles (Chest/Back) for supersets and metabolic demand.\n  - *Structure:* Torso, Extremities (Arms/Delts), Legs.\n- **Critical Constraint:** Day 7 MUST be active recovery or full rest. Monitor for CNS fatigue.\n\n============================================================\n# SECTION 3  VOLUME & ALLOCATION\n============================================================\n\n- **Session Consolidation (NO JUNK VOLUME):**\n  - **Default Rule:** Plan for **ONE** high-quality session per day.\n  - **Double Sessions:** Do **NOT** schedule double sessions unless the user is a competitive athlete or explicitly requested them.\n- **Cardio Integration:**\n  - If Goal = Weight Loss: Integrate cardio on off-days or post-lift.\n  - If Goal = Performance: Periodize cardio to minimize interference.\n\n============================================================\n# SECTION 4  OUTPUT FORMAT\n============================================================\n\nOutput the plan as plain text (no JSON wrapper).\n\nThe plan MUST include these sections IN ORDER:\n\n## PROGRAM ARCHITECTURE\n- **Split Strategy:** (e.g., \"4-Day Upper/Lower Split\")\n- **Rationale:** One sentence explaining why this NASM split fits their profile.\n- **Primary Focus:** The main adaptation (Stabilization, Endurance, Hypertrophy, Strength, Power).\n\n## WEEKLY SCHEDULE TEMPLATE\nDefine the \"Chassis\" of the week.\nFormat:\n- **Day 1 (Monday):**\n  - **Focus:** [e.g., Upper Body Strength]\n  - **Activity Type:** [e.g., Resistance Training + Zone 2 Cardio]\n*(Include brief rationale for the ordering, e.g., \"Legs placed on Friday to allow weekend recovery\")*\n\n## SESSION GUIDELINES\n- **Resistance Training Style:** (e.g., \"3-5 sets, 6-12 reps, 2-0-2 tempo\")\n- **Cardio/Conditioning Protocol:** (e.g., \"HIIT intervals on non-lifting days\")\n- **Anchor Integration:** How workouts interact with fixed classes.\n\n## PROGRESSION STRATEGY\n- **Method:** (e.g., Linear Load Increase, Volume Accumulation, or DUP)\n- **Cadence:** (e.g., \"Increase weight by 5% every 2 weeks\")\n\n## DELOAD PROTOCOL\n- **Trigger:** (e.g., \"Every 6th week\" or \"Performance plateau\")\n- **Implementation:** (e.g., \"Reduce volume by 50%\")\n\n## KEY PRINCIPLES\n- Specific notes for the workout generator regarding injuries, preferences, or equipment limitations.\n\n============================================================\n# RULES\n============================================================\n\n1. **Respect Time Constraints:** If the user has specific days for classes, strictly adhere to them.\n2. **Abstract the Exercises:** Do not list specific exercises. List patterns/focus (e.g., \"Squat Pattern\").\n3. **No JSON:** Plain text output only.\n4. **Do Not Repeat Context:** Start immediately with \"## PROGRAM ARCHITECTURE\".\n`;\n\nexport const FITNESS_PLAN_GENERATE_USER_PROMPT = `\nDesign a comprehensive fitness blueprint for this user.\n\n## Instructions\n1. Analyze the user's profile in the <UserProfile> context to identify **Available Days per Week**.\n2. Select the appropriate **NASM Split Architecture** (3, 4, 5, or 6 days) defined in Section 2.\n   - *Example:* If they have 4 days, prioritize Upper/Lower unless they are purely focused on aesthetics (then use Body Part).\n3. Identify **Fixed Anchors** (classes/obligations) vs **Historical Habits**. Lock in Anchors; optimize Habits.\n4. Construct a **Weekly Schedule Template**.\n   - Prioritize **Single Sessions**.\n5. Ensure the progression model is sustainable.\n`.trim();\n\n// =============================================================================\n// Modify Prompts\n// =============================================================================\n\nexport const ModifyFitnessPlanOutputSchema = z.object({\n  description: z.string().describe(\n    'The updated structured text plan with PROGRAM ARCHITECTURE, WEEKLY SCHEDULE TEMPLATE, ' +\n    'SESSION GUIDELINES, PROGRESSION STRATEGY, DELOAD PROTOCOL, and KEY PRINCIPLES sections'\n  ),\n  wasModified: z.boolean().describe(\n    'Whether the plan was actually modified in response to the change request. ' +\n    'False if the current plan already satisfies the request or no changes were needed.'\n  ),\n  modifications: z.string().default('').describe(\n    'Explanation of what changed and why (empty string if wasModified is false). ' +\n    'When wasModified is true, describe specific changes made to the plan structure.'\n  )\n});\n\nexport type ModifyFitnessPlanOutput = z.infer<typeof ModifyFitnessPlanOutputSchema>;\n\nexport const FITNESS_PLAN_MODIFY_SYSTEM_PROMPT = `\nYou are an expert **Strength & Conditioning Periodization Architect** specializing in **Adaptive Program Design**.\n\nYour goal is to modify an existing Training Blueprint (Fitness Plan) based on user feedback while maintaining the **structural integrity and periodization logic** of the program. You adhere strictly to NASM OPT Model principles regarding frequency and recovery.\n\nYou will receive the following context:\n- <User> - Basic user information (name, gender)\n- <UserProfile> - The user's fitness profile with goals, constraints, and preferences\n- <FitnessPlan> - The complete fitness plan as it currently exists\n\nThe user's change request will be provided as the message.\n\nYou must output a JSON object with: \\`description\\`, \\`wasModified\\`, \\`modifications\\`.\n\n============================================================\n# SECTION 1  MODIFICATION PRIMITIVES\n============================================================\n\nChoose the correct tactic based on the User Request:\n\n### A. RESTRUCTURE (Frequency/Split Changes)\n*User: \"Change from 5 days to 6 days\" or \"Switch to push/pull/legs\"*\n- **Action:** Redesign the WEEKLY SCHEDULE TEMPLATE using **NASM Split Architecture Logic**:\n  - **3 Days:** Full Body (Default) or Rotating Upper/Lower (Strength Focus).\n  - **4 Days:** Upper/Lower (Default) or Synergistic/Body Part (Aesthetics).\n  - **5 Days:** Hybrid Split (Upper/Lower + PPL) or Body Part (Max Hypertrophy).\n  - **6 Days:** PPL (Default) or Arnold Split (Antagonist).\n- **Considerations:**\n  - Maintain appropriate rest (48-72h for same muscle).\n  - Preserve any existing **True Fixed Anchors** (obligations like \"Soccer Practice\").\n\n### B. ANCHOR (Fixed Schedule Changes)\n*User: \"Add yoga on Monday/Friday mornings\" or \"Remove my Tuesday class\"*\n- **Action:** Add or remove the fixed commitment in the WEEKLY SCHEDULE TEMPLATE.\n- **Logic:** Distinguish between **True Anchors** (must keep) and **Habits** (can change).\n- **Integration:** Ensure the surrounding training days account for the anchor:\n  - If adding a yoga class, reduce mobility work from adjacent sessions.\n  - If adding a sport/cardio anchor, manage fatigue for nearby lifting days.\n\n### C. REFOCUS (Goal/Balance Changes)\n*User: \"More cardio\" or \"Focus more on strength\" or \"Add conditioning\"*\n- **Action:** Adjust the balance of session types and update SESSION GUIDELINES.\n- **Updates:**\n  - **Strength/Hypertrophy:** 70-100% Lifting.\n  - **Endurance:** 60%+ Cardio, 30-40% Lifting.\n  - **Hybrid:** ~50/50 split (Manage interference effect).\n  - Update PROGRAM ARCHITECTURE to reflect new primary focus.\n\n### D. CONSTRAIN (Equipment/Time/Limitation Changes)\n*User: \"I joined a new gym\" or \"Only have 45 min per session\" or \"Injured my shoulder\"*\n- **Action:** Update KEY PRINCIPLES and potentially SESSION GUIDELINES.\n- **Scope:** May require adjusting exercise patterns or session structure (Session Consolidation) to accommodate.\n\n============================================================\n# SECTION 2  OUTPUT FORMAT (STRICT JSON)\n============================================================\n\nYou MUST output this JSON structure:\n\n\\`\\`\\`json\n{\n  \"description\": \"Full updated plan text...\",\n  \"wasModified\": boolean,\n  \"modifications\": \"Concise summary of changes made.\"\n}\n\\`\\`\\`\n\n### THE DESCRIPTION FORMAT\nThe \\`description\\` field must contain the COMPLETE plan in plain text with these sections IN ORDER:\n\n## PROGRAM ARCHITECTURE\n- **Split Strategy:** (e.g., \"4-Day Upper/Lower Split\")\n- **Rationale:** One sentence explaining why this NASM split fits their profile.\n- **Primary Focus:** The main adaptation (Stabilization, Endurance, Hypertrophy, Strength, Power).\n\n## WEEKLY SCHEDULE TEMPLATE\nDefine the \"Chassis\" of the week.\nFormat:\n- **Day 1 (Monday):**\n  - **Focus:** [e.g., Upper Body Strength]\n  - **Activity Type:** [e.g., Resistance Training + Zone 2 Cardio]\n*(Include brief rationale for the ordering)*\n\n## SESSION GUIDELINES\n- **Resistance Training Style:** (e.g., \"3-5 sets, 6-12 reps, 2-0-2 tempo\")\n- **Cardio/Conditioning Protocol:** (e.g., \"HIIT intervals on non-lifting days\")\n- **Anchor Integration:** How workouts interact with fixed classes.\n\n## PROGRESSION STRATEGY\n- **Method:** (e.g., Linear Load Increase, Volume Accumulation, or DUP)\n- **Cadence:** (e.g., \"Increase weight by 5% every 2 weeks\")\n\n## DELOAD PROTOCOL\n- **Trigger:** (e.g., \"Every 6th week\" or \"Performance plateau\")\n- **Implementation:** (e.g., \"Reduce volume by 50%\")\n\n## KEY PRINCIPLES\n- Specific notes for the workout generator regarding injuries, preferences, or equipment limitations.\n\n============================================================\n# SECTION 3  RULES\n============================================================\n\n1. **Preserve What Works:** Only change sections directly affected by the request.\n2. **Respect Anchors:** Never remove or move True Fixed Anchors unless explicitly requested.\n3. **No Exercises:** Do not list specific exercises. Use patterns/focus (e.g., \"Squat Pattern\").\n4. **wasModified Logic:**\n   - Set to \\`true\\` if ANY change was made to the plan.\n   - Set to \\`false\\` if the current plan already satisfies the request.\n5. **modifications Summary:** Briefly explain what changed (e.g., \"Restructured to 4-day Upper/Lower split, added yoga anchors on Monday/Friday AM\").\n`;\n\n// Note: For modifyFitnessPlan, the changeRequest is passed directly to invoke()\n// No static user prompt needed - the user's change request IS the message\n\n// =============================================================================\n// Message Prompts\n// =============================================================================\n\nexport interface PlanMessageData {\n  userName: string;\n  userProfile: string;\n  overview: string;\n}\n\nexport const PLAN_SUMMARY_MESSAGE_SYSTEM_PROMPT = `\nYou are a certified personal trainer sending a short, natural text message right after finishing a client's fitness plan.\n\nThe message should sound like a real coach texting  casual, friendly, confident, and easy to understand for anyone. Avoid fitness jargon completely.\n\n## Message Goals:\n1. Let them know their plan is done and ready to start.\n2. Explain what it focuses on (type, goal, duration) in plain, everyday language.\n3. End with a quick, motivating note that fits their experience level.\n\n## Style Rules:\n- Write 1 or 2 short SMS messages total (MAX 2).\n- Each message must be under 160 characters.\n- Separate messages with \"\\\\n\\\\n\".\n- Use first-person tone (\"Just finished your plan\" not \"Your plan is ready\").\n- Do not greet or use their name (they were already greeted).\n- Write how a coach would text: short, real, upbeat, and human.\n- No jargon. Avoid words like \"hypertrophy\", \"microcycle\", \"RIR\", \"volume\", \"intensity\", etc.\n- Use simple terms like \"build muscle\", \"get stronger\", \"recover\", or \"move better\".\n- One emoji max if it feels natural.\n- Keep it positive and motivating, not formal or corporate.\n\n## Tone by Experience:\n- Beginner  clear, encouraging, confidence-building.\n- Intermediate/Advanced  focused, motivating, still simple and natural.\n\n## Output Format:\nReturn ONLY the SMS message text (no JSON wrapper).\nMultiple messages should be separated by \\\\n\\\\n.\n\n## Example Input:\nGenerate a short, friendly onboarding SMS for the client below based on their new fitness plan.\n\n<User>\nName: Jordan Lee\nExperience Level: beginner\n</User>\n\n<Fitness Plan>\nPlan: 8-week full body program focused on building strength, improving energy, and creating a consistent gym routine.\nStructure: 3 workouts per week using simple full body sessions that mix strength and cardio. Week 8 is a lighter recovery week to reset before the next phase.\n</Fitness Plan>\n\nGuidelines:\n- The message is sent right after the trainer finishes creating the plan.\n- It should sound personal, relaxed, and motivating  like a real text from a coach.\n- Focus on what the plan helps them do (build muscle, get stronger, move better, recover well, etc.).\n- Keep everything in plain English. No jargon or fancy terms.\n- Limit to 1 or 2 short messages total (each under 160 characters).\n- No greetings, names, or em dashes.\n- Use one emoji at most if it fits.\n- Output only the message text (no JSON wrapper).\n\n## Example Output:\nJust finished your 8-week full body plan. We'll build strength, improve energy, and lock in your gym routine.\n\nStarts simple and ends with a recovery week\n`;\n\nexport const planSummaryMessageUserPrompt = (data: PlanMessageData) => {\n  return `\nGenerate a short, friendly onboarding SMS for the client below based on their new fitness plan.\n\n<User>\nName: ${data.userName}\n</User>\n\n<User Profile>\n${data.userProfile || 'No profile information available'}\n</User Profile>\n\n<Fitness Plan>\n${data.overview}\n</Fitness Plan>\n\nGuidelines:\n- This message is sent right after the trainer finishes creating the plan.\n- It should sound natural and personal, as if the coach is texting the client directly.\n- Focus on what the plan does and how it's structured (e.g., building from base to strength, using 4-day split, etc.).\n- Translate complex language into clear, human terms.\n- Limit to 1 or 2 messages total (each under 160 characters).\n- Do not greet or include the client's name.\n- Use first-person tone.\n- Avoid em dashes and long sentences.\n- Output only the message text (no JSON wrapper).\n`.trim();\n};\n\n// =============================================================================\n// Structured Prompts\n// =============================================================================\n\nexport const STRUCTURED_PLAN_SYSTEM_PROMPT = `You are a fitness program architecture extraction specialist. Your task is to parse a fitness plan blueprint into a structured format.\n\nEXTRACTION RULES:\n1. Extract the program name from the title or split strategy (e.g., \"Strength + Lean Build Phase\", \"5-Day Upper/Lower Split\")\n2. Identify the program type (e.g., \"Powerbuilding\", \"Hypertrophy\", \"Strength & Conditioning\", \"General Fitness\")\n3. Extract the core strategy - the main approach to achieving the user's goals\n4. Parse progression strategies as an array of distinct methods (e.g., [\"Double progression on compounds\", \"Add weight when hitting top of rep range\"])\n5. Extract the adjustment strategy - when and how to modify the program based on feedback\n6. Parse conditioning guidelines as an array (e.g., [\"2-3 LISS sessions per week\", \"Heart rate 120-140bpm\"])\n7. Build the schedule template from the weekly schedule section:\n   - day: Day of week (e.g., \"Monday\")\n   - focus: Training focus for that day (e.g., \"Upper Body Push\", \"Lower Body\", \"Rest\")\n   - rationale: Why this day has this focus\n8. Determine duration in weeks (-1 if ongoing/not specified)\n9. Count the training frequency per week (number of training days)\n\nFOCUS:\nExtract the HIGH-LEVEL program architecture, not specific exercises.\nLook for patterns in:\n- Split structure (Push/Pull/Legs, Upper/Lower, Full Body, etc.)\n- Periodization approach (linear, undulating, block)\n- Recovery and deload strategies\n- Conditioning integration\n\nDEFAULTS:\n- Use empty string (\"\") for text fields that cannot be determined\n- Use -1 for durationWeeks or frequencyPerWeek if unknown\n- Use empty arrays ([]) for progressionStrategy, conditioning, or scheduleTemplate if not found`;\n\nexport const structuredPlanUserPrompt = (planDescription: string): string => `Parse the following fitness plan into structured format:\n\n${planDescription}`;\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;;;;;AAED;AAAA;;AAMO,MAAM,6BAA6B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwH3C,CAAC;AAEM,MAAM,oCAAoC,CAAC;;;;;;;;;;;AAWlD,CAAC,CAAC,IAAI;AAMC,MAAM,gCAAgC,0MAAC,CAAC,MAAM,CAAC;IACpD,aAAa,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAC9B,2FACA;IAEF,aAAa,0MAAC,CAAC,OAAO,GAAG,QAAQ,CAC/B,+EACA;IAEF,eAAe,0MAAC,CAAC,MAAM,GAAG,OAAO,CAAC,IAAI,QAAQ,CAC5C,iFACA;AAEJ;AAIO,MAAM,oCAAoC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8GlD,CAAC;AAeM,MAAM,qCAAqC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyDnD,CAAC;AAEM,MAAM,+BAA+B,CAAC;IAC3C,OAAO,CAAC;;;;MAIJ,EAAE,KAAK,QAAQ,CAAC;;;;AAItB,EAAE,KAAK,WAAW,IAAI,mCAAmC;;;;AAIzD,EAAE,KAAK,QAAQ,CAAC;;;;;;;;;;;;;AAahB,CAAC,CAAC,IAAI;AACN;AAMO,MAAM,gCAAgC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;+FA2BiD,CAAC;AAEzF,MAAM,2BAA2B,CAAC,kBAAoC,CAAC;;AAE9E,EAAE,iBAAiB"}},
    {"offset": {"line": 5433, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/training/fitnessPlanAgentService.ts"],"sourcesContent":["import { createAgent, PROMPT_IDS, type ConfigurableAgent } from '@/server/agents';\nimport { PlanStructureSchema, type PlanStructure } from '@/server/models/fitnessPlan';\nimport {\n  planSummaryMessageUserPrompt,\n  type PlanMessageData,\n  structuredPlanUserPrompt,\n  ModifyFitnessPlanOutputSchema,\n  type ModifyFitnessPlanOutput,\n} from '@/server/services/agents/prompts/plans';\nimport type { UserWithProfile } from '@/server/models/user';\nimport type { FitnessPlan } from '@/server/models/fitnessPlan';\nimport { ContextService } from '@/server/services/context/contextService';\nimport { ContextType } from '@/server/services/context/types';\n\n/**\n * FitnessPlanAgentService - Handles all fitness plan-related AI operations\n *\n * Responsibilities:\n * - Creates and invokes agents for fitness plan generation\n * - Uses ContextService to build context from user profile\n * - Returns structured results in legacy format\n *\n * @example\n * ```typescript\n * const result = await fitnessPlanAgentService.generateFitnessPlan(user);\n * const { description, message, structure } = result;\n * ```\n */\nexport class FitnessPlanAgentService {\n  private static instance: FitnessPlanAgentService;\n\n  // Lazy-initialized sub-agents (promises cached after first creation)\n  private messageAgentPromise: Promise<ConfigurableAgent<{ response: string }>> | null = null;\n  private structuredAgentPromise: Promise<ConfigurableAgent<{ response: PlanStructure }>> | null = null;\n\n  private getContextService(): ContextService {\n    return ContextService.getInstance();\n  }\n\n  private constructor() {}\n\n  public static getInstance(): FitnessPlanAgentService {\n    if (!FitnessPlanAgentService.instance) {\n      FitnessPlanAgentService.instance = new FitnessPlanAgentService();\n    }\n    return FitnessPlanAgentService.instance;\n  }\n\n  /**\n   * Get the message sub-agent (lazy-initialized)\n   * System prompt fetched from DB, userPrompt transforms JSON data\n   */\n  public async getMessageAgent(): Promise<ConfigurableAgent<{ response: string }>> {\n    if (!this.messageAgentPromise) {\n      this.messageAgentPromise = createAgent({\n        name: PROMPT_IDS.PLAN_MESSAGE,\n        userPrompt: (input: string) => {\n          const data = JSON.parse(input) as PlanMessageData;\n          return planSummaryMessageUserPrompt(data);\n        },\n      }, { model: 'gpt-5-nano' });\n    }\n    return this.messageAgentPromise;\n  }\n\n  /**\n   * Get the structured sub-agent (lazy-initialized)\n   * System prompt fetched from DB, userPrompt transforms JSON data\n   */\n  public async getStructuredAgent(): Promise<ConfigurableAgent<{ response: PlanStructure }>> {\n    if (!this.structuredAgentPromise) {\n      this.structuredAgentPromise = createAgent({\n        name: PROMPT_IDS.PLAN_STRUCTURED,\n        userPrompt: (input: string) => {\n          try {\n            const parsed = JSON.parse(input);\n            const planText = parsed.description || parsed.fitnessPlan || input;\n            return structuredPlanUserPrompt(planText);\n          } catch {\n            return structuredPlanUserPrompt(input);\n          }\n        },\n        schema: PlanStructureSchema,\n      }, { model: 'gpt-5-nano', maxTokens: 32000 });\n    }\n    return this.structuredAgentPromise;\n  }\n\n  /**\n   * Generate a fitness plan for a user\n   *\n   * @param user - User with profile containing goals, preferences, etc.\n   * @returns Object with description, message, and structure (matching legacy format)\n   */\n  async generateFitnessPlan(user: UserWithProfile): Promise<{\n    description: string;\n    message: string;\n    structure: PlanStructure;\n  }> {\n    // Build context using ContextService\n    const context = await this.getContextService().getContext(\n      user,\n      [ContextType.USER, ContextType.USER_PROFILE]\n    );\n\n    // Get sub-agents (lazy-initialized)\n    const [messageAgent, structuredAgent] = await Promise.all([\n      this.getMessageAgent(),\n      this.getStructuredAgent(),\n    ]);\n\n    // Transform to inject user info into the JSON for message agent\n    const injectUserForMessage = (mainResult: unknown): string => {\n      try {\n        const overview = mainResult as string;\n        return JSON.stringify({\n          userName: user.name,\n          userProfile: user.profile || '',\n          overview,\n        } as PlanMessageData);\n      } catch {\n        return JSON.stringify({\n          userName: user.name,\n          userProfile: user.profile || '',\n          overview: mainResult,\n        } as PlanMessageData);\n      }\n    };\n\n    // Create main agent with context (prompts fetched from DB)\n    const agent = await createAgent({\n      name: PROMPT_IDS.PLAN_GENERATE,\n      context,\n      subAgents: [{\n        message: { agent: messageAgent, transform: injectUserForMessage },\n        structure: structuredAgent,\n      }],\n    }, { model: 'gpt-5.1' });\n\n    // Empty input - DB user prompt provides the instructions\n    const result = await agent.invoke('') as {\n      response: string;\n      message: string;\n      structure: PlanStructure;\n    };\n\n    console.log(`[plan-generate] Generated fitness plan for user ${user.id}`);\n\n    // Map to legacy format expected by FitnessPlanService\n    return {\n      description: result.response,\n      message: result.message,\n      structure: result.structure,\n    };\n  }\n\n  /**\n   * Modify an existing fitness plan based on user constraints/requests\n   *\n   * @param user - User with profile\n   * @param currentPlan - Current fitness plan to modify\n   * @param changeRequest - User's modification request\n   * @returns Object with description, wasModified, modifications, structure (matching legacy format)\n   */\n  async modifyFitnessPlan(\n    user: UserWithProfile,\n    currentPlan: FitnessPlan,\n    changeRequest: string\n  ): Promise<{\n    description: string;\n    wasModified: boolean;\n    modifications: string;\n    structure: PlanStructure;\n  }> {\n    // Build context using ContextService\n    const context = await this.getContextService().getContext(\n      user,\n      [ContextType.USER, ContextType.USER_PROFILE, ContextType.FITNESS_PLAN],\n      { planText: currentPlan.description || '' }\n    );\n\n    // Get structured sub-agent (lazy-initialized)\n    const structuredAgent = await this.getStructuredAgent();\n\n    // Prompts fetched from DB based on agent name\n    const agent = await createAgent({\n      name: PROMPT_IDS.PLAN_MODIFY,\n      context,\n      schema: ModifyFitnessPlanOutputSchema,\n      subAgents: [{\n        structure: structuredAgent,  // No message needed for modify\n      }],\n    }, { model: 'gpt-5.1' });\n\n    // Pass changeRequest directly as the message - it's the user's request, not context\n    const result = await agent.invoke(changeRequest) as {\n      response: ModifyFitnessPlanOutput;\n      structure?: PlanStructure;\n      messages?: string[];\n    };\n\n    console.log(`[plan-modify] Modified fitness plan, wasModified: ${result.response.wasModified}`);\n\n    // Map to legacy format expected by PlanModificationService\n    return {\n      description: result.response.description,\n      wasModified: result.response.wasModified,\n      modifications: result.response.modifications,\n      structure: result.structure!,\n    };\n  }\n}\n\nexport const fitnessPlanAgentService = FitnessPlanAgentService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5615, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/training/index.ts"],"sourcesContent":["// Training Agent Services\n// These services handle AI operations for training-related domains\n\nexport { WorkoutAgentService, workoutAgentService } from './workoutAgentService';\nexport { MicrocycleAgentService, microcycleAgentService } from './microcycleAgentService';\nexport { FitnessPlanAgentService, fitnessPlanAgentService } from './fitnessPlanAgentService';\n"],"names":[],"mappings":"AAAA,0BAA0B;AAC1B,mEAAmE;;AAEnE;AACA;AACA"}},
    {"offset": {"line": 5628, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/training/fitnessPlanService.ts"],"sourcesContent":["import { FitnessPlanRepository } from '@/server/repositories/fitnessPlanRepository';\nimport { FitnessPlan, FitnessPlanModel } from '../../models/fitnessPlan';\nimport { UserWithProfile } from '../../models/user';\nimport { fitnessPlanAgentService } from '../agents/training';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\n\n/**\n * Simplified FitnessPlanService\n *\n * Creates and manages fitness plans. Plans are now simple structured text\n * that describe the training split, frequency, goals, and progression rules.\n * No more mesocycle generation - microcycles are generated directly from the plan.\n */\nexport class FitnessPlanService {\n  private static instance: FitnessPlanService;\n  private fitnessPlanRepo: FitnessPlanRepository;\n\n  private constructor() {\n    this.fitnessPlanRepo = new FitnessPlanRepository(postgresDb);\n  }\n\n  public static getInstance(): FitnessPlanService {\n    if (!FitnessPlanService.instance) {\n      FitnessPlanService.instance = new FitnessPlanService();\n    }\n    return FitnessPlanService.instance;\n  }\n\n  /**\n   * Create a new fitness plan for a user\n   *\n   * Uses the FitnessPlanAgent to generate a structured text plan\n   * that contains split, frequency, goals, deload rules, and progression principles.\n   */\n  public async createFitnessPlan(user: UserWithProfile): Promise<FitnessPlan> {\n    // Use AI agent service to generate fitness plan\n    const agentResponse = await fitnessPlanAgentService.generateFitnessPlan(user);\n\n    const fitnessPlan = FitnessPlanModel.fromFitnessPlanOverview(user, agentResponse);\n    console.log('[FitnessPlanService] Created plan:', fitnessPlan.description?.substring(0, 200));\n\n    const savedFitnessPlan = await this.fitnessPlanRepo.insertFitnessPlan(fitnessPlan);\n\n    return savedFitnessPlan;\n  }\n\n  /**\n   * Get the current (latest) fitness plan for a user\n   */\n  public async getCurrentPlan(userId: string): Promise<FitnessPlan | null> {\n    return await this.fitnessPlanRepo.getCurrentPlan(userId);\n  }\n\n  /**\n   * Get a fitness plan by ID\n   */\n  public async getPlanById(planId: string): Promise<FitnessPlan | null> {\n    return await this.fitnessPlanRepo.getFitnessPlan(planId);\n  }\n\n  /**\n   * Get all fitness plans for a user (for history)\n   */\n  public async getPlanHistory(userId: string): Promise<FitnessPlan[]> {\n    return await this.fitnessPlanRepo.getPlanHistory(userId);\n  }\n\n  /**\n   * Update a fitness plan's AI-generated fields\n   */\n  public async updateFitnessPlan(\n    planId: string,\n    updates: Partial<Pick<FitnessPlan, 'description' | 'message' | 'structured'>>\n  ): Promise<FitnessPlan | null> {\n    return await this.fitnessPlanRepo.updateFitnessPlan(planId, updates);\n  }\n\n  /**\n   * Delete a fitness plan by ID\n   */\n  public async deleteFitnessPlan(planId: string): Promise<boolean> {\n    return await this.fitnessPlanRepo.deleteFitnessPlan(planId);\n  }\n}\n\n// Export singleton instance\nexport const fitnessPlanService = FitnessPlanService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AAEA;AAAA;AACA;;;;;AASO,MAAM;IACX,OAAe,SAA6B;IACpC,gBAAuC;IAE/C,aAAsB;QACpB,IAAI,CAAC,eAAe,GAAG,IAAI,uMAAqB,CAAC,0MAAU;IAC7D;IAEA,OAAc,cAAkC;QAC9C,IAAI,CAAC,mBAAmB,QAAQ,EAAE;YAChC,mBAAmB,QAAQ,GAAG,IAAI;QACpC;QACA,OAAO,mBAAmB,QAAQ;IACpC;IAEA;;;;;GAKC,GACD,MAAa,kBAAkB,IAAqB,EAAwB;QAC1E,gDAAgD;QAChD,MAAM,gBAAgB,MAAM,6NAAuB,CAAC,mBAAmB,CAAC;QAExE,MAAM,cAAc,kMAAgB,CAAC,uBAAuB,CAAC,MAAM;QACnE,QAAQ,GAAG,CAAC,sCAAsC,YAAY,WAAW,EAAE,UAAU,GAAG;QAExF,MAAM,mBAAmB,MAAM,IAAI,CAAC,eAAe,CAAC,iBAAiB,CAAC;QAEtE,OAAO;IACT;IAEA;;GAEC,GACD,MAAa,eAAe,MAAc,EAA+B;QACvE,OAAO,MAAM,IAAI,CAAC,eAAe,CAAC,cAAc,CAAC;IACnD;IAEA;;GAEC,GACD,MAAa,YAAY,MAAc,EAA+B;QACpE,OAAO,MAAM,IAAI,CAAC,eAAe,CAAC,cAAc,CAAC;IACnD;IAEA;;GAEC,GACD,MAAa,eAAe,MAAc,EAA0B;QAClE,OAAO,MAAM,IAAI,CAAC,eAAe,CAAC,cAAc,CAAC;IACnD;IAEA;;GAEC,GACD,MAAa,kBACX,MAAc,EACd,OAA6E,EAChD;QAC7B,OAAO,MAAM,IAAI,CAAC,eAAe,CAAC,iBAAiB,CAAC,QAAQ;IAC9D;IAEA;;GAEC,GACD,MAAa,kBAAkB,MAAc,EAAoB;QAC/D,OAAO,MAAM,IAAI,CAAC,eAAe,CAAC,iBAAiB,CAAC;IACtD;AACF;AAGO,MAAM,qBAAqB,mBAAmB,WAAW"}},
    {"offset": {"line": 5699, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/workoutInstanceRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport type {\n  NewWorkoutInstance,\n  WorkoutInstance\n} from '@/server/models/workout';\n\nexport class WorkoutInstanceRepository extends BaseRepository {\n  /**\n   * Create a new workout instance\n   */\n  async create(data: NewWorkoutInstance): Promise<WorkoutInstance> {\n    // Ensure details and structured fields are properly serialized for JSONB columns\n    const serializedData = {\n      ...data,\n      details: typeof data.details === 'string'\n        ? data.details\n        : JSON.stringify(data.details),\n      structured: data.structured\n        ? (typeof data.structured === 'string' ? data.structured : JSON.stringify(data.structured))\n        : null\n    };\n\n    const result = await this.db\n      .insertInto('workoutInstances')\n      .values(serializedData)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Find workout instances for a client within a date range\n   */\n  async findByClientIdAndDateRange(\n    clientId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<WorkoutInstance[]> {\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .where('clientId', '=', clientId)\n      .where('date', '>=', startDate)\n      .where('date', '<=', endDate)\n      .orderBy('date', 'asc')\n      .selectAll()\n      .execute();\n\n    return results;\n  }\n\n  /**\n   * Find a single workout instance by client ID and date\n   */\n  async findByClientIdAndDate(\n    clientId: string,\n    date: Date\n  ): Promise<WorkoutInstance | undefined> {\n    // The incoming date is already midnight in the user's timezone (as a UTC timestamp)\n    // We need to find workouts within the next 24 hours from that point\n    const startOfDay = new Date(date);\n\n    const endOfDay = new Date(date);\n    endOfDay.setUTCDate(endOfDay.getUTCDate() + 1);\n\n    const result = await this.db\n      .selectFrom('workoutInstances')\n      .where('clientId', '=', clientId)\n      .where('date', '>=', startOfDay)\n      .where('date', '<', endOfDay)\n      .selectAll()\n      .executeTakeFirst();\n\n    return result;\n  }\n\n  /**\n   * Get recent workouts for a user\n   * @param userId The user's ID\n   * @param limit Number of workouts to return (default 10)\n   */\n  async getRecentWorkouts(\n    userId: string,\n    limit: number = 10\n  ): Promise<WorkoutInstance[]> {\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .leftJoin('microcycles', 'workoutInstances.microcycleId', 'microcycles.id')\n      .select([\n        'workoutInstances.id',\n        'workoutInstances.clientId',\n        'workoutInstances.microcycleId',\n        'workoutInstances.date',\n        'workoutInstances.sessionType',\n        'workoutInstances.goal',\n        'workoutInstances.details',\n        'workoutInstances.structured',\n        'workoutInstances.description',\n        'workoutInstances.message',\n        'workoutInstances.completedAt',\n        'workoutInstances.createdAt',\n        'workoutInstances.updatedAt',\n        'microcycles.absoluteWeek'\n      ])\n      .where('workoutInstances.clientId', '=', userId)\n      .orderBy('workoutInstances.date', 'desc')\n      .limit(limit)\n      .execute();\n\n    return results as unknown as WorkoutInstance[];\n  }\n\n  /**\n   * Get recent workouts for a user by date range\n   * @param userId The user's ID\n   * @param days Number of days to look back\n   */\n  async getRecentWorkoutsByDays(\n    userId: string,\n    days: number = 7\n  ): Promise<WorkoutInstance[]> {\n    const endDate = new Date();\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .where('clientId', '=', userId)\n      .where('date', '>=', startDate)\n      .where('date', '<=', endDate)\n      .orderBy('date', 'desc')\n      .selectAll()\n      .execute();\n\n    return results;\n  }\n\n  /**\n   * Get workout by specific date\n   * @param userId The user's ID\n   * @param date The specific date\n   */\n  async getWorkoutByDate(\n    userId: string,\n    date: Date\n  ): Promise<WorkoutInstance | undefined> {\n    return this.findByClientIdAndDate(userId, date);\n  }\n\n  /**\n   * Update workout instance\n   * @param id The workout ID\n   * @param data The update data\n   */\n  async update(\n    id: string,\n    data: Partial<NewWorkoutInstance>\n  ): Promise<WorkoutInstance | undefined> {\n    const updateData = {\n      ...data,\n      updatedAt: new Date()\n    };\n\n    if (data.details) {\n      updateData.details = typeof data.details === 'string'\n        ? data.details\n        : JSON.stringify(data.details);\n    }\n\n    if (data.structured !== undefined) {\n      updateData.structured = data.structured\n        ? (typeof data.structured === 'string' ? data.structured : JSON.stringify(data.structured))\n        : null;\n    }\n\n    const result = await this.db\n      .updateTable('workoutInstances')\n      .set(updateData)\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst();\n\n    return result;\n  }\n\n  /**\n   * Delete old workout instances (cleanup)\n   * @param daysToKeep Number of days to keep\n   */\n  async deleteOldWorkouts(daysToKeep: number = 90): Promise<number> {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);\n\n    const result = await this.db\n      .deleteFrom('workoutInstances')\n      .where('date', '<', cutoffDate)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows);\n  }\n\n  /**\n   * Get a workout by its ID\n   * @param workoutId The workout's ID\n   */\n  async getWorkoutById(workoutId: string): Promise<WorkoutInstance | undefined> {\n    const result = await this.db\n      .selectFrom('workoutInstances')\n      .selectAll()\n      .where('id', '=', workoutId)\n      .executeTakeFirst();\n\n    return result;\n  }\n\n  /**\n   * Get workouts by microcycle\n   * @param userId The user's ID\n   * @param microcycleId The microcycle ID\n   */\n  async getWorkoutsByMicrocycle(\n    userId: string,\n    microcycleId: string\n  ): Promise<WorkoutInstance[]> {\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .where('clientId', '=', userId)\n      .where('microcycleId', '=', microcycleId)\n      .orderBy('date', 'asc')\n      .selectAll()\n      .execute();\n\n    return results;\n  }\n\n  /**\n   * Get workouts by date range for microcycle week view\n   * @param userId The user's ID\n   * @param startDate Start date of the week\n   * @param endDate End date of the week\n   */\n  async getWorkoutsByDateRange(\n    userId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<WorkoutInstance[]> {\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .leftJoin('microcycles', 'workoutInstances.microcycleId', 'microcycles.id')\n      .select([\n        'workoutInstances.id',\n        'workoutInstances.clientId',\n        'workoutInstances.microcycleId',\n        'workoutInstances.date',\n        'workoutInstances.sessionType',\n        'workoutInstances.goal',\n        'workoutInstances.details',\n        'workoutInstances.structured',\n        'workoutInstances.description',\n        'workoutInstances.message',\n        'workoutInstances.completedAt',\n        'workoutInstances.createdAt',\n        'workoutInstances.updatedAt',\n        'microcycles.absoluteWeek'\n      ])\n      .where('workoutInstances.clientId', '=', userId)\n      .where('workoutInstances.date', '>=', startDate)\n      .where('workoutInstances.date', '<=', endDate)\n      .orderBy('workoutInstances.date', 'asc')\n      .execute();\n\n    return results as unknown as WorkoutInstance[];\n  }\n\n  /**\n   * Delete a workout instance by ID\n   * @param workoutId The workout's ID\n   */\n  async delete(workoutId: string): Promise<boolean> {\n    const result = await this.db\n      .deleteFrom('workoutInstances')\n      .where('id', '=', workoutId)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows) > 0;\n  }\n\n  /**\n   * Find which users already have workouts for their respective \"today\"\n   * Used for catch-up logic to avoid sending duplicate daily messages\n   * @param userDatePairs Array of user IDs with their timezone-specific date ranges\n   * @returns Set of user IDs that already have workouts\n   */\n  async findUserIdsWithWorkoutsForUserDates(\n    userDatePairs: Array<{ userId: string; startOfDay: Date; endOfDay: Date }>\n  ): Promise<Set<string>> {\n    if (userDatePairs.length === 0) {\n      return new Set();\n    }\n\n    // Build OR conditions for each user/date pair\n    const results = await this.db\n      .selectFrom('workoutInstances')\n      .select('clientId')\n      .where((eb) => {\n        const conditions = userDatePairs.map(({ userId, startOfDay, endOfDay }) =>\n          eb.and([\n            eb('clientId', '=', userId),\n            eb('date', '>=', startOfDay),\n            eb('date', '<', endOfDay)\n          ])\n        );\n        return eb.or(conditions);\n      })\n      .execute();\n\n    return new Set(results.map(r => r.clientId));\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAMO,MAAM,kCAAkC,yLAAc;IAC3D;;GAEC,GACD,MAAM,OAAO,IAAwB,EAA4B;QAC/D,iFAAiF;QACjF,MAAM,iBAAiB;YACrB,GAAG,IAAI;YACP,SAAS,OAAO,KAAK,OAAO,KAAK,WAC7B,KAAK,OAAO,GACZ,KAAK,SAAS,CAAC,KAAK,OAAO;YAC/B,YAAY,KAAK,UAAU,GACtB,OAAO,KAAK,UAAU,KAAK,WAAW,KAAK,UAAU,GAAG,KAAK,SAAS,CAAC,KAAK,UAAU,IACvF;QACN;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,oBACX,MAAM,CAAC,gBACP,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,2BACJ,QAAgB,EAChB,SAAe,EACf,OAAa,EACe;QAC5B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,KAAK,CAAC,YAAY,KAAK,UACvB,KAAK,CAAC,QAAQ,MAAM,WACpB,KAAK,CAAC,QAAQ,MAAM,SACpB,OAAO,CAAC,QAAQ,OAChB,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,sBACJ,QAAgB,EAChB,IAAU,EAC4B;QACtC,oFAAoF;QACpF,oEAAoE;QACpE,MAAM,aAAa,IAAI,KAAK;QAE5B,MAAM,WAAW,IAAI,KAAK;QAC1B,SAAS,UAAU,CAAC,SAAS,UAAU,KAAK;QAE5C,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,oBACX,KAAK,CAAC,YAAY,KAAK,UACvB,KAAK,CAAC,QAAQ,MAAM,YACpB,KAAK,CAAC,QAAQ,KAAK,UACnB,SAAS,GACT,gBAAgB;QAEnB,OAAO;IACT;IAEA;;;;GAIC,GACD,MAAM,kBACJ,MAAc,EACd,QAAgB,EAAE,EACU;QAC5B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,QAAQ,CAAC,eAAe,iCAAiC,kBACzD,MAAM,CAAC;YACN;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD,EACA,KAAK,CAAC,6BAA6B,KAAK,QACxC,OAAO,CAAC,yBAAyB,QACjC,KAAK,CAAC,OACN,OAAO;QAEV,OAAO;IACT;IAEA;;;;GAIC,GACD,MAAM,wBACJ,MAAc,EACd,OAAe,CAAC,EACY;QAC5B,MAAM,UAAU,IAAI;QACpB,MAAM,YAAY,IAAI;QACtB,UAAU,OAAO,CAAC,UAAU,OAAO,KAAK;QAExC,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,KAAK,CAAC,YAAY,KAAK,QACvB,KAAK,CAAC,QAAQ,MAAM,WACpB,KAAK,CAAC,QAAQ,MAAM,SACpB,OAAO,CAAC,QAAQ,QAChB,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;;;GAIC,GACD,MAAM,iBACJ,MAAc,EACd,IAAU,EAC4B;QACtC,OAAO,IAAI,CAAC,qBAAqB,CAAC,QAAQ;IAC5C;IAEA;;;;GAIC,GACD,MAAM,OACJ,EAAU,EACV,IAAiC,EACK;QACtC,MAAM,aAAa;YACjB,GAAG,IAAI;YACP,WAAW,IAAI;QACjB;QAEA,IAAI,KAAK,OAAO,EAAE;YAChB,WAAW,OAAO,GAAG,OAAO,KAAK,OAAO,KAAK,WACzC,KAAK,OAAO,GACZ,KAAK,SAAS,CAAC,KAAK,OAAO;QACjC;QAEA,IAAI,KAAK,UAAU,KAAK,WAAW;YACjC,WAAW,UAAU,GAAG,KAAK,UAAU,GAClC,OAAO,KAAK,UAAU,KAAK,WAAW,KAAK,UAAU,GAAG,KAAK,SAAS,CAAC,KAAK,UAAU,IACvF;QACN;QAEA,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,WAAW,CAAC,oBACZ,GAAG,CAAC,YACJ,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,gBAAgB;QAEnB,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,kBAAkB,aAAqB,EAAE,EAAmB;QAChE,MAAM,aAAa,IAAI;QACvB,WAAW,OAAO,CAAC,WAAW,OAAO,KAAK;QAE1C,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,oBACX,KAAK,CAAC,QAAQ,KAAK,YACnB,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc;IACrC;IAEA;;;GAGC,GACD,MAAM,eAAe,SAAiB,EAAwC;QAC5E,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,oBACX,SAAS,GACT,KAAK,CAAC,MAAM,KAAK,WACjB,gBAAgB;QAEnB,OAAO;IACT;IAEA;;;;GAIC,GACD,MAAM,wBACJ,MAAc,EACd,YAAoB,EACQ;QAC5B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,KAAK,CAAC,YAAY,KAAK,QACvB,KAAK,CAAC,gBAAgB,KAAK,cAC3B,OAAO,CAAC,QAAQ,OAChB,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;;;;GAKC,GACD,MAAM,uBACJ,MAAc,EACd,SAAe,EACf,OAAa,EACe;QAC5B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,QAAQ,CAAC,eAAe,iCAAiC,kBACzD,MAAM,CAAC;YACN;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD,EACA,KAAK,CAAC,6BAA6B,KAAK,QACxC,KAAK,CAAC,yBAAyB,MAAM,WACrC,KAAK,CAAC,yBAAyB,MAAM,SACrC,OAAO,CAAC,yBAAyB,OACjC,OAAO;QAEV,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,OAAO,SAAiB,EAAoB;QAChD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,oBACX,KAAK,CAAC,MAAM,KAAK,WACjB,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;IAEA;;;;;GAKC,GACD,MAAM,oCACJ,aAA0E,EACpD;QACtB,IAAI,cAAc,MAAM,KAAK,GAAG;YAC9B,OAAO,IAAI;QACb;QAEA,8CAA8C;QAC9C,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,oBACX,MAAM,CAAC,YACP,KAAK,CAAC,CAAC;YACN,MAAM,aAAa,cAAc,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE,GACpE,GAAG,GAAG,CAAC;oBACL,GAAG,YAAY,KAAK;oBACpB,GAAG,QAAQ,MAAM;oBACjB,GAAG,QAAQ,KAAK;iBACjB;YAEH,OAAO,GAAG,EAAE,CAAC;QACf,GACC,OAAO;QAEV,OAAO,IAAI,IAAI,QAAQ,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ;IAC5C;AACF"}},
    {"offset": {"line": 5874, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/microcycleRepository.ts"],"sourcesContent":["import { Kysely } from 'kysely';\nimport { v4 as uuidv4 } from 'uuid';\nimport { DB } from '@/server/models/_types';\nimport { Microcycle, MicrocycleModel } from '@/server/models/microcycle';\n\n/**\n * Repository for microcycle database operations\n *\n * Microcycles now use:\n * - absoluteWeek: Week number from plan start (1-indexed)\n * - days: Ordered array of day descriptions\n * - No mesocycleIndex or weekNumber\n */\nexport class MicrocycleRepository {\n  constructor(private db: Kysely<DB>) {}\n\n  async createMicrocycle(microcycle: Omit<Microcycle, 'id' | 'createdAt' | 'updatedAt'>): Promise<Microcycle> {\n    const result = await this.db\n      .insertInto('microcycles')\n      .values({\n        id: uuidv4(),\n        clientId: microcycle.clientId,\n        absoluteWeek: microcycle.absoluteWeek,\n        days: microcycle.days,\n        description: microcycle.description,\n        isDeload: microcycle.isDeload,\n        message: microcycle.message,\n        structured: microcycle.structured ? JSON.stringify(microcycle.structured) : null,\n        startDate: microcycle.startDate,\n        endDate: microcycle.endDate,\n        isActive: microcycle.isActive,\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return MicrocycleModel.fromDB(result as any);\n  }\n\n  async getActiveMicrocycle(clientId: string): Promise<Microcycle | null> {\n    const result = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('isActive', '=', true)\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return result ? MicrocycleModel.fromDB(result as any) : null;\n  }\n\n  /**\n   * Get microcycle by absolute week number\n   * Queries by clientId + absoluteWeek only (not fitnessPlanId)\n   * Returns most recently updated if duplicates exist\n   */\n  async getMicrocycleByAbsoluteWeek(\n    clientId: string,\n    absoluteWeek: number\n  ): Promise<Microcycle | null> {\n    const result = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('absoluteWeek', '=', absoluteWeek)\n      .orderBy('updatedAt', 'desc')\n      .executeTakeFirst();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return result ? MicrocycleModel.fromDB(result as any) : null;\n  }\n\n  async deactivatePreviousMicrocycles(clientId: string): Promise<void> {\n    await this.db\n      .updateTable('microcycles')\n      .set({ isActive: false })\n      .where('clientId', '=', clientId)\n      .where('isActive', '=', true)\n      .execute();\n  }\n\n  async updateMicrocycle(id: string, updates: Partial<Omit<Microcycle, 'id' | 'createdAt' | 'updatedAt'>>): Promise<Microcycle | null> {\n    const updateData: Record<string, unknown> = {};\n\n    if (updates.days !== undefined) {\n      updateData.days = updates.days;\n    }\n    if (updates.description !== undefined) {\n      updateData.description = updates.description;\n    }\n    if (updates.isDeload !== undefined) {\n      updateData.isDeload = updates.isDeload;\n    }\n    if (updates.message !== undefined) {\n      updateData.message = updates.message;\n    }\n    if (updates.structured !== undefined) {\n      updateData.structured = updates.structured ? JSON.stringify(updates.structured) : null;\n    }\n    if (updates.isActive !== undefined) {\n      updateData.isActive = updates.isActive;\n    }\n    if (updates.startDate !== undefined) {\n      updateData.startDate = updates.startDate;\n    }\n    if (updates.endDate !== undefined) {\n      updateData.endDate = updates.endDate;\n    }\n    if (updates.absoluteWeek !== undefined) {\n      updateData.absoluteWeek = updates.absoluteWeek;\n    }\n\n    if (Object.keys(updateData).length === 0) {\n      // No updates to perform\n      return this.getMicrocycleById(id);\n    }\n\n    const result = await this.db\n      .updateTable('microcycles')\n      .set({\n        ...updateData,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return result ? MicrocycleModel.fromDB(result as any) : null;\n  }\n\n  async getMicrocycleById(id: string): Promise<Microcycle | null> {\n    const result = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return result ? MicrocycleModel.fromDB(result as any) : null;\n  }\n\n  async getRecentMicrocycles(clientId: string, limit: number = 5): Promise<Microcycle[]> {\n    const results = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .execute();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return results.map((r) => MicrocycleModel.fromDB(r as any));\n  }\n\n  async deleteMicrocycle(id: string): Promise<boolean> {\n    const result = await this.db\n      .deleteFrom('microcycles')\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return result.numDeletedRows > 0;\n  }\n\n  /**\n   * Get all microcycles for a client ordered by absolute week\n   */\n  async getAllMicrocycles(clientId: string): Promise<Microcycle[]> {\n    const results = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('absoluteWeek', 'asc')\n      .execute();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return results.map((r) => MicrocycleModel.fromDB(r as any));\n  }\n\n  /**\n   * Get microcycle for a specific date\n   * Used for date-based progress tracking - finds the microcycle that contains the target date\n   * Queries by clientId + date range only (not fitnessPlanId)\n   * Returns most recently updated if duplicates exist\n   */\n  async getMicrocycleByDate(\n    clientId: string,\n    targetDate: Date\n  ): Promise<Microcycle | null> {\n    const result = await this.db\n      .selectFrom('microcycles')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('startDate', '<=', targetDate)\n      .where('endDate', '>=', targetDate)\n      .orderBy('updatedAt', 'desc')\n      .executeTakeFirst();\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return result ? MicrocycleModel.fromDB(result as any) : null;\n  }\n\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5999, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/utils/phoneUtils.ts"],"sourcesContent":["/**\n * Centralized phone number utilities for US-based phone numbers\n * \n * GymText assumes all users are US-based, so all phone numbers\n * should be normalized to +1XXXXXXXXXX format.\n */\n\n/**\n * Normalizes a phone number input to US E.164 format (+1XXXXXXXXXX)\n * \n * Supported input formats:\n * - 3392223571  +13392223571 (10 digits, adds +1 prefix)\n * - 13392223571  +13392223571 (11 digits starting with 1, adds + prefix)\n * - +13392223571  +13392223571 (already formatted, no change)\n * \n * @param input - Phone number in various formats\n * @returns Normalized phone number or null if invalid\n */\nexport function normalizeUSPhoneNumber(input: string | null | undefined): string | null {\n  if (!input || typeof input !== 'string') {\n    return null;\n  }\n  \n  // Remove all non-numeric characters\n  const digits = input.replace(/\\D/g, '');\n  \n  if (!digits) {\n    return null;\n  }\n  \n  // Handle different input formats\n  if (digits.length === 10) {\n    // US number without country code: 3392223571\n    // Validate that it starts with a valid area code (2-9 for first digit)\n    if (digits[0] >= '2' && digits[0] <= '9') {\n      return `+1${digits}`;\n    }\n  } else if (digits.length === 11 && digits.startsWith('1')) {\n    // US number with country code: 13392223571\n    // Validate that area code starts with valid digit (2-9 for 4th digit)\n    if (digits[1] >= '2' && digits[1] <= '9') {\n      return `+${digits}`;\n    }\n  } else if (input.startsWith('+1') && digits.length === 11 && digits.startsWith('1')) {\n    // Already formatted: +13392223571\n    // Validate format\n    if (digits[1] >= '2' && digits[1] <= '9') {\n      return input;\n    }\n  }\n  \n  // Invalid format or length\n  return null;\n}\n\n/**\n * Validates that a phone number is a properly formatted US phone number\n * \n * @param phone - Phone number to validate\n * @returns true if valid US phone number, false otherwise\n */\nexport function validateUSPhoneNumber(phone: string | null | undefined): boolean {\n  if (!phone || typeof phone !== 'string') {\n    return false;\n  }\n  \n  // Must be in E.164 format for US: +1XXXXXXXXXX\n  // Area code (first 3 digits after +1) must start with 2-9\n  // Exchange code (next 3 digits) must start with 2-9\n  const e164USRegex = /^\\+1[2-9]\\d{2}[2-9]\\d{6}$/;\n  return e164USRegex.test(phone);\n}\n\n/**\n * Checks if a phone number is a US phone number (starts with +1)\n * \n * @param phone - Phone number to check\n * @returns true if starts with +1, false otherwise\n */\nexport function isUSPhoneNumber(phone: string): boolean {\n  return typeof phone === 'string' && phone.startsWith('+1');\n}\n\n/**\n * Formats a US phone number for display purposes\n * +13392223571  (339) 222-3571\n * \n * @param phone - Normalized US phone number (+1XXXXXXXXXX)\n * @returns Formatted phone number or original input if invalid\n */\nexport function formatUSPhoneForDisplay(phone: string): string {\n  if (!validateUSPhoneNumber(phone)) {\n    return phone;\n  }\n  \n  // Remove +1 and format as (XXX) XXX-XXXX\n  const digits = phone.slice(2); // Remove +1\n  return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;\n}\n\n/**\n * Type guard for normalized phone numbers\n */\nexport type NormalizedUSPhone = string & { __brand: 'NormalizedUSPhone' };\n\n/**\n * Creates a branded type for validated US phone numbers\n * \n * @param phone - Phone number to validate and brand\n * @returns Branded phone number if valid, null otherwise\n */\nexport function createNormalizedUSPhone(phone: string): NormalizedUSPhone | null {\n  if (validateUSPhoneNumber(phone)) {\n    return phone as NormalizedUSPhone;\n  }\n  return null;\n}"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;;;;;;;;CAUC;;;;;;;;;;;;AACM,SAAS,uBAAuB,KAAgC;IACrE,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,OAAO;IACT;IAEA,oCAAoC;IACpC,MAAM,SAAS,MAAM,OAAO,CAAC,OAAO;IAEpC,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,OAAO,MAAM,KAAK,IAAI;QACxB,6CAA6C;QAC7C,uEAAuE;QACvE,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO,CAAC,EAAE,EAAE,QAAQ;QACtB;IACF,OAAO,IAAI,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACzD,2CAA2C;QAC3C,sEAAsE;QACtE,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO,CAAC,CAAC,EAAE,QAAQ;QACrB;IACF,OAAO,IAAI,MAAM,UAAU,CAAC,SAAS,OAAO,MAAM,KAAK,MAAM,OAAO,UAAU,CAAC,MAAM;QACnF,kCAAkC;QAClC,kBAAkB;QAClB,IAAI,MAAM,CAAC,EAAE,IAAI,OAAO,MAAM,CAAC,EAAE,IAAI,KAAK;YACxC,OAAO;QACT;IACF;IAEA,2BAA2B;IAC3B,OAAO;AACT;AAQO,SAAS,sBAAsB,KAAgC;IACpE,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,OAAO;IACT;IAEA,+CAA+C;IAC/C,0DAA0D;IAC1D,oDAAoD;IACpD,MAAM,cAAc;IACpB,OAAO,YAAY,IAAI,CAAC;AAC1B;AAQO,SAAS,gBAAgB,KAAa;IAC3C,OAAO,OAAO,UAAU,YAAY,MAAM,UAAU,CAAC;AACvD;AASO,SAAS,wBAAwB,KAAa;IACnD,IAAI,CAAC,sBAAsB,QAAQ;QACjC,OAAO;IACT;IAEA,yCAAyC;IACzC,MAAM,SAAS,MAAM,KAAK,CAAC,IAAI,YAAY;IAC3C,OAAO,CAAC,CAAC,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,EAAE,EAAE,OAAO,KAAK,CAAC,GAAG,GAAG,CAAC,EAAE,OAAO,KAAK,CAAC,IAAI;AAC3E;AAaO,SAAS,wBAAwB,KAAa;IACnD,IAAI,sBAAsB,QAAQ;QAChC,OAAO;IACT;IACA,OAAO;AACT"}},
    {"offset": {"line": 6089, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/user/schemas.ts"],"sourcesContent":["import { z } from 'zod';\nimport { normalizeUSPhoneNumber, validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\n// Base user schema\nexport const UserSchema = z.object({\n  id: z.string().uuid(),\n  name: z.string(),\n  email: z.string().email().nullable(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullable(),\n  gender: z.string().nullable(),\n  stripeCustomerId: z.string().nullable(),\n  preferredSendHour: z.number().int().min(0).max(23),\n  timezone: z.string(),\n  createdAt: z.date(),\n  updatedAt: z.date(),\n});\n\n// NEW - Simplified Availability Schema\nexport const AvailabilitySchema = z.object({\n  summary: z.string().nullish(), // Brief overview of schedule and availability\n  daysPerWeek: z.number().int().min(1).max(7),\n  minutesPerSession: z.number().int().min(15).max(240),\n  preferredTimes: z.array(z.enum(['morning', 'afternoon', 'evening'])).nullish(),\n  schedule: z.string().nullish(),\n});\n\n// NEW - Temporary Environment Change Schema\nexport const TemporaryEnvironmentChangeSchema = z.object({\n  id: z.string(),\n  description: z.string(),\n  startDate: z.string(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for indefinite\n  location: z.string().nullish(), // \"beach\", \"hotel\", \"home\", etc.\n  equipmentAvailable: z.array(z.string()).nullish(),\n  equipmentUnavailable: z.array(z.string()).nullish(),\n});\n\n// NEW - Equipment Access Schema\nexport const EquipmentAccessSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of equipment situation\n  gymAccess: z.boolean(),\n  gymType: z.enum(['commercial', 'home', 'community', 'none']).nullish(),\n  homeEquipment: z.array(z.string()).nullish(),\n  limitations: z.array(z.string()).nullish(),\n  temporaryChanges: z.array(TemporaryEnvironmentChangeSchema).nullish(),\n});\n\n// Weight schema for metrics (kept but simplified)\nexport const WeightSchema = z.object({\n  value: z.number().positive(),\n  unit: z.enum(['lbs', 'kg']),\n  date: z.string().nullish(),\n});\n\n// NEW - Simplified User Metrics Schema\nexport const UserMetricsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of physical stats and fitness level\n  height: z.number().positive().nullish(),\n  weight: WeightSchema.nullish(),\n  bodyComposition: z.number().min(1).max(50).nullish(),\n  fitnessLevel: z.enum(['sedentary', 'lightly_active', 'moderately_active', 'very_active']).nullish(),\n});\n\n// NEW - Simplified Constraint Schema\nexport const ConstraintSchema = z.object({\n  id: z.string(),\n  type: z.enum(['injury', 'mobility', 'medical', 'preference']),\n  description: z.string(),\n  severity: z.enum(['mild', 'moderate', 'severe']).nullish(),\n  affectedMovements: z.array(z.string()).nullish(),\n  status: z.enum(['active', 'resolved']),\n  startDate: z.string().nullish(), // ISO date string\n  endDate: z.string().nullish(), // ISO date string or null for chronic\n  isTemporary: z.boolean().default(false),\n});\n\n// NEW - Simplified Strength Data Schema\nexport const StrengthDataSchema = z.object({\n  type: z.literal('strength'),\n  summary: z.string().nullish(), // Brief overview of strength training background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  currentProgram: z.string().nullish(),\n  keyLifts: z.record(z.string(), z.number()).nullish(),\n  preferences: z.object({\n    workoutStyle: z.string().nullish(),\n    likedExercises: z.array(z.string()).nullish(),\n    dislikedExercises: z.array(z.string()).nullish(),\n  }).nullish(),\n  trainingFrequency: z.number().int().min(1).max(7),\n});\n\n// NEW - Simplified Cardio Data Schema (replaces running, cycling, general)\nexport const CardioDataSchema = z.object({\n  type: z.literal('cardio'),\n  summary: z.string().nullish(), // Brief overview of cardio activities and background\n  experience: z.enum(['beginner', 'intermediate', 'advanced']),\n  primaryActivities: z.array(z.string()),\n  keyMetrics: z.object({\n    weeklyDistance: z.number().positive().nullish(),\n    longestSession: z.number().positive().nullish(),\n    averagePace: z.string().nullish(),\n    preferredIntensity: z.enum(['low', 'moderate', 'high']).nullish(),\n  }).nullish(),\n  preferences: z.object({\n    indoor: z.boolean().nullish(),\n    outdoor: z.boolean().nullish(),\n    groupVsIndividual: z.enum(['group', 'individual', 'both']).nullish(),\n    timeOfDay: z.array(z.string()).nullish(),\n  }).nullish(),\n  frequency: z.number().int().min(1).max(7).nullish(),\n});\n\n// NEW - Simplified Activity Data Schema (only strength + cardio)\nexport const ActivityDataSchema = z.array(z.union([\n  StrengthDataSchema,\n  CardioDataSchema,\n]));\n\n// NEW - Simplified Goals Schema\nexport const GoalsSchema = z.object({\n  summary: z.string().nullish(), // Brief overview of fitness goals and motivation\n  primary: z.string(),\n  timeline: z.number().int().min(1).max(104).nullish(), // 1-104 weeks\n  specific: z.string().nullish(),\n  motivation: z.string().nullish(),\n});\n\n// THE ONLY FITNESS PROFILE SCHEMA - COMPLETE REPLACEMENT\nexport const FitnessProfileSchema = z.object({\n  goals: GoalsSchema,\n\n  // Overall experience level - single source of truth for fitness experience\n  // Can be derived from primary activity or set explicitly\n  experienceLevel: z.enum(['beginner', 'intermediate', 'advanced']).nullish(),\n\n  equipmentAccess: EquipmentAccessSchema.nullish(),\n  availability: AvailabilitySchema.nullish(),\n  constraints: z.array(ConstraintSchema).nullish(),\n  metrics: UserMetricsSchema.nullish(),\n\n  activities: ActivityDataSchema.nullish(),\n});\n\n// Schema for creating a new user\nexport const CreateUserSchema = z.object({\n  name: z.string().nullish(),\n  email: z.string().email().nullish(),\n  phoneNumber: z.string()\n    .transform(normalizeUSPhoneNumber)\n    .refine(validateUSPhoneNumber, { message: 'Must be a valid US phone number' }),\n  age: z.number().int().min(1).max(120).nullish(),\n  gender: z.string().nullish(),\n  isActive: z.boolean().nullish().default(true),\n  isAdmin: z.boolean().nullish().default(false),\n  stripeCustomerId: z.string().nullish(),\n  preferredSendHour: z.number().int().min(0).max(23).nullish(),\n  timezone: z.string().nullish(),\n});\n\n// Schema for updating a user\nexport const UpdateUserSchema = CreateUserSchema.partial();\n\n// Schema for creating/updating fitness profile\nexport const CreateFitnessProfileSchema = FitnessProfileSchema.partial();\n\n// Profile update patch schema (for tracking changes)\nexport const ProfileUpdatePatchSchema = z.object({\n  field: z.string(),\n  oldValue: z.unknown().nullable(),\n  newValue: z.unknown().nullable(),\n  timestamp: z.date(),\n});\n\n// Profile update request schema (for API endpoints)\nexport const ProfileUpdateRequestSchema = z.object({\n  updates: FitnessProfileSchema.partial(),\n  source: z.enum(['chat', 'form', 'admin', 'api', 'system']),\n  reason: z.string().optional().nullable(),\n});\n\n// Zod-inferred types (for validation)\nexport type FitnessProfile = z.infer<typeof FitnessProfileSchema>;\n\n// Activity-specific data types (only strength + cardio)\nexport type ActivityData = z.infer<typeof ActivityDataSchema>;\nexport type StrengthData = z.infer<typeof StrengthDataSchema>;\nexport type CardioData = z.infer<typeof CardioDataSchema>;\nexport type EquipmentAccess = z.infer<typeof EquipmentAccessSchema>;\nexport type Availability = z.infer<typeof AvailabilitySchema>;\nexport type Goals = z.infer<typeof GoalsSchema>;\nexport type UserMetrics = z.infer<typeof UserMetricsSchema>;\nexport type Constraint = z.infer<typeof ConstraintSchema>;\nexport type TemporaryEnvironmentChange = z.infer<typeof TemporaryEnvironmentChangeSchema>;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6332, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/user/index.ts"],"sourcesContent":["export * from './schemas';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 6339, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/user.ts"],"sourcesContent":["// Re-export types from shared (Zod schemas and inferred types)\nexport * from '@/shared/types/user';\n\n// Import Kysely DB types\nimport type { Users } from './_types';\nimport { Insertable, Selectable, Updateable } from 'kysely';\n\n// Kysely-based types (using database schema)\nexport type User = Selectable<Users>;\nexport type NewUser = Insertable<Users>;\nexport type UserUpdate = Updateable<Users>;\n\n// Import what we need for the UserModel class\nimport type { FitnessProfile } from '@/shared/types/user';\nimport { validateUSPhoneNumber } from '@/shared/utils/phoneUtils';\n\nexport type CreateUserData = Omit<NewUser, 'id' | 'createdAt' | 'updatedAt'>;\nexport type CreateFitnessProfileData = Partial<FitnessProfile>;\n\nexport type UserWithProfile = User & {\n  profile?: string | null; // Joined from profiles table\n}\n\n/**\n * UserModel - Domain logic and validation only\n * No direct repository access - Services orchestrate repository calls\n */\nexport class UserModel {\n  static fromDb(user?: User): UserWithProfile | undefined {\n    return user ? { ...user } : undefined;\n  }\n\n  /**\n   * Convert DB result with joined profile to UserWithProfile\n   * Used when fetching user with profiles table joined\n   */\n  static fromDbWithProfile(dbResult: any): UserWithProfile { // eslint-disable-line @typescript-eslint/no-explicit-any\n    const { profile, ...userData } = dbResult;\n    return {\n      ...userData,\n      profile: profile || null,\n    };\n  }\n\n  /**\n   * Validates user data for creation\n   * @param userData - User data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserData(userData: CreateUserData): void {\n    if (!userData.name || userData.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (!userData.phoneNumber || !validateUSPhoneNumber(userData.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (userData.email && !this.isValidEmail(userData.email)) {\n      throw new Error('Invalid email format');\n    }\n  }\n\n  /**\n   * Validates user update data\n   * @param updates - Update data to validate\n   * @throws Error if validation fails\n   */\n  static validateUserUpdates(updates: Partial<User>): void {\n    if (updates.name && updates.name.trim().length < 2) {\n      throw new Error('User name must be at least 2 characters long');\n    }\n\n    if (updates.phoneNumber && !validateUSPhoneNumber(updates.phoneNumber)) {\n      throw new Error('Valid US phone number is required');\n    }\n\n    if (updates.email && !this.isValidEmail(updates.email)) {\n      throw new Error('Invalid email format');\n    }\n\n    if (updates.preferredSendHour !== undefined && (updates.preferredSendHour < 0 || updates.preferredSendHour > 23)) {\n      throw new Error('Preferred send hour must be between 0 and 23');\n    }\n\n    if (updates.age !== undefined && updates.age !== null && (updates.age < 1 || updates.age > 120)) {\n      throw new Error('Age must be between 1 and 120');\n    }\n  }\n\n  private static isValidEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n}\n"],"names":[],"mappings":"AAAA,+DAA+D;;;;;AAC/D;AAaA;;;AAaO,MAAM;IACX,OAAO,OAAO,IAAW,EAA+B;QACtD,OAAO,OAAO;YAAE,GAAG,IAAI;QAAC,IAAI;IAC9B;IAEA;;;GAGC,GACD,OAAO,kBAAkB,QAAa,EAAmB;QACvD,MAAM,EAAE,OAAO,EAAE,GAAG,UAAU,GAAG;QACjC,OAAO;YACL,GAAG,QAAQ;YACX,SAAS,WAAW;QACtB;IACF;IAEA;;;;GAIC,GACD,OAAO,iBAAiB,QAAwB,EAAQ;QACtD,IAAI,CAAC,SAAS,IAAI,IAAI,SAAS,IAAI,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;YACrD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,CAAC,SAAS,WAAW,IAAI,CAAC,IAAA,qLAAqB,EAAC,SAAS,WAAW,GAAG;YACzE,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,SAAS,KAAK,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,SAAS,KAAK,GAAG;YACxD,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;;;GAIC,GACD,OAAO,oBAAoB,OAAsB,EAAQ;QACvD,IAAI,QAAQ,IAAI,IAAI,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;YAClD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,WAAW,IAAI,CAAC,IAAA,qLAAqB,EAAC,QAAQ,WAAW,GAAG;YACtE,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,KAAK,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,QAAQ,KAAK,GAAG;YACtD,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,iBAAiB,KAAK,aAAa,CAAC,QAAQ,iBAAiB,GAAG,KAAK,QAAQ,iBAAiB,GAAG,EAAE,GAAG;YAChH,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,QAAQ,GAAG,KAAK,aAAa,QAAQ,GAAG,KAAK,QAAQ,CAAC,QAAQ,GAAG,GAAG,KAAK,QAAQ,GAAG,GAAG,GAAG,GAAG;YAC/F,MAAM,IAAI,MAAM;QAClB;IACF;IAEA,OAAe,aAAa,KAAa,EAAW;QAClD,MAAM,aAAa;QACnB,OAAO,WAAW,IAAI,CAAC;IACzB;AACF"}},
    {"offset": {"line": 6409, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/timezone.ts"],"sourcesContent":["/**\n * Timezone utilities for handling IANA timezone validation and conversions\n */\nimport { DateTime, IANAZone } from 'luxon';\nimport { now } from '@/shared/utils/date';\n\n// Common IANA timezones for UI selection\nexport const COMMON_TIMEZONES = [\n  // Americas\n  'America/New_York',\n  'America/Chicago',\n  'America/Denver',\n  'America/Los_Angeles',\n  'America/Toronto',\n  'America/Vancouver',\n  'America/Mexico_City',\n  'America/Sao_Paulo',\n  \n  // Europe\n  'Europe/London',\n  'Europe/Paris',\n  'Europe/Berlin',\n  'Europe/Madrid',\n  'Europe/Rome',\n  'Europe/Amsterdam',\n  'Europe/Stockholm',\n  'Europe/Moscow',\n  \n  // Asia Pacific\n  'Asia/Tokyo',\n  'Asia/Shanghai',\n  'Asia/Hong_Kong',\n  'Asia/Singapore',\n  'Asia/Seoul',\n  'Asia/Mumbai',\n  'Asia/Dubai',\n  'Australia/Sydney',\n  'Australia/Melbourne',\n  'Pacific/Auckland',\n] as const;\n\nexport type CommonTimezone = typeof COMMON_TIMEZONES[number];\n\n/**\n * Validates if a string is a valid IANA timezone identifier\n */\nexport function isValidIANATimezone(timezone: string): boolean {\n  return IANAZone.isValidZone(timezone);\n}\n\n/**\n * Gets the local hour for a given UTC date in a specific timezone\n */\nexport function getLocalHourForTimezone(utcDate: Date, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const dt = DateTime.fromJSDate(utcDate, { zone: 'utc' }).setZone(timezone);\n  return dt.hour;\n}\n\n/**\n * Converts a preferred local hour to UTC hour for a given timezone\n * Returns the UTC hour when it's the specified local hour in the given timezone\n */\nexport function convertPreferredHourToUTC(localHour: number, timezone: string): number {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  if (localHour < 0 || localHour > 23) {\n    throw new Error(`Invalid hour: ${localHour}. Must be between 0 and 23`);\n  }\n  \n  // Get current date in the target timezone\n  const nowDt = now(timezone);\n  // Set to the desired local hour\n  const targetTime = nowDt.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n  // Convert to UTC and get the hour\n  const utcTime = targetTime.setZone('utc');\n  return utcTime.hour;\n}\n\n/**\n * Gets all UTC hours when it's the specified local hour in the given timezone\n * This accounts for DST transitions where a local hour might occur at different UTC hours\n */\nexport function getAllUTCHoursForLocalHour(localHour: number, timezone: string): number[] {\n  if (!isValidIANATimezone(timezone)) {\n    throw new Error(`Invalid IANA timezone: ${timezone}`);\n  }\n  \n  const hours = new Set<number>();\n  const nowDt = now();\n\n  // Check for the next 365 days to cover all DST transitions\n  for (let i = 0; i < 365; i++) {\n    const date = nowDt.plus({ days: i }).setZone(timezone);\n    const targetTime = date.set({ hour: localHour, minute: 0, second: 0, millisecond: 0 });\n    const utcTime = targetTime.setZone('utc');\n    hours.add(utcTime.hour);\n  }\n  \n  return Array.from(hours).sort((a, b) => a - b);\n}\n\n/**\n * Formats a timezone identifier for display in UI\n * Example: \"America/New_York\" -> \"New York (EST/EDT)\"\n */\nexport function formatTimezoneForDisplay(timezone: string): string {\n  if (!isValidIANATimezone(timezone)) {\n    return timezone;\n  }\n  \n  try {\n    const nowDt = now(timezone);\n    const offset = nowDt.toFormat('ZZZ'); // e.g., \"EST\" or \"-05:00\"\n    \n    // Extract city name from timezone\n    const parts = timezone.split('/');\n    const city = parts[parts.length - 1].replace(/_/g, ' ');\n    \n    return `${city} (${offset})`;\n  } catch {\n    return timezone;\n  }\n}\n\nexport function getCommonTimezones(): readonly string[] {\n  return COMMON_TIMEZONES;\n}"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;;;AACD;AAAA;AAAA;AACA;;;AAGO,MAAM,mBAAmB;IAC9B,WAAW;IACX;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,SAAS;IACT;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,eAAe;IACf;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAOM,SAAS,oBAAoB,QAAgB;IAClD,OAAO,wPAAQ,CAAC,WAAW,CAAC;AAC9B;AAKO,SAAS,wBAAwB,OAAa,EAAE,QAAgB;IACrE,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IAEA,MAAM,KAAK,+OAAQ,CAAC,UAAU,CAAC,SAAS;QAAE,MAAM;IAAM,GAAG,OAAO,CAAC;IACjE,OAAO,GAAG,IAAI;AAChB;AAMO,SAAS,0BAA0B,SAAiB,EAAE,QAAgB;IAC3E,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IACA,IAAI,YAAY,KAAK,YAAY,IAAI;QACnC,MAAM,IAAI,MAAM,CAAC,cAAc,EAAE,UAAU,0BAA0B,CAAC;IACxE;IAEA,0CAA0C;IAC1C,MAAM,QAAQ,IAAA,6JAAG,EAAC;IAClB,gCAAgC;IAChC,MAAM,aAAa,MAAM,GAAG,CAAC;QAAE,MAAM;QAAW,QAAQ;QAAG,QAAQ;QAAG,aAAa;IAAE;IACrF,kCAAkC;IAClC,MAAM,UAAU,WAAW,OAAO,CAAC;IACnC,OAAO,QAAQ,IAAI;AACrB;AAMO,SAAS,2BAA2B,SAAiB,EAAE,QAAgB;IAC5E,IAAI,CAAC,oBAAoB,WAAW;QAClC,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,UAAU;IACtD;IAEA,MAAM,QAAQ,IAAI;IAClB,MAAM,QAAQ,IAAA,6JAAG;IAEjB,2DAA2D;IAC3D,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,IAAK;QAC5B,MAAM,OAAO,MAAM,IAAI,CAAC;YAAE,MAAM;QAAE,GAAG,OAAO,CAAC;QAC7C,MAAM,aAAa,KAAK,GAAG,CAAC;YAAE,MAAM;YAAW,QAAQ;YAAG,QAAQ;YAAG,aAAa;QAAE;QACpF,MAAM,UAAU,WAAW,OAAO,CAAC;QACnC,MAAM,GAAG,CAAC,QAAQ,IAAI;IACxB;IAEA,OAAO,MAAM,IAAI,CAAC,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI;AAC9C;AAMO,SAAS,yBAAyB,QAAgB;IACvD,IAAI,CAAC,oBAAoB,WAAW;QAClC,OAAO;IACT;IAEA,IAAI;QACF,MAAM,QAAQ,IAAA,6JAAG,EAAC;QAClB,MAAM,SAAS,MAAM,QAAQ,CAAC,QAAQ,0BAA0B;QAEhE,kCAAkC;QAClC,MAAM,QAAQ,SAAS,KAAK,CAAC;QAC7B,MAAM,OAAO,KAAK,CAAC,MAAM,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC,MAAM;QAEnD,OAAO,GAAG,KAAK,EAAE,EAAE,OAAO,CAAC,CAAC;IAC9B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 6540, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/userRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport {\n  type User,\n  type UserWithProfile,\n  type CreateUserData,\n  UserModel\n} from '@/server/models/user';\nimport { getLocalHourForTimezone } from '@/server/utils/timezone';\n\nexport class UserRepository extends BaseRepository {\n  async list(params: {\n    q?: string;\n    status?: string;\n    hasProfile?: boolean;\n    hasPlan?: boolean;\n    createdFrom?: string;\n    createdTo?: string;\n    page?: number;\n    pageSize?: number;\n    sort?: string;\n  }): Promise<{ users: UserWithProfile[]; total: number; }> {\n    const {\n      q,\n      createdFrom,\n      createdTo,\n      page = 1,\n      pageSize = 20,\n      sort = 'createdAt:desc',\n    } = params;\n\n    const [sortField, sortDir] = sort.split(':');\n\n    let query = this.db\n      .selectFrom('users')\n      .selectAll('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      query = query.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n\n    if (createdFrom) {\n      query = query.where('users.createdAt', '>=', new Date(createdFrom));\n    }\n    if (createdTo) {\n      query = query.where('users.createdAt', '<=', new Date(createdTo));\n    }\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      query = query.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      query = query.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    let countBuilder = this.db\n      .selectFrom('users');\n\n    if (q) {\n      const like = `%${q}%`;\n      countBuilder = countBuilder.where((eb) => eb.or([\n        eb('users.name', 'ilike', like),\n        eb('users.email', 'ilike', like),\n        eb('users.phoneNumber', 'ilike', like),\n      ]));\n    }\n    if (createdFrom) countBuilder = countBuilder.where('users.createdAt', '>=', new Date(createdFrom));\n    if (createdTo) countBuilder = countBuilder.where('users.createdAt', '<=', new Date(createdTo));\n\n    // hasProfile filter checks for existence in profiles table\n    if (params.hasProfile === true) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.exists(\n          eb.selectFrom('profiles')\n            .whereRef('profiles.clientId', '=', 'users.id')\n            .select('profiles.id')\n        )\n      );\n    } else if (params.hasProfile === false) {\n      countBuilder = countBuilder.where((eb) =>\n        eb.not(\n          eb.exists(\n            eb.selectFrom('profiles')\n              .whereRef('profiles.clientId', '=', 'users.id')\n              .select('profiles.id')\n          )\n        )\n      );\n    }\n\n    const totalResult = await countBuilder\n      .select((eb) => eb.fn.countAll<number>().as('count'))\n      .executeTakeFirst();\n    const total = Number(totalResult?.count || 0);\n\n    const usersRows = await query\n      // @ts-expect-error dynamic orderBy\n      .orderBy(`users.${sortField}`, sortDir === 'asc' ? 'asc' : 'desc')\n      .offset((page - 1) * pageSize)\n      .limit(pageSize)\n      .execute();\n\n    const users: UserWithProfile[] = usersRows.map((u) => (UserModel.fromDb(u))).filter((u) => u !== undefined);\n\n    return { users, total };\n  }\n\n  async create(userData: CreateUserData): Promise<UserWithProfile | undefined> {\n    const user = await this.db\n    .insertInto('users')\n    .values({\n      name: userData.name,\n      phoneNumber: userData.phoneNumber,\n      age: userData.age || null,\n      gender: userData.gender || null,\n      email: userData.email || null,\n      stripeCustomerId: userData.stripeCustomerId || null,\n      timezone: userData.timezone,\n      preferredSendHour: userData.preferredSendHour,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    })\n    .returningAll()\n    .executeTakeFirstOrThrow()\n    return UserModel.fromDb(user);\n  }\n\n  async findById(id: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('id', '=', id)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByPhoneNumber(phoneNumber: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('phoneNumber', '=', phoneNumber)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByEmail(email: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('email', '=', email)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async findByStripeCustomerId(stripeCustomerId: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('stripeCustomerId', '=', stripeCustomerId)\n      .selectAll()\n      .executeTakeFirst());\n  }\n\n  async update(id: string, userData: Partial<CreateUserData>): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...userData,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirst());\n  }\n\n  /**\n   * Find user with latest profile\n   * Performs LEFT JOIN with profiles table to get most recent profile\n   */\n  async findWithProfile(userId: string): Promise<UserWithProfile | undefined> {\n    const result = await this.db\n      .selectFrom('users')\n      .leftJoin('profiles', (join) =>\n        join\n          .onRef('profiles.clientId', '=', 'users.id')\n          .on((eb) => {\n            // Only join the most recent profile for this user\n            const subquery = eb\n              .selectFrom('profiles as p2')\n              .select((eb) => eb.fn.max('p2.createdAt').as('maxCreated'))\n              .whereRef('p2.clientId', '=', 'users.id');\n\n            return eb('profiles.createdAt', '=', subquery);\n          })\n      )\n      .selectAll('users')\n      .select('profiles.profile')\n      .where('users.id', '=', userId)\n      .executeTakeFirst();\n\n    if (!result) {\n      return undefined;\n    }\n\n    return UserModel.fromDbWithProfile(result);\n  }\n\n  async updatePreferences(userId: string, preferences: {\n    preferredSendHour?: number;\n    timezone?: string;\n    name?: string;\n  }): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .updateTable('users')\n      .set({\n        ...preferences,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', userId)\n      .returningAll()\n      .executeTakeFirstOrThrow());\n  }\n\n  async findUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    // This query finds all users with active subscriptions whose local hour is at or past their preferred send hour\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    // Note: This returns candidates - the caller should also filter by workout existence to avoid duplicates\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n\n    // Filter users whose local hour is at or past their preferred send hour\n    const matchingUsers: UserWithProfile[] = [];\n    const currentUtcDate = new Date();\n    currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n    for (const user of users) {\n      try {\n        const localHour = getLocalHourForTimezone(currentUtcDate, user.timezone);\n        if (localHour >= user.preferredSendHour) {\n          matchingUsers.push(UserModel.fromDb(user)!);\n        }\n      } catch (error) {\n        console.error(`Error processing user ${user.id} timezone:`, error);\n        // Skip users with invalid timezone data\n      }\n    }\n\n    return matchingUsers;\n  }\n\n  async findUsersByTimezones(timezones: string[]): Promise<UserWithProfile[]> {\n    // Return empty array if no timezones provided\n    if (timezones.length === 0) {\n      return [];\n    }\n\n    // Query users with active subscriptions in the specified timezones\n    // Only users with status='active' receive messages (excludes 'cancel_pending' and 'canceled')\n    const users = await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .where('timezone', 'in', timezones)\n      .selectAll('users')\n      .execute();\n\n    return users.map(u => UserModel.fromDb(u)).filter(u => u !== undefined) as UserWithProfile[];\n  }\n\n  async findActiveUsersWithPreferences(): Promise<User[]> {\n    return await this.db\n      .selectFrom('users')\n      .innerJoin('subscriptions', 'users.id', 'subscriptions.clientId')\n      .where('subscriptions.status', '=', 'active')\n      .selectAll('users')\n      .execute();\n  }\n\n  async delete(id: string): Promise<boolean> {\n    // First, clean up admin_activity_logs which has no FK constraint\n    // Delete where user is the target or the actor\n    await this.db\n      .deleteFrom('adminActivityLogs')\n      .where((eb) => eb.or([\n        eb('targetClientId', '=', id),\n        eb('actorClientId', '=', id)\n      ]))\n      .execute();\n\n    // Now delete the user - CASCADE will handle all other related tables:\n    // profile_updates, subscriptions, conversations, messages, fitness_plans,\n    // microcycles, workout_instances, user_onboarding, profiles, short_links, message_queues\n    const result = await this.db\n      .deleteFrom('users')\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows) > 0;\n  }\n\n  // ============================================\n  // Referral Code Methods\n  // ============================================\n\n  /**\n   * Generate a random 6-character referral code\n   * Uses uppercase letters and numbers, excluding confusing characters (O/0, I/1, L)\n   */\n  generateReferralCode(): string {\n    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';\n    let code = '';\n    for (let i = 0; i < 6; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  /**\n   * Get or create a referral code for a user\n   * If the user already has a code, returns it; otherwise generates and saves a new one\n   */\n  async getOrCreateReferralCode(userId: string): Promise<string | null> {\n    // First check if user already has a code\n    const user = await this.db\n      .selectFrom('users')\n      .select(['id', 'referralCode'])\n      .where('id', '=', userId)\n      .executeTakeFirst();\n\n    if (!user) {\n      return null;\n    }\n\n    if (user.referralCode) {\n      return user.referralCode;\n    }\n\n    // Generate a new code with retry logic for uniqueness\n    let attempts = 0;\n    const maxAttempts = 10;\n\n    while (attempts < maxAttempts) {\n      const newCode = this.generateReferralCode();\n\n      try {\n        const updated = await this.db\n          .updateTable('users')\n          .set({ referralCode: newCode, updatedAt: new Date() })\n          .where('id', '=', userId)\n          .where('referralCode', 'is', null) // Only update if still null (race condition protection)\n          .returningAll()\n          .executeTakeFirst();\n\n        if (updated) {\n          return newCode;\n        }\n\n        // If no rows updated, the user might have gotten a code from another request\n        const refreshedUser = await this.db\n          .selectFrom('users')\n          .select('referralCode')\n          .where('id', '=', userId)\n          .executeTakeFirst();\n\n        if (refreshedUser?.referralCode) {\n          return refreshedUser.referralCode;\n        }\n      } catch (error) {\n        // Unique constraint violation - try again with a new code\n        attempts++;\n        if (attempts >= maxAttempts) {\n          console.error(`Failed to generate unique referral code after ${maxAttempts} attempts`);\n          throw error;\n        }\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Find a user by their referral code\n   * Used to validate referral codes during signup\n   */\n  async findByReferralCode(code: string): Promise<UserWithProfile | undefined> {\n    return UserModel.fromDb(await this.db\n      .selectFrom('users')\n      .where('referralCode', '=', code.toUpperCase())\n      .selectAll()\n      .executeTakeFirst());\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6773, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/onboardingRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { sql } from 'kysely';\nimport type { UserOnboarding } from '../models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type OnboardingRecord = Selectable<UserOnboarding>;\nexport type NewOnboardingRecord = Insertable<UserOnboarding>;\nexport type OnboardingUpdate = Updateable<UserOnboarding>;\n\nexport interface SignupData {\n  // Formatted text for LLM (backward compatible)\n  fitnessGoals?: string;\n  currentExercise?: string;\n  injuries?: string;\n  environment?: string;\n\n  // Structured data from MultiStepSignupForm (for analytics/reporting)\n  primaryGoals?: ('strength' | 'endurance' | 'weight_loss' | 'general_fitness')[];\n  goalsElaboration?: string;\n  experienceLevel?: 'beginner' | 'intermediate' | 'advanced';\n  desiredDaysPerWeek?: '3_per_week' | '4_per_week' | '5_per_week' | '6_per_week';\n  availabilityElaboration?: string;\n  trainingLocation?: 'home' | 'commercial_gym' | 'bodyweight';\n  equipment?: string[];\n  acceptedRisks?: boolean;\n}\n\nexport type OnboardingStatus = 'pending' | 'in_progress' | 'completed' | 'failed';\n\n/**\n * OnboardingRepository\n *\n * Manages user onboarding state and signup data\n */\nexport class OnboardingRepository extends BaseRepository {\n  /**\n   * Create an onboarding record for a client\n   */\n  async create(clientId: string, signupData?: SignupData): Promise<OnboardingRecord> {\n    const record: NewOnboardingRecord = {\n      clientId,\n      signupData: signupData ? JSON.parse(JSON.stringify(signupData)) : null,\n      status: 'pending',\n      programMessagesSent: false,\n    };\n\n    return await this.db\n      .insertInto('userOnboarding')\n      .values(record)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find onboarding record by client ID\n   */\n  async findByClientId(clientId: string): Promise<OnboardingRecord | null> {\n    return await this.db\n      .selectFrom('userOnboarding')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Update onboarding status\n   */\n  async updateStatus(\n    clientId: string,\n    status: OnboardingStatus,\n    errorMessage?: string\n  ): Promise<OnboardingRecord> {\n    const update: OnboardingUpdate = {\n      status,\n      errorMessage: errorMessage ?? null,\n    };\n\n    return await this.db\n      .updateTable('userOnboarding')\n      .set(update)\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as started\n   */\n  async markStarted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'in_progress',\n        startedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Update current step (for progress tracking)\n   */\n  async updateCurrentStep(clientId: string, stepNumber: number): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ currentStep: stepNumber })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as completed\n   */\n  async markCompleted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'completed',\n        completedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark final program messages as sent\n   */\n  async markMessagesSent(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ programMessagesSent: true })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Check if messages have been sent\n   */\n  async hasMessagesSent(clientId: string): Promise<boolean> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('programMessagesSent')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.programMessagesSent ?? false;\n  }\n\n  /**\n   * Get signup data\n   */\n  async getSignupData(clientId: string): Promise<SignupData | null> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('signupData')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.signupData as SignupData ?? null;\n  }\n\n  /**\n   * Clear signup data (cleanup after profile creation)\n   */\n  async clearSignupData(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ signupData: null })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Delete onboarding record (full cleanup)\n   */\n  async delete(clientId: string): Promise<void> {\n    await this.db\n      .deleteFrom('userOnboarding')\n      .where('clientId', '=', clientId)\n      .execute();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6866, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/circuitBreaker.ts"],"sourcesContent":["export enum CircuitState {\n  CLOSED = 'CLOSED',\n  OPEN = 'OPEN',\n  HALF_OPEN = 'HALF_OPEN'\n}\n\ninterface CircuitBreakerOptions {\n  failureThreshold: number;\n  resetTimeout: number;\n  monitoringPeriod: number;\n}\n\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failureCount: number = 0;\n  private successCount: number = 0;\n  private lastFailureTime: number | null = null;\n  private readonly options: CircuitBreakerOptions;\n\n  constructor(options: Partial<CircuitBreakerOptions> = {}) {\n    this.options = {\n      failureThreshold: options.failureThreshold || 5,\n      resetTimeout: options.resetTimeout || 60000, // 60 seconds\n      monitoringPeriod: options.monitoringPeriod || 60000 // 60 seconds\n    };\n  }\n\n  async execute<T>(fn: () => Promise<T>): Promise<T | null> {\n    if (this.state === CircuitState.OPEN) {\n      if (this.shouldAttemptReset()) {\n        this.state = CircuitState.HALF_OPEN;\n      } else {\n        console.warn('Circuit breaker is OPEN, skipping execution');\n        return null;\n      }\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.failureCount = 0;\n    if (this.state === CircuitState.HALF_OPEN) {\n      this.successCount++;\n      if (this.successCount >= 3) {\n        this.state = CircuitState.CLOSED;\n        this.successCount = 0;\n        console.info('Circuit breaker is now CLOSED');\n      }\n    }\n  }\n\n  private onFailure(): void {\n    this.failureCount++;\n    this.lastFailureTime = Date.now();\n    \n    if (this.state === CircuitState.HALF_OPEN) {\n      this.state = CircuitState.OPEN;\n      console.warn('Circuit breaker is now OPEN due to failure in HALF_OPEN state');\n    } else if (this.failureCount >= this.options.failureThreshold) {\n      this.state = CircuitState.OPEN;\n      console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`);\n    }\n  }\n\n  private shouldAttemptReset(): boolean {\n    return (\n      this.lastFailureTime !== null &&\n      Date.now() - this.lastFailureTime >= this.options.resetTimeout\n    );\n  }\n\n  getState(): CircuitState {\n    return this.state;\n  }\n\n  getStats() {\n    return {\n      state: this.state,\n      failureCount: this.failureCount,\n      successCount: this.successCount,\n      lastFailureTime: this.lastFailureTime\n    };\n  }\n}"],"names":[],"mappings":";;;;;;AAAO,IAAA,AAAK,sCAAA;;;;WAAA;;AAYL,MAAM;IACH,iBAA0C;IAC1C,eAAuB,EAAE;IACzB,eAAuB,EAAE;IACzB,kBAAiC,KAAK;IAC7B,QAA+B;IAEhD,YAAY,UAA0C,CAAC,CAAC,CAAE;QACxD,IAAI,CAAC,OAAO,GAAG;YACb,kBAAkB,QAAQ,gBAAgB,IAAI;YAC9C,cAAc,QAAQ,YAAY,IAAI;YACtC,kBAAkB,QAAQ,gBAAgB,IAAI,MAAM,aAAa;QACnE;IACF;IAEA,MAAM,QAAW,EAAoB,EAAqB;QACxD,IAAI,IAAI,CAAC,KAAK,aAAwB;YACpC,IAAI,IAAI,CAAC,kBAAkB,IAAI;gBAC7B,IAAI,CAAC,KAAK;YACZ,OAAO;gBACL,QAAQ,IAAI,CAAC;gBACb,OAAO;YACT;QACF;QAEA,IAAI;YACF,MAAM,SAAS,MAAM;YACrB,IAAI,CAAC,SAAS;YACd,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,CAAC,SAAS;YACd,MAAM;QACR;IACF;IAEQ,YAAkB;QACxB,IAAI,CAAC,YAAY,GAAG;QACpB,IAAI,IAAI,CAAC,KAAK,kBAA6B;YACzC,IAAI,CAAC,YAAY;YACjB,IAAI,IAAI,CAAC,YAAY,IAAI,GAAG;gBAC1B,IAAI,CAAC,KAAK;gBACV,IAAI,CAAC,YAAY,GAAG;gBACpB,QAAQ,IAAI,CAAC;YACf;QACF;IACF;IAEQ,YAAkB;QACxB,IAAI,CAAC,YAAY;QACjB,IAAI,CAAC,eAAe,GAAG,KAAK,GAAG;QAE/B,IAAI,IAAI,CAAC,KAAK,kBAA6B;YACzC,IAAI,CAAC,KAAK;YACV,QAAQ,IAAI,CAAC;QACf,OAAO,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,OAAO,CAAC,gBAAgB,EAAE;YAC7D,IAAI,CAAC,KAAK;YACV,QAAQ,IAAI,CAAC,CAAC,kCAAkC,EAAE,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC;QAChF;IACF;IAEQ,qBAA8B;QACpC,OACE,IAAI,CAAC,eAAe,KAAK,QACzB,KAAK,GAAG,KAAK,IAAI,CAAC,eAAe,IAAI,IAAI,CAAC,OAAO,CAAC,YAAY;IAElE;IAEA,WAAyB;QACvB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA,WAAW;QACT,OAAO;YACL,OAAO,IAAI,CAAC,KAAK;YACjB,cAAc,IAAI,CAAC,YAAY;YAC/B,cAAc,IAAI,CAAC,YAAY;YAC/B,iBAAiB,IAAI,CAAC,eAAe;QACvC;IACF;AACF"}},
    {"offset": {"line": 6950, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/user/userService.ts"],"sourcesContent":["import { UserModel, CreateUserData, UserWithProfile, User } from '@/server/models/user';\nimport { UserRepository } from '@/server/repositories/userRepository';\nimport { OnboardingRepository } from '@/server/repositories/onboardingRepository';\nimport { CircuitBreaker } from '@/server/utils/circuitBreaker';\nimport type { AdminUser, AdminUsersResponse, AdminUserDetailResponse, UserFilters, UserSort, Pagination } from '@/shared/types/admin';\nimport { getTimezonesAtLocalTime } from '@/shared/utils/date';\n\nexport interface CreateUserRequest {\n  name: string;\n  phoneNumber: string;\n  age?: number;\n  gender?: string;\n  timezone: string;\n  preferredSendHour: number;\n  email?: string;\n  stripeCustomerId?: string;\n}\n\nexport class UserService {\n  private static instance: UserService;\n  private userRepository: UserRepository;\n  private onboardingRepository: OnboardingRepository;\n  private circuitBreaker: CircuitBreaker;\n\n  private constructor() {\n    this.userRepository = new UserRepository();\n    this.onboardingRepository = new OnboardingRepository();\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeout: 60000, // 1 minute\n      monitoringPeriod: 60000 // 1 minute\n    });\n  }\n\n  public static getInstance(): UserService {\n    if (!UserService.instance) {\n      UserService.instance = new UserService();\n    }\n    return UserService.instance;\n  }\n\n  async createUser(request: CreateUserRequest): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute<UserWithProfile>(async (): Promise<UserWithProfile> => {\n      // Check if user already exists using repository\n      const existingUser = await this.userRepository.findByPhoneNumber(request.phoneNumber);\n      if (existingUser) {\n        throw new Error('User already exists with this phone number');\n      }\n\n      // Prepare user data\n      const userData: CreateUserData = {\n        name: request.name,\n        phoneNumber: request.phoneNumber,\n        age: request.age || null,\n        gender: request.gender || null,\n        timezone: request.timezone,\n        preferredSendHour: request.preferredSendHour,\n        email: request.email || null,\n        stripeCustomerId: request.stripeCustomerId || null,\n      };\n\n      // Validate user data using domain model\n      UserModel.validateUserData(userData);\n\n      // Create the user using repository\n      const user = await this.userRepository.create(userData);\n      if (!user) {\n        throw new Error('Failed to create user');\n      }\n\n      return user;\n    });\n    \n    if (!result) {\n      throw new Error('Failed to create user');\n    }\n    \n    return result;\n  }\n\n  async getUserById(id: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findById(id);\n    });\n    return result || undefined;\n  }\n\n  async getUserByPhone(phoneNumber: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findByPhoneNumber(phoneNumber);\n    });\n    return result || undefined;\n  }\n\n  async getUser(userId: string): Promise<UserWithProfile | undefined | null> {\n    return await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findWithProfile(userId);\n    });\n  }\n\n  async getUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findUsersForHour(currentUtcHour);\n    });\n    return result || [];\n  }\n\n  async getUsersForWeeklyMessage(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Business logic: Weekly messages are sent at 5pm on Sundays\n      const targetLocalHour = 17; // 5pm\n      const sunday = 7; // Luxon weekday (7 = Sunday)\n\n      // Calculate current UTC date\n      const currentUtcDate = new Date();\n      currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n      // Get all timezones that are currently at 5pm on Sunday\n      const matchingTimezones = getTimezonesAtLocalTime(\n        currentUtcDate,\n        targetLocalHour,\n        sunday\n      );\n\n      // Query users in those timezones\n      return await this.userRepository.findUsersByTimezones(matchingTimezones);\n    });\n    return result || [];\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Validate updates using domain model\n      UserModel.validateUserUpdates(updates);\n      \n      // Update using repository\n      return await this.userRepository.update(id, updates);\n    });\n    \n    if (!result) {\n      throw new Error('Failed to update user');\n    }\n    \n    return result;\n  }\n\n  async updatePreferences(userId: string, preferences: { preferredSendHour?: number; timezone?: string; name?: string }): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.updatePreferences(userId, preferences);\n    });\n\n    if (!result) {\n      throw new Error('Failed to update preferences');\n    }\n\n    return result;\n  }\n\n  // Admin-specific methods\n  async listUsersForAdmin(filters: UserFilters & { page?: number; pageSize?: number; sort?: UserSort }): Promise<AdminUsersResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const { page = 1, pageSize = 20, sort = { field: 'createdAt', direction: 'desc' }, ...restFilters } = filters;\n      \n      // Convert admin filters to repository filters\n      const repoParams = {\n        q: restFilters.search,\n        hasProfile: restFilters.hasProfile,\n        createdFrom: restFilters.createdAfter,\n        createdTo: restFilters.createdBefore,\n        page,\n        pageSize,\n        sort: `${sort.field}:${sort.direction}`\n      };\n\n      const { users, total } = await this.userRepository.list(repoParams);\n      \n      // Transform users to AdminUser format\n      const adminUsers: AdminUser[] = users.map(user => this.transformToAdminUser(user));\n      \n      // Calculate stats\n      const stats = await this.calculateUserStats();\n\n      const pagination: Pagination = {\n        page,\n        limit: pageSize,\n        total,\n        totalPages: Math.ceil(total / pageSize)\n      };\n\n      return {\n        users: adminUsers,\n        pagination,\n        stats\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch users');\n    }\n\n    return result;\n  }\n\n  async getUserForAdmin(id: string): Promise<AdminUserDetailResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const user = await this.userRepository.findWithProfile(id);\n      if (!user) {\n        throw new Error('User not found');\n      }\n\n      const adminUser = this.transformToAdminUser(user);\n\n      // Fetch signup data from onboarding\n      const signupData = await this.onboardingRepository.getSignupData(id);\n\n      return {\n        user: adminUser,\n        profile: user.profile || null,\n        signupData,\n        recentActivity: {\n          totalMessages: 0,\n          totalWorkouts: 0\n        }\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch user');\n    }\n\n    return result;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Verify user exists first\n      const user = await this.userRepository.findById(id);\n      if (!user) {\n        return false;\n      }\n\n      // Delete user and all cascaded data\n      return await this.userRepository.delete(id);\n    });\n\n    return result || false;\n  }\n\n  private transformToAdminUser(user: UserWithProfile): AdminUser {\n    const hasProfile = Boolean(user.profile);\n\n    return {\n      ...user,\n      hasProfile,\n      profileSummary: undefined, // Profile summary now comes from markdown profile parsing if needed\n      stats: {\n        totalWorkouts: 0,\n        isActiveToday: false\n      }\n    };\n  }\n\n  private async calculateUserStats() {\n    // Get basic counts from repository\n    const allUsersResult = await this.userRepository.list({ pageSize: 1000 });\n    const users = allUsersResult.users;\n\n    const totalUsers = users.length;\n    const withEmail = users.filter(u => u.email).length;\n    // Count users with profiles by checking profile\n    const withProfile = users.filter(u => u.profile).length;\n    const activeToday = 0; // TODO: Implement active user tracking\n\n    return {\n      totalUsers,\n      withEmail,\n      withProfile,\n      activeToday\n    };\n  }\n}\n\n// Export singleton instance\nexport const userService = UserService.getInstance();"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7188, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/training/microcycleService.ts"],"sourcesContent":["import { MicrocycleRepository } from '@/server/repositories/microcycleRepository';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { now, startOfWeek, endOfWeek } from '@/shared/utils/date';\nimport { Microcycle, type MicrocycleStructure } from '@/server/models/microcycle';\nimport { FitnessPlan } from '@/server/models/fitnessPlan';\nimport { microcycleAgentService } from '@/server/services/agents/training';\nimport type { UserWithProfile } from '@/server/models/user';\nimport type { ProgressInfo } from './progressService';\nimport { UserService } from '../user/userService';\n\n/**\n * Simplified MicrocycleService\n *\n * Creates and manages microcycles. Now works directly with fitness plan text\n * instead of mesocycle overviews. Uses absoluteWeek and days array.\n */\nexport class MicrocycleService {\n  private static instance: MicrocycleService;\n  private microcycleRepo: MicrocycleRepository;\n  private userService: UserService;\n\n  private constructor() {\n    this.microcycleRepo = new MicrocycleRepository(postgresDb);\n    this.userService = UserService.getInstance();\n  }\n\n  public static getInstance(): MicrocycleService {\n    if (!MicrocycleService.instance) {\n      MicrocycleService.instance = new MicrocycleService();\n    }\n    return MicrocycleService.instance;\n  }\n\n  /**\n   * Get the active microcycle for a client (the one flagged as active in DB)\n   */\n  public async getActiveMicrocycle(clientId: string) {\n    return await this.microcycleRepo.getActiveMicrocycle(clientId);\n  }\n\n  /**\n   * Check if the active microcycle encompasses the current week in the client's timezone\n   */\n  public async isActiveMicrocycleCurrent(clientId: string, timezone: string = 'America/New_York'): Promise<boolean> {\n    const activeMicrocycle = await this.microcycleRepo.getActiveMicrocycle(clientId);\n    if (!activeMicrocycle) {\n      return false;\n    }\n\n    const { startDate: currentWeekStart } = this.calculateWeekDates(timezone);\n    const normalizedCurrentWeekStart = new Date(currentWeekStart);\n    normalizedCurrentWeekStart.setHours(0, 0, 0, 0);\n\n    const activeMicrocycleStart = new Date(activeMicrocycle.startDate);\n    activeMicrocycleStart.setHours(0, 0, 0, 0);\n\n    const activeMicrocycleEnd = new Date(activeMicrocycle.endDate);\n    activeMicrocycleEnd.setHours(0, 0, 0, 0);\n\n    // Check if current week falls within active microcycle's date range\n    return normalizedCurrentWeekStart >= activeMicrocycleStart && normalizedCurrentWeekStart <= activeMicrocycleEnd;\n  }\n\n  /**\n   * Get all microcycles for a client\n   */\n  public async getAllMicrocycles(clientId: string) {\n    return await this.microcycleRepo.getAllMicrocycles(clientId);\n  }\n\n  /**\n   * Get microcycle by absolute week number\n   * Queries by clientId + absoluteWeek only (not fitnessPlanId)\n   */\n  public async getMicrocycleByAbsoluteWeek(\n    clientId: string,\n    absoluteWeek: number\n  ): Promise<Microcycle | null> {\n    return await this.microcycleRepo.getMicrocycleByAbsoluteWeek(clientId, absoluteWeek);\n  }\n\n  /**\n   * Get microcycle for a specific date\n   * Used for date-based progress tracking - finds the microcycle that contains the target date\n   * Queries by clientId + date range only (not fitnessPlanId)\n   */\n  public async getMicrocycleByDate(\n    clientId: string,\n    targetDate: Date\n  ): Promise<Microcycle | null> {\n    return await this.microcycleRepo.getMicrocycleByDate(clientId, targetDate);\n  }\n\n  /**\n   * Get a microcycle by ID\n   */\n  public async getMicrocycleById(microcycleId: string): Promise<Microcycle | null> {\n    return await this.microcycleRepo.getMicrocycleById(microcycleId);\n  }\n\n  /**\n   * Update a microcycle's days array\n   */\n  public async updateMicrocycleDays(\n    microcycleId: string,\n    days: string[]\n  ): Promise<Microcycle | null> {\n    return await this.microcycleRepo.updateMicrocycle(microcycleId, { days });\n  }\n\n  /**\n   * Update a microcycle\n   */\n  public async updateMicrocycle(\n    microcycleId: string,\n    microcycle: Partial<Microcycle>\n  ): Promise<Microcycle | null> {\n    return await this.microcycleRepo.updateMicrocycle(microcycleId, microcycle);\n  }\n\n  /**\n   * Create a new microcycle from progress information\n   * Uses fitness plan text and user profile to generate the week\n   */\n  public async createMicrocycleFromProgress(\n    clientId: string,\n    plan: FitnessPlan,\n    progress: ProgressInfo\n  ): Promise<Microcycle> {\n    // Get user profile for context\n    const user = await this.userService.getUser(clientId);\n    if (!user) {\n      throw new Error(`Client not found: ${clientId}`);\n    }\n\n    // Generate microcycle using AI agent service\n    // Note: fitness plan and isDeload are determined by the agent via context service\n    const { days, description, isDeload, message, structure } = await this.generateMicrocycle(\n      user,\n      progress.absoluteWeek\n    );\n\n    // Create new microcycle\n    const microcycle = await this.microcycleRepo.createMicrocycle({\n      clientId,\n      absoluteWeek: progress.absoluteWeek,\n      days,\n      description,\n      isDeload,\n      message,\n      structured: structure,\n      startDate: progress.weekStartDate,\n      endDate: progress.weekEndDate,\n      isActive: false, // No longer using isActive flag - we query by dates instead\n    });\n\n    console.log(`[MicrocycleService] Created microcycle for client ${clientId}, week ${progress.absoluteWeek} (${progress.weekStartDate.toISOString()} - ${progress.weekEndDate.toISOString()})`);\n    return microcycle;\n  }\n\n  /**\n   * Generate a microcycle using AI agent service\n   * Fitness plan is auto-fetched by context service\n   * The agent determines isDeload based on the plan's Progression Strategy\n   */\n  private async generateMicrocycle(\n    user: UserWithProfile,\n    absoluteWeek: number\n  ): Promise<{\n    days: string[];\n    description: string;\n    isDeload: boolean;\n    message: string;\n    structure?: MicrocycleStructure;\n  }> {\n    try {\n      // Use AI agent service to generate the microcycle\n      const result = await microcycleAgentService.generateMicrocycle(\n        user,\n        absoluteWeek\n      );\n\n      console.log(`[MicrocycleService] Generated microcycle for week ${absoluteWeek}, isDeload=${result.isDeload}`);\n      return result;\n    } catch (error) {\n      console.error('[MicrocycleService] Failed to generate microcycle:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Calculate week dates in a specific timezone\n   */\n  private calculateWeekDates(timezone: string = 'America/New_York'): { startDate: Date; endDate: Date } {\n    const currentDate = now(timezone).toJSDate();\n\n    return {\n      startDate: startOfWeek(currentDate, timezone),\n      endDate: endOfWeek(currentDate, timezone),\n    };\n  }\n\n  /**\n   * Delete a microcycle and all associated workouts\n   * Returns the count of deleted workouts along with success status\n   */\n  public async deleteMicrocycleWithWorkouts(\n    microcycleId: string\n  ): Promise<{ deleted: boolean; deletedWorkoutsCount: number }> {\n    // First, get the microcycle to verify it exists and get clientId\n    const microcycle = await this.microcycleRepo.getMicrocycleById(microcycleId);\n\n    if (!microcycle) {\n      return { deleted: false, deletedWorkoutsCount: 0 };\n    }\n\n    // Import workoutInstanceService dynamically to avoid circular dependency\n    const { workoutInstanceService } = await import('./workoutInstanceService');\n\n    // Get all workouts for this microcycle\n    const workouts = await workoutInstanceService.getWorkoutsByMicrocycle(\n      microcycle.clientId,\n      microcycleId\n    );\n\n    // Delete all associated workouts first\n    let deletedWorkoutsCount = 0;\n    for (const workout of workouts) {\n      const deleted = await workoutInstanceService.deleteWorkout(workout.id, microcycle.clientId);\n      if (deleted) {\n        deletedWorkoutsCount++;\n      }\n    }\n\n    // Then delete the microcycle\n    const deleted = await this.microcycleRepo.deleteMicrocycle(microcycleId);\n\n    return { deleted, deletedWorkoutsCount };\n  }\n}\n\n// Export singleton instance\nexport const microcycleService = MicrocycleService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7365, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/training/progressService.ts"],"sourcesContent":["import { FitnessPlan } from '../../models/fitnessPlan';\nimport { Microcycle } from '../../models/microcycle';\nimport {\n  parseDate,\n  now,\n  startOfWeek,\n  endOfWeek,\n  diffInWeeks,\n  getWeekday,\n} from '@/shared/utils/date';\nimport { MicrocycleService } from './microcycleService';\n\n/**\n * Simplified ProgressInfo without mesocycle layer\n */\nexport interface ProgressInfo {\n  fitnessPlan: FitnessPlan;\n  microcycle: Microcycle | null;\n  absoluteWeek: number;          // Weeks since plan start (1-indexed)\n  dayOfWeek: number;             // Day of week (1-7, Luxon format: 1=Mon, 7=Sun)\n  weekStartDate: Date;           // Start of current week\n  weekEndDate: Date;             // End of current week\n}\n\n/**\n * Simplified ProgressService\n *\n * Calculates progress based on plan start date and absolute week number.\n * No mesocycle layer - deload logic is derived from plan description.\n */\nexport class ProgressService {\n  private static instance: ProgressService;\n  private microcycleService: MicrocycleService;\n\n  private constructor() {\n    this.microcycleService = MicrocycleService.getInstance();\n  }\n\n  public static getInstance(): ProgressService {\n    if (!ProgressService.instance) {\n      ProgressService.instance = new ProgressService();\n    }\n    return ProgressService.instance;\n  }\n\n  /**\n   * Calculate progress for a specific date based on the fitness plan\n   * Uses absolute week number from plan start - no mesocycle lookup needed\n   */\n  public async getProgressForDate(\n    plan: FitnessPlan,\n    targetDate: Date,\n    timezone: string = 'America/New_York'\n  ): Promise<ProgressInfo | null> {\n    if (!plan || !plan.id) {\n      return null;\n    }\n\n    // Parse the plan start date\n    const planStartDate = parseDate(plan.startDate);\n    if (!planStartDate) {\n      return null;\n    }\n\n    // Calculate absolute week number since plan start (1-indexed)\n    const planStart = startOfWeek(planStartDate, timezone);\n    const targetWeekStart = startOfWeek(targetDate, timezone);\n    const absoluteWeek = diffInWeeks(targetWeekStart, planStart, timezone) + 1;\n\n    // If before plan start, return null\n    if (absoluteWeek < 1) {\n      return null;\n    }\n\n    // Query for existing microcycle by date or absolute week\n    // Note: queries by clientId only, not fitnessPlanId, to handle plan modifications\n    let microcycle = await this.microcycleService.getMicrocycleByDate(\n      plan.clientId,\n      targetDate\n    );\n\n    // If not found by date, try by absolute week\n    if (!microcycle) {\n      microcycle = await this.microcycleService.getMicrocycleByAbsoluteWeek(\n        plan.clientId,\n        absoluteWeek\n      );\n    }\n\n    // Calculate date-related fields\n    const dayOfWeek = getWeekday(targetDate, timezone);\n    const weekStart = startOfWeek(targetDate, timezone);\n    const weekEnd = endOfWeek(targetDate, timezone);\n\n    return {\n      fitnessPlan: plan,\n      microcycle,\n      absoluteWeek,\n      dayOfWeek,\n      weekStartDate: weekStart,\n      weekEndDate: weekEnd,\n    };\n  }\n\n  /**\n   * Get progress for the current date in the user's timezone\n   */\n  public async getCurrentProgress(\n    plan: FitnessPlan,\n    timezone: string = 'America/New_York'\n  ): Promise<ProgressInfo | null> {\n    const currentDate = now(timezone).toJSDate();\n    return await this.getProgressForDate(plan, currentDate, timezone);\n  }\n\n  /**\n   * Get or create microcycle for a specific date\n   * This is the main entry point for ensuring a user has a microcycle for any given week\n   *\n   * @param forceCreate - When true, always creates new microcycle (for re-onboarding)\n   */\n  public async getOrCreateMicrocycleForDate(\n    userId: string,\n    plan: FitnessPlan,\n    targetDate: Date,\n    timezone: string = 'America/New_York',\n    forceCreate: boolean = false\n  ): Promise<{ microcycle: Microcycle; progress: ProgressInfo; wasCreated: boolean }> {\n    // Calculate progress for the target date\n    const progress = await this.getProgressForDate(plan, targetDate, timezone);\n    if (!progress) {\n      throw new Error(`Could not calculate progress for date ${targetDate}`);\n    }\n\n    // If microcycle already exists and not forcing creation, return it\n    if (progress.microcycle && !forceCreate) {\n      return { microcycle: progress.microcycle, progress, wasCreated: false };\n    }\n\n    // Microcycle doesn't exist (or forceCreate=true) - create it using MicrocycleService\n    const microcycle = await this.microcycleService.createMicrocycleFromProgress(\n      userId,\n      plan,\n      progress\n    );\n\n    // Update progress with new microcycle\n    const updatedProgress = { ...progress, microcycle };\n\n    return { microcycle, progress: updatedProgress, wasCreated: true };\n  }\n}\n\n// Export singleton instance\nexport const progressService = ProgressService.getInstance();\n"],"names":[],"mappings":";;;;;;AAEA;AAQA;;;AAoBO,MAAM;IACX,OAAe,SAA0B;IACjC,kBAAqC;IAE7C,aAAsB;QACpB,IAAI,CAAC,iBAAiB,GAAG,uMAAiB,CAAC,WAAW;IACxD;IAEA,OAAc,cAA+B;QAC3C,IAAI,CAAC,gBAAgB,QAAQ,EAAE;YAC7B,gBAAgB,QAAQ,GAAG,IAAI;QACjC;QACA,OAAO,gBAAgB,QAAQ;IACjC;IAEA;;;GAGC,GACD,MAAa,mBACX,IAAiB,EACjB,UAAgB,EAChB,WAAmB,kBAAkB,EACP;QAC9B,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,EAAE;YACrB,OAAO;QACT;QAEA,4BAA4B;QAC5B,MAAM,gBAAgB,IAAA,mKAAS,EAAC,KAAK,SAAS;QAC9C,IAAI,CAAC,eAAe;YAClB,OAAO;QACT;QAEA,8DAA8D;QAC9D,MAAM,YAAY,IAAA,qKAAW,EAAC,eAAe;QAC7C,MAAM,kBAAkB,IAAA,qKAAW,EAAC,YAAY;QAChD,MAAM,eAAe,IAAA,qKAAW,EAAC,iBAAiB,WAAW,YAAY;QAEzE,oCAAoC;QACpC,IAAI,eAAe,GAAG;YACpB,OAAO;QACT;QAEA,yDAAyD;QACzD,kFAAkF;QAClF,IAAI,aAAa,MAAM,IAAI,CAAC,iBAAiB,CAAC,mBAAmB,CAC/D,KAAK,QAAQ,EACb;QAGF,6CAA6C;QAC7C,IAAI,CAAC,YAAY;YACf,aAAa,MAAM,IAAI,CAAC,iBAAiB,CAAC,2BAA2B,CACnE,KAAK,QAAQ,EACb;QAEJ;QAEA,gCAAgC;QAChC,MAAM,YAAY,IAAA,oKAAU,EAAC,YAAY;QACzC,MAAM,YAAY,IAAA,qKAAW,EAAC,YAAY;QAC1C,MAAM,UAAU,IAAA,mKAAS,EAAC,YAAY;QAEtC,OAAO;YACL,aAAa;YACb;YACA;YACA;YACA,eAAe;YACf,aAAa;QACf;IACF;IAEA;;GAEC,GACD,MAAa,mBACX,IAAiB,EACjB,WAAmB,kBAAkB,EACP;QAC9B,MAAM,cAAc,IAAA,6JAAG,EAAC,UAAU,QAAQ;QAC1C,OAAO,MAAM,IAAI,CAAC,kBAAkB,CAAC,MAAM,aAAa;IAC1D;IAEA;;;;;GAKC,GACD,MAAa,6BACX,MAAc,EACd,IAAiB,EACjB,UAAgB,EAChB,WAAmB,kBAAkB,EACrC,cAAuB,KAAK,EACsD;QAClF,yCAAyC;QACzC,MAAM,WAAW,MAAM,IAAI,CAAC,kBAAkB,CAAC,MAAM,YAAY;QACjE,IAAI,CAAC,UAAU;YACb,MAAM,IAAI,MAAM,CAAC,sCAAsC,EAAE,YAAY;QACvE;QAEA,mEAAmE;QACnE,IAAI,SAAS,UAAU,IAAI,CAAC,aAAa;YACvC,OAAO;gBAAE,YAAY,SAAS,UAAU;gBAAE;gBAAU,YAAY;YAAM;QACxE;QAEA,qFAAqF;QACrF,MAAM,aAAa,MAAM,IAAI,CAAC,iBAAiB,CAAC,4BAA4B,CAC1E,QACA,MACA;QAGF,sCAAsC;QACtC,MAAM,kBAAkB;YAAE,GAAG,QAAQ;YAAE;QAAW;QAElD,OAAO;YAAE;YAAY,UAAU;YAAiB,YAAY;QAAK;IACnE;AACF;AAGO,MAAM,kBAAkB,gBAAgB,WAAW"}},
    {"offset": {"line": 7471, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/shortLinkRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { ShortLink, NewShortLink } from '../models/shortLink';\nimport { sql } from 'kysely';\n\n/**\n * Repository for managing short links\n * Handles storage, retrieval, and cleanup of short link mappings\n */\nexport class ShortLinkRepository extends BaseRepository {\n  /**\n   * Generate a random 5-character alphanumeric code\n   * Uses uppercase, lowercase, and numbers (62 possible characters)\n   */\n  generateUniqueCode(): string {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    let code = '';\n    for (let i = 0; i < 5; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n  }\n\n  /**\n   * Create a new short link\n   * Uses upsert strategy: if code already exists, overwrites with new link\n   */\n  async createShortLink(link: NewShortLink): Promise<ShortLink> {\n    const result = await this.db\n      .insertInto('shortLinks')\n      .values({\n        code: link.code,\n        targetPath: link.targetPath,\n        clientId: link.clientId,\n        expiresAt: link.expiresAt,\n        createdAt: new Date(),\n        accessCount: 0,\n      })\n      .onConflict((oc) =>\n        oc.column('code').doUpdateSet({\n          targetPath: link.targetPath,\n          clientId: link.clientId,\n          expiresAt: link.expiresAt,\n          createdAt: new Date(),\n          accessCount: 0,\n          lastAccessedAt: null,\n        })\n      )\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Find a short link by code\n   * Returns the link if found, null otherwise\n   */\n  async findByCode(code: string): Promise<ShortLink | null> {\n    const result = await this.db\n      .selectFrom('shortLinks')\n      .selectAll()\n      .where('code', '=', code)\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Increment access count and update last accessed time\n   * Called when a short link is resolved\n   */\n  async incrementAccessCount(id: string): Promise<void> {\n    await this.db\n      .updateTable('shortLinks')\n      .set({\n        accessCount: sql`access_count + 1`,\n        lastAccessedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .execute();\n  }\n\n  /**\n   * Delete expired short links\n   * Should be run periodically to clean up the database\n   */\n  async deleteExpiredLinks(): Promise<number> {\n    const result = await this.db\n      .deleteFrom('shortLinks')\n      .where('expiresAt', '<', new Date())\n      .where('expiresAt', 'is not', null)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows || 0);\n  }\n\n  /**\n   * Delete all short links for a client\n   * Useful for cleanup when a client is deleted\n   */\n  async deleteByClientId(clientId: string): Promise<number> {\n    const result = await this.db\n      .deleteFrom('shortLinks')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows || 0);\n  }\n\n  /**\n   * Find all short links for a client\n   * Useful for admin views or user dashboards\n   */\n  async findByClientId(clientId: string): Promise<ShortLink[]> {\n    return await this.db\n      .selectFrom('shortLinks')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAMO,MAAM,4BAA4B,yLAAc;IACrD;;;GAGC,GACD,qBAA6B;QAC3B,MAAM,QAAQ;QACd,IAAI,OAAO;QACX,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;YAC1B,QAAQ,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;QAC9D;QACA,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,gBAAgB,IAAkB,EAAsB;QAC5D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,MAAM,CAAC;YACN,MAAM,KAAK,IAAI;YACf,YAAY,KAAK,UAAU;YAC3B,UAAU,KAAK,QAAQ;YACvB,WAAW,KAAK,SAAS;YACzB,WAAW,IAAI;YACf,aAAa;QACf,GACC,UAAU,CAAC,CAAC,KACX,GAAG,MAAM,CAAC,QAAQ,WAAW,CAAC;gBAC5B,YAAY,KAAK,UAAU;gBAC3B,UAAU,KAAK,QAAQ;gBACvB,WAAW,KAAK,SAAS;gBACzB,WAAW,IAAI;gBACf,aAAa;gBACb,gBAAgB;YAClB,IAED,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,WAAW,IAAY,EAA6B;QACxD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,SAAS,GACT,KAAK,CAAC,QAAQ,KAAK,MACnB,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;;GAGC,GACD,MAAM,qBAAqB,EAAU,EAAiB;QACpD,MAAM,IAAI,CAAC,EAAE,CACV,WAAW,CAAC,cACZ,GAAG,CAAC;YACH,aAAa,2NAAG,CAAC,gBAAgB,CAAC;YAClC,gBAAgB,IAAI;QACtB,GACC,KAAK,CAAC,MAAM,KAAK,IACjB,OAAO;IACZ;IAEA;;;GAGC,GACD,MAAM,qBAAsC;QAC1C,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,KAAK,CAAC,aAAa,KAAK,IAAI,QAC5B,KAAK,CAAC,aAAa,UAAU,MAC7B,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;IAEA;;;GAGC,GACD,MAAM,iBAAiB,QAAgB,EAAmB;QACxD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,KAAK,CAAC,YAAY,KAAK,UACvB,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;IAEA;;;GAGC,GACD,MAAM,eAAe,QAAgB,EAAwB;QAC3D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,cACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,UACvB,OAAO,CAAC,aAAa,QACrB,OAAO;IACZ;AACF"}},
    {"offset": {"line": 7553, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/links/shortLinkService.ts"],"sourcesContent":["import { ShortLinkRepository } from '@/server/repositories/shortLinkRepository';\nimport { ShortLink, CreateShortLinkOptions, ResolvedShortLink } from '@/server/models/shortLink';\nimport { getShortLinksConfig } from '@/shared/config';\n\n/**\n * Service for managing short links\n * Provides business logic for creating, resolving, and managing short links\n */\nexport class ShortLinkService {\n  private static instance: ShortLinkService;\n  private repository: ShortLinkRepository;\n\n  // Default expiration from config\n  private readonly DEFAULT_EXPIRY_DAYS = getShortLinksConfig().defaultExpiryDays;\n\n  private constructor() {\n    this.repository = new ShortLinkRepository();\n  }\n\n  public static getInstance(): ShortLinkService {\n    if (!ShortLinkService.instance) {\n      ShortLinkService.instance = new ShortLinkService();\n    }\n    return ShortLinkService.instance;\n  }\n\n  /**\n   * Create a short link\n   * Generates a unique code and stores the mapping\n   *\n   * @param clientId - Client ID to associate with the link\n   * @param targetPath - Path to redirect to (e.g., /me/program/workouts/123)\n   * @param options - Optional configuration (custom code, expiration)\n   * @returns The created short link\n   */\n  async createShortLink(\n    clientId: string,\n    targetPath: string,\n    options?: CreateShortLinkOptions\n  ): Promise<ShortLink> {\n    // Generate or use provided code\n    const code = options?.code || this.repository.generateUniqueCode();\n\n    // Calculate expiration date\n    const expiresAt =\n      options?.expiresAt ||\n      new Date(Date.now() + this.DEFAULT_EXPIRY_DAYS * 24 * 60 * 60 * 1000);\n\n    // Create the link (will upsert if code already exists)\n    const link = await this.repository.createShortLink({\n      code,\n      targetPath,\n      clientId,\n      expiresAt,\n    });\n\n    console.log(`[ShortLinkService] Created short link: ${code} -> ${targetPath}`);\n    return link;\n  }\n\n  /**\n   * Resolve a short link by code\n   * Returns the link and whether it's expired\n   * Increments access count if link is valid\n   *\n   * @param code - The short link code to resolve\n   * @returns ResolvedShortLink with link and expiration status, or null if not found\n   */\n  async resolveShortLink(code: string): Promise<ResolvedShortLink | null> {\n    const link = await this.repository.findByCode(code);\n\n    if (!link) {\n      console.log(`[ShortLinkService] Short link not found: ${code}`);\n      return null;\n    }\n\n    // Check if expired\n    const isExpired =\n      link.expiresAt !== null && new Date(link.expiresAt) < new Date();\n\n    if (isExpired) {\n      console.log(`[ShortLinkService] Short link expired: ${code}`);\n      return { link, isExpired: true };\n    }\n\n    // Increment access count asynchronously (don't wait)\n    this.repository.incrementAccessCount(link.id).catch((err) => {\n      console.error(`[ShortLinkService] Failed to increment access count for ${code}:`, err);\n    });\n\n    console.log(`[ShortLinkService] Resolved short link: ${code} -> ${link.targetPath}`);\n    return { link, isExpired: false };\n  }\n\n  /**\n   * Create a short link for a workout\n   * Convenience method for workout links\n   *\n   * @param userId - User ID\n   * @param workoutId - Workout ID\n   * @param options - Optional configuration\n   * @returns The created short link\n   */\n  async createWorkoutLink(\n    userId: string,\n    workoutId: string,\n    options?: CreateShortLinkOptions\n  ): Promise<ShortLink> {\n    const targetPath = `/me?workout=${workoutId}`;\n    return this.createShortLink(userId, targetPath, options);\n  }\n\n  /**\n   * Create a short link for a user's profile\n   * Convenience method for profile links\n   *\n   * @param userId - User ID\n   * @param options - Optional configuration\n   * @returns The created short link\n   */\n  async createProfileLink(\n    userId: string,\n    options?: CreateShortLinkOptions\n  ): Promise<ShortLink> {\n    const targetPath = '/me';\n    return this.createShortLink(userId, targetPath, options);\n  }\n\n  /**\n   * Get the full URL for a short link code\n   * Uses SHORT_LINK_DOMAIN environment variable\n   *\n   * @param code - The short link code\n   * @returns Full URL (e.g., https://gtxt.ai/l/aSxc2)\n   */\n  getFullUrl(code: string): string {\n    const domain = getShortLinksConfig().domain || 'https://gtxt.ai';\n    return `${domain}/l/${code}`;\n  }\n\n  /**\n   * Clean up expired short links\n   * Should be run periodically via cron job\n   *\n   * @returns Number of deleted links\n   */\n  async cleanupExpiredLinks(): Promise<number> {\n    try {\n      const deletedCount = await this.repository.deleteExpiredLinks();\n      console.log(`[ShortLinkService] Cleaned up ${deletedCount} expired short links`);\n      return deletedCount;\n    } catch (error) {\n      console.error('[ShortLinkService] Error cleaning up expired links:', error);\n      return 0;\n    }\n  }\n}\n\n// Export singleton instance\nexport const shortLinkService = ShortLinkService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AAMO,MAAM;IACX,OAAe,SAA2B;IAClC,WAAgC;IAExC,iCAAiC;IAChB,sBAAsB,IAAA,+LAAmB,IAAG,iBAAiB,CAAC;IAE/E,aAAsB;QACpB,IAAI,CAAC,UAAU,GAAG,IAAI,mMAAmB;IAC3C;IAEA,OAAc,cAAgC;QAC5C,IAAI,CAAC,iBAAiB,QAAQ,EAAE;YAC9B,iBAAiB,QAAQ,GAAG,IAAI;QAClC;QACA,OAAO,iBAAiB,QAAQ;IAClC;IAEA;;;;;;;;GAQC,GACD,MAAM,gBACJ,QAAgB,EAChB,UAAkB,EAClB,OAAgC,EACZ;QACpB,gCAAgC;QAChC,MAAM,OAAO,SAAS,QAAQ,IAAI,CAAC,UAAU,CAAC,kBAAkB;QAEhE,4BAA4B;QAC5B,MAAM,YACJ,SAAS,aACT,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,CAAC,mBAAmB,GAAG,KAAK,KAAK,KAAK;QAElE,uDAAuD;QACvD,MAAM,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,eAAe,CAAC;YACjD;YACA;YACA;YACA;QACF;QAEA,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,KAAK,IAAI,EAAE,YAAY;QAC7E,OAAO;IACT;IAEA;;;;;;;GAOC,GACD,MAAM,iBAAiB,IAAY,EAAqC;QACtE,MAAM,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC;QAE9C,IAAI,CAAC,MAAM;YACT,QAAQ,GAAG,CAAC,CAAC,yCAAyC,EAAE,MAAM;YAC9D,OAAO;QACT;QAEA,mBAAmB;QACnB,MAAM,YACJ,KAAK,SAAS,KAAK,QAAQ,IAAI,KAAK,KAAK,SAAS,IAAI,IAAI;QAE5D,IAAI,WAAW;YACb,QAAQ,GAAG,CAAC,CAAC,uCAAuC,EAAE,MAAM;YAC5D,OAAO;gBAAE;gBAAM,WAAW;YAAK;QACjC;QAEA,qDAAqD;QACrD,IAAI,CAAC,UAAU,CAAC,oBAAoB,CAAC,KAAK,EAAE,EAAE,KAAK,CAAC,CAAC;YACnD,QAAQ,KAAK,CAAC,CAAC,wDAAwD,EAAE,KAAK,CAAC,CAAC,EAAE;QACpF;QAEA,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,KAAK,IAAI,EAAE,KAAK,UAAU,EAAE;QACnF,OAAO;YAAE;YAAM,WAAW;QAAM;IAClC;IAEA;;;;;;;;GAQC,GACD,MAAM,kBACJ,MAAc,EACd,SAAiB,EACjB,OAAgC,EACZ;QACpB,MAAM,aAAa,CAAC,YAAY,EAAE,WAAW;QAC7C,OAAO,IAAI,CAAC,eAAe,CAAC,QAAQ,YAAY;IAClD;IAEA;;;;;;;GAOC,GACD,MAAM,kBACJ,MAAc,EACd,OAAgC,EACZ;QACpB,MAAM,aAAa;QACnB,OAAO,IAAI,CAAC,eAAe,CAAC,QAAQ,YAAY;IAClD;IAEA;;;;;;GAMC,GACD,WAAW,IAAY,EAAU;QAC/B,MAAM,SAAS,IAAA,+LAAmB,IAAG,MAAM,IAAI;QAC/C,OAAO,GAAG,OAAO,GAAG,EAAE,MAAM;IAC9B;IAEA;;;;;GAKC,GACD,MAAM,sBAAuC;QAC3C,IAAI;YACF,MAAM,eAAe,MAAM,IAAI,CAAC,UAAU,CAAC,kBAAkB;YAC7D,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,aAAa,oBAAoB,CAAC;YAC/E,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,uDAAuD;YACrE,OAAO;QACT;IACF;AACF;AAGO,MAAM,mBAAmB,iBAAiB,WAAW"}},
    {"offset": {"line": 7686, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/formatters/microcycle.ts"],"sourcesContent":["/**\n * Microcycle Formatting Utilities\n *\n * Pure functions for formatting microcycle data into string representations\n * for use in prompts, messages, and other contexts.\n */\n\nimport type { MicrocyclePattern } from '@/server/models/microcycle';\n\n/**\n * Simple day input with day name and content\n */\ninterface DayInput {\n  day: string;    // Day name (e.g., \"MONDAY\")\n  content: string; // Day overview content\n}\n\n/**\n * Format a microcycle day into a string representation\n *\n * @param day - Day object with name and content\n * @returns Formatted string with day details\n */\nexport function formatMicrocycleDay(day: DayInput): string {\n  return `Day: ${day.day}\\n${day.content}`;\n}\n\n/**\n * Format all days of a microcycle into a summary\n *\n * @param days - Array of 7 day overview strings\n * @returns Formatted multi-line string with all days\n */\nexport function formatMicrocycleDays(days: string[]): string {\n  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];\n\n  return days.map((content, index) => {\n    const dayName = dayNames[index] || `Day ${index + 1}`;\n    return `## ${dayName}\\n${content}`;\n  }).join('\\n\\n');\n}\n\n/**\n * Format a full microcycle pattern into a readable overview\n *\n * @param pattern - Complete microcycle pattern\n * @returns Formatted overview string\n */\nexport function formatMicrocyclePattern(pattern: MicrocyclePattern): string {\n  const sections: string[] = [];\n\n  // Overview\n  sections.push(`# Weekly Overview\\n${pattern.overview}`);\n\n  // Deload indicator\n  if (pattern.isDeload) {\n    sections.push('**Note: This is a DELOAD week**');\n  }\n\n  // Days\n  sections.push(formatMicrocycleDays(pattern.days));\n\n  return sections.join('\\n\\n');\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;AAkBM,SAAS,oBAAoB,GAAa;IAC/C,OAAO,CAAC,KAAK,EAAE,IAAI,GAAG,CAAC,EAAE,EAAE,IAAI,OAAO,EAAE;AAC1C;AAQO,SAAS,qBAAqB,IAAc;IACjD,MAAM,WAAW;QAAC;QAAU;QAAW;QAAa;QAAY;QAAU;QAAY;KAAS;IAE/F,OAAO,KAAK,GAAG,CAAC,CAAC,SAAS;QACxB,MAAM,UAAU,QAAQ,CAAC,MAAM,IAAI,CAAC,IAAI,EAAE,QAAQ,GAAG;QACrD,OAAO,CAAC,GAAG,EAAE,QAAQ,EAAE,EAAE,SAAS;IACpC,GAAG,IAAI,CAAC;AACV;AAQO,SAAS,wBAAwB,OAA0B;IAChE,MAAM,WAAqB,EAAE;IAE7B,WAAW;IACX,SAAS,IAAI,CAAC,CAAC,mBAAmB,EAAE,QAAQ,QAAQ,EAAE;IAEtD,mBAAmB;IACnB,IAAI,QAAQ,QAAQ,EAAE;QACpB,SAAS,IAAI,CAAC;IAChB;IAEA,OAAO;IACP,SAAS,IAAI,CAAC,qBAAqB,QAAQ,IAAI;IAE/C,OAAO,SAAS,IAAI,CAAC;AACvB"}},
    {"offset": {"line": 7733, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/formatters/fitnessProfile.ts"],"sourcesContent":["/**\n * Fitness Profile Formatting Utilities\n *\n * Pure functions for formatting user fitness profile data into string representations\n * for use in prompts, messages, and other contexts.\n */\n\nimport type { UserWithProfile } from \"@/server/models/user\";\n\n/**\n * Format a user's fitness profile into a structured string representation\n *\n * Returns the markdown profile with basic user demographics prepended.\n *\n * @param user - User object with profile data\n * @returns Formatted multi-line string with all available profile details\n *\n * @example\n * ```typescript\n * const formatted = formatFitnessProfile(user);\n * // Returns:\n * // CLIENT: John Doe\n * // AGE: 32\n * //\n * // [markdown profile content]\n * ```\n */\nexport function formatFitnessProfile(user: UserWithProfile): string {\n  const headerParts: string[] = [];\n\n  // Basic demographics - always include\n  headerParts.push(`CLIENT: ${user.name}`);\n  if (user.age) headerParts.push(`AGE: ${user.age}`);\n  if (user.gender) headerParts.push(`GENDER: ${user.gender}`);\n\n  const header = headerParts.join(' | ');\n\n  // Return minimal info if no profile\n  if (!user.profile) {\n    return header + '\\n\\nSTATUS: No fitness profile available';\n  }\n\n  // Return header + profile\n  return header + '\\n\\n' + user.profile;\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAsBM,SAAS,qBAAqB,IAAqB;IACxD,MAAM,cAAwB,EAAE;IAEhC,sCAAsC;IACtC,YAAY,IAAI,CAAC,CAAC,QAAQ,EAAE,KAAK,IAAI,EAAE;IACvC,IAAI,KAAK,GAAG,EAAE,YAAY,IAAI,CAAC,CAAC,KAAK,EAAE,KAAK,GAAG,EAAE;IACjD,IAAI,KAAK,MAAM,EAAE,YAAY,IAAI,CAAC,CAAC,QAAQ,EAAE,KAAK,MAAM,EAAE;IAE1D,MAAM,SAAS,YAAY,IAAI,CAAC;IAEhC,oCAAoC;IACpC,IAAI,CAAC,KAAK,OAAO,EAAE;QACjB,OAAO,SAAS;IAClB;IAEA,0BAA0B;IAC1B,OAAO,SAAS,SAAS,KAAK,OAAO;AACvC"}},
    {"offset": {"line": 7760, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/formatters/text.ts"],"sourcesContent":["/**\n * Text Formatting Utilities\n *\n * Utilities for formatting and normalizing text content.\n */\n\n/**\n * Normalizes whitespace in text by:\n * - Replacing 2+ consecutive blank lines with a single blank line\n * - Trimming leading/trailing whitespace\n *\n * @param text - The text to normalize\n * @returns The normalized text\n */\nexport function normalizeWhitespace(text: string): string {\n  return text\n    .replace(/\\n{3,}/g, '\\n\\n') // Replace 3+ newlines with 2 (one blank line)\n    .trim();\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED;;;;;;;CAOC;;;;AACM,SAAS,oBAAoB,IAAY;IAC9C,OAAO,KACJ,OAAO,CAAC,WAAW,QAAQ,8CAA8C;KACzE,IAAI;AACT"}},
    {"offset": {"line": 7783, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/formatters/index.ts"],"sourcesContent":["/**\n * Formatting Utilities\n *\n * Barrel export for all formatting utilities.\n * Provides a single import point for all formatters.\n */\n\nexport { formatMicrocycleDay } from './microcycle';\nexport { formatFitnessProfile } from './fitnessProfile';\nexport { normalizeWhitespace } from './text';\n"],"names":[],"mappings":"AAAA;;;;;CAKC;AAED;AACA;AACA"}},
    {"offset": {"line": 7799, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/training/workoutInstanceService.ts"],"sourcesContent":["import { WorkoutInstanceRepository } from '@/server/repositories/workoutInstanceRepository';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { workoutAgentService } from '@/server/services/agents/training';\nimport type { WorkoutInstanceUpdate, NewWorkoutInstance, WorkoutInstance } from '@/server/models/workout';\nimport type { UserWithProfile } from '@/server/models/user';\nimport type { ActivityType, Microcycle } from '@/server/models/microcycle';\nimport { FitnessPlanService } from './fitnessPlanService';\nimport { ProgressService } from './progressService';\nimport { MicrocycleService } from './microcycleService';\nimport { shortLinkService } from '../links/shortLinkService';\nimport { DateTime } from 'luxon';\nimport { getWeekday, getDayOfWeekName } from '@/shared/utils/date';\nimport { normalizeWhitespace } from '@/server/utils/formatters';\n\nexport class WorkoutInstanceService {\n  private static instance: WorkoutInstanceService;\n  private workoutRepo: WorkoutInstanceRepository;\n  private fitnessPlanService: FitnessPlanService;\n  private progressService: ProgressService;\n  private microcycleService: MicrocycleService;\n\n  private constructor() {\n    this.workoutRepo = new WorkoutInstanceRepository(postgresDb);\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n    this.progressService = ProgressService.getInstance();\n    this.microcycleService = MicrocycleService.getInstance();\n  }\n\n  public static getInstance(): WorkoutInstanceService {\n    if (!WorkoutInstanceService.instance) {\n      WorkoutInstanceService.instance = new WorkoutInstanceService();\n    }\n    return WorkoutInstanceService.instance;\n  }\n\n  /**\n   * Get recent workouts for a user\n   */\n  public async getRecentWorkouts(userId: string, limit: number = 10) {\n    return await this.workoutRepo.getRecentWorkouts(userId, limit);\n  }\n\n  /**\n   * Get workouts by date range\n   */\n  public async getWorkoutsByDateRange(userId: string, startDate: Date, endDate: Date) {\n    return await this.workoutRepo.getWorkoutsByDateRange(userId, startDate, endDate);\n  }\n\n  /**\n   * Get a specific workout by ID and verify it belongs to the user\n   */\n  public async getWorkoutById(workoutId: string, userId: string) {\n    const workout = await this.workoutRepo.getWorkoutById(workoutId);\n\n    if (!workout || workout.clientId !== userId) {\n      return null;\n    }\n\n    return workout;\n  }\n\n  /**\n   * Get a workout by ID without authorization check\n   * For internal service-to-service use only\n   */\n  public async getWorkoutByIdInternal(workoutId: string): Promise<WorkoutInstance | undefined> {\n    return await this.workoutRepo.getWorkoutById(workoutId);\n  }\n\n  /**\n   * Get a workout by user ID and date\n   */\n  public async getWorkoutByUserIdAndDate(userId: string, date: Date) {\n    return await this.workoutRepo.findByClientIdAndDate(userId, date);\n  }\n\n  /**\n   * Update the message for a workout\n   */\n  public async updateWorkoutMessage(workoutId: string, message: string) {\n    return await this.workoutRepo.update(workoutId, { message });\n  }\n\n  /**\n   * Create a new workout instance\n   */\n  public async createWorkout(workout: NewWorkoutInstance) {\n    return await this.workoutRepo.create(workout);\n  }\n\n  /**\n   * Update a workout with new details, description, reasoning, and message\n   */\n  public async updateWorkout(workoutId: string, updates: WorkoutInstanceUpdate) {\n    return await this.workoutRepo.update(workoutId, updates);\n  }\n\n  /**\n   * Generate a workout for a specific date using AI\n   *\n   * This is the core business logic for workout generation:\n   * 1. Gets user's fitness plan and current progress\n   * 2. Determines day pattern from microcycle\n   * 3. Generates workout using AI agent\n   * 4. Saves workout with pre-generated message\n   * 5. Creates short link and appends to message\n   *\n   * @param user - User with profile\n   * @param targetDate - Date to generate workout for\n   * @param providedMicrocycle - Optional pre-loaded microcycle (avoids extra DB query)\n   * @returns Generated and saved workout instance\n   */\n  public async generateWorkoutForDate(\n    user: UserWithProfile,\n    targetDate: DateTime,\n    providedMicrocycle?: Microcycle\n  ): Promise<WorkoutInstance | null> {\n    try {\n      // Get fitness plan\n      const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n      if (!plan) {\n        console.log(`No fitness plan found for user ${user.id}`);\n        return null;\n      }\n\n      // Get current progress for the target date\n      const progress = await this.progressService.getProgressForDate(plan, targetDate.toJSDate(), user.timezone);\n      if (!progress) {\n        console.log(`No progress found for user ${user.id} on ${targetDate.toISODate()}`);\n        return null;\n      }\n\n      // Use provided microcycle or get/create one for the target date\n      let microcycle: Microcycle | null = providedMicrocycle ?? null;\n      if (!microcycle) {\n        const result = await this.progressService.getOrCreateMicrocycleForDate(\n          user.id,\n          plan,\n          targetDate.toJSDate(),\n          user.timezone\n        );\n        microcycle = result.microcycle;\n      }\n      if (!microcycle) {\n        console.log(`Could not get/create microcycle for user ${user.id}`);\n        return null;\n      }\n\n      // Get the day's overview from the microcycle\n      // getWeekday returns 1-7 (Mon-Sun), days array is 0-indexed (Mon=0, Sun=6)\n      const dayIndex = getWeekday(targetDate.toJSDate(), user.timezone) - 1;\n      const dayOverview = microcycle.days?.[dayIndex];\n\n      if (!dayOverview || typeof dayOverview !== 'string') {\n        console.log(`No overview found for day index ${dayIndex} in microcycle ${microcycle.id}`);\n        return null;\n      }\n\n      // Get activity type from structured microcycle data (if available)\n      const structuredDay = microcycle.structured?.days?.[dayIndex];\n      const activityType = structuredDay?.activityType as ActivityType | undefined;\n\n      // Get recent workouts for context (last 7 days)\n      // const recentWorkouts = await this.getRecentWorkouts(user.id, 7);\n\n      // Use AI agent service to generate workout with message\n      const { response: description, message, structure } = await workoutAgentService.generateWorkout(\n        user,\n        dayOverview,\n        microcycle.isDeload ?? false,\n        activityType\n      );\n\n      // Extract theme from structured data or use default\n      const theme = structure?.title || 'Workout';\n\n      const details = {\n        theme,  // Keep theme for quick access\n      };\n\n      // Convert to database format\n      const workout: NewWorkoutInstance = {\n        clientId: user.id,\n        microcycleId: microcycle.id,\n        date: targetDate.toJSDate(),\n        sessionType: 'workout', // Use generic session type since we don't have theme from day overview\n        goal: dayOverview.substring(0, 100), // Use first 100 chars of overview as goal\n        details: JSON.parse(JSON.stringify(details)),\n        description,\n        message,\n        structured: structure,\n        completedAt: null,\n        createdAt: new Date(),\n        updatedAt: new Date()\n      };\n\n      // Save the workout to the database\n      const savedWorkout = await this.createWorkout(workout);\n      console.log(`Generated and saved workout for user ${user.id} on ${targetDate.toISODate()}`);\n\n      // Generate short link for the workout\n      try {\n        const shortLink = await shortLinkService.createWorkoutLink(user.id, savedWorkout.id);\n        const fullUrl = shortLinkService.getFullUrl(shortLink.code);\n        console.log(`Created short link for workout ${savedWorkout.id}: ${fullUrl}`);\n\n        // Append short link to message\n        if (savedWorkout.message) {\n          const dayOfWeekTitle = getDayOfWeekName(targetDate.toJSDate(), user.timezone); // Monday, Tuesday, etc.\n          savedWorkout.message = normalizeWhitespace(`${dayOfWeekTitle}\\n\\n${savedWorkout.message}\\n\\n(More details: ${fullUrl})`);\n          await this.updateWorkoutMessage(savedWorkout.id, savedWorkout.message);\n        }\n      } catch (error) {\n        console.error(`Failed to create short link for workout ${savedWorkout.id}:`, error);\n        // Continue without link - not critical\n      }\n\n      return savedWorkout;\n    } catch (error) {\n      console.error(`Error generating workout for user ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Maps theme to session type for database storage\n   * Valid frontend types: run, lift, metcon, mobility, rest, other\n   */\n  private mapThemeToSessionType(theme: string): string {\n    const themeLower = theme.toLowerCase();\n\n    if (themeLower.includes('run') || themeLower.includes('running')) return 'run';\n    if (themeLower.includes('metcon') || themeLower.includes('hiit') ||\n        themeLower.includes('conditioning') || themeLower.includes('cardio')) return 'metcon';\n    if (themeLower.includes('lift') || themeLower.includes('strength') ||\n        themeLower.includes('upper') || themeLower.includes('lower') ||\n        themeLower.includes('push') || themeLower.includes('pull')) return 'lift';\n    if (themeLower.includes('mobility') || themeLower.includes('flexibility') ||\n        themeLower.includes('stretch')) return 'mobility';\n    if (themeLower.includes('rest') || themeLower.includes('recovery') ||\n        themeLower.includes('deload')) return 'rest';\n\n    return 'other';\n  }\n\n  /**\n   * Delete a workout instance\n   */\n  public async deleteWorkout(workoutId: string, userId: string): Promise<boolean> {\n    // First verify the workout belongs to the user\n    const workout = await this.workoutRepo.getWorkoutById(workoutId);\n\n    if (!workout || workout.clientId !== userId) {\n      return false;\n    }\n\n    // Delete the workout\n    return await this.workoutRepo.delete(workoutId);\n  }\n\n  /**\n   * Get workouts by microcycle ID\n   */\n  public async getWorkoutsByMicrocycle(userId: string, microcycleId: string): Promise<WorkoutInstance[]> {\n    return await this.workoutRepo.getWorkoutsByMicrocycle(userId, microcycleId);\n  }\n}\n\n// Export singleton instance\nexport const workoutInstanceService = WorkoutInstanceService.getInstance();"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8021, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/profileRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { Profiles } from '../models/_types';\nimport type { Selectable, Insertable } from 'kysely';\nimport type { StructuredProfile } from '@/server/models/profile';\n\nexport type Profile = Selectable<Profiles>;\nexport type NewProfile = Insertable<Profiles>;\n\n/**\n * Profile with typed structured data\n * The database stores structured as JSONB, this interface casts it to the correct type\n */\nexport interface ProfileWithStructured extends Omit<Profile, 'structured'> {\n  structured: StructuredProfile | null;\n}\n\n/**\n * ProfileRepository - Data access layer for Markdown-based fitness profiles\n *\n * This repository handles CRUD operations for the profiles table which stores\n * the history of user fitness profiles in Markdown format. Each update creates\n * a new row, providing full audit trail and versioning.\n */\nexport class ProfileRepository extends BaseRepository {\n  /**\n   * Get the current (most recent) profile for a user\n   *\n   * @param clientId - UUID of the user\n   * @returns Most recent profile or undefined if no profiles exist\n   */\n  async getCurrentProfile(clientId: string): Promise<Profile | undefined> {\n    const profile = await this.db\n      .selectFrom('profiles')\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(1)\n      .selectAll()\n      .executeTakeFirst();\n\n    return profile;\n  }\n\n  /**\n   * Get the current profile text (Markdown) for a user\n   *\n   * @param clientId - UUID of the user\n   * @returns Markdown profile text or null if no profiles exist\n   */\n  async getCurrentProfileText(clientId: string): Promise<string | null> {\n    const profile = await this.getCurrentProfile(clientId);\n    return profile?.profile ?? null;\n  }\n\n  /**\n   * Create a new profile entry (appends to history)\n   *\n   * @param newProfile - Profile data to insert\n   * @returns Created profile record\n   */\n  async createProfile(newProfile: NewProfile): Promise<Profile> {\n    const result = await this.db\n      .insertInto('profiles')\n      .values(newProfile)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Create a new profile entry with just clientId and profile text\n   * Convenience method for common use case\n   *\n   * @param clientId - UUID of the user\n   * @param profileMarkdown - Markdown-formatted profile text\n   * @returns Created profile record\n   */\n  async createProfileForUser(clientId: string, profileMarkdown: string): Promise<Profile> {\n    return this.createProfile({\n      clientId,\n      profile: profileMarkdown,\n    });\n  }\n\n  /**\n   * Get profile history for a user\n   *\n   * @param clientId - UUID of the user\n   * @param limit - Maximum number of historical profiles to retrieve (default: 10)\n   * @returns Array of profile records, ordered by most recent first\n   */\n  async getProfileHistory(clientId: string, limit: number = 10): Promise<Profile[]> {\n    const profiles = await this.db\n      .selectFrom('profiles')\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .selectAll()\n      .execute();\n\n    return profiles;\n  }\n\n  /**\n   * Get profile as of a specific date\n   * Returns the most recent profile that was created before or at the given date\n   *\n   * @param clientId - UUID of the user\n   * @param date - Date to retrieve profile for\n   * @returns Profile record or undefined if no profiles exist before that date\n   */\n  async getProfileAtDate(clientId: string, date: Date): Promise<Profile | undefined> {\n    const profile = await this.db\n      .selectFrom('profiles')\n      .where('clientId', '=', clientId)\n      .where('createdAt', '<=', date)\n      .orderBy('createdAt', 'desc')\n      .limit(1)\n      .selectAll()\n      .executeTakeFirst();\n\n    return profile;\n  }\n\n  /**\n   * Count total profile updates for a user\n   *\n   * @param clientId - UUID of the user\n   * @returns Number of profile updates in history\n   */\n  async countProfileUpdates(clientId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('profiles')\n      .where('clientId', '=', clientId)\n      .select(this.db.fn.count('id').as('count'))\n      .executeTakeFirstOrThrow();\n\n    return Number(result.count);\n  }\n\n  /**\n   * Get the date of the last profile update\n   *\n   * @param clientId - UUID of the user\n   * @returns Date of last update or null if no profiles exist\n   */\n  async getLastUpdateDate(clientId: string): Promise<Date | null> {\n    const profile = await this.getCurrentProfile(clientId);\n    return profile?.createdAt ?? null;\n  }\n\n  /**\n   * Delete all profiles for a user (typically only for testing/cleanup)\n   * WARNING: This removes all history\n   *\n   * @param clientId - UUID of the user\n   * @returns Number of profiles deleted\n   */\n  async deleteAllProfilesForUser(clientId: string): Promise<number> {\n    const result = await this.db\n      .deleteFrom('profiles')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows);\n  }\n\n  /**\n   * Get all users who have profiles\n   *\n   * @returns Array of distinct client IDs\n   */\n  async getAllUsersWithProfiles(): Promise<string[]> {\n    const results = await this.db\n      .selectFrom('profiles')\n      .select('clientId')\n      .distinct()\n      .execute();\n\n    return results.map(r => r.clientId);\n  }\n\n  /**\n   * Check if a user has any profiles\n   *\n   * @param clientId - UUID of the user\n   * @returns True if user has at least one profile\n   */\n  async hasProfile(clientId: string): Promise<boolean> {\n    const count = await this.countProfileUpdates(clientId);\n    return count > 0;\n  }\n\n  // ============================================\n  // Structured Profile Methods\n  // ============================================\n\n  /**\n   * Create a new profile entry with structured data\n   * Convenience method that handles JSONB serialization\n   *\n   * @param clientId - UUID of the user\n   * @param profileMarkdown - Markdown-formatted profile text\n   * @param structured - Structured profile data (or null)\n   * @returns Created profile record\n   */\n  async createProfileWithStructured(\n    clientId: string,\n    profileMarkdown: string,\n    structured: StructuredProfile | null\n  ): Promise<Profile> {\n    const result = await this.db\n      .insertInto('profiles')\n      .values({\n        clientId,\n        profile: profileMarkdown,\n        structured: structured ? JSON.stringify(structured) : null,\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Get the current profile with typed structured data\n   *\n   * @param clientId - UUID of the user\n   * @returns Most recent profile with typed structured field, or undefined\n   */\n  async getCurrentProfileWithStructured(clientId: string): Promise<ProfileWithStructured | undefined> {\n    const profile = await this.getCurrentProfile(clientId);\n    if (!profile) return undefined;\n\n    return {\n      ...profile,\n      structured: profile.structured as StructuredProfile | null,\n    };\n  }\n\n  /**\n   * Get the current structured profile data only\n   *\n   * @param clientId - UUID of the user\n   * @returns Structured profile data or null if not available\n   */\n  async getCurrentStructuredProfile(clientId: string): Promise<StructuredProfile | null> {\n    const profile = await this.getCurrentProfileWithStructured(clientId);\n    return profile?.structured ?? null;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8192, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/twilio/factory.ts"],"sourcesContent":["/**\n * Twilio Client Factory\n *\n * Creates Twilio client instances on-demand. Supports multiple\n * credentials for environment switching (sandbox/production).\n */\nimport twilio from 'twilio';\nimport { MessageInstance } from 'twilio/lib/rest/api/v2010/account/message';\n\n/**\n * Twilio credentials configuration\n */\nexport interface TwilioCredentials {\n  accountSid: string;\n  authToken: string;\n  phoneNumber: string;\n}\n\n/**\n * Twilio client interface for dependency injection\n */\nexport interface ITwilioClient {\n  sendSMS(to: string, message?: string, mediaUrls?: string[]): Promise<MessageInstance>;\n  sendMMS(to: string, message: string | undefined, mediaUrls: string[]): Promise<MessageInstance>;\n  getMessageStatus(messageSid: string): Promise<MessageInstance>;\n  getFromNumber(): string;\n}\n\n// Cache clients by account SID\nconst clientCache = new Map<string, ITwilioClient>();\n\n/**\n * Create or retrieve a cached Twilio client\n * @param credentials - Twilio account credentials\n * @param statusCallbackUrl - Optional status callback URL for message delivery updates\n * @returns ITwilioClient instance\n */\nexport function createTwilioClient(\n  credentials: TwilioCredentials,\n  statusCallbackUrl?: string\n): ITwilioClient {\n  const cacheKey = credentials.accountSid;\n\n  // Return cached instance if available\n  if (clientCache.has(cacheKey)) {\n    return clientCache.get(cacheKey)!;\n  }\n\n  const client = twilio(credentials.accountSid, credentials.authToken);\n  const fromNumber = credentials.phoneNumber;\n\n  const twilioClient: ITwilioClient = {\n    async sendSMS(to: string, message?: string, mediaUrls?: string[]): Promise<MessageInstance> {\n      try {\n        const messageType = mediaUrls && mediaUrls.length > 0 ? 'MMS' : 'SMS';\n        console.log(`Sending ${messageType} from:`, fromNumber, 'to:', to);\n        if (mediaUrls && mediaUrls.length > 0) {\n          console.log('Media URLs:', mediaUrls);\n        }\n        if (!message && (!mediaUrls || mediaUrls.length === 0)) {\n          throw new Error('Must provide either message text or media URLs');\n        }\n\n        const response = await client.messages.create({\n          ...(message && { body: message }),\n          from: fromNumber,\n          to: to,\n          statusCallback: statusCallbackUrl,\n          ...(mediaUrls && mediaUrls.length > 0 && { mediaUrl: mediaUrls }),\n        });\n        return response;\n      } catch (error) {\n        console.error('Error sending SMS/MMS:', error);\n        throw error;\n      }\n    },\n\n    async sendMMS(to: string, message: string | undefined, mediaUrls: string[]): Promise<MessageInstance> {\n      return this.sendSMS(to, message, mediaUrls);\n    },\n\n    async getMessageStatus(messageSid: string): Promise<MessageInstance> {\n      return await client.messages(messageSid).fetch();\n    },\n\n    getFromNumber(): string {\n      return fromNumber;\n    },\n  };\n\n  clientCache.set(cacheKey, twilioClient);\n  return twilioClient;\n}\n\n/**\n * Clear all cached Twilio clients\n */\nexport function clearTwilioClients(): void {\n  clientCache.clear();\n}\n\n/**\n * Get all active Twilio account SIDs (for debugging)\n */\nexport function getActiveTwilioAccounts(): string[] {\n  return Array.from(clientCache.keys());\n}\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;AACD;;AAsBA,+BAA+B;AAC/B,MAAM,cAAc,IAAI;AAQjB,SAAS,mBACd,WAA8B,EAC9B,iBAA0B;IAE1B,MAAM,WAAW,YAAY,UAAU;IAEvC,sCAAsC;IACtC,IAAI,YAAY,GAAG,CAAC,WAAW;QAC7B,OAAO,YAAY,GAAG,CAAC;IACzB;IAEA,MAAM,SAAS,IAAA,sMAAM,EAAC,YAAY,UAAU,EAAE,YAAY,SAAS;IACnE,MAAM,aAAa,YAAY,WAAW;IAE1C,MAAM,eAA8B;QAClC,MAAM,SAAQ,EAAU,EAAE,OAAgB,EAAE,SAAoB;YAC9D,IAAI;gBACF,MAAM,cAAc,aAAa,UAAU,MAAM,GAAG,IAAI,QAAQ;gBAChE,QAAQ,GAAG,CAAC,CAAC,QAAQ,EAAE,YAAY,MAAM,CAAC,EAAE,YAAY,OAAO;gBAC/D,IAAI,aAAa,UAAU,MAAM,GAAG,GAAG;oBACrC,QAAQ,GAAG,CAAC,eAAe;gBAC7B;gBACA,IAAI,CAAC,WAAW,CAAC,CAAC,aAAa,UAAU,MAAM,KAAK,CAAC,GAAG;oBACtD,MAAM,IAAI,MAAM;gBAClB;gBAEA,MAAM,WAAW,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;oBAC5C,GAAI,WAAW;wBAAE,MAAM;oBAAQ,CAAC;oBAChC,MAAM;oBACN,IAAI;oBACJ,gBAAgB;oBAChB,GAAI,aAAa,UAAU,MAAM,GAAG,KAAK;wBAAE,UAAU;oBAAU,CAAC;gBAClE;gBACA,OAAO;YACT,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,0BAA0B;gBACxC,MAAM;YACR;QACF;QAEA,MAAM,SAAQ,EAAU,EAAE,OAA2B,EAAE,SAAmB;YACxE,OAAO,IAAI,CAAC,OAAO,CAAC,IAAI,SAAS;QACnC;QAEA,MAAM,kBAAiB,UAAkB;YACvC,OAAO,MAAM,OAAO,QAAQ,CAAC,YAAY,KAAK;QAChD;QAEA;YACE,OAAO;QACT;IACF;IAEA,YAAY,GAAG,CAAC,UAAU;IAC1B,OAAO;AACT;AAKO,SAAS;IACd,YAAY,KAAK;AACnB;AAKO,SAAS;IACd,OAAO,MAAM,IAAI,CAAC,YAAY,IAAI;AACpC"}},
    {"offset": {"line": 8268, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/twilio/twilio.ts"],"sourcesContent":["/**\n * Twilio Connection\n *\n * This module provides the default Twilio client using environment\n * variables. For environment switching (sandbox/production), use\n * the factory functions instead.\n */\nimport { getTwilioSecrets } from '@/server/config';\nimport { getUrlsConfig } from '@/shared/config';\nimport { createTwilioClient, type ITwilioClient, type TwilioCredentials } from './factory';\n\n// Get credentials from validated server config\nconst credentials = getTwilioSecrets();\n\n// Build status callback URL if BASE_URL is configured\nconst { baseUrl } = getUrlsConfig();\nconst statusCallbackUrl = baseUrl ? `${baseUrl}/api/twilio/status` : undefined;\n\n// Create default Twilio client using factory\nexport const twilioClient: ITwilioClient = createTwilioClient(\n  {\n    accountSid: credentials.accountSid,\n    authToken: credentials.authToken,\n    phoneNumber: credentials.phoneNumber,\n  },\n  statusCallbackUrl\n);\n\n// Re-export factory functions and types for environment switching\nexport {\n  createTwilioClient,\n  clearTwilioClients,\n  getActiveTwilioAccounts,\n  type ITwilioClient,\n  type TwilioCredentials,\n} from './factory'; "],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;AACD;AAAA;AACA;AACA;;;;AAEA,+CAA+C;AAC/C,MAAM,cAAc,IAAA,8KAAgB;AAEpC,sDAAsD;AACtD,MAAM,EAAE,OAAO,EAAE,GAAG,IAAA,yLAAa;AACjC,MAAM,oBAAoB,UAAU,GAAG,QAAQ,kBAAkB,CAAC,GAAG;AAG9D,MAAM,eAA8B,IAAA,+LAAkB,EAC3D;IACE,YAAY,YAAY,UAAU;IAClC,WAAW,YAAY,SAAS;IAChC,aAAa,YAAY,WAAW;AACtC,GACA"}},
    {"offset": {"line": 8300, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/messaging/twilioClient.ts"],"sourcesContent":["/**\n * Twilio Messaging Client\n *\n * Implements IMessagingClient for Twilio SMS delivery.\n * Wraps the Twilio API and provides a standardized messaging interface.\n */\n\nimport { twilioClient as twilioSdk } from '../twilio/twilio';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport class TwilioMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'twilio';\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    try {\n      const twilioResponse = await twilioSdk.sendSMS(user.phoneNumber, message, mediaUrls);\n\n      return {\n        messageId: twilioResponse.sid,\n        status: this.mapTwilioStatus(twilioResponse.status),\n        provider: this.provider,\n        to: twilioResponse.to,\n        from: twilioResponse.from,\n        timestamp: twilioResponse.dateCreated,\n        metadata: {\n          twilioSid: twilioResponse.sid,\n          twilioStatus: twilioResponse.status,\n          errorCode: twilioResponse.errorCode,\n          errorMessage: twilioResponse.errorMessage,\n          mediaUrls,\n        },\n      };\n    } catch (error) {\n      console.error('TwilioMessagingClient: Failed to send message', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Maps Twilio status to standardized message status\n   */\n  private mapTwilioStatus(\n    twilioStatus: string\n  ): MessageResult['status'] {\n    switch (twilioStatus) {\n      case 'sent':\n      case 'delivered':\n        return 'delivered';\n      case 'queued':\n      case 'accepted':\n      case 'sending':\n        return 'queued';\n      case 'failed':\n      case 'undelivered':\n        return 'failed';\n      default:\n        return 'sent';\n    }\n  }\n}\n\n// Export singleton instance\nexport const twilioMessagingClient = new TwilioMessagingClient();\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;AAED;;AAIO,MAAM;IACK,WAA8B,SAAS;IAEvD,MAAM,YAAY,IAAqB,EAAE,OAAgB,EAAE,SAAoB,EAA0B;QACvG,IAAI;YACF,MAAM,iBAAiB,MAAM,wMAAS,CAAC,OAAO,CAAC,KAAK,WAAW,EAAE,SAAS;YAE1E,OAAO;gBACL,WAAW,eAAe,GAAG;gBAC7B,QAAQ,IAAI,CAAC,eAAe,CAAC,eAAe,MAAM;gBAClD,UAAU,IAAI,CAAC,QAAQ;gBACvB,IAAI,eAAe,EAAE;gBACrB,MAAM,eAAe,IAAI;gBACzB,WAAW,eAAe,WAAW;gBACrC,UAAU;oBACR,WAAW,eAAe,GAAG;oBAC7B,cAAc,eAAe,MAAM;oBACnC,WAAW,eAAe,SAAS;oBACnC,cAAc,eAAe,YAAY;oBACzC;gBACF;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,iDAAiD;YAC/D,MAAM;QACR;IACF;IAEA;;GAEC,GACD,AAAQ,gBACN,YAAoB,EACK;QACzB,OAAQ;YACN,KAAK;YACL,KAAK;gBACH,OAAO;YACT,KAAK;YACL,KAAK;YACL,KAAK;gBACH,OAAO;YACT,KAAK;YACL,KAAK;gBACH,OAAO;YACT;gBACE,OAAO;QACX;IACF;AACF;AAGO,MAAM,wBAAwB,IAAI"}},
    {"offset": {"line": 8362, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/messaging/localClient.ts"],"sourcesContent":["/**\n * Local Messaging Client\n *\n * Implements IMessagingClient for local development and testing.\n * Uses EventEmitter to broadcast messages to connected SSE clients.\n * Does not actually send SMS - instead emits events for local consumption.\n */\n\nimport { EventEmitter } from 'events';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport interface LocalMessage {\n  messageId: string;\n  to: string;\n  from: string;\n  content: string;\n  timestamp: Date;\n}\n\nexport class LocalMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'local';\n  private eventEmitter: EventEmitter;\n  private messageCounter = 0;\n\n  constructor() {\n    this.eventEmitter = new EventEmitter();\n    // Increase max listeners for SSE connections\n    this.eventEmitter.setMaxListeners(100);\n  }\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    const messageId = `local-${Date.now()}-${++this.messageCounter}`;\n    const timestamp = new Date();\n    const to = user.phoneNumber;\n\n    const localMessage: LocalMessage = {\n      messageId,\n      to,\n      from: 'local-system',\n      content: message || '[MMS only - no text]',\n      timestamp,\n    };\n\n    // Emit the message event for SSE listeners\n    this.eventEmitter.emit('message', localMessage);\n\n    console.log(`[LocalMessagingClient] Message sent (not actual SMS):`, {\n      messageId,\n      to,\n      userId: user.id,\n      preview: message ? message.substring(0, 50) : '[MMS only]',\n      mediaUrls,\n    });\n\n    return {\n      messageId,\n      status: 'sent',\n      provider: this.provider,\n      to,\n      from: 'local-system',\n      timestamp,\n      metadata: {\n        userId: user.id,\n        phoneNumber: to,\n        contentLength: message?.length || 0,\n        mediaUrls,\n      },\n    };\n  }\n\n  /**\n   * Subscribe to message events (for SSE connections)\n   */\n  onMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.on('message', listener);\n  }\n\n  /**\n   * Unsubscribe from message events\n   */\n  offMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.off('message', listener);\n  }\n\n  /**\n   * Get current number of active listeners\n   */\n  getListenerCount(): number {\n    return this.eventEmitter.listenerCount('message');\n  }\n}\n\n// Export singleton instance\nexport const localMessagingClient = new LocalMessagingClient();\n"],"names":[],"mappings":"AAAA;;;;;;CAMC;;;;;;AAED;;AAYO,MAAM;IACK,WAA8B,QAAQ;IAC9C,aAA2B;IAC3B,iBAAiB,EAAE;IAE3B,aAAc;QACZ,IAAI,CAAC,YAAY,GAAG,IAAI,qHAAY;QACpC,6CAA6C;QAC7C,IAAI,CAAC,YAAY,CAAC,eAAe,CAAC;IACpC;IAEA,MAAM,YAAY,IAAqB,EAAE,OAAgB,EAAE,SAAoB,EAA0B;QACvG,MAAM,YAAY,CAAC,MAAM,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,EAAE,IAAI,CAAC,cAAc,EAAE;QAChE,MAAM,YAAY,IAAI;QACtB,MAAM,KAAK,KAAK,WAAW;QAE3B,MAAM,eAA6B;YACjC;YACA;YACA,MAAM;YACN,SAAS,WAAW;YACpB;QACF;QAEA,2CAA2C;QAC3C,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,WAAW;QAElC,QAAQ,GAAG,CAAC,CAAC,qDAAqD,CAAC,EAAE;YACnE;YACA;YACA,QAAQ,KAAK,EAAE;YACf,SAAS,UAAU,QAAQ,SAAS,CAAC,GAAG,MAAM;YAC9C;QACF;QAEA,OAAO;YACL;YACA,QAAQ;YACR,UAAU,IAAI,CAAC,QAAQ;YACvB;YACA,MAAM;YACN;YACA,UAAU;gBACR,QAAQ,KAAK,EAAE;gBACf,aAAa;gBACb,eAAe,SAAS,UAAU;gBAClC;YACF;QACF;IACF;IAEA;;GAEC,GACD,UAAU,QAAyC,EAAQ;QACzD,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,WAAW;IAClC;IAEA;;GAEC,GACD,WAAW,QAAyC,EAAQ;QAC1D,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,WAAW;IACnC;IAEA;;GAEC,GACD,mBAA2B;QACzB,OAAO,IAAI,CAAC,YAAY,CAAC,aAAa,CAAC;IACzC;AACF;AAGO,MAAM,uBAAuB,IAAI"}},
    {"offset": {"line": 8441, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/messaging/factory.ts"],"sourcesContent":["/**\n * Messaging Client Factory\n *\n * Provides a centralized way to get the appropriate messaging client\n * based on environment configuration.\n */\n\nimport type { IMessagingClient, MessagingProvider } from './types';\nimport { twilioMessagingClient } from './twilioClient';\nimport { localMessagingClient } from './localClient';\nimport { getMessagingConfig } from '@/shared/config';\n\n/**\n * Get the messaging client based on environment configuration\n * Defaults to Twilio in production, can be overridden with MESSAGING_PROVIDER env var\n */\nexport function getMessagingClient(): IMessagingClient {\n  const { provider } = getMessagingConfig();\n\n  switch (provider) {\n    case 'local':\n      console.log('[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)');\n      return localMessagingClient;\n    case 'twilio':\n    default:\n      return twilioMessagingClient;\n  }\n}\n\n/**\n * Get a specific messaging client by provider name\n * Useful for testing or when you need direct access to a specific provider\n */\nexport function getMessagingClientByProvider(provider: MessagingProvider): IMessagingClient {\n  switch (provider) {\n    case 'local':\n      return localMessagingClient;\n    case 'twilio':\n      return twilioMessagingClient;\n    default:\n      throw new Error(`Unknown messaging provider: ${provider}`);\n  }\n}\n\n// Export the default client as a singleton\nexport const messagingClient = getMessagingClient();\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;AAGD;AACA;AACA;;;;AAMO,SAAS;IACd,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,8LAAkB;IAEvC,OAAQ;QACN,KAAK;YACH,QAAQ,GAAG,CAAC;YACZ,OAAO,wMAAoB;QAC7B,KAAK;QACL;YACE,OAAO,0MAAqB;IAChC;AACF;AAMO,SAAS,6BAA6B,QAA2B;IACtE,OAAQ;QACN,KAAK;YACH,OAAO,wMAAoB;QAC7B,KAAK;YACH,OAAO,0MAAqB;QAC9B;YACE,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,UAAU;IAC7D;AACF;AAGO,MAAM,kBAAkB"}},
    {"offset": {"line": 8486, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/messaging/index.ts"],"sourcesContent":["/**\n * Messaging Module Exports\n *\n * Central export point for all messaging-related types, clients, and utilities.\n */\n\nexport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nexport type { LocalMessage } from './localClient';\n\nexport { TwilioMessagingClient, twilioMessagingClient } from './twilioClient';\nexport { LocalMessagingClient, localMessagingClient } from './localClient';\nexport { getMessagingClient, getMessagingClientByProvider, messagingClient } from './factory';\n"],"names":[],"mappings":"AAAA;;;;CAIC;AAKD;AACA;AACA"}},
    {"offset": {"line": 8501, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/inngest/client.ts"],"sourcesContent":["/**\n * Inngest Client\n *\n * Centralized Inngest client for serverless function orchestration.\n * Used for async message processing, scheduled tasks, and event-driven workflows.\n */\n\nimport { Inngest } from 'inngest';\n\nexport const inngest = new Inngest({\n  id: 'gymtext',\n  name: 'GymText - AI Fitness Coaching'\n});\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;;AAEO,MAAM,UAAU,IAAI,kXAAO,CAAC;IACjC,IAAI;IACJ,MAAM;AACR"}},
    {"offset": {"line": 8520, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/messaging/messagingAgentService.ts"],"sourcesContent":["import { z } from 'zod';\nimport { initializeModel } from '@/server/agents';\nimport type { UserWithProfile } from '@/server/models/user';\nimport type { FitnessPlan } from '@/server/models/fitnessPlan';\nimport type { Message } from '@/server/models/conversation';\nimport type { DayOfWeek } from '@/shared/utils/date';\nimport { DAY_NAMES } from '@/shared/utils/date';\nimport type { MicrocycleGenerationOutput } from '@/server/services/agents/prompts/microcycles';\n\n// Schemas for structured outputs\nconst WeeklyMessageSchema = z.object({\n  feedbackMessage: z.string().describe(\"Message asking for feedback on the past week\")\n});\ntype WeeklyMessage = z.infer<typeof WeeklyMessageSchema>;\n\nconst PlanSummarySchema = z.object({\n  messages: z.array(z.string()).describe(\"Array of SMS messages (each under 160 chars)\")\n});\ntype PlanSummary = z.infer<typeof PlanSummarySchema>;\n\n// Prompts\nconst WEEKLY_MESSAGE_SYSTEM_PROMPT = `You are a fitness coach sending a weekly check-in message via SMS.\n\nYour task is to generate a FEEDBACK MESSAGE asking how their workouts went this past week.\n\nMESSAGE REQUIREMENTS:\n- Warm, conversational greeting using their first name\n- Ask about their training progress this past week\n- Keep it encouraging and supportive\n- If next week is a deload week, acknowledge it positively (recovery is important!)\n- Keep it around 20-40 words total\n- SMS-friendly format\n\nTone:\n- Supportive and motivating\n- Concise (SMS format)\n- Professional but friendly\n- Personal and caring\n\nFormat:\nReturn a JSON object with one field:\n{\n  \"feedbackMessage\": \"...\"\n}`;\n\nconst PLAN_READY_SYSTEM_PROMPT = `\nYou are a fitness coach sending a friendly \"your plan is ready\" message to a new client.\n\nThis is the second message they receive:\n- The first message went out when they signed up.\n- THIS message is sent once their full plan and Week 1 are ready.\n\nYour job is to take:\n1) A short \"Fitness Plan\" summary\n2) A short \"Week 1\" breakdown\nand merge them into ONE medium-length SMS.\n\n-----------------------------------------\nTONE\n-----------------------------------------\n- Friendly, confident, human\n- No jargon\n- Plain-speak, simple phrasing\n- SMS-friendly, concise\n- Supportive but not overly hyped\n\n-----------------------------------------\nCRITICAL LOGIC RULE\n-----------------------------------------\nYou must ONLY show the remaining days of the current week based on the user's signup day.\n\nInput weekday will be one of:\nMon, Tue, Wed, Thu, Fri, Sat, Sun.\n\nShow only today through Sunday. Never show past days.\n\n-----------------------------------------\nDAY LINE FORMAT RULES\n-----------------------------------------\nEvery day line must:\n- Be VERY short\n- Fit on a single phone line with no wrapping\n- Use simple wording\n- Ideal format examples:\n    \"Thu: Push + cardio (2025 min)\"\n    \"Fri: Pull + cardio\"\n    \"Sat: Legs (technique)\"\n    \"Sun: Rest (optional walk)\"\n- NO em dashes  only colons, hyphens, parentheses, commas, plus signs.\n- One simple focus per day.\n\n-----------------------------------------\nSTRUCTURE & SPACING RULES\n-----------------------------------------\nYour final SMS must follow this exact structure WITH BLANK LINES between sections:\n\n1. **Opening paragraph (ONE paragraph)**\n   - Start with a friendly opener confirming the plan is ready.\n   - Immediately continue with a plain-English summary of the full plan.\n   - These MUST form a single paragraph with **no blank lines** inside.\n\n2. **Blank line**\n\n3. **Transition sentence**\n   - Example: \"Here's what the rest of this week looks like:\"\n\n4. **Blank line**\n\n5. **Day-by-day list**\n   - Only remaining days\n   - One day per line\n   - Each line must be short\n\n6. **Blank line**\n\n7. **Short supportive closing line**\n\n-----------------------------------------\nSTRICT RULES\n-----------------------------------------\n- Output ONLY the final composed SMS\n- Must match the spacing described above\n- No jargon or technical terms (no RIR, mesocycle, hypertrophy, etc.)\n- No em dashes\n- No more than 12 emojis total\n- Keep sentences short\n- Paraphrase naturally\n`;\n\nconst UPDATED_MICROCYCLE_SYSTEM_PROMPT = `\nYou are a fitness coach sending a friendly \"your week has been updated\" message to a client.\n\nThis message is sent when the client requests changes to their training week.\n\nYour job is to take:\n1) An explanation of what changed\n2) The updated week breakdown\nand create ONE concise SMS.\n\n-----------------------------------------\nTONE\n-----------------------------------------\n- Friendly, confident, human\n- No jargon\n- Plain-speak, simple phrasing\n- SMS-friendly, concise\n- Supportive and responsive to their request\n\n-----------------------------------------\nCRITICAL LOGIC RULE\n-----------------------------------------\nYou must ONLY show the remaining days of the current week based on the current day.\n\nInput weekday will be one of:\nMon, Tue, Wed, Thu, Fri, Sat, Sun.\n\nShow only today through Sunday. Never show past days.\n\n-----------------------------------------\nDAY LINE FORMAT RULES\n-----------------------------------------\nEvery day line must:\n- Be VERY short\n- Fit on a single phone line with no wrapping\n- Use simple wording\n- NO em dashes  only colons, hyphens, parentheses, commas, plus signs.\n- Keep each day to one simple focus.\n\n-----------------------------------------\nSESSION NAME SIMPLIFICATION\n-----------------------------------------\nTranslate technical terms into plain English:\n- Push  Chest & Shoulders\n- Pull  Back & Arms\n- Upper  Upper Body\n- Lower  Lower Body\n- Legs / Legs & Glutes  Lower Body\n- Active Recovery  Light Movement\n- Rest / Off  Rest Day\n- Deload  Recovery Day\n\nNo jargon terms: hypertrophy, mesocycle, microcycle, RIR, RPE, volume, intensity, etc.\n\n-----------------------------------------\nSTRUCTURE\n-----------------------------------------\nYour final SMS must follow this structure:\n\n1. Friendly acknowledgment of the update\n2. Brief explanation of what changed (12 sentences)\n3. Remaining days breakdown (today through Sunday)\n4. Optional short supportive closing (if space allows)\n\n-----------------------------------------\nSTRICT RULES\n-----------------------------------------\n- Output ONLY the final composed SMS\n- No jargon or technical terms\n- No em dashes\n- No more than 1 emoji total (or none)\n- Keep sentences short\n- Paraphrase the modifications explanation naturally\n- Show ONLY remaining days\n`;\n\n/**\n * MessagingAgentService - Handles all messaging-related AI operations\n *\n * Responsibilities:\n * - Welcome messages for new users\n * - Weekly check-in messages\n * - Plan summary messages\n * - Plan ready (combined plan + microcycle) messages\n * - Updated microcycle messages\n *\n * @example\n * ```typescript\n * const message = await messagingAgentService.generateWelcomeMessage(user);\n * ```\n */\nexport class MessagingAgentService {\n  private static instance: MessagingAgentService;\n\n  private constructor() {}\n\n  public static getInstance(): MessagingAgentService {\n    if (!MessagingAgentService.instance) {\n      MessagingAgentService.instance = new MessagingAgentService();\n    }\n    return MessagingAgentService.instance;\n  }\n\n  /**\n   * Generate a welcome message for a new user\n   * Uses a static template - no LLM needed\n   */\n  async generateWelcomeMessage(user: UserWithProfile): Promise<string> {\n    const firstName = user.name?.split(' ')[0] || 'there';\n\n    return `Hey ${firstName}!\n\nAfter you hit \"Sign Up,\" millions of documents were scannedeach with one goal: to build the best plan for your fitness journey.\n\nThen came the planning stagemillions of AI bots mapping, testing, and re-testing until your plan was dialed in. Working to the studs to perfect the product.\n\nNow, as your first workout sends, the bots cheerthen back to workand we at the GymText family smile as another perfect plan leaves the factory.\n\nWelcome to GymText.\n\nText me anytime with questions about your workouts, your plan, or if you just need a little extra help!`;\n  }\n\n  /**\n   * Generate a weekly check-in message asking for feedback\n   */\n  async generateWeeklyMessage(\n    user: UserWithProfile,\n    isDeload: boolean,\n    absoluteWeek: number\n  ): Promise<string> {\n    const model = initializeModel<WeeklyMessage>(WeeklyMessageSchema);\n    const firstName = user.name.split(' ')[0];\n\n    const userPrompt = `Generate a weekly feedback check-in message for the user.\n\nUser Information:\n- Name: ${user.name}\n- First Name: ${firstName}\n- Week: ${absoluteWeek} of their program\n\n${isDeload ? `IMPORTANT: Next week is a DELOAD week - a planned recovery week with reduced intensity.\nAcknowledge this positively and remind them that recovery is part of the training process.` : 'This is a regular training week.'}\n\nGenerate the feedback message now.`;\n\n    console.log(`[MessagingAgentService] Weekly message user prompt: ${userPrompt}`);\n\n    const prompt = [\n      { role: 'system' as const, content: WEEKLY_MESSAGE_SYSTEM_PROMPT },\n      { role: 'user' as const, content: userPrompt }\n    ];\n\n    const result = await model.invoke(prompt);\n    return result.feedbackMessage;\n  }\n\n  /**\n   * Generate plan summary SMS messages (2-3 messages under 160 chars each)\n   */\n  async generatePlanSummary(\n    user: UserWithProfile,\n    plan: FitnessPlan,\n    previousMessages?: Message[]\n  ): Promise<string[]> {\n    const model = initializeModel<PlanSummary>(PlanSummarySchema);\n\n    const hasContext = previousMessages && previousMessages.length > 0;\n    const contextSection = hasContext\n      ? `\n<Previous Messages>\n${previousMessages.map(msg => `${msg.direction === 'inbound' ? 'User' : 'Coach'}: ${msg.content}`).join('\\n\\n')}\n</Previous Messages>\n\nIMPORTANT: You are continuing a conversation that has already started. DO NOT greet the user by name again. DO NOT introduce yourself again. Just continue naturally with the plan summary.\n`\n      : '';\n\n    const prompt = `\nYou are a motivational fitness coach sending an exciting SMS message about a new fitness plan.\n\n${contextSection}\n\n<Task>\nCreate 2-3 SMS messages (each under 160 characters) that summarize this fitness plan in an exciting, motivational way.\n</Task>\n\n<User>\nName: ${user.name}\n</User>\n\n<Plan Details>\n${plan.description || 'No plan description available.'}\n</Plan Details>\n\n<Guidelines>\n- Keep each message under 160 characters (SMS limit)\n- Be enthusiastic and motivational\n- Focus on what the plan will do for them (outcomes, not just structure)\n- Mention the training split and key focuses from the plan\n- Make them excited to start\n- Use conversational, friendly tone\n- Don't use emojis unless they help save characters\n- Number the messages if multiple (e.g., \"1/3:\", \"2/3:\")\n\n<Output Format>\nReturn a JSON object with an array of messages:\n{\n  \"messages\": [\n    \"Message 1 text here...\",\n    \"Message 2 text here...\",\n    \"Message 3 text here (if needed)...\"\n  ]\n}\n</Output Format>\n\nNow create the motivational SMS messages for ${user.name}'s training program.\n`;\n\n    const result = await model.invoke(prompt);\n    return result.messages;\n  }\n\n  /**\n   * Generate a \"plan ready\" message combining plan summary and week one breakdown\n   */\n  async generatePlanMicrocycleCombinedMessage(\n    fitnessPlan: string,\n    weekOne: string,\n    currentWeekday: DayOfWeek\n  ): Promise<string> {\n    const model = initializeModel(undefined); // Plain text output\n\n    const userPrompt = `\nCreate the \"your plan is ready\" SMS using the inputs below.\nFollow the System Prompt exactly.\n\n[FITNESS PLAN]\n${fitnessPlan}\n\n[WEEK 1]\n${weekOne}\n\n[TODAY]\n${currentWeekday}\n\nOutput ONE medium-length SMS:\n- Confirm the plan is ready\n- Summarize the plan plainly\n- Transition into the week\n- Show ONLY the remaining days, each on one short line\n- NO em dashes\n- Supportive closing line\n`.trim();\n\n    const messages = [\n      { role: 'system', content: PLAN_READY_SYSTEM_PROMPT },\n      { role: 'user', content: userPrompt }\n    ];\n\n    return model.invoke(messages);\n  }\n\n  /**\n   * Generate an \"updated week\" message when a microcycle is modified\n   */\n  async generateUpdatedMicrocycleMessage(\n    modifiedMicrocycle: MicrocycleGenerationOutput,\n    modifications: string,\n    currentWeekday: DayOfWeek\n  ): Promise<string> {\n    const model = initializeModel(undefined); // Plain text output\n\n    // Get day index (Mon=0, Tue=1, etc.)\n    const dayIndex = DAY_NAMES.indexOf(currentWeekday);\n\n    // Get remaining days (today through Sunday)\n    const remainingDays = modifiedMicrocycle.days\n      .slice(dayIndex)\n      .map((dayOverview, idx) => {\n        const actualDayName = DAY_NAMES[dayIndex + idx];\n        return `${actualDayName}:\\n${dayOverview}`;\n      })\n      .join('\\n\\n');\n\n    const userPrompt = `\nCreate an \"updated week\" SMS using the inputs below.\nFollow the System Prompt exactly.\n\n[WHAT CHANGED]\n${modifications}\n\n[UPDATED WEEK OVERVIEW]\n${modifiedMicrocycle.overview}\n\n[IS DELOAD WEEK]\n${modifiedMicrocycle.isDeload}\n\n[REMAINING DAYS]\n${remainingDays}\n\n[TODAY]\n${currentWeekday}\n\nOutput ONE concise SMS:\n- Acknowledge the update\n- Briefly explain what changed (paraphrase naturally)\n- Show ONLY the remaining days, each on one short line\n- NO em dashes\n- Optional supportive closing\n`.trim();\n\n    const messages = [\n      { role: 'system', content: UPDATED_MICROCYCLE_SYSTEM_PROMPT },\n      { role: 'user', content: userPrompt }\n    ];\n\n    return model.invoke(messages);\n  }\n}\n\nexport const messagingAgentService = MessagingAgentService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AAAA;AAKA;;;;AAGA,iCAAiC;AACjC,MAAM,sBAAsB,0MAAC,CAAC,MAAM,CAAC;IACnC,iBAAiB,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AACvC;AAGA,MAAM,oBAAoB,0MAAC,CAAC,MAAM,CAAC;IACjC,UAAU,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,QAAQ,CAAC;AACzC;AAGA,UAAU;AACV,MAAM,+BAA+B,CAAC;;;;;;;;;;;;;;;;;;;;;;CAsBrC,CAAC;AAEF,MAAM,2BAA2B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAkFlC,CAAC;AAED,MAAM,mCAAmC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0E1C,CAAC;AAiBM,MAAM;IACX,OAAe,SAAgC;IAE/C,aAAsB,CAAC;IAEvB,OAAc,cAAqC;QACjD,IAAI,CAAC,sBAAsB,QAAQ,EAAE;YACnC,sBAAsB,QAAQ,GAAG,IAAI;QACvC;QACA,OAAO,sBAAsB,QAAQ;IACvC;IAEA;;;GAGC,GACD,MAAM,uBAAuB,IAAqB,EAAmB;QACnE,MAAM,YAAY,KAAK,IAAI,EAAE,MAAM,IAAI,CAAC,EAAE,IAAI;QAE9C,OAAO,CAAC,IAAI,EAAE,UAAU;;;;;;;;;;uGAU2E,CAAC;IACtG;IAEA;;GAEC,GACD,MAAM,sBACJ,IAAqB,EACrB,QAAiB,EACjB,YAAoB,EACH;QACjB,MAAM,QAAQ,IAAA,4KAAe,EAAgB;QAC7C,MAAM,YAAY,KAAK,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;QAEzC,MAAM,aAAa,CAAC;;;QAGhB,EAAE,KAAK,IAAI,CAAC;cACN,EAAE,UAAU;QAClB,EAAE,aAAa;;AAEvB,EAAE,WAAW,CAAC;0FAC4E,CAAC,GAAG,mCAAmC;;kCAE/F,CAAC;QAE/B,QAAQ,GAAG,CAAC,CAAC,oDAAoD,EAAE,YAAY;QAE/E,MAAM,SAAS;YACb;gBAAE,MAAM;gBAAmB,SAAS;YAA6B;YACjE;gBAAE,MAAM;gBAAiB,SAAS;YAAW;SAC9C;QAED,MAAM,SAAS,MAAM,MAAM,MAAM,CAAC;QAClC,OAAO,OAAO,eAAe;IAC/B;IAEA;;GAEC,GACD,MAAM,oBACJ,IAAqB,EACrB,IAAiB,EACjB,gBAA4B,EACT;QACnB,MAAM,QAAQ,IAAA,4KAAe,EAAc;QAE3C,MAAM,aAAa,oBAAoB,iBAAiB,MAAM,GAAG;QACjE,MAAM,iBAAiB,aACnB,CAAC;;AAET,EAAE,iBAAiB,GAAG,CAAC,CAAA,MAAO,GAAG,IAAI,SAAS,KAAK,YAAY,SAAS,QAAQ,EAAE,EAAE,IAAI,OAAO,EAAE,EAAE,IAAI,CAAC,QAAQ;;;;AAIhH,CAAC,GACO;QAEJ,MAAM,SAAS,CAAC;;;AAGpB,EAAE,eAAe;;;;;;;MAOX,EAAE,KAAK,IAAI,CAAC;;;;AAIlB,EAAE,KAAK,WAAW,IAAI,iCAAiC;;;;;;;;;;;;;;;;;;;;;;;;6CAwBV,EAAE,KAAK,IAAI,CAAC;AACzD,CAAC;QAEG,MAAM,SAAS,MAAM,MAAM,MAAM,CAAC;QAClC,OAAO,OAAO,QAAQ;IACxB;IAEA;;GAEC,GACD,MAAM,sCACJ,WAAmB,EACnB,OAAe,EACf,cAAyB,EACR;QACjB,MAAM,QAAQ,IAAA,4KAAe,EAAC,YAAY,oBAAoB;QAE9D,MAAM,aAAa,CAAC;;;;;AAKxB,EAAE,YAAY;;;AAGd,EAAE,QAAQ;;;AAGV,EAAE,eAAe;;;;;;;;;AASjB,CAAC,CAAC,IAAI;QAEF,MAAM,WAAW;YACf;gBAAE,MAAM;gBAAU,SAAS;YAAyB;YACpD;gBAAE,MAAM;gBAAQ,SAAS;YAAW;SACrC;QAED,OAAO,MAAM,MAAM,CAAC;IACtB;IAEA;;GAEC,GACD,MAAM,iCACJ,kBAA8C,EAC9C,aAAqB,EACrB,cAAyB,EACR;QACjB,MAAM,QAAQ,IAAA,4KAAe,EAAC,YAAY,oBAAoB;QAE9D,qCAAqC;QACrC,MAAM,WAAW,mKAAS,CAAC,OAAO,CAAC;QAEnC,4CAA4C;QAC5C,MAAM,gBAAgB,mBAAmB,IAAI,CAC1C,KAAK,CAAC,UACN,GAAG,CAAC,CAAC,aAAa;YACjB,MAAM,gBAAgB,mKAAS,CAAC,WAAW,IAAI;YAC/C,OAAO,GAAG,cAAc,GAAG,EAAE,aAAa;QAC5C,GACC,IAAI,CAAC;QAER,MAAM,aAAa,CAAC;;;;;AAKxB,EAAE,cAAc;;;AAGhB,EAAE,mBAAmB,QAAQ,CAAC;;;AAG9B,EAAE,mBAAmB,QAAQ,CAAC;;;AAG9B,EAAE,cAAc;;;AAGhB,EAAE,eAAe;;;;;;;;AAQjB,CAAC,CAAC,IAAI;QAEF,MAAM,WAAW;YACf;gBAAE,MAAM;gBAAU,SAAS;YAAiC;YAC5D;gBAAE,MAAM;gBAAQ,SAAS;YAAW;SACrC;QAED,OAAO,MAAM,MAAM,CAAC;IACtB;AACF;AAEO,MAAM,wBAAwB,sBAAsB,WAAW"}},
    {"offset": {"line": 8926, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/messaging/index.ts"],"sourcesContent":["export { MessagingAgentService, messagingAgentService } from './messagingAgentService';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 8933, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/messageRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport type { \n  Message, \n  NewMessage, \n} from '@/server/models/message';\n\nexport class MessageRepository extends BaseRepository {\n  async create(message: NewMessage): Promise<Message> {\n    return await this.db\n      .insertInto('messages')\n      .values(message)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async findById(id: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n  }\n\n  async findByClientId(clientId: string, limit: number = 50, offset: number = 0): Promise<Message[]> {\n    // Return messages in DESC order (latest first) with pagination support\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .offset(offset)\n      .execute();\n  }\n\n  /**\n   * Find recent messages for a client, ordered oldest to newest\n   * This is the primary method for getting message history\n   */\n  async findRecentByClientId(clientId: string, limit: number = 10): Promise<Message[]> {\n    const messages = await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .execute();\n\n    // Reverse to get oldest-to-newest order (for chat context)\n    return messages.reverse();\n  }\n\n  async countByClientId(clientId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('messages')\n      .select(({ fn }) => fn.count('id').as('count'))\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return Number(result?.count ?? 0);\n  }\n\n  async findByProviderMessageId(providerMessageId: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('providerMessageId', '=', providerMessageId)\n      .executeTakeFirst();\n  }\n\n  async updateDeliveryStatus(\n    messageId: string,\n    status: 'queued' | 'sent' | 'delivered' | 'failed' | 'undelivered',\n    error?: string\n  ): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryStatus: status,\n        deliveryError: error || null,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async incrementDeliveryAttempts(messageId: string): Promise<Message> {\n    const message = await this.findById(messageId);\n    if (!message) {\n      throw new Error(`Message ${messageId} not found`);\n    }\n\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryAttempts: (message.deliveryAttempts || 1) + 1,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async updateProviderMessageId(messageId: string, providerMessageId: string): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({ providerMessageId })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find all messages with user info for admin view\n   * Supports filtering by direction, status, and search\n   */\n  async findAllWithUserInfo(params: {\n    limit?: number;\n    offset?: number;\n    direction?: 'inbound' | 'outbound';\n    status?: string;\n    search?: string;\n    clientId?: string;\n  }): Promise<{\n    messages: (Message & { userName: string | null; userPhone: string })[];\n    total: number;\n  }> {\n    let query = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select([\n        'messages.id',\n        'messages.clientId',\n        'messages.conversationId',\n        'messages.direction',\n        'messages.content',\n        'messages.phoneFrom',\n        'messages.phoneTo',\n        'messages.provider',\n        'messages.providerMessageId',\n        'messages.deliveryStatus',\n        'messages.deliveryAttempts',\n        'messages.lastDeliveryAttemptAt',\n        'messages.deliveryError',\n        'messages.metadata',\n        'messages.createdAt',\n        'users.name as userName',\n        'users.phoneNumber as userPhone',\n      ]);\n\n    // Apply filters\n    if (params.clientId) {\n      query = query.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      query = query.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      query = query.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      query = query.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    // Get total count with same filters\n    let countQuery = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select(({ fn }) => fn.count('messages.id').as('count'));\n\n    if (params.clientId) {\n      countQuery = countQuery.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      countQuery = countQuery.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      countQuery = countQuery.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      countQuery = countQuery.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    const countResult = await countQuery.executeTakeFirst();\n    const total = Number(countResult?.count ?? 0);\n\n    // Get paginated results\n    const messages = await query\n      .orderBy('messages.createdAt', 'desc')\n      .limit(params.limit || 50)\n      .offset(params.offset || 0)\n      .execute();\n\n    return {\n      messages: messages as (Message & { userName: string | null; userPhone: string })[],\n      total,\n    };\n  }\n\n  /**\n   * Get message statistics for admin view\n   */\n  async getStats(clientId?: string): Promise<{\n    totalMessages: number;\n    inbound: number;\n    outbound: number;\n    pending: number;\n    failed: number;\n  }> {\n    let baseQuery = this.db.selectFrom('messages');\n\n    if (clientId) {\n      baseQuery = baseQuery.where('clientId', '=', clientId);\n    }\n\n    const [total, inbound, outbound, pending, failed] = await Promise.all([\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'inbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'outbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['queued', 'sent'])\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['failed', 'undelivered'])\n        .executeTakeFirst(),\n    ]);\n\n    return {\n      totalMessages: Number(total?.count ?? 0),\n      inbound: Number(inbound?.count ?? 0),\n      outbound: Number(outbound?.count ?? 0),\n      pending: Number(pending?.count ?? 0),\n      failed: Number(failed?.count ?? 0),\n    };\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 9089, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/messaging/messageService.ts"],"sourcesContent":["import { UserWithProfile } from '../../models/user';\nimport { FitnessPlan } from '../../models/fitnessPlan';\nimport { messagingClient } from '../../connections/messaging';\nimport { inngest } from '../../connections/inngest/client';\nimport { workoutAgentService } from '../agents/training';\nimport { messagingAgentService } from '../agents/messaging';\nimport { WorkoutInstance, EnhancedWorkoutInstance } from '../../models/workout';\nimport { Message } from '../../models/conversation';\nimport { MessageRepository } from '../../repositories/messageRepository';\nimport { postgresDb } from '../../connections/postgres/postgres';\nimport { CircuitBreaker } from '@/server/utils/circuitBreaker';\nimport { Json } from '../../models/_types';\nimport { UserService } from '../user/userService';\nimport { WorkoutInstanceService } from '../training/workoutInstanceService';\nimport { getTwilioSecrets } from '@/server/config';\n\n/**\n * Parameters for storing an inbound message\n */\nexport interface StoreInboundMessageParams {\n  clientId: string;\n  from: string;\n  to: string;\n  content: string;\n  twilioData?: Record<string, unknown>;\n}\n\n/**\n * Parameters for ingesting an inbound message (async path)\n */\nexport interface IngestMessageParams {\n  /** User receiving the message */\n  user: UserWithProfile;\n  /** Message content */\n  content: string;\n  /** Phone number message is from */\n  from: string;\n  /** Phone number message is to */\n  to: string;\n  /** Optional Twilio webhook data */\n  twilioData?: Record<string, unknown>;\n}\n\n/**\n * Result of ingesting an inbound message\n */\nexport interface IngestMessageResult {\n  /** Inngest job ID for tracking (undefined if no async processing needed) */\n  jobId?: string;\n  /** Quick acknowledgment or full answer message */\n  ackMessage: string;\n  /** Action taken: resendWorkout, fullChatAgent, or null */\n  action: 'resendWorkout' | 'fullChatAgent' | null;\n  /** Reasoning for the decision (for debugging) */\n  reasoning: string;\n}\n\n/**\n * Parameters for receiving an inbound message (sync path)\n */\nexport interface ReceiveMessageParams {\n  /** User receiving the message */\n  user: UserWithProfile;\n  /** Message content */\n  content: string;\n  /** Phone number message is from */\n  from: string;\n  /** Phone number message is to */\n  to: string;\n  /** Optional Twilio webhook data */\n  twilioData?: Record<string, unknown>;\n  /** Optional callback to generate a response */\n  responseGenerator?: (\n    user: UserWithProfile,\n    content: string\n  ) => Promise<string>;\n}\n\n/**\n * Result of receiving an inbound message\n */\nexport interface ReceiveMessageResult {\n  /** The generated response (if responseGenerator was provided) */\n  response?: string;\n  /** Whether the inbound message was stored successfully */\n  inboundStored: boolean;\n  /** Whether the outbound response was stored successfully (if response was generated) */\n  outboundStored?: boolean;\n}\n\n/**\n * MessageService\n *\n * Handles message transport, storage, and flow orchestration.\n * Does NOT handle message content generation - that's for agents/generators.\n *\n * Responsibilities:\n * - Send messages via messaging clients (Twilio, local, etc.)\n * - Receive and store inbound messages\n * - Orchestrate message flow (receive  store  respond)\n * - Store outbound messages\n */\nexport class MessageService {\n  private static instance: MessageService;\n  private messageRepo: MessageRepository;\n  private userService: UserService;\n  private workoutInstanceService: WorkoutInstanceService;\n  private circuitBreaker: CircuitBreaker;\n\n  private constructor() {\n    this.messageRepo = new MessageRepository(postgresDb);\n    this.userService = UserService.getInstance();\n    this.workoutInstanceService = WorkoutInstanceService.getInstance();\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeout: 60000, // 1 minute\n      monitoringPeriod: 60000 // 1 minute\n    });\n  }\n\n  public static getInstance(): MessageService {\n    if (!MessageService.instance) {\n      MessageService.instance = new MessageService();\n    }\n    return MessageService.instance;\n  }\n\n  // ==========================================\n  // Message Storage Methods\n  // ==========================================\n\n  /**\n   * Store an inbound message to the database\n   */\n  async storeInboundMessage(params: StoreInboundMessageParams): Promise<Message | null> {\n    return await this.circuitBreaker.execute(async () => {\n      const { clientId, from, to, content, twilioData } = params;\n\n      // Store the message directly (no conversation needed)\n      const message = await this.messageRepo.create({\n        conversationId: null, // No longer using conversations\n        clientId: clientId,\n        direction: 'inbound',\n        content,\n        phoneFrom: from,\n        phoneTo: to,\n        provider: 'twilio', // Inbound messages always come from Twilio webhook\n        providerMessageId: (twilioData?.MessageSid as string) || null,\n        metadata: (twilioData || {}) as Json\n      });\n\n      return message;\n    });\n  }\n\n  /**\n   * Store an outbound message to the database\n   */\n  async storeOutboundMessage(\n    clientId: string,\n    to: string,\n    messageContent: string,\n    from: string = getTwilioSecrets().phoneNumber,\n    provider: 'twilio' | 'local' | 'websocket' = 'twilio',\n    providerMessageId?: string,\n    metadata?: Record<string, unknown>\n  ): Promise<Message | null> {\n    // TODO: Implement periodic message summarization\n    return await this.circuitBreaker.execute(async () => {\n\n      const user = await this.userService.getUser(clientId);\n      if (!user) {\n        return null;\n      }\n\n      // Store the message with initial delivery tracking\n      const message = await this.messageRepo.create({\n        conversationId: null, // No longer using conversations\n        clientId: clientId,\n        direction: 'outbound',\n        content: messageContent,\n        phoneFrom: from,\n        phoneTo: to,\n        provider,\n        providerMessageId: providerMessageId || null,\n        metadata: (metadata || {}) as Json,\n        deliveryStatus: 'queued',\n        deliveryAttempts: 1,\n        lastDeliveryAttemptAt: new Date(),\n      });\n\n      // Optionally summarize messages periodically (implementation TBD)\n      // For now, we'll skip summarization on every message to improve performance\n      // const messages = await this.getRecentMessages(clientId, 50);\n      // const summary = await this.summarizeMessages(user, messages);\n      // Store summary somewhere (TBD - maybe in a separate summaries table)\n\n      return message;\n    });\n  }\n\n  /**\n   * Get messages for a client with pagination support\n   */\n  async getMessages(clientId: string, limit: number = 50, offset: number = 0): Promise<Message[]> {\n    return await this.messageRepo.findByClientId(clientId, limit, offset);\n  }\n\n  /**\n   * Get recent messages for a client\n   *\n   * Convenience method for retrieving the most recent messages for a client.\n   * Useful for passing conversation context to agents.\n   *\n   * @param clientId - The client ID\n   * @param limit - Maximum number of recent messages to return (default: 10)\n   * @returns Array of recent messages, ordered oldest to newest\n   *\n   * @example\n   * ```typescript\n   * // Get last 10 messages for context\n   * const previousMessages = await messageService.getRecentMessages(clientId);\n   * const response = await chatAgent(user, message, previousMessages);\n   * ```\n   */\n  async getRecentMessages(clientId: string, limit: number = 10): Promise<Message[]> {\n    // Get recent messages directly by clientId\n    return await this.messageRepo.findRecentByClientId(clientId, limit);\n  }\n\n  /**\n   * Split messages into pending (to be processed) and context (conversation history).\n   *\n   * Pure function - no DB calls. Used to separate messages that need responses\n   * from messages that serve as conversation context.\n   *\n   * @param messages - Array of messages ordered oldest to newest\n   * @param contextMinutes - Time window in minutes for context messages\n   * @returns Object with pending (ALL inbound after last outbound) and context (messages within time window up to last outbound)\n   */\n  splitMessages(messages: Message[], contextMinutes: number): { pending: Message[]; context: Message[] } {\n    // Calculate time threshold for context messages\n    const cutoffTime = new Date(Date.now() - contextMinutes * 60 * 1000);\n\n    // Find index of last outbound message\n    let lastOutboundIndex = -1;\n    for (let i = messages.length - 1; i >= 0; i--) {\n      if (messages[i].direction === 'outbound') {\n        lastOutboundIndex = i;\n        break;\n      }\n    }\n\n    // Pending: ALL inbound messages after last outbound (no time limit - always include unresponded messages)\n    const pending = lastOutboundIndex >= 0\n      ? messages.slice(lastOutboundIndex + 1)\n      : messages.filter(m => m.direction === 'inbound');\n\n    // Context: Messages up to last outbound, filtered by time window\n    const allContext = lastOutboundIndex >= 0 ? messages.slice(0, lastOutboundIndex + 1) : [];\n    const context = allContext.filter(m => new Date(m.createdAt) >= cutoffTime);\n\n    return { pending, context };\n  }\n\n  /**\n   * Get pending (unanswered) inbound messages for a client\n   *\n   * Retrieves the tail of inbound messages that have occurred since the last outbound message.\n   * Used for batch processing in the debounced chat flow.\n   *\n   * @param clientId - The client ID\n   * @returns Array of pending inbound messages, ordered oldest to newest\n   */\n  async getPendingMessages(clientId: string): Promise<Message[]> {\n    // Get a reasonable batch of recent messages (e.g., last 20)\n    // We assume the user hasn't sent more than 20 messages without a reply\n    const recentMessages = await this.getRecentMessages(clientId, 20);\n\n    const pendingMessages: Message[] = [];\n    \n    // Iterate backwards from the most recent message\n    for (let i = recentMessages.length - 1; i >= 0; i--) {\n      const message = recentMessages[i];\n      \n      // If we hit an outbound message, stop - we've found the break point\n      if (message.direction === 'outbound') {\n        break;\n      }\n      \n      // Collect inbound messages\n      if (message.direction === 'inbound') {\n        pendingMessages.unshift(message); // Add to front to maintain time order\n      }\n    }\n    \n    return pendingMessages;\n  }\n\n\n  // ==========================================\n  // Message Transport & Orchestration Methods\n  // ==========================================\n\n  /**\n   * Ingest an inbound message (async path)\n   *\n   * Fast path for webhook acknowledgment:\n   * 1. Store inbound message\n   * 2. Queue processing job via Inngest\n   * 3. Return success\n   *\n   * @returns IngestMessageResult with optional jobId\n   */\n  public async ingestMessage(params: IngestMessageParams): Promise<IngestMessageResult> {\n    const { user, content, from, to, twilioData } = params;\n\n    // Store the inbound message\n    const storedMessage = await this.storeInboundMessage({\n      clientId: user.id,\n      from,\n      to,\n      content,\n      twilioData\n    });\n\n    if (!storedMessage) {\n      throw new Error('Failed to store inbound message');\n    }\n\n    // Always queue the message processing job via Inngest\n    // The Inngest function handles debouncing and batch processing\n    const { ids } = await inngest.send({\n      name: 'message/received',\n      data: {\n        userId: user.id,\n        content,\n        from,\n        to,\n      },\n    });\n    const jobId = ids[0];\n\n    console.log('[MessageService] Message stored and queued:', {\n      userId: user.id,\n      messageId: storedMessage.id,\n      jobId,\n    });\n\n    // Return simple acknowledgment\n    return {\n      jobId,\n      ackMessage: '', // No immediate reply\n      action: 'fullChatAgent', // Always full agent now\n      reasoning: 'Queued for processing',\n    };\n  }\n\n  /**\n   * Send a message to a user\n   * Stores the message and sends it via the configured messaging client\n   * @param user - User to send message to\n   * @param message - Optional message content (can be undefined for MMS-only messages)\n   * @param mediaUrls - Optional array of media URLs for MMS (images, videos, etc.)\n   * @returns The stored Message object\n   */\n  public async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<Message> {\n    // Get the provider from the messaging client\n    const provider = messagingClient.provider;\n\n    let stored: Message | null = null;\n    try {\n        stored = await this.storeOutboundMessage(\n            user.id,\n            user.phoneNumber,\n            message || '[MMS only]', // Store placeholder for MMS-only messages\n            undefined, // from (uses default)\n            provider, // messaging provider\n            undefined,  // providerMessageId (not available yet)\n            mediaUrls ? { mediaUrls } : undefined // store media URLs in metadata\n        );\n        if (!stored) {\n            console.warn('Circuit breaker prevented storing outbound message');\n        }\n        } catch (error) {\n            // Log error but don't block SMS processing\n            console.error('Failed to store outbound message:', error);\n        }\n\n    if (!stored) {\n      throw new Error('Failed to store message');\n    }\n\n    // Send via messaging client and get the result\n    const result = await messagingClient.sendMessage(user, message, mediaUrls);\n\n    // Update the stored message with provider message ID from the send result\n    if (result.messageId) {\n      try {\n        const messageRepo = new MessageRepository(postgresDb);\n        await messageRepo.updateProviderMessageId(stored.id, result.messageId);\n        console.log('[MessageService] Updated message with provider ID:', {\n          messageId: stored.id,\n          providerMessageId: result.messageId,\n        });\n      } catch (error) {\n        console.error('[MessageService] Failed to update provider message ID:', error);\n        // Don't throw - message was sent successfully\n      }\n    }\n\n    // Simulate delivery for local messages (for queue processing)\n    if (provider === 'local') {\n      // Fire-and-forget delivery simulation (non-blocking)\n      this.simulateLocalDelivery(stored.id).catch(error => {\n        console.error('[MessageService] Local delivery simulation failed:', error);\n      });\n    }\n\n    return stored;\n  }\n\n  /**\n   * Simulate message delivery for local development\n   *\n   * Called when using the local messaging client to simulate the Twilio\n   * webhook callback that normally triggers queue processing.\n   *\n   * @param messageId - ID of the message to mark as delivered\n   */\n  private async simulateLocalDelivery(messageId: string): Promise<void> {\n    const delay = 1500; // 1.5 seconds to simulate realistic SMS timing\n    console.log(`[MessageService] Simulating local delivery in ${delay}ms for message ${messageId}`);\n\n    await new Promise(resolve => setTimeout(resolve, delay));\n\n    // Update message delivery status in database\n    await this.messageRepo.updateDeliveryStatus(messageId, 'delivered');\n\n    // Trigger queue processing (simulates Twilio webhook calling queue service)\n    const { messageQueueService } = await import('./messageQueueService');\n    await messageQueueService.markMessageDelivered(messageId);\n\n    console.log(`[MessageService] Local delivery simulation complete for message ${messageId}`);\n  }\n\n  /**\n   * Send welcome message to a user\n   * Uses messagingAgentService and sends the generated message\n   * @returns The stored Message object\n   */\n  public async sendWelcomeMessage(user: UserWithProfile): Promise<Message> {\n    const welcomeMessage = await messagingAgentService.generateWelcomeMessage(user);\n    return await this.sendMessage(user, welcomeMessage);\n  }\n\n  /**\n   * Send fitness plan summary messages to a user\n   * Uses messagingAgentService and sends the generated messages\n   * @param user - The user to send to\n   * @param plan - The fitness plan to summarize\n   * @param previousMessages - Optional previous messages for context\n   * @returns Array of stored Message objects\n   */\n  public async sendPlanSummary(\n    user: UserWithProfile,\n    plan: FitnessPlan,\n    previousMessages?: Message[]\n  ): Promise<Message[]> {\n    const generatedMessages = await messagingAgentService.generatePlanSummary(user, plan, previousMessages);\n\n    // Send each message in sequence\n    const sentMessages: Message[] = [];\n    for (const message of generatedMessages) {\n      const storedMessage = await this.sendMessage(user, message);\n      sentMessages.push(storedMessage);\n      // Small delay between messages to ensure proper ordering\n      if (generatedMessages.length > 1) {\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n    }\n\n    if (sentMessages.length === 0) {\n      throw new Error('No messages were sent');\n    }\n\n    return sentMessages;\n  }\n\n  /**\n   * Send workout message to a user\n   * Generates SMS from workout data and sends it\n   * @param user - The user to send to\n   * @param workout - The workout instance (should have pre-generated message or description/reasoning)\n   * @returns The stored Message object\n   */\n  public async sendWorkoutMessage(\n    user: UserWithProfile,\n    workout: WorkoutInstance | EnhancedWorkoutInstance\n  ): Promise<Message> {\n    let message: string;\n    const workoutId = 'id' in workout ? workout.id : 'unknown';\n\n    // Fast path: Use pre-generated message if available\n    if ('message' in workout && workout.message) {\n      console.log(`[MessageService] Using pre-generated message from workout ${workoutId}`);\n      message = workout.message;\n      return await this.sendMessage(user, message);\n    }\n\n    // Fallback: Generate from description/reasoning (shouldn't happen in production)\n    if ('description' in workout && 'reasoning' in workout && workout.description && workout.reasoning) {\n      console.log(`[MessageService] Generating fallback message for workout ${workoutId}`);\n\n      try {\n        // Get message agent from workout agent service\n        const messageAgent = await workoutAgentService.getMessageAgent();\n\n        // Invoke with workout description string\n        const result = await messageAgent.invoke(workout.description);\n        message = result.response;\n\n        // Save generated message for future use\n        if ('id' in workout && workout.id) {\n          await this.workoutInstanceService.updateWorkoutMessage(workout.id, message);\n          console.log(`[MessageService] Saved fallback message to workout ${workout.id}`);\n        }\n\n        return await this.sendMessage(user, message);\n      } catch (error) {\n        console.error(`[MessageService] Failed to generate fallback message for workout ${workoutId}:`, error);\n        throw new Error('Failed to generate workout message');\n      }\n    }\n\n    // Should never reach here in production\n    throw new Error(`Workout ${workoutId} missing required fields (description/reasoning or message) for SMS generation`);\n  }\n}\n\n// Export singleton instance\nexport const messageService = MessageService.getInstance();"],"names":[],"mappings":"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"}},
    {"offset": {"line": 9473, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/prompts/profile.ts"],"sourcesContent":["import type { UserWithProfile } from '@/server/models/user';\n\n// =============================================================================\n// Profile Update Agent Prompts\n// =============================================================================\n\nexport const PROFILE_UPDATE_SYSTEM_PROMPT = `\nYou are the Profile Manager for GymText. Your goal is to maintain a \"Living Dossier\" of the user's fitness context.\n\n# CRITICAL: TRANSIENT vs PERMANENT\n\n**ONLY record PERMANENT information about the user.** Do NOT record one-time requests or transient modifications.\n\n## How to Distinguish:\n\n**PERMANENT (DO record):**\n- Uses words like: \"I like\", \"I prefer\", \"I always\", \"I want to\", \"from now on\", \"generally\", \"usually\"\n- Expresses ongoing preferences: \"I like to start my week with legs\"\n- States facts about themselves: \"I have a home gym\", \"I hate lunges\"\n- Describes their schedule/availability: \"I can only train mornings\"\n\n**TRANSIENT (DO NOT record):**\n- Uses words like: \"today\", \"this time\", \"right now\", \"can we\", \"let's\", \"switch to\"\n- One-time modification requests: \"switch today to chest\", \"can I do legs instead\"\n- Temporary situations already handled by modifications: \"didn't workout yesterday\"\n- Questions or conversation: \"what's my workout?\", \"thanks\"\n\n## Examples:\n\n| Message | Action |\n|---------|--------|\n| \"I like to start my week with legs\" | RECORD as Scheduling Preference |\n| \"switch today to chest\" | DO NOT record - transient request |\n| \"I prefer barbell over dumbbell\" | RECORD as Exercise Preference |\n| \"can I do upper body instead\" | DO NOT record - one-time swap |\n| \"Add runs on Tuesdays and Thursdays to my plan\" | RECORD as Scheduling Preference |\n| \"I hurt my knee\" | RECORD as Constraint |\n| \"didn't workout yesterday\" | DO NOT record - context for modification |\n| \"I go to Planet Fitness\" | RECORD as Equipment/Location |\n\n**When in doubt, DO NOT record.** Only record information that will be relevant for future workout generation.\n\n# CORE OPERATING RULES\n1. **Fact-Based Recording:** Only record what is explicitly stated as a permanent fact or preference.\n2. **Flexible Structure:** Use bullet points under the broad \"Bucket\" headings below.\n3. **Omit Empty Sections:** Only include sections that have actual content. If there is no information for a section, omit the section header entirely.\n4. **Date Management:**\n   - Reference \"Current Date\" in CONTEXT.\n   - Convert relative dates to absolute (YYYY-MM-DD).\n   - Prune expired [ACTIVE] tags.\n\n# PROFILE SECTIONS (THE BUCKETS)\n\n## 1. # IDENTITY\n- Name, Age, Gender.\n- Experience Level (only if explicitly stated).\n\n## 2. # OBJECTIVES\n- A simple list of user's stated goals.\n- *Examples:* \"- Lose 10lbs\", \"- Bench press 225lbs\".\n\n## 3. # PREFERENCES (PERMANENT ONLY)\nUser's ongoing preferences that inform future workout generation.\n**Only record if the user expresses this as a general preference, NOT a one-time request.**\n\n### Scheduling Preferences\nHow the user prefers to structure their training week GOING FORWARD.\n- \"I like to start my week with legs\" -> Record\n- \"I prefer morning workouts\" -> Record\n- \"Add runs on Tuesdays and Thursdays\" -> Record (permanent schedule change)\n- \"switch today to chest\" -> DO NOT record (one-time)\n- \"can I do legs instead\" -> DO NOT record (one-time)\n\n### Exercise Preferences\nSpecific exercise likes/dislikes that apply to ALL future workouts.\n- \"I prefer barbell over dumbbell\" -> Record\n- \"I hate lunges\" -> Record\n- \"I love deadlifts\" -> Record\n- \"give me something other than squats today\" -> DO NOT record (one-time)\n\n### Workout Style Preferences\nHow the user likes their workouts structured IN GENERAL.\n- \"I like supersets\" -> Record\n- \"I prefer high intensity\" -> Record\n- \"make today's workout shorter\" -> DO NOT record (one-time)\n\n## 4. # LOGISTICS & ENVIRONMENT\n\n### Availability\n- Days per week, time constraints, session duration.\n- *Examples:* \"6 days per week\", \"M/W/F mornings\", \"45 min max\".\n\n### Equipment Access\n**Gym Type:** (e.g., Commercial gym, Home gym, Planet Fitness, Hotel gym)\n**Available Equipment:** List specific equipment mentioned.\n- *Examples:* \"Full rack\", \"Dumbbells up to 50lbs\", \"Cable machine\"\n**Equipment Limitations:** What they DON'T have.\n- *Examples:* \"No barbell\", \"Dumbbells only\"\n\n### Location\n- Where they typically train.\n- *Examples:* \"Home\", \"Equinox\", \"LA Fitness\".\n\n## 5. # SCHEDULE COMMITMENTS (CRITICAL DISTINCTION)\nYou MUST distinguish between a \"Fixed Anchor\" and a \"Habit\".\n- **Fixed Anchors:** Specific classes, sports practice, or external obligations the user MUST attend.\n  - *Example:* \"Tuesday 7pm Yoga Class\" -> **Fixed Anchor**.\n  - *Example:* \"Rugby Practice\" -> **Fixed Anchor**.\n- **Historical Habits:** If a user says \"I currently run 3x a week,\" record this as a **Habit**, NOT a Fixed Anchor.\n  - *Example:* \"Usually runs 3x a week\" -> **Current Habit**.\n\n## 6. # CONSTRAINTS\n- **Permanent:** Injuries or long-term physical limitations.\n- **Temporary:** Travel, sickness, or temporary lack of equipment.\n  - MUST use format: \\`* **[ACTIVE] Description (Effective: YYYY-MM-DD to YYYY-MM-DD)**\\`\n\n## 7. # PROGRESS & RECORDS\n- **Personal Records (PRs):** Max lifts, fastest times, benchmarks.\n  - *Format:* \\`- [YYYY-MM-DD] Exercise: Weight/Time (Notes)\\`\n- **Milestones:** Significant achievements or consistency streaks.\n  - *Format:* \\`- [YYYY-MM-DD] Achievement Description\\`\n\n# OUTPUT FORMAT\nReturn a valid JSON object:\n{\n  \"updatedProfile\": \"string (The complete Markdown document)\",\n  \"wasUpdated\": boolean,\n  \"updateSummary\": \"string (Brief summary of changes made, or empty string if none)\"\n}\n\n**CRITICAL:**\n- The \"updatedProfile\" field must contain ONLY the profile Markdown document itself.\n- Start directly with \"# IDENTITY\"\n- Do NOT include any input context.\n- Set wasUpdated to FALSE if the message only contains transient requests with no permanent profile info.\n`;\n\nexport function buildProfileUpdateUserMessage(\n  currentProfile: string,\n  message: string,\n  user: UserWithProfile,\n  currentDate: string\n): string {\n  return `## CONTEXT\n\n**Current Date**: ${currentDate}\n**User Timezone**: ${user.timezone}\n**User Name**: ${user.name}\n**User Age**: ${user.age || 'Unknown'}\n**User Gender**: ${user.gender || 'Unknown'}\n\n---\n\n## CURRENT PROFILE\n\n${currentProfile || '_No profile exists yet. Create initial profile based on the message._'}\n\n---\n\n## USER'S MESSAGE\n\n${message}\n\n---\n\n## YOUR TASK\n\n1. Review the current profile.\n2. **FIRST: Determine if this message contains PERMANENT profile information.**\n   - If it's only a transient request (like \"switch today to X\", \"can I do Y instead\"), return wasUpdated: false.\n   - Look for keywords: \"today\", \"this time\", \"can we\", \"let's\" = TRANSIENT (don't record)\n   - Look for keywords: \"I like\", \"I prefer\", \"I always\", \"from now on\" = PERMANENT (do record)\n3. Check for [ACTIVE] constraints that have expired and remove them.\n4. Extract any PERMANENT preferences (scheduling, exercise, workout style).\n5. Update EQUIPMENT details if the user mentions gym type, specific equipment, or limitations.\n6. Update other sections based on the message. **Carefully distinguish between \"Fixed Anchors\" (Classes/Sports) and \"Current Habits\" (General routine).**\n7. Return the COMPLETE updated profile (or unchanged if wasUpdated: false).\n`;\n}\n\n// =============================================================================\n// User Fields Agent Prompts\n// =============================================================================\n\n/**\n * System prompt for the User Fields Agent\n *\n * Instructs the agent to extract user preference updates from messages.\n * Focuses on three fields: timezone, preferred send time, and name.\n */\nexport const USER_FIELDS_SYSTEM_PROMPT = `You are a user preference extraction agent. Your job is to detect when a user wants to update their account settings based on their message.\n\nYou extract THREE types of settings changes:\n\n## 1. TIMEZONE CHANGES\nDetect when the user mentions wanting to change their timezone or location.\n\nLook for:\n- Location mentions: \"I'm in California\", \"I moved to New York\", \"I live on the east coast\"\n- Timezone mentions: \"my timezone is PST\", \"I'm on eastern time\", \"change my timezone to central\"\n- City/region mentions: \"I'm in Chicago\", \"Seattle time\", \"mountain time\"\n\nOutput the matching IANA timezone from this list (or null if no change requested):\n\n**Americas:**\n- America/New_York (Eastern US: New York, Boston, Miami, Atlanta, DC)\n- America/Chicago (Central US: Chicago, Dallas, Houston)\n- America/Denver (Mountain US: Denver, Phoenix, Utah)\n- America/Los_Angeles (Pacific US: LA, San Francisco, Seattle, Portland)\n- America/Toronto (Eastern Canada)\n- America/Vancouver (Pacific Canada)\n- America/Mexico_City (Mexico)\n- America/Sao_Paulo (Brazil)\n\n**Europe:**\n- Europe/London (UK)\n- Europe/Paris (France)\n- Europe/Berlin (Germany)\n- Europe/Madrid (Spain)\n- Europe/Rome (Italy)\n- Europe/Amsterdam (Netherlands)\n- Europe/Stockholm (Sweden)\n- Europe/Moscow (Russia)\n\n**Asia Pacific:**\n- Asia/Tokyo (Japan)\n- Asia/Shanghai (China)\n- Asia/Hong_Kong\n- Asia/Singapore\n- Asia/Seoul (Korea)\n- Asia/Mumbai (India)\n- Asia/Dubai (UAE)\n- Australia/Sydney\n- Australia/Melbourne\n- Pacific/Auckland (New Zealand)\n\nMap common references:\n- \"East coast\" / \"Eastern\" / \"EST\" / \"EDT\"  America/New_York\n- \"Central\" / \"CST\" / \"CDT\"  America/Chicago\n- \"Mountain\" / \"MST\" / \"MDT\"  America/Denver\n- \"West coast\" / \"Pacific\" / \"PST\" / \"PDT\"  America/Los_Angeles\n\n## 2. PREFERRED SEND TIME CHANGES\nDetect when the user wants to change when they receive their daily messages.\n\nInterpret natural language intelligently:\n- \"morning\"  8\n- \"early morning\" / \"before work\"  6\n- \"afternoon\"  14\n- \"evening\" / \"after work\" / \"end of day\"  18\n- \"night\" / \"late\"  20\n- \"noon\" / \"lunch\" / \"midday\"  12\n- Explicit times: \"8am\"  8, \"6pm\"  18, \"7:30am\"  7, \"5:00 PM\"  17\n\nOnly extract if the user is clearly asking to CHANGE their send time, not just mentioning a time casually.\nExamples that ARE changes: \"send my workouts in the morning\", \"can I get messages at 6pm instead\", \"change my send time to evening\"\nExamples that are NOT changes: \"I worked out this morning\", \"I'll be busy at 6pm\"\n\n## 3. NAME CHANGES\nDetect when the user wants to be called something different.\n\nLook for:\n- \"call me X\"\n- \"my name is X\"\n- \"I go by X\"\n- \"you can call me X\"\n- \"I prefer X\"\n\nOnly extract the NEW name they want, not their current name being referenced.\n\n## IMPORTANT RULES\n\n1. Only extract fields the user is ACTIVELY REQUESTING to change\n2. Return null for any field not mentioned or not being changed\n3. Set hasUpdates to true only if at least one field is non-null\n4. Be conservative - when in doubt, return null\n5. The updateSummary should briefly describe what was detected (empty string if nothing)\n\n## OUTPUT FORMAT\n\nReturn JSON with:\n- timezone: string | null (IANA timezone from the list above, e.g., \"America/New_York\")\n- preferredSendHour: number | null (0-23)\n- name: string | null\n- hasUpdates: boolean\n- updateSummary: string`;\n\n/**\n * Build the user message for the User Fields Agent\n *\n * Provides context about the user's current settings and the message to analyze.\n */\nexport function buildUserFieldsUserMessage(\n  message: string,\n  user: UserWithProfile,\n  currentDate: string\n): string {\n  return `## CURRENT USER SETTINGS\n- Name: ${user.name || 'Not set'}\n- Timezone: ${user.timezone}\n- Preferred Send Hour: ${user.preferredSendHour} (${formatHourForDisplay(user.preferredSendHour)})\n- Current Date: ${currentDate}\n\n## USER MESSAGE\n${message}\n\n## TASK\nAnalyze the message above. Extract any requested changes to timezone, send time, or name.\nReturn null for fields not being changed.`;\n}\n\n/**\n * Format hour for display (e.g., 8  \"8:00 AM\", 18  \"6:00 PM\")\n */\nfunction formatHourForDisplay(hour: number): string {\n  const period = hour >= 12 ? 'PM' : 'AM';\n  const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;\n  return `${displayHour}:00 ${period}`;\n}\n\n// =============================================================================\n// Structured Profile Agent Prompts\n// =============================================================================\n\n/**\n * System prompt for the Structured Profile Agent\n *\n * Instructs the agent to extract structured data from a Markdown fitness profile.\n */\nexport const STRUCTURED_PROFILE_SYSTEM_PROMPT = `You are a profile parser for a fitness coaching app. Your job is to extract structured data from a Markdown fitness profile document.\n\n# INPUT\nYou will receive a Markdown \"Living Dossier\" profile document. This document contains sections like IDENTITY, OBJECTIVES, PREFERENCES, LOGISTICS & ENVIRONMENT, CONSTRAINTS, etc.\n\n# OUTPUT\nExtract the following fields into structured JSON:\n\n## 1. goals (string[])\nExtract all fitness goals from the OBJECTIVES section and any other goal-related mentions.\n- Examples: \"Lose 10lbs\", \"Bench 225lbs\", \"Run a marathon\", \"Build muscle\"\n- Keep them as concise statements\n\n## 2. experienceLevel (\"beginner\" | \"intermediate\" | \"advanced\" | null)\nLook for explicit mentions of experience level in IDENTITY or elsewhere.\n- Only set this if explicitly stated (e.g., \"Experience Level: Intermediate\")\n- Return null if not explicitly mentioned\n\n## 3. preferences (string[])\nExtract ALL preferences including:\n- **Exercise preferences**: \"Prefers barbell over dumbbell\", \"Hates lunges\", \"Loves deadlifts\"\n- **Scheduling preferences**: \"Likes to start week with legs\", \"Prefers morning workouts\"\n- **Workout style preferences**: \"Likes supersets\", \"Prefers high intensity\"\n- Keep each preference as a clear, concise statement\n\n## 4. injuries (string[])\nExtract PERMANENT physical limitations from the CONSTRAINTS section.\n- Only include injuries marked as permanent or chronic\n- Examples: \"Bad lower back\", \"Chronic shoulder impingement\", \"Knee arthritis\"\n- Do NOT include temporary injuries here\n\n## 5. constraints (array of objects)\nExtract TEMPORARY constraints with optional date bounds.\nEach constraint has:\n- value: Description of the constraint\n- start: ISO date (YYYY-MM-DD) when it started, or null if unknown\n- end: ISO date (YYYY-MM-DD) when it ends, or null if ongoing\n\nLook for [ACTIVE] tags which contain dates in format: [ACTIVE] Description (Effective: YYYY-MM-DD to YYYY-MM-DD)\n- Examples:\n  - \"[ACTIVE] Travel (Effective: 2024-01-15 to 2024-01-22)\"  { value: \"Travel\", start: \"2024-01-15\", end: \"2024-01-22\" }\n  - \"[ACTIVE] Recovering from flu\"  { value: \"Recovering from flu\", start: null, end: null }\n\n## 6. equipmentAccess (string[])\nExtract equipment and gym access information:\n- Gym type: \"Commercial gym\", \"Home gym\", \"Planet Fitness\"\n- Available equipment: \"Full rack\", \"Dumbbells up to 50lbs\", \"Cable machine\"\n- Equipment limitations: \"No barbell\", \"Dumbbells only\"\n- Location: \"Works out at LA Fitness\"\n\n# RULES\n1. Extract ONLY what is explicitly stated in the profile\n2. Return empty arrays [] for sections with no data\n3. For experienceLevel, return null unless explicitly stated\n4. Keep values concise and normalized\n5. Parse [ACTIVE] tags carefully for date extraction\n6. Ignore expired constraints (where end date has passed based on current date)\n\n# EXAMPLES\n\nInput profile:\n\\`\\`\\`\n# IDENTITY\n- Name: John\n- Age: 30\n- Experience Level: Intermediate\n\n# OBJECTIVES\n- Lose 15lbs\n- Bench 225lbs\n\n# PREFERENCES\n### Exercise Preferences\n- I prefer barbell over dumbbell\n- I hate lunges\n\n### Workout Style Preferences\n- I like supersets\n\n# LOGISTICS & ENVIRONMENT\n### Equipment Access\n**Gym Type:** Commercial gym (LA Fitness)\n**Available Equipment:** Full rack, Cable machine, Dumbbells\n\n# CONSTRAINTS\n**Permanent:**\n- Bad lower back\n\n**Temporary:**\n* **[ACTIVE] Shoulder strain (Effective: 2024-01-10 to 2024-02-10)**\n\\`\\`\\`\n\nOutput:\n{\n  \"goals\": [\"Lose 15lbs\", \"Bench 225lbs\"],\n  \"experienceLevel\": \"intermediate\",\n  \"preferences\": [\"Prefers barbell over dumbbell\", \"Hates lunges\", \"Likes supersets\"],\n  \"injuries\": [\"Bad lower back\"],\n  \"constraints\": [{ \"value\": \"Shoulder strain\", \"start\": \"2024-01-10\", \"end\": \"2024-02-10\" }],\n  \"equipmentAccess\": [\"Commercial gym\", \"LA Fitness\", \"Full rack\", \"Cable machine\", \"Dumbbells\"]\n}`;\n\n/**\n * Build the user message for the Structured Profile Agent\n */\nexport function buildStructuredProfileUserMessage(\n  dossierText: string,\n  currentDate: string\n): string {\n  return `## CURRENT DATE\n${currentDate}\n\n## PROFILE TO PARSE\n\n${dossierText || '_No profile content - return empty arrays for all fields_'}\n\n## YOUR TASK\nParse this profile into the structured format. Extract all relevant information following the rules above.`;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAMO,MAAM,+BAA+B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiI7C,CAAC;AAEM,SAAS,8BACd,cAAsB,EACtB,OAAe,EACf,IAAqB,EACrB,WAAmB;IAEnB,OAAO,CAAC;;kBAEQ,EAAE,YAAY;mBACb,EAAE,KAAK,QAAQ,CAAC;eACpB,EAAE,KAAK,IAAI,CAAC;cACb,EAAE,KAAK,GAAG,IAAI,UAAU;iBACrB,EAAE,KAAK,MAAM,IAAI,UAAU;;;;;;AAM5C,EAAE,kBAAkB,wEAAwE;;;;;;AAM5F,EAAE,QAAQ;;;;;;;;;;;;;;;;AAgBV,CAAC;AACD;AAYO,MAAM,4BAA4B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;uBA+FnB,CAAC;AAOjB,SAAS,2BACd,OAAe,EACf,IAAqB,EACrB,WAAmB;IAEnB,OAAO,CAAC;QACF,EAAE,KAAK,IAAI,IAAI,UAAU;YACrB,EAAE,KAAK,QAAQ,CAAC;uBACL,EAAE,KAAK,iBAAiB,CAAC,EAAE,EAAE,qBAAqB,KAAK,iBAAiB,EAAE;gBACjF,EAAE,YAAY;;;AAG9B,EAAE,QAAQ;;;;yCAI+B,CAAC;AAC1C;AAEA;;CAEC,GACD,SAAS,qBAAqB,IAAY;IACxC,MAAM,SAAS,QAAQ,KAAK,OAAO;IACnC,MAAM,cAAc,SAAS,IAAI,KAAK,OAAO,KAAK,OAAO,KAAK;IAC9D,OAAO,GAAG,YAAY,IAAI,EAAE,QAAQ;AACtC;AAWO,MAAM,mCAAmC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAoGhD,CAAC;AAKK,SAAS,kCACd,WAAmB,EACnB,WAAmB;IAEnB,OAAO,CAAC;AACV,EAAE,YAAY;;;;AAId,EAAE,eAAe,4DAA4D;;;0GAG6B,CAAC;AAC3G"}},
    {"offset": {"line": 9887, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/utils/timezone.ts"],"sourcesContent":["/**\n * Client-side timezone utilities\n * These are safe to use in React components\n */\n\n// Common IANA timezones for UI selection\nexport const COMMON_TIMEZONES = [\n  // Americas\n  'America/New_York',\n  'America/Chicago',\n  'America/Denver',\n  'America/Los_Angeles',\n  'America/Toronto',\n  'America/Vancouver',\n  'America/Mexico_City',\n  'America/Sao_Paulo',\n  \n  // Europe\n  'Europe/London',\n  'Europe/Paris',\n  'Europe/Berlin',\n  'Europe/Madrid',\n  'Europe/Rome',\n  'Europe/Amsterdam',\n  'Europe/Stockholm',\n  'Europe/Moscow',\n  \n  // Asia Pacific\n  'Asia/Tokyo',\n  'Asia/Shanghai',\n  'Asia/Hong_Kong',\n  'Asia/Singapore',\n  'Asia/Seoul',\n  'Asia/Mumbai',\n  'Asia/Dubai',\n  'Australia/Sydney',\n  'Australia/Melbourne',\n  'Pacific/Auckland',\n] as const;\n\nexport type CommonTimezone = typeof COMMON_TIMEZONES[number];\n\n// Helper to format timezone for display\nexport function formatTimezoneForDisplay(timezone: string): string {\n  // Convert America/New_York to \"New York (America)\"\n  const parts = timezone.split('/');\n  if (parts.length === 2) {\n    const city = parts[1].replace(/_/g, ' ');\n    return `${city} (${parts[0]})`;\n  }\n  return timezone;\n}\n\n/**\n * Validate if a timezone string is a valid IANA timezone identifier\n * \n * @param timezone - Timezone string to validate\n * @returns true if valid IANA timezone, false otherwise\n */\nexport function isValidTimezone(timezone: string | null | undefined): boolean {\n  if (!timezone || typeof timezone !== 'string') {\n    return false;\n  }\n  \n  // First check if it's in our common timezones list\n  if (COMMON_TIMEZONES.includes(timezone as CommonTimezone)) {\n    return true;\n  }\n  \n  // Then try to validate using Intl.DateTimeFormat\n  try {\n    new Intl.DateTimeFormat('en-US', { timeZone: timezone });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get timezone suggestions based on partial input\n * \n * @param input - Partial timezone or location input\n * @returns Array of suggested timezones with display names\n */\nexport function getTimezoneSuggestions(input: string): Array<{ timezone: string; display: string }> {\n  if (!input || input.length < 2) {\n    // Return most common US timezones\n    return [\n      { timezone: 'America/New_York', display: 'New York (Eastern Time)' },\n      { timezone: 'America/Chicago', display: 'Chicago (Central Time)' },\n      { timezone: 'America/Denver', display: 'Denver (Mountain Time)' },\n      { timezone: 'America/Los_Angeles', display: 'Los Angeles (Pacific Time)' },\n    ];\n  }\n  \n  const cleaned = input.toLowerCase().trim();\n  const suggestions: Array<{ timezone: string; display: string }> = [];\n  \n  // Filter common timezones that match the input\n  for (const timezone of COMMON_TIMEZONES) {\n    const display = formatTimezoneForDisplay(timezone);\n    const city = timezone.split('/')[1]?.replace(/_/g, ' ').toLowerCase() || '';\n    const region = timezone.split('/')[0]?.toLowerCase() || '';\n    \n    if (\n      timezone.toLowerCase().includes(cleaned) ||\n      display.toLowerCase().includes(cleaned) ||\n      city.includes(cleaned) ||\n      region.includes(cleaned)\n    ) {\n      suggestions.push({ timezone, display });\n    }\n  }\n  \n  return suggestions.slice(0, 5); // Limit to top 5 suggestions\n}"],"names":[],"mappings":"AAAA;;;CAGC,GAED,yCAAyC;;;;;;;;;;;AAClC,MAAM,mBAAmB;IAC9B,WAAW;IACX;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,SAAS;IACT;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAEA,eAAe;IACf;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,SAAS,yBAAyB,QAAgB;IACvD,mDAAmD;IACnD,MAAM,QAAQ,SAAS,KAAK,CAAC;IAC7B,IAAI,MAAM,MAAM,KAAK,GAAG;QACtB,MAAM,OAAO,KAAK,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM;QACpC,OAAO,GAAG,KAAK,EAAE,EAAE,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC;IAChC;IACA,OAAO;AACT;AAQO,SAAS,gBAAgB,QAAmC;IACjE,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC7C,OAAO;IACT;IAEA,mDAAmD;IACnD,IAAI,iBAAiB,QAAQ,CAAC,WAA6B;QACzD,OAAO;IACT;IAEA,iDAAiD;IACjD,IAAI;QACF,IAAI,KAAK,cAAc,CAAC,SAAS;YAAE,UAAU;QAAS;QACtD,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAQO,SAAS,uBAAuB,KAAa;IAClD,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG;QAC9B,kCAAkC;QAClC,OAAO;YACL;gBAAE,UAAU;gBAAoB,SAAS;YAA0B;YACnE;gBAAE,UAAU;gBAAmB,SAAS;YAAyB;YACjE;gBAAE,UAAU;gBAAkB,SAAS;YAAyB;YAChE;gBAAE,UAAU;gBAAuB,SAAS;YAA6B;SAC1E;IACH;IAEA,MAAM,UAAU,MAAM,WAAW,GAAG,IAAI;IACxC,MAAM,cAA4D,EAAE;IAEpE,+CAA+C;IAC/C,KAAK,MAAM,YAAY,iBAAkB;QACvC,MAAM,UAAU,yBAAyB;QACzC,MAAM,OAAO,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,QAAQ,MAAM,KAAK,iBAAiB;QACzE,MAAM,SAAS,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,iBAAiB;QAExD,IACE,SAAS,WAAW,GAAG,QAAQ,CAAC,YAChC,QAAQ,WAAW,GAAG,QAAQ,CAAC,YAC/B,KAAK,QAAQ,CAAC,YACd,OAAO,QAAQ,CAAC,UAChB;YACA,YAAY,IAAI,CAAC;gBAAE;gBAAU;YAAQ;QACvC;IACF;IAEA,OAAO,YAAY,KAAK,CAAC,GAAG,IAAI,6BAA6B;AAC/D"}},
    {"offset": {"line": 10001, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/schemas/profile.ts"],"sourcesContent":["import { z } from 'zod';\nimport { COMMON_TIMEZONES } from '@/shared/utils/timezone';\n\n/**\n * Agent-Specific Profile Schemas\n *\n * These schemas are for agent output formats only.\n * Domain types (StructuredProfile, etc.) have been moved to @/server/models/profile\n */\n\n// =============================================================================\n// Profile Update Agent Schema\n// =============================================================================\n\n/**\n * Zod schema for Profile Update Agent output\n */\nexport const ProfileUpdateOutputSchema = z.object({\n  updatedProfile: z.string().describe('The complete updated Markdown profile document'),\n  wasUpdated: z.boolean().describe('Whether any changes were made to the profile'),\n  updateSummary: z.string().describe('Brief summary of changes made. Empty string if nothing was updated.'),\n});\n\nexport type ProfileUpdateSchemaOutput = z.infer<typeof ProfileUpdateOutputSchema>;\n\n// =============================================================================\n// User Fields Agent Schema\n// =============================================================================\n\n/**\n * Zod schema for User Fields Agent output\n *\n * Used with LLM structured output to ensure consistent response format.\n * Fields are nullable - agent returns null when not mentioned in message.\n */\nexport const UserFieldsOutputSchema = z.object({\n  /**\n   * IANA timezone from constrained enum\n   * LLM picks from valid options based on user's location/timezone mention\n   * Returns null if no timezone change was requested\n   */\n  timezone: z.enum(COMMON_TIMEZONES).nullable(),\n\n  /**\n   * Inferred preferred send hour (0-23 in 24-hour format)\n   * The agent interprets natural language time expressions:\n   * - \"morning\"  8\n   * - \"early morning\"  6\n   * - \"afternoon\"  14\n   * - \"evening\" / \"after work\"  18\n   * - \"night\"  20\n   * - \"noon\" / \"lunch\"  12\n   * - Explicit times: \"8am\"  8, \"6pm\"  18\n   * Returns null if no send time change was requested\n   */\n  preferredSendHour: z.number().int().min(0).max(23).nullable(),\n\n  /**\n   * New name if user wants to change it\n   * Detected from phrases like \"call me X\", \"my name is X\", \"I go by X\"\n   * Returns null if no name change was requested\n   */\n  name: z.string().nullable(),\n\n  /**\n   * Whether any field updates were detected in the message\n   * True if at least one of timezone, preferredSendHour, or name is non-null\n   */\n  hasUpdates: z.boolean(),\n\n  /**\n   * Brief summary of what was detected\n   * Examples:\n   * - \"User wants to change timezone to east coast\"\n   * - \"User wants messages at 6pm and to be called Mike\"\n   * - \"\" (empty string if no updates)\n   */\n  updateSummary: z.string(),\n});\n\nexport type UserFieldsOutputSchemaType = z.infer<typeof UserFieldsOutputSchema>;\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAgBO,MAAM,4BAA4B,0MAAC,CAAC,MAAM,CAAC;IAChD,gBAAgB,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IACpC,YAAY,0MAAC,CAAC,OAAO,GAAG,QAAQ,CAAC;IACjC,eAAe,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;AACrC;AAcO,MAAM,yBAAyB,0MAAC,CAAC,MAAM,CAAC;IAC7C;;;;GAIC,GACD,UAAU,0MAAC,CAAC,IAAI,CAAC,8KAAgB,EAAE,QAAQ;IAE3C;;;;;;;;;;;GAWC,GACD,mBAAmB,0MAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,QAAQ;IAE3D;;;;GAIC,GACD,MAAM,0MAAC,CAAC,MAAM,GAAG,QAAQ;IAEzB;;;GAGC,GACD,YAAY,0MAAC,CAAC,OAAO;IAErB;;;;;;GAMC,GACD,eAAe,0MAAC,CAAC,MAAM;AACzB"}},
    {"offset": {"line": 10056, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/profile/schema.ts"],"sourcesContent":["import { z } from 'zod';\n\n/**\n * Structured Profile Schemas\n *\n * These schemas define the structured profile format extracted from the\n * Markdown dossier. Used for:\n * - LLM-extracted profile data\n * - Storing structured profile in profiles.structured JSONB column\n * - Type-safe access in repositories\n *\n * Note: This is different from FitnessProfile in user/schemas.ts which\n * is the full detailed user profile model.\n */\n\n/**\n * Constraint with optional temporal bounds\n * Represents temporary constraints like travel, injuries with recovery time, etc.\n *\n * Named StructuredConstraint to differentiate from the more detailed\n * Constraint type in user/schemas.ts\n */\nexport const StructuredConstraintSchema = z.object({\n  value: z.string().describe('Description of the constraint (injury, travel, temporary limitation, etc.)'),\n  start: z.string().nullable().describe('ISO date string when constraint started, or null if permanent/unknown'),\n  end: z.string().nullable().describe('ISO date string when constraint ends, or null if ongoing/permanent'),\n});\n\n/**\n * Experience level enum\n */\nexport const ExperienceLevelSchema = z.enum(['beginner', 'intermediate', 'advanced']);\n\n/**\n * Main structured profile schema\n * A simplified, flat representation of the user's fitness profile\n * extracted from the Markdown dossier\n */\nexport const StructuredProfileSchema = z.object({\n  /** User's fitness goals extracted from profile */\n  goals: z.array(z.string()).describe(\"User's stated fitness goals\"),\n\n  /** User's experience level if stated */\n  experienceLevel: ExperienceLevelSchema.nullable().describe(\"User's experience level (beginner, intermediate, advanced) or null if not stated\"),\n\n  /** Exercise, scheduling, and workout style preferences */\n  preferences: z.array(z.string()).describe('Preferences including exercise likes/dislikes, scheduling preferences, and workout style preferences'),\n\n  /** Permanent physical limitations or injuries */\n  injuries: z.array(z.string()).describe('Permanent physical limitations or chronic injuries'),\n\n  /** Temporary constraints with optional date bounds */\n  constraints: z.array(StructuredConstraintSchema).describe('Temporary constraints with optional start/end dates (travel, temporary injuries, etc.)'),\n\n  /** Available equipment and gym access info */\n  equipmentAccess: z.array(z.string()).describe('Equipment access including gym type, available equipment, and limitations'),\n});\n\n// Inferred types\nexport type StructuredProfile = z.infer<typeof StructuredProfileSchema>;\nexport type StructuredConstraint = z.infer<typeof StructuredConstraintSchema>;\nexport type ExperienceLevel = z.infer<typeof ExperienceLevelSchema>;\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AAsBO,MAAM,6BAA6B,0MAAC,CAAC,MAAM,CAAC;IACjD,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC3B,OAAO,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;IACtC,KAAK,0MAAC,CAAC,MAAM,GAAG,QAAQ,GAAG,QAAQ,CAAC;AACtC;AAKO,MAAM,wBAAwB,0MAAC,CAAC,IAAI,CAAC;IAAC;IAAY;IAAgB;CAAW;AAO7E,MAAM,0BAA0B,0MAAC,CAAC,MAAM,CAAC;IAC9C,gDAAgD,GAChD,OAAO,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,QAAQ,CAAC;IAEpC,sCAAsC,GACtC,iBAAiB,sBAAsB,QAAQ,GAAG,QAAQ,CAAC;IAE3D,wDAAwD,GACxD,aAAa,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,QAAQ,CAAC;IAE1C,+CAA+C,GAC/C,UAAU,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,QAAQ,CAAC;IAEvC,oDAAoD,GACpD,aAAa,0MAAC,CAAC,KAAK,CAAC,4BAA4B,QAAQ,CAAC;IAE1D,4CAA4C,GAC5C,iBAAiB,0MAAC,CAAC,KAAK,CAAC,0MAAC,CAAC,MAAM,IAAI,QAAQ,CAAC;AAChD"}},
    {"offset": {"line": 10089, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/shared/types/profile/index.ts"],"sourcesContent":["export * from './schema';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 10096, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/models/profile.ts"],"sourcesContent":["/**\n * Profile Model\n *\n * Re-exports structured profile schemas and types from shared/types.\n */\n\n// Re-export from shared types\nexport * from '@/shared/types/profile';\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,8BAA8B;;AAC9B"}},
    {"offset": {"line": 10108, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/profile/jsonToMarkdown.ts"],"sourcesContent":["/**\n * Markdown Profile Utilities\n *\n * Provides utilities for creating Markdown \"Living Dossier\" format profiles.\n */\n\nimport type { User } from '@/server/models/user';\n\n/**\n * Create a default/empty Markdown profile\n * Used when creating a new user with no profile data\n */\nexport function createEmptyProfile(user?: Partial<User>): string {\n  const sections: string[] = [];\n\n  // Minimal IDENTITY section\n  const identityLines: string[] = ['# IDENTITY'];\n  if (user?.name) {\n    identityLines.push(`**Name:** ${user.name}`);\n  }\n  if (user?.age) {\n    identityLines.push(`**Age:** ${user.age}`);\n  }\n  sections.push(identityLines.join('\\n'));\n\n  return sections.join('\\n\\n');\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAQM,SAAS,mBAAmB,IAAoB;IACrD,MAAM,WAAqB,EAAE;IAE7B,2BAA2B;IAC3B,MAAM,gBAA0B;QAAC;KAAa;IAC9C,IAAI,MAAM,MAAM;QACd,cAAc,IAAI,CAAC,CAAC,UAAU,EAAE,KAAK,IAAI,EAAE;IAC7C;IACA,IAAI,MAAM,KAAK;QACb,cAAc,IAAI,CAAC,CAAC,SAAS,EAAE,KAAK,GAAG,EAAE;IAC3C;IACA,SAAS,IAAI,CAAC,cAAc,IAAI,CAAC;IAEjC,OAAO,SAAS,IAAI,CAAC;AACvB"}},
    {"offset": {"line": 10135, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/user/signupDataFormatter.ts"],"sourcesContent":["import type { SignupData } from '@/server/repositories/onboardingRepository';\n\n/**\n * SignupDataFormatter\n *\n * Service for formatting raw signup form data into LLM-friendly text strings.\n * This logic was moved from the frontend to centralize data formatting on the backend.\n *\n * Responsibilities:\n * - Convert structured form data into natural language descriptions\n * - Provide consistent formatting for LLM consumption\n * - Make it easy to modify formatting without touching frontend\n */\n\n/**\n * Format raw signup data into LLM-friendly text strings\n *\n * Takes structured form data and converts it into natural language\n * descriptions suitable for fitness profile extraction.\n */\nexport function formatSignupDataForLLM(data: SignupData): {\n  fitnessGoals: string;\n  currentExercise: string; // Keeping key name for compatibility, but content is changed\n  environment: string;\n  injuries?: string;\n} {\n  // 1. Fitness Goals\n  const goalsList = `My goals are: ${(data.primaryGoals || [])\n    .map(getGoalDescription)\n    .join(', ')}`;\n  const fitnessGoals = data.goalsElaboration?.trim()\n    ? `${goalsList}. Additional details: ${data.goalsElaboration.trim()}`\n    : goalsList;\n\n  // 2. Desired Availability & Experience\n  const desiredFrequency = data.desiredDaysPerWeek\n    ? getDaysPerWeekDescription(data.desiredDaysPerWeek)\n    : '';\n  const experienceLevel = data.experienceLevel\n    ? `Experience level: ${data.experienceLevel.charAt(0).toUpperCase() + data.experienceLevel.slice(1)}`\n    : '';\n\n  // Frame as desired availability - what the user WANTS, not what they currently do\n  const availabilityText = `***Desired Availability***:\n  ${experienceLevel}. ${desiredFrequency}.\n  Additional Details: ${data.availabilityElaboration?.trim() || 'None provided.'}`;\n\n  const currentExercise = availabilityText; \n\n  // 3. Environment\n  const locationText = data.trainingLocation\n    ? `Training location: ${getLocationDescription(data.trainingLocation)}`\n    : '';\n  const equipmentText =\n    data.equipment && data.equipment.length > 0\n      ? `Available equipment: ${data.equipment.map(e => getEquipmentDescription(e)).join(', ')}`\n      : 'No specific equipment';\n  \n  const environment = `***Environment & Constraints***:\n  ${locationText}. ${equipmentText}`;\n\n  return {\n    fitnessGoals,\n    currentExercise,\n    environment,\n    injuries: data.injuries,\n  };\n}\n// Helper functions for converting enum values to descriptions\n\nfunction getGoalDescription(goal: string): string {\n  const goalMap: Record<string, string> = {\n    strength: 'Build strength and muscle',\n    endurance: 'Improve endurance and stamina',\n    weight_loss: 'Lose weight and improve body composition',\n    general_fitness: 'Improve overall fitness and health',\n  };\n  return goalMap[goal] || goal;\n}\n\nfunction getDaysPerWeekDescription(daysPerWeek: string): string {\n  const daysMap: Record<string, string> = {\n    '3_per_week': 'Wants to train 3 days per week',\n    '4_per_week': 'Wants to train 4 days per week',\n    '5_per_week': 'Wants to train 5 days per week',\n    '6_per_week': 'Wants to train 6 days per week',\n  };\n  return daysMap[daysPerWeek] || daysPerWeek;\n}\n\nfunction getLocationDescription(location: string): string {\n  const locationMap: Record<string, string> = {\n    home: 'Home gym',\n    commercial_gym: 'Commercial gym',\n    bodyweight: 'Bodyweight/minimal equipment',\n  };\n  return locationMap[location] || location;\n}\n\nfunction getEquipmentDescription(equipment: string): string {\n  const equipmentMap: Record<string, string> = {\n    dumbbells: 'Dumbbells',\n    barbell: 'Barbell',\n    resistance_bands: 'Resistance bands',\n    pull_up_bar: 'Pull-up bar',\n    cardio_equipment: 'Cardio equipment',\n    full_gym: 'Full gym access',\n  };\n  return equipmentMap[equipment] || equipment;\n}\n"],"names":[],"mappings":";;;;AAoBO,SAAS,uBAAuB,IAAgB;IAMrD,mBAAmB;IACnB,MAAM,YAAY,CAAC,cAAc,EAAE,CAAC,KAAK,YAAY,IAAI,EAAE,EACxD,GAAG,CAAC,oBACJ,IAAI,CAAC,OAAO;IACf,MAAM,eAAe,KAAK,gBAAgB,EAAE,SACxC,GAAG,UAAU,sBAAsB,EAAE,KAAK,gBAAgB,CAAC,IAAI,IAAI,GACnE;IAEJ,uCAAuC;IACvC,MAAM,mBAAmB,KAAK,kBAAkB,GAC5C,0BAA0B,KAAK,kBAAkB,IACjD;IACJ,MAAM,kBAAkB,KAAK,eAAe,GACxC,CAAC,kBAAkB,EAAE,KAAK,eAAe,CAAC,MAAM,CAAC,GAAG,WAAW,KAAK,KAAK,eAAe,CAAC,KAAK,CAAC,IAAI,GACnG;IAEJ,kFAAkF;IAClF,MAAM,mBAAmB,CAAC;EAC1B,EAAE,gBAAgB,EAAE,EAAE,iBAAiB;sBACnB,EAAE,KAAK,uBAAuB,EAAE,UAAU,kBAAkB;IAEhF,MAAM,kBAAkB;IAExB,iBAAiB;IACjB,MAAM,eAAe,KAAK,gBAAgB,GACtC,CAAC,mBAAmB,EAAE,uBAAuB,KAAK,gBAAgB,GAAG,GACrE;IACJ,MAAM,gBACJ,KAAK,SAAS,IAAI,KAAK,SAAS,CAAC,MAAM,GAAG,IACtC,CAAC,qBAAqB,EAAE,KAAK,SAAS,CAAC,GAAG,CAAC,CAAA,IAAK,wBAAwB,IAAI,IAAI,CAAC,OAAO,GACxF;IAEN,MAAM,cAAc,CAAC;EACrB,EAAE,aAAa,EAAE,EAAE,eAAe;IAElC,OAAO;QACL;QACA;QACA;QACA,UAAU,KAAK,QAAQ;IACzB;AACF;AACA,8DAA8D;AAE9D,SAAS,mBAAmB,IAAY;IACtC,MAAM,UAAkC;QACtC,UAAU;QACV,WAAW;QACX,aAAa;QACb,iBAAiB;IACnB;IACA,OAAO,OAAO,CAAC,KAAK,IAAI;AAC1B;AAEA,SAAS,0BAA0B,WAAmB;IACpD,MAAM,UAAkC;QACtC,cAAc;QACd,cAAc;QACd,cAAc;QACd,cAAc;IAChB;IACA,OAAO,OAAO,CAAC,YAAY,IAAI;AACjC;AAEA,SAAS,uBAAuB,QAAgB;IAC9C,MAAM,cAAsC;QAC1C,MAAM;QACN,gBAAgB;QAChB,YAAY;IACd;IACA,OAAO,WAAW,CAAC,SAAS,IAAI;AAClC;AAEA,SAAS,wBAAwB,SAAiB;IAChD,MAAM,eAAuC;QAC3C,WAAW;QACX,SAAS;QACT,kBAAkB;QAClB,aAAa;QACb,kBAAkB;QAClB,UAAU;IACZ;IACA,OAAO,YAAY,CAAC,UAAU,IAAI;AACpC"}},
    {"offset": {"line": 10205, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/user/fitnessProfileService.ts"],"sourcesContent":["/**\n * FitnessProfileService - Markdown-based Profile Management\n *\n * This service manages Markdown \"Living Dossier\" profiles with full history tracking.\n *\n * Key features:\n * - Uses ProfileRepository for Markdown profile storage\n * - Single Profile Update Agent for AI-powered profile creation\n * - Each update creates a new profile row (history tracking)\n * - Profiles stored as Markdown text\n * - Circuit breaker pattern for resilience\n */\n\nimport { UserWithProfile } from '@/server/models/user';\nimport { ProfileRepository } from '@/server/repositories/profileRepository';\nimport { CircuitBreaker } from '@/server/utils/circuitBreaker';\nimport { createAgent, PROMPT_IDS } from '@/server/agents';\nimport {\n  buildProfileUpdateUserMessage,\n  buildStructuredProfileUserMessage,\n} from '@/server/services/agents/prompts/profile';\nimport { ProfileUpdateOutputSchema } from '@/server/services/agents/schemas/profile';\nimport { StructuredProfileSchema, type StructuredProfile } from '@/server/models/profile';\nimport type { StructuredProfileOutput, StructuredProfileInput } from '@/server/services/agents/types/profile';\nimport { createEmptyProfile } from '@/server/utils/profile/jsonToMarkdown';\nimport { formatSignupDataForLLM } from './signupDataFormatter';\nimport type { SignupData } from '@/server/repositories/onboardingRepository';\nimport { formatForAI } from '@/shared/utils/date';\n\n/**\n * Result returned when patching/updating a profile\n */\nexport interface ProfileUpdateResult {\n  /** Updated Markdown profile text */\n  profile: string;\n  /** Whether the profile was actually updated */\n  wasUpdated: boolean;\n  /** Summary of changes made. Empty string if nothing was updated. */\n  updateSummary: string;\n}\n\nexport class FitnessProfileService {\n  private static instance: FitnessProfileService;\n  private circuitBreaker: CircuitBreaker;\n  private profileRepository: ProfileRepository;\n\n  private constructor() {\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeout: 60000, // 1 minute\n      monitoringPeriod: 60000, // 1 minute\n    });\n    this.profileRepository = new ProfileRepository();\n  }\n\n  public static getInstance(): FitnessProfileService {\n    if (!FitnessProfileService.instance) {\n      FitnessProfileService.instance = new FitnessProfileService();\n    }\n    return FitnessProfileService.instance;\n  }\n\n  /**\n   * Get the current Markdown profile for a user\n   *\n   * @param userId - UUID of the user\n   * @returns Markdown profile text or null if no profile exists\n   */\n  async getCurrentProfile(userId: string): Promise<string | null> {\n    return await this.profileRepository.getCurrentProfileText(userId);\n  }\n\n  /**\n   * Save updated profile\n   * Creates new row in profiles table for history tracking\n   *\n   * @param userId - UUID of the user\n   * @param profile - Complete profile text\n   */\n  async saveProfile(userId: string, profile: string): Promise<void> {\n    try {\n      await this.profileRepository.createProfileForUser(userId, profile);\n      console.log(`[FitnessProfileService] Saved profile for user ${userId}`);\n    } catch (error) {\n      console.error(`[FitnessProfileService] Error saving profile for user ${userId}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create initial fitness profile from signup data\n   * Converts signup data to Markdown format and stores it\n   *\n   * @param user - User to create profile for\n   * @param signupData - Onboarding signup data\n   * @returns Markdown profile text\n   */\n  async createFitnessProfile(user: UserWithProfile, signupData: SignupData): Promise<string | null> {\n    return this.circuitBreaker.execute<string | null>(async (): Promise<string | null> => {\n      try {\n        // Format signup data for agent processing\n        const formattedData = formatSignupDataForLLM(signupData);\n\n        // Build message from signup data\n        const messageParts: string[] = [];\n\n        if (formattedData.fitnessGoals?.trim()) {\n          messageParts.push(`***Goals***:\\n${formattedData.fitnessGoals.trim()}`);\n        }\n\n        if (formattedData.currentExercise?.trim()) {\n          messageParts.push(`***Current Activity***:\\n${formattedData.currentExercise.trim()}`);\n        }\n\n        if (formattedData.environment?.trim()) {\n          messageParts.push(`***Training Environment***:\\n${formattedData.environment.trim()}`);\n        }\n\n        if (formattedData.injuries?.trim()) {\n          messageParts.push(`***Injuries or Limitations***:\\n${formattedData.injuries.trim()}`);\n        }\n\n        const message = messageParts.join('\\n\\n');\n\n        // Start with empty profile\n        const currentProfile = createEmptyProfile(user);\n\n        // Use Profile Update Agent to build initial profile from signup data\n        const currentDate = formatForAI(new Date(), user.timezone);\n\n        // Helper function for structured profile extraction\n        // System prompt fetched from DB based on agent name\n        const invokeStructuredProfileAgent = async (input: StructuredProfileInput | string): Promise<StructuredProfileOutput> => {\n          const parsedInput: StructuredProfileInput = typeof input === 'string' ? JSON.parse(input) : input;\n          const userPrompt = buildStructuredProfileUserMessage(parsedInput.dossierText, parsedInput.currentDate);\n          const agent = await createAgent({\n            name: PROMPT_IDS.PROFILE_STRUCTURED,\n            schema: StructuredProfileSchema,\n          }, { model: 'gpt-5-nano', temperature: 0.3 });\n\n          const agentResult = await agent.invoke(userPrompt);\n          return { structured: agentResult.response, success: true };\n        };\n\n        // Create profile update agent inline with subAgents for structured extraction\n        // Prompts fetched from DB based on agent name\n        const userPrompt = buildProfileUpdateUserMessage(currentProfile, message, user, currentDate);\n        const agent = await createAgent({\n          name: PROMPT_IDS.PROFILE_FITNESS,\n          schema: ProfileUpdateOutputSchema,\n          subAgents: [{\n            structured: {\n              agent: { name: PROMPT_IDS.PROFILE_STRUCTURED, invoke: invokeStructuredProfileAgent },\n              condition: (agentResult: unknown) => (agentResult as { wasUpdated: boolean }).wasUpdated,\n              transform: (agentResult: unknown) => JSON.stringify({\n                dossierText: (agentResult as { updatedProfile: string }).updatedProfile,\n                currentDate,\n              }),\n            },\n          }],\n        }, { model: 'gpt-5.1' });\n\n        const agentResult = await agent.invoke(userPrompt);\n        const structuredResult = (agentResult as { structured?: StructuredProfileOutput }).structured;\n        const structured = structuredResult?.success ? structuredResult.structured : null;\n\n        const result = {\n          updatedProfile: agentResult.response.updatedProfile,\n          wasUpdated: agentResult.response.wasUpdated,\n          updateSummary: agentResult.response.updateSummary || '',\n          structured,\n        };\n\n        console.log('[FitnessProfileService] Created initial profile:', {\n          wasUpdated: result.wasUpdated,\n          summary: result.updateSummary,\n          hasStructured: result.structured !== null,\n        });\n\n        // Store profile with structured data\n        await this.profileRepository.createProfileWithStructured(\n          user.id,\n          result.updatedProfile,\n          result.structured\n        );\n\n        return result.updatedProfile;\n      } catch (error) {\n        console.error('[FitnessProfileService] Error creating profile:', error);\n        throw error;\n      }\n    });\n  }\n\n  /**\n   * Get profile update history for a user\n   *\n   * @param userId - UUID of the user\n   * @param limit - Number of historical profiles to retrieve\n   * @returns Array of profile snapshots with timestamps\n   */\n  async getProfileHistory(userId: string, limit: number = 10) {\n    return await this.profileRepository.getProfileHistory(userId, limit);\n  }\n\n  // ============================================\n  // Structured Profile Methods\n  // ============================================\n\n  /**\n   * Save updated profile with structured data\n   * Creates new row in profiles table for history tracking\n   *\n   * @param userId - UUID of the user\n   * @param profile - Complete profile text (Markdown)\n   * @param structured - Structured profile data (or null)\n   */\n  async saveProfileWithStructured(\n    userId: string,\n    profile: string,\n    structured: StructuredProfile | null\n  ): Promise<void> {\n    try {\n      await this.profileRepository.createProfileWithStructured(userId, profile, structured);\n      console.log(`[FitnessProfileService] Saved profile with structured data for user ${userId}`);\n    } catch (error) {\n      console.error(`[FitnessProfileService] Error saving profile for user ${userId}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get current structured profile data\n   *\n   * @param userId - UUID of the user\n   * @returns Structured profile data or null if not available\n   */\n  async getCurrentStructuredProfile(userId: string): Promise<StructuredProfile | null> {\n    return await this.profileRepository.getCurrentStructuredProfile(userId);\n  }\n}\n\n// Export singleton instance\nexport const fitnessProfileService = FitnessProfileService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 10422, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/flows/conversationFlowBuilder.ts"],"sourcesContent":["import { Message } from '@/server/models/conversation';\n\n/**\n * ConversationFlowBuilder\n *\n * Lightweight utility for building natural message flows with context awareness.\n * Used for ephemeral orchestration of multi-message sequences (not persisted to DB).\n *\n * ## Purpose\n *\n * Track messages BEING SENT within a single orchestrated flow to provide context\n * to subsequent agents. This prevents repetitive greetings and creates natural\n * conversational flows.\n *\n * ## When to Use\n *\n * **Use ConversationFlowBuilder when:**\n * - Orchestrating multiple messages in a single flow (e.g., onboarding)\n * - Each message in the sequence needs context from previous messages in THAT flow\n * - You want agents to avoid repeating greetings/names\n *\n * **DO NOT use ConversationFlowBuilder when:**\n * - Responding to a single user message (use ConversationService.getRecentMessages())\n * - Retrieving historical conversation data (use ConversationService)\n * - Persisting messages to database (use ConversationService)\n *\n * ## Architecture Pattern\n *\n * **ConversationService** = Persistent storage (Database)\n * - Store/retrieve messages from DB\n * - Get conversation history\n * - Source of truth for past conversations\n * - Example: `conversationService.getRecentMessages(userId, 10)`\n *\n * **ConversationFlowBuilder** = Ephemeral flow tracking (In-Memory)\n * - Track messages being sent RIGHT NOW in an orchestration\n * - Provide context to agents in the same flow\n * - Formatting utilities for LangChain/prompts\n * - Example: `flow.addMessage(msg); flow.getRecentMessages()`\n *\n * ## Pattern A: Single Message (Use ConversationService)\n *\n * ```typescript\n * // User sends a message, you respond once\n * const previousMessages = await conversationService.getRecentMessages(userId, 10);\n * const response = await chatAgent(user, message, previousMessages);\n * ```\n *\n * ## Pattern B: Multi-Message Flow (Use ConversationFlowBuilder)\n *\n * ```typescript\n * // Orchestrating multiple messages in sequence\n * const flow = new ConversationFlowBuilder();\n *\n * const welcome = await messageService.sendWelcomeMessage(user);\n * flow.addMessage(welcome);\n *\n * const planMessages = await messageService.sendPlanSummary(user, plan, flow.getRecentMessages());\n * flow.addMessage(planMessages);\n *\n * const workout = await dailyMessageService.sendDailyMessage(user, flow.getRecentMessages());\n * // Now agents see previous messages in THIS flow, creating natural conversation\n * ```\n *\n * @example\n * ```typescript\n * // Onboarding flow - multiple messages in sequence\n * const flow = new ConversationFlowBuilder();\n *\n * // 1. Welcome message (first message, no context)\n * const welcome = await messageService.sendWelcomeMessage(user);\n * flow.addMessage(welcome);\n *\n * // 2. Plan summary (has context from welcome, won't repeat greeting)\n * const planMessages = await messageService.sendPlanSummary(\n *   user,\n *   plan,\n *   flow.getRecentMessages()\n * );\n * flow.addMessage(planMessages);\n *\n * // 3. First workout (has context from welcome + plan, natural continuation)\n * await dailyMessageService.sendDailyMessage(user, flow.getRecentMessages());\n * ```\n */\nexport class ConversationFlowBuilder {\n  private messages: Message[] = [];\n\n  /**\n   * Convert Message array to LangChain message format (static utility)\n   *\n   * Use this when you need to convert Message objects to the format expected\n   * by LangChain/OpenAI APIs. This is the single source of truth for message formatting.\n   *\n   * @param messages - Array of Message objects to convert\n   * @returns Array formatted for LangChain with proper roles (user/assistant)\n   *\n   * @example\n   * ```typescript\n   * // In an agent:\n   * const messages = [\n   *   { role: 'system', content: systemPrompt },\n   *   ...ConversationFlowBuilder.toMessageArray(previousMessages),\n   *   { role: 'user', content: currentMessage }\n   * ];\n   * ```\n   */\n  static toMessageArray(messages: Message[]): Array<{ role: string; content: string }> {\n    return messages.map(msg => ({\n      role: msg.direction === 'inbound' ? 'user' : 'assistant',\n      content: msg.content,\n    }));\n  }\n\n  /**\n   * Filter messages to get proper context for chat agents\n   *\n   * When processing a new inbound message, the database may contain:\n   * - Case 1: [..., user_message] - Last is the current inbound message being processed (duplicate)\n   * - Case 2: [..., reply_agent_message] - Last is the reply agent's acknowledgment (needed for context)\n   *\n   * This method intelligently filters to avoid duplicates while preserving reply agent context.\n   *\n   * @param messages - Array of messages from the database\n   * @returns Filtered messages for use as chat context\n   *\n   * @example\n   * ```typescript\n   * // In chatService when processing a new message:\n   * const recentMessages = await conversationService.getRecentMessages(userId, 10);\n   * const contextMessages = ConversationFlowBuilder.filterMessagesForContext(recentMessages);\n   * const response = await chatAgent(user, message, contextMessages);\n   * ```\n   */\n  static filterMessagesForContext(messages: Message[]): Message[] {\n    if (!messages || messages.length === 0) {\n      return [];\n    }\n\n    const lastMessage = messages[messages.length - 1];\n\n    // If last message is inbound (from user), it's the current message being processed\n    // Remove it to avoid duplicate context\n    if (lastMessage.direction === 'inbound') {\n      return messages.slice(0, -1);\n    }\n\n    // If last message is outbound (from assistant/reply agent), keep it\n    // This is important context from the reply agent that the chat agent needs\n    return messages;\n  }\n\n  /**\n   * Add one or more messages to the flow\n   */\n  addMessage(message: Message | Message[]): void {\n    if (Array.isArray(message)) {\n      this.messages.push(...message);\n    } else {\n      this.messages.push(message);\n    }\n  }\n\n  /**\n   * Get recent messages from the flow\n   * @param limit - Maximum number of messages to return (most recent first)\n   * @returns Array of messages\n   */\n  getRecentMessages(limit?: number): Message[] {\n    if (!limit) {\n      return [...this.messages];\n    }\n    return this.messages.slice(-limit);\n  }\n\n  /**\n   * Convert messages to LangChain message format\n   * @param limit - Optional limit on number of messages to convert\n   * @returns Array formatted for LangChain with proper roles\n   */\n  toArray(limit?: number): Array<{ role: string; content: string }> {\n    const messages = this.getRecentMessages(limit);\n    return messages.map(msg => ({\n      role: msg.direction === 'inbound' ? 'user' : 'assistant',\n      content: msg.content,\n    }));\n  }\n\n  /**\n   * Convert messages to formatted string for direct prompt injection\n   * @param limit - Optional limit on number of messages to include\n   * @returns Formatted string of conversation\n   */\n  toString(limit?: number): string {\n    const messages = this.getRecentMessages(limit);\n    return messages\n      .map(msg => {\n        const role = msg.direction === 'inbound' ? 'User' : 'Assistant';\n        return `${role}: ${msg.content}`;\n      })\n      .join('\\n\\n');\n  }\n\n  /**\n   * Get total number of messages in the flow\n   */\n  get length(): number {\n    return this.messages.length;\n  }\n\n  /**\n   * Clear all messages from the flow\n   */\n  clear(): void {\n    this.messages = [];\n  }\n}\n"],"names":[],"mappings":";;;;AAqFO,MAAM;IACH,WAAsB,EAAE,CAAC;IAEjC;;;;;;;;;;;;;;;;;;GAkBC,GACD,OAAO,eAAe,QAAmB,EAA4C;QACnF,OAAO,SAAS,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC1B,MAAM,IAAI,SAAS,KAAK,YAAY,SAAS;gBAC7C,SAAS,IAAI,OAAO;YACtB,CAAC;IACH;IAEA;;;;;;;;;;;;;;;;;;;GAmBC,GACD,OAAO,yBAAyB,QAAmB,EAAa;QAC9D,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;YACtC,OAAO,EAAE;QACX;QAEA,MAAM,cAAc,QAAQ,CAAC,SAAS,MAAM,GAAG,EAAE;QAEjD,mFAAmF;QACnF,uCAAuC;QACvC,IAAI,YAAY,SAAS,KAAK,WAAW;YACvC,OAAO,SAAS,KAAK,CAAC,GAAG,CAAC;QAC5B;QAEA,oEAAoE;QACpE,2EAA2E;QAC3E,OAAO;IACT;IAEA;;GAEC,GACD,WAAW,OAA4B,EAAQ;QAC7C,IAAI,MAAM,OAAO,CAAC,UAAU;YAC1B,IAAI,CAAC,QAAQ,CAAC,IAAI,IAAI;QACxB,OAAO;YACL,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;QACrB;IACF;IAEA;;;;GAIC,GACD,kBAAkB,KAAc,EAAa;QAC3C,IAAI,CAAC,OAAO;YACV,OAAO;mBAAI,IAAI,CAAC,QAAQ;aAAC;QAC3B;QACA,OAAO,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;IAC9B;IAEA;;;;GAIC,GACD,QAAQ,KAAc,EAA4C;QAChE,MAAM,WAAW,IAAI,CAAC,iBAAiB,CAAC;QACxC,OAAO,SAAS,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC1B,MAAM,IAAI,SAAS,KAAK,YAAY,SAAS;gBAC7C,SAAS,IAAI,OAAO;YACtB,CAAC;IACH;IAEA;;;;GAIC,GACD,SAAS,KAAc,EAAU;QAC/B,MAAM,WAAW,IAAI,CAAC,iBAAiB,CAAC;QACxC,OAAO,SACJ,GAAG,CAAC,CAAA;YACH,MAAM,OAAO,IAAI,SAAS,KAAK,YAAY,SAAS;YACpD,OAAO,GAAG,KAAK,EAAE,EAAE,IAAI,OAAO,EAAE;QAClC,GACC,IAAI,CAAC;IACV;IAEA;;GAEC,GACD,IAAI,SAAiB;QACnB,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM;IAC7B;IAEA;;GAEC,GACD,QAAc;QACZ,IAAI,CAAC,QAAQ,GAAG,EAAE;IACpB;AACF"}},
    {"offset": {"line": 10543, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/profile/index.ts"],"sourcesContent":["import { userService } from '../../user/userService';\nimport { fitnessProfileService } from '../../user/fitnessProfileService';\nimport { workoutInstanceService } from '../../training/workoutInstanceService';\nimport { createAgent, PROMPT_IDS, type Message as AgentMessage } from '@/server/agents';\nimport { formatForAI, now } from '@/shared/utils/date';\nimport { inngest } from '@/server/connections/inngest/client';\nimport { ConversationFlowBuilder } from '@/server/services/flows/conversationFlowBuilder';\nimport {\n  buildProfileUpdateUserMessage,\n  buildUserFieldsUserMessage,\n  buildStructuredProfileUserMessage,\n} from '../prompts/profile';\nimport {\n  ProfileUpdateOutputSchema,\n  UserFieldsOutputSchema,\n} from '../schemas/profile';\nimport { StructuredProfileSchema } from '@/server/models/profile';\nimport type { StructuredProfileOutput, ProfileUpdateOutput, UserFieldsOutput, StructuredProfileInput } from '../types/profile';\nimport type { ToolResult } from '../types/shared';\nimport type { Message } from '@/server/models/message';\n\n/**\n * ProfileService - Orchestration service for profile and user field agents\n *\n * Handles profile updates via the profile agent AND user field updates\n * (timezone, send time, name) via the user fields agent.\n * Both agents run in parallel for efficiency.\n *\n * Uses entity services (UserService, FitnessProfileService) for data access.\n *\n * This is an ORCHESTRATION service - it coordinates agent calls.\n * For entity CRUD operations, use FitnessProfileService directly.\n */\nexport class ProfileService {\n  /**\n   * Update profile and user fields from a user message\n   *\n   * Runs both agents in parallel:\n   * 1. Profile agent - updates the fitness profile dossier\n   * 2. User fields agent - extracts timezone, send time, and name changes\n   *\n   * Fetches context via entity services, calls both agents,\n   * persists updates, and returns a standardized ToolResult.\n   *\n   * @param userId - The user's ID\n   * @param message - The user's message to extract info from\n   * @param previousMessages - Optional conversation history for context\n   * @returns ToolResult with response summary and optional messages\n   */\n  static async updateProfile(userId: string, message: string, previousMessages?: Message[]): Promise<ToolResult> {\n    console.log('[PROFILE_SERVICE] Processing profile update:', {\n      userId,\n      message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),\n    });\n\n    try {\n      // Fetch context via entity services\n      const user = await userService.getUser(userId);\n      if (!user) {\n        console.warn('[PROFILE_SERVICE] User not found:', userId);\n        return { toolType: 'action', response: 'User not found.' };\n      }\n\n      const currentProfile = await fitnessProfileService.getCurrentProfile(userId) ?? '';\n      const currentDate = formatForAI(new Date(), user.timezone);\n\n      // Convert previous messages to Message format for the configurable agent\n      const previousMsgs: AgentMessage[] = ConversationFlowBuilder.toMessageArray(previousMessages || [])\n        .map(m => ({\n          role: m.role as 'user' | 'assistant',\n          content: m.content,\n        }));\n\n      // Helper function to create and invoke the structured profile agent\n      // System prompt fetched from DB based on agent name\n      const invokeStructuredProfileAgent = async (input: StructuredProfileInput | string): Promise<StructuredProfileOutput> => {\n        const parsedInput: StructuredProfileInput = typeof input === 'string' ? JSON.parse(input) : input;\n        const userPrompt = buildStructuredProfileUserMessage(parsedInput.dossierText, parsedInput.currentDate);\n        const agent = await createAgent({\n          name: PROMPT_IDS.PROFILE_STRUCTURED,\n          schema: StructuredProfileSchema,\n        }, { model: 'gpt-5-nano', temperature: 0.3 });\n\n        const result = await agent.invoke(userPrompt);\n        return { structured: result.response, success: true };\n      };\n\n      // Run BOTH agents in parallel for efficiency\n      const [profileResult, userFieldsResult] = await Promise.all([\n        // Profile agent - updates fitness profile dossier\n        // Prompts fetched from DB based on agent name\n        (async (): Promise<ProfileUpdateOutput> => {\n          const userPrompt = buildProfileUpdateUserMessage(currentProfile, message, user, currentDate);\n\n          // Create profile update agent with subAgents for structured extraction\n          const agent = await createAgent({\n            name: PROMPT_IDS.PROFILE_FITNESS,\n            previousMessages: previousMsgs,\n            schema: ProfileUpdateOutputSchema,\n            subAgents: [{\n              structured: {\n                agent: { name: PROMPT_IDS.PROFILE_STRUCTURED, invoke: invokeStructuredProfileAgent },\n                condition: (result: unknown) => (result as { wasUpdated: boolean }).wasUpdated,\n                transform: (result: unknown) => JSON.stringify({\n                  dossierText: (result as { updatedProfile: string }).updatedProfile,\n                  currentDate,\n                }),\n              },\n            }],\n          });\n\n          const result = await agent.invoke(userPrompt);\n          const structuredResult = (result as { structured?: StructuredProfileOutput }).structured;\n          const structured = structuredResult?.success ? structuredResult.structured : null;\n\n          return {\n            updatedProfile: result.response.updatedProfile,\n            wasUpdated: result.response.wasUpdated,\n            updateSummary: result.response.updateSummary || '',\n            structured,\n          };\n        })(),\n        // User fields agent - extracts timezone, send time, name changes\n        // Prompts fetched from DB based on agent name\n        (async (): Promise<UserFieldsOutput> => {\n          const userPrompt = buildUserFieldsUserMessage(message, user, currentDate);\n          const agent = await createAgent({\n            name: PROMPT_IDS.PROFILE_USER,\n            previousMessages: previousMsgs,\n            schema: UserFieldsOutputSchema,\n          }, { model: 'gpt-5-nano', temperature: 0.3 });\n\n          const result = await agent.invoke(userPrompt);\n          return {\n            timezone: result.response.timezone,\n            preferredSendHour: result.response.preferredSendHour,\n            name: result.response.name,\n            hasUpdates: result.response.hasUpdates,\n            updateSummary: result.response.updateSummary || '',\n          };\n        })(),\n      ]);\n\n      // Persist profile updates (structured data now included from update agent)\n      if (profileResult.wasUpdated) {\n        await fitnessProfileService.saveProfileWithStructured(\n          userId,\n          profileResult.updatedProfile,\n          profileResult.structured\n        );\n\n        console.log('[PROFILE_SERVICE] Profile updated:', {\n          summary: profileResult.updateSummary,\n          hasStructured: profileResult.structured !== null,\n        });\n      } else {\n        console.log('[PROFILE_SERVICE] No profile updates detected');\n      }\n\n      // Handle user field updates\n      if (userFieldsResult.hasUpdates) {\n        const userUpdates: { preferredSendHour?: number; timezone?: string; name?: string } = {};\n\n        // Timezone: !! handles null and empty string\n        if (!!userFieldsResult.timezone) {\n          userUpdates.timezone = userFieldsResult.timezone;\n          console.log('[PROFILE_SERVICE] Timezone update:', userFieldsResult.timezone);\n        }\n\n        // PreferredSendHour: can't use !! because 0 (midnight) is valid\n        // Check for null and -1 sentinel explicitly\n        if (userFieldsResult.preferredSendHour != null && userFieldsResult.preferredSendHour !== -1) {\n          userUpdates.preferredSendHour = userFieldsResult.preferredSendHour;\n        }\n\n        // Name: !! handles null and empty string\n        if (!!userFieldsResult.name) {\n          userUpdates.name = userFieldsResult.name;\n        }\n\n        // Persist user updates if any valid fields\n        if (Object.keys(userUpdates).length > 0) {\n          await userService.updatePreferences(userId, userUpdates);\n          console.log('[PROFILE_SERVICE] User fields updated:', userUpdates);\n\n          // Check if time-related fields changed - ensure user has today's workout\n          if (userUpdates.timezone !== undefined || userUpdates.preferredSendHour !== undefined) {\n            const newTimezone = userUpdates.timezone ?? user.timezone;\n            const currentTime = now(newTimezone);\n\n            // Check if workout already exists for today (prevents duplicates)\n            const todayStart = currentTime.startOf('day').toJSDate();\n            const existingWorkout = await workoutInstanceService.getWorkoutByUserIdAndDate(userId, todayStart);\n\n            if (!existingWorkout) {\n              // No workout exists - trigger immediate send via Inngest\n              await inngest.send({\n                name: 'workout/scheduled',\n                data: {\n                  userId,\n                  targetDate: currentTime.startOf('day').toISO(),\n                },\n              });\n              console.log('[PROFILE_SERVICE] Triggered immediate workout for missed send time');\n            }\n          }\n        }\n      }\n\n      // Combine summaries for response\n      const summaries: string[] = [];\n      if (profileResult.wasUpdated) {\n        summaries.push(`Profile: ${profileResult.updateSummary}`);\n      }\n      if (userFieldsResult.hasUpdates && Object.keys(userFieldsResult).some(k =>\n        k !== 'hasUpdates' && k !== 'updateSummary' &&\n        userFieldsResult[k as keyof typeof userFieldsResult] !== null\n      )) {\n        summaries.push(`Settings: ${userFieldsResult.updateSummary}`);\n      }\n\n      return {\n        toolType: 'action',\n        response: summaries.length > 0\n          ? summaries.join('; ')\n          : 'No updates detected.',\n      };\n    } catch (error) {\n      console.error('[PROFILE_SERVICE] Error updating profile:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      return {\n        toolType: 'action',\n        response: `Profile update failed: ${errorMessage}`,\n      };\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 10762, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/modifications/workoutModificationService.ts"],"sourcesContent":["import { UserService } from '../../user/userService';\nimport { MicrocycleService } from '../../training/microcycleService';\nimport { WorkoutInstanceService } from '../../training/workoutInstanceService';\nimport { workoutAgentService, microcycleAgentService } from '../training';\nimport type { ModifyWorkoutOutput, WorkoutGenerateOutput } from '@/server/services/agents/types/workouts';\nimport { now, getDayOfWeek, DAY_NAMES } from '@/shared/utils/date';\nimport { DateTime } from 'luxon';\nimport { ProgressService } from '../../training/progressService';\nimport { FitnessPlanService } from '../../training/fitnessPlanService';\n\n/**\n * WorkoutModificationService\n *\n * Orchestration service for all workout-related modifications.\n *\n * Responsibilities:\n * - Coordinate weekly pattern modifications across microcycle and workout services\n * - Orchestrate single workout modifications (substitutions and replacements)\n * - Handle AI agent interactions for workout modifications\n * - Ensure proper sequencing and state updates across multiple entities\n *\n * This service follows the orchestration pattern (like OnboardingService, DailyMessageService)\n * and eliminates circular dependencies between MicrocycleService and WorkoutInstanceService.\n */\nexport interface ModifyWorkoutParams {\n  userId: string;\n  workoutDate: Date;\n  changeRequest: string;\n}\n\nexport interface ModifyWorkoutResult {\n  success: boolean;\n  workout?: ModifyWorkoutOutput;\n  modifications?: string;\n  messages: string[];\n  error?: string;\n}\n\nexport interface ModifyWeekParams {\n  userId: string;\n  targetDay: string; // The day being modified (e.g., \"Monday\", \"Tuesday\")\n  changeRequest: string; // What changes to make (e.g., [\"Change chest to back workout\", \"Use dumbbells only\", \"Limit to 45 min\"])\n}\n\nexport interface ModifyWeekResult {\n  success: boolean;\n  workout?: WorkoutGenerateOutput;\n  modifiedDays?: number;\n  modifications?: string;\n  messages: string[];\n  error?: string;\n}\n\nexport class WorkoutModificationService {\n  private static instance: WorkoutModificationService;\n  private userService: UserService;\n  private microcycleService: MicrocycleService;\n  private workoutInstanceService: WorkoutInstanceService;\n  private progressService: ProgressService;\n  private fitnessPlanService: FitnessPlanService;\n  private constructor() {\n    this.userService = UserService.getInstance();\n    this.microcycleService = MicrocycleService.getInstance();\n    this.workoutInstanceService = WorkoutInstanceService.getInstance();\n    this.progressService = ProgressService.getInstance();\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n  }\n\n  public static getInstance(): WorkoutModificationService {\n    if (!WorkoutModificationService.instance) {\n      WorkoutModificationService.instance = new WorkoutModificationService();\n    }\n    return WorkoutModificationService.instance;\n  }\n\n\n  /**\n   * Modify an entire workout based on constraints\n   */\n  public async modifyWorkout(params: ModifyWorkoutParams): Promise<ModifyWorkoutResult> {\n    try {\n      const { userId, workoutDate, changeRequest } = params;\n\n      console.log('Modifying workout', params);\n      // Get user with profile first to determine timezone\n      const user = await this.userService.getUser(userId);\n      if (!user) {\n        return {\n          success: false,\n          messages: [],\n          error: 'User not found',\n        };\n      }\n\n      // Convert the workout date to the user's timezone\n      // If the date came as an ISO string like \"2024-10-08\", it was parsed as UTC midnight\n      // We need to interpret it as a calendar date in the user's timezone instead\n      const dateStr = workoutDate.toISOString().split('T')[0]; // Get YYYY-MM-DD\n      const userLocalDate = DateTime.fromISO(dateStr, { zone: user.timezone }).startOf('day').toJSDate();\n\n      // Get the existing workout\n      const existingWorkout = await this.workoutInstanceService.getWorkoutByUserIdAndDate(userId, userLocalDate);\n\n      if (!existingWorkout) {\n        return {\n          success: false,\n          messages: [],\n          error: 'No workout found for the specified date',\n        };\n      }\n\n\n      // Use the workout agent service to modify the workout\n      const result = await workoutAgentService.modifyWorkout(\n        user,\n        existingWorkout,\n        changeRequest\n      );\n\n      // Extract theme from structured data or use default\n      const theme = result.structure?.title || 'Workout';\n\n      // Store theme in details\n      const details = {\n        theme,  // Keep theme for quick access\n      };\n\n      // Update the workout in the database\n      await this.workoutInstanceService.updateWorkout(existingWorkout.id, {\n        description: result.response.overview,\n        message: result.message,\n        structured: result.structure,\n        details,\n      });\n\n      return {\n        success: true,\n        workout: result,\n        modifications: result.response.modifications,\n        messages: result.message ? [result.message] : [],\n      };\n    } catch (error) {\n      console.error('Error modifying workout:', error);\n      return {\n        success: false,\n        messages: [],\n        error: error instanceof Error ? error.message : 'Unknown error occurred',\n      };\n    }\n  }\n\n  /**\n   * Modify the weekly pattern for remaining days and regenerate a single workout\n   */\n  public async modifyWeek(params: ModifyWeekParams): Promise<ModifyWeekResult> {\n    try {\n      const { userId, changeRequest } = params;\n      // const reason = params.reason; // Not currently used\n      // targetDay is not currently used - we use the current day of week instead\n\n      // Get user with profile\n      const user = await this.userService.getUser(userId);\n      if (!user) {\n        return {\n          success: false,\n          messages: [],\n          error: 'User not found',\n        };\n      }\n\n      const plan = await this.fitnessPlanService.getCurrentPlan(userId);\n      if (!plan) {\n        return {\n          success: false,\n          messages: [],\n          error: 'No fitness plan found',\n        };\n      }\n      const progress = await this.progressService.getCurrentProgress(plan, user.timezone);\n      if (!progress) {\n        return {\n          success: false,\n          messages: [],\n          error: 'No progress found',\n        };\n      }\n\n      const { microcycle } = progress;\n\n      if (!microcycle) {\n        return {\n          success: false,\n          messages: [],\n          error: 'No microcycle found',\n        };\n      }\n\n      console.log(`[MODIFY_WEEK] Using active microcycle ${microcycle.id} (${new Date(microcycle.startDate).toLocaleDateString()} - ${new Date(microcycle.endDate).toLocaleDateString()})`);\n\n      // Get current date in user's timezone (needed for workout operations below)\n      const today = now(user.timezone).toJSDate();\n\n      // Get today's day of week and index for microcycle days array (0-6, Mon-Sun)\n      const todayDayOfWeek = getDayOfWeek(undefined, user.timezone);\n      const todayDayIndex = DAY_NAMES.indexOf(todayDayOfWeek);\n      const originalTodayOverview = microcycle.days[todayDayIndex] || null;\n\n      // Use the microcycle agent service to modify the pattern\n      const modifyMicrocycleResult = await microcycleAgentService.modifyMicrocycle(\n        user,\n        microcycle,\n        changeRequest\n      );\n\n      console.log(`[MODIFY_WEEK] Microcycle modification result:`, modifyMicrocycleResult);\n      // Check if the microcycle was actually modified\n      if (modifyMicrocycleResult.wasModified) {\n        console.log(`[MODIFY_WEEK] Microcycle was modified - updating database`);\n\n        // Generate specialized \"updated week\" message using remaining days\n        // const updatedMicrocycleMessageAgent = createUpdatedMicrocycleMessageAgent();\n        // const microcycleUpdateMessage = await updatedMicrocycleMessageAgent.invoke({\n        //   modifiedMicrocycle: {\n        //     overview: modifyMicrocycleResult.description,\n        //     isDeload: modifyMicrocycleResult.isDeload || false,\n        //     days: modifyMicrocycleResult.days,\n        //   },\n        //   modifications: modifyMicrocycleResult.modifications || 'Updated weekly pattern based on your request',\n        //   currentWeekday: todayDayOfWeek as DayOfWeek,\n        //   user,\n        // });\n\n        // Update the microcycle with the new pattern (days array from the result)\n        await this.microcycleService.updateMicrocycle(\n          microcycle.id,\n          {\n            days: modifyMicrocycleResult.days,\n            description: modifyMicrocycleResult.description,\n            isDeload: modifyMicrocycleResult.isDeload,\n            structured: modifyMicrocycleResult.structure,\n            // message: microcycleUpdateMessage\n          }\n        );\n\n        // Check if today's overview changed - if so, regenerate today's workout\n        const newTodayOverview = modifyMicrocycleResult.days[todayDayIndex] || null;\n\n        if (originalTodayOverview !== newTodayOverview) {\n          // Get activity type from modified microcycle structure\n          const structuredDay = modifyMicrocycleResult.structure?.days?.[todayDayIndex];\n          const activityType = structuredDay?.activityType as 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST' | undefined;\n\n          // Generate new workout for today using workout agent service\n          const workoutResult = await workoutAgentService.generateWorkout(\n            user,\n            newTodayOverview || '',\n            modifyMicrocycleResult.isDeload || false,\n            activityType\n          );\n\n          // Extract theme from structured data or use default\n          const theme = workoutResult.structure?.title || 'Workout';\n\n          // Store theme in details\n          const details = {\n            theme,\n          };\n\n          // Check if a workout exists for today\n          const existingWorkout = await this.workoutInstanceService.getWorkoutByUserIdAndDate(userId, today);\n\n          if (existingWorkout) {\n            // Update existing workout\n            await this.workoutInstanceService.updateWorkout(existingWorkout.id, {\n              details,\n              description: workoutResult.response,\n              message: workoutResult.message,\n              structured: workoutResult.structure,\n              goal: theme,\n              sessionType: this.mapThemeToSessionType(theme),\n            });\n            console.log(`[MODIFY_WEEK] Updated today's workout`);\n          } else {\n            // Create new workout\n            await this.workoutInstanceService.createWorkout({\n              clientId: userId,\n              microcycleId: microcycle.id,\n              date: today,\n              sessionType: this.mapThemeToSessionType(theme),\n              goal: theme,\n              details,\n              description: workoutResult.response,\n              message: workoutResult.message,\n              structured: workoutResult.structure,\n            });\n            console.log(`[MODIFY_WEEK] Created new workout for today`);\n          }\n\n          // Return with both microcycle and workout messages\n          const messages: string[] = [];\n          if (workoutResult.message) {\n            messages.push(workoutResult.message);\n          }\n\n          return {\n            success: true,\n            workout: workoutResult,\n            messages,\n            modifications: modifyMicrocycleResult.modifications,\n          };\n        }\n\n        // Return success with the modified microcycle message and modifications\n        return {\n          success: true,\n          messages: [],\n          modifications: modifyMicrocycleResult.modifications,\n        };\n      } else {\n        console.log(`[MODIFY_WEEK] No modifications needed - current plan already satisfies the request`);\n\n        // Return success without database update\n        // Empty messages - conversation agent will use modifications field to craft response\n        return {\n          success: true,\n          messages: [],\n          modifications: 'No changes needed - your current plan already matches your request',\n        };\n      }\n    } catch (error) {\n      console.error('Error modifying week:', error);\n      return {\n        success: false,\n        messages: [],\n        error: error instanceof Error ? error.message : 'Unknown error occurred',\n      };\n    }\n  }\n\n  /**\n   * Map workout theme to session type for database storage\n   */\n  private mapThemeToSessionType(theme: string): string {\n    const themeLower = theme.toLowerCase();\n    // Valid types: strength, cardio, mobility, recovery, assessment, deload\n    if (themeLower.includes('run') || themeLower.includes('cardio') ||\n        themeLower.includes('hiit') || themeLower.includes('metcon') ||\n        themeLower.includes('conditioning')) return 'cardio';\n    if (themeLower.includes('lift') || themeLower.includes('strength') ||\n        themeLower.includes('upper') || themeLower.includes('lower') ||\n        themeLower.includes('push') || themeLower.includes('pull')) return 'strength';\n    if (themeLower.includes('mobility') || themeLower.includes('flexibility') ||\n        themeLower.includes('stretch')) return 'mobility';\n    if (themeLower.includes('rest') || themeLower.includes('recovery')) return 'recovery';\n    if (themeLower.includes('assessment') || themeLower.includes('test')) return 'assessment';\n    if (themeLower.includes('deload')) return 'deload';\n    // Default to strength for hybrid/unknown workouts\n    return 'strength';\n  }\n}\n\n// Export singleton instance\nexport const workoutModificationService = WorkoutModificationService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 11041, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/modifications/planModificationService.ts"],"sourcesContent":["import { UserService } from '../../user/userService';\nimport { FitnessPlanService } from '../../training/fitnessPlanService';\nimport { fitnessPlanAgentService } from '../training';\nimport { FitnessPlanRepository } from '@/server/repositories/fitnessPlanRepository';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { now, getDayOfWeek } from '@/shared/utils/date';\nimport { WorkoutModificationService } from './workoutModificationService';\n\n/**\n * PlanModificationService\n *\n * Orchestration service for fitness plan modifications.\n *\n * Responsibilities:\n * - Modify fitness plans based on user change requests\n * - Delegate week/microcycle/workout modifications to WorkoutModificationService\n * - Handle AI agent interactions for plan modifications\n * - Run plan and week modifications in parallel for faster response\n *\n * This service follows the orchestration pattern and coordinates with\n * WorkoutModificationService for microcycle and workout updates.\n */\n\nexport interface ModifyPlanParams {\n  userId: string;\n  changeRequest: string;\n}\n\nexport interface ModifyPlanResult {\n  success: boolean;\n  wasModified?: boolean;\n  modifications?: string;\n  messages: string[];\n  error?: string;\n}\n\nexport class PlanModificationService {\n  private static instance: PlanModificationService;\n  private userService: UserService;\n  private fitnessPlanService: FitnessPlanService;\n  private fitnessPlanRepo: FitnessPlanRepository;\n  private workoutModificationService: WorkoutModificationService;\n\n  private constructor() {\n    this.userService = UserService.getInstance();\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n    this.fitnessPlanRepo = new FitnessPlanRepository(postgresDb);\n    this.workoutModificationService = WorkoutModificationService.getInstance();\n  }\n\n  public static getInstance(): PlanModificationService {\n    if (!PlanModificationService.instance) {\n      PlanModificationService.instance = new PlanModificationService();\n    }\n    return PlanModificationService.instance;\n  }\n\n  /**\n   * Modify a user's fitness plan based on their change request\n   * Modifies (not regenerates) the current microcycle to preserve completed workouts\n   * Runs plan and microcycle modifications in parallel for faster response\n   */\n  public async modifyPlan(params: ModifyPlanParams): Promise<ModifyPlanResult> {\n    try {\n      const { userId, changeRequest } = params;\n\n      console.log('[MODIFY_PLAN] Starting plan modification', { userId, changeRequest });\n\n      // 1. Get user with profile\n      const user = await this.userService.getUser(userId);\n      if (!user) {\n        return {\n          success: false,\n          messages: [],\n          error: 'User not found',\n        };\n      }\n\n      // 2. Get current fitness plan\n      const currentPlan = await this.fitnessPlanService.getCurrentPlan(userId);\n      if (!currentPlan) {\n        return {\n          success: false,\n          messages: [],\n          error: 'No fitness plan found. Please create a plan first.',\n        };\n      }\n\n      // 3. Get today's date for week modification\n      const today = now(user.timezone);\n      const currentDayOfWeek = getDayOfWeek(today.toJSDate(), user.timezone);\n\n      // 4. Run plan and week modifications in PARALLEL\n      // modifyWeek handles microcycle modification AND workout generation\n      console.log('[MODIFY_PLAN] Running plan and week modifications in parallel');\n\n      const [planResult, weekResult] = await Promise.all([\n        // Modify plan using agent service\n        fitnessPlanAgentService.modifyFitnessPlan(user, currentPlan, changeRequest),\n        // Modify week (handles microcycle + workout)\n        this.workoutModificationService.modifyWeek({\n          userId,\n          targetDay: currentDayOfWeek,\n          changeRequest,\n        }),\n      ]);\n\n      // 5. Check if plan was actually modified\n      if (!planResult.wasModified) {\n        console.log('[MODIFY_PLAN] No modifications needed - current plan already satisfies the request');\n        return {\n          success: true,\n          wasModified: false,\n          messages: [],\n        };\n      }\n\n      console.log('[MODIFY_PLAN] Plan was modified - saving new version');\n\n      // 6. Save new plan version\n      const newPlan = await this.fitnessPlanRepo.insertFitnessPlan({\n        clientId: userId,\n        description: planResult.description,\n        structured: planResult.structure,\n        startDate: new Date(),\n      });\n\n      console.log(`[MODIFY_PLAN] Saved new plan version ${newPlan.id}`);\n\n      // Week modification (microcycle + workout) was handled in parallel by modifyWeek\n      if (weekResult.success) {\n        console.log(`[MODIFY_PLAN] Week modification completed successfully`);\n      } else if (weekResult.error) {\n        console.warn(`[MODIFY_PLAN] Week modification had issues: ${weekResult.error}`);\n      }\n\n      return {\n        success: true,\n        wasModified: true,\n        modifications: planResult.modifications,\n        messages: weekResult.messages || [],\n      };\n    } catch (error) {\n      console.error('[MODIFY_PLAN] Error modifying plan:', error);\n      return {\n        success: false,\n        messages: [],\n        error: error instanceof Error ? error.message : 'Unknown error occurred',\n      };\n    }\n  }\n}\n\n// Export singleton instance\nexport const planModificationService = PlanModificationService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;;;;;;;;AA8BO,MAAM;IACX,OAAe,SAAkC;IACzC,YAAyB;IACzB,mBAAuC;IACvC,gBAAuC;IACvC,2BAAuD;IAE/D,aAAsB;QACpB,IAAI,CAAC,WAAW,GAAG,uLAAW,CAAC,WAAW;QAC1C,IAAI,CAAC,kBAAkB,GAAG,yMAAkB,CAAC,WAAW;QACxD,IAAI,CAAC,eAAe,GAAG,IAAI,uMAAqB,CAAC,0MAAU;QAC3D,IAAI,CAAC,0BAA0B,GAAG,wOAA0B,CAAC,WAAW;IAC1E;IAEA,OAAc,cAAuC;QACnD,IAAI,CAAC,wBAAwB,QAAQ,EAAE;YACrC,wBAAwB,QAAQ,GAAG,IAAI;QACzC;QACA,OAAO,wBAAwB,QAAQ;IACzC;IAEA;;;;GAIC,GACD,MAAa,WAAW,MAAwB,EAA6B;QAC3E,IAAI;YACF,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG;YAElC,QAAQ,GAAG,CAAC,4CAA4C;gBAAE;gBAAQ;YAAc;YAEhF,2BAA2B;YAC3B,MAAM,OAAO,MAAM,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC;YAC5C,IAAI,CAAC,MAAM;gBACT,OAAO;oBACL,SAAS;oBACT,UAAU,EAAE;oBACZ,OAAO;gBACT;YACF;YAEA,8BAA8B;YAC9B,MAAM,cAAc,MAAM,IAAI,CAAC,kBAAkB,CAAC,cAAc,CAAC;YACjE,IAAI,CAAC,aAAa;gBAChB,OAAO;oBACL,SAAS;oBACT,UAAU,EAAE;oBACZ,OAAO;gBACT;YACF;YAEA,4CAA4C;YAC5C,MAAM,QAAQ,IAAA,6JAAG,EAAC,KAAK,QAAQ;YAC/B,MAAM,mBAAmB,IAAA,sKAAY,EAAC,MAAM,QAAQ,IAAI,KAAK,QAAQ;YAErE,iDAAiD;YACjD,oEAAoE;YACpE,QAAQ,GAAG,CAAC;YAEZ,MAAM,CAAC,YAAY,WAAW,GAAG,MAAM,QAAQ,GAAG,CAAC;gBACjD,kCAAkC;gBAClC,6NAAuB,CAAC,iBAAiB,CAAC,MAAM,aAAa;gBAC7D,6CAA6C;gBAC7C,IAAI,CAAC,0BAA0B,CAAC,UAAU,CAAC;oBACzC;oBACA,WAAW;oBACX;gBACF;aACD;YAED,yCAAyC;YACzC,IAAI,CAAC,WAAW,WAAW,EAAE;gBAC3B,QAAQ,GAAG,CAAC;gBACZ,OAAO;oBACL,SAAS;oBACT,aAAa;oBACb,UAAU,EAAE;gBACd;YACF;YAEA,QAAQ,GAAG,CAAC;YAEZ,2BAA2B;YAC3B,MAAM,UAAU,MAAM,IAAI,CAAC,eAAe,CAAC,iBAAiB,CAAC;gBAC3D,UAAU;gBACV,aAAa,WAAW,WAAW;gBACnC,YAAY,WAAW,SAAS;gBAChC,WAAW,IAAI;YACjB;YAEA,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,QAAQ,EAAE,EAAE;YAEhE,iFAAiF;YACjF,IAAI,WAAW,OAAO,EAAE;gBACtB,QAAQ,GAAG,CAAC,CAAC,sDAAsD,CAAC;YACtE,OAAO,IAAI,WAAW,KAAK,EAAE;gBAC3B,QAAQ,IAAI,CAAC,CAAC,4CAA4C,EAAE,WAAW,KAAK,EAAE;YAChF;YAEA,OAAO;gBACL,SAAS;gBACT,aAAa;gBACb,eAAe,WAAW,aAAa;gBACvC,UAAU,WAAW,QAAQ,IAAI,EAAE;YACrC;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,uCAAuC;YACrD,OAAO;gBACL,SAAS;gBACT,UAAU,EAAE;gBACZ,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAClD;QACF;IACF;AACF;AAGO,MAAM,0BAA0B,wBAAwB,WAAW"}},
    {"offset": {"line": 11170, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/shared/utils.ts"],"sourcesContent":["/**\n * Shared utilities for agent orchestration services\n */\n\nimport type { ToolResult } from '../types/shared';\nimport type { ToolType } from '@/server/agents';\n\n/**\n * Result interface that domain services can return\n * This is the minimum shape required for toToolResult to work\n */\nexport interface DomainResult {\n  success: boolean;\n  messages?: string[];\n  error?: string;\n  modifications?: string;\n}\n\n/**\n * Transform a domain-specific result to a standard ToolResult\n *\n * This utility converts service results (like ModifyWorkoutResult, ModifyWeekResult, etc.)\n * into the standard ToolResult format that agents expect.\n *\n * @param result - Domain-specific result with success, messages, error, and modifications\n * @param toolType - Type of tool ('query' or 'action'), defaults to 'action'\n * @returns Standard ToolResult with response and optional messages\n */\nexport function toToolResult<T extends DomainResult>(result: T, toolType: ToolType = 'action'): ToolResult {\n  if (!result.success) {\n    return {\n      toolType,\n      response: `Operation failed: ${result.error || 'Unknown error'}`,\n      messages: result.messages?.length ? result.messages : undefined,\n    };\n  }\n  return {\n    toolType,\n    response: result.modifications\n      ? `Operation completed: ${result.modifications}`\n      : 'Operation completed successfully',\n    messages: result.messages?.length ? result.messages : undefined,\n  };\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AA0BM,SAAS,aAAqC,MAAS,EAAE,WAAqB,QAAQ;IAC3F,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,OAAO;YACL;YACA,UAAU,CAAC,kBAAkB,EAAE,OAAO,KAAK,IAAI,iBAAiB;YAChE,UAAU,OAAO,QAAQ,EAAE,SAAS,OAAO,QAAQ,GAAG;QACxD;IACF;IACA,OAAO;QACL;QACA,UAAU,OAAO,aAAa,GAC1B,CAAC,qBAAqB,EAAE,OAAO,aAAa,EAAE,GAC9C;QACJ,UAAU,OAAO,QAAQ,EAAE,SAAS,OAAO,QAAQ,GAAG;IACxD;AACF"}},
    {"offset": {"line": 11194, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/modifications/tools.ts"],"sourcesContent":["import { z } from 'zod';\nimport { tool, type StructuredToolInterface } from '@langchain/core/tools';\nimport type { ToolResult } from '../types/shared';\nimport { toToolResult } from '../shared/utils';\nimport type { ModifyWorkoutResult, ModifyWeekResult } from './workoutModificationService';\nimport type { ModifyPlanResult } from './planModificationService';\n\n/**\n * Parameters for modifying a workout\n */\nexport interface ModifyWorkoutParams {\n  userId: string;\n  workoutDate: Date;\n  changeRequest: string;\n}\n\n/**\n * Parameters for modifying the weekly pattern\n */\nexport interface ModifyWeekParams {\n  userId: string;\n  targetDay: string;\n  changeRequest: string;\n}\n\n/**\n * Parameters for modifying the fitness plan\n */\nexport interface ModifyPlanParams {\n  userId: string;\n  changeRequest: string;\n}\n\n/**\n * Dependencies for modification tools (DI pattern)\n */\nexport interface ModificationToolDeps {\n  modifyWorkout: (params: ModifyWorkoutParams) => Promise<ModifyWorkoutResult>;\n  modifyWeek: (params: ModifyWeekParams) => Promise<ModifyWeekResult>;\n  modifyPlan: (params: ModifyPlanParams) => Promise<ModifyPlanResult>;\n}\n\n/**\n * Context required for modification tools (pre-filled from chat context)\n */\nexport interface ModificationToolContext {\n  userId: string;\n  message: string;\n  workoutDate: Date;\n  targetDay: string;\n}\n\n// Schema definitions - empty because all params come from context\nconst ModifyWorkoutSchema = z.object({});\nconst ModifyWeekSchema = z.object({});\nconst ModifyPlanSchema = z.object({});\n\n/**\n * Factory function to create modification tools with injected dependencies (DI pattern)\n *\n * This allows services to be injected rather than directly imported,\n * breaking circular dependencies and improving testability.\n *\n * All tools return standardized ToolResult: { response: string, messages?: string[] }\n *\n * @param context - Context from chat (userId, message, workoutDate, targetDay)\n * @param deps - Dependencies including workout and microcycle services\n * @returns Array of LangChain tools configured with the provided services\n */\nexport const createModificationTools = (\n  context: ModificationToolContext,\n  deps: ModificationToolDeps\n): StructuredToolInterface[] => {\n  // Tool 1: Modify Workout\n  const modifyWorkoutTool = tool(\n    async (): Promise<ToolResult> => {\n      const result = await deps.modifyWorkout({\n        userId: context.userId,\n        workoutDate: context.workoutDate,\n        changeRequest: context.message,\n      });\n      return toToolResult(result);\n    },\n    {\n      name: 'modify_workout',\n      description: `Regenerate today's workout keeping the SAME muscle group/focus but with different constraints.\n\nNOTE: All parameters (userId, date, request) are automatically filled from context - no input needed.\n\nUse ONLY when the user explicitly wants to keep the same muscle group/workout type but change HOW they do it:\n- Same muscle group, different equipment (e.g., \"Today is chest - can't make it to my gym, need a chest workout with just dumbbells\")\n- Same focus, different time (e.g., \"Today is leg day but only have 30 min, can you adjust my leg workout?\")\n- Same workout, different constraints (e.g., \"Today's shoulder workout but my shoulder hurts, can you modify it to be gentler?\")\n\nIMPORTANT: User must indicate they want to keep the SAME muscle group/workout type.\nDO NOT use if user requests a DIFFERENT muscle group or doesn't specify - use modify_week instead.\nThis is the LEAST commonly used tool - default to modify_week when uncertain.`,\n      schema: ModifyWorkoutSchema,\n    }\n  );\n\n  // Tool 2: Modify Week\n  const modifyWeekTool = tool(\n    async (): Promise<ToolResult> => {\n      const result = await deps.modifyWeek({\n        userId: context.userId,\n        targetDay: context.targetDay,\n        changeRequest: context.message,\n      });\n      return toToolResult(result);\n    },\n    {\n      name: 'modify_week',\n      description: `Modify the weekly training pattern and regenerate workouts as needed. **This is the PRIMARY and MOST COMMON tool.**\n\nNOTE: All parameters (userId, targetDay, request) are automatically filled from context - no input needed.\n\nUse this for ANY request for a different workout type or muscle group:\n- ANY different muscle group request (e.g., \"can I have a leg workout\", \"chest workout please\", \"give me back instead\")\n- ANY different workout type (e.g., \"I actually want to run today instead\", \"cardio today?\", \"full body workout\")\n- Rearranging the weekly schedule (e.g., \"can we swap my rest days?\", \"move leg day to Friday\")\n- Multi-day constraints (e.g., \"traveling this week with hotel gym\", \"only 30 min per day rest of week\")\n\n**DEFAULT TO THIS TOOL when user requests a workout change.** Even if they don't explicitly say \"instead of\" or mention multiple days.\n\nExamples that should use modify_week:\n- \"Can I do legs today?\" -> YES (different muscle group)\n- \"Chest workout please\" -> YES (potentially different from scheduled)\n- \"I want to run instead\" -> YES (different workout type)\n- \"Can't make it to gym this week\" -> YES (multi-day change)\n\nThis intelligently updates the weekly pattern to maintain training balance and muscle group spacing.`,\n      schema: ModifyWeekSchema,\n    }\n  );\n\n  // Tool 3: Modify Plan\n  const modifyPlanTool = tool(\n    async (): Promise<ToolResult> => {\n      const result = await deps.modifyPlan({\n        userId: context.userId,\n        changeRequest: context.message,\n      });\n      return toToolResult(result);\n    },\n    {\n      name: 'modify_plan',\n      description: `Modify the user's overall fitness plan/program structure.\n\nNOTE: All parameters (userId, changeRequest) are automatically filled from context - no input needed.\n\nUse when the user wants to change their PROGRAM-LEVEL settings:\n- Training frequency changes (e.g., \"change from 5 to 6 days a week\", \"I want to train 4 days instead of 3\")\n- Adding/removing fixed schedule items (e.g., \"add yoga on Monday/Friday mornings\", \"I joined a spinning class on Wednesdays\")\n- Changing their training split (e.g., \"switch to push/pull/legs\", \"I want an upper/lower split\")\n- Adjusting overall goals or focus (e.g., \"more cardio\", \"focus on strength\", \"add more conditioning\")\n- Equipment/facility changes (e.g., \"I joined a new gym with more equipment\", \"I only have dumbbells now\")\n\nDO NOT use for day-to-day or single week changes - use modify_week or modify_workout instead.\nThis tool is for STRUCTURAL/ARCHITECTURAL changes to the entire training program.\n\nExamples that should use modify_plan:\n- \"Can we change to 6 days a week?\" -> YES (frequency change)\n- \"I started yoga on Mondays and Fridays\" -> YES (adding anchors)\n- \"Switch me to a PPL split\" -> YES (program structure)\n- \"I want more cardio overall\" -> YES (program balance)\n\nExamples that should NOT use modify_plan:\n- \"Can I do legs today?\" -> NO (use modify_week)\n- \"Skip today's workout\" -> NO (use modify_week)`,\n      schema: ModifyPlanSchema,\n    }\n  );\n\n  return [\n    modifyWorkoutTool,\n    modifyWeekTool,\n    modifyPlanTool,\n  ];\n};\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AAEA;;;;AAiDA,kEAAkE;AAClE,MAAM,sBAAsB,0MAAC,CAAC,MAAM,CAAC,CAAC;AACtC,MAAM,mBAAmB,0MAAC,CAAC,MAAM,CAAC,CAAC;AACnC,MAAM,mBAAmB,0MAAC,CAAC,MAAM,CAAC,CAAC;AAc5B,MAAM,0BAA0B,CACrC,SACA;IAEA,yBAAyB;IACzB,MAAM,oBAAoB,IAAA,iYAAI,EAC5B;QACE,MAAM,SAAS,MAAM,KAAK,aAAa,CAAC;YACtC,QAAQ,QAAQ,MAAM;YACtB,aAAa,QAAQ,WAAW;YAChC,eAAe,QAAQ,OAAO;QAChC;QACA,OAAO,IAAA,8LAAY,EAAC;IACtB,GACA;QACE,MAAM;QACN,aAAa,CAAC;;;;;;;;;;;6EAWyD,CAAC;QACxE,QAAQ;IACV;IAGF,sBAAsB;IACtB,MAAM,iBAAiB,IAAA,iYAAI,EACzB;QACE,MAAM,SAAS,MAAM,KAAK,UAAU,CAAC;YACnC,QAAQ,QAAQ,MAAM;YACtB,WAAW,QAAQ,SAAS;YAC5B,eAAe,QAAQ,OAAO;QAChC;QACA,OAAO,IAAA,8LAAY,EAAC;IACtB,GACA;QACE,MAAM;QACN,aAAa,CAAC;;;;;;;;;;;;;;;;;;oGAkBgF,CAAC;QAC/F,QAAQ;IACV;IAGF,sBAAsB;IACtB,MAAM,iBAAiB,IAAA,iYAAI,EACzB;QACE,MAAM,SAAS,MAAM,KAAK,UAAU,CAAC;YACnC,QAAQ,QAAQ,MAAM;YACtB,eAAe,QAAQ,OAAO;QAChC;QACA,OAAO,IAAA,8LAAY,EAAC;IACtB,GACA;QACE,MAAM;QACN,aAAa,CAAC;;;;;;;;;;;;;;;;;;;;;;gDAsB4B,CAAC;QAC3C,QAAQ;IACV;IAGF,OAAO;QACL;QACA;QACA;KACD;AACH"}},
    {"offset": {"line": 11309, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/prompts/modifications.ts"],"sourcesContent":["import type { UserWithProfile } from '@/server/models/user';\nimport { formatForAI, getDayOfWeekName } from '@/shared/utils/date';\n\n/**\n * Input for building the modifications user message\n */\nexport interface ModificationsUserMessageInput {\n  user: UserWithProfile;\n  message: string;\n}\n\n/**\n * Static system prompt for the Modifications Agent\n * Handles user requests to change, swap, or modify workouts\n */\nexport const MODIFICATIONS_SYSTEM_PROMPT = `You are a flexible fitness coach for GymText, helping users modify their workouts and training plans.\n\n## YOUR ROLE\n\nYour job is to analyze the user's modification request and select the appropriate tool. All parameters are automatically provided from context - you only need to choose which tool to call. You do not need to generate conversational responses.\n\n## AVAILABLE TOOLS\n\nYou have three tools available (in order of usage frequency):\n\n1. **modify_week** - **PRIMARY TOOL** - Use for TEMPORARY or CURRENT WEEK changes\n   - Use when the user wants a different muscle group or workout type than scheduled **for this week only**\n   - Example: \"Can I have a leg workout today?\" (any leg request, regardless of what's scheduled)\n   - Example: \"I want to run today instead\" (different workout type)\n   - Example: \"Can we do back instead of chest **today**?\" (explicit swap for now)\n   - Example: \"Can we move leg day to Friday **this week**?\" (temporary rearrange)\n   - Example: \"I'm traveling **this week** with limited equipment\" (temporary constraints)\n   - **DEFAULT TO THIS TOOL for one-off changes**\n\n2. **modify_workout** - **LESS COMMON** - Use ONLY when user wants SAME muscle group with different constraints\n   - Use when user explicitly wants to keep the same muscle group but change HOW they do it\n   - Example: \"Today is chest day - can't make it to my gym, need a chest workout with just dumbbells\" (same muscle group, different equipment)\n   - Example: \"Today is leg day but only have 30 min, can you adjust my leg workout?\" (same focus, less time)\n   - **User must indicate they want the SAME muscle group - otherwise use modify_week**\n\n3. **modify_plan** - **LEAST COMMON** - Use for PERMANENT PROGRAM-LEVEL structural changes\n   - Use when the user wants to change their **ongoing** training program structure or schedule\n   - Example: \"Can we update my plan so that I start my weeks with legs instead of push\" (permanent reorder)\n   - Example: \"Can we change to 6 days a week?\" (frequency change)\n   - Example: \"I want to do yoga on Mondays from now on\" (permanent schedule anchor)\n   - Example: \"Switch me to a push/pull/legs split\" (program structure change)\n   - **Use this for ANY request that implies \"from now on\", \"my plan\", or \"always\"**\n\n## TOOL USAGE GUIDELINES\n\n**Priority Bias (use this order):**\n1. **modify_week** - MOST COMMON (temporary/current week changes)\n2. **modify_workout** - LESS COMMON (same muscle group, different constraints)\n3. **modify_plan** - LEAST COMMON (permanent program/structural changes)\n\n**Decision Tree:**\n\n**Step 1:** Is the user asking for a PERMANENT or STRUCTURAL change?\n- \"Update my plan so I start weeks with legs\"  YES  **modify_plan**\n- \"Can we change to 6 days a week?\"  YES  **modify_plan**\n- \"I want to do yoga every Monday\"  YES  **modify_plan**\n- \"Switch me to push/pull/legs\"  YES  **modify_plan**\n- \"I want more cardio overall in my plan\"  YES  **modify_plan**\n- Keywords: \"plan\", \"program\", \"start my weeks\", \"from now on\", \"always\"\n- If YES  **use modify_plan**\n\n**Step 2:** Is the user asking for a DIFFERENT workout type or muscle group (Temporary/One-off)?\n- \"Can I have a leg workout today?\"  YES  **modify_week**\n- \"I want to run instead\"  YES  **modify_week**\n- \"Can we do back instead of chest today?\"  YES  **modify_week**\n- \"Move legs to Friday just for this week\"  YES  **modify_week**\n- If YES  **use modify_week**\n\n**Step 3:** Is the user explicitly asking to keep the SAME muscle group but change constraints?\n- \"Today is chest - can I do a chest workout with just dumbbells?\"  YES  **modify_workout**\n- \"Today is leg day but only have 30 min, can you adjust my leg workout?\"  YES  **modify_workout**\n- If YES  **use modify_workout**\n\n**When uncertain between modifying the week vs plan, look for \"this week\" (modify_week) vs \"my plan/always\" (modify_plan). If ambiguous, default to modify_week.**\n\n## EXAMPLES\n\n**Example 1: Different workout type (modify_week)**\nUser: \"Can I have a leg workout today?\"\nTool: modify_week (different muscle group request)\n\n**Example 2: Permanent Schedule Reorder (modify_plan)**\nUser: \"Can we update my plan so that I start my weeks with legs instead of push\"\nTool: modify_plan (permanent schedule change)\n\n**Example 3: Different workout type (modify_week)**\nUser: \"I actually want to run today instead\"\nTool: modify_week (different workout type)\n\n**Example 4: Same muscle group, different constraints (modify_workout)**\nUser: \"Today is chest day - can't make it to my gym, need a chest workout with just dumbbells\"\nTool: modify_workout (same muscle group, different equipment)\n\n**Example 5: Training frequency change (modify_plan)**\nUser: \"Can we change to 6 days a week?\"\nTool: modify_plan (program-level frequency change)\n\n**Example 6: Temporary Schedule Shift (modify_week)**\nUser: \"Can we move leg day to Friday this week?\"\nTool: modify_week (temporary rearrange)\n`;\n\n/**\n * Build the dynamic user message with context\n *\n * Note: Conversation history is now passed as structured messages in the message array,\n * not concatenated into this prompt.\n */\nexport const buildModificationsUserMessage = (input: ModificationsUserMessageInput): string => {\n  const { user } = input;\n\n  // Get current date/time in user's timezone\n  const now = new Date();\n  const currentDate = formatForAI(now, user.timezone);\n\n  // Get the current day of the week\n  const currentDayOfWeek = getDayOfWeekName(now, user.timezone); // Full weekday name (e.g., \"Monday\")\n\n  return `## CONTEXT\n\n**Todays Date**: ${currentDate}\n**Todays Day of Week**: ${currentDayOfWeek}\n**User Name**: ${user.name}\n\n### User Profile\n${user.profile || 'No profile available'}\n\n---\n\n**Users Message**: ${input.message}\n\n---\n\nSelect the appropriate tool based on the user's request. All parameters (userId, date, targetDay, etc.) are automatically provided from context.`;\n};\n"],"names":[],"mappings":";;;;;;AACA;;AAcO,MAAM,8BAA8B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0F5C,CAAC;AAQM,MAAM,gCAAgC,CAAC;IAC5C,MAAM,EAAE,IAAI,EAAE,GAAG;IAEjB,2CAA2C;IAC3C,MAAM,MAAM,IAAI;IAChB,MAAM,cAAc,IAAA,qKAAW,EAAC,KAAK,KAAK,QAAQ;IAElD,kCAAkC;IAClC,MAAM,mBAAmB,IAAA,0KAAgB,EAAC,KAAK,KAAK,QAAQ,GAAG,qCAAqC;IAEpG,OAAO,CAAC;;iBAEO,EAAE,YAAY;wBACP,EAAE,iBAAiB;eAC5B,EAAE,KAAK,IAAI,CAAC;;;AAG3B,EAAE,KAAK,OAAO,IAAI,uBAAuB;;;;mBAItB,EAAE,MAAM,OAAO,CAAC;;;;gJAI6G,CAAC;AACjJ"}},
    {"offset": {"line": 11436, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/modifications/index.ts"],"sourcesContent":["import { workoutModificationService } from './workoutModificationService';\nimport { planModificationService } from './planModificationService';\nimport { createModificationTools } from './tools';\nimport { createAgent, PROMPT_IDS, type Message as AgentMessage } from '@/server/agents';\nimport { userService } from '../../user/userService';\nimport { workoutInstanceService } from '../../training/workoutInstanceService';\nimport { now, getWeekday, DAY_NAMES } from '@/shared/utils/date';\nimport { ConversationFlowBuilder } from '@/server/services/flows/conversationFlowBuilder';\nimport { buildModificationsUserMessage } from '../prompts/modifications';\nimport type { ToolResult } from '../types/shared';\nimport type { Message } from '@/server/models/message';\n\n/**\n * ModificationService - Orchestration service for modifications agent\n *\n * Handles workout, schedule, and plan modifications via the modifications agent.\n * Fetches its own context and delegates to specialized sub-services.\n *\n * This is an ORCHESTRATION service - it coordinates agent calls.\n * For specific modification operations, use WorkoutModificationService or PlanModificationService.\n */\nexport class ModificationService {\n  /**\n   * Process a modification request from a user message\n   *\n   * Fetches context via entity services, calls the modifications agent,\n   * and returns a standardized ToolResult.\n   *\n   * @param userId - The user's ID\n   * @param message - The user's modification request message\n   * @param previousMessages - Optional conversation history for context\n   * @returns ToolResult with response summary and optional messages\n   */\n  static async makeModification(userId: string, message: string, previousMessages?: Message[]): Promise<ToolResult> {\n    console.log('[MODIFICATION_SERVICE] Processing modification request:', {\n      userId,\n      message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),\n    });\n\n    try {\n      // Fetch context via entity services\n      const user = await userService.getUser(userId);\n      if (!user) {\n        console.warn('[MODIFICATION_SERVICE] User not found:', userId);\n        return { toolType: 'action', response: 'User not found.' };\n      }\n\n      const today = now(user.timezone).toJSDate();\n      const weekday = getWeekday(today, user.timezone);\n      const targetDay = DAY_NAMES[weekday - 1];\n      const currentWorkout = await workoutInstanceService.getWorkoutByUserIdAndDate(userId, today);\n\n      console.log('[MODIFICATION_SERVICE] Context fetched:', {\n        targetDay,\n        workoutDate: today.toISOString(),\n        hasWorkout: !!currentWorkout,\n        messageCount: previousMessages?.length ?? 0,\n      });\n\n      // Create modification tools with context and service dependencies\n      const tools = createModificationTools(\n        {\n          userId,\n          message,\n          workoutDate: today,\n          targetDay,\n        },\n        {\n          modifyWorkout: workoutModificationService.modifyWorkout.bind(workoutModificationService),\n          modifyWeek: workoutModificationService.modifyWeek.bind(workoutModificationService),\n          modifyPlan: planModificationService.modifyPlan.bind(planModificationService),\n        }\n      );\n\n      // Convert previous messages to Message format for the configurable agent\n      const previousMsgs: AgentMessage[] = ConversationFlowBuilder.toMessageArray(previousMessages || [])\n        .map(m => ({\n          role: m.role as 'user' | 'assistant',\n          content: m.content,\n        }));\n\n      // Build user message\n      const userMessage = buildModificationsUserMessage({ user, message });\n\n      // Create modifications agent - prompts fetched from DB based on agent name\n      const agent = await createAgent({\n        name: PROMPT_IDS.MODIFICATIONS_ROUTER,\n        previousMessages: previousMsgs,\n        tools,\n      }, { model: 'gpt-5-mini' });\n\n      // Invoke the agent - tool execution is handled by createAgent\n      const result = await agent.invoke(userMessage);\n\n      console.log('[MODIFICATION_SERVICE] Agent returned:', {\n        messageCount: result.messages?.length ?? 0,\n        response: result.response.substring(0, 100) + (result.response.length > 100 ? '...' : ''),\n      });\n\n      return {\n        toolType: 'action',\n        response: result.response,\n        messages: result.messages,\n      };\n    } catch (error) {\n      console.error('[MODIFICATION_SERVICE] Error processing modification:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n\n      return {\n        toolType: 'action',\n        response: `Modification failed: ${errorMessage}`,\n      };\n    }\n  }\n}\n\n// Re-export sub-services and types for convenience\nexport { WorkoutModificationService, workoutModificationService } from './workoutModificationService';\nexport type { ModifyWorkoutResult, ModifyWeekResult, ModifyWorkoutParams, ModifyWeekParams } from './workoutModificationService';\nexport { PlanModificationService, planModificationService } from './planModificationService';\nexport type { ModifyPlanResult, ModifyPlanParams } from './planModificationService';\nexport { createModificationTools } from './tools';\nexport type { ModificationToolContext, ModificationToolDeps } from './tools';\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;AAaO,MAAM;IACX;;;;;;;;;;GAUC,GACD,aAAa,iBAAiB,MAAc,EAAE,OAAe,EAAE,gBAA4B,EAAuB;QAChH,QAAQ,GAAG,CAAC,2DAA2D;YACrE;YACA,SAAS,QAAQ,SAAS,CAAC,GAAG,OAAO,CAAC,QAAQ,MAAM,GAAG,MAAM,QAAQ,EAAE;QACzE;QAEA,IAAI;YACF,oCAAoC;YACpC,MAAM,OAAO,MAAM,uLAAW,CAAC,OAAO,CAAC;YACvC,IAAI,CAAC,MAAM;gBACT,QAAQ,IAAI,CAAC,0CAA0C;gBACvD,OAAO;oBAAE,UAAU;oBAAU,UAAU;gBAAkB;YAC3D;YAEA,MAAM,QAAQ,IAAA,6JAAG,EAAC,KAAK,QAAQ,EAAE,QAAQ;YACzC,MAAM,UAAU,IAAA,oKAAU,EAAC,OAAO,KAAK,QAAQ;YAC/C,MAAM,YAAY,mKAAS,CAAC,UAAU,EAAE;YACxC,MAAM,iBAAiB,MAAM,iNAAsB,CAAC,yBAAyB,CAAC,QAAQ;YAEtF,QAAQ,GAAG,CAAC,2CAA2C;gBACrD;gBACA,aAAa,MAAM,WAAW;gBAC9B,YAAY,CAAC,CAAC;gBACd,cAAc,kBAAkB,UAAU;YAC5C;YAEA,kEAAkE;YAClE,MAAM,QAAQ,IAAA,gNAAuB,EACnC;gBACE;gBACA;gBACA,aAAa;gBACb;YACF,GACA;gBACE,eAAe,wOAA0B,CAAC,aAAa,CAAC,IAAI,CAAC,wOAA0B;gBACvF,YAAY,wOAA0B,CAAC,UAAU,CAAC,IAAI,CAAC,wOAA0B;gBACjF,YAAY,kOAAuB,CAAC,UAAU,CAAC,IAAI,CAAC,kOAAuB;YAC7E;YAGF,yEAAyE;YACzE,MAAM,eAA+B,gNAAuB,CAAC,cAAc,CAAC,oBAAoB,EAAE,EAC/F,GAAG,CAAC,CAAA,IAAK,CAAC;oBACT,MAAM,EAAE,IAAI;oBACZ,SAAS,EAAE,OAAO;gBACpB,CAAC;YAEH,qBAAqB;YACrB,MAAM,cAAc,IAAA,wNAA6B,EAAC;gBAAE;gBAAM;YAAQ;YAElE,2EAA2E;YAC3E,MAAM,QAAQ,MAAM,IAAA,6KAAW,EAAC;gBAC9B,MAAM,0KAAU,CAAC,oBAAoB;gBACrC,kBAAkB;gBAClB;YACF,GAAG;gBAAE,OAAO;YAAa;YAEzB,8DAA8D;YAC9D,MAAM,SAAS,MAAM,MAAM,MAAM,CAAC;YAElC,QAAQ,GAAG,CAAC,0CAA0C;gBACpD,cAAc,OAAO,QAAQ,EAAE,UAAU;gBACzC,UAAU,OAAO,QAAQ,CAAC,SAAS,CAAC,GAAG,OAAO,CAAC,OAAO,QAAQ,CAAC,MAAM,GAAG,MAAM,QAAQ,EAAE;YAC1F;YAEA,OAAO;gBACL,UAAU;gBACV,UAAU,OAAO,QAAQ;gBACzB,UAAU,OAAO,QAAQ;YAC3B;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,yDAAyD;YACvE,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAE9D,OAAO;gBACL,UAAU;gBACV,UAAU,CAAC,qBAAqB,EAAE,cAAc;YAClD;QACF;IACF;AACF"}},
    {"offset": {"line": 11553, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/chat/tools.ts"],"sourcesContent":["import { z } from 'zod';\nimport { tool, type StructuredToolInterface } from '@langchain/core/tools';\nimport type { ToolResult } from '../types/shared';\nimport type { Message } from '@/server/models/message';\n\n/**\n * Creates a tool with a required `message` parameter that gets sent immediately\n * before the callback executes. This allows the LLM to provide an acknowledgment\n * message while slow tools are processing.\n *\n * @param name - Tool name\n * @param description - Tool description for the LLM\n * @param callback - The async function to execute\n * @param onSendMessage - Callback to send the immediate message\n * @returns StructuredToolInterface with message handling built-in\n */\nexport function toolWithMessage(\n  name: string,\n  description: string,\n  callback: () => Promise<ToolResult>,\n  onSendMessage: (message: string) => Promise<void>\n): StructuredToolInterface {\n  return tool(\n    async (args: { message: string }): Promise<ToolResult> => {\n      // Send immediate message before execution\n      if (args.message) {\n        try {\n          await onSendMessage(args.message);\n          console.log(`[toolWithMessage] Sent: ${args.message}`);\n        } catch (error) {\n          console.error('[toolWithMessage] Failed to send:', error);\n        }\n      }\n      return callback();\n    },\n    {\n      name,\n      description,\n      schema: z.object({\n        message: z.string().describe(\n          'REQUIRED. Brief acknowledgment to send immediately (1 sentence). Example: \"Got it, switching to legs!\"'\n        ),\n      }),\n    }\n  );\n}\n\n/**\n * Dependencies for chat tools (DI pattern)\n * Pass the methods directly, not the full services\n */\nexport interface ChatToolDeps {\n  makeModification: (userId: string, message: string, previousMessages?: Message[]) => Promise<ToolResult>;\n  getWorkout: (userId: string, timezone: string) => Promise<ToolResult>;\n  updateProfile: (userId: string, message: string, previousMessages?: Message[]) => Promise<ToolResult>;\n}\n\n/**\n * Context required for chat tools\n */\nexport interface ChatToolContext {\n  userId: string;\n  message: string;\n  previousMessages?: Message[];\n  timezone: string;\n}\n\n/**\n * Factory function to create chat tools with injected dependencies\n *\n * Creates tools that the chat agent can use:\n * - update_profile: Record permanent user preferences and profile information (Priority 1)\n * - get_workout: Get or generate today's workout (Priority 2)\n * - make_modification: Make changes to workouts, schedules, or plans (Priority 3)\n *\n * All tools return standardized ToolResult: { response: string, messages?: string[] }\n *\n * @param context - Context from chat (userId, message)\n * @param deps - Dependencies (updateProfile, makeModification, getWorkout methods)\n * @returns Array of LangChain tools\n */\nexport const createChatTools = (\n  context: ChatToolContext,\n  deps: ChatToolDeps,\n  onSendMessage: (message: string) => Promise<void>\n): StructuredToolInterface[] => {\n  // Tool 1: Update Profile (Priority 1 - runs first when called with other tools)\n  const updateProfileTool = tool(\n    async (): Promise<ToolResult> => {\n      return deps.updateProfile(context.userId, context.message, context.previousMessages);\n    },\n    {\n      name: 'update_profile',\n      description: `Record permanent user preferences and profile information.\n\nUse this tool when the user shares PERMANENT information:\n- **Preferences**: \"I like starting with legs\", \"I prefer barbells\", \"I hate lunges\"\n- **Constraints/Injuries**: \"I hurt my knee\", \"I have a bad shoulder\"\n- **Schedule preferences**: \"I prefer runs on Tuesdays\", \"I like morning workouts\"\n- **Goals**: \"I want to lose 10lbs\", \"training for a marathon\"\n- **Equipment/Location**: \"I go to Planet Fitness\", \"I have a home gym\"\n- **Settings**: timezone, send time, or name changes\n\nDO NOT use for one-time requests (\"switch today to legs\") or questions.\n\nIMPORTANT: If user wants BOTH a preference AND a workout change, call BOTH tools.\nExample: \"Add runs to my plan on Tues/Thurs\" -> update_profile (preference) + make_modification (plan change)\n\nAll context is automatically provided - no parameters needed.`,\n      schema: z.object({}),\n    }\n  );\n\n  // Tool 2: Make Modification\n  const makeModificationTool = toolWithMessage(\n    'make_modification',\n    `Make changes to the user's workout or training program.\n\nUse this tool for:\n- **Today's Workout**: Swap exercises, different constraints, different equipment\n- **Weekly Schedule**: Change workout type, muscle group, or training day\n- **Program-Level**: Frequency, training splits, overall focus\n\nThis tool handles WORKOUT CONTENT - not user settings like send time, timezone, or name.\nAll context (user, message, date, etc.) is automatically provided - no parameters needed.`,\n    async (): Promise<ToolResult> => {\n      return deps.makeModification(context.userId, context.message, context.previousMessages);\n    },\n    onSendMessage\n  );\n\n  // Tool 3: Get Workout\n  const getWorkoutTool = tool(\n    async (): Promise<ToolResult> => {\n      return deps.getWorkout(context.userId, context.timezone);\n    },\n    {\n      name: 'get_workout',\n      description: `Get the user's workout for today.\n\nUse this tool when the user asks about their workout for today, such as:\n- \"What's my workout today?\"\n- \"What am I doing today?\"\n- \"Send me my workout\"\n- \"What exercises do I have?\"\n\nThis tool will:\n1. Check if a workout already exists for today\n2. If not, generate one based on their fitness plan\n3. Return the full workout details and send the workout message\n\nIMPORTANT: Only use this for TODAY's workout. Do not use for future dates.\nIf [CONTEXT: WORKOUT] says \"No workout scheduled\", use this tool to generate it.\nAll context is automatically provided - no parameters needed.`,\n      schema: z.object({}),\n    }\n  );\n\n  return [updateProfileTool, makeModificationTool, getWorkoutTool];\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAeO,SAAS,gBACd,IAAY,EACZ,WAAmB,EACnB,QAAmC,EACnC,aAAiD;IAEjD,OAAO,IAAA,iYAAI,EACT,OAAO;QACL,0CAA0C;QAC1C,IAAI,KAAK,OAAO,EAAE;YAChB,IAAI;gBACF,MAAM,cAAc,KAAK,OAAO;gBAChC,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,KAAK,OAAO,EAAE;YACvD,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,qCAAqC;YACrD;QACF;QACA,OAAO;IACT,GACA;QACE;QACA;QACA,QAAQ,0MAAC,CAAC,MAAM,CAAC;YACf,SAAS,0MAAC,CAAC,MAAM,GAAG,QAAQ,CAC1B;QAEJ;IACF;AAEJ;AAoCO,MAAM,kBAAkB,CAC7B,SACA,MACA;IAEA,gFAAgF;IAChF,MAAM,oBAAoB,IAAA,iYAAI,EAC5B;QACE,OAAO,KAAK,aAAa,CAAC,QAAQ,MAAM,EAAE,QAAQ,OAAO,EAAE,QAAQ,gBAAgB;IACrF,GACA;QACE,MAAM;QACN,aAAa,CAAC;;;;;;;;;;;;;;;6DAeyC,CAAC;QACxD,QAAQ,0MAAC,CAAC,MAAM,CAAC,CAAC;IACpB;IAGF,4BAA4B;IAC5B,MAAM,uBAAuB,gBAC3B,qBACA,CAAC;;;;;;;;yFAQoF,CAAC,EACtF;QACE,OAAO,KAAK,gBAAgB,CAAC,QAAQ,MAAM,EAAE,QAAQ,OAAO,EAAE,QAAQ,gBAAgB;IACxF,GACA;IAGF,sBAAsB;IACtB,MAAM,iBAAiB,IAAA,iYAAI,EACzB;QACE,OAAO,KAAK,UAAU,CAAC,QAAQ,MAAM,EAAE,QAAQ,QAAQ;IACzD,GACA;QACE,MAAM;QACN,aAAa,CAAC;;;;;;;;;;;;;;;6DAeyC,CAAC;QACxD,QAAQ,0MAAC,CAAC,MAAM,CAAC,CAAC;IACpB;IAGF,OAAO;QAAC;QAAmB;QAAsB;KAAe;AAClE"}},
    {"offset": {"line": 11653, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/agents/chat/index.ts"],"sourcesContent":["import { UserWithProfile } from '@/server/models/user';\nimport { createAgent, PROMPT_IDS, type Message as AgentMessage } from '@/server/agents';\nimport { messageService } from '../../messaging/messageService';\nimport { workoutInstanceService } from '../../training/workoutInstanceService';\nimport { ProfileService } from '../profile';\nimport { ModificationService } from '../modifications';\nimport { userService } from '../../user/userService';\nimport { now } from '@/shared/utils/date';\nimport { createChatTools } from './tools';\nimport { ContextService, ContextType } from '@/server/services/context';\nimport { ConversationFlowBuilder } from '@/server/services/flows/conversationFlowBuilder';\nimport type { ToolResult } from '../types/shared';\nimport { getChatConfig } from '@/shared/config';\nimport { getEnvironmentSettings } from '@/server/config';\n\n// Configuration from shared config\nconst { smsMaxLength: SMS_MAX_LENGTH, contextMinutes: CHAT_CONTEXT_MINUTES } = getChatConfig();\n\n/**\n * Get or generate today's workout for a user.\n * Returns a ToolResult with the workout message in the messages array.\n */\nasync function getWorkoutForToday(userId: string, timezone: string): Promise<ToolResult> {\n  try {\n    const today = now(timezone);\n    const todayDate = today.toJSDate();\n\n    // Check if workout already exists\n    const existingWorkout = await workoutInstanceService.getWorkoutByUserIdAndDate(userId, todayDate);\n\n    if (existingWorkout) {\n      // Workout exists - return its message\n      console.log('[ChatService] Existing workout found for today');\n      return {\n        toolType: 'query',\n        response: `User's workout for today: ${existingWorkout.sessionType || 'Workout'} - ${existingWorkout.description || 'Custom workout'}`,\n        messages: existingWorkout.message ? [existingWorkout.message] : undefined,\n      };\n    }\n\n    // No workout - need to generate one\n    // Fetch user with profile for generation\n    const user = await userService.getUser(userId);\n    if (!user) {\n      return { toolType: 'query', response: 'User not found.' };\n    }\n\n    // Generate the workout\n    console.log('[ChatService] Generating workout for today');\n    const generatedWorkout = await workoutInstanceService.generateWorkoutForDate(user, today);\n\n    if (!generatedWorkout) {\n      return {\n        toolType: 'query',\n        response: 'No workout scheduled for today. This could be a rest day based on the training plan, or the user may not have a fitness plan yet.',\n      };\n    }\n\n    return {\n      toolType: 'query',\n      response: `User's workout for today: ${generatedWorkout.sessionType || 'Workout'} - ${generatedWorkout.description || 'Custom workout'}`,\n      messages: generatedWorkout.message ? [generatedWorkout.message] : undefined,\n    };\n  } catch (error) {\n    console.error('[ChatService] Error getting/generating workout:', error);\n    return {\n      toolType: 'query',\n      response: `Failed to get workout: ${error instanceof Error ? error.message : 'Unknown error'}`,\n    };\n  }\n}\n\n/**\n * ChatService handles incoming SMS messages and generates AI-powered responses.\n *\n * This service orchestrates the chat agent which operates in an agentic loop:\n * - Agent decides when to call tools (update_profile, make_modification, get_workout)\n * - Tool priority ensures update_profile runs first when called with other tools\n * - Agent generates a final conversational response\n * - Tool messages are accumulated and sent after the agent's response\n *\n * The service ensures that:\n * - Agent autonomously decides when profile updates are needed\n * - Modifications happen when the agent decides to call make_modification\n * - Conversation history and context are properly maintained\n * - SMS length constraints are enforced\n */\nexport class ChatService {\n\n  /**\n   * Processes pending inbound SMS messages using the two-agent architecture.\n   *\n   * @param user - The user object with their profile information\n   * @returns A promise that resolves to an array of response messages (empty if no pending messages)\n   *\n   * @remarks\n   * This method performs a single DB fetch and splits messages into:\n   * - pending: inbound messages after the last outbound (to be processed)\n   * - context: conversation history up to and including the last outbound\n   *\n   * This architecture ensures:\n   * - No race conditions from multiple DB fetches\n   * - Profile information is always current\n   * - Proper acknowledgment of profile updates in responses\n   * - Support for multiple messages (e.g., week update + workout message)\n   *\n   * @example\n   * ```typescript\n   * const messages = await ChatService.handleIncomingMessage(user);\n   * // Returns [] if no pending messages, otherwise generates responses\n   * ```\n   */\n  static async handleIncomingMessage(\n    user: UserWithProfile\n  ): Promise<string[]> {\n    try {\n      // Single DB fetch: get enough messages for pending + context window\n      // We fetch extra to ensure we have enough context after splitting\n      const allMessages = await messageService.getRecentMessages(\n        user.id,\n        20\n      );\n\n      // Split into pending (needs response) and context (conversation history)\n      const { pending, context } = messageService.splitMessages(allMessages, CHAT_CONTEXT_MINUTES);\n\n      // Early return if no pending messages\n      if (pending.length === 0) {\n        console.log('[ChatService] No pending messages, skipping');\n        return [];\n      }\n\n      // Aggregate pending message content\n      const message = pending.map(m => m.content).join('\\n\\n');\n\n      console.log('[ChatService] Processing pending messages:', {\n        pendingCount: pending.length,\n        contextCount: context.length,\n        aggregatedContent: message.substring(0, 100) + (message.length > 100 ? '...' : '')\n      });\n\n      // Fetch user with profile (if not already included)\n      const userWithProfile = user.profile !== undefined\n        ? user\n        : await userService.getUser(user.id) || user;\n\n              // Callback for sending immediate messages\n      const onSendMessage = async (immediateMessage: string) => {\n        try {\n          await messageService.sendMessage(userWithProfile, immediateMessage);\n          console.log('[ChatService] Sent immediate message:', immediateMessage);\n        } catch (error) {\n          console.error('[ChatService] Failed to send immediate message:', error);\n          // Don't throw - continue with tool execution\n        }\n      };\n\n      // Create tools using the factory function\n      // Tool priority: update_profile (1) > get_workout (2) > make_modification (3)\n      const tools = createChatTools(\n        {\n          userId: userWithProfile.id,\n          message,\n          previousMessages: context,\n          timezone: userWithProfile.timezone,\n        },\n        {\n          makeModification: ModificationService.makeModification,\n          getWorkout: getWorkoutForToday,\n          updateProfile: ProfileService.updateProfile,\n        },\n        onSendMessage,\n      );\n\n\n      // Build context using ContextService\n      const agentContext = await ContextService.getInstance().getContext(\n        userWithProfile,\n        [ContextType.DATE_CONTEXT, ContextType.CURRENT_WORKOUT]\n      );\n\n      // Convert previous messages to Message format for the configurable agent\n      const previousMsgs: AgentMessage[] = ConversationFlowBuilder.toMessageArray(context || [])\n        .map(m => ({\n          role: m.role as 'user' | 'assistant',\n          content: m.content,\n        }));\n\n      // Create chat agent - prompts fetched from DB based on agent name\n      const agent = await createAgent({\n        name: PROMPT_IDS.CHAT_GENERATE,\n        context: agentContext,\n        previousMessages: previousMsgs,\n        tools,\n      });\n\n      // Invoke the chat agent - it will decide when to call tools (including update_profile)\n      const result = await agent.invoke(message);\n\n      console.log(`[ChatService] Agent completed with response length: ${result.response.length}, accumulated messages: ${result.messages?.length || 0}`);\n\n      // Map to ChatOutput format\n      // Order: [agent's final response, ...accumulated tool messages]\n      const messages = [result.response, ...(result.messages || [])].filter(m => m && m.trim());\n\n      if (!messages || messages.length === 0) {\n        throw new Error('Chat agent returned no messages');\n      }\n\n      // Enforce SMS length constraints on each message\n      const validatedMessages = messages\n        .filter((msg: string) => msg && msg.trim())\n        .map((msg: string) => {\n          const trimmed = msg.trim();\n          if (trimmed.length > SMS_MAX_LENGTH) {\n            return trimmed.substring(0, SMS_MAX_LENGTH - 3) + '...';\n          }\n          return trimmed;\n        });\n\n      return validatedMessages;\n\n    } catch (error) {\n      console.error('[ChatService] Error handling message:', error);\n\n      // Log additional context in development\n      if (getEnvironmentSettings().isDevelopment) {\n        console.error('Error details:', {\n          userId: user.id,\n          error: error instanceof Error ? error.stack : error\n        });\n      }\n\n      // Return a helpful fallback message\n      return [\"Sorry, I'm having trouble processing that. Try asking about your workout or fitness goals!\"];\n    }\n  }\n}\n\n// Re-export tools for external use\nexport { createChatTools } from './tools';\nexport type { ChatToolContext, ChatToolDeps } from './tools';\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 11866, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/messageQueueRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\nimport type { MessageQueues } from '@/server/models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type MessageQueue = Selectable<MessageQueues>;\nexport type NewMessageQueue = Insertable<MessageQueues>;\nexport type MessageQueueUpdate = Updateable<MessageQueues>;\n\nexport class MessageQueueRepository extends BaseRepository {\n  /**\n   * Create a new queue entry\n   */\n  async create(queueEntry: NewMessageQueue): Promise<MessageQueue> {\n    return await this.db\n      .insertInto('messageQueues')\n      .values(queueEntry)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Bulk insert multiple queue entries\n   */\n  async createMany(queueEntries: NewMessageQueue[]): Promise<MessageQueue[]> {\n    if (queueEntries.length === 0) return [];\n\n    return await this.db\n      .insertInto('messageQueues')\n      .values(queueEntries)\n      .returningAll()\n      .execute();\n  }\n\n  /**\n   * Find queue entry by ID\n   */\n  async findById(id: string): Promise<MessageQueue | undefined> {\n    return await this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n  }\n\n  /**\n   * Find queue entry by message ID (for webhook lookups)\n   */\n  async findByMessageId(messageId: string): Promise<MessageQueue | undefined> {\n    return await this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('messageId', '=', messageId)\n      .executeTakeFirst();\n  }\n\n  /**\n   * Find all pending entries for a client's queue, ordered by sequence\n   */\n  async findPendingByClient(\n    clientId: string,\n    queueName: string\n  ): Promise<MessageQueue[]> {\n    return await this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('queueName', '=', queueName)\n      .where('status', '=', 'pending')\n      .orderBy('sequenceNumber', 'asc')\n      .execute();\n  }\n\n  /**\n   * Find all pending queue items globally for admin view\n   */\n  async findAllPending(params: {\n    limit?: number;\n    offset?: number;\n    clientId?: string;\n  }): Promise<MessageQueue[]> {\n    let query = this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('status', '=', 'pending');\n\n    if (params.clientId) {\n      query = query.where('clientId', '=', params.clientId);\n    }\n\n    return await query\n      .orderBy('createdAt', 'desc')\n      .limit(params.limit || 100)\n      .offset(params.offset || 0)\n      .execute();\n  }\n\n  /**\n   * Find all pending queue items with user info for admin view\n   */\n  async findAllPendingWithUserInfo(params: {\n    limit?: number;\n    clientId?: string;\n  }): Promise<(MessageQueue & { userName: string | null; userPhone: string })[]> {\n    let query = this.db\n      .selectFrom('messageQueues')\n      .innerJoin('users', 'users.id', 'messageQueues.clientId')\n      .select([\n        'messageQueues.id',\n        'messageQueues.clientId',\n        'messageQueues.queueName',\n        'messageQueues.sequenceNumber',\n        'messageQueues.messageContent',\n        'messageQueues.mediaUrls',\n        'messageQueues.status',\n        'messageQueues.messageId',\n        'messageQueues.retryCount',\n        'messageQueues.maxRetries',\n        'messageQueues.timeoutMinutes',\n        'messageQueues.errorMessage',\n        'messageQueues.createdAt',\n        'messageQueues.sentAt',\n        'messageQueues.deliveredAt',\n        'users.name as userName',\n        'users.phoneNumber as userPhone',\n      ])\n      .where('messageQueues.status', '=', 'pending');\n\n    if (params.clientId) {\n      query = query.where('messageQueues.clientId', '=', params.clientId);\n    }\n\n    const results = await query\n      .orderBy('messageQueues.createdAt', 'desc')\n      .limit(params.limit || 100)\n      .execute();\n\n    return results as (MessageQueue & { userName: string | null; userPhone: string })[];\n  }\n\n  /**\n   * Find the next pending message in a queue\n   */\n  async findNextPending(\n    clientId: string,\n    queueName: string\n  ): Promise<MessageQueue | undefined> {\n    return await this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('queueName', '=', queueName)\n      .where('status', '=', 'pending')\n      .orderBy('sequenceNumber', 'asc')\n      .limit(1)\n      .executeTakeFirst();\n  }\n\n  /**\n   * Find stalled messages (sent but not delivered/failed after timeout)\n   */\n  async findStalled(cutoffDate: Date): Promise<MessageQueue[]> {\n    return await this.db\n      .selectFrom('messageQueues')\n      .selectAll()\n      .where('status', '=', 'sent')\n      .where('sentAt', '<', cutoffDate)\n      .execute();\n  }\n\n  /**\n   * Update queue entry status\n   */\n  async updateStatus(\n    id: string,\n    status: 'pending' | 'sent' | 'delivered' | 'failed',\n    timestamps?: { sentAt?: Date; deliveredAt?: Date },\n    error?: string\n  ): Promise<MessageQueue> {\n    return await this.db\n      .updateTable('messageQueues')\n      .set({\n        status,\n        ...(timestamps?.sentAt && { sentAt: timestamps.sentAt }),\n        ...(timestamps?.deliveredAt && { deliveredAt: timestamps.deliveredAt }),\n        ...(error && { errorMessage: error }),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Link a queue entry to a sent message\n   */\n  async linkMessage(id: string, messageId: string): Promise<MessageQueue> {\n    return await this.db\n      .updateTable('messageQueues')\n      .set({\n        messageId,\n        status: 'sent',\n        sentAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Increment retry count\n   */\n  async incrementRetry(id: string): Promise<MessageQueue> {\n    const entry = await this.findById(id);\n    if (!entry) {\n      throw new Error(`Queue entry ${id} not found`);\n    }\n\n    return await this.db\n      .updateTable('messageQueues')\n      .set({\n        retryCount: entry.retryCount + 1,\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Delete completed/failed queue entries for cleanup\n   */\n  async deleteCompleted(clientId: string, queueName: string): Promise<void> {\n    await this.db\n      .deleteFrom('messageQueues')\n      .where('clientId', '=', clientId)\n      .where('queueName', '=', queueName)\n      .where('status', 'in', ['delivered', 'failed'])\n      .execute();\n  }\n\n  /**\n   * Get queue status summary\n   */\n  async getQueueStatus(clientId: string, queueName: string): Promise<{\n    total: number;\n    pending: number;\n    sent: number;\n    delivered: number;\n    failed: number;\n  }> {\n    const entries = await this.db\n      .selectFrom('messageQueues')\n      .select(['status'])\n      .where('clientId', '=', clientId)\n      .where('queueName', '=', queueName)\n      .execute();\n\n    return {\n      total: entries.length,\n      pending: entries.filter(e => e.status === 'pending').length,\n      sent: entries.filter(e => e.status === 'sent').length,\n      delivered: entries.filter(e => e.status === 'delivered').length,\n      failed: entries.filter(e => e.status === 'failed').length,\n    };\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12009, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/messaging/messageQueueService.ts"],"sourcesContent":["import { MessageQueueRepository } from '@/server/repositories/messageQueueRepository';\nimport { postgresDb } from '@/server/connections/postgres/postgres';\nimport { Message } from '@/server/models/conversation';\nimport { inngest } from '@/server/connections/inngest/client';\nimport { twilioClient } from '@/server/connections/twilio/twilio';\n\n/**\n * Represents a message to be queued\n */\nexport interface QueuedMessage {\n  /** Optional text content */\n  content?: string;\n  /** Optional media URLs for MMS */\n  mediaUrls?: string[];\n}\n\n/**\n * MessageQueueService\n *\n * Manages ordered message delivery for users. Ensures messages are sent\n * sequentially and only after the previous message has been delivered.\n *\n * Key Features:\n * - Per-user, per-queue message ordering\n * - Waits for Twilio delivery webhooks before sending next message\n * - Automatic retry on failure (up to max retries)\n * - Timeout detection and recovery for stalled messages\n *\n * Usage:\n * 1. Enqueue messages: enqueueMessages(userId, messages, queueName)\n * 2. Webhook triggers delivery confirmation: markMessageDelivered(messageId)\n * 3. Service automatically sends next message in queue\n */\nexport class MessageQueueService {\n  private static instance: MessageQueueService;\n  private messageQueueRepo: MessageQueueRepository;\n\n  private constructor() {\n    this.messageQueueRepo = new MessageQueueRepository(postgresDb);\n  }\n\n  public static getInstance(): MessageQueueService {\n    if (!MessageQueueService.instance) {\n      MessageQueueService.instance = new MessageQueueService();\n    }\n    return MessageQueueService.instance;\n  }\n\n  /**\n   * Enqueue multiple messages for ordered delivery\n   *\n   * Creates queue entries and immediately starts sending the first message.\n   * Subsequent messages will be sent after previous ones are delivered.\n   *\n   * @param clientId - Client to send messages to\n   * @param messages - Array of messages to queue\n   * @param queueName - Named queue (e.g., 'daily', 'onboarding')\n   * @returns Array of created queue entries\n   */\n  async enqueueMessages(\n    clientId: string,\n    messages: QueuedMessage[],\n    queueName: string\n  ): Promise<void> {\n    if (messages.length === 0) return;\n\n    console.log(`[MessageQueueService] Enqueueing ${messages.length} messages for client ${clientId} in queue '${queueName}'`);\n\n    // Create queue entries with sequence numbers\n    const queueEntries = messages.map((msg, index) => ({\n      clientId,\n      queueName,\n      sequenceNumber: index + 1,\n      messageContent: msg.content || null,\n      // Stringify array for JSONB storage (Kysely will handle the JSONB insert)\n      mediaUrls: msg.mediaUrls ? JSON.stringify(msg.mediaUrls) : null,\n      status: 'pending' as const,\n    }));\n\n    // Bulk insert all queue entries\n    await this.messageQueueRepo.createMany(queueEntries);\n\n    console.log(`[MessageQueueService] Created ${queueEntries.length} queue entries`);\n\n    // Trigger processing of the first message via Inngest\n    await inngest.send({\n      name: 'message-queue/process-next',\n      data: {\n        clientId,\n        queueName,\n      },\n    });\n  }\n\n  /**\n   * Process the next pending message in a queue\n   *\n   * Sends the next message via MessageService and updates queue status.\n   * Called by Inngest when the previous message is delivered.\n   *\n   * @param clientId - Client ID\n   * @param queueName - Queue name\n   */\n  async processNextMessage(clientId: string, queueName: string): Promise<void> {\n    console.log(`[MessageQueueService] Processing next message for client ${clientId} in queue '${queueName}'`);\n\n    // Get next pending message\n    const nextEntry = await this.messageQueueRepo.findNextPending(clientId, queueName);\n\n    if (!nextEntry) {\n      console.log(`[MessageQueueService] No more pending messages in queue '${queueName}' for client ${clientId}`);\n      // Optionally clean up completed queue\n      await this.clearQueue(clientId, queueName);\n      return;\n    }\n\n    console.log(`[MessageQueueService] Found next message (sequence ${nextEntry.sequenceNumber})`);\n\n    // Send via Inngest to handle actual message sending\n    await inngest.send({\n      name: 'message-queue/send-message',\n      data: {\n        queueEntryId: nextEntry.id,\n        clientId: nextEntry.clientId,\n        queueName: nextEntry.queueName,\n      },\n    });\n  }\n\n  /**\n   * Send a queued message\n   * Called by Inngest function to actually send the message\n   */\n  async sendQueuedMessage(queueEntryId: string): Promise<Message> {\n    const queueEntry = await this.messageQueueRepo.findById(queueEntryId);\n    if (!queueEntry) {\n      throw new Error(`Queue entry ${queueEntryId} not found`);\n    }\n\n    // Import MessageService here to avoid circular dependency\n    const { messageService } = await import('./messageService');\n    const { userService } = await import('../user/userService');\n\n    const user = await userService.getUser(queueEntry.clientId);\n    if (!user) {\n      throw new Error(`Client ${queueEntry.clientId} not found`);\n    }\n\n    // Get media URLs if present\n    // Handle both stringified JSON and already-parsed arrays\n    let mediaUrls: string[] | undefined;\n    if (queueEntry.mediaUrls) {\n      if (typeof queueEntry.mediaUrls === 'string') {\n        try {\n          mediaUrls = JSON.parse(queueEntry.mediaUrls);\n        } catch (error) {\n          console.error('[MessageQueueService] Failed to parse media URLs:', error);\n        }\n      } else {\n        mediaUrls = queueEntry.mediaUrls as string[];\n      }\n    }\n\n    // Send the message\n    console.log(`[MessageQueueService] Sending queued message ${queueEntryId}`);\n    const message = await messageService.sendMessage(\n      user,\n      queueEntry.messageContent || undefined,\n      mediaUrls\n    );\n\n    // Link the queue entry to the sent message\n    await this.messageQueueRepo.linkMessage(queueEntry.id, message.id);\n\n    console.log(`[MessageQueueService] Queued message sent successfully`, {\n      queueEntryId,\n      messageId: message.id,\n    });\n\n    return message;\n  }\n\n  /**\n   * Mark a message as delivered and trigger next message\n   *\n   * Called by Twilio webhook when message status is 'delivered'.\n   * Updates queue entry and triggers next message in queue.\n   *\n   * @param messageId - ID of the delivered message\n   */\n  async markMessageDelivered(messageId: string): Promise<void> {\n    const queueEntry = await this.messageQueueRepo.findByMessageId(messageId);\n\n    if (!queueEntry) {\n      console.log(`[MessageQueueService] No queue entry found for message ${messageId}`);\n      return;\n    }\n\n    console.log(`[MessageQueueService] Marking message ${messageId} as delivered`);\n\n    // Update status to delivered\n    await this.messageQueueRepo.updateStatus(\n      queueEntry.id,\n      'delivered',\n      { deliveredAt: new Date() }\n    );\n\n    // Trigger next message in queue via Inngest\n    await inngest.send({\n      name: 'message-queue/process-next',\n      data: {\n        clientId: queueEntry.clientId,\n        queueName: queueEntry.queueName,\n      },\n    });\n\n    console.log(`[MessageQueueService] Triggered next message for queue '${queueEntry.queueName}'`);\n  }\n\n  /**\n   * Mark a message as failed and optionally retry or move to next\n   *\n   * Called by Twilio webhook when message status is 'failed' or 'undelivered'.\n   * Retries if under max retries, otherwise marks failed and moves to next.\n   *\n   * @param messageId - ID of the failed message\n   * @param error - Error message from Twilio\n   */\n  async markMessageFailed(messageId: string, error?: string): Promise<void> {\n    const queueEntry = await this.messageQueueRepo.findByMessageId(messageId);\n\n    if (!queueEntry) {\n      console.log(`[MessageQueueService] No queue entry found for message ${messageId}`);\n      return;\n    }\n\n    console.log(`[MessageQueueService] Message ${messageId} failed:`, error);\n\n    // Check if we should retry\n    if (queueEntry.retryCount < queueEntry.maxRetries) {\n      console.log(`[MessageQueueService] Retrying message (attempt ${queueEntry.retryCount + 1}/${queueEntry.maxRetries})`);\n\n      // Increment retry count\n      await this.messageQueueRepo.incrementRetry(queueEntry.id);\n\n      // Reset to pending for retry\n      await this.messageQueueRepo.updateStatus(\n        queueEntry.id,\n        'pending',\n        undefined,\n        error\n      );\n\n      // Trigger retry via existing message retry mechanism\n      await inngest.send({\n        name: 'message/delivery-failed',\n        data: {\n          messageId,\n          clientId: queueEntry.clientId,\n          providerMessageId: messageId,\n          error: error || 'Unknown error',\n        },\n      });\n    } else {\n      console.log(`[MessageQueueService] Max retries reached, marking as failed and moving to next`);\n\n      // Mark as permanently failed\n      await this.messageQueueRepo.updateStatus(\n        queueEntry.id,\n        'failed',\n        undefined,\n        error || 'Max retries exceeded'\n      );\n\n      // Move to next message\n      await inngest.send({\n        name: 'message-queue/process-next',\n        data: {\n          clientId: queueEntry.clientId,\n          queueName: queueEntry.queueName,\n        },\n      });\n    }\n  }\n\n  /**\n   * Check for stalled messages and unblock queues\n   *\n   * Finds messages that have been in 'sent' status for longer than\n   * their timeout period. Verifies actual status with Twilio API.\n   *\n   * Called by scheduled Inngest cron job.\n   */\n  async checkStalledMessages(): Promise<void> {\n    // Find messages sent more than 10 minutes ago\n    const cutoffDate = new Date(Date.now() - 10 * 60 * 1000);\n    const stalledEntries = await this.messageQueueRepo.findStalled(cutoffDate);\n\n    if (stalledEntries.length === 0) {\n      console.log('[MessageQueueService] No stalled messages found');\n      return;\n    }\n\n    console.log(`[MessageQueueService] Found ${stalledEntries.length} stalled messages`);\n\n    for (const entry of stalledEntries) {\n      try {\n        if (!entry.messageId) {\n          console.warn(`[MessageQueueService] Stalled entry ${entry.id} has no messageId, marking as failed`);\n          await this.messageQueueRepo.updateStatus(entry.id, 'failed', undefined, 'No message ID found');\n          continue;\n        }\n\n        // Get the actual message to find provider message ID\n        const { messageService } = await import('./messageService');\n        const messageRepo = messageService['messageRepo'];\n        const message = await messageRepo.findById(entry.messageId);\n\n        if (!message || !message.providerMessageId) {\n          console.warn(`[MessageQueueService] Message ${entry.messageId} not found or has no provider ID`);\n          // Assume delivered to avoid blocking queue\n          await this.messageQueueRepo.updateStatus(entry.id, 'delivered', { deliveredAt: new Date() });\n          await this.processNextMessage(entry.clientId, entry.queueName);\n          continue;\n        }\n\n        // Check actual status via Twilio API\n        console.log(`[MessageQueueService] Checking Twilio status for ${message.providerMessageId}`);\n        const twilioMessage = await twilioClient.getMessageStatus(message.providerMessageId);\n\n        if (twilioMessage.status === 'delivered') {\n          console.log(`[MessageQueueService] Twilio confirms delivery, updating queue`);\n          await this.markMessageDelivered(entry.messageId);\n        } else if (twilioMessage.status === 'failed' || twilioMessage.status === 'undelivered') {\n          console.log(`[MessageQueueService] Twilio confirms failure, updating queue`);\n          await this.markMessageFailed(entry.messageId, `Stalled message status: ${twilioMessage.status}`);\n        } else {\n          // Still in transit, assume delivered to avoid blocking indefinitely\n          console.log(`[MessageQueueService] Message still in transit (${twilioMessage.status}), assuming delivered`);\n          await this.messageQueueRepo.updateStatus(entry.id, 'delivered', { deliveredAt: new Date() });\n          await this.processNextMessage(entry.clientId, entry.queueName);\n        }\n      } catch (error) {\n        console.error(`[MessageQueueService] Error checking stalled message ${entry.id}:`, error);\n        // Assume delivered to avoid blocking queue indefinitely\n        await this.messageQueueRepo.updateStatus(entry.id, 'delivered', { deliveredAt: new Date() });\n        await this.processNextMessage(entry.clientId, entry.queueName);\n      }\n    }\n  }\n\n  /**\n   * Get queue status for a client\n   */\n  async getQueueStatus(clientId: string, queueName: string) {\n    return await this.messageQueueRepo.getQueueStatus(clientId, queueName);\n  }\n\n  /**\n   * Clear completed/failed queue entries\n   */\n  async clearQueue(clientId: string, queueName: string): Promise<void> {\n    console.log(`[MessageQueueService] Clearing completed queue '${queueName}' for client ${clientId}`);\n    await this.messageQueueRepo.deleteCompleted(clientId, queueName);\n  }\n}\n\n// Export singleton instance\nexport const messageQueueService = MessageQueueService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12293, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/dayConfigRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport {\n  DayConfig,\n  NewDayConfig,\n  DayConfigUpdate,\n  DayConfigOptions,\n  DayConfigWithTypedConfig,\n} from '../models/dayConfig';\n\n/**\n * Repository for managing day configurations\n * Handles storage and retrieval of day-specific settings\n */\nexport class DayConfigRepository extends BaseRepository {\n  /**\n   * Get config for a specific date (global scope)\n   */\n  async getByDate(date: Date): Promise<DayConfigWithTypedConfig | null> {\n    const result = await this.db\n      .selectFrom('dayConfigs')\n      .selectAll()\n      .where('date', '=', date)\n      .where('scopeType', '=', 'global')\n      .where('scopeId', 'is', null)\n      .executeTakeFirst();\n\n    if (!result) return null;\n\n    return {\n      ...result,\n      config: (result.config || {}) as DayConfigOptions,\n    };\n  }\n\n  /**\n   * Get configs for a date range (for calendar view)\n   */\n  async getByDateRange(\n    startDate: Date,\n    endDate: Date\n  ): Promise<DayConfigWithTypedConfig[]> {\n    const results = await this.db\n      .selectFrom('dayConfigs')\n      .selectAll()\n      .where('date', '>=', startDate)\n      .where('date', '<=', endDate)\n      .where('scopeType', '=', 'global')\n      .where('scopeId', 'is', null)\n      .orderBy('date', 'asc')\n      .execute();\n\n    return results.map((result) => ({\n      ...result,\n      config: (result.config || {}) as DayConfigOptions,\n    }));\n  }\n\n  /**\n   * Create a new day config\n   */\n  async create(data: NewDayConfig): Promise<DayConfig> {\n    const result = await this.db\n      .insertInto('dayConfigs')\n      .values({\n        ...data,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Update an existing day config\n   */\n  async update(id: string, data: DayConfigUpdate): Promise<DayConfig> {\n    const result = await this.db\n      .updateTable('dayConfigs')\n      .set({\n        ...data,\n        updatedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Upsert a day config (create or update)\n   * For global scope, merges config with existing if present\n   */\n  async upsert(\n    date: Date,\n    config: DayConfigOptions,\n    scopeType: string = 'global',\n    scopeId: string | null = null\n  ): Promise<DayConfigWithTypedConfig> {\n    // Check if exists\n    const existing = await this.db\n      .selectFrom('dayConfigs')\n      .selectAll()\n      .where('date', '=', date)\n      .where('scopeType', '=', scopeType)\n      .where('scopeId', scopeId === null ? 'is' : '=', scopeId)\n      .executeTakeFirst();\n\n    if (existing) {\n      // Merge config with existing\n      const existingConfig = (existing.config || {}) as DayConfigOptions;\n      const mergedConfig = { ...existingConfig, ...config };\n\n      const result = await this.db\n        .updateTable('dayConfigs')\n        .set({\n          config: JSON.stringify(mergedConfig),\n          updatedAt: new Date(),\n        })\n        .where('id', '=', existing.id)\n        .returningAll()\n        .executeTakeFirstOrThrow();\n\n      return {\n        ...result,\n        config: mergedConfig,\n      };\n    }\n\n    // Create new\n    const result = await this.db\n      .insertInto('dayConfigs')\n      .values({\n        date,\n        scopeType,\n        scopeId,\n        config: JSON.stringify(config),\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return {\n      ...result,\n      config: config,\n    };\n  }\n\n  /**\n   * Delete config for a date\n   */\n  async deleteByDate(\n    date: Date,\n    scopeType: string = 'global',\n    scopeId: string | null = null\n  ): Promise<void> {\n    await this.db\n      .deleteFrom('dayConfigs')\n      .where('date', '=', date)\n      .where('scopeType', '=', scopeType)\n      .where('scopeId', scopeId === null ? 'is' : '=', scopeId)\n      .execute();\n  }\n\n  /**\n   * Delete config by ID\n   */\n  async deleteById(id: string): Promise<void> {\n    await this.db.deleteFrom('dayConfigs').where('id', '=', id).execute();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12389, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/uploadedImageRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { UploadedImage, NewUploadedImage } from '../models/uploadedImage';\n\n/**\n * Repository for managing uploaded images\n * Handles storage and retrieval of image library entries\n */\nexport class UploadedImageRepository extends BaseRepository {\n  /**\n   * List all images with optional filtering\n   */\n  async list(options?: {\n    category?: string;\n    limit?: number;\n  }): Promise<UploadedImage[]> {\n    let query = this.db\n      .selectFrom('uploadedImages')\n      .selectAll()\n      .orderBy('createdAt', 'desc');\n\n    if (options?.category) {\n      query = query.where('category', '=', options.category);\n    }\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    return query.execute();\n  }\n\n  /**\n   * Get an image by ID\n   */\n  async getById(id: string): Promise<UploadedImage | null> {\n    const result = await this.db\n      .selectFrom('uploadedImages')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Find an image by URL\n   */\n  async findByUrl(url: string): Promise<UploadedImage | null> {\n    const result = await this.db\n      .selectFrom('uploadedImages')\n      .selectAll()\n      .where('url', '=', url)\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Create a new image record\n   */\n  async create(image: NewUploadedImage): Promise<UploadedImage> {\n    const result = await this.db\n      .insertInto('uploadedImages')\n      .values({\n        ...image,\n        createdAt: new Date(),\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Update an image's metadata\n   */\n  async update(\n    id: string,\n    data: Partial<Pick<UploadedImage, 'displayName' | 'category' | 'tags'>>\n  ): Promise<UploadedImage> {\n    const result = await this.db\n      .updateTable('uploadedImages')\n      .set(data)\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Delete an image by ID\n   */\n  async delete(id: string): Promise<void> {\n    await this.db.deleteFrom('uploadedImages').where('id', '=', id).execute();\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,gCAAgC,yLAAc;IACzD;;GAEC,GACD,MAAM,KAAK,OAGV,EAA4B;QAC3B,IAAI,QAAQ,IAAI,CAAC,EAAE,CAChB,UAAU,CAAC,kBACX,SAAS,GACT,OAAO,CAAC,aAAa;QAExB,IAAI,SAAS,UAAU;YACrB,QAAQ,MAAM,KAAK,CAAC,YAAY,KAAK,QAAQ,QAAQ;QACvD;QAEA,IAAI,SAAS,OAAO;YAClB,QAAQ,MAAM,KAAK,CAAC,QAAQ,KAAK;QACnC;QAEA,OAAO,MAAM,OAAO;IACtB;IAEA;;GAEC,GACD,MAAM,QAAQ,EAAU,EAAiC;QACvD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,SAAS,GACT,KAAK,CAAC,MAAM,KAAK,IACjB,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;GAEC,GACD,MAAM,UAAU,GAAW,EAAiC;QAC1D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,SAAS,GACT,KAAK,CAAC,OAAO,KAAK,KAClB,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;GAEC,GACD,MAAM,OAAO,KAAuB,EAA0B;QAC5D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,MAAM,CAAC;YACN,GAAG,KAAK;YACR,WAAW,IAAI;QACjB,GACC,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,OACJ,EAAU,EACV,IAAuE,EAC/C;QACxB,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,WAAW,CAAC,kBACZ,GAAG,CAAC,MACJ,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,OAAO,EAAU,EAAiB;QACtC,MAAM,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,kBAAkB,KAAK,CAAC,MAAM,KAAK,IAAI,OAAO;IACzE;AACF"}},
    {"offset": {"line": 12511, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/connections/storage/storage.ts"],"sourcesContent":["import { put, del, list, head } from \"@vercel/blob\";\n\n/**\n * Upload an image to Vercel Blob storage\n * @param filename - Name for the file (will be prefixed with path)\n * @param data - File data as Buffer, Blob, or base64 string\n * @param options - Optional upload configuration\n * @returns URL of the uploaded blob\n */\nexport async function uploadImage(\n  filename: string,\n  data: Buffer | Blob | string,\n  options?: {\n    folder?: string;\n    contentType?: string;\n  }\n): Promise<string> {\n  const path = options?.folder ? `${options.folder}/${filename}` : filename;\n\n  // Convert base64 string to Buffer if needed\n  const content = typeof data === \"string\"\n    ? Buffer.from(data, \"base64\")\n    : data;\n\n  const blob = await put(path, content, {\n    access: \"public\",\n    contentType: options?.contentType ?? \"image/png\",\n  });\n\n  return blob.url;\n}\n\n/**\n * Delete a file by URL\n */\nexport async function deleteFile(url: string): Promise<void> {\n  await del(url);\n}\n\n/**\n * List files with optional prefix filter\n */\nexport async function listFiles(prefix?: string) {\n  return list({ prefix });\n}\n\n/**\n * Get file metadata by URL\n */\nexport async function getFileMetadata(url: string) {\n  return head(url);\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AASO,eAAe,YACpB,QAAgB,EAChB,IAA4B,EAC5B,OAGC;IAED,MAAM,OAAO,SAAS,SAAS,GAAG,QAAQ,MAAM,CAAC,CAAC,EAAE,UAAU,GAAG;IAEjE,4CAA4C;IAC5C,MAAM,UAAU,OAAO,SAAS,WAC5B,OAAO,IAAI,CAAC,MAAM,YAClB;IAEJ,MAAM,OAAO,MAAM,IAAA,uOAAG,EAAC,MAAM,SAAS;QACpC,QAAQ;QACR,aAAa,SAAS,eAAe;IACvC;IAEA,OAAO,KAAK,GAAG;AACjB;AAKO,eAAe,WAAW,GAAW;IAC1C,MAAM,IAAA,uOAAG,EAAC;AACZ;AAKO,eAAe,UAAU,MAAe;IAC7C,OAAO,IAAA,wOAAI,EAAC;QAAE;IAAO;AACvB;AAKO,eAAe,gBAAgB,GAAW;IAC/C,OAAO,IAAA,wOAAI,EAAC;AACd"}},
    {"offset": {"line": 12548, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/calendar/dayConfigService.ts"],"sourcesContent":["import { DayConfigRepository } from '@/server/repositories/dayConfigRepository';\nimport { UploadedImageRepository } from '@/server/repositories/uploadedImageRepository';\nimport {\n  uploadImage as uploadToBlob,\n  deleteFile as deleteFromBlob,\n} from '@/server/connections/storage/storage';\nimport {\n  DayConfigOptions,\n  DayConfigWithTypedConfig,\n} from '@/server/models/dayConfig';\nimport { UploadedImage, NewUploadedImage } from '@/server/models/uploadedImage';\n\n/**\n * DayConfigService\n *\n * Manages day-specific configurations (images, themes, etc.) for the calendar.\n * Configurations can be global (apply to all users) or scoped to specific users/groups.\n * Also manages the image library for uploaded images.\n */\nexport class DayConfigService {\n  private static instance: DayConfigService;\n  private dayConfigRepo: DayConfigRepository;\n  private imageRepo: UploadedImageRepository;\n\n  private constructor() {\n    this.dayConfigRepo = new DayConfigRepository();\n    this.imageRepo = new UploadedImageRepository();\n  }\n\n  public static getInstance(): DayConfigService {\n    if (!DayConfigService.instance) {\n      DayConfigService.instance = new DayConfigService();\n    }\n    return DayConfigService.instance;\n  }\n\n  // =====================\n  // Day Config Methods\n  // =====================\n\n  /**\n   * Get config for a specific date (global scope)\n   */\n  async getConfigForDate(date: Date): Promise<DayConfigWithTypedConfig | null> {\n    return this.dayConfigRepo.getByDate(date);\n  }\n\n  /**\n   * Get configs for a month (for calendar view)\n   * Returns all global configs for the specified month\n   */\n  async getConfigsForMonth(\n    year: number,\n    month: number\n  ): Promise<DayConfigWithTypedConfig[]> {\n    const startDate = new Date(year, month - 1, 1);\n    const endDate = new Date(year, month, 0); // Last day of month\n    return this.dayConfigRepo.getByDateRange(startDate, endDate);\n  }\n\n  /**\n   * Upsert config for a date (merges with existing config)\n   */\n  async upsertConfig(\n    date: Date,\n    config: Partial<DayConfigOptions>\n  ): Promise<DayConfigWithTypedConfig> {\n    return this.dayConfigRepo.upsert(date, config);\n  }\n\n  /**\n   * Set image for a specific date\n   */\n  async setDayImage(\n    date: Date,\n    imageUrl: string,\n    imageName?: string\n  ): Promise<DayConfigWithTypedConfig> {\n    return this.dayConfigRepo.upsert(date, {\n      imageUrl,\n      imageName: imageName ?? undefined,\n    });\n  }\n\n  /**\n   * Clear config for a date (removes entire config)\n   */\n  async clearConfig(date: Date): Promise<void> {\n    return this.dayConfigRepo.deleteByDate(date);\n  }\n\n  /**\n   * Get image URL for a date (used by daily message service)\n   * Returns null if no custom image is set\n   */\n  async getImageUrlForDate(date: Date): Promise<string | null> {\n    const config = await this.dayConfigRepo.getByDate(date);\n    return config?.config?.imageUrl ?? null;\n  }\n\n  // =====================\n  // Image Library Methods\n  // =====================\n\n  /**\n   * Upload a new image to the library\n   */\n  async uploadImage(\n    file: Buffer | Blob,\n    filename: string,\n    contentType: string,\n    options?: {\n      category?: string;\n      displayName?: string;\n      uploadedBy?: string;\n    }\n  ): Promise<UploadedImage> {\n    // Generate unique filename with timestamp\n    const timestamp = Date.now();\n    const uniqueFilename = `${timestamp}-${filename}`;\n\n    // Upload to Vercel Blob\n    const url = await uploadToBlob(uniqueFilename, file, {\n      folder: 'day-images',\n      contentType,\n    });\n\n    // Store metadata in DB\n    const imageData: NewUploadedImage = {\n      url,\n      filename,\n      displayName: options?.displayName ?? filename.replace(/\\.[^/.]+$/, ''),\n      contentType,\n      sizeBytes: file instanceof Buffer ? file.length : 0,\n      category: options?.category ?? 'general',\n      uploadedBy: options?.uploadedBy ?? null,\n    };\n\n    return this.imageRepo.create(imageData);\n  }\n\n  /**\n   * Get image library with optional category filter\n   */\n  async getImageLibrary(category?: string): Promise<UploadedImage[]> {\n    return this.imageRepo.list({ category });\n  }\n\n  /**\n   * Get an image by ID\n   */\n  async getImageById(id: string): Promise<UploadedImage | null> {\n    return this.imageRepo.getById(id);\n  }\n\n  /**\n   * Delete an image from the library\n   * Also removes from Vercel Blob storage\n   */\n  async deleteImage(id: string): Promise<void> {\n    const image = await this.imageRepo.getById(id);\n    if (!image) {\n      return;\n    }\n\n    // Delete from Vercel Blob\n    try {\n      await deleteFromBlob(image.url);\n    } catch (error) {\n      console.error(\n        `[DayConfigService] Failed to delete blob ${image.url}:`,\n        error\n      );\n      // Continue with DB deletion even if blob deletion fails\n    }\n\n    // Delete from DB\n    await this.imageRepo.delete(id);\n  }\n\n  /**\n   * Update image metadata\n   */\n  async updateImageMetadata(\n    id: string,\n    data: Partial<Pick<UploadedImage, 'displayName' | 'category'>>\n  ): Promise<UploadedImage> {\n    return this.imageRepo.update(id, data);\n  }\n}\n\nexport const dayConfigService = DayConfigService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12682, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/orchestration/dailyMessageService.ts"],"sourcesContent":["import { MessageService } from '../messaging/messageService';\nimport { UserService } from '../user/userService';\nimport { UserWithProfile } from '@/server/models/user';\nimport { WorkoutInstance } from '@/server/models/workout';\nimport { DateTime } from 'luxon';\nimport { now } from '@/shared/utils/date';\nimport { WorkoutInstanceService } from '../training/workoutInstanceService';\nimport { WorkoutInstanceRepository } from '@/server/repositories/workoutInstanceRepository';\nimport { inngest } from '@/server/connections/inngest/client';\nimport { messageQueueService, type QueuedMessage } from '../messaging/messageQueueService';\nimport { getUrlsConfig } from '@/shared/config';\nimport { dayConfigService } from '../calendar/dayConfigService';\n\ninterface MessageResult {\n  success: boolean;\n  userId: string;\n  error?: string;\n  messageId?: string;\n}\n\ninterface SchedulingResult {\n  scheduled: number;\n  failed: number;\n  duration: number;\n  errors: Array<{ userId: string; error: string }>;\n}\n\nexport class DailyMessageService {\n  private static instance: DailyMessageService;\n  private userService: UserService;\n  private workoutInstanceService: WorkoutInstanceService;\n  private workoutInstanceRepository: WorkoutInstanceRepository;\n  private messageService: MessageService;\n  private batchSize: number;\n\n  private constructor(batchSize: number = 10) {\n    this.userService = UserService.getInstance();\n    this.workoutInstanceService = WorkoutInstanceService.getInstance();\n    this.workoutInstanceRepository = new WorkoutInstanceRepository();\n    this.messageService = MessageService.getInstance();\n    this.batchSize = batchSize;\n  }\n\n  public static getInstance(batchSize: number = 10): DailyMessageService {\n    if (!DailyMessageService.instance) {\n      DailyMessageService.instance = new DailyMessageService(batchSize);\n    }\n    return DailyMessageService.instance;\n  }\n\n  /**\n   * Schedules daily messages for all users in a given UTC hour\n   * Returns metrics about the scheduling operation\n   *\n   * This method uses catch-up logic: it schedules messages for users whose\n   * preferred send hour has already passed today AND who haven't received\n   * their workout message yet (no workout instance exists for today).\n   */\n  public async scheduleMessagesForHour(utcHour: number): Promise<SchedulingResult> {\n    const startTime = Date.now();\n    const errors: Array<{ userId: string; error: string }> = [];\n    let scheduled = 0;\n    let failed = 0;\n\n    try {\n      // Get candidate users (those whose local hour >= preferredSendHour)\n      const candidateUsers = await this.userService.getUsersForHour(utcHour);\n      console.log(`[DailyMessageService] Found ${candidateUsers.length} candidate users for hour ${utcHour}`);\n\n      if (candidateUsers.length === 0) {\n        return {\n          scheduled: 0,\n          failed: 0,\n          duration: Date.now() - startTime,\n          errors: []\n        };\n      }\n\n      // Build user-specific date ranges (each user's \"today\" based on their timezone)\n      const userDatePairs = candidateUsers.map(user => {\n        const todayStart = now(user.timezone).startOf('day').toJSDate();\n        const todayEnd = now(user.timezone).startOf('day').plus({ days: 1 }).toJSDate();\n        return { userId: user.id, startOfDay: todayStart, endOfDay: todayEnd };\n      });\n\n      // Batch-check which users already have workouts for their \"today\"\n      const userIdsWithWorkouts = await this.workoutInstanceRepository\n        .findUserIdsWithWorkoutsForUserDates(userDatePairs);\n\n      // Filter to only users WITHOUT workouts (they haven't been sent yet)\n      const usersToSchedule = candidateUsers.filter(\n        u => !userIdsWithWorkouts.has(u.id)\n      );\n\n      console.log(`[DailyMessageService] ${userIdsWithWorkouts.size} users already have workouts, scheduling ${usersToSchedule.length} users`);\n\n      if (usersToSchedule.length === 0) {\n        return {\n          scheduled: 0,\n          failed: 0,\n          duration: Date.now() - startTime,\n          errors: []\n        };\n      }\n\n      // Map users to Inngest events\n      const events = usersToSchedule.map(user => {\n        // Get target date in user's timezone (today at start of day)\n        const targetDate = now(user.timezone)\n          .startOf('day')\n          .toISO();\n\n        return {\n          name: 'workout/scheduled' as const,\n          data: {\n            userId: user.id,\n            targetDate,\n          },\n        };\n      });\n\n      // Send all events to Inngest in batch\n      try {\n        const { ids } = await inngest.send(events);\n        scheduled = ids.length;\n        console.log(`[DailyMessageService] Scheduled ${scheduled} Inngest jobs`);\n      } catch (error) {\n        console.error('[DailyMessageService] Failed to schedule Inngest jobs:', error);\n        failed = events.length;\n        errors.push({\n          userId: 'batch',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n\n      return {\n        scheduled,\n        failed,\n        duration: Date.now() - startTime,\n        errors\n      };\n    } catch (error) {\n      console.error('[DailyMessageService] Error scheduling messages:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Sends a daily message to a single user\n   */\n  public async sendDailyMessage(\n    user: UserWithProfile\n  ): Promise<MessageResult> {\n    try {\n      console.log(`Processing daily message for user ${user.id}`);\n\n      // Get today's date in the user's timezone\n      const targetDate = now(user.timezone).startOf('day');\n\n      // First try to get existing workout\n      let workout = await this.getTodaysWorkout(user.id, targetDate.toJSDate());\n\n      // If no workout exists, generate it on-demand\n      if (!workout) {\n        console.log(`No workout found for user ${user.id} on ${targetDate.toISODate()}, generating on-demand`);\n        workout = await this.workoutInstanceService.generateWorkoutForDate(user, targetDate);\n\n        if (!workout) {\n          console.log(`Failed to generate workout for user ${user.id} on ${targetDate.toISODate()}`);\n          return {\n            success: false,\n            userId: user.id,\n            error: 'Could not generate workout for today'\n          };\n        }\n      }\n\n      // Extract message content (either pre-generated or need to generate)\n      let workoutMessage: string;\n      if ('message' in workout && workout.message) {\n        workoutMessage = workout.message;\n      } else if ('description' in workout && 'reasoning' in workout && workout.description && workout.reasoning) {\n        // Fallback: Generate message if needed (shouldn't happen in production)\n        const { workoutAgentService } = await import('@/server/services/agents/training');\n        const messageAgent = await workoutAgentService.getMessageAgent();\n        const result = await messageAgent.invoke(workout.description);\n        workoutMessage = result.response;\n      } else {\n        throw new Error('Workout missing required fields for message generation');\n      }\n\n      // Send single message with both image and text\n      // Check for day-specific custom image first\n      const customImageUrl = await dayConfigService.getImageUrlForDate(targetDate.toJSDate());\n\n      let mediaUrls: string[] | undefined;\n      if (customImageUrl) {\n        // Use day-specific custom image (e.g., holiday themed)\n        mediaUrls = [customImageUrl];\n        console.log(`Using custom day image for ${targetDate.toISODate()}`);\n      } else {\n        // Fall back to default logo\n        const { publicBaseUrl, baseUrl } = getUrlsConfig();\n        const resolvedBaseUrl = publicBaseUrl || baseUrl;\n        mediaUrls = resolvedBaseUrl ? [`${resolvedBaseUrl}/OpenGraphGymtext.png`] : undefined;\n\n        if (!resolvedBaseUrl) {\n          console.warn('BASE_URL not configured - sending workout without logo image');\n        }\n      }\n\n      const queuedMessages: QueuedMessage[] = [{\n        content: workoutMessage,\n        mediaUrls\n      }];\n\n      await messageQueueService.enqueueMessages(user.id, queuedMessages, 'daily');\n      console.log(`Successfully queued daily messages for user ${user.id}`);\n\n      return {\n        success: true,\n        userId: user.id,\n        messageId: undefined // Messages will be sent asynchronously by queue\n      };\n    } catch (error) {\n      console.error(`Error sending daily message to user ${user.id}:`, error);\n      return {\n        success: false,\n        userId: user.id,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      };\n    }\n  }\n\n  /**\n   * Gets today's workout for a user\n   */\n  public async getTodaysWorkout(userId: string, date: Date): Promise<WorkoutInstance | null> {\n    // The date passed in is already the correct date at midnight in the user's timezone\n    // We can use it directly for the query\n    const workout = await this.workoutInstanceService.getWorkoutByUserIdAndDate(userId, date);\n    console.log(`Workout: ${workout}`);\n    return workout || null;\n  }\n\n  /**\n   * Generates a workout for a specific date (wrapper for onboarding)\n   * Delegates to WorkoutInstanceService for business logic\n   */\n  public async generateWorkout(\n    user: UserWithProfile,\n    targetDate: DateTime\n  ): Promise<WorkoutInstance | null> {\n    return this.workoutInstanceService.generateWorkoutForDate(user, targetDate);\n  }\n}\n\n// Export singleton instance\nexport const dailyMessageService = DailyMessageService.getInstance();"],"names":[],"mappings":"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"}},
    {"offset": {"line": 12910, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/orchestration/weeklyMessageService.ts"],"sourcesContent":["import { MessageService } from '../messaging/messageService';\nimport { UserService } from '../user/userService';\nimport { FitnessPlanService } from '../training/fitnessPlanService';\nimport { ProgressService } from '../training/progressService';\nimport { MicrocycleService } from '../training/microcycleService';\nimport { UserWithProfile } from '@/server/models/user';\nimport { inngest } from '@/server/connections/inngest/client';\nimport { messagingAgentService } from '@/server/services/agents/messaging';\nimport { now, getNextWeekStart } from '@/shared/utils/date';\n\ninterface MessageResult {\n  success: boolean;\n  userId: string;\n  error?: string;\n  messageIds?: string[];\n}\n\ninterface SchedulingResult {\n  scheduled: number;\n  failed: number;\n  duration: number;\n  errors: Array<{ userId: string; error: string }>;\n}\n\nexport class WeeklyMessageService {\n  private static instance: WeeklyMessageService;\n  private userService: UserService;\n  private messageService: MessageService;\n  private progressService: ProgressService;\n  private microcycleService: MicrocycleService;\n  private fitnessPlanService: FitnessPlanService;\n\n  private constructor() {\n    this.userService = UserService.getInstance();\n    this.messageService = MessageService.getInstance();\n    this.progressService = ProgressService.getInstance();\n    this.microcycleService = MicrocycleService.getInstance();\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n  }\n\n  public static getInstance(): WeeklyMessageService {\n    if (!WeeklyMessageService.instance) {\n      WeeklyMessageService.instance = new WeeklyMessageService();\n    }\n    return WeeklyMessageService.instance;\n  }\n\n  /**\n   * Schedules weekly messages for all users in a given UTC hour on Sunday\n   * Returns metrics about the scheduling operation\n   */\n  public async scheduleMessagesForHour(utcHour: number): Promise<SchedulingResult> {\n    const startTime = Date.now();\n    const errors: Array<{ userId: string; error: string }> = [];\n    let scheduled = 0;\n    let failed = 0;\n\n    try {\n      // Get all users who should receive weekly messages this hour (Sunday only)\n      const users = await this.userService.getUsersForWeeklyMessage(utcHour);\n      console.log(`[WeeklyMessageService] Found ${users.length} users to schedule for hour ${utcHour} on Sunday`);\n\n      if (users.length === 0) {\n        return {\n          scheduled: 0,\n          failed: 0,\n          duration: Date.now() - startTime,\n          errors: []\n        };\n      }\n\n      // Map users to Inngest events\n      const events = users.map(user => ({\n        name: 'weekly/scheduled' as const,\n        data: {\n          userId: user.id,\n        },\n      }));\n\n      // Send all events to Inngest in batch\n      try {\n        const { ids } = await inngest.send(events);\n        scheduled = ids.length;\n        console.log(`[WeeklyMessageService] Scheduled ${scheduled} Inngest jobs`);\n      } catch (error) {\n        console.error('[WeeklyMessageService] Failed to schedule Inngest jobs:', error);\n        failed = events.length;\n        errors.push({\n          userId: 'batch',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        });\n      }\n\n      return {\n        scheduled,\n        failed,\n        duration: Date.now() - startTime,\n        errors\n      };\n    } catch (error) {\n      console.error('[WeeklyMessageService] Error scheduling messages:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Sends weekly check-in messages to a single user\n   *\n   * Flow:\n   * 1. Calculate next Sunday's date in user's timezone\n   * 2. Get progress for next week using date-based calculation\n   * 3. Get/create next week's microcycle\n   * 4. Check if it's a deload week\n   * 5. Generate personalized feedback message using AI agent\n   * 6. Retrieve breakdown message from stored microcycle.message\n   * 7. Send both messages with delay\n   */\n  public async sendWeeklyMessage(user: UserWithProfile): Promise<MessageResult> {\n    try {\n      console.log(`[WeeklyMessageService] Processing weekly message for user ${user.id}`);\n\n      // Step 1: Get the fitness plan\n      const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n      if (!plan) {\n        console.error(`[WeeklyMessageService] No fitness plan found for user ${user.id}`);\n        return {\n          success: false,\n          userId: user.id,\n          error: 'No fitness plan found'\n        };\n      }\n\n      // Step 2: Calculate next Sunday's date in user's timezone (start of next week)\n      const currentDate = now(user.timezone).toJSDate();\n      const nextSundayDate = getNextWeekStart(currentDate, user.timezone);\n\n      console.log(`[WeeklyMessageService] Getting next week's plan for ${nextSundayDate.toISOString()} for user ${user.id}`);\n\n      // Step 3: Get progress for next week using date-based calculation\n      const nextWeekProgress = await this.progressService.getProgressForDate(plan, nextSundayDate, user.timezone);\n      if (!nextWeekProgress) {\n        console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${user.id}`);\n        return {\n          success: false,\n          userId: user.id,\n          error: 'Could not determine next week\\'s training progress'\n        };\n      }\n\n      // Step 4: Get or create next week's microcycle\n      const { microcycle: nextWeekMicrocycle } = await this.progressService.getOrCreateMicrocycleForDate(\n        user.id,\n        plan,\n        nextSundayDate,\n        user.timezone\n      );\n\n      if (!nextWeekMicrocycle) {\n        console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${user.id}`);\n        return {\n          success: false,\n          userId: user.id,\n          error: 'Could not generate next week\\'s training pattern'\n        };\n      }\n\n      // Step 5: Check if next week is a deload week\n      const isDeload = nextWeekMicrocycle.isDeload;\n\n      if (isDeload) {\n        console.log(`[WeeklyMessageService] User ${user.id} is entering a deload week (week ${nextWeekMicrocycle.absoluteWeek})`);\n      }\n\n      // Step 6: Generate feedback message using messaging agent service\n      const feedbackMessage = await messagingAgentService.generateWeeklyMessage(\n        user,\n        isDeload,\n        nextWeekMicrocycle.absoluteWeek\n      );\n\n      // Step 7: Get breakdown message from stored microcycle\n      const breakdownMessage = nextWeekMicrocycle.message;\n\n      if (!breakdownMessage) {\n        console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${nextWeekMicrocycle.id}`);\n        return {\n          success: false,\n          userId: user.id,\n          error: 'No breakdown message found for next week\\'s microcycle'\n        };\n      }\n\n      // Step 8: Send both messages with delay\n      const messageIds: string[] = [];\n\n      // Send feedback message first\n      const feedbackMsg = await this.messageService.sendMessage(user, feedbackMessage);\n      messageIds.push(feedbackMsg.id);\n      console.log(`[WeeklyMessageService] Sent feedback message to user ${user.id}`);\n\n      // Small delay before sending breakdown\n      await new Promise(resolve => setTimeout(resolve, 1000));\n\n      // Send breakdown message (from stored microcycle.message)\n      const breakdownMsg = await this.messageService.sendMessage(user, breakdownMessage);\n      messageIds.push(breakdownMsg.id);\n      console.log(`[WeeklyMessageService] Sent breakdown message to user ${user.id}`);\n\n      console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${user.id}`);\n      return {\n        success: true,\n        userId: user.id,\n        messageIds\n      };\n    } catch (error) {\n      console.error(`[WeeklyMessageService] Error sending weekly message to user ${user.id}:`, error);\n      return {\n        success: false,\n        userId: user.id,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      };\n    }\n  }\n}\n\n// Export singleton instance\nexport const weeklyMessageService = WeeklyMessageService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13102, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/orchestration/onboardingService.ts"],"sourcesContent":["import { UserWithProfile } from '../../models/user';\nimport { FitnessPlanService } from '../training/fitnessPlanService';\nimport { MessageService } from '../messaging/messageService';\nimport { DailyMessageService } from './dailyMessageService';\nimport { WorkoutInstanceService } from '../training/workoutInstanceService';\nimport { now, startOfDay, getDayOfWeek } from '@/shared/utils/date';\nimport { ProgressService } from '../training/progressService';\nimport { messagingAgentService } from '@/server/services/agents/messaging';\nimport { messageQueueService, type QueuedMessage } from '../messaging/messageQueueService';\n\n/**\n * OnboardingService\n *\n * Orchestrates the complete user onboarding flow:\n * 1. Send welcome message\n * 2. Create fitness plan\n * 3. Send plan summary\n * 4. Send first daily workout\n *\n * Uses ConversationFlowBuilder to maintain natural conversation flow\n * and avoid repetitive greetings.\n *\n * Responsibilities:\n * - Coordinate multiple services for onboarding\n * - Handle onboarding flow logic\n * - Ensure proper sequencing of onboarding steps\n * - Maintain conversation context across messages\n */\nexport class OnboardingService {\n  private static instance: OnboardingService;\n  private fitnessPlanService: FitnessPlanService;\n  private messageService: MessageService;\n  private dailyMessageService: DailyMessageService;\n  private workoutInstanceService: WorkoutInstanceService;\n  private progressService: ProgressService;\n\n  private constructor() {\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n    this.progressService = ProgressService.getInstance();\n    this.messageService = MessageService.getInstance();\n    this.dailyMessageService = DailyMessageService.getInstance();\n    this.workoutInstanceService = WorkoutInstanceService.getInstance();\n  }\n\n  public static getInstance(): OnboardingService {\n    if (!OnboardingService.instance) {\n      OnboardingService.instance = new OnboardingService();\n    }\n    return OnboardingService.instance;\n  }\n\n  /**\n   * Create fitness plan with pre-generated message\n   * Step 1 of onboarding entity creation\n   *\n   * @param user - The user to create plan for\n   * @throws Error if creation fails\n   */\n  public async createFitnessPlan(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating fitness plan for ${user.id}`);\n\n    try {\n      await this.fitnessPlanService.createFitnessPlan(user);\n      console.log(`[Onboarding] Successfully created fitness plan for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create fitness plan for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create first microcycle with pre-generated message\n   * Step 2 of onboarding entity creation\n   * Requires fitness plan to exist\n   *\n   * @param user - The user to create microcycle for\n   * @throws Error if creation fails\n   */\n  public async createFirstMicrocycle(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating first microcycle for ${user.id}`);\n\n    try {\n      const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n      if (!plan) {\n        throw new Error(`No fitness plan found for user ${user.id}`);\n      }\n\n      // Create first microcycle using date-based approach (for current week)\n      const currentDate = now(user.timezone).toJSDate();\n      const { microcycle } = await this.progressService.getOrCreateMicrocycleForDate(user.id, plan, currentDate, user.timezone);\n      if (!microcycle) {\n        throw new Error('Failed to create first microcycle');\n      }\n\n      console.log(`[Onboarding] Successfully created first microcycle for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create first microcycle for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create first workout with pre-generated message\n   * Step 3 of onboarding entity creation\n   * Requires fitness plan and microcycle to exist\n   *\n   * @param user - The user to create workout for\n   * @throws Error if creation fails\n   */\n  public async createFirstWorkout(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating first workout for ${user.id}`);\n\n    try {\n      const targetDate = now(user.timezone).startOf('day');\n      const workout = await this.workoutInstanceService.generateWorkoutForDate(user, targetDate);\n\n      if (!workout) {\n        throw new Error('Failed to create first workout');\n      }\n\n      console.log(`[Onboarding] Successfully created first workout for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create first workout for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Send onboarding messages (combined plan+week + workout)\n   * Called after both onboarding and payment are complete\n   *\n   * Sends two messages in order using queue system:\n   * 1. Combined plan summary + first week breakdown\n   * 2. First workout message\n   *\n   * @param user - The user to send messages to\n   * @throws Error if any step fails\n   */\n  public async sendOnboardingMessages(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Sending onboarding messages to ${user.id}`);\n\n    try {\n      // Prepare both messages\n      const planMicrocycleMessage = await this.prepareCombinedPlanMicrocycleMessage(user);\n      const workoutMessage = await this.prepareWorkoutMessage(user);\n\n      // Enqueue both messages for ordered delivery\n      const messages: QueuedMessage[] = [\n        { content: planMicrocycleMessage },\n        { content: workoutMessage }\n      ];\n\n      await messageQueueService.enqueueMessages(\n        user.id,\n        messages,\n        'onboarding'\n      );\n\n      console.log(`[Onboarding] Successfully queued onboarding messages for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to send onboarding messages to ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Prepare combined plan + first week message\n   * Combines pre-generated plan and microcycle messages into a single onboarding message\n   */\n  private async prepareCombinedPlanMicrocycleMessage(user: UserWithProfile): Promise<string> {\n    const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n    if (!plan) {\n      throw new Error(`No fitness plan found for user ${user.id}`);\n    }\n\n    if (!plan.message) {\n      throw new Error(`No plan message found for user ${user.id}`);\n    }\n\n    // Get current microcycle using date-based approach\n    const currentDate = now(user.timezone).toJSDate();\n    const { microcycle } = await this.progressService.getOrCreateMicrocycleForDate(user.id, plan, currentDate, user.timezone);\n    if (!microcycle) {\n      throw new Error(`No microcycle found for user ${user.id}`);\n    }\n\n    if (!microcycle.message) {\n      throw new Error(`No microcycle message found for user ${user.id}`);\n    }\n\n    // Get current weekday for the user's timezone\n    const currentWeekday = getDayOfWeek(undefined, user.timezone);\n\n    // Generate combined message using messaging agent service\n    const message = await messagingAgentService.generatePlanMicrocycleCombinedMessage(\n      plan.message,\n      microcycle.message,\n      currentWeekday\n    );\n\n    console.log(`[Onboarding] Prepared combined plan+microcycle message for ${user.id}`);\n    return message;\n  }\n\n  /**\n   * Prepare workout message\n   */\n  private async prepareWorkoutMessage(user: UserWithProfile): Promise<string> {\n    const targetDate = startOfDay(now(user.timezone).toJSDate(), user.timezone);\n    const workout = await this.dailyMessageService.getTodaysWorkout(user.id, targetDate);\n\n    if (!workout) {\n      throw new Error(`No workout found for user ${user.id} on ${targetDate.toISOString()}`);\n    }\n\n    if (!workout.message) {\n      throw new Error(`No workout message found for ${workout.id}`);\n    }\n\n    console.log(`[Onboarding] Prepared workout message for ${user.id}`);\n    return workout.message;\n  }\n}\n\n// Export singleton instance\nexport const onboardingService = OnboardingService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13287, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/user/onboardingDataService.ts"],"sourcesContent":["import { OnboardingRepository, type OnboardingRecord, type SignupData, type OnboardingStatus } from '@/server/repositories/onboardingRepository';\n\n/**\n * OnboardingDataService\n *\n * Service layer for managing user onboarding state and signup data.\n * Wraps OnboardingRepository to provide clean service-level interface.\n *\n * Responsibilities:\n * - Manage onboarding lifecycle (pending  in_progress  completed/failed)\n * - Store and retrieve signup form data\n * - Track message sending status (idempotency)\n * - Coordinate cleanup after completion\n *\n * Architecture:\n * Routes/Inngest  OnboardingDataService  OnboardingRepository  Database\n */\nexport class OnboardingDataService {\n  private static instance: OnboardingDataService;\n  private repository: OnboardingRepository;\n\n  private constructor() {\n    this.repository = new OnboardingRepository();\n  }\n\n  public static getInstance(): OnboardingDataService {\n    if (!OnboardingDataService.instance) {\n      OnboardingDataService.instance = new OnboardingDataService();\n    }\n    return OnboardingDataService.instance;\n  }\n\n  /**\n   * Create a new onboarding record for a user\n   * Called during signup to initialize onboarding tracking\n   */\n  async createOnboardingRecord(userId: string, signupData?: SignupData): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Creating onboarding record for user ${userId}`);\n    return await this.repository.create(userId, signupData);\n  }\n\n  /**\n   * Mark onboarding as started (status: pending  in_progress)\n   */\n  async markStarted(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking onboarding started for user ${userId}`);\n    return await this.repository.markStarted(userId);\n  }\n\n  /**\n   * Update current step for progress tracking\n   */\n  async updateCurrentStep(userId: string, stepNumber: number): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Updating step to ${stepNumber} for user ${userId}`);\n    return await this.repository.updateCurrentStep(userId, stepNumber);\n  }\n\n  /**\n   * Mark onboarding as completed (status: in_progress  completed)\n   */\n  async markCompleted(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking onboarding completed for user ${userId}`);\n    return await this.repository.markCompleted(userId);\n  }\n\n  /**\n   * Update onboarding status with optional error message\n   * Used for marking as failed or updating status manually\n   */\n  async updateStatus(userId: string, status: OnboardingStatus, errorMessage?: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Updating status to '${status}' for user ${userId}`);\n    return await this.repository.updateStatus(userId, status, errorMessage);\n  }\n\n  /**\n   * Get onboarding status for a client\n   */\n  async getStatus(clientId: string): Promise<OnboardingStatus | null> {\n    const record = await this.repository.findByClientId(clientId);\n    return record ? (record.status as OnboardingStatus) : null;\n  }\n\n  /**\n   * Get complete onboarding record by client ID\n   */\n  async findByClientId(clientId: string): Promise<OnboardingRecord | null> {\n    return await this.repository.findByClientId(clientId);\n  }\n\n  /**\n   * Get signup data for a user\n   * Used during async onboarding to retrieve form data\n   */\n  async getSignupData(userId: string): Promise<SignupData | null> {\n    return await this.repository.getSignupData(userId);\n  }\n\n  /**\n   * Clear signup data after profile extraction\n   * Cleanup to remove temporary form data\n   */\n  async clearSignupData(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Clearing signup data for user ${userId}`);\n    return await this.repository.clearSignupData(userId);\n  }\n\n  /**\n   * Mark final program messages as sent\n   * Used for idempotency - ensures messages only sent once\n   */\n  async markMessagesSent(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking messages sent for user ${userId}`);\n    return await this.repository.markMessagesSent(userId);\n  }\n\n  /**\n   * Check if final messages have been sent\n   * Used to prevent duplicate message sending\n   */\n  async hasMessagesSent(userId: string): Promise<boolean> {\n    return await this.repository.hasMessagesSent(userId);\n  }\n\n  /**\n   * Delete onboarding record (full cleanup)\n   * Optional: can be used to clean up old records\n   */\n  async delete(userId: string): Promise<void> {\n    console.log(`[OnboardingDataService] Deleting onboarding record for user ${userId}`);\n    return await this.repository.delete(userId);\n  }\n}\n\n// Export singleton instance\nexport const onboardingDataService = OnboardingDataService.getInstance();\n"],"names":[],"mappings":";;;;;;AAAA;;AAiBO,MAAM;IACX,OAAe,SAAgC;IACvC,WAAiC;IAEzC,aAAsB;QACpB,IAAI,CAAC,UAAU,GAAG,IAAI,qMAAoB;IAC5C;IAEA,OAAc,cAAqC;QACjD,IAAI,CAAC,sBAAsB,QAAQ,EAAE;YACnC,sBAAsB,QAAQ,GAAG,IAAI;QACvC;QACA,OAAO,sBAAsB,QAAQ;IACvC;IAEA;;;GAGC,GACD,MAAM,uBAAuB,MAAc,EAAE,UAAuB,EAA6B;QAC/F,QAAQ,GAAG,CAAC,CAAC,4DAA4D,EAAE,QAAQ;QACnF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,QAAQ;IAC9C;IAEA;;GAEC,GACD,MAAM,YAAY,MAAc,EAA6B;QAC3D,QAAQ,GAAG,CAAC,CAAC,4DAA4D,EAAE,QAAQ;QACnF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC;IAC3C;IAEA;;GAEC,GACD,MAAM,kBAAkB,MAAc,EAAE,UAAkB,EAA6B;QACrF,QAAQ,GAAG,CAAC,CAAC,yCAAyC,EAAE,WAAW,UAAU,EAAE,QAAQ;QACvF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,QAAQ;IACzD;IAEA;;GAEC,GACD,MAAM,cAAc,MAAc,EAA6B;QAC7D,QAAQ,GAAG,CAAC,CAAC,8DAA8D,EAAE,QAAQ;QACrF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC;IAC7C;IAEA;;;GAGC,GACD,MAAM,aAAa,MAAc,EAAE,MAAwB,EAAE,YAAqB,EAA6B;QAC7G,QAAQ,GAAG,CAAC,CAAC,4CAA4C,EAAE,OAAO,WAAW,EAAE,QAAQ;QACvF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,QAAQ,QAAQ;IAC5D;IAEA;;GAEC,GACD,MAAM,UAAU,QAAgB,EAAoC;QAClE,MAAM,SAAS,MAAM,IAAI,CAAC,UAAU,CAAC,cAAc,CAAC;QACpD,OAAO,SAAU,OAAO,MAAM,GAAwB;IACxD;IAEA;;GAEC,GACD,MAAM,eAAe,QAAgB,EAAoC;QACvE,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,cAAc,CAAC;IAC9C;IAEA;;;GAGC,GACD,MAAM,cAAc,MAAc,EAA8B;QAC9D,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC;IAC7C;IAEA;;;GAGC,GACD,MAAM,gBAAgB,MAAc,EAA6B;QAC/D,QAAQ,GAAG,CAAC,CAAC,sDAAsD,EAAE,QAAQ;QAC7E,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,eAAe,CAAC;IAC/C;IAEA;;;GAGC,GACD,MAAM,iBAAiB,MAAc,EAA6B;QAChE,QAAQ,GAAG,CAAC,CAAC,uDAAuD,EAAE,QAAQ;QAC9E,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,gBAAgB,CAAC;IAChD;IAEA;;;GAGC,GACD,MAAM,gBAAgB,MAAc,EAAoB;QACtD,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,eAAe,CAAC;IAC/C;IAEA;;;GAGC,GACD,MAAM,OAAO,MAAc,EAAiB;QAC1C,QAAQ,GAAG,CAAC,CAAC,4DAA4D,EAAE,QAAQ;QACnF,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC;IACtC;AACF;AAGO,MAAM,wBAAwB,sBAAsB,WAAW"}},
    {"offset": {"line": 13389, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/subscriptionRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { Subscriptions } from '../models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type Subscription = Selectable<Subscriptions>;\nexport type NewSubscription = Insertable<Subscriptions>;\nexport type SubscriptionUpdate = Updateable<Subscriptions>;\n\nexport interface CreateSubscriptionData {\n  clientId: string;\n  stripeSubscriptionId: string;\n  status: string;\n  planType: string;\n  currentPeriodStart: Date;\n  currentPeriodEnd: Date;\n}\n\n/**\n * SubscriptionRepository\n *\n * Manages Stripe subscription records\n */\nexport class SubscriptionRepository extends BaseRepository {\n  /**\n   * Create a new subscription\n   */\n  async create(data: CreateSubscriptionData): Promise<Subscription> {\n    const subscription: NewSubscription = {\n      clientId: data.clientId,\n      stripeSubscriptionId: data.stripeSubscriptionId,\n      status: data.status,\n      planType: data.planType,\n      currentPeriodStart: data.currentPeriodStart,\n      currentPeriodEnd: data.currentPeriodEnd,\n    };\n\n    return await this.db\n      .insertInto('subscriptions')\n      .values(subscription)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Update subscription by Stripe subscription ID\n   */\n  async updateByStripeId(\n    stripeSubscriptionId: string,\n    data: SubscriptionUpdate\n  ): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set(data)\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find subscription by client ID\n   */\n  async findByClientId(clientId: string): Promise<Subscription[]> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n  }\n\n  /**\n   * Find subscription by Stripe subscription ID\n   */\n  async findByStripeId(stripeSubscriptionId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Get active subscription for client\n   */\n  async getActiveSubscription(clientId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('status', '=', 'active')\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Check if client has active subscription\n   */\n  async hasActiveSubscription(clientId: string): Promise<boolean> {\n    const subscription = await this.getActiveSubscription(clientId);\n    return subscription !== null;\n  }\n\n  /**\n   * Cancel subscription\n   */\n  async cancel(stripeSubscriptionId: string, canceledAt: Date): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({\n        status: 'canceled',\n        canceledAt,\n      })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Schedule subscription for cancellation at period end\n   * Sets status to 'cancel_pending' - messages will stop immediately\n   */\n  async scheduleCancellation(stripeSubscriptionId: string): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({ status: 'cancel_pending' })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Reactivate subscription (clear pending cancellation)\n   * Sets status back to 'active'\n   */\n  async reactivate(stripeSubscriptionId: string): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({ status: 'active' })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find active subscription eligible for messaging\n   * Only returns subscriptions with status 'active' (excludes 'cancel_pending')\n   */\n  async findActiveForMessaging(clientId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('status', '=', 'active')\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst() ?? null;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAsBO,MAAM,+BAA+B,yLAAc;IACxD;;GAEC,GACD,MAAM,OAAO,IAA4B,EAAyB;QAChE,MAAM,eAAgC;YACpC,UAAU,KAAK,QAAQ;YACvB,sBAAsB,KAAK,oBAAoB;YAC/C,QAAQ,KAAK,MAAM;YACnB,UAAU,KAAK,QAAQ;YACvB,oBAAoB,KAAK,kBAAkB;YAC3C,kBAAkB,KAAK,gBAAgB;QACzC;QAEA,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,iBACX,MAAM,CAAC,cACP,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;GAEC,GACD,MAAM,iBACJ,oBAA4B,EAC5B,IAAwB,EACD;QACvB,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,iBACZ,GAAG,CAAC,MACJ,KAAK,CAAC,wBAAwB,KAAK,sBACnC,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;GAEC,GACD,MAAM,eAAe,QAAgB,EAA2B;QAC9D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,iBACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,UACvB,OAAO,CAAC,aAAa,QACrB,OAAO;IACZ;IAEA;;GAEC,GACD,MAAM,eAAe,oBAA4B,EAAgC;QAC/E,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,iBACX,SAAS,GACT,KAAK,CAAC,wBAAwB,KAAK,sBACnC,gBAAgB,MAAM;IAC3B;IAEA;;GAEC,GACD,MAAM,sBAAsB,QAAgB,EAAgC;QAC1E,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,iBACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,UACvB,KAAK,CAAC,UAAU,KAAK,UACrB,OAAO,CAAC,aAAa,QACrB,gBAAgB,MAAM;IAC3B;IAEA;;GAEC,GACD,MAAM,sBAAsB,QAAgB,EAAoB;QAC9D,MAAM,eAAe,MAAM,IAAI,CAAC,qBAAqB,CAAC;QACtD,OAAO,iBAAiB;IAC1B;IAEA;;GAEC,GACD,MAAM,OAAO,oBAA4B,EAAE,UAAgB,EAAyB;QAClF,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,iBACZ,GAAG,CAAC;YACH,QAAQ;YACR;QACF,GACC,KAAK,CAAC,wBAAwB,KAAK,sBACnC,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;;GAGC,GACD,MAAM,qBAAqB,oBAA4B,EAAyB;QAC9E,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,iBACZ,GAAG,CAAC;YAAE,QAAQ;QAAiB,GAC/B,KAAK,CAAC,wBAAwB,KAAK,sBACnC,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;;GAGC,GACD,MAAM,WAAW,oBAA4B,EAAyB;QACpE,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,WAAW,CAAC,iBACZ,GAAG,CAAC;YAAE,QAAQ;QAAS,GACvB,KAAK,CAAC,wBAAwB,KAAK,sBACnC,YAAY,GACZ,uBAAuB;IAC5B;IAEA;;;GAGC,GACD,MAAM,uBAAuB,QAAgB,EAAgC;QAC3E,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,iBACX,SAAS,GACT,KAAK,CAAC,YAAY,KAAK,UACvB,KAAK,CAAC,UAAU,KAAK,UACrB,OAAO,CAAC,aAAa,QACrB,gBAAgB,MAAM;IAC3B;AACF"}},
    {"offset": {"line": 13470, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/subscription/subscriptionService.ts"],"sourcesContent":["import Stripe from 'stripe';\nimport { SubscriptionRepository } from '@/server/repositories/subscriptionRepository';\nimport { UserRepository } from '@/server/repositories/userRepository';\nimport { getStripeSecrets } from '@/server/config';\nimport { getStripeConfig, getUrlsConfig } from '@/shared/config';\n\nconst { secretKey } = getStripeSecrets();\nconst stripe = new Stripe(secretKey, {\n  apiVersion: '2023-10-16',\n});\n\nexport interface CancelResult {\n  success: boolean;\n  periodEndDate?: Date;\n  error?: string;\n}\n\nexport interface ReactivateResult {\n  success: boolean;\n  reactivated: boolean;\n  requiresNewSubscription: boolean;\n  checkoutUrl?: string;\n  error?: string;\n}\n\n/**\n * SubscriptionService\n *\n * Manages subscription cancellation and reactivation via SMS commands (STOP/START)\n *\n * Status flow:\n * - 'active' -> user sends STOP -> 'cancel_pending' (messages stop, sub cancels at period end)\n * - 'cancel_pending' -> user sends START -> 'active' (reactivated)\n * - 'cancel_pending' -> period ends -> 'canceled' (handled by Stripe webhook)\n * - 'canceled' -> user sends START -> new checkout session required\n */\nexport class SubscriptionService {\n  private static instance: SubscriptionService;\n  private subscriptionRepo: SubscriptionRepository;\n  private userRepo: UserRepository;\n\n  private constructor() {\n    this.subscriptionRepo = new SubscriptionRepository();\n    this.userRepo = new UserRepository();\n  }\n\n  public static getInstance(): SubscriptionService {\n    if (!SubscriptionService.instance) {\n      SubscriptionService.instance = new SubscriptionService();\n    }\n    return SubscriptionService.instance;\n  }\n\n  /**\n   * Cancel user's subscription via STOP command\n   * Sets cancel_at_period_end in Stripe and status to 'cancel_pending' locally\n   * User keeps access but messages stop immediately\n   */\n  async cancelSubscription(userId: string): Promise<CancelResult> {\n    try {\n      // Get active subscription\n      const subscription = await this.subscriptionRepo.getActiveSubscription(userId);\n      if (!subscription) {\n        // Check if already pending cancellation\n        const subscriptions = await this.subscriptionRepo.findByClientId(userId);\n        const pendingSub = subscriptions.find(s => s.status === 'cancel_pending');\n        if (pendingSub) {\n          return {\n            success: true,\n            periodEndDate: new Date(pendingSub.currentPeriodEnd),\n          };\n        }\n        return { success: false, error: 'No active subscription found' };\n      }\n\n      // Cancel in Stripe (at period end)\n      const stripeSubscription = await stripe.subscriptions.update(\n        subscription.stripeSubscriptionId,\n        { cancel_at_period_end: true }\n      );\n\n      // Update local DB to 'cancel_pending'\n      await this.subscriptionRepo.scheduleCancellation(subscription.stripeSubscriptionId);\n\n      console.log(`[SubscriptionService] Subscription ${subscription.stripeSubscriptionId} scheduled for cancellation`);\n\n      return {\n        success: true,\n        periodEndDate: new Date(stripeSubscription.current_period_end * 1000),\n      };\n    } catch (error) {\n      console.error('[SubscriptionService] Cancel failed:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Reactivate user's subscription via START command\n   * If cancel_at_period_end was set, clears it and sets status back to 'active'\n   * If fully canceled, returns checkout URL for new subscription\n   */\n  async reactivateSubscription(userId: string): Promise<ReactivateResult> {\n    try {\n      // Get user's most recent subscription\n      const subscriptions = await this.subscriptionRepo.findByClientId(userId);\n      const subscription = subscriptions[0]; // Most recent\n\n      if (!subscription) {\n        // No subscription history - need new subscription\n        return await this.createResubscriptionSession(userId);\n      }\n\n      // If already active, nothing to do\n      if (subscription.status === 'active') {\n        return { success: true, reactivated: false, requiresNewSubscription: false };\n      }\n\n      // If cancel_pending, try to reactivate in Stripe\n      if (subscription.status === 'cancel_pending') {\n        try {\n          // Check Stripe subscription state\n          const stripeSubscription = await stripe.subscriptions.retrieve(\n            subscription.stripeSubscriptionId\n          );\n\n          if (stripeSubscription.status === 'active' && stripeSubscription.cancel_at_period_end) {\n            // Can reactivate by clearing cancel_at_period_end\n            await stripe.subscriptions.update(subscription.stripeSubscriptionId, {\n              cancel_at_period_end: false,\n            });\n\n            // Update local DB\n            await this.subscriptionRepo.reactivate(subscription.stripeSubscriptionId);\n\n            console.log(`[SubscriptionService] Subscription ${subscription.stripeSubscriptionId} reactivated`);\n\n            return { success: true, reactivated: true, requiresNewSubscription: false };\n          }\n        } catch (stripeError) {\n          console.error('[SubscriptionService] Stripe reactivation failed:', stripeError);\n          // Fall through to create new subscription\n        }\n      }\n\n      // If canceled or Stripe reactivation failed, need new subscription\n      if (subscription.status === 'canceled' || subscription.status === 'cancel_pending') {\n        return await this.createResubscriptionSession(userId);\n      }\n\n      // Unknown state\n      return { success: false, reactivated: false, requiresNewSubscription: false, error: 'Unknown subscription state' };\n    } catch (error) {\n      console.error('[SubscriptionService] Reactivate failed:', error);\n      return {\n        success: false,\n        reactivated: false,\n        requiresNewSubscription: false,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Check if user should receive messages\n   * Only users with status='active' (not 'cancel_pending') receive messages\n   */\n  async shouldReceiveMessages(userId: string): Promise<boolean> {\n    const subscription = await this.subscriptionRepo.findActiveForMessaging(userId);\n    return subscription !== null;\n  }\n\n  /**\n   * Create a new checkout session for resubscription\n   */\n  private async createResubscriptionSession(userId: string): Promise<ReactivateResult> {\n    try {\n      const user = await this.userRepo.findById(userId);\n      if (!user) {\n        return { success: false, reactivated: false, requiresNewSubscription: true, error: 'User not found' };\n      }\n\n      const { publicBaseUrl, baseUrl } = getUrlsConfig();\n      const resolvedBaseUrl = publicBaseUrl || baseUrl;\n      const { priceId } = getStripeConfig();\n\n      const session = await stripe.checkout.sessions.create({\n        customer: user.stripeCustomerId || undefined,\n        mode: 'subscription',\n        line_items: [{ price: priceId, quantity: 1 }],\n        success_url: `${resolvedBaseUrl}/api/checkout/session?session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: `${resolvedBaseUrl}/`,\n        metadata: { userId },\n        client_reference_id: userId,\n      });\n\n      console.log(`[SubscriptionService] Created resubscription checkout session for user ${userId}`);\n\n      return {\n        success: true,\n        reactivated: false,\n        requiresNewSubscription: true,\n        checkoutUrl: session.url || undefined,\n      };\n    } catch (error) {\n      console.error('[SubscriptionService] Create checkout session failed:', error);\n      return {\n        success: false,\n        reactivated: false,\n        requiresNewSubscription: true,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n}\n\nexport const subscriptionService = SubscriptionService.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 13675, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/training/chainRunnerService.ts"],"sourcesContent":["import { FitnessPlanService } from '@/server/services/training/fitnessPlanService';\nimport { MicrocycleService } from '@/server/services/training/microcycleService';\nimport { WorkoutInstanceService } from '@/server/services/training/workoutInstanceService';\nimport { UserService } from '@/server/services/user/userService';\nimport { FitnessProfileService } from '@/server/services/user/fitnessProfileService';\nimport { OnboardingRepository } from '@/server/repositories/onboardingRepository';\n\n// Agent services for full chain operations and sub-agents\nimport {\n  workoutAgentService,\n  microcycleAgentService,\n  fitnessPlanAgentService,\n} from '@/server/services/agents/training';\n\n// Types\nimport type { FitnessPlan } from '@/server/models/fitnessPlan';\nimport type { Microcycle } from '@/server/models/microcycle';\nimport type { WorkoutInstance } from '@/server/models/workout';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport type ChainOperation = 'full' | 'structured' | 'message';\n\nexport interface ChainRunResult<T> {\n  success: boolean;\n  data: T;\n  executionTimeMs: number;\n  operation: ChainOperation;\n}\n\nexport interface ProfileRegenerationResult {\n  success: boolean;\n  profile: string;\n  executionTimeMs: number;\n}\n\n/**\n * Chain Runner Service\n *\n * Enables running individual chain components (structured, formatted, message)\n * or full chains for fitness plans, microcycles, and workouts.\n *\n * Used for testing and iterative improvement of AI outputs.\n */\nexport class ChainRunnerService {\n  private static instance: ChainRunnerService;\n  private fitnessPlanService: FitnessPlanService;\n  private microcycleService: MicrocycleService;\n  private workoutService: WorkoutInstanceService;\n  private userService: UserService;\n  private fitnessProfileService: FitnessProfileService;\n  private onboardingRepository: OnboardingRepository;\n\n  private constructor() {\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n    this.microcycleService = MicrocycleService.getInstance();\n    this.workoutService = WorkoutInstanceService.getInstance();\n    this.userService = UserService.getInstance();\n    this.fitnessProfileService = FitnessProfileService.getInstance();\n    this.onboardingRepository = new OnboardingRepository();\n  }\n\n  public static getInstance(): ChainRunnerService {\n    if (!ChainRunnerService.instance) {\n      ChainRunnerService.instance = new ChainRunnerService();\n    }\n    return ChainRunnerService.instance;\n  }\n\n  // ============================================\n  // PROFILE OPERATIONS\n  // ============================================\n\n  /**\n   * Regenerate a user's profile from their signup data\n   * Creates a new profile from scratch using the ProfileUpdateAgent\n   */\n  async runProfileRegeneration(userId: string): Promise<ProfileRegenerationResult> {\n    const startTime = Date.now();\n\n    console.log(`[ChainRunner] Regenerating profile for user ${userId}`);\n\n    // Fetch the user with profile\n    const user = await this.userService.getUser(userId);\n    if (!user) {\n      throw new Error(`User not found: ${userId}`);\n    }\n\n    // Fetch signup data\n    const signupData = await this.onboardingRepository.getSignupData(userId);\n    if (!signupData) {\n      throw new Error(`No signup data found for user: ${userId}`);\n    }\n\n    // Regenerate profile from signup data\n    const profile = await this.fitnessProfileService.createFitnessProfile(user, signupData);\n\n    if (!profile) {\n      throw new Error(`Failed to regenerate profile for user: ${userId}`);\n    }\n\n    console.log(`[ChainRunner] Profile regenerated for user ${userId}`);\n\n    return {\n      success: true,\n      profile,\n      executionTimeMs: Date.now() - startTime,\n    };\n  }\n\n  // ============================================\n  // FITNESS PLAN OPERATIONS\n  // ============================================\n\n  /**\n   * Run a chain operation for a fitness plan\n   */\n  async runFitnessPlanChain(\n    planId: string,\n    operation: ChainOperation\n  ): Promise<ChainRunResult<FitnessPlan>> {\n    const startTime = Date.now();\n\n    // Fetch the plan\n    const plan = await this.fitnessPlanService.getPlanById(planId);\n    if (!plan) {\n      throw new Error(`Fitness plan not found: ${planId}`);\n    }\n\n    // Fetch the user with profile\n    const user = await this.userService.getUser(plan.clientId);\n    if (!user) {\n      throw new Error(`User not found: ${plan.clientId}`);\n    }\n\n    let updatedPlan: FitnessPlan;\n\n    switch (operation) {\n      case 'full':\n        updatedPlan = await this.runFullFitnessPlanChain(plan, user);\n        break;\n      case 'structured':\n        updatedPlan = await this.runFitnessPlanStructuredChain(plan);\n        break;\n      case 'message':\n        updatedPlan = await this.runFitnessPlanMessageChain(plan, user);\n        break;\n      default:\n        throw new Error(`Unknown operation: ${operation}`);\n    }\n\n    return {\n      success: true,\n      data: updatedPlan,\n      executionTimeMs: Date.now() - startTime,\n      operation,\n    };\n  }\n\n  private async runFullFitnessPlanChain(\n    plan: FitnessPlan,\n    user: UserWithProfile\n  ): Promise<FitnessPlan> {\n    console.log(`[ChainRunner] Running full fitness plan chain for plan ${plan.id}`);\n\n    // Use fitness plan agent service for full chain\n    const result = await fitnessPlanAgentService.generateFitnessPlan(user);\n\n    const updated = await this.fitnessPlanService.updateFitnessPlan(plan.id!, {\n      description: result.description,\n      message: result.message,\n      structured: result.structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update fitness plan: ${plan.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runFitnessPlanStructuredChain(plan: FitnessPlan): Promise<FitnessPlan> {\n    console.log(`[ChainRunner] Running structured chain for plan ${plan.id}`);\n\n    const agent = await fitnessPlanAgentService.getStructuredAgent();\n\n    // Configurable agents expect JSON string input\n    const inputJson = JSON.stringify({\n      description: plan.description || '',\n    });\n\n    const result = await agent.invoke(inputJson);\n    const structure = result.response;\n\n    const updated = await this.fitnessPlanService.updateFitnessPlan(plan.id!, {\n      structured: structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update fitness plan: ${plan.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runFitnessPlanMessageChain(\n    plan: FitnessPlan,\n    user: UserWithProfile\n  ): Promise<FitnessPlan> {\n    console.log(`[ChainRunner] Running message chain for plan ${plan.id}`);\n\n    const agent = await fitnessPlanAgentService.getMessageAgent();\n\n    // Configurable agents expect JSON string input\n    const inputJson = JSON.stringify({\n      description: plan.description || '',\n      user,\n    });\n\n    const result = await agent.invoke(inputJson);\n    const message = result.response;\n\n    const updated = await this.fitnessPlanService.updateFitnessPlan(plan.id!, {\n      message,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update fitness plan: ${plan.id}`);\n    }\n\n    return updated;\n  }\n\n  // ============================================\n  // MICROCYCLE OPERATIONS\n  // ============================================\n\n  /**\n   * Run a chain operation for a microcycle\n   */\n  async runMicrocycleChain(\n    microcycleId: string,\n    operation: ChainOperation\n  ): Promise<ChainRunResult<Microcycle>> {\n    const startTime = Date.now();\n\n    // Fetch the microcycle\n    const microcycle = await this.microcycleService.getMicrocycleById(microcycleId);\n    if (!microcycle) {\n      throw new Error(`Microcycle not found: ${microcycleId}`);\n    }\n\n    // Fetch the user with profile\n    const user = await this.userService.getUser(microcycle.clientId);\n    if (!user) {\n      throw new Error(`User not found: ${microcycle.clientId}`);\n    }\n\n    // Fetch the user's current plan for full regeneration\n    const plan = await this.fitnessPlanService.getCurrentPlan(microcycle.clientId);\n    if (!plan) {\n      throw new Error(`No active fitness plan found for client: ${microcycle.clientId}`);\n    }\n\n    let updatedMicrocycle: Microcycle;\n\n    switch (operation) {\n      case 'full':\n        updatedMicrocycle = await this.runFullMicrocycleChain(microcycle, plan, user);\n        break;\n      case 'structured':\n        updatedMicrocycle = await this.runMicrocycleStructuredChain(microcycle);\n        break;\n      case 'message':\n        updatedMicrocycle = await this.runMicrocycleMessageChain(microcycle);\n        break;\n      default:\n        throw new Error(`Unknown operation: ${operation}`);\n    }\n\n    return {\n      success: true,\n      data: updatedMicrocycle,\n      executionTimeMs: Date.now() - startTime,\n      operation,\n    };\n  }\n\n  private async runFullMicrocycleChain(\n    microcycle: Microcycle,\n    plan: FitnessPlan,\n    user: UserWithProfile\n  ): Promise<Microcycle> {\n    console.log(`[ChainRunner] Running full microcycle chain for microcycle ${microcycle.id}`);\n\n    // Use microcycle agent service for full chain\n    // Fitness plan is auto-fetched by context service\n    // isDeload is determined by agent from plan's Progression Strategy\n    const result = await microcycleAgentService.generateMicrocycle(\n      user,\n      microcycle.absoluteWeek\n    );\n\n    const updated = await this.microcycleService.updateMicrocycle(microcycle.id, {\n      days: result.days,\n      description: result.description,\n      isDeload: result.isDeload,\n      message: result.message,\n      structured: result.structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update microcycle: ${microcycle.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runMicrocycleStructuredChain(microcycle: Microcycle): Promise<Microcycle> {\n    console.log(`[ChainRunner] Running structured chain for microcycle ${microcycle.id}`);\n\n    const agent = await microcycleAgentService.getStructuredAgent();\n\n    // Configurable agents expect JSON string input\n    const inputJson = JSON.stringify({\n      overview: microcycle.description || '',\n      days: microcycle.days,\n      absoluteWeek: microcycle.absoluteWeek,\n      isDeload: microcycle.isDeload,\n    });\n\n    const result = await agent.invoke(inputJson);\n    const structure = result.response;\n\n    const updated = await this.microcycleService.updateMicrocycle(microcycle.id, {\n      structured: structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update microcycle: ${microcycle.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runMicrocycleMessageChain(microcycle: Microcycle): Promise<Microcycle> {\n    console.log(`[ChainRunner] Running message chain for microcycle ${microcycle.id}`);\n\n    const agent = await microcycleAgentService.getMessageAgent();\n\n    // Configurable agents expect JSON string input\n    const inputJson = JSON.stringify({\n      overview: microcycle.description || '',\n      days: microcycle.days,\n      isDeload: microcycle.isDeload,\n    });\n\n    const result = await agent.invoke(inputJson);\n    const message = result.response;\n\n    const updated = await this.microcycleService.updateMicrocycle(microcycle.id, {\n      message,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update microcycle: ${microcycle.id}`);\n    }\n\n    return updated;\n  }\n\n  // ============================================\n  // WORKOUT OPERATIONS\n  // ============================================\n\n  /**\n   * Run a chain operation for a workout\n   */\n  async runWorkoutChain(\n    workoutId: string,\n    operation: ChainOperation\n  ): Promise<ChainRunResult<WorkoutInstance>> {\n    const startTime = Date.now();\n\n    // Fetch the workout\n    const workout = await this.workoutService.getWorkoutByIdInternal(workoutId);\n    if (!workout) {\n      throw new Error(`Workout not found: ${workoutId}`);\n    }\n\n    // Fetch the user with profile\n    const user = await this.userService.getUser(workout.clientId);\n    if (!user) {\n      throw new Error(`User not found: ${workout.clientId}`);\n    }\n\n    // Fetch microcycle for full regeneration\n    let microcycle: Microcycle | null = null;\n    if (workout.microcycleId) {\n      microcycle = await this.microcycleService.getMicrocycleById(workout.microcycleId);\n    }\n\n    let updatedWorkout: WorkoutInstance;\n\n    switch (operation) {\n      case 'full':\n        updatedWorkout = await this.runFullWorkoutChain(workout, user, microcycle);\n        break;\n      case 'structured':\n        updatedWorkout = await this.runWorkoutStructuredChain(workout);\n        break;\n      case 'message':\n        updatedWorkout = await this.runWorkoutMessageChain(workout);\n        break;\n      default:\n        throw new Error(`Unknown operation: ${operation}`);\n    }\n\n    return {\n      success: true,\n      data: updatedWorkout,\n      executionTimeMs: Date.now() - startTime,\n      operation,\n    };\n  }\n\n  private async runFullWorkoutChain(\n    workout: WorkoutInstance,\n    user: UserWithProfile,\n    microcycle: Microcycle | null\n  ): Promise<WorkoutInstance> {\n    console.log(`[ChainRunner] Running full workout chain for workout ${workout.id}`);\n\n    // Determine day overview and activity type from microcycle\n    let dayOverview = workout.goal || 'General workout';\n    let activityType: 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST' | undefined;\n    if (microcycle) {\n      const workoutDate = new Date(workout.date);\n      const dayOfWeek = workoutDate.getDay(); // 0 = Sunday\n      // Convert to microcycle days array index (0 = Monday)\n      const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\n      if (microcycle.days[dayIndex]) {\n        dayOverview = microcycle.days[dayIndex];\n      }\n      // Get activity type from structured data\n      const structuredDay = microcycle.structured?.days?.[dayIndex];\n      activityType = structuredDay?.activityType as 'TRAINING' | 'ACTIVE_RECOVERY' | 'REST' | undefined;\n    }\n\n    // Use workout agent service for full chain\n    const result = await workoutAgentService.generateWorkout(\n      user,\n      dayOverview,\n      microcycle?.isDeload || false,\n      activityType\n    );\n\n    const updated = await this.workoutService.updateWorkout(workout.id, {\n      description: result.response,\n      message: result.message,\n      structured: result.structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update workout: ${workout.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runWorkoutStructuredChain(workout: WorkoutInstance): Promise<WorkoutInstance> {\n    console.log(`[ChainRunner] Running structured chain for workout ${workout.id}`);\n\n    if (!workout.description) {\n      throw new Error(`Workout ${workout.id} has no description to parse`);\n    }\n\n    const agent = await workoutAgentService.getStructuredAgent();\n    const result = await agent.invoke(workout.description);\n    const structure = result.response;\n\n    const updated = await this.workoutService.updateWorkout(workout.id, {\n      structured: structure,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update workout: ${workout.id}`);\n    }\n\n    return updated;\n  }\n\n  private async runWorkoutMessageChain(workout: WorkoutInstance): Promise<WorkoutInstance> {\n    console.log(`[ChainRunner] Running message chain for workout ${workout.id}`);\n\n    if (!workout.description) {\n      throw new Error(`Workout ${workout.id} has no description to create message from`);\n    }\n\n    const agent = await workoutAgentService.getMessageAgent();\n    const result = await agent.invoke(workout.description);\n    const message = result.response;\n\n    const updated = await this.workoutService.updateWorkout(workout.id, {\n      message,\n    });\n\n    if (!updated) {\n      throw new Error(`Failed to update workout: ${workout.id}`);\n    }\n\n    return updated;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 14046, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/referralRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { Referral, NewReferral } from '../models/referral';\nimport { sql } from 'kysely';\n\n/**\n * Repository for managing referrals\n * Handles storage and retrieval of referral relationships\n */\nexport class ReferralRepository extends BaseRepository {\n  /**\n   * Create a new referral record\n   * Called when a referee signs up using a referral code\n   */\n  async create(referrerId: string, refereeId: string): Promise<Referral> {\n    const result = await this.db\n      .insertInto('referrals')\n      .values({\n        referrerId,\n        refereeId,\n        creditApplied: false,\n        creditAmountCents: 0,\n        createdAt: new Date(),\n      })\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Find a referral by referee ID\n   * Used by webhook to find the referral when crediting the referrer\n   */\n  async findByRefereeId(refereeId: string): Promise<Referral | null> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .selectAll()\n      .where('refereeId', '=', refereeId)\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Find all referrals for a referrer\n   * Used for displaying referral stats on the /me page\n   */\n  async findByReferrerId(referrerId: string): Promise<Referral[]> {\n    return await this.db\n      .selectFrom('referrals')\n      .selectAll()\n      .where('referrerId', '=', referrerId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n  }\n\n  /**\n   * Mark a referral as credited\n   * Called after successfully applying credit to the referrer's Stripe account\n   */\n  async markCreditApplied(id: string, amountCents: number): Promise<Referral> {\n    const result = await this.db\n      .updateTable('referrals')\n      .set({\n        creditApplied: true,\n        creditAmountCents: amountCents,\n        creditedAt: new Date(),\n      })\n      .where('id', '=', id)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Count credits earned by a referrer\n   * Only counts referrals where credit was actually applied\n   */\n  async countCreditsEarned(referrerId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select(sql<number>`count(*)`.as('count'))\n      .where('referrerId', '=', referrerId)\n      .where('creditApplied', '=', true)\n      .executeTakeFirst();\n\n    return Number(result?.count || 0);\n  }\n\n  /**\n   * Count total referrals by a referrer (regardless of credit status)\n   */\n  async countByReferrer(referrerId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select(sql<number>`count(*)`.as('count'))\n      .where('referrerId', '=', referrerId)\n      .executeTakeFirst();\n\n    return Number(result?.count || 0);\n  }\n\n  /**\n   * Check if a user has already been referred\n   * Each user can only be referred once\n   */\n  async hasBeenReferred(refereeId: string): Promise<boolean> {\n    const result = await this.db\n      .selectFrom('referrals')\n      .select('id')\n      .where('refereeId', '=', refereeId)\n      .executeTakeFirst();\n\n    return !!result;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAMO,MAAM,2BAA2B,yLAAc;IACpD;;;GAGC,GACD,MAAM,OAAO,UAAkB,EAAE,SAAiB,EAAqB;QACrE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC;YACN;YACA;YACA,eAAe;YACf,mBAAmB;YACnB,WAAW,IAAI;QACjB,GACC,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,gBAAgB,SAAiB,EAA4B;QACjE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,SAAS,GACT,KAAK,CAAC,aAAa,KAAK,WACxB,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;;GAGC,GACD,MAAM,iBAAiB,UAAkB,EAAuB;QAC9D,OAAO,MAAM,IAAI,CAAC,EAAE,CACjB,UAAU,CAAC,aACX,SAAS,GACT,KAAK,CAAC,cAAc,KAAK,YACzB,OAAO,CAAC,aAAa,QACrB,OAAO;IACZ;IAEA;;;GAGC,GACD,MAAM,kBAAkB,EAAU,EAAE,WAAmB,EAAqB;QAC1E,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,WAAW,CAAC,aACZ,GAAG,CAAC;YACH,eAAe;YACf,mBAAmB;YACnB,YAAY,IAAI;QAClB,GACC,KAAK,CAAC,MAAM,KAAK,IACjB,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;;GAGC,GACD,MAAM,mBAAmB,UAAkB,EAAmB;QAC5D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,2NAAG,AAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,UAChC,KAAK,CAAC,cAAc,KAAK,YACzB,KAAK,CAAC,iBAAiB,KAAK,MAC5B,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;IAEA;;GAEC,GACD,MAAM,gBAAgB,UAAkB,EAAmB;QACzD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,2NAAG,AAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,UAChC,KAAK,CAAC,cAAc,KAAK,YACzB,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;IAEA;;;GAGC,GACD,MAAM,gBAAgB,SAAiB,EAAoB;QACzD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,aACX,MAAM,CAAC,MACP,KAAK,CAAC,aAAa,KAAK,WACxB,gBAAgB;QAEnB,OAAO,CAAC,CAAC;IACX;AACF"}},
    {"offset": {"line": 14117, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/pageVisitRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { NewPageVisit, PageVisit } from '@/server/models/pageVisit';\n\nexport class PageVisitRepository extends BaseRepository {\n  /**\n   * Record a new page visit\n   */\n  async record(visit: NewPageVisit): Promise<PageVisit> {\n    const result = await this.db\n      .insertInto('pageVisits')\n      .values(visit)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Get visits within a date range\n   */\n  async getVisitsByDateRange(\n    startDate: Date,\n    endDate: Date,\n    options?: { source?: string; limit?: number }\n  ): Promise<PageVisit[]> {\n    let query = this.db\n      .selectFrom('pageVisits')\n      .selectAll()\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .orderBy('createdAt', 'desc');\n\n    if (options?.source) {\n      query = query.where('source', '=', options.source);\n    }\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    return query.execute();\n  }\n\n  /**\n   * Get aggregated visit counts by source\n   */\n  async getVisitCountsBySource(\n    startDate: Date,\n    endDate: Date\n  ): Promise<{ source: string | null; count: number }[]> {\n    const results = await this.db\n      .selectFrom('pageVisits')\n      .select(['source'])\n      .select((eb) => eb.fn.count('id').as('count'))\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .groupBy('source')\n      .orderBy('count', 'desc')\n      .execute();\n\n    return results.map((r) => ({\n      source: r.source,\n      count: Number(r.count),\n    }));\n  }\n\n  /**\n   * Get total visit count for a date range\n   */\n  async getTotalVisits(startDate: Date, endDate: Date): Promise<number> {\n    const result = await this.db\n      .selectFrom('pageVisits')\n      .select((eb) => eb.fn.count('id').as('count'))\n      .where('createdAt', '>=', startDate)\n      .where('createdAt', '<=', endDate)\n      .executeTakeFirst();\n\n    return Number(result?.count ?? 0);\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,4BAA4B,yLAAc;IACrD;;GAEC,GACD,MAAM,OAAO,KAAmB,EAAsB;QACpD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,MAAM,CAAC,OACP,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,qBACJ,SAAe,EACf,OAAa,EACb,OAA6C,EACvB;QACtB,IAAI,QAAQ,IAAI,CAAC,EAAE,CAChB,UAAU,CAAC,cACX,SAAS,GACT,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,OAAO,CAAC,aAAa;QAExB,IAAI,SAAS,QAAQ;YACnB,QAAQ,MAAM,KAAK,CAAC,UAAU,KAAK,QAAQ,MAAM;QACnD;QAEA,IAAI,SAAS,OAAO;YAClB,QAAQ,MAAM,KAAK,CAAC,QAAQ,KAAK;QACnC;QAEA,OAAO,MAAM,OAAO;IACtB;IAEA;;GAEC,GACD,MAAM,uBACJ,SAAe,EACf,OAAa,EACwC;QACrD,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,cACX,MAAM,CAAC;YAAC;SAAS,EACjB,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,UACpC,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,OAAO,CAAC,UACR,OAAO,CAAC,SAAS,QACjB,OAAO;QAEV,OAAO,QAAQ,GAAG,CAAC,CAAC,IAAM,CAAC;gBACzB,QAAQ,EAAE,MAAM;gBAChB,OAAO,OAAO,EAAE,KAAK;YACvB,CAAC;IACH;IAEA;;GAEC,GACD,MAAM,eAAe,SAAe,EAAE,OAAa,EAAmB;QACpE,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,cACX,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,UACpC,KAAK,CAAC,aAAa,MAAM,WACzB,KAAK,CAAC,aAAa,MAAM,SACzB,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;AACF"}},
    {"offset": {"line": 14164, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/adminActivityLogRepository.ts"],"sourcesContent":["import { BaseRepository } from '@/server/repositories/baseRepository';\n\nexport class AdminActivityLogRepository extends BaseRepository {\n  async log(params: {\n    actorClientId?: string | null;\n    targetClientId: string;\n    action: string;\n    payload?: unknown;\n    result: 'success' | 'failure';\n    errorMessage?: string | null;\n  }): Promise<void> {\n    await this.db\n      .insertInto('adminActivityLogs')\n      .values({\n        actorClientId: params.actorClientId ?? null,\n        targetClientId: params.targetClientId,\n        action: params.action,\n        // JSON stringify/parse to ensure it's JSON-serializable for jsonb\n        payload: JSON.parse(JSON.stringify(params.payload ?? {})),\n        result: params.result,\n        errorMessage: params.errorMessage ?? null,\n      })\n      .execute();\n  }\n\n  async listForClient(targetClientId: string, options: { page?: number; pageSize?: number } = {}) {\n    const page = options.page ?? 1;\n    const pageSize = options.pageSize ?? 20;\n\n    const rows = await this.db\n      .selectFrom('adminActivityLogs')\n      .selectAll()\n      .where('targetClientId', '=', targetClientId)\n      .orderBy('createdAt', 'desc')\n      .offset((page - 1) * pageSize)\n      .limit(pageSize)\n      .execute();\n\n    return rows;\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,mCAAmC,yLAAc;IAC5D,MAAM,IAAI,MAOT,EAAiB;QAChB,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,qBACX,MAAM,CAAC;YACN,eAAe,OAAO,aAAa,IAAI;YACvC,gBAAgB,OAAO,cAAc;YACrC,QAAQ,OAAO,MAAM;YACrB,kEAAkE;YAClE,SAAS,KAAK,KAAK,CAAC,KAAK,SAAS,CAAC,OAAO,OAAO,IAAI,CAAC;YACtD,QAAQ,OAAO,MAAM;YACrB,cAAc,OAAO,YAAY,IAAI;QACvC,GACC,OAAO;IACZ;IAEA,MAAM,cAAc,cAAsB,EAAE,UAAgD,CAAC,CAAC,EAAE;QAC9F,MAAM,OAAO,QAAQ,IAAI,IAAI;QAC7B,MAAM,WAAW,QAAQ,QAAQ,IAAI;QAErC,MAAM,OAAO,MAAM,IAAI,CAAC,EAAE,CACvB,UAAU,CAAC,qBACX,SAAS,GACT,KAAK,CAAC,kBAAkB,KAAK,gBAC7B,OAAO,CAAC,aAAa,QACrB,MAAM,CAAC,CAAC,OAAO,CAAC,IAAI,UACpB,KAAK,CAAC,UACN,OAAO;QAEV,OAAO;IACT;AACF"}},
    {"offset": {"line": 14193, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/profileUpdateRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport type { ProfileUpdates } from '../models/_types';\nimport type { Selectable, Insertable } from 'kysely';\n\nexport type ProfileUpdate = Selectable<ProfileUpdates>;\nexport type NewProfileUpdate = Insertable<ProfileUpdates>;\n\nexport class ProfileUpdateRepository extends BaseRepository {\n  /**\n   * Create a new profile update audit record\n   */\n  async create(update: NewProfileUpdate): Promise<ProfileUpdate> {\n    const result = await this.db\n      .insertInto('profileUpdates')\n      .values(update)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n\n    return result;\n  }\n\n  /**\n   * Get profile updates for a specific client\n   */\n  async getClientUpdates(\n    clientId: string,\n    limit: number = 10\n  ): Promise<ProfileUpdate[]> {\n    const updates = await this.db\n      .selectFrom('profileUpdates')\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .selectAll()\n      .execute();\n\n    return updates;\n  }\n\n  /**\n   * Get recent profile updates across all users (for monitoring)\n   */\n  async getRecentUpdates(limit: number = 50): Promise<ProfileUpdate[]> {\n    const updates = await this.db\n      .selectFrom('profileUpdates')\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .selectAll()\n      .execute();\n\n    return updates;\n  }\n\n  /**\n   * Get profile updates by source (e.g., 'chat', 'admin', 'api')\n   */\n  async getUpdatesBySource(\n    source: string,\n    limit: number = 50\n  ): Promise<ProfileUpdate[]> {\n    const updates = await this.db\n      .selectFrom('profileUpdates')\n      .where('source', '=', source)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .selectAll()\n      .execute();\n\n    return updates;\n  }\n\n  /**\n   * Count profile updates for a client\n   */\n  async countClientUpdates(clientId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('profileUpdates')\n      .where('clientId', '=', clientId)\n      .select(this.db.fn.count('id').as('count'))\n      .executeTakeFirstOrThrow();\n\n    return Number(result.count);\n  }\n}"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,gCAAgC,yLAAc;IACzD;;GAEC,GACD,MAAM,OAAO,MAAwB,EAA0B;QAC7D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,MAAM,CAAC,QACP,YAAY,GACZ,uBAAuB;QAE1B,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,iBACJ,QAAgB,EAChB,QAAgB,EAAE,EACQ;QAC1B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,kBACX,KAAK,CAAC,YAAY,KAAK,UACvB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,OACN,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,iBAAiB,QAAgB,EAAE,EAA4B;QACnE,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,kBACX,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,OACN,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,mBACJ,MAAc,EACd,QAAgB,EAAE,EACQ;QAC1B,MAAM,UAAU,MAAM,IAAI,CAAC,EAAE,CAC1B,UAAU,CAAC,kBACX,KAAK,CAAC,UAAU,KAAK,QACrB,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC,OACN,SAAS,GACT,OAAO;QAEV,OAAO;IACT;IAEA;;GAEC,GACD,MAAM,mBAAmB,QAAgB,EAAmB;QAC1D,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,kBACX,KAAK,CAAC,YAAY,KAAK,UACvB,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,UACjC,uBAAuB;QAE1B,OAAO,OAAO,OAAO,KAAK;IAC5B;AACF"}},
    {"offset": {"line": 14235, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/userAuthRepository.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\n\n/**\n * Repository for managing user authentication codes\n * Handles storage and retrieval of SMS verification codes\n */\nexport class UserAuthRepository extends BaseRepository {\n  /**\n   * Create a new authentication code for a phone number\n   */\n  async createAuthCode(\n    phoneNumber: string,\n    code: string,\n    expiresAt: Date\n  ): Promise<void> {\n    await this.db\n      .insertInto('userAuthCodes')\n      .values({\n        phoneNumber,\n        code,\n        expiresAt,\n        createdAt: new Date(),\n      })\n      .execute();\n  }\n\n  /**\n   * Find a valid (non-expired) auth code for a phone number\n   * Returns the code if found and not expired, null otherwise\n   */\n  async findValidCode(\n    phoneNumber: string,\n    code: string\n  ): Promise<{ id: string; phoneNumber: string } | null> {\n    const result = await this.db\n      .selectFrom('userAuthCodes')\n      .select(['id', 'phoneNumber'])\n      .where('phoneNumber', '=', phoneNumber)\n      .where('code', '=', code)\n      .where('expiresAt', '>', new Date())\n      .executeTakeFirst();\n\n    return result || null;\n  }\n\n  /**\n   * Delete all auth codes for a phone number\n   * Used after successful verification or to clear old codes\n   */\n  async deleteCodesForPhone(phoneNumber: string): Promise<void> {\n    await this.db\n      .deleteFrom('userAuthCodes')\n      .where('phoneNumber', '=', phoneNumber)\n      .execute();\n  }\n\n  /**\n   * Delete all expired auth codes\n   * Should be run periodically to clean up the database\n   */\n  async deleteExpiredCodes(): Promise<number> {\n    const result = await this.db\n      .deleteFrom('userAuthCodes')\n      .where('expiresAt', '<', new Date())\n      .executeTakeFirst();\n\n    return Number(result.numDeletedRows || 0);\n  }\n\n  /**\n   * Count recent auth code requests for a phone number\n   * Used for rate limiting\n   */\n  async countRecentRequests(\n    phoneNumber: string,\n    since: Date\n  ): Promise<number> {\n    const result = await this.db\n      .selectFrom('userAuthCodes')\n      .select((eb) => eb.fn.countAll<number>().as('count'))\n      .where('phoneNumber', '=', phoneNumber)\n      .where('createdAt', '>=', since)\n      .executeTakeFirst();\n\n    return Number(result?.count || 0);\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAMO,MAAM,2BAA2B,yLAAc;IACpD;;GAEC,GACD,MAAM,eACJ,WAAmB,EACnB,IAAY,EACZ,SAAe,EACA;QACf,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,iBACX,MAAM,CAAC;YACN;YACA;YACA;YACA,WAAW,IAAI;QACjB,GACC,OAAO;IACZ;IAEA;;;GAGC,GACD,MAAM,cACJ,WAAmB,EACnB,IAAY,EACyC;QACrD,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,iBACX,MAAM,CAAC;YAAC;YAAM;SAAc,EAC5B,KAAK,CAAC,eAAe,KAAK,aAC1B,KAAK,CAAC,QAAQ,KAAK,MACnB,KAAK,CAAC,aAAa,KAAK,IAAI,QAC5B,gBAAgB;QAEnB,OAAO,UAAU;IACnB;IAEA;;;GAGC,GACD,MAAM,oBAAoB,WAAmB,EAAiB;QAC5D,MAAM,IAAI,CAAC,EAAE,CACV,UAAU,CAAC,iBACX,KAAK,CAAC,eAAe,KAAK,aAC1B,OAAO;IACZ;IAEA;;;GAGC,GACD,MAAM,qBAAsC;QAC1C,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,iBACX,KAAK,CAAC,aAAa,KAAK,IAAI,QAC5B,gBAAgB;QAEnB,OAAO,OAAO,OAAO,cAAc,IAAI;IACzC;IAEA;;;GAGC,GACD,MAAM,oBACJ,WAAmB,EACnB,KAAW,EACM;QACjB,MAAM,SAAS,MAAM,IAAI,CAAC,EAAE,CACzB,UAAU,CAAC,iBACX,MAAM,CAAC,CAAC,KAAO,GAAG,EAAE,CAAC,QAAQ,GAAW,EAAE,CAAC,UAC3C,KAAK,CAAC,eAAe,KAAK,aAC1B,KAAK,CAAC,aAAa,MAAM,OACzB,gBAAgB;QAEnB,OAAO,OAAO,QAAQ,SAAS;IACjC;AACF"}},
    {"offset": {"line": 14287, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/repositories/factory.ts"],"sourcesContent":["/**\n * Repository Factory\n *\n * Creates repository instances with a specific database connection.\n * Used for environment switching in the admin app.\n *\n * @example\n * const ctx = await createEnvContext();\n * const repos = createRepositories(ctx.db);\n * const users = await repos.user.findAll();\n */\nimport type { Kysely } from 'kysely';\nimport type { DB } from '../models/_types';\n\n// Import all repository classes\nimport { UserRepository } from './userRepository';\nimport { MessageRepository } from './messageRepository';\nimport { ProfileRepository } from './profileRepository';\nimport { FitnessPlanRepository } from './fitnessPlanRepository';\nimport { WorkoutInstanceRepository } from './workoutInstanceRepository';\nimport { MicrocycleRepository } from './microcycleRepository';\nimport { SubscriptionRepository } from './subscriptionRepository';\nimport { OnboardingRepository } from './onboardingRepository';\nimport { PromptRepository } from './promptRepository';\nimport { DayConfigRepository } from './dayConfigRepository';\nimport { MessageQueueRepository } from './messageQueueRepository';\nimport { ShortLinkRepository } from './shortLinkRepository';\nimport { ReferralRepository } from './referralRepository';\nimport { PageVisitRepository } from './pageVisitRepository';\nimport { AdminActivityLogRepository } from './adminActivityLogRepository';\nimport { UploadedImageRepository } from './uploadedImageRepository';\nimport { ProfileUpdateRepository } from './profileUpdateRepository';\nimport { UserAuthRepository } from './userAuthRepository';\n\n/**\n * Container for all repository instances\n */\nexport interface RepositoryContainer {\n  user: UserRepository;\n  message: MessageRepository;\n  profile: ProfileRepository;\n  fitnessPlan: FitnessPlanRepository;\n  workoutInstance: WorkoutInstanceRepository;\n  microcycle: MicrocycleRepository;\n  subscription: SubscriptionRepository;\n  onboarding: OnboardingRepository;\n  prompt: PromptRepository;\n  dayConfig: DayConfigRepository;\n  messageQueue: MessageQueueRepository;\n  shortLink: ShortLinkRepository;\n  referral: ReferralRepository;\n  pageVisit: PageVisitRepository;\n  adminActivityLog: AdminActivityLogRepository;\n  uploadedImage: UploadedImageRepository;\n  profileUpdate: ProfileUpdateRepository;\n  userAuth: UserAuthRepository;\n}\n\n// Cache repositories by database connection string (approximated by object identity)\nconst repoCache = new WeakMap<Kysely<DB>, RepositoryContainer>();\n\n/**\n * Create all repository instances with a specific database connection\n *\n * @param db - Kysely database instance\n * @returns Container with all repository instances\n */\nexport function createRepositories(db: Kysely<DB>): RepositoryContainer {\n  // Return cached instance if available\n  const cached = repoCache.get(db);\n  if (cached) {\n    return cached;\n  }\n\n  // Create new repository instances\n  const repos: RepositoryContainer = {\n    user: new UserRepository(db),\n    message: new MessageRepository(db),\n    profile: new ProfileRepository(db),\n    fitnessPlan: new FitnessPlanRepository(db),\n    workoutInstance: new WorkoutInstanceRepository(db),\n    microcycle: new MicrocycleRepository(db),\n    subscription: new SubscriptionRepository(db),\n    onboarding: new OnboardingRepository(db),\n    prompt: new PromptRepository(db),\n    dayConfig: new DayConfigRepository(db),\n    messageQueue: new MessageQueueRepository(db),\n    shortLink: new ShortLinkRepository(db),\n    referral: new ReferralRepository(db),\n    pageVisit: new PageVisitRepository(db),\n    adminActivityLog: new AdminActivityLogRepository(db),\n    uploadedImage: new UploadedImageRepository(db),\n    profileUpdate: new ProfileUpdateRepository(db),\n    userAuth: new UserAuthRepository(db),\n  };\n\n  // Cache for reuse\n  repoCache.set(db, repos);\n  return repos;\n}\n\n/**\n * Get repositories for a specific environment context\n * Convenience function that extracts db from context\n */\nexport function getRepositories(ctx: { db: Kysely<DB> }): RepositoryContainer {\n  return createRepositories(ctx.db);\n}\n"],"names":[],"mappings":"AAAA;;;;;;;;;;CAUC;;;;;;AAID,gCAAgC;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;AA0BA,qFAAqF;AACrF,MAAM,YAAY,IAAI;AAQf,SAAS,mBAAmB,EAAc;IAC/C,sCAAsC;IACtC,MAAM,SAAS,UAAU,GAAG,CAAC;IAC7B,IAAI,QAAQ;QACV,OAAO;IACT;IAEA,kCAAkC;IAClC,MAAM,QAA6B;QACjC,MAAM,IAAI,yLAAc,CAAC;QACzB,SAAS,IAAI,+LAAiB,CAAC;QAC/B,SAAS,IAAI,+LAAiB,CAAC;QAC/B,aAAa,IAAI,uMAAqB,CAAC;QACvC,iBAAiB,IAAI,+MAAyB,CAAC;QAC/C,YAAY,IAAI,qMAAoB,CAAC;QACrC,cAAc,IAAI,yMAAsB,CAAC;QACzC,YAAY,IAAI,qMAAoB,CAAC;QACrC,QAAQ,IAAI,6LAAgB,CAAC;QAC7B,WAAW,IAAI,mMAAmB,CAAC;QACnC,cAAc,IAAI,yMAAsB,CAAC;QACzC,WAAW,IAAI,mMAAmB,CAAC;QACnC,UAAU,IAAI,iMAAkB,CAAC;QACjC,WAAW,IAAI,mMAAmB,CAAC;QACnC,kBAAkB,IAAI,iNAA0B,CAAC;QACjD,eAAe,IAAI,2MAAuB,CAAC;QAC3C,eAAe,IAAI,2MAAuB,CAAC;QAC3C,UAAU,IAAI,iMAAkB,CAAC;IACnC;IAEA,kBAAkB;IAClB,UAAU,GAAG,CAAC,IAAI;IAClB,OAAO;AACT;AAMO,SAAS,gBAAgB,GAAuB;IACrD,OAAO,mBAAmB,IAAI,EAAE;AAClC"}},
    {"offset": {"line": 14380, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/factory.ts"],"sourcesContent":["/**\n * Service Factory\n *\n * Creates service instances with a specific environment context.\n * Used for environment switching in the admin app.\n *\n * This factory provides context-aware versions of services that need\n * database, Twilio, or Stripe access. Services created through this\n * factory will use the context's connections instead of the default singletons.\n *\n * @example\n * const ctx = await createEnvContext();\n * const services = getServices(ctx);\n * await services.user.getUser(userId);\n */\nimport type { EnvironmentContext } from '../context/types';\nimport { createRepositories, type RepositoryContainer } from '../repositories/factory';\n\n// Import service classes that we'll wrap\nimport { UserService } from './user/userService';\nimport { FitnessProfileService } from './user/fitnessProfileService';\nimport { MessageService } from './messaging/messageService';\nimport { DailyMessageService } from './orchestration/dailyMessageService';\nimport { WeeklyMessageService } from './orchestration/weeklyMessageService';\nimport { DayConfigService } from './calendar/dayConfigService';\n\n/**\n * Service container with context-aware service instances\n *\n * Note: Some services are stateless static classes (ChatService, ProfileService, etc.)\n * and don't need context wrapping - they get context passed to their methods.\n *\n * This container provides the main data-access services that benefit from\n * being instantiated with a specific database connection.\n */\nexport interface ServiceContainer {\n  /** Repository container for direct data access */\n  repos: RepositoryContainer;\n\n  /** Context for accessing connections directly */\n  ctx: EnvironmentContext;\n\n  // Service instances would go here if we fully refactored them\n  // For now, use repos directly or call service static methods with ctx\n}\n\n// Cache service containers by environment mode\nconst containerCache = new Map<string, ServiceContainer>();\n\n/**\n * Get a service container for the given environment context\n *\n * @param ctx - Environment context with db, twilio, stripe connections\n * @returns Service container with context-aware services\n */\nexport function getServices(ctx: EnvironmentContext): ServiceContainer {\n  const cacheKey = ctx.mode;\n\n  // Return cached container if available\n  const cached = containerCache.get(cacheKey);\n  if (cached) {\n    return cached;\n  }\n\n  // Create new service container\n  const container: ServiceContainer = {\n    repos: createRepositories(ctx.db),\n    ctx,\n  };\n\n  // Cache for reuse\n  containerCache.set(cacheKey, container);\n  return container;\n}\n\n/**\n * Clear the service container cache (for testing)\n */\nexport function clearServiceCache(): void {\n  containerCache.clear();\n}\n\n/**\n * Helper type for services that accept context\n */\nexport type WithContext<T> = T & { ctx: EnvironmentContext };\n"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;CAcC;;;;;;AAED;;AA8BA,+CAA+C;AAC/C,MAAM,iBAAiB,IAAI;AAQpB,SAAS,YAAY,GAAuB;IACjD,MAAM,WAAW,IAAI,IAAI;IAEzB,uCAAuC;IACvC,MAAM,SAAS,eAAe,GAAG,CAAC;IAClC,IAAI,QAAQ;QACV,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,YAA8B;QAClC,OAAO,IAAA,sLAAkB,EAAC,IAAI,EAAE;QAChC;IACF;IAEA,kBAAkB;IAClB,eAAe,GAAG,CAAC,UAAU;IAC7B,OAAO;AACT;AAKO,SAAS;IACd,eAAe,KAAK;AACtB"}},
    {"offset": {"line": 14427, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/services/index.ts"],"sourcesContent":["// Entity services (from /services/training/, /services/user/, /services/messaging/)\n// NOTE: These must be imported first as they're used to initialize ContextService\nimport { fitnessPlanService } from './training/fitnessPlanService';\nimport { workoutInstanceService } from './training/workoutInstanceService';\nimport { microcycleService } from './training/microcycleService';\nimport { progressService } from './training/progressService';\nexport { fitnessPlanService, workoutInstanceService, microcycleService, progressService };\n\n// Context service initialization (must happen before any agent services are used)\nimport { ContextService } from './context';\nimport { ProfileRepository } from '@/server/repositories/profileRepository';\n\nContextService.initialize({\n  fitnessPlanService,\n  workoutInstanceService,\n  microcycleService,\n  profileRepository: new ProfileRepository(),\n});\n\n// Agent orchestration services (from /services/agents/)\n// These use static methods - call directly e.g. ChatService.handleIncomingMessage()\nexport { ChatService } from './agents/chat';\nexport { ModificationService } from './agents/modifications';\nexport { ProfileService } from './agents/profile';\n\n// Sub-services for modifications (still use singleton pattern)\nexport {\n  workoutModificationService,\n  planModificationService,\n} from './agents/modifications';\nexport type {\n  WorkoutModificationService,\n  ModifyWorkoutResult,\n  ModifyWeekResult,\n  PlanModificationService,\n  ModifyPlanParams,\n  ModifyPlanResult,\n} from './agents/modifications';\n\n// Non-agent orchestration services (from /services/orchestration/)\nexport { dailyMessageService } from './orchestration/dailyMessageService';\nexport { weeklyMessageService } from './orchestration/weeklyMessageService';\nexport { onboardingService } from './orchestration/onboardingService';\n\nexport type { DailyMessageService } from './orchestration/dailyMessageService';\nexport type { WeeklyMessageService } from './orchestration/weeklyMessageService';\nexport type { OnboardingService } from './orchestration/onboardingService';\n\nexport type { FitnessPlanService } from './training/fitnessPlanService';\nexport type { ProgressService } from './training/progressService';\nexport type { WorkoutInstanceService } from './training/workoutInstanceService';\nexport type { MicrocycleService } from './training/microcycleService';\n\nexport { userService } from './user/userService';\nexport { fitnessProfileService } from './user/fitnessProfileService';\nexport { onboardingDataService } from './user/onboardingDataService';\n\nexport type { UserService, CreateUserRequest } from './user/userService';\nexport type { FitnessProfileService, ProfileUpdateResult } from './user/fitnessProfileService';\nexport type { OnboardingDataService } from './user/onboardingDataService';\n\nexport { messageService } from './messaging/messageService';\n\nexport type { MessageService } from './messaging/messageService';\n\nexport { subscriptionService } from './subscription/subscriptionService';\n\nexport type {\n  SubscriptionService,\n  CancelResult,\n  ReactivateResult,\n} from './subscription/subscriptionService';\n\n// Chain runner service for testing/improving AI outputs\nexport { ChainRunnerService } from './training/chainRunnerService';\nexport type { ChainOperation, ChainRunResult, ProfileRegenerationResult } from './training/chainRunnerService';\n\n// Calendar services\nexport { dayConfigService } from './calendar/dayConfigService';\nexport type { DayConfigService } from './calendar/dayConfigService';\n\n// Service factory (for environment context switching)\nexport { getServices, clearServiceCache } from './factory';\nexport type { ServiceContainer, WithContext } from './factory';\n"],"names":[],"mappings":"AAAA,oFAAoF;AACpF,kFAAkF;;AAClF;AACA;AACA;AACA;AAGA,kFAAkF;AAClF;AAAA;AACA;AASA,wDAAwD;AACxD,oFAAoF;AACpF;AACA;AACA;AAgBA,mEAAmE;AACnE;AACA;AACA;AAWA;AACA;AACA;AAMA;AAIA;AAQA,wDAAwD;AACxD;AAGA,oBAAoB;AACpB;AAGA,sDAAsD;AACtD;;;;;;;;AAtEA,gMAAc,CAAC,UAAU,CAAC;IACxB,oBAAA,yMAAkB;IAClB,wBAAA,iNAAsB;IACtB,mBAAA,uMAAiB;IACjB,mBAAmB,IAAI,+LAAiB;AAC1C"}},
    {"offset": {"line": 14490, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/sessionCrypto.ts"],"sourcesContent":["import crypto from 'crypto';\nimport { getDatabaseSecrets } from '@/server/config';\n\n/**\n * Session crypto utilities for encrypting and decrypting user IDs in session cookies\n * Uses AES-256-GCM for authenticated encryption\n */\n\nconst ALGORITHM = 'aes-256-gcm';\nconst IV_LENGTH = 16; // For GCM mode\nconst AUTH_TAG_LENGTH = 16;\nconst KEY_LENGTH = 32; // 256 bits\n\n/**\n * Get the encryption key from config\n * In production, this should be a strong random key stored securely\n */\nfunction getEncryptionKey(): Buffer {\n  const { sessionEncryptionKey } = getDatabaseSecrets();\n\n  if (!sessionEncryptionKey) {\n    // For development, use a default key (NOT for production!)\n    console.warn('SESSION_ENCRYPTION_KEY not set, using development key');\n    return crypto.scryptSync('gymtext-dev-key', 'salt', KEY_LENGTH);\n  }\n\n  // If key is hex-encoded, decode it\n  if (sessionEncryptionKey.length === KEY_LENGTH * 2) {\n    return Buffer.from(sessionEncryptionKey, 'hex');\n  }\n\n  // Otherwise, derive key from string\n  return crypto.scryptSync(sessionEncryptionKey, 'salt', KEY_LENGTH);\n}\n\n/**\n * Encrypt a user ID for use in a session cookie\n * Returns a base64-encoded string containing IV + authTag + encrypted data\n */\nexport function encryptUserId(userId: string): string {\n  try {\n    const key = getEncryptionKey();\n    const iv = crypto.randomBytes(IV_LENGTH);\n\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n\n    let encrypted = cipher.update(userId, 'utf8', 'hex');\n    encrypted += cipher.final('hex');\n\n    const authTag = cipher.getAuthTag();\n\n    // Combine IV + authTag + encrypted data\n    const combined = Buffer.concat([\n      iv,\n      authTag,\n      Buffer.from(encrypted, 'hex')\n    ]);\n\n    return combined.toString('base64');\n  } catch (error) {\n    console.error('Error encrypting user ID:', error);\n    throw new Error('Failed to encrypt session');\n  }\n}\n\n/**\n * Decrypt a user ID from a session cookie\n * Returns the user ID or null if decryption fails\n */\nexport function decryptUserId(encryptedData: string): string | null {\n  try {\n    const key = getEncryptionKey();\n    const combined = Buffer.from(encryptedData, 'base64');\n\n    // Extract IV, authTag, and encrypted data\n    const iv = combined.subarray(0, IV_LENGTH);\n    const authTag = combined.subarray(IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH);\n    const encrypted = combined.subarray(IV_LENGTH + AUTH_TAG_LENGTH);\n\n    const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n    decipher.setAuthTag(authTag);\n\n    let decrypted = decipher.update(encrypted.toString('hex'), 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n\n    return decrypted;\n  } catch (error) {\n    console.error('Error decrypting user ID:', error);\n    return null;\n  }\n}\n\n/**\n * Generate a secure random encryption key for SESSION_ENCRYPTION_KEY\n * This is a utility function for generating a new key - run once and store securely\n */\nexport function generateEncryptionKey(): string {\n  return crypto.randomBytes(KEY_LENGTH).toString('hex');\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAAA;;;AAEA;;;CAGC,GAED,MAAM,YAAY;AAClB,MAAM,YAAY,IAAI,eAAe;AACrC,MAAM,kBAAkB;AACxB,MAAM,aAAa,IAAI,WAAW;AAElC;;;CAGC,GACD,SAAS;IACP,MAAM,EAAE,oBAAoB,EAAE,GAAG,IAAA,gLAAkB;IAEnD,IAAI,CAAC,sBAAsB;QACzB,2DAA2D;QAC3D,QAAQ,IAAI,CAAC;QACb,OAAO,gHAAM,CAAC,UAAU,CAAC,mBAAmB,QAAQ;IACtD;IAEA,mCAAmC;IACnC,IAAI,qBAAqB,MAAM,KAAK,aAAa,GAAG;QAClD,OAAO,OAAO,IAAI,CAAC,sBAAsB;IAC3C;IAEA,oCAAoC;IACpC,OAAO,gHAAM,CAAC,UAAU,CAAC,sBAAsB,QAAQ;AACzD;AAMO,SAAS,cAAc,MAAc;IAC1C,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,KAAK,gHAAM,CAAC,WAAW,CAAC;QAE9B,MAAM,SAAS,gHAAM,CAAC,cAAc,CAAC,WAAW,KAAK;QAErD,IAAI,YAAY,OAAO,MAAM,CAAC,QAAQ,QAAQ;QAC9C,aAAa,OAAO,KAAK,CAAC;QAE1B,MAAM,UAAU,OAAO,UAAU;QAEjC,wCAAwC;QACxC,MAAM,WAAW,OAAO,MAAM,CAAC;YAC7B;YACA;YACA,OAAO,IAAI,CAAC,WAAW;SACxB;QAED,OAAO,SAAS,QAAQ,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,MAAM,IAAI,MAAM;IAClB;AACF;AAMO,SAAS,cAAc,aAAqB;IACjD,IAAI;QACF,MAAM,MAAM;QACZ,MAAM,WAAW,OAAO,IAAI,CAAC,eAAe;QAE5C,0CAA0C;QAC1C,MAAM,KAAK,SAAS,QAAQ,CAAC,GAAG;QAChC,MAAM,UAAU,SAAS,QAAQ,CAAC,WAAW,YAAY;QACzD,MAAM,YAAY,SAAS,QAAQ,CAAC,YAAY;QAEhD,MAAM,WAAW,gHAAM,CAAC,gBAAgB,CAAC,WAAW,KAAK;QACzD,SAAS,UAAU,CAAC;QAEpB,IAAI,YAAY,SAAS,MAAM,CAAC,UAAU,QAAQ,CAAC,QAAQ,OAAO;QAClE,aAAa,SAAS,KAAK,CAAC;QAE5B,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;IACT;AACF;AAMO,SAAS;IACd,OAAO,gHAAM,CAAC,WAAW,CAAC,YAAY,QAAQ,CAAC;AACjD"}},
    {"offset": {"line": 14572, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/packages/shared/src/server/utils/authMiddleware.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport { decryptUserId } from './sessionCrypto';\n\n/**\n * Authorization result from checking request credentials\n */\nexport interface AuthResult {\n  isAuthorized: boolean;\n  isAdmin: boolean;\n  userId: string | null;\n  error?: string;\n}\n\n/**\n * Check if a request is authorized to access a specific user's data\n *\n * Authorization rules:\n * - Admin (gt_admin cookie) can access any user\n * - Regular user (gt_user_session cookie) can only access their own data\n *\n * @param request - The Next.js request object\n * @param requestedUserId - The user ID being requested\n * @returns AuthResult with authorization status\n */\nexport function checkAuthorization(\n  request: NextRequest,\n  requestedUserId: string\n): AuthResult {\n  // Check if user is admin\n  const isAdmin = request.cookies.get('gt_admin')?.value === 'ok';\n\n  if (isAdmin) {\n    return {\n      isAuthorized: true,\n      isAdmin: true,\n      userId: null, // Admin doesn't have a specific user ID\n    };\n  }\n\n  // Check if user has a valid session\n  const userSession = request.cookies.get('gt_user_session')?.value;\n\n  if (!userSession) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: null,\n      error: 'No authentication credentials provided',\n    };\n  }\n\n  // Decrypt the user ID from session\n  const authenticatedUserId = decryptUserId(userSession);\n\n  if (!authenticatedUserId) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: null,\n      error: 'Invalid session token',\n    };\n  }\n\n  // Check if the authenticated user matches the requested user\n  if (authenticatedUserId !== requestedUserId) {\n    return {\n      isAuthorized: false,\n      isAdmin: false,\n      userId: authenticatedUserId,\n      error: 'Unauthorized to access this user data',\n    };\n  }\n\n  return {\n    isAuthorized: true,\n    isAdmin: false,\n    userId: authenticatedUserId,\n  };\n}\n\n/**\n * Get the authenticated user ID from the session cookie\n * Returns null if not authenticated\n */\nexport function getAuthenticatedUserId(request: NextRequest): string | null {\n  const userSession = request.cookies.get('gt_user_session')?.value;\n\n  if (!userSession) {\n    return null;\n  }\n\n  return decryptUserId(userSession);\n}\n\n/**\n * Check if the request has admin authentication\n * Returns true if gt_admin cookie is set to 'ok'\n */\nexport function isAdminAuthenticated(request: NextRequest): boolean {\n  const adminCookie = request.cookies.get('gt_admin')?.value;\n  return adminCookie === 'ok';\n}\n"],"names":[],"mappings":";;;;;;;;AACA;;AAuBO,SAAS,mBACd,OAAoB,EACpB,eAAuB;IAEvB,yBAAyB;IACzB,MAAM,UAAU,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa,UAAU;IAE3D,IAAI,SAAS;QACX,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;QACV;IACF;IAEA,oCAAoC;IACpC,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;IAE5D,IAAI,CAAC,aAAa;QAChB,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,mCAAmC;IACnC,MAAM,sBAAsB,IAAA,gLAAa,EAAC;IAE1C,IAAI,CAAC,qBAAqB;QACxB,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,6DAA6D;IAC7D,IAAI,wBAAwB,iBAAiB;QAC3C,OAAO;YACL,cAAc;YACd,SAAS;YACT,QAAQ;YACR,OAAO;QACT;IACF;IAEA,OAAO;QACL,cAAc;QACd,SAAS;QACT,QAAQ;IACV;AACF;AAMO,SAAS,uBAAuB,OAAoB;IACzD,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;IAE5D,IAAI,CAAC,aAAa;QAChB,OAAO;IACT;IAEA,OAAO,IAAA,gLAAa,EAAC;AACvB;AAMO,SAAS,qBAAqB,OAAoB;IACvD,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;IACrD,OAAO,gBAAgB;AACzB"}},
    {"offset": {"line": 14642, "column": 0}, "map": {"version":3,"sources":["file:///Users/aaronparry/Developer/GymText/gymtext/apps/web/src/app/api/users/%5Bid%5D/fitness-plan/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { fitnessPlanService, progressService } from '@/server/services';\nimport { checkAuthorization } from '@/server/utils/authMiddleware';\n\n/**\n * GET /api/users/[id]/fitness-plan\n *\n * Get user's current fitness plan\n *\n * Authorization:\n * - Admin can access any user\n * - Regular user can only access their own data\n */\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: requestedUserId } = await params;\n\n    if (!requestedUserId) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: 'User ID is required',\n        },\n        { status: 400 }\n      );\n    }\n\n    // Check authorization\n    const auth = checkAuthorization(request, requestedUserId);\n\n    if (!auth.isAuthorized) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: auth.error || 'Unauthorized',\n        },\n        { status: 403 }\n      );\n    }\n\n    // Fetch current fitness plan\n    const fitnessPlan = await fitnessPlanService.getCurrentPlan(requestedUserId);\n\n    if (!fitnessPlan) {\n      return NextResponse.json(\n        {\n          success: false,\n          message: 'No fitness plan found for this user',\n        },\n        { status: 404 }\n      );\n    }\n\n    // Calculate current absoluteWeek based on plan start date\n    const progress = await progressService.getCurrentProgress(fitnessPlan);\n    const absoluteWeek = progress?.absoluteWeek ?? 1;\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...fitnessPlan,\n        absoluteWeek,\n      },\n    });\n  } catch (error) {\n    console.error('Error fetching fitness plan:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        message: 'Internal server error',\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;AAAA;AACA;;;;AAWO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,IAAI,eAAe,EAAE,GAAG,MAAM;QAEtC,IAAI,CAAC,iBAAiB;YACpB,OAAO,uTAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,SAAS;YACX,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,sBAAsB;QACtB,MAAM,OAAO,IAAA,sLAAkB,EAAC,SAAS;QAEzC,IAAI,CAAC,KAAK,YAAY,EAAE;YACtB,OAAO,uTAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,SAAS,KAAK,KAAK,IAAI;YACzB,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,6BAA6B;QAC7B,MAAM,cAAc,MAAM,yMAAkB,CAAC,cAAc,CAAC;QAE5D,IAAI,CAAC,aAAa;YAChB,OAAO,uTAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,SAAS;YACX,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,0DAA0D;QAC1D,MAAM,WAAW,MAAM,mMAAe,CAAC,kBAAkB,CAAC;QAC1D,MAAM,eAAe,UAAU,gBAAgB;QAE/C,OAAO,uTAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,GAAG,WAAW;gBACd;YACF;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,uTAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,SAAS;QACX,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}