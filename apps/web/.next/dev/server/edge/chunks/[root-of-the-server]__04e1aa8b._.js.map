{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/Developer/GymText/gymtext/apps/web/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\n/**\n * Paths that should be tracked for analytics.\n * Dynamic segments will be normalized to placeholders.\n */\nconst TRACKED_PATH_PREFIXES = ['/', '/me', '/l'];\n\n/**\n * Check if a path should be tracked.\n */\nfunction shouldTrack(pathname: string): boolean {\n  // Track root path exactly\n  if (pathname === '/') return true;\n\n  // Track paths starting with tracked prefixes\n  return TRACKED_PATH_PREFIXES.some(\n    (prefix) => prefix !== '/' && pathname.startsWith(prefix)\n  );\n}\n\n/**\n * Normalize path for analytics (replace dynamic segments with placeholders)\n */\nfunction normalizePath(fullPath: string): string {\n  // Remove query string for normalization\n  const pathOnly = fullPath.split('?')[0];\n\n  // Replace UUID-like segments with placeholder\n  return pathOnly.replace(/\\/[a-f0-9-]{36}/gi, '/:id');\n}\n\n/**\n * Fire tracking event (non-blocking).\n */\nfunction trackPageVisit(request: NextRequest): void {\n  const url = request.nextUrl;\n  const fullPath = url.pathname + url.search;\n\n  // Normalize the path for analytics\n  const normalizedPage = normalizePath(fullPath);\n  const source = url.searchParams.get('utm_source') || url.searchParams.get('ref') || null;\n\n  // Build absolute URL for the tracking endpoint\n  const trackUrl = new URL('/api/track', request.url);\n\n  // Fire-and-forget: don't await, just catch errors\n  fetch(trackUrl.toString(), {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      // Forward visitor metadata\n      'x-forwarded-for': request.headers.get('x-forwarded-for') ?? '',\n      'x-real-ip': request.headers.get('x-real-ip') ?? '',\n      'user-agent': request.headers.get('user-agent') ?? '',\n      referer: request.headers.get('referer') ?? '',\n    },\n    body: JSON.stringify({ page: normalizedPage, source }),\n  }).catch((err) => console.error('[Middleware] Tracking error:', err));\n}\n\n/**\n * Web app middleware\n * - Tracks page visits for analytics\n * - Protects /me routes with user session\n */\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n\n  // Fire tracking for relevant pages (non-blocking)\n  if (shouldTrack(pathname)) {\n    trackPageVisit(request);\n  }\n\n  // User /me path protection\n  const isClientPath = pathname.startsWith('/me');\n  const isClientLoginPath = pathname === '/me/login' || pathname === '/me/login/';\n\n  if (isClientPath) {\n    // Allow access to the login page without cookie\n    if (isClientLoginPath) {\n      return NextResponse.next();\n    }\n\n    const userSession = request.cookies.get('gt_user_session')?.value;\n\n    if (userSession) {\n      return NextResponse.next();\n    }\n\n    // Redirect to login\n    const url = request.nextUrl.clone();\n    url.pathname = '/me/login';\n    return NextResponse.redirect(url);\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\n    // Home page (tracking)\n    '/',\n    // User routes (auth + tracking)\n    '/me',\n    '/me/:path*',\n    // Short links (tracking)\n    '/l/:path*',\n  ],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;AAEA;;;CAGC,GACD,MAAM,wBAAwB;IAAC;IAAK;IAAO;CAAK;AAEhD;;CAEC,GACD,SAAS,YAAY,QAAgB;IACnC,0BAA0B;IAC1B,IAAI,aAAa,KAAK,OAAO;IAE7B,6CAA6C;IAC7C,OAAO,sBAAsB,IAAI,CAC/B,CAAC,SAAW,WAAW,OAAO,SAAS,UAAU,CAAC;AAEtD;AAEA;;CAEC,GACD,SAAS,cAAc,QAAgB;IACrC,wCAAwC;IACxC,MAAM,WAAW,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE;IAEvC,8CAA8C;IAC9C,OAAO,SAAS,OAAO,CAAC,qBAAqB;AAC/C;AAEA;;CAEC,GACD,SAAS,eAAe,OAAoB;IAC1C,MAAM,MAAM,QAAQ,OAAO;IAC3B,MAAM,WAAW,IAAI,QAAQ,GAAG,IAAI,MAAM;IAE1C,mCAAmC;IACnC,MAAM,iBAAiB,cAAc;IACrC,MAAM,SAAS,IAAI,YAAY,CAAC,GAAG,CAAC,iBAAiB,IAAI,YAAY,CAAC,GAAG,CAAC,UAAU;IAEpF,+CAA+C;IAC/C,MAAM,WAAW,IAAI,IAAI,cAAc,QAAQ,GAAG;IAElD,kDAAkD;IAClD,MAAM,SAAS,QAAQ,IAAI;QACzB,QAAQ;QACR,SAAS;YACP,gBAAgB;YAChB,2BAA2B;YAC3B,mBAAmB,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;YAC7D,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;YACjD,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;YACnD,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC,cAAc;QAC7C;QACA,MAAM,KAAK,SAAS,CAAC;YAAE,MAAM;YAAgB;QAAO;IACtD,GAAG,KAAK,CAAC,CAAC,MAAQ,QAAQ,KAAK,CAAC,gCAAgC;AAClE;AAOO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,kDAAkD;IAClD,IAAI,YAAY,WAAW;QACzB,eAAe;IACjB;IAEA,2BAA2B;IAC3B,MAAM,eAAe,SAAS,UAAU,CAAC;IACzC,MAAM,oBAAoB,aAAa,eAAe,aAAa;IAEnE,IAAI,cAAc;QAChB,gDAAgD;QAChD,IAAI,mBAAmB;YACrB,OAAO,0YAAY,CAAC,IAAI;QAC1B;QAEA,MAAM,cAAc,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB;QAE5D,IAAI,aAAa;YACf,OAAO,0YAAY,CAAC,IAAI;QAC1B;QAEA,oBAAoB;QACpB,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,OAAO,0YAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,OAAO,0YAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QACP,uBAAuB;QACvB;QACA,gCAAgC;QAChC;QACA;QACA,yBAAyB;QACzB;KACD;AACH"}}]
}