module.exports=[123269,e=>{"use strict";var t=e.i(553573),r=e.i(163459),n=e.i(342845),a=e.i(904973),i=e.i(818385),o=e.i(588303),s=e.i(583020),l=e.i(304941),u=e.i(370312),d=e.i(40504),c=e.i(802579),p=e.i(225915),g=e.i(150373),m=e.i(804342),S=e.i(259207),h=e.i(348684),v=e.i(193695);e.i(650048);var f=e.i(219407),R=e.i(982099),w=e.i(336801),b=e.i(220578);e.i(180256);var C=e.i(565431),E=e.i(23250),y=e.i(80643),x=e.i(842576),_=e.i(187070),A=e.i(961691);e.i(791146);var N=e.i(832821),U=e.i(875559),P=e.i(452130);let{secretKey:T}=(0,N.getStripeSecrets)(),I=new w.default(T,{apiVersion:"2023-10-16"});async function O(e){try{let t=await e.json();console.log("[Signup] Form data:",t);let r=await C.userService.getUserByPhone(t.phoneNumber);if(r){let e=new A.SubscriptionRepository;if(await e.hasActiveSubscription(r.id))return console.log(`[Signup] Existing subscribed user: ${r.id}`),await $(r,t);return console.log(`[Signup] Existing unsubscribed user: ${r.id}`),await H(r,t)}return console.log("[Signup] Creating new user"),await k(t)}catch(e){return console.error("[Signup] Error in signup API:",e),R.NextResponse.json({success:!1,message:e instanceof Error?e.message:"Internal server error"},{status:500})}}async function k(e){console.log("[Signup] Creating user with basic info");let t=await C.userService.createUser({name:e.name,phoneNumber:e.phoneNumber,age:e.age?parseInt(e.age,10):void 0,gender:e.gender,timezone:e.timezone,preferredSendHour:e.preferredSendHour});console.log(`[Signup] User created: ${t.id}`),console.log("[Signup] Creating Stripe customer");let r=await I.customers.create({name:t.name,phone:t.phoneNumber,metadata:{userId:t.id}});return await C.userService.updateUser(t.id,{stripeCustomerId:r.id}),console.log(`[Signup] Stripe customer created: ${r.id}`),await D(t.id,r.id,e,!1)}async function H(e,t){console.log("[Signup] Updating existing user info"),await C.userService.updateUser(e.id,{name:t.name,age:t.age?parseInt(t.age,10):void 0,gender:t.gender,timezone:t.timezone,preferredSendHour:t.preferredSendHour});let r=e.stripeCustomerId;return r?console.log(`[Signup] Reusing existing Stripe customer: ${r}`):(console.log("[Signup] Creating Stripe customer for existing user"),r=(await I.customers.create({name:t.name,phone:e.phoneNumber,metadata:{userId:e.id}})).id,await C.userService.updateUser(e.id,{stripeCustomerId:r}),console.log(`[Signup] Stripe customer created: ${r}`)),await D(e.id,r,t,!1)}async function $(e,t){console.log("[Signup] Updating subscribed user info"),await C.userService.updateUser(e.id,{name:t.name,age:t.age?parseInt(t.age,10):void 0,gender:t.gender,timezone:t.timezone,preferredSendHour:t.preferredSendHour}),console.log("[Signup] Resetting onboarding record");try{await E.onboardingDataService.delete(e.id)}catch{}await E.onboardingDataService.createOnboardingRecord(e.id,q(t)),console.log("[Signup] Triggering re-onboarding job with forceCreate"),await _.inngest.send({name:"user/onboarding.requested",data:{userId:e.id,forceCreate:!0}});let r=b.userAuthService.createSessionToken(e.id),n=R.NextResponse.json({success:!0,redirectUrl:"/me"});return n.cookies.set("gt_user_session",r,{httpOnly:!0,secure:(0,P.isProductionEnvironment)(),sameSite:"lax",maxAge:2592e3,path:"/"}),console.log("[Signup] Subscribed user re-onboarding started, redirecting to /me"),n}async function D(e,t,r,n){let a,i;console.log("[Signup] Creating onboarding record");try{await E.onboardingDataService.delete(e)}catch{}await E.onboardingDataService.createOnboardingRecord(e,q(r)),console.log("[Signup] Sending welcome SMS");let o=await C.userService.getUser(e);o&&await y.messageService.sendWelcomeMessage(o),console.log("[Signup] Triggering async onboarding job"),await _.inngest.send({name:"user/onboarding.requested",data:{userId:e,forceCreate:n}}),console.log("[Signup] Creating Stripe checkout session");let{publicBaseUrl:s,baseUrl:l}=(0,U.getUrlsConfig)(),u=s||l,{priceId:d}=(0,U.getStripeConfig)(),c=r.referralCode;if(c){console.log(`[Signup] Validating referral code: ${c}`);let t=await C.userService.getUser(e),r=await x.referralService.validateReferralCode(c,t?.phoneNumber);r.valid?(a=c.toUpperCase(),i=await x.referralService.getRefereeCouponId(),console.log(`[Signup] Referral code valid, applying coupon: ${i}`),await x.referralService.completeReferral(a,e)):console.log(`[Signup] Referral code invalid: ${r.error}`)}let p={customer:t,mode:"subscription",payment_method_types:["card"],line_items:[{price:d,quantity:1}],success_url:`${u}/api/checkout/session?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${u}?canceled=true`,metadata:{userId:e,referralCode:a||""},client_reference_id:e};i?p.discounts=[{coupon:i}]:p.allow_promotion_codes=!0;let g=await I.checkout.sessions.create(p);console.log(`[Signup] Checkout session created: ${g.id}`);let m=b.userAuthService.createSessionToken(e),S=R.NextResponse.json({success:!0,checkoutUrl:g.url});return S.cookies.set("gt_user_session",m,{httpOnly:!0,secure:(0,P.isProductionEnvironment)(),sameSite:"lax",maxAge:2592e3,path:"/"}),S}function q(e){return{primaryGoals:e.primaryGoals,goalsElaboration:e.goalsElaboration,experienceLevel:e.experienceLevel,desiredDaysPerWeek:e.desiredDaysPerWeek,availabilityElaboration:e.availabilityElaboration,trainingLocation:e.trainingLocation,equipment:e.equipment,injuries:e.injuries,acceptedRisks:e.acceptedRisks}}e.s(["POST",()=>O],428337);var M=e.i(428337);let j=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/users/signup/route",pathname:"/api/users/signup",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/users/signup/route.ts",nextConfigOutput:"",userland:M}),{workAsyncStorage:F,workUnitAsyncStorage:K,serverHooks:L}=j;function z(){return(0,n.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:K})}async function B(e,t,n){j.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/users/signup/route";R=R.replace(/\/index$/,"")||"/";let w=await j.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:b,params:C,nextConfig:E,parsedUrl:y,isDraftMode:x,prerenderManifest:_,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:U,resolvedPathname:P,clientReferenceManifest:T,serverActionsManifest:I}=w,O=(0,l.normalizeAppPath)(R),k=!!(_.dynamicRoutes[O]||_.routes[P]),H=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,y,!1):t.end("This page could not be found"),null);if(k&&!x){let e=!!_.routes[P],t=_.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await H();throw new v.NoFallbackError}}let $=null;!k||j.isDev||x||($="/index"===($=P)?"/":$);let D=!0===j.isDev||!k,q=k&&!D;I&&T&&(0,o.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:T,serverActionsManifest:I,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:I})});let M=e.method||"GET",F=(0,i.getTracer)(),K=F.getActiveScopeSpan(),L={params:C,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>j.onRequestError(e,t,n,A)},sharedContext:{buildId:b}},z=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(z,(0,d.signalFromNodeResponse)(t));try{let o=async e=>j.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${M} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${R}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&N&&U&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=L.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(z,B,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})},A),t}},d=await j.handleResponse({req:e,nextConfig:E,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:U,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!k)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&k||c.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,S.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(z,B,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};K?await l(K):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${M} ${R}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})}),k)throw t;return await (0,g.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>B,"patchFetch",()=>z,"routeModule",()=>j,"serverHooks",()=>L,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>K],123269)}];

//# sourceMappingURL=708d8_next_dist_esm_build_templates_app-route_0574815c.js.map