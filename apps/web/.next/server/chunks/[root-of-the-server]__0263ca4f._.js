module.exports=[918622,(e,t,s)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},224361,(e,t,s)=>{t.exports=e.x("util",()=>require("util"))},814747,(e,t,s)=>{t.exports=e.x("path",()=>require("path"))},193695,(e,t,s)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},875559,452130,e=>{"use strict";e.i(454188);var t=e.i(331612);let s=t.z.object({messageHistoryLimit:t.z.number().int().positive().default(5),includeSystemMessages:t.z.boolean().default(!0),maxContextTokens:t.z.number().int().positive().default(1e3),reserveTokensForResponse:t.z.number().int().positive().default(1500),conversationGapMinutes:t.z.number().int().positive().default(30),enableCaching:t.z.boolean().default(!0),cacheTTLSeconds:t.z.number().int().nonnegative().default(600)}),r=t.z.object({smsMaxLength:t.z.number().int().positive().default(1600),contextMinutes:t.z.number().int().positive().default(10)}),n=t.z.enum(["twilio","local"]),a=t.z.object({provider:n.default("twilio")}),i=t.z.object({agentLogging:t.z.boolean().default(!1),enableConversationStorage:t.z.boolean().default(!0)}),o=t.z.object({timeoutMinutes:t.z.number().int().positive().default(30),maxLength:t.z.number().int().positive().default(100),inactiveThresholdDays:t.z.number().int().positive().default(7)}),l=t.z.object({defaultExpiryDays:t.z.number().int().positive().default(7),domain:t.z.string().optional()}),u=t.z.object({priceId:t.z.string().min(1)}),d=t.z.object({phoneNumbers:t.z.array(t.z.string()).default([]),maxRequestsPerWindow:t.z.number().int().positive().default(3),rateLimitWindowMinutes:t.z.number().int().positive().default(15),codeExpiryMinutes:t.z.number().int().positive().default(10),codeLength:t.z.number().int().positive().default(6),devBypassCode:t.z.string().optional()}),c=t.z.object({baseUrl:t.z.string().optional(),publicBaseUrl:t.z.string().optional()}),p=t.z.object({environment:t.z.enum(["development","staging","production"]),context:s,chat:r,messaging:a,features:i,conversation:o,shortLinks:l,stripe:u,admin:d,urls:c});function g(e){if(!e)return;let t=parseInt(e,10);return isNaN(t)?void 0:t}function m(e){if(void 0!==e)return"true"===e}let h=null;function v(){return h||(h=function(){var e;let t="staging"===process.env.APP_ENV?"staging":"production",s={environment:t,context:{messageHistoryLimit:g(process.env.CONTEXT_MESSAGE_HISTORY_LIMIT),includeSystemMessages:m(process.env.CONTEXT_INCLUDE_SYSTEM_MESSAGES),maxContextTokens:g(process.env.CONTEXT_MAX_TOKENS),reserveTokensForResponse:g(process.env.CONTEXT_RESERVE_TOKENS),conversationGapMinutes:g(process.env.CONTEXT_CONVERSATION_GAP_MINUTES),enableCaching:m(process.env.CONTEXT_ENABLE_CACHING),cacheTTLSeconds:g(process.env.CONTEXT_CACHE_TTL)},chat:{smsMaxLength:g(process.env.SMS_MAX_LENGTH),contextMinutes:g(process.env.CHAT_CONTEXT_MINUTES)},messaging:{provider:process.env.MESSAGING_PROVIDER},features:{agentLogging:m(process.env.AGENT_LOGGING),enableConversationStorage:m(process.env.ENABLE_CONVERSATION_STORAGE)},conversation:{timeoutMinutes:g(process.env.CONVERSATION_TIMEOUT_MINUTES),maxLength:g(process.env.MAX_CONVERSATION_LENGTH),inactiveThresholdDays:g(process.env.INACTIVE_THRESHOLD_DAYS)},shortLinks:{defaultExpiryDays:g(process.env.SHORT_LINK_DEFAULT_EXPIRY_DAYS),domain:process.env.SHORT_LINK_DOMAIN},stripe:{priceId:process.env.STRIPE_PRICE_ID},admin:{phoneNumbers:process.env.ADMIN_PHONE_NUMBERS?(e=process.env.ADMIN_PHONE_NUMBERS)?e.split(",").map(e=>e.trim()).filter(e=>e.length>0):[]:void 0,devBypassCode:process.env.DEV_BYPASS_CODE},urls:{baseUrl:process.env.BASE_URL,publicBaseUrl:"http://localhost:3000"}},r=p.safeParse(s);if(!r.success){let e=r.error.errors.map(e=>`  - ${e.path.join(".")}: ${e.message}`).join("\n");throw Error(`Configuration validation failed:
${e}

Environment: ${t}
Check your environment variables.`)}return r.data}()),h}function f(){return!0}t.z.object({NEXT_PUBLIC_BASE_URL:t.z.string().optional(),NEXT_PUBLIC_ANALYTICS_WRITE_KEY:t.z.string().optional(),NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:t.z.string().optional()}),e.s(["isProductionEnvironment",()=>f],452130);let E=null;function T(){return v().chat}function w(){return v().messaging}function b(){return v().features}function x(){return v().shortLinks}function y(){return v().stripe}function R(){return v().admin}function C(){return v().urls}new Proxy({},{get:(e,t)=>(!E&&(E=v()),E)[t]}),e.s(["getAdminConfig",()=>R,"getChatConfig",()=>T,"getFeatureFlags",()=>b,"getMessagingConfig",()=>w,"getShortLinksConfig",()=>x,"getStripeConfig",()=>y,"getUrlsConfig",()=>C],875559)},501261,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,t=50,s=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).offset(s).execute()}async findRecentByClientId(e,t=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).reverse()}async countByClientId(e){let t=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(t?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,t,s){return await this.db.updateTable("messages").set({deliveryStatus:t,deliveryError:s||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let t=await this.findById(e);if(!t)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(t.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,t){return await this.db.updateTable("messages").set({providerMessageId:t}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await s.executeTakeFirst(),n=Number(r?.count??0);return{messages:await t.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:n}}async getStats(e){let t=this.db.selectFrom("messages");e&&(t=t.where("clientId","=",e));let[s,r,n,a,i]=await Promise.all([t.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(s?.count??0),inbound:Number(r?.count??0),outbound:Number(n?.count??0),pending:Number(a?.count??0),failed:Number(i?.count??0)}}}e.s(["MessageRepository",()=>s])},489731,e=>{"use strict";var t=e.i(553573),s=e.i(163459),r=e.i(342845),n=e.i(904973),a=e.i(818385),i=e.i(588303),o=e.i(583020),l=e.i(304941),u=e.i(370312),d=e.i(40504),c=e.i(802579),p=e.i(225915),g=e.i(150373),m=e.i(804342),h=e.i(259207),v=e.i(348684),f=e.i(193695);e.i(650048);var E=e.i(219407),T=e.i(501261),w=e.i(187070),b=e.i(982099),x=e.i(66637),y=e.i(36480);e.i(791146);var R=e.i(832821),C=e.i(875559);async function N(t){try{let s=await t.formData(),r=Object.fromEntries(s),n=r.MessageSid,a=r.MessageStatus,i=r.ErrorCode,o=r.ErrorMessage;if(console.log("[Twilio Status Callback]",{messageSid:n,messageStatus:a,errorCode:i,errorMessage:o}),!n||!a)return b.NextResponse.json({error:"Missing required fields"},{status:400});let{authToken:l}=(0,R.getTwilioSecrets)(),{baseUrl:u}=(0,C.getUrlsConfig)();if(l&&u){let e=t.headers.get("x-twilio-signature"),r=`${u}/api/twilio/status`;if(e&&r){let t={};if(s.forEach((e,s)=>{t[s]=e.toString()}),!x.default.validateRequest(l,e,r,t))return console.error("[Twilio Status Callback] Invalid signature"),b.NextResponse.json({error:"Invalid signature"},{status:403})}}let d=new T.MessageRepository(y.postgresDb),c=await d.findByProviderMessageId(n);if(!c)return console.warn("[Twilio Status Callback] Message not found:",n),b.NextResponse.json({error:"Message not found"},{status:404});let p=i?`${i}${o?`: ${o}`:""}`:void 0;await d.updateDeliveryStatus(c.id,a,p),console.log("[Twilio Status Callback] Updated message:",{messageId:c.id,status:a});let{messageQueueService:g}=await e.A(279524);return"delivered"===a?(console.log("[Twilio Status Callback] Message delivered, processing queue"),await g.markMessageDelivered(c.id)):("failed"===a||"undelivered"===a)&&(console.log("[Twilio Status Callback] Message failed, handling in queue"),await g.markMessageFailed(c.id,p),await w.inngest.send({name:"message/delivery-failed",data:{messageId:c.id,clientId:c.clientId,providerMessageId:n,error:p||"Unknown error"}})),b.NextResponse.json({success:!0},{status:200})}catch(e){return console.error("[Twilio Status Callback] Error processing status:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>N],317478);var S=e.i(317478);let _=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/twilio/status/route",pathname:"/api/twilio/status",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/twilio/status/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:A,workUnitAsyncStorage:I,serverHooks:M}=_;function k(){return(0,r.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:I})}async function O(e,t,r){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let T="/api/twilio/status/route";T=T.replace(/\/index$/,"")||"/";let w=await _.prepare(e,t,{srcPage:T,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:x,nextConfig:y,parsedUrl:R,isDraftMode:C,prerenderManifest:N,routerServerContext:S,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,resolvedPathname:M,clientReferenceManifest:k,serverActionsManifest:O}=w,P=(0,l.normalizeAppPath)(T),z=!!(N.dynamicRoutes[P]||N.routes[M]),L=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,R,!1):t.end("This page could not be found"),null);if(z&&!C){let e=!!N.routes[M],t=N.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await L();throw new f.NoFallbackError}}let D=null;!z||_.isDev||C||(D="/index"===(D=M)?"/":D);let U=!0===_.isDev||!z,j=z&&!U;O&&k&&(0,i.setReferenceManifestsSingleton)({page:T,clientReferenceManifest:k,serverActionsManifest:O,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:O})});let F=e.method||"GET",B=(0,a.getTracer)(),H=B.getActiveScopeSpan(),q={params:x,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,r)=>_.onRequestError(e,t,r,S)},sharedContext:{buildId:b}},$=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),X=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let i=async e=>_.handle(X,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=B.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=s.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${T}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let u=async({previousCacheEntry:s})=>{try{if(!o&&A&&I&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=q.renderOpts.collectedTags;if(!z)return await (0,g.sendResponse)($,G,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[v.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,r=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:r}}}}catch(t){throw(null==s?void 0:s.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})},S),t}},d=await _.handleResponse({req:e,nextConfig:y,cacheKey:D,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:o});if(!z)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&z||c.delete(v.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)($,G,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};H?await l(H):await B.withPropagatedContext(e.headers,()=>B.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${T}`,kind:a.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:A})}),z)throw t;return await (0,g.sendResponse)($,G,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>k,"routeModule",()=>_,"serverHooks",()=>M,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>I],489731)},5389,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(t=>e.l(t))).then(()=>t(478500)))},279524,e=>{e.v(t=>Promise.all(["server/chunks/packages_shared_src_server_c900dae6._.js"].map(t=>e.l(t))).then(()=>t(38330)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0263ca4f._.js.map