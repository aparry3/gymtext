module.exports=[777492,e=>{"use strict";var r=e.i(254799);e.i(791146);var t=e.i(832821);let s="aes-256-gcm";function o(){let{sessionEncryptionKey:e}=(0,t.getDatabaseSecrets)();return e?64===e.length?Buffer.from(e,"hex"):r.default.scryptSync(e,"salt",32):(console.warn("SESSION_ENCRYPTION_KEY not set, using development key"),r.default.scryptSync("gymtext-dev-key","salt",32))}function i(e){try{let t=o(),i=r.default.randomBytes(16),n=r.default.createCipheriv(s,t,i),a=n.update(e,"utf8","hex");a+=n.final("hex");let c=n.getAuthTag();return Buffer.concat([i,c,Buffer.from(a,"hex")]).toString("base64")}catch(e){throw console.error("Error encrypting user ID:",e),Error("Failed to encrypt session")}}function n(e){try{let t=o(),i=Buffer.from(e,"base64"),n=i.subarray(0,16),a=i.subarray(16,32),c=i.subarray(32),u=r.default.createDecipheriv(s,t,n);u.setAuthTag(a);let d=u.update(c.toString("hex"),"hex","utf8");return d+=u.final("utf8")}catch(e){return console.error("Error decrypting user ID:",e),null}}e.s(["decryptUserId",()=>n,"encryptUserId",()=>i])},733897,e=>{"use strict";var r=e.i(46308);class t extends r.BaseRepository{async createAuthCode(e,r,t){await this.db.insertInto("userAuthCodes").values({phoneNumber:e,code:r,expiresAt:t,createdAt:new Date}).execute()}async findValidCode(e,r){return await this.db.selectFrom("userAuthCodes").select(["id","phoneNumber"]).where("phoneNumber","=",e).where("code","=",r).where("expiresAt",">",new Date).executeTakeFirst()||null}async deleteCodesForPhone(e){await this.db.deleteFrom("userAuthCodes").where("phoneNumber","=",e).execute()}async deleteExpiredCodes(){return Number((await this.db.deleteFrom("userAuthCodes").where("expiresAt","<",new Date).executeTakeFirst()).numDeletedRows||0)}async countRecentRequests(e,r){let t=await this.db.selectFrom("userAuthCodes").select(e=>e.fn.countAll().as("count")).where("phoneNumber","=",e).where("createdAt",">=",r).executeTakeFirst();return Number(t?.count||0)}}e.s(["UserAuthRepository",()=>t])},166194,e=>{"use strict";var r=e.i(46308),t=e.i(705590);class s extends r.BaseRepository{async create(e,r){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:r,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,r){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:r,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let r=await this.db.selectFrom("referrals").select(t.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(r?.count||0)}async countByReferrer(e){let r=await this.db.selectFrom("referrals").select(t.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(r?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>s])},139765,e=>{"use strict";var r=e.i(46308);class t extends r.BaseRepository{async record(e){return await this.db.insertInto("pageVisits").values(e).returningAll().executeTakeFirstOrThrow()}async getVisitsByDateRange(e,r,t){let s=this.db.selectFrom("pageVisits").selectAll().where("createdAt",">=",e).where("createdAt","<=",r).orderBy("createdAt","desc");return t?.source&&(s=s.where("source","=",t.source)),t?.limit&&(s=s.limit(t.limit)),s.execute()}async getVisitCountsBySource(e,r){return(await this.db.selectFrom("pageVisits").select(["source"]).select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",r).groupBy("source").orderBy("count","desc").execute()).map(e=>({source:e.source,count:Number(e.count)}))}async getTotalVisits(e,r){let t=await this.db.selectFrom("pageVisits").select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",r).executeTakeFirst();return Number(t?.count??0)}}e.s(["PageVisitRepository",()=>t])},534821,e=>{"use strict";var r=e.i(80643),t=e.i(565431),s=e.i(201236),o=e.i(108436),i=e.i(763800),n=e.i(187070);e.i(249805);var a=e.i(884031),c=e.i(823525);class u{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=t.UserService.getInstance(),this.messageService=r.MessageService.getInstance(),this.progressService=o.ProgressService.getInstance(),this.microcycleService=i.MicrocycleService.getInstance(),this.fitnessPlanService=s.FitnessPlanService.getInstance()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async scheduleMessagesForHour(e){let r=Date.now(),t=[],s=0,o=0;try{let i=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${i.length} users to schedule for hour ${e} on Sunday`),0===i.length)return{scheduled:0,failed:0,duration:Date.now()-r,errors:[]};let a=i.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await n.inngest.send(a);s=e.length,console.log(`[WeeklyMessageService] Scheduled ${s} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),o=a.length,t.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:s,failed:o,duration:Date.now()-r,errors:t}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let r=await this.fitnessPlanService.getCurrentPlan(e.id);if(!r)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let t=(0,c.now)(e.timezone).toJSDate(),s=(0,c.getNextWeekStart)(t,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${s.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(r,s,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:o}=await this.progressService.getOrCreateMicrocycleForDate(e.id,r,s,e.timezone);if(!o)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let i=o.isDeload;i&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${o.absoluteWeek})`);let n=await a.messagingAgentService.generateWeeklyMessage(e,i,o.absoluteWeek),u=o.message;if(!u)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${o.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let d=[],l=await this.messageService.sendMessage(e,n);d.push(l.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let h=await this.messageService.sendMessage(e,u);return d.push(h.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:d}}catch(r){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,r),{success:!1,userId:e.id,error:r instanceof Error?r.message:"Unknown error"}}}}let d=u.getInstance();e.s(["WeeklyMessageService",()=>u,"weeklyMessageService",0,d])},842576,e=>{"use strict";var r=e.i(336801),t=e.i(166194),s=e.i(297934);e.i(791146);var o=e.i(832821),i=e.i(875559);let{secretKey:n}=(0,o.getStripeSecrets)(),a=new r.default(n,{apiVersion:"2023-10-16"}),c="REFERRAL_FREE_MONTH";class u{static instance;referralRepo;userRepo;constructor(){this.referralRepo=new t.ReferralRepository,this.userRepo=new s.UserRepository}static getInstance(){return u.instance||(u.instance=new u),u.instance}async getOrCreateReferralCode(e){return this.userRepo.getOrCreateReferralCode(e)}async getReferralStats(e){let r=await this.userRepo.getOrCreateReferralCode(e);if(!r)return null;let{publicBaseUrl:t,baseUrl:s}=(0,i.getUrlsConfig)(),o=`${t||s}/r/${r}`,n=await this.referralRepo.countByReferrer(e),a=await this.referralRepo.countCreditsEarned(e),c=Math.max(0,12-a);return{referralCode:r,referralLink:o,completedReferrals:n,creditsEarned:a,creditsRemaining:c}}async validateReferralCode(e,r){if(!e||6!==e.length)return{valid:!1,error:"Invalid referral code format"};let t=await this.userRepo.findByReferralCode(e.toUpperCase());return t?r&&t.phoneNumber===r?{valid:!1,error:"Cannot use your own referral code"}:{valid:!0,referrerId:t.id,referrerName:t.name}:{valid:!1,error:"Referral code not found"}}async completeReferral(e,r){let t=await this.userRepo.findByReferralCode(e.toUpperCase());t?await this.referralRepo.hasBeenReferred(r)?console.log(`[ReferralService] User ${r} has already been referred, skipping`):(await this.referralRepo.create(t.id,r),console.log(`[ReferralService] Referral completed: ${t.id} -> ${r}`)):console.error(`[ReferralService] Cannot complete referral: code ${e} not found`)}async creditReferrer(e){let r=await this.referralRepo.findByRefereeId(e);if(!r)return console.log(`[ReferralService] No referral found for referee ${e}`),{success:!0};if(r.creditApplied)return console.log(`[ReferralService] Credit already applied for referral ${r.id}`),{success:!0};if(await this.referralRepo.countCreditsEarned(r.referrerId)>=12)return console.log(`[ReferralService] Referrer ${r.referrerId} has reached max credits (12)`),{success:!0};let t=await this.userRepo.findById(r.referrerId);if(!t?.stripeCustomerId)return console.error(`[ReferralService] Referrer ${r.referrerId} has no Stripe customer ID`),{success:!1,error:"Referrer has no Stripe customer"};try{let e=await a.customers.createBalanceTransaction(t.stripeCustomerId,{amount:-1999,currency:"usd",description:"Referral credit - 1 free month"});return await this.referralRepo.markCreditApplied(r.id,1999),console.log(`[ReferralService] Applied $19.99 credit to referrer ${t.id}`),{success:!0,creditId:e.id}}catch(e){return console.error("[ReferralService] Failed to apply credit:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getRefereeCouponId(){try{return await a.coupons.retrieve(c),c}catch{return await a.coupons.create({id:c,amount_off:1999,currency:"usd",duration:"once",name:"Referral - First Month Free"}),console.log("[ReferralService] Created referral coupon in Stripe"),c}}async canEarnCredits(e){return await this.referralRepo.countCreditsEarned(e)<12}}let d=u.getInstance();e.s(["referralService",0,d],842576)},220578,e=>{"use strict";var r=e.i(733897),t=e.i(297934),s=e.i(681247),o=e.i(777492);e.i(791146);var i=e.i(437234),n=e.i(875559);class a{authRepository;MAX_REQUESTS_PER_WINDOW=3;RATE_LIMIT_WINDOW_MINUTES=15;CODE_EXPIRY_MINUTES=10;CODE_LENGTH=6;isDev=!(0,i.getEnvironmentSettings)().isProduction;devBypassCode=(0,n.getAdminConfig)().devBypassCode||"000000";constructor(){this.authRepository=new r.UserAuthRepository}isPhoneWhitelisted(e){let{phoneNumbers:r}=(0,n.getAdminConfig)();return 0===r.length?(console.warn("[AdminAuth] ADMIN_PHONE_NUMBERS not configured"),!1):r.includes(e)}generateCode(){return Math.floor(9e5*Math.random()+1e5).toString()}async requestCode(e){try{if(!e.startsWith("+1"))return console.error("[AdminAuth] Phone number not properly normalized:",e),{success:!1,message:"Internal error: phone number format invalid"};if(!this.isPhoneWhitelisted(e))return console.warn(`[AdminAuth] Unauthorized admin login attempt: ${e}`),{success:!1,message:"Phone number not authorized for admin access."};let r=new Date(Date.now()-60*this.RATE_LIMIT_WINDOW_MINUTES*1e3);if(await this.authRepository.countRecentRequests(e,r)>=this.MAX_REQUESTS_PER_WINDOW)return{success:!1,message:`Too many requests. Please try again in ${this.RATE_LIMIT_WINDOW_MINUTES} minutes.`};let t=this.generateCode(),o=new Date(Date.now()+60*this.CODE_EXPIRY_MINUTES*1e3);await this.authRepository.createAuthCode(e,t,o);let i=`Your GymText admin verification code is: ${t}

This code expires in ${this.CODE_EXPIRY_MINUTES} minutes.`;return await s.twilioClient.sendSMS(e,i),console.log(`[AdminAuth] Verification code sent to ${e}`),this.isDev&&(console.log(`[AdminAuth:Dev] ðŸ”‘ Verification code for ${e}: ${t}`),console.log(`[AdminAuth:Dev] ðŸ’¡ Tip: You can also use magic code "${this.devBypassCode}" in dev mode`)),{success:!0}}catch(e){return console.error("[AdminAuth] Error requesting verification code:",e),{success:!1,message:"Failed to send verification code. Please try again."}}}async verifyCode(e,r){try{if(!e.startsWith("+1"))return console.error("[AdminAuth] Phone number not properly normalized:",e),{success:!1,message:"Internal error: phone number format invalid"};if(!this.isPhoneWhitelisted(e))return console.warn(`[AdminAuth] Unauthorized verification attempt: ${e}`),{success:!1,message:"Phone number not authorized for admin access."};if(r.length!==this.CODE_LENGTH||!/^\d+$/.test(r))return{success:!1,message:"Invalid code format. Code must be 6 digits."};if(this.isDev&&r===this.devBypassCode)return console.log(`[AdminAuth:Dev] âœ… Magic bypass code accepted for ${e}`),await this.authRepository.deleteCodesForPhone(e),{success:!0};if(!await this.authRepository.findValidCode(e,r))return{success:!1,message:"Invalid or expired verification code."};return await this.authRepository.deleteCodesForPhone(e),console.log(`[AdminAuth] Admin verified: ${e}`),{success:!0}}catch(e){return console.error("[AdminAuth] Error verifying code:",e),{success:!1,message:"Failed to verify code. Please try again."}}}async cleanupExpiredCodes(){try{let e=await this.authRepository.deleteExpiredCodes();return console.log(`[AdminAuth] Cleaned up ${e} expired auth codes`),e}catch(e){return console.error("[AdminAuth] Error cleaning up expired codes:",e),0}}}let c=new a;class u{authRepository;userRepository;MAX_REQUESTS_PER_WINDOW=3;RATE_LIMIT_WINDOW_MINUTES=15;CODE_EXPIRY_MINUTES=10;CODE_LENGTH=6;isDev=!(0,i.getEnvironmentSettings)().isProduction;devBypassCode=(0,n.getAdminConfig)().devBypassCode||"000000";constructor(){this.authRepository=new r.UserAuthRepository,this.userRepository=new t.UserRepository}generateCode(){return Math.floor(9e5*Math.random()+1e5).toString()}async requestVerificationCode(e){try{if(!e.startsWith("+1"))return console.error("[UserAuth] Phone number not properly normalized:",e),{success:!1,message:"Internal error: phone number format invalid"};let r=await this.userRepository.findByPhoneNumber(e),t=c.isPhoneWhitelisted(e);if(!r&&!t)return{success:!1,message:"Phone number not registered. Please sign up first."};let o=new Date(Date.now()-60*this.RATE_LIMIT_WINDOW_MINUTES*1e3);if(await this.authRepository.countRecentRequests(e,o)>=this.MAX_REQUESTS_PER_WINDOW)return{success:!1,message:`Too many requests. Please try again in ${this.RATE_LIMIT_WINDOW_MINUTES} minutes.`};let i=this.generateCode(),n=new Date(Date.now()+60*this.CODE_EXPIRY_MINUTES*1e3);await this.authRepository.createAuthCode(e,i,n);let a=`Your GymText verification code is: ${i}

This code expires in ${this.CODE_EXPIRY_MINUTES} minutes.`;return await s.twilioClient.sendSMS(e,a),this.isDev&&(console.log(`[UserAuth:Dev] ðŸ”‘ Verification code for ${e}: ${i}`),console.log(`[UserAuth:Dev] ðŸ’¡ Tip: You can also use magic code "${this.devBypassCode}" in dev mode`)),{success:!0,userId:r?.id}}catch(e){return console.error("Error requesting verification code:",e),{success:!1,message:"Failed to send verification code. Please try again."}}}async verifyCode(e,r){try{if(!e.startsWith("+1"))return console.error("[UserAuth] Phone number not properly normalized:",e),{success:!1,message:"Internal error: phone number format invalid"};if(r.length!==this.CODE_LENGTH||!/^\d+$/.test(r))return{success:!1,message:"Invalid code format. Code must be 6 digits."};if(this.isDev&&r===this.devBypassCode){console.log(`[UserAuth:Dev] âœ… Magic bypass code accepted for ${e}`);let r=await this.userRepository.findByPhoneNumber(e);return await this.authRepository.deleteCodesForPhone(e),{success:!0,userId:r?.id}}if(!await this.authRepository.findValidCode(e,r))return{success:!1,message:"Invalid or expired verification code."};let t=await this.userRepository.findByPhoneNumber(e);if(!t)return{success:!1,message:"User not found."};return await this.authRepository.deleteCodesForPhone(e),{success:!0,userId:t.id}}catch(e){return console.error("Error verifying code:",e),{success:!1,message:"Failed to verify code. Please try again."}}}createSessionToken(e){return(0,o.encryptUserId)(e)}async cleanupExpiredCodes(){try{let e=await this.authRepository.deleteExpiredCodes();return console.log(`Cleaned up ${e} expired auth codes`),e}catch(e){return console.error("Error cleaning up expired codes:",e),0}}}let d=new u;e.s(["userAuthService",0,d],220578)},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(r=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(r=>e.l(r))).then(()=>r(706674)))},399164,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(r=>e.l(r))).then(()=>r(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},5389,e=>{e.v(r=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(r=>e.l(r))).then(()=>r(478500)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(r=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(r=>e.l(r))).then(()=>r(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2a4df061._.js.map