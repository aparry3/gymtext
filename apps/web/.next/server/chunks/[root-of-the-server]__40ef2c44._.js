module.exports=[968387,32721,363690,e=>{"use strict";var s=e.i(681247);let t=new class{provider="twilio";async sendMessage(e,t,r){try{let i=await s.twilioClient.sendSMS(e.phoneNumber,t,r);return{messageId:i.sid,status:this.mapTwilioStatus(i.status),provider:this.provider,to:i.to,from:i.from,timestamp:i.dateCreated,metadata:{twilioSid:i.sid,twilioStatus:i.status,errorCode:i.errorCode,errorMessage:i.errorMessage,mediaUrls:r}}}catch(e){throw console.error("TwilioMessagingClient: Failed to send message",e),e}}mapTwilioStatus(e){switch(e){case"sent":case"delivered":return"delivered";case"queued":case"accepted":case"sending":return"queued";case"failed":case"undelivered":return"failed";default:return"sent"}}};var r=e.i(427699);let i=new class{provider="local";eventEmitter;messageCounter=0;constructor(){this.eventEmitter=new r.EventEmitter,this.eventEmitter.setMaxListeners(100)}async sendMessage(e,s,t){let r=`local-${Date.now()}-${++this.messageCounter}`,i=new Date,a=e.phoneNumber;return this.eventEmitter.emit("message",{messageId:r,to:a,from:"local-system",content:s||"[MMS only - no text]",timestamp:i}),console.log("[LocalMessagingClient] Message sent (not actual SMS):",{messageId:r,to:a,userId:e.id,preview:s?s.substring(0,50):"[MMS only]",mediaUrls:t}),{messageId:r,status:"sent",provider:this.provider,to:a,from:"local-system",timestamp:i,metadata:{userId:e.id,phoneNumber:a,contentLength:s?.length||0,mediaUrls:t}}}onMessage(e){this.eventEmitter.on("message",e)}offMessage(e){this.eventEmitter.off("message",e)}getListenerCount(){return this.eventEmitter.listenerCount("message")}};e.s(["localMessagingClient",0,i],32721);var a=e.i(875559);let n=function(){let{provider:e}=(0,a.getMessagingConfig)();return"local"===e?(console.log("[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)"),i):t}();e.s(["messagingClient",0,n],363690),e.s([],968387)},501261,e=>{"use strict";var s=e.i(46308);class t extends s.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,s=50,t=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(s).offset(t).execute()}async findRecentByClientId(e,s=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(s).execute()).reverse()}async countByClientId(e){let s=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(s?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,s,t){return await this.db.updateTable("messages").set({deliveryStatus:s,deliveryError:t||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let s=await this.findById(e);if(!s)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(s.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,s){return await this.db.updateTable("messages").set({providerMessageId:s}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(s=>s.or([s("messages.phoneFrom","ilike",`%${e.search}%`),s("messages.phoneTo","ilike",`%${e.search}%`),s("users.name","ilike",`%${e.search}%`),s("users.phoneNumber","ilike",`%${e.search}%`)])));let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(s=>s.or([s("messages.phoneFrom","ilike",`%${e.search}%`),s("messages.phoneTo","ilike",`%${e.search}%`),s("users.name","ilike",`%${e.search}%`),s("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await t.executeTakeFirst(),i=Number(r?.count??0);return{messages:await s.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:i}}async getStats(e){let s=this.db.selectFrom("messages");e&&(s=s.where("clientId","=",e));let[t,r,i,a,n]=await Promise.all([s.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(t?.count??0),inbound:Number(r?.count??0),outbound:Number(i?.count??0),pending:Number(a?.count??0),failed:Number(n?.count??0)}}}e.s(["MessageRepository",()=>t])},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(s=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(s=>e.l(s))).then(()=>s(706674)))},399164,e=>{e.v(s=>Promise.all(["server/chunks/[root-of-the-server]__61a8a079._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(s=>e.l(s))).then(()=>s(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__40ef2c44._.js.map