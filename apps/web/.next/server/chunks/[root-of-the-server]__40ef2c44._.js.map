{"version":3,"sources":["../../../../../packages/shared/src/server/connections/messaging/twilioClient.ts","../../../../../packages/shared/src/server/connections/messaging/localClient.ts","../../../../../packages/shared/src/server/connections/messaging/factory.ts","../../../../../packages/shared/src/server/repositories/messageRepository.ts"],"sourcesContent":["/**\n * Twilio Messaging Client\n *\n * Implements IMessagingClient for Twilio SMS delivery.\n * Wraps the Twilio API and provides a standardized messaging interface.\n */\n\nimport { twilioClient as twilioSdk } from '../twilio/twilio';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport class TwilioMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'twilio';\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    try {\n      const twilioResponse = await twilioSdk.sendSMS(user.phoneNumber, message, mediaUrls);\n\n      return {\n        messageId: twilioResponse.sid,\n        status: this.mapTwilioStatus(twilioResponse.status),\n        provider: this.provider,\n        to: twilioResponse.to,\n        from: twilioResponse.from,\n        timestamp: twilioResponse.dateCreated,\n        metadata: {\n          twilioSid: twilioResponse.sid,\n          twilioStatus: twilioResponse.status,\n          errorCode: twilioResponse.errorCode,\n          errorMessage: twilioResponse.errorMessage,\n          mediaUrls,\n        },\n      };\n    } catch (error) {\n      console.error('TwilioMessagingClient: Failed to send message', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Maps Twilio status to standardized message status\n   */\n  private mapTwilioStatus(\n    twilioStatus: string\n  ): MessageResult['status'] {\n    switch (twilioStatus) {\n      case 'sent':\n      case 'delivered':\n        return 'delivered';\n      case 'queued':\n      case 'accepted':\n      case 'sending':\n        return 'queued';\n      case 'failed':\n      case 'undelivered':\n        return 'failed';\n      default:\n        return 'sent';\n    }\n  }\n}\n\n// Export singleton instance\nexport const twilioMessagingClient = new TwilioMessagingClient();\n","/**\n * Local Messaging Client\n *\n * Implements IMessagingClient for local development and testing.\n * Uses EventEmitter to broadcast messages to connected SSE clients.\n * Does not actually send SMS - instead emits events for local consumption.\n */\n\nimport { EventEmitter } from 'events';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport interface LocalMessage {\n  messageId: string;\n  to: string;\n  from: string;\n  content: string;\n  timestamp: Date;\n}\n\nexport class LocalMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'local';\n  private eventEmitter: EventEmitter;\n  private messageCounter = 0;\n\n  constructor() {\n    this.eventEmitter = new EventEmitter();\n    // Increase max listeners for SSE connections\n    this.eventEmitter.setMaxListeners(100);\n  }\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    const messageId = `local-${Date.now()}-${++this.messageCounter}`;\n    const timestamp = new Date();\n    const to = user.phoneNumber;\n\n    const localMessage: LocalMessage = {\n      messageId,\n      to,\n      from: 'local-system',\n      content: message || '[MMS only - no text]',\n      timestamp,\n    };\n\n    // Emit the message event for SSE listeners\n    this.eventEmitter.emit('message', localMessage);\n\n    console.log(`[LocalMessagingClient] Message sent (not actual SMS):`, {\n      messageId,\n      to,\n      userId: user.id,\n      preview: message ? message.substring(0, 50) : '[MMS only]',\n      mediaUrls,\n    });\n\n    return {\n      messageId,\n      status: 'sent',\n      provider: this.provider,\n      to,\n      from: 'local-system',\n      timestamp,\n      metadata: {\n        userId: user.id,\n        phoneNumber: to,\n        contentLength: message?.length || 0,\n        mediaUrls,\n      },\n    };\n  }\n\n  /**\n   * Subscribe to message events (for SSE connections)\n   */\n  onMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.on('message', listener);\n  }\n\n  /**\n   * Unsubscribe from message events\n   */\n  offMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.off('message', listener);\n  }\n\n  /**\n   * Get current number of active listeners\n   */\n  getListenerCount(): number {\n    return this.eventEmitter.listenerCount('message');\n  }\n}\n\n// Export singleton instance\nexport const localMessagingClient = new LocalMessagingClient();\n","/**\n * Messaging Client Factory\n *\n * Provides a centralized way to get the appropriate messaging client\n * based on environment configuration.\n */\n\nimport type { IMessagingClient, MessagingProvider } from './types';\nimport { twilioMessagingClient } from './twilioClient';\nimport { localMessagingClient } from './localClient';\nimport { getMessagingConfig } from '@/shared/config';\n\n/**\n * Get the messaging client based on environment configuration\n * Defaults to Twilio in production, can be overridden with MESSAGING_PROVIDER env var\n */\nexport function getMessagingClient(): IMessagingClient {\n  const { provider } = getMessagingConfig();\n\n  switch (provider) {\n    case 'local':\n      console.log('[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)');\n      return localMessagingClient;\n    case 'twilio':\n    default:\n      return twilioMessagingClient;\n  }\n}\n\n/**\n * Get a specific messaging client by provider name\n * Useful for testing or when you need direct access to a specific provider\n */\nexport function getMessagingClientByProvider(provider: MessagingProvider): IMessagingClient {\n  switch (provider) {\n    case 'local':\n      return localMessagingClient;\n    case 'twilio':\n      return twilioMessagingClient;\n    default:\n      throw new Error(`Unknown messaging provider: ${provider}`);\n  }\n}\n\n// Export the default client as a singleton\nexport const messagingClient = getMessagingClient();\n","import { BaseRepository } from '@/server/repositories/baseRepository';\nimport type { \n  Message, \n  NewMessage, \n} from '@/server/models/message';\n\nexport class MessageRepository extends BaseRepository {\n  async create(message: NewMessage): Promise<Message> {\n    return await this.db\n      .insertInto('messages')\n      .values(message)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async findById(id: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n  }\n\n  async findByClientId(clientId: string, limit: number = 50, offset: number = 0): Promise<Message[]> {\n    // Return messages in DESC order (latest first) with pagination support\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .offset(offset)\n      .execute();\n  }\n\n  /**\n   * Find recent messages for a client, ordered oldest to newest\n   * This is the primary method for getting message history\n   */\n  async findRecentByClientId(clientId: string, limit: number = 10): Promise<Message[]> {\n    const messages = await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .execute();\n\n    // Reverse to get oldest-to-newest order (for chat context)\n    return messages.reverse();\n  }\n\n  async countByClientId(clientId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('messages')\n      .select(({ fn }) => fn.count('id').as('count'))\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return Number(result?.count ?? 0);\n  }\n\n  async findByProviderMessageId(providerMessageId: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('providerMessageId', '=', providerMessageId)\n      .executeTakeFirst();\n  }\n\n  async updateDeliveryStatus(\n    messageId: string,\n    status: 'queued' | 'sent' | 'delivered' | 'failed' | 'undelivered',\n    error?: string\n  ): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryStatus: status,\n        deliveryError: error || null,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async incrementDeliveryAttempts(messageId: string): Promise<Message> {\n    const message = await this.findById(messageId);\n    if (!message) {\n      throw new Error(`Message ${messageId} not found`);\n    }\n\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryAttempts: (message.deliveryAttempts || 1) + 1,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async updateProviderMessageId(messageId: string, providerMessageId: string): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({ providerMessageId })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find all messages with user info for admin view\n   * Supports filtering by direction, status, and search\n   */\n  async findAllWithUserInfo(params: {\n    limit?: number;\n    offset?: number;\n    direction?: 'inbound' | 'outbound';\n    status?: string;\n    search?: string;\n    clientId?: string;\n  }): Promise<{\n    messages: (Message & { userName: string | null; userPhone: string })[];\n    total: number;\n  }> {\n    let query = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select([\n        'messages.id',\n        'messages.clientId',\n        'messages.conversationId',\n        'messages.direction',\n        'messages.content',\n        'messages.phoneFrom',\n        'messages.phoneTo',\n        'messages.provider',\n        'messages.providerMessageId',\n        'messages.deliveryStatus',\n        'messages.deliveryAttempts',\n        'messages.lastDeliveryAttemptAt',\n        'messages.deliveryError',\n        'messages.metadata',\n        'messages.createdAt',\n        'users.name as userName',\n        'users.phoneNumber as userPhone',\n      ]);\n\n    // Apply filters\n    if (params.clientId) {\n      query = query.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      query = query.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      query = query.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      query = query.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    // Get total count with same filters\n    let countQuery = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select(({ fn }) => fn.count('messages.id').as('count'));\n\n    if (params.clientId) {\n      countQuery = countQuery.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      countQuery = countQuery.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      countQuery = countQuery.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      countQuery = countQuery.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    const countResult = await countQuery.executeTakeFirst();\n    const total = Number(countResult?.count ?? 0);\n\n    // Get paginated results\n    const messages = await query\n      .orderBy('messages.createdAt', 'desc')\n      .limit(params.limit || 50)\n      .offset(params.offset || 0)\n      .execute();\n\n    return {\n      messages: messages as (Message & { userName: string | null; userPhone: string })[],\n      total,\n    };\n  }\n\n  /**\n   * Get message statistics for admin view\n   */\n  async getStats(clientId?: string): Promise<{\n    totalMessages: number;\n    inbound: number;\n    outbound: number;\n    pending: number;\n    failed: number;\n  }> {\n    let baseQuery = this.db.selectFrom('messages');\n\n    if (clientId) {\n      baseQuery = baseQuery.where('clientId', '=', clientId);\n    }\n\n    const [total, inbound, outbound, pending, failed] = await Promise.all([\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'inbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'outbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['queued', 'sent'])\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['failed', 'undelivered'])\n        .executeTakeFirst(),\n    ]);\n\n    return {\n      totalMessages: Number(total?.count ?? 0),\n      inbound: Number(inbound?.count ?? 0),\n      outbound: Number(outbound?.count ?? 0),\n      pending: Number(pending?.count ?? 0),\n      failed: Number(failed?.count ?? 0),\n    };\n  }\n}"],"names":[],"mappings":"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"}