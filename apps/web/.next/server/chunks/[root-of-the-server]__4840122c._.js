module.exports=[166194,e=>{"use strict";var t=e.i(46308),r=e.i(705590);class s extends t.BaseRepository{async create(e,t){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:t,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,t){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:t,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(t?.count||0)}async countByReferrer(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(t?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>s])},733897,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async createAuthCode(e,t,r){await this.db.insertInto("userAuthCodes").values({phoneNumber:e,code:t,expiresAt:r,createdAt:new Date}).execute()}async findValidCode(e,t){return await this.db.selectFrom("userAuthCodes").select(["id","phoneNumber"]).where("phoneNumber","=",e).where("code","=",t).where("expiresAt",">",new Date).executeTakeFirst()||null}async deleteCodesForPhone(e){await this.db.deleteFrom("userAuthCodes").where("phoneNumber","=",e).execute()}async deleteExpiredCodes(){return Number((await this.db.deleteFrom("userAuthCodes").where("expiresAt","<",new Date).executeTakeFirst()).numDeletedRows||0)}async countRecentRequests(e,t){let r=await this.db.selectFrom("userAuthCodes").select(e=>e.fn.countAll().as("count")).where("phoneNumber","=",e).where("createdAt",">=",t).executeTakeFirst();return Number(r?.count||0)}}e.s(["UserAuthRepository",()=>r])},139765,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async record(e){return await this.db.insertInto("pageVisits").values(e).returningAll().executeTakeFirstOrThrow()}async getVisitsByDateRange(e,t,r){let s=this.db.selectFrom("pageVisits").selectAll().where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc");return r?.source&&(s=s.where("source","=",r.source)),r?.limit&&(s=s.limit(r.limit)),s.execute()}async getVisitCountsBySource(e,t){return(await this.db.selectFrom("pageVisits").select(["source"]).select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).groupBy("source").orderBy("count","desc").execute()).map(e=>({source:e.source,count:Number(e.count)}))}async getTotalVisits(e,t){let r=await this.db.selectFrom("pageVisits").select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).executeTakeFirst();return Number(r?.count??0)}}e.s(["PageVisitRepository",()=>r])},534821,e=>{"use strict";var t=e.i(80643),r=e.i(565431),s=e.i(201236),a=e.i(108436),n=e.i(763800),i=e.i(187070);e.i(249805);var o=e.i(884031),c=e.i(823525);class l{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=r.UserService.getInstance(),this.messageService=t.MessageService.getInstance(),this.progressService=a.ProgressService.getInstance(),this.microcycleService=n.MicrocycleService.getInstance(),this.fitnessPlanService=s.FitnessPlanService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async scheduleMessagesForHour(e){let t=Date.now(),r=[],s=0,a=0;try{let n=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${n.length} users to schedule for hour ${e} on Sunday`),0===n.length)return{scheduled:0,failed:0,duration:Date.now()-t,errors:[]};let o=n.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await i.inngest.send(o);s=e.length,console.log(`[WeeklyMessageService] Scheduled ${s} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),a=o.length,r.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:s,failed:a,duration:Date.now()-t,errors:r}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let t=await this.fitnessPlanService.getCurrentPlan(e.id);if(!t)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let r=(0,c.now)(e.timezone).toJSDate(),s=(0,c.getNextWeekStart)(r,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${s.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(t,s,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:a}=await this.progressService.getOrCreateMicrocycleForDate(e.id,t,s,e.timezone);if(!a)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let n=a.isDeload;n&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${a.absoluteWeek})`);let i=await o.messagingAgentService.generateWeeklyMessage(e,n,a.absoluteWeek),l=a.message;if(!l)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${a.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let u=[],d=await this.messageService.sendMessage(e,i);u.push(d.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let p=await this.messageService.sendMessage(e,l);return u.push(p.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:u}}catch(t){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,t),{success:!1,userId:e.id,error:t instanceof Error?t.message:"Unknown error"}}}}let u=l.getInstance();e.s(["WeeklyMessageService",()=>l,"weeklyMessageService",0,u])},879957,e=>{"use strict";var t=e.i(553573),r=e.i(163459),s=e.i(342845),a=e.i(904973),n=e.i(818385),i=e.i(588303),o=e.i(583020),c=e.i(304941),l=e.i(370312),u=e.i(40504),d=e.i(802579),p=e.i(225915),h=e.i(150373),g=e.i(804342),w=e.i(259207),m=e.i(348684),v=e.i(193695);e.i(650048);var y=e.i(219407),f=e.i(565431);e.i(180256);var S=e.i(80643),R=e.i(739351),b=e.i(982099),x=e.i(66637);e.i(791146);var k=e.i(832821);let A=["STOP","STOPALL","UNSUBSCRIBE","CANCEL","END","QUIT"],C=["START","YES","UNSTOP","RESUME"];async function T(e){try{let t,r,s=new x.default.twiml.MessagingResponse,a=await e.formData(),n=Object.fromEntries(a),i=n.Body||"",o=n.From||"",c=n.To||(0,k.getTwilioSecrets)().phoneNumber,l=await f.userService.getUserByPhone(o);if(!l)return s.message("Sign up now! https://www.gymtext.co/"),new b.NextResponse(s.toString(),{status:200,headers:{"Content-Type":"text/xml"}});let u=await f.userService.getUser(l.id);if(!u)return s.message("Sorry, I had trouble loading your profile. Please try again later."),new b.NextResponse(s.toString(),{status:200,headers:{"Content-Type":"text/xml"}});if(t=i.trim().toUpperCase(),A.includes(t)){let e,t=await R.subscriptionService.cancelSubscription(l.id);if(await S.messageService.storeInboundMessage({clientId:l.id,from:o,to:c,content:i,twilioData:n}),t.success&&t.periodEndDate){let r=t.periodEndDate.toLocaleDateString("en-US",{month:"long",day:"numeric"});e=`You've been unsubscribed from GymText. You'll have access until ${r}. Reply START anytime to reactivate.`}else e="No active subscription found"===t.error?"You don't have an active subscription. Visit gymtext.co to sign up!":"Sorry, there was an issue processing your request. Please try again or contact support.";return await S.messageService.sendMessage(u,e),s.message(""),new b.NextResponse(s.toString(),{status:200,headers:{"Content-Type":"text/xml"}})}if(r=i.trim().toUpperCase(),C.includes(r)){let e,t=await R.subscriptionService.reactivateSubscription(l.id);return await S.messageService.storeInboundMessage({clientId:l.id,from:o,to:c,content:i,twilioData:n}),e=t.success&&t.reactivated?"Welcome back! Your GymText subscription has been reactivated. You'll receive your next workout soon.":t.requiresNewSubscription&&t.checkoutUrl?`Your subscription has ended. Resubscribe here: ${t.checkoutUrl}`:!t.success||t.requiresNewSubscription||t.reactivated?"Sorry, there was an issue processing your request. Visit gymtext.co to subscribe.":"Your subscription is already active! Reply with any question to continue.",await S.messageService.sendMessage(u,e),s.message(""),new b.NextResponse(s.toString(),{status:200,headers:{"Content-Type":"text/xml"}})}let d=await S.messageService.ingestMessage({user:u,content:i,from:o,to:c,twilioData:n});return s.message(d.ackMessage),new b.NextResponse(s.toString(),{status:200,headers:{"Content-Type":"text/xml"}})}catch(t){console.error("Error processing SMS webhook:",t);let e=new x.default.twiml.MessagingResponse;return e.message("Sorry, something went wrong. Please try again later."),new b.NextResponse(e.toString(),{status:200,headers:{"Content-Type":"text/xml"}})}}e.s(["POST",()=>T],590348);var E=e.i(590348);let M=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/twilio/sms/route",pathname:"/api/twilio/sms",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/twilio/sms/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:N,workUnitAsyncStorage:P,serverHooks:_}=M;function I(){return(0,s.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:P})}async function F(e,t,s){M.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/twilio/sms/route";f=f.replace(/\/index$/,"")||"/";let S=await M.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:x,parsedUrl:k,isDraftMode:A,prerenderManifest:C,routerServerContext:T,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,resolvedPathname:P,clientReferenceManifest:_,serverActionsManifest:I}=S,F=(0,c.normalizeAppPath)(f),D=!!(C.dynamicRoutes[F]||C.routes[P]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,k,!1):t.end("This page could not be found"),null);if(D&&!A){let e=!!C.routes[P],t=C.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await U();throw new v.NoFallbackError}}let O=null;!D||M.isDev||A||(O="/index"===(O=P)?"/":O);let $=!0===M.isDev||!D,W=D&&!$;I&&_&&(0,i.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:_,serverActionsManifest:I,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:I})});let q=e.method||"GET",B=(0,n.getTracer)(),H=B.getActiveScopeSpan(),j={params:b,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>M.onRequestError(e,t,s,T)},sharedContext:{buildId:R}},V=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let i=async e=>M.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${q} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${f}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var n,c;let l=async({previousCacheEntry:r})=>{try{if(!o&&E&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(a);e.fetchMetrics=j.renderOpts.fetchMetrics;let c=j.renderOpts.pendingWaitUntil;c&&s.waitUntil&&(s.waitUntil(c),c=void 0);let l=j.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(V,L,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,s=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:E})},T),t}},u=await M.handleResponse({req:e,nextConfig:x,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:o});if(!D)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",E?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&D||d.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,w.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(V,L,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};H?await c(H):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},c))}catch(t){if(t instanceof v.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:E})}),D)throw t;return await (0,h.sendResponse)(V,L,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>I,"routeModule",()=>M,"serverHooks",()=>_,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>P],879957)},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(t=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(t=>e.l(t))).then(()=>t(706674)))},399164,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(t=>e.l(t))).then(()=>t(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},5389,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(t=>e.l(t))).then(()=>t(478500)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(t=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(t=>e.l(t))).then(()=>t(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__4840122c._.js.map