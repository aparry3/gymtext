module.exports=[968387,32721,363690,e=>{"use strict";var t=e.i(681247);let s=new class{provider="twilio";async sendMessage(e,s,r){try{let a=await t.twilioClient.sendSMS(e.phoneNumber,s,r);return{messageId:a.sid,status:this.mapTwilioStatus(a.status),provider:this.provider,to:a.to,from:a.from,timestamp:a.dateCreated,metadata:{twilioSid:a.sid,twilioStatus:a.status,errorCode:a.errorCode,errorMessage:a.errorMessage,mediaUrls:r}}}catch(e){throw console.error("TwilioMessagingClient: Failed to send message",e),e}}mapTwilioStatus(e){switch(e){case"sent":case"delivered":return"delivered";case"queued":case"accepted":case"sending":return"queued";case"failed":case"undelivered":return"failed";default:return"sent"}}};var r=e.i(427699);let a=new class{provider="local";eventEmitter;messageCounter=0;constructor(){this.eventEmitter=new r.EventEmitter,this.eventEmitter.setMaxListeners(100)}async sendMessage(e,t,s){let r=`local-${Date.now()}-${++this.messageCounter}`,a=new Date,n=e.phoneNumber;return this.eventEmitter.emit("message",{messageId:r,to:n,from:"local-system",content:t||"[MMS only - no text]",timestamp:a}),console.log("[LocalMessagingClient] Message sent (not actual SMS):",{messageId:r,to:n,userId:e.id,preview:t?t.substring(0,50):"[MMS only]",mediaUrls:s}),{messageId:r,status:"sent",provider:this.provider,to:n,from:"local-system",timestamp:a,metadata:{userId:e.id,phoneNumber:n,contentLength:t?.length||0,mediaUrls:s}}}onMessage(e){this.eventEmitter.on("message",e)}offMessage(e){this.eventEmitter.off("message",e)}getListenerCount(){return this.eventEmitter.listenerCount("message")}};e.s(["localMessagingClient",0,a],32721);var n=e.i(875559);let i=function(){let{provider:e}=(0,n.getMessagingConfig)();return"local"===e?(console.log("[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)"),a):s}();e.s(["messagingClient",0,i],363690),e.s([],968387)},501261,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,t=50,s=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).offset(s).execute()}async findRecentByClientId(e,t=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).reverse()}async countByClientId(e){let t=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(t?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,t,s){return await this.db.updateTable("messages").set({deliveryStatus:t,deliveryError:s||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let t=await this.findById(e);if(!t)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(t.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,t){return await this.db.updateTable("messages").set({providerMessageId:t}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await s.executeTakeFirst(),a=Number(r?.count??0);return{messages:await t.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:a}}async getStats(e){let t=this.db.selectFrom("messages");e&&(t=t.where("clientId","=",e));let[s,r,a,n,i]=await Promise.all([t.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(s?.count??0),inbound:Number(r?.count??0),outbound:Number(a?.count??0),pending:Number(n?.count??0),failed:Number(i?.count??0)}}}e.s(["MessageRepository",()=>s])},37702,(e,t,s)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},812057,(e,t,s)=>{t.exports=e.x("node:util",()=>require("node:util"))},363890,(e,t,s)=>{t.exports=e.x("stream/web",()=>require("stream/web"))},60438,(e,t,s)=>{t.exports=e.x("perf_hooks",()=>require("perf_hooks"))},178249,(e,t,s)=>{t.exports=e.x("util/types",()=>require("util/types"))},687769,(e,t,s)=>{t.exports=e.x("node:events",()=>require("node:events"))},154993,(e,t,s)=>{t.exports=e.x("diagnostics_channel",()=>require("diagnostics_channel"))},925328,(e,t,s)=>{t.exports=e.x("http2",()=>require("http2"))},99348,(e,t,s)=>{t.exports=e.x("string_decoder",()=>require("string_decoder"))},410430,(e,t,s)=>{t.exports=e.x("async_hooks",()=>require("async_hooks"))},611913,(e,t,s)=>{t.exports=e.x("console",()=>require("console"))},671440,e=>{"use strict";var t=e.i(553573),s=e.i(163459),r=e.i(342845),a=e.i(904973),n=e.i(818385),i=e.i(588303),o=e.i(583020),l=e.i(304941),d=e.i(370312),u=e.i(40504),c=e.i(802579),m=e.i(225915),h=e.i(150373),p=e.i(804342),g=e.i(259207),v=e.i(348684),w=e.i(193695);e.i(650048);var y=e.i(219407),f=e.i(982099),x=e.i(172709);e.i(791146);var R=e.i(832821);async function _(e){try{let t=e.headers.get("authorization"),{cronSecret:s}=(0,R.getCronSecrets)();if(!s)return console.error("[CRON] CRON_SECRET is not configured"),f.NextResponse.json({error:"Server configuration error"},{status:500});if(t!==`Bearer ${s}`)return f.NextResponse.json({error:"Unauthorized"},{status:401});let r=new Date,a=r.getUTCHours();console.log("[CRON] Daily messages cron triggered",{timestamp:r.toISOString(),utcHour:a});let n=x.DailyMessageService.getInstance(),{scheduled:i,failed:o,duration:l,errors:d}=await n.scheduleMessagesForHour(a);return console.log("[CRON] Daily message scheduling completed:",{scheduled:i,failed:o,duration:`${l}ms`,timestamp:r.toISOString()}),d.length>0&&console.error("[CRON] Daily message scheduling errors:",d),f.NextResponse.json({success:!0,scheduled:i,failed:o,duration:l,timestamp:r.toISOString()})}catch(e){return console.error("[CRON] Fatal error in daily messages cron:",e),f.NextResponse.json({error:"Internal server error",timestamp:new Date().toISOString()},{status:500})}}e.s(["GET",()=>_,"maxDuration",0,60],803935);var b=e.i(803935);let C=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/cron/daily-messages/route",pathname:"/api/cron/daily-messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/cron/daily-messages/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:E,workUnitAsyncStorage:T,serverHooks:A}=C;function S(){return(0,r.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:T})}async function I(e,t,r){C.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/cron/daily-messages/route";f=f.replace(/\/index$/,"")||"/";let x=await C.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:_,nextConfig:b,parsedUrl:E,isDraftMode:T,prerenderManifest:A,routerServerContext:S,isOnDemandRevalidate:I,revalidateOnlyGenerated:k,resolvedPathname:N,clientReferenceManifest:M,serverActionsManifest:F}=x,P=(0,l.normalizeAppPath)(f),O=!!(A.dynamicRoutes[P]||A.routes[N]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!T){let e=!!A.routes[N],t=A.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await D();throw new w.NoFallbackError}}let q=null;!O||C.isDev||T||(q="/index"===(q=N)?"/":q);let $=!0===C.isDev||!O,H=O&&!$;F&&M&&(0,i.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:M,serverActionsManifest:F,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:F})});let U=e.method||"GET",j=(0,n.getTracer)(),B=j.getActiveScopeSpan(),L={params:_,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,r)=>C.onRequestError(e,t,r,S)},sharedContext:{buildId:R}},K=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),z=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let i=async e=>C.handle(z,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=j.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=s.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${f}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let d=async({previousCacheEntry:s})=>{try{if(!o&&I&&k&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(K,G,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,r=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:r}}}}catch(t){throw(null==s?void 0:s.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:I})},S),t}},u=await C.handleResponse({req:e,nextConfig:b,cacheKey:q,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:k,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||c.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(K,G,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};B?await l(B):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:I})}),O)throw t;return await (0,h.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>S,"routeModule",()=>C,"serverHooks",()=>A,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>T],671440)},5389,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(t=>e.l(t))).then(()=>t(478500)))},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(t=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(t=>e.l(t))).then(()=>t(706674)))},399164,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(t=>e.l(t))).then(()=>t(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(t=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(t=>e.l(t))).then(()=>t(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__59fee347._.js.map