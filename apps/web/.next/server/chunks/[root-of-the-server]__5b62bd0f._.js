module.exports=[166194,e=>{"use strict";var t=e.i(46308),r=e.i(705590);class s extends t.BaseRepository{async create(e,t){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:t,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,t){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:t,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(t?.count||0)}async countByReferrer(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(t?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>s])},733897,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async createAuthCode(e,t,r){await this.db.insertInto("userAuthCodes").values({phoneNumber:e,code:t,expiresAt:r,createdAt:new Date}).execute()}async findValidCode(e,t){return await this.db.selectFrom("userAuthCodes").select(["id","phoneNumber"]).where("phoneNumber","=",e).where("code","=",t).where("expiresAt",">",new Date).executeTakeFirst()||null}async deleteCodesForPhone(e){await this.db.deleteFrom("userAuthCodes").where("phoneNumber","=",e).execute()}async deleteExpiredCodes(){return Number((await this.db.deleteFrom("userAuthCodes").where("expiresAt","<",new Date).executeTakeFirst()).numDeletedRows||0)}async countRecentRequests(e,t){let r=await this.db.selectFrom("userAuthCodes").select(e=>e.fn.countAll().as("count")).where("phoneNumber","=",e).where("createdAt",">=",t).executeTakeFirst();return Number(r?.count||0)}}e.s(["UserAuthRepository",()=>r])},139765,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async record(e){return await this.db.insertInto("pageVisits").values(e).returningAll().executeTakeFirstOrThrow()}async getVisitsByDateRange(e,t,r){let s=this.db.selectFrom("pageVisits").selectAll().where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc");return r?.source&&(s=s.where("source","=",r.source)),r?.limit&&(s=s.limit(r.limit)),s.execute()}async getVisitCountsBySource(e,t){return(await this.db.selectFrom("pageVisits").select(["source"]).select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).groupBy("source").orderBy("count","desc").execute()).map(e=>({source:e.source,count:Number(e.count)}))}async getTotalVisits(e,t){let r=await this.db.selectFrom("pageVisits").select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).executeTakeFirst();return Number(r?.count??0)}}e.s(["PageVisitRepository",()=>r])},534821,e=>{"use strict";var t=e.i(80643),r=e.i(565431),s=e.i(201236),n=e.i(108436),a=e.i(763800),o=e.i(187070);e.i(249805);var i=e.i(884031),c=e.i(823525);class u{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=r.UserService.getInstance(),this.messageService=t.MessageService.getInstance(),this.progressService=n.ProgressService.getInstance(),this.microcycleService=a.MicrocycleService.getInstance(),this.fitnessPlanService=s.FitnessPlanService.getInstance()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async scheduleMessagesForHour(e){let t=Date.now(),r=[],s=0,n=0;try{let a=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${a.length} users to schedule for hour ${e} on Sunday`),0===a.length)return{scheduled:0,failed:0,duration:Date.now()-t,errors:[]};let i=a.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await o.inngest.send(i);s=e.length,console.log(`[WeeklyMessageService] Scheduled ${s} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),n=i.length,r.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:s,failed:n,duration:Date.now()-t,errors:r}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let t=await this.fitnessPlanService.getCurrentPlan(e.id);if(!t)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let r=(0,c.now)(e.timezone).toJSDate(),s=(0,c.getNextWeekStart)(r,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${s.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(t,s,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:n}=await this.progressService.getOrCreateMicrocycleForDate(e.id,t,s,e.timezone);if(!n)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let a=n.isDeload;a&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${n.absoluteWeek})`);let o=await i.messagingAgentService.generateWeeklyMessage(e,a,n.absoluteWeek),u=n.message;if(!u)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${n.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let l=[],d=await this.messageService.sendMessage(e,o);l.push(d.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let h=await this.messageService.sendMessage(e,u);return l.push(h.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:l}}catch(t){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,t),{success:!1,userId:e.id,error:t instanceof Error?t.message:"Unknown error"}}}}let l=u.getInstance();e.s(["WeeklyMessageService",()=>u,"weeklyMessageService",0,l])},777492,e=>{"use strict";var t=e.i(254799);e.i(791146);var r=e.i(832821);let s="aes-256-gcm";function n(){let{sessionEncryptionKey:e}=(0,r.getDatabaseSecrets)();return e?64===e.length?Buffer.from(e,"hex"):t.default.scryptSync(e,"salt",32):(console.warn("SESSION_ENCRYPTION_KEY not set, using development key"),t.default.scryptSync("gymtext-dev-key","salt",32))}function a(e){try{let r=n(),a=t.default.randomBytes(16),o=t.default.createCipheriv(s,r,a),i=o.update(e,"utf8","hex");i+=o.final("hex");let c=o.getAuthTag();return Buffer.concat([a,c,Buffer.from(i,"hex")]).toString("base64")}catch(e){throw console.error("Error encrypting user ID:",e),Error("Failed to encrypt session")}}function o(e){try{let r=n(),a=Buffer.from(e,"base64"),o=a.subarray(0,16),i=a.subarray(16,32),c=a.subarray(32),u=t.default.createDecipheriv(s,r,o);u.setAuthTag(i);let l=u.update(c.toString("hex"),"hex","utf8");return l+=u.final("utf8")}catch(e){return console.error("Error decrypting user ID:",e),null}}e.s(["decryptUserId",()=>o,"encryptUserId",()=>a])},619588,e=>{"use strict";var t=e.i(777492);function r(e,r){if(e.cookies.get("gt_admin")?.value==="ok")return{isAuthorized:!0,isAdmin:!0,userId:null};let s=e.cookies.get("gt_user_session")?.value;if(!s)return{isAuthorized:!1,isAdmin:!1,userId:null,error:"No authentication credentials provided"};let n=(0,t.decryptUserId)(s);return n?n!==r?{isAuthorized:!1,isAdmin:!1,userId:n,error:"Unauthorized to access this user data"}:{isAuthorized:!0,isAdmin:!1,userId:n}:{isAuthorized:!1,isAdmin:!1,userId:null,error:"Invalid session token"}}e.s(["checkAuthorization",()=>r])},395907,e=>{"use strict";var t=e.i(553573),r=e.i(163459),s=e.i(342845),n=e.i(904973),a=e.i(818385),o=e.i(588303),i=e.i(583020),c=e.i(304941),u=e.i(370312),l=e.i(40504),d=e.i(802579),h=e.i(225915),p=e.i(150373),g=e.i(804342),f=e.i(259207),m=e.i(348684),w=e.i(193695);e.i(650048);var v=e.i(219407),y=e.i(982099);e.i(180256);var k=e.i(125720),R=e.i(619588);async function x(e,{params:t}){try{let{id:r,workoutId:s}=await t;if(!r)return y.NextResponse.json({success:!1,message:"User ID is required"},{status:400});if(!s)return y.NextResponse.json({success:!1,message:"Workout ID is required"},{status:400});let n=(0,R.checkAuthorization)(e,r);if(!n.isAuthorized)return y.NextResponse.json({success:!1,message:n.error||"Unauthorized"},{status:403});let a=await k.workoutInstanceService.getWorkoutById(s,r);if(!a)return y.NextResponse.json({success:!1,message:"Workout not found"},{status:404});return y.NextResponse.json({success:!0,data:a})}catch(e){return console.error("Error fetching workout:",e),y.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}async function A(e,{params:t}){try{let{id:r,workoutId:s}=await t;if(!r)return y.NextResponse.json({success:!1,message:"User ID is required"},{status:400});if(!s)return y.NextResponse.json({success:!1,message:"Workout ID is required"},{status:400});let n=(0,R.checkAuthorization)(e,r);if(!n.isAuthorized)return y.NextResponse.json({success:!1,message:n.error||"Unauthorized"},{status:403});if(!n.isAdmin)return y.NextResponse.json({success:!1,message:"Only administrators can delete workouts"},{status:403});if(!await k.workoutInstanceService.deleteWorkout(s,r))return y.NextResponse.json({success:!1,message:"Workout not found or already deleted"},{status:404});return y.NextResponse.json({success:!0,message:"Workout deleted successfully"})}catch(e){return console.error("Error deleting workout:",e),y.NextResponse.json({success:!1,message:"Internal server error"},{status:500})}}e.s(["DELETE",()=>A,"GET",()=>x],698222);var S=e.i(698222);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/users/[id]/workouts/[workoutId]/route",pathname:"/api/users/[id]/workouts/[workoutId]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/users/[id]/workouts/[workoutId]/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:b,workUnitAsyncStorage:E,serverHooks:C}=I;function _(){return(0,s.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:E})}async function N(e,t,s){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/users/[id]/workouts/[workoutId]/route";y=y.replace(/\/index$/,"")||"/";let k=await I.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!k)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:R,params:x,nextConfig:A,parsedUrl:S,isDraftMode:b,prerenderManifest:E,routerServerContext:C,isOnDemandRevalidate:_,revalidateOnlyGenerated:N,resolvedPathname:T,clientReferenceManifest:P,serverActionsManifest:M}=k,F=(0,c.normalizeAppPath)(y),D=!!(E.dynamicRoutes[F]||E.routes[T]),W=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,S,!1):t.end("This page could not be found"),null);if(D&&!b){let e=!!E.routes[T],t=E.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await W();throw new w.NoFallbackError}}let U=null;!D||I.isDev||b||(U="/index"===(U=T)?"/":U);let O=!0===I.isDev||!D,j=D&&!O;M&&P&&(0,o.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:P,serverActionsManifest:M,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:M})});let $=e.method||"GET",B=(0,a.getTracer)(),q=B.getActiveScopeSpan(),z={params:x,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>I.onRequestError(e,t,s,C)},sharedContext:{buildId:R}},H=new u.NodeNextRequest(e),V=new u.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(H,(0,l.signalFromNodeResponse)(t));try{let o=async e=>I.handle(K,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${$} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${y}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var a,c;let u=async({previousCacheEntry:r})=>{try{if(!i&&_&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(n);e.fetchMetrics=z.renderOpts.fetchMetrics;let c=z.renderOpts.pendingWaitUntil;c&&s.waitUntil&&(s.waitUntil(c),c=void 0);let u=z.renderOpts.collectedTags;if(!D)return await (0,p.sendResponse)(H,V,a,z.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,s=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:_})},C),t}},l=await I.handleResponse({req:e,nextConfig:A,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:s.waitUntil,isMinimalMode:i});if(!D)return null;if((null==l||null==(a=l.value)?void 0:a.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",_?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&D||d.delete(m.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(H,V,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};q?await c(q):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${$} ${y}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},c))}catch(t){if(t instanceof w.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:_})}),D)throw t;return await (0,p.sendResponse)(H,V,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>_,"routeModule",()=>I,"serverHooks",()=>C,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>E],395907)},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(t=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(t=>e.l(t))).then(()=>t(706674)))},399164,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(t=>e.l(t))).then(()=>t(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},5389,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(t=>e.l(t))).then(()=>t(478500)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(t=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(t=>e.l(t))).then(()=>t(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__5b62bd0f._.js.map