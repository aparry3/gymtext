module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},967255,(e,t,r)=>{t.exports=e.x("pg",()=>require("pg"))},13423,e=>{"use strict";var t=e.i(46308),r=e.i(705590);class s extends t.BaseRepository{async create(e,t){let r={clientId:e,signupData:t?JSON.parse(JSON.stringify(t)):null,status:"pending",programMessagesSent:!1};return await this.db.insertInto("userOnboarding").values(r).returningAll().executeTakeFirstOrThrow()}async findByClientId(e){return await this.db.selectFrom("userOnboarding").selectAll().where("clientId","=",e).executeTakeFirst()??null}async updateStatus(e,t,r){return await this.db.updateTable("userOnboarding").set({status:t,errorMessage:r??null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markStarted(e){return await this.db.updateTable("userOnboarding").set({status:"in_progress",startedAt:r.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async updateCurrentStep(e,t){return await this.db.updateTable("userOnboarding").set({currentStep:t}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markCompleted(e){return await this.db.updateTable("userOnboarding").set({status:"completed",completedAt:r.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markMessagesSent(e){return await this.db.updateTable("userOnboarding").set({programMessagesSent:!0}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async hasMessagesSent(e){let t=await this.db.selectFrom("userOnboarding").select("programMessagesSent").where("clientId","=",e).executeTakeFirst();return t?.programMessagesSent??!1}async getSignupData(e){let t=await this.db.selectFrom("userOnboarding").select("signupData").where("clientId","=",e).executeTakeFirst();return t?.signupData??null}async clearSignupData(e){return await this.db.updateTable("userOnboarding").set({signupData:null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async delete(e){await this.db.deleteFrom("userOnboarding").where("clientId","=",e).execute()}}e.s(["OnboardingRepository",()=>s])},565431,39917,e=>{"use strict";var t,r=e.i(973559),s=e.i(297934),a=e.i(13423);(t={}).CLOSED="CLOSED",t.OPEN="OPEN",t.HALF_OPEN="HALF_OPEN";class i{state="CLOSED";failureCount=0;successCount=0;lastFailureTime=null;options;constructor(e={}){this.options={failureThreshold:e.failureThreshold||5,resetTimeout:e.resetTimeout||6e4,monitoringPeriod:e.monitoringPeriod||6e4}}async execute(e){if("OPEN"===this.state)if(!this.shouldAttemptReset())return console.warn("Circuit breaker is OPEN, skipping execution"),null;else this.state="HALF_OPEN";try{let t=await e();return this.onSuccess(),t}catch(e){throw this.onFailure(),e}}onSuccess(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=3&&(this.state="CLOSED",this.successCount=0,console.info("Circuit breaker is now CLOSED")))}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state?(this.state="OPEN",console.warn("Circuit breaker is now OPEN due to failure in HALF_OPEN state")):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`))}shouldAttemptReset(){return null!==this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.options.resetTimeout}getState(){return this.state}getStats(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount,lastFailureTime:this.lastFailureTime}}}e.s(["CircuitBreaker",()=>i],39917);var n=e.i(823525);class o{static instance;userRepository;onboardingRepository;circuitBreaker;constructor(){this.userRepository=new s.UserRepository,this.onboardingRepository=new a.OnboardingRepository,this.circuitBreaker=new i({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4})}static getInstance(){return o.instance||(o.instance=new o),o.instance}async createUser(e){let t=await this.circuitBreaker.execute(async()=>{if(await this.userRepository.findByPhoneNumber(e.phoneNumber))throw Error("User already exists with this phone number");let t={name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null};r.UserModel.validateUserData(t);let s=await this.userRepository.create(t);if(!s)throw Error("Failed to create user");return s});if(!t)throw Error("Failed to create user");return t}async getUserById(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findById(e))||void 0}async getUserByPhone(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findByPhoneNumber(e))||void 0}async getUser(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findWithProfile(e))}async getUsersForHour(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findUsersForHour(e))||[]}async getUsersForWeeklyMessage(e){return await this.circuitBreaker.execute(async()=>{let t=new Date;t.setUTCHours(e,0,0,0);let r=(0,n.getTimezonesAtLocalTime)(t,17,7);return await this.userRepository.findUsersByTimezones(r)})||[]}async updateUser(e,t){let s=await this.circuitBreaker.execute(async()=>(r.UserModel.validateUserUpdates(t),await this.userRepository.update(e,t)));if(!s)throw Error("Failed to update user");return s}async updatePreferences(e,t){let r=await this.circuitBreaker.execute(async()=>await this.userRepository.updatePreferences(e,t));if(!r)throw Error("Failed to update preferences");return r}async listUsersForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let{page:t=1,pageSize:r=20,sort:s={field:"createdAt",direction:"desc"},...a}=e,i={q:a.search,hasProfile:a.hasProfile,createdFrom:a.createdAfter,createdTo:a.createdBefore,page:t,pageSize:r,sort:`${s.field}:${s.direction}`},{users:n,total:o}=await this.userRepository.list(i),u=n.map(e=>this.transformToAdminUser(e));return{users:u,pagination:{page:t,limit:r,total:o,totalPages:Math.ceil(o/r)},stats:await this.calculateUserStats()}});if(!t)throw Error("Failed to fetch users");return t}async getUserForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let t=await this.userRepository.findWithProfile(e);if(!t)throw Error("User not found");let r=this.transformToAdminUser(t),s=await this.onboardingRepository.getSignupData(e);return{user:r,profile:t.profile||null,signupData:s,recentActivity:{totalMessages:0,totalWorkouts:0}}});if(!t)throw Error("Failed to fetch user");return t}async deleteUser(e){return await this.circuitBreaker.execute(async()=>!!await this.userRepository.findById(e)&&await this.userRepository.delete(e))||!1}transformToAdminUser(e){let t=!!e.profile;return{...e,hasProfile:t,profileSummary:void 0,stats:{totalWorkouts:0,isActiveToday:!1}}}async calculateUserStats(){let e=(await this.userRepository.list({pageSize:1e3})).users,t=e.length,r=e.filter(e=>e.email).length;return{totalUsers:t,withEmail:r,withProfile:e.filter(e=>e.profile).length,activeToday:0}}}let u=o.getInstance();e.s(["UserService",()=>o,"userService",0,u],565431)},659382,e=>{"use strict";var t=e.i(553573),r=e.i(163459),s=e.i(342845),a=e.i(904973),i=e.i(818385),n=e.i(588303),o=e.i(583020),u=e.i(304941),l=e.i(370312),c=e.i(40504),d=e.i(802579),p=e.i(225915),h=e.i(150373),f=e.i(804342),m=e.i(259207),w=e.i(348684),g=e.i(193695);e.i(650048);var y=e.i(219407),x=e.i(982099),R=e.i(565431),T=e.i(301418),v=e.i(823525);async function E(e){return e.headers.get("x-user-id")}async function b(e){try{let t=await E(e);if(!t)return x.NextResponse.json({error:"Unauthorized"},{status:401});let r=await R.userService.getUserById(t);if(!r)return x.NextResponse.json({error:"User not found"},{status:404});let s=(0,v.now)(r.timezone),a=s.set({hour:r.preferredSendHour,minute:0,second:0,millisecond:0});return a<=s&&(a=a.plus({days:1})),x.NextResponse.json({preferredSendHour:r.preferredSendHour,timezone:r.timezone,timezoneDisplay:(0,T.formatTimezoneForDisplay)(r.timezone),localTime:`${r.preferredSendHour}:00`,localTime12h:(0,v.now)(r.timezone).set({hour:r.preferredSendHour}).toFormat("h:mm a"),nextDelivery:a.toISO(),nextDeliveryLocal:a.toFormat("EEE, MMM d 'at' h:mm a")})}catch(e){return console.error("Error fetching user preferences:",e),x.NextResponse.json({error:"Internal server error"},{status:500})}}async function S(e){try{let t=await E(e);if(!t)return x.NextResponse.json({error:"Unauthorized"},{status:401});let{preferredSendHour:r,timezone:s}=await e.json(),a=[];if(void 0!==r&&("number"!=typeof r||r<0||r>23)&&a.push("preferredSendHour must be a number between 0 and 23"),void 0===s||"string"==typeof s&&(0,T.isValidIANATimezone)(s)||a.push("timezone must be a valid IANA timezone identifier"),a.length>0)return x.NextResponse.json({error:"Validation failed",errors:a},{status:400});let i={};void 0!==r&&(i.preferredSendHour=r),void 0!==s&&(i.timezone=s);let n=await R.userService.updatePreferences(t,i);if(!n)return x.NextResponse.json({error:"Failed to update preferences"},{status:500});let o=(0,v.now)(n.timezone),u=o.set({hour:n.preferredSendHour,minute:0,second:0,millisecond:0});return u<=o&&(u=u.plus({days:1})),x.NextResponse.json({success:!0,preferences:{preferredSendHour:n.preferredSendHour,timezone:n.timezone,timezoneDisplay:(0,T.formatTimezoneForDisplay)(n.timezone),localTime:`${n.preferredSendHour}:00`,localTime12h:(0,v.now)(n.timezone).set({hour:n.preferredSendHour}).toFormat("h:mm a"),nextDelivery:u.toISO(),nextDeliveryLocal:u.toFormat("EEE, MMM d 'at' h:mm a")}})}catch(e){return console.error("Error updating user preferences:",e),x.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>b,"PUT",()=>S],336875);var C=e.i(336875);let O=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/users/preferences/route",pathname:"/api/users/preferences",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/users/preferences/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:A,workUnitAsyncStorage:N,serverHooks:k}=O;function F(){return(0,s.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:N})}async function P(e,t,s){O.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/users/preferences/route";x=x.replace(/\/index$/,"")||"/";let R=await O.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:T,params:v,nextConfig:E,parsedUrl:b,isDraftMode:S,prerenderManifest:C,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:k,resolvedPathname:F,clientReferenceManifest:P,serverActionsManifest:U}=R,I=(0,u.normalizeAppPath)(x),H=!!(C.dynamicRoutes[I]||C.routes[F]),M=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,b,!1):t.end("This page could not be found"),null);if(H&&!S){let e=!!C.routes[F],t=C.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await M();throw new g.NoFallbackError}}let D=null;!H||O.isDev||S||(D="/index"===(D=F)?"/":D);let B=!0===O.isDev||!H,_=H&&!B;U&&P&&(0,n.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:P,serverActionsManifest:U,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:U})});let j=e.method||"GET",z=(0,i.getTracer)(),q=z.getActiveScopeSpan(),L={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>O.onRequestError(e,t,s,A)},sharedContext:{buildId:T}},$=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),W=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let n=async e=>O.handle(W,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${x}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var i,u;let l=async({previousCacheEntry:r})=>{try{if(!o&&N&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let u=L.renderOpts.pendingWaitUntil;u&&s.waitUntil&&(s.waitUntil(u),u=void 0);let l=L.renderOpts.collectedTags;if(!H)return await (0,h.sendResponse)($,K,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,s=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:N})},A),t}},c=await O.handleResponse({req:e,nextConfig:E,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:k,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:o});if(!H)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&H||d.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)($,K,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};q?await u(q):await z.withPropagatedContext(e.headers,()=>z.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${x}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},u))}catch(t){if(t instanceof g.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:N})}),H)throw t;return await (0,h.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>F,"routeModule",()=>O,"serverHooks",()=>k,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>N],659382)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__604159e9._.js.map