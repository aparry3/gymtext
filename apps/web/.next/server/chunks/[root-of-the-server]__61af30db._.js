module.exports=[166194,e=>{"use strict";var t=e.i(46308),r=e.i(705590);class s extends t.BaseRepository{async create(e,t){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:t,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,t){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:t,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(t?.count||0)}async countByReferrer(e){let t=await this.db.selectFrom("referrals").select(r.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(t?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>s])},733897,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async createAuthCode(e,t,r){await this.db.insertInto("userAuthCodes").values({phoneNumber:e,code:t,expiresAt:r,createdAt:new Date}).execute()}async findValidCode(e,t){return await this.db.selectFrom("userAuthCodes").select(["id","phoneNumber"]).where("phoneNumber","=",e).where("code","=",t).where("expiresAt",">",new Date).executeTakeFirst()||null}async deleteCodesForPhone(e){await this.db.deleteFrom("userAuthCodes").where("phoneNumber","=",e).execute()}async deleteExpiredCodes(){return Number((await this.db.deleteFrom("userAuthCodes").where("expiresAt","<",new Date).executeTakeFirst()).numDeletedRows||0)}async countRecentRequests(e,t){let r=await this.db.selectFrom("userAuthCodes").select(e=>e.fn.countAll().as("count")).where("phoneNumber","=",e).where("createdAt",">=",t).executeTakeFirst();return Number(r?.count||0)}}e.s(["UserAuthRepository",()=>r])},139765,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async record(e){return await this.db.insertInto("pageVisits").values(e).returningAll().executeTakeFirstOrThrow()}async getVisitsByDateRange(e,t,r){let s=this.db.selectFrom("pageVisits").selectAll().where("createdAt",">=",e).where("createdAt","<=",t).orderBy("createdAt","desc");return r?.source&&(s=s.where("source","=",r.source)),r?.limit&&(s=s.limit(r.limit)),s.execute()}async getVisitCountsBySource(e,t){return(await this.db.selectFrom("pageVisits").select(["source"]).select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).groupBy("source").orderBy("count","desc").execute()).map(e=>({source:e.source,count:Number(e.count)}))}async getTotalVisits(e,t){let r=await this.db.selectFrom("pageVisits").select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",t).executeTakeFirst();return Number(r?.count??0)}}e.s(["PageVisitRepository",()=>r])},534821,e=>{"use strict";var t=e.i(80643),r=e.i(565431),s=e.i(201236),a=e.i(108436),n=e.i(763800),i=e.i(187070);e.i(249805);var o=e.i(884031),c=e.i(823525);class l{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=r.UserService.getInstance(),this.messageService=t.MessageService.getInstance(),this.progressService=a.ProgressService.getInstance(),this.microcycleService=n.MicrocycleService.getInstance(),this.fitnessPlanService=s.FitnessPlanService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async scheduleMessagesForHour(e){let t=Date.now(),r=[],s=0,a=0;try{let n=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${n.length} users to schedule for hour ${e} on Sunday`),0===n.length)return{scheduled:0,failed:0,duration:Date.now()-t,errors:[]};let o=n.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await i.inngest.send(o);s=e.length,console.log(`[WeeklyMessageService] Scheduled ${s} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),a=o.length,r.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:s,failed:a,duration:Date.now()-t,errors:r}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let t=await this.fitnessPlanService.getCurrentPlan(e.id);if(!t)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let r=(0,c.now)(e.timezone).toJSDate(),s=(0,c.getNextWeekStart)(r,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${s.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(t,s,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:a}=await this.progressService.getOrCreateMicrocycleForDate(e.id,t,s,e.timezone);if(!a)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let n=a.isDeload;n&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${a.absoluteWeek})`);let i=await o.messagingAgentService.generateWeeklyMessage(e,n,a.absoluteWeek),l=a.message;if(!l)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${a.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let u=[],d=await this.messageService.sendMessage(e,i);u.push(d.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let h=await this.messageService.sendMessage(e,l);return u.push(h.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:u}}catch(t){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,t),{success:!1,userId:e.id,error:t instanceof Error?t.message:"Unknown error"}}}}let u=l.getInstance();e.s(["WeeklyMessageService",()=>l,"weeklyMessageService",0,u])},777492,e=>{"use strict";var t=e.i(254799);e.i(791146);var r=e.i(832821);let s="aes-256-gcm";function a(){let{sessionEncryptionKey:e}=(0,r.getDatabaseSecrets)();return e?64===e.length?Buffer.from(e,"hex"):t.default.scryptSync(e,"salt",32):(console.warn("SESSION_ENCRYPTION_KEY not set, using development key"),t.default.scryptSync("gymtext-dev-key","salt",32))}function n(e){try{let r=a(),n=t.default.randomBytes(16),i=t.default.createCipheriv(s,r,n),o=i.update(e,"utf8","hex");o+=i.final("hex");let c=i.getAuthTag();return Buffer.concat([n,c,Buffer.from(o,"hex")]).toString("base64")}catch(e){throw console.error("Error encrypting user ID:",e),Error("Failed to encrypt session")}}function i(e){try{let r=a(),n=Buffer.from(e,"base64"),i=n.subarray(0,16),o=n.subarray(16,32),c=n.subarray(32),l=t.default.createDecipheriv(s,r,i);l.setAuthTag(o);let u=l.update(c.toString("hex"),"hex","utf8");return u+=l.final("utf8")}catch(e){return console.error("Error decrypting user ID:",e),null}}e.s(["decryptUserId",()=>i,"encryptUserId",()=>n])},619588,e=>{"use strict";var t=e.i(777492);function r(e,r){if(e.cookies.get("gt_admin")?.value==="ok")return{isAuthorized:!0,isAdmin:!0,userId:null};let s=e.cookies.get("gt_user_session")?.value;if(!s)return{isAuthorized:!1,isAdmin:!1,userId:null,error:"No authentication credentials provided"};let a=(0,t.decryptUserId)(s);return a?a!==r?{isAuthorized:!1,isAdmin:!1,userId:a,error:"Unauthorized to access this user data"}:{isAuthorized:!0,isAdmin:!1,userId:a}:{isAuthorized:!1,isAdmin:!1,userId:null,error:"Invalid session token"}}e.s(["checkAuthorization",()=>r])},313556,e=>{"use strict";var t=e.i(553573),r=e.i(163459),s=e.i(342845),a=e.i(904973),n=e.i(818385),i=e.i(588303),o=e.i(583020),c=e.i(304941),l=e.i(370312),u=e.i(40504),d=e.i(802579),h=e.i(225915),p=e.i(150373),g=e.i(804342),f=e.i(259207),m=e.i(348684),v=e.i(193695);e.i(650048);var w=e.i(219407),y=e.i(982099),k=e.i(565431);e.i(180256);var A=e.i(172709),S=e.i(619588);async function R(e,{params:t}){try{let{id:r}=await t;if(!r)return y.NextResponse.json({error:"User ID is required"},{status:400});let s=(0,S.checkAuthorization)(e,r);if(!s.isAuthorized)return y.NextResponse.json({error:s.error||"Unauthorized"},{status:403});let a=await k.userService.getUser(r);if(!a)return y.NextResponse.json({error:"User not found"},{status:404});return await A.dailyMessageService.sendDailyMessage(a),y.NextResponse.json({success:!0,message:"dailyMessage sent successfully"})}catch(e){return console.error("Error in fitness program creation:",e),y.NextResponse.json({error:e instanceof Error?e.message:"An unknown error occurred"},{status:500})}}e.s(["POST",()=>R],532620);var x=e.i(532620);let b=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/users/[id]/messages/route",pathname:"/api/users/[id]/messages",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/users/[id]/messages/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:I,workUnitAsyncStorage:C,serverHooks:_}=b;function E(){return(0,s.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:C})}async function N(e,t,s){b.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/users/[id]/messages/route";y=y.replace(/\/index$/,"")||"/";let k=await b.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!k)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:A,params:S,nextConfig:R,parsedUrl:x,isDraftMode:I,prerenderManifest:C,routerServerContext:_,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,resolvedPathname:M,clientReferenceManifest:P,serverActionsManifest:T}=k,F=(0,c.normalizeAppPath)(y),D=!!(C.dynamicRoutes[F]||C.routes[M]),U=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,x,!1):t.end("This page could not be found"),null);if(D&&!I){let e=!!C.routes[M],t=C.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await U();throw new v.NoFallbackError}}let O=null;!D||b.isDev||I||(O="/index"===(O=M)?"/":O);let $=!0===b.isDev||!D,W=D&&!$;T&&P&&(0,i.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:P,serverActionsManifest:T,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:T})});let B=e.method||"GET",j=(0,n.getTracer)(),q=j.getActiveScopeSpan(),H={params:S,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>b.onRequestError(e,t,s,_)},sharedContext:{buildId:A}},z=new l.NodeNextRequest(e),V=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(z,(0,u.signalFromNodeResponse)(t));try{let i=async e=>b.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${B} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${y}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var n,c;let l=async({previousCacheEntry:r})=>{try{if(!o&&E&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let c=H.renderOpts.pendingWaitUntil;c&&s.waitUntil&&(s.waitUntil(c),c=void 0);let l=H.renderOpts.collectedTags;if(!D)return await (0,p.sendResponse)(z,V,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,s=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:E})},_),t}},u=await b.handleResponse({req:e,nextConfig:R,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:o});if(!D)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",E?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&D||d.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(z,V,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};q?await c(q):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${B} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},c))}catch(t){if(t instanceof v.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:E})}),D)throw t;return await (0,p.sendResponse)(z,V,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>E,"routeModule",()=>b,"serverHooks",()=>_,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>C],313556)},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(t=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(t=>e.l(t))).then(()=>t(706674)))},399164,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(t=>e.l(t))).then(()=>t(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},5389,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(t=>e.l(t))).then(()=>t(478500)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(t=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(t=>e.l(t))).then(()=>t(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__61af30db._.js.map