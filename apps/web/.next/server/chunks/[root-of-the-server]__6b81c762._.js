module.exports=[840936,e=>{"use strict";var t=e.i(46308),s=e.i(76421);class r extends t.BaseRepository{async insertFitnessPlan(e){let t=await this.db.insertInto("fitnessPlans").values({clientId:e.clientId,description:e.description,message:e.message,structured:e.structured?JSON.stringify(e.structured):null,startDate:e.startDate}).returningAll().executeTakeFirstOrThrow();return s.FitnessPlanModel.fromDB(t)}async getFitnessPlan(e){let t=await this.db.selectFrom("fitnessPlans").selectAll().where("id","=",e).executeTakeFirst();return t?s.FitnessPlanModel.fromDB(t):null}async getCurrentPlan(e){let t=await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",e).orderBy("createdAt","desc").executeTakeFirst();return t?s.FitnessPlanModel.fromDB(t):null}async getPlanHistory(e){return(await this.db.selectFrom("fitnessPlans").selectAll().where("clientId","=",e).orderBy("createdAt","desc").execute()).map(s.FitnessPlanModel.fromDB)}async updateFitnessPlan(e,t){let r={updatedAt:new Date};void 0!==t.description&&(r.description=t.description),void 0!==t.message&&(r.message=t.message),void 0!==t.structured&&(r.structured=t.structured?JSON.stringify(t.structured):null);let i=await this.db.updateTable("fitnessPlans").set(r).where("id","=",e).returningAll().executeTakeFirst();return i?s.FitnessPlanModel.fromDB(i):null}async deleteFitnessPlan(e){return Number((await this.db.deleteFrom("fitnessPlans").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}}e.s(["FitnessPlanRepository",()=>r])},81111,(e,t,s)=>{t.exports=e.x("node:stream",()=>require("node:stream"))},233405,(e,t,s)=>{t.exports=e.x("child_process",()=>require("child_process"))},666680,(e,t,s)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},564621,e=>{e.v({name:"gaxios",version:"7.1.3",description:"A simple common HTTP client specifically for Google APIs and services.",main:"build/cjs/src/index.js",types:"build/cjs/src/index.d.ts",files:["build/"],exports:{".":{import:{types:"./build/esm/src/index.d.ts",default:"./build/esm/src/index.js"},require:{types:"./build/cjs/src/index.d.ts",default:"./build/cjs/src/index.js"}}},scripts:{lint:"gts check --no-inline-config",test:"c8 mocha build/esm/test","presystem-test":"npm run compile","system-test":"mocha build/esm/system-test --timeout 80000",compile:"tsc -b ./tsconfig.json ./tsconfig.cjs.json && node utils/enable-esm.mjs",fix:"gts fix",prepare:"npm run compile",pretest:"npm run compile",webpack:"webpack","prebrowser-test":"npm run compile","browser-test":"node build/browser-test/browser-test-runner.js",docs:"jsdoc -c .jsdoc.js","docs-test":"linkinator docs","predocs-test":"npm run docs","samples-test":"cd samples/ && npm link ../ && npm test && cd ../",prelint:"cd samples; npm link ../; npm install",clean:"gts clean"},repository:{type:"git",directory:"packages/gaxios",url:"https://github.com/googleapis/google-cloud-node-core.git"},keywords:["google"],engines:{node:">=18"},author:"Google, LLC",license:"Apache-2.0",devDependencies:{"@babel/plugin-proposal-private-methods":"^7.18.6","@types/cors":"^2.8.6","@types/express":"^5.0.0","@types/extend":"^3.0.1","@types/mocha":"^10.0.10","@types/multiparty":"4.2.1","@types/mv":"^2.1.0","@types/ncp":"^2.0.1","@types/node":"^22.0.0","@types/sinon":"^17.0.0","@types/tmp":"0.2.6",assert:"^2.0.0",browserify:"^17.0.0",c8:"^10.0.0",cors:"^2.8.5",express:"^5.0.0",gts:"^6.0.0","is-docker":"^3.0.0",jsdoc:"^4.0.0","jsdoc-fresh":"^5.0.0","jsdoc-region-tag":"^4.0.0",karma:"^6.0.0","karma-chrome-launcher":"^3.0.0","karma-coverage":"^2.0.0","karma-firefox-launcher":"^2.0.0","karma-mocha":"^2.0.0","karma-remap-coverage":"^0.1.5","karma-sourcemap-loader":"^0.4.0","karma-webpack":"^5.0.1",linkinator:"^6.1.2",mocha:"^11.1.0",multiparty:"^4.2.1",mv:"^2.1.1",ncp:"^2.0.0",nock:"^14.0.0-beta.13","null-loader":"^4.0.0","pack-n-play":"^4.0.0",puppeteer:"^24.0.0",sinon:"^21.0.0","stream-browserify":"^3.0.0",tmp:"0.2.5","ts-loader":"^9.5.2",typescript:"^5.8.3",webpack:"^5.35.0","webpack-cli":"^6.0.1"},dependencies:{extend:"^3.0.2","https-proxy-agent":"^7.0.1","node-fetch":"^3.3.2",rimraf:"^5.0.1"},homepage:"https://github.com/googleapis/google-cloud-node-core/tree/main/packages/gaxios"})},605365,(e,t,s)=>{t.exports=e.x("process",()=>require("process"))},885083,e=>{e.v({name:"google-auth-library",version:"10.5.0",author:"Google Inc.",description:"Google APIs Authentication Client Library for Node.js",engines:{node:">=18"},main:"./build/src/index.js",types:"./build/src/index.d.ts",repository:"googleapis/google-auth-library-nodejs.git",keywords:["google","api","google apis","client","client library"],dependencies:{"base64-js":"^1.3.0","ecdsa-sig-formatter":"^1.0.11",gaxios:"^7.0.0","gcp-metadata":"^8.0.0","google-logging-utils":"^1.0.0",gtoken:"^8.0.0",jws:"^4.0.0"},devDependencies:{"@types/base64-js":"^1.2.5","@types/jws":"^3.1.0","@types/mocha":"^10.0.10","@types/mv":"^2.1.0","@types/ncp":"^2.0.1","@types/node":"^22.0.0","@types/sinon":"^17.0.0","assert-rejects":"^1.0.0",c8:"^10.0.0",codecov:"^3.0.2",gts:"^6.0.0","is-docker":"^3.0.0",jsdoc:"^4.0.0","jsdoc-fresh":"^5.0.0","jsdoc-region-tag":"^4.0.0",karma:"^6.0.0","karma-chrome-launcher":"^3.0.0","karma-coverage":"^2.0.0","karma-firefox-launcher":"^2.0.0","karma-mocha":"^2.0.0","karma-sourcemap-loader":"^0.4.0","karma-webpack":"^5.0.1",keypair:"^1.0.4",mocha:"^11.1.0",mv:"^2.1.1",ncp:"^2.0.0",nock:"^14.0.5","null-loader":"^4.0.0",puppeteer:"^24.0.0",sinon:"^21.0.0","ts-loader":"^8.0.0",typescript:"5.8.2",webpack:"^5.21.2","webpack-cli":"^4.0.0"},files:["build/src","!build/src/**/*.map"],scripts:{test:"c8 mocha build/test",clean:"gts clean",prepare:"npm run compile",lint:"gts check --no-inline-config",compile:"tsc -p .",fix:"gts fix",pretest:"npm run compile -- --sourceMap",docs:"jsdoc -c .jsdoc.js","samples-setup":"cd samples/ && npm link ../ && npm run setup && cd ../","samples-test":"cd samples/ && npm link ../ && npm test && cd ../","system-test":"mocha build/system-test --timeout 60000","presystem-test":"npm run compile -- --sourceMap",webpack:"webpack","browser-test":"karma start","docs-test":"echo 'disabled until linkinator is fixed'","predocs-test":"npm run docs",prelint:"cd samples; npm link ../; npm install"},license:"Apache-2.0"})},924868,(e,t,s)=>{t.exports=e.x("fs/promises",()=>require("fs/promises"))},188646,(e,t,s)=>{t.exports=e.x("node:stream/promises",()=>require("node:stream/promises"))},76421,271964,e=>{"use strict";e.i(454188);var t=e.i(331612);let s=t.z.array(t.z.object({day:t.z.string(),focus:t.z.string().default(""),rationale:t.z.string().default("")})).describe("The ideal/default weekly rhythm"),r=t.z.object({name:t.z.string().describe("e.g. 'Strength + Lean Build Phase'"),type:t.z.string().describe("e.g. 'Powerbuilding'").default(""),coreStrategy:t.z.string().default(""),progressionStrategy:t.z.array(t.z.string()).default([]),adjustmentStrategy:t.z.string().default(""),conditioning:t.z.array(t.z.string()).default([]),scheduleTemplate:s.default([]),durationWeeks:t.z.number().default(-1),frequencyPerWeek:t.z.number().default(-1)}),i=t.z.object({description:t.z.string({description:"Structured text fitness plan containing split, frequency, deload rules, goals, and progression principles"}),message:t.z.string({description:"Brief summary of the fitness plan for SMS messages"}).nullish()});e.s(["PlanStructureSchema",0,r,"_FitnessPlanSchema",0,i],271964);class a{id;clientId;description;message;structured;startDate;createdAt;updatedAt;constructor(e,t,s,r,i,a,n,o){this.id=e,this.clientId=t,this.description=s,this.message=r,this.structured=i,this.startDate=a,this.createdAt=n,this.updatedAt=o}static fromDB(e){return{id:e.id,clientId:e.clientId,description:e.description||"",message:e.message,structured:e.structured,startDate:new Date(e.startDate),createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}}static fromFitnessPlanOverview(e,t){return{clientId:e.id,description:t.description,message:t.message||null,structured:t.structure||null,startDate:new Date}}static schema=i}e.s(["FitnessPlanModel",()=>a],76421)},52396,e=>{"use strict";var t=e.i(46308),s=e.i(705590);class r extends t.BaseRepository{generateUniqueCode(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let s=0;s<5;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}async createShortLink(e){return await this.db.insertInto("shortLinks").values({code:e.code,targetPath:e.targetPath,clientId:e.clientId,expiresAt:e.expiresAt,createdAt:new Date,accessCount:0}).onConflict(t=>t.column("code").doUpdateSet({targetPath:e.targetPath,clientId:e.clientId,expiresAt:e.expiresAt,createdAt:new Date,accessCount:0,lastAccessedAt:null})).returningAll().executeTakeFirstOrThrow()}async findByCode(e){return await this.db.selectFrom("shortLinks").selectAll().where("code","=",e).executeTakeFirst()||null}async incrementAccessCount(e){await this.db.updateTable("shortLinks").set({accessCount:s.sql`access_count + 1`,lastAccessedAt:new Date}).where("id","=",e).execute()}async deleteExpiredLinks(){return Number((await this.db.deleteFrom("shortLinks").where("expiresAt","<",new Date).where("expiresAt","is not",null).executeTakeFirst()).numDeletedRows||0)}async deleteByClientId(e){return Number((await this.db.deleteFrom("shortLinks").where("clientId","=",e).executeTakeFirst()).numDeletedRows||0)}async findByClientId(e){return await this.db.selectFrom("shortLinks").selectAll().where("clientId","=",e).orderBy("createdAt","desc").execute()}}e.s(["ShortLinkRepository",()=>r])},11385,e=>{"use strict";var t=e.i(52396),s=e.i(875559);class r{static instance;repository;DEFAULT_EXPIRY_DAYS=(0,s.getShortLinksConfig)().defaultExpiryDays;constructor(){this.repository=new t.ShortLinkRepository}static getInstance(){return r.instance||(r.instance=new r),r.instance}async createShortLink(e,t,s){let r=s?.code||this.repository.generateUniqueCode(),i=s?.expiresAt||new Date(Date.now()+24*this.DEFAULT_EXPIRY_DAYS*36e5),a=await this.repository.createShortLink({code:r,targetPath:t,clientId:e,expiresAt:i});return console.log(`[ShortLinkService] Created short link: ${r} -> ${t}`),a}async resolveShortLink(e){let t=await this.repository.findByCode(e);return t?null!==t.expiresAt&&new Date(t.expiresAt)<new Date?(console.log(`[ShortLinkService] Short link expired: ${e}`),{link:t,isExpired:!0}):(this.repository.incrementAccessCount(t.id).catch(t=>{console.error(`[ShortLinkService] Failed to increment access count for ${e}:`,t)}),console.log(`[ShortLinkService] Resolved short link: ${e} -> ${t.targetPath}`),{link:t,isExpired:!1}):(console.log(`[ShortLinkService] Short link not found: ${e}`),null)}async createWorkoutLink(e,t,s){let r=`/me?workout=${t}`;return this.createShortLink(e,r,s)}async createProfileLink(e,t){return this.createShortLink(e,"/me",t)}getFullUrl(e){let t=(0,s.getShortLinksConfig)().domain||"https://gtxt.ai";return`${t}/l/${e}`}async cleanupExpiredLinks(){try{let e=await this.repository.deleteExpiredLinks();return console.log(`[ShortLinkService] Cleaned up ${e} expired short links`),e}catch(e){return console.error("[ShortLinkService] Error cleaning up expired links:",e),0}}}let i=r.getInstance();e.s(["shortLinkService",0,i])},13423,e=>{"use strict";var t=e.i(46308),s=e.i(705590);class r extends t.BaseRepository{async create(e,t){let s={clientId:e,signupData:t?JSON.parse(JSON.stringify(t)):null,status:"pending",programMessagesSent:!1};return await this.db.insertInto("userOnboarding").values(s).returningAll().executeTakeFirstOrThrow()}async findByClientId(e){return await this.db.selectFrom("userOnboarding").selectAll().where("clientId","=",e).executeTakeFirst()??null}async updateStatus(e,t,s){return await this.db.updateTable("userOnboarding").set({status:t,errorMessage:s??null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markStarted(e){return await this.db.updateTable("userOnboarding").set({status:"in_progress",startedAt:s.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async updateCurrentStep(e,t){return await this.db.updateTable("userOnboarding").set({currentStep:t}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markCompleted(e){return await this.db.updateTable("userOnboarding").set({status:"completed",completedAt:s.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markMessagesSent(e){return await this.db.updateTable("userOnboarding").set({programMessagesSent:!0}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async hasMessagesSent(e){let t=await this.db.selectFrom("userOnboarding").select("programMessagesSent").where("clientId","=",e).executeTakeFirst();return t?.programMessagesSent??!1}async getSignupData(e){let t=await this.db.selectFrom("userOnboarding").select("signupData").where("clientId","=",e).executeTakeFirst();return t?.signupData??null}async clearSignupData(e){return await this.db.updateTable("userOnboarding").set({signupData:null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async delete(e){await this.db.deleteFrom("userOnboarding").where("clientId","=",e).execute()}}e.s(["OnboardingRepository",()=>r])},565431,39917,e=>{"use strict";var t,s=e.i(973559),r=e.i(297934),i=e.i(13423);(t={}).CLOSED="CLOSED",t.OPEN="OPEN",t.HALF_OPEN="HALF_OPEN";class a{state="CLOSED";failureCount=0;successCount=0;lastFailureTime=null;options;constructor(e={}){this.options={failureThreshold:e.failureThreshold||5,resetTimeout:e.resetTimeout||6e4,monitoringPeriod:e.monitoringPeriod||6e4}}async execute(e){if("OPEN"===this.state)if(!this.shouldAttemptReset())return console.warn("Circuit breaker is OPEN, skipping execution"),null;else this.state="HALF_OPEN";try{let t=await e();return this.onSuccess(),t}catch(e){throw this.onFailure(),e}}onSuccess(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=3&&(this.state="CLOSED",this.successCount=0,console.info("Circuit breaker is now CLOSED")))}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state?(this.state="OPEN",console.warn("Circuit breaker is now OPEN due to failure in HALF_OPEN state")):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`))}shouldAttemptReset(){return null!==this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.options.resetTimeout}getState(){return this.state}getStats(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount,lastFailureTime:this.lastFailureTime}}}e.s(["CircuitBreaker",()=>a],39917);var n=e.i(823525);class o{static instance;userRepository;onboardingRepository;circuitBreaker;constructor(){this.userRepository=new r.UserRepository,this.onboardingRepository=new i.OnboardingRepository,this.circuitBreaker=new a({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4})}static getInstance(){return o.instance||(o.instance=new o),o.instance}async createUser(e){let t=await this.circuitBreaker.execute(async()=>{if(await this.userRepository.findByPhoneNumber(e.phoneNumber))throw Error("User already exists with this phone number");let t={name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null};s.UserModel.validateUserData(t);let r=await this.userRepository.create(t);if(!r)throw Error("Failed to create user");return r});if(!t)throw Error("Failed to create user");return t}async getUserById(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findById(e))||void 0}async getUserByPhone(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findByPhoneNumber(e))||void 0}async getUser(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findWithProfile(e))}async getUsersForHour(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findUsersForHour(e))||[]}async getUsersForWeeklyMessage(e){return await this.circuitBreaker.execute(async()=>{let t=new Date;t.setUTCHours(e,0,0,0);let s=(0,n.getTimezonesAtLocalTime)(t,17,7);return await this.userRepository.findUsersByTimezones(s)})||[]}async updateUser(e,t){let r=await this.circuitBreaker.execute(async()=>(s.UserModel.validateUserUpdates(t),await this.userRepository.update(e,t)));if(!r)throw Error("Failed to update user");return r}async updatePreferences(e,t){let s=await this.circuitBreaker.execute(async()=>await this.userRepository.updatePreferences(e,t));if(!s)throw Error("Failed to update preferences");return s}async listUsersForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let{page:t=1,pageSize:s=20,sort:r={field:"createdAt",direction:"desc"},...i}=e,a={q:i.search,hasProfile:i.hasProfile,createdFrom:i.createdAfter,createdTo:i.createdBefore,page:t,pageSize:s,sort:`${r.field}:${r.direction}`},{users:n,total:o}=await this.userRepository.list(a),c=n.map(e=>this.transformToAdminUser(e));return{users:c,pagination:{page:t,limit:s,total:o,totalPages:Math.ceil(o/s)},stats:await this.calculateUserStats()}});if(!t)throw Error("Failed to fetch users");return t}async getUserForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let t=await this.userRepository.findWithProfile(e);if(!t)throw Error("User not found");let s=this.transformToAdminUser(t),r=await this.onboardingRepository.getSignupData(e);return{user:s,profile:t.profile||null,signupData:r,recentActivity:{totalMessages:0,totalWorkouts:0}}});if(!t)throw Error("Failed to fetch user");return t}async deleteUser(e){return await this.circuitBreaker.execute(async()=>!!await this.userRepository.findById(e)&&await this.userRepository.delete(e))||!1}transformToAdminUser(e){let t=!!e.profile;return{...e,hasProfile:t,profileSummary:void 0,stats:{totalWorkouts:0,isActiveToday:!1}}}async calculateUserStats(){let e=(await this.userRepository.list({pageSize:1e3})).users,t=e.length,s=e.filter(e=>e.email).length;return{totalUsers:t,withEmail:s,withProfile:e.filter(e=>e.profile).length,activeToday:0}}}let c=o.getInstance();e.s(["UserService",()=>o,"userService",0,c],565431)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6b81c762._.js.map