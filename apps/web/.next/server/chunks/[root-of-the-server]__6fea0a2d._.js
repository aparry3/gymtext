module.exports=[898990,e=>{"use strict";var t=e.i(201236),s=e.i(80643),r=e.i(172709),i=e.i(125720),a=e.i(823525),n=e.i(108436);e.i(249805);var o=e.i(884031),c=e.i(38330);class l{static instance;fitnessPlanService;messageService;dailyMessageService;workoutInstanceService;progressService;constructor(){this.fitnessPlanService=t.FitnessPlanService.getInstance(),this.progressService=n.ProgressService.getInstance(),this.messageService=s.MessageService.getInstance(),this.dailyMessageService=r.DailyMessageService.getInstance(),this.workoutInstanceService=i.WorkoutInstanceService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async createFitnessPlan(e){console.log(`[Onboarding] Creating fitness plan for ${e.id}`);try{await this.fitnessPlanService.createFitnessPlan(e),console.log(`[Onboarding] Successfully created fitness plan for ${e.id}`)}catch(t){throw console.error(`[Onboarding] Failed to create fitness plan for ${e.id}:`,t),t}}async createFirstMicrocycle(e){console.log(`[Onboarding] Creating first microcycle for ${e.id}`);try{let t=await this.fitnessPlanService.getCurrentPlan(e.id);if(!t)throw Error(`No fitness plan found for user ${e.id}`);let s=(0,a.now)(e.timezone).toJSDate(),{microcycle:r}=await this.progressService.getOrCreateMicrocycleForDate(e.id,t,s,e.timezone);if(!r)throw Error("Failed to create first microcycle");console.log(`[Onboarding] Successfully created first microcycle for ${e.id}`)}catch(t){throw console.error(`[Onboarding] Failed to create first microcycle for ${e.id}:`,t),t}}async createFirstWorkout(e){console.log(`[Onboarding] Creating first workout for ${e.id}`);try{let t=(0,a.now)(e.timezone).startOf("day");if(!await this.workoutInstanceService.generateWorkoutForDate(e,t))throw Error("Failed to create first workout");console.log(`[Onboarding] Successfully created first workout for ${e.id}`)}catch(t){throw console.error(`[Onboarding] Failed to create first workout for ${e.id}:`,t),t}}async sendOnboardingMessages(e){console.log(`[Onboarding] Sending onboarding messages to ${e.id}`);try{let t=await this.prepareCombinedPlanMicrocycleMessage(e),s=await this.prepareWorkoutMessage(e);await c.messageQueueService.enqueueMessages(e.id,[{content:t},{content:s}],"onboarding"),console.log(`[Onboarding] Successfully queued onboarding messages for ${e.id}`)}catch(t){throw console.error(`[Onboarding] Failed to send onboarding messages to ${e.id}:`,t),t}}async prepareCombinedPlanMicrocycleMessage(e){let t=await this.fitnessPlanService.getCurrentPlan(e.id);if(!t)throw Error(`No fitness plan found for user ${e.id}`);if(!t.message)throw Error(`No plan message found for user ${e.id}`);let s=(0,a.now)(e.timezone).toJSDate(),{microcycle:r}=await this.progressService.getOrCreateMicrocycleForDate(e.id,t,s,e.timezone);if(!r)throw Error(`No microcycle found for user ${e.id}`);if(!r.message)throw Error(`No microcycle message found for user ${e.id}`);let i=(0,a.getDayOfWeek)(void 0,e.timezone),n=await o.messagingAgentService.generatePlanMicrocycleCombinedMessage(t.message,r.message,i);return console.log(`[Onboarding] Prepared combined plan+microcycle message for ${e.id}`),n}async prepareWorkoutMessage(e){let t=(0,a.startOfDay)((0,a.now)(e.timezone).toJSDate(),e.timezone),s=await this.dailyMessageService.getTodaysWorkout(e.id,t);if(!s)throw Error(`No workout found for user ${e.id} on ${t.toISOString()}`);if(!s.message)throw Error(`No workout message found for ${s.id}`);return console.log(`[Onboarding] Prepared workout message for ${e.id}`),s.message}}l.getInstance(),e.s(["OnboardingService",()=>l])},23250,e=>{"use strict";var t=e.i(13423);class s{static instance;repository;constructor(){this.repository=new t.OnboardingRepository}static getInstance(){return s.instance||(s.instance=new s),s.instance}async createOnboardingRecord(e,t){return console.log(`[OnboardingDataService] Creating onboarding record for user ${e}`),await this.repository.create(e,t)}async markStarted(e){return console.log(`[OnboardingDataService] Marking onboarding started for user ${e}`),await this.repository.markStarted(e)}async updateCurrentStep(e,t){return console.log(`[OnboardingDataService] Updating step to ${t} for user ${e}`),await this.repository.updateCurrentStep(e,t)}async markCompleted(e){return console.log(`[OnboardingDataService] Marking onboarding completed for user ${e}`),await this.repository.markCompleted(e)}async updateStatus(e,t,s){return console.log(`[OnboardingDataService] Updating status to '${t}' for user ${e}`),await this.repository.updateStatus(e,t,s)}async getStatus(e){let t=await this.repository.findByClientId(e);return t?t.status:null}async findByClientId(e){return await this.repository.findByClientId(e)}async getSignupData(e){return await this.repository.getSignupData(e)}async clearSignupData(e){return console.log(`[OnboardingDataService] Clearing signup data for user ${e}`),await this.repository.clearSignupData(e)}async markMessagesSent(e){return console.log(`[OnboardingDataService] Marking messages sent for user ${e}`),await this.repository.markMessagesSent(e)}async hasMessagesSent(e){return await this.repository.hasMessagesSent(e)}async delete(e){return console.log(`[OnboardingDataService] Deleting onboarding record for user ${e}`),await this.repository.delete(e)}}let r=s.getInstance();e.s(["onboardingDataService",0,r])},961691,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){let t={clientId:e.clientId,stripeSubscriptionId:e.stripeSubscriptionId,status:e.status,planType:e.planType,currentPeriodStart:e.currentPeriodStart,currentPeriodEnd:e.currentPeriodEnd};return await this.db.insertInto("subscriptions").values(t).returningAll().executeTakeFirstOrThrow()}async updateByStripeId(e,t){return await this.db.updateTable("subscriptions").set(t).where("stripeSubscriptionId","=",e).returningAll().executeTakeFirstOrThrow()}async findByClientId(e){return await this.db.selectFrom("subscriptions").selectAll().where("clientId","=",e).orderBy("createdAt","desc").execute()}async findByStripeId(e){return await this.db.selectFrom("subscriptions").selectAll().where("stripeSubscriptionId","=",e).executeTakeFirst()??null}async getActiveSubscription(e){return await this.db.selectFrom("subscriptions").selectAll().where("clientId","=",e).where("status","=","active").orderBy("createdAt","desc").executeTakeFirst()??null}async hasActiveSubscription(e){return null!==await this.getActiveSubscription(e)}async cancel(e,t){return await this.db.updateTable("subscriptions").set({status:"canceled",canceledAt:t}).where("stripeSubscriptionId","=",e).returningAll().executeTakeFirstOrThrow()}async scheduleCancellation(e){return await this.db.updateTable("subscriptions").set({status:"cancel_pending"}).where("stripeSubscriptionId","=",e).returningAll().executeTakeFirstOrThrow()}async reactivate(e){return await this.db.updateTable("subscriptions").set({status:"active"}).where("stripeSubscriptionId","=",e).returningAll().executeTakeFirstOrThrow()}async findActiveForMessaging(e){return await this.db.selectFrom("subscriptions").selectAll().where("clientId","=",e).where("status","=","active").orderBy("createdAt","desc").executeTakeFirst()??null}}e.s(["SubscriptionRepository",()=>s])},968387,32721,363690,e=>{"use strict";var t=e.i(681247);let s=new class{provider="twilio";async sendMessage(e,s,r){try{let i=await t.twilioClient.sendSMS(e.phoneNumber,s,r);return{messageId:i.sid,status:this.mapTwilioStatus(i.status),provider:this.provider,to:i.to,from:i.from,timestamp:i.dateCreated,metadata:{twilioSid:i.sid,twilioStatus:i.status,errorCode:i.errorCode,errorMessage:i.errorMessage,mediaUrls:r}}}catch(e){throw console.error("TwilioMessagingClient: Failed to send message",e),e}}mapTwilioStatus(e){switch(e){case"sent":case"delivered":return"delivered";case"queued":case"accepted":case"sending":return"queued";case"failed":case"undelivered":return"failed";default:return"sent"}}};var r=e.i(427699);let i=new class{provider="local";eventEmitter;messageCounter=0;constructor(){this.eventEmitter=new r.EventEmitter,this.eventEmitter.setMaxListeners(100)}async sendMessage(e,t,s){let r=`local-${Date.now()}-${++this.messageCounter}`,i=new Date,a=e.phoneNumber;return this.eventEmitter.emit("message",{messageId:r,to:a,from:"local-system",content:t||"[MMS only - no text]",timestamp:i}),console.log("[LocalMessagingClient] Message sent (not actual SMS):",{messageId:r,to:a,userId:e.id,preview:t?t.substring(0,50):"[MMS only]",mediaUrls:s}),{messageId:r,status:"sent",provider:this.provider,to:a,from:"local-system",timestamp:i,metadata:{userId:e.id,phoneNumber:a,contentLength:t?.length||0,mediaUrls:s}}}onMessage(e){this.eventEmitter.on("message",e)}offMessage(e){this.eventEmitter.off("message",e)}getListenerCount(){return this.eventEmitter.listenerCount("message")}};e.s(["localMessagingClient",0,i],32721);var a=e.i(875559);let n=function(){let{provider:e}=(0,a.getMessagingConfig)();return"local"===e?(console.log("[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)"),i):s}();e.s(["messagingClient",0,n],363690),e.s([],968387)},501261,e=>{"use strict";var t=e.i(46308);class s extends t.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,t=50,s=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).offset(s).execute()}async findRecentByClientId(e,t=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).reverse()}async countByClientId(e){let t=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(t?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,t,s){return await this.db.updateTable("messages").set({deliveryStatus:t,deliveryError:s||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let t=await this.findById(e);if(!t)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(t.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,t){return await this.db.updateTable("messages").set({providerMessageId:t}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(t=>t.or([t("messages.phoneFrom","ilike",`%${e.search}%`),t("messages.phoneTo","ilike",`%${e.search}%`),t("users.name","ilike",`%${e.search}%`),t("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await s.executeTakeFirst(),i=Number(r?.count??0);return{messages:await t.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:i}}async getStats(e){let t=this.db.selectFrom("messages");e&&(t=t.where("clientId","=",e));let[s,r,i,a,n]=await Promise.all([t.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),t.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(s?.count??0),inbound:Number(r?.count??0),outbound:Number(i?.count??0),pending:Number(a?.count??0),failed:Number(n?.count??0)}}}e.s(["MessageRepository",()=>s])},37702,(e,t,s)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},812057,(e,t,s)=>{t.exports=e.x("node:util",()=>require("node:util"))},363890,(e,t,s)=>{t.exports=e.x("stream/web",()=>require("stream/web"))},60438,(e,t,s)=>{t.exports=e.x("perf_hooks",()=>require("perf_hooks"))},178249,(e,t,s)=>{t.exports=e.x("util/types",()=>require("util/types"))},687769,(e,t,s)=>{t.exports=e.x("node:events",()=>require("node:events"))},154993,(e,t,s)=>{t.exports=e.x("diagnostics_channel",()=>require("diagnostics_channel"))},925328,(e,t,s)=>{t.exports=e.x("http2",()=>require("http2"))},99348,(e,t,s)=>{t.exports=e.x("string_decoder",()=>require("string_decoder"))},410430,(e,t,s)=>{t.exports=e.x("async_hooks",()=>require("async_hooks"))},611913,(e,t,s)=>{t.exports=e.x("console",()=>require("console"))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6fea0a2d._.js.map