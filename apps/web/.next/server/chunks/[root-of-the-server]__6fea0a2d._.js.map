{"version":3,"sources":["../../../../../packages/shared/src/server/services/orchestration/onboardingService.ts","../../../../../packages/shared/src/server/services/user/onboardingDataService.ts","../../../../../packages/shared/src/server/repositories/subscriptionRepository.ts","../../../../../packages/shared/src/server/connections/messaging/twilioClient.ts","../../../../../packages/shared/src/server/connections/messaging/localClient.ts","../../../../../packages/shared/src/server/connections/messaging/factory.ts","../../../../../packages/shared/src/server/repositories/messageRepository.ts"],"sourcesContent":["import { UserWithProfile } from '../../models/user';\nimport { FitnessPlanService } from '../training/fitnessPlanService';\nimport { MessageService } from '../messaging/messageService';\nimport { DailyMessageService } from './dailyMessageService';\nimport { WorkoutInstanceService } from '../training/workoutInstanceService';\nimport { now, startOfDay, getDayOfWeek } from '@/shared/utils/date';\nimport { ProgressService } from '../training/progressService';\nimport { messagingAgentService } from '@/server/services/agents/messaging';\nimport { messageQueueService, type QueuedMessage } from '../messaging/messageQueueService';\n\n/**\n * OnboardingService\n *\n * Orchestrates the complete user onboarding flow:\n * 1. Send welcome message\n * 2. Create fitness plan\n * 3. Send plan summary\n * 4. Send first daily workout\n *\n * Uses ConversationFlowBuilder to maintain natural conversation flow\n * and avoid repetitive greetings.\n *\n * Responsibilities:\n * - Coordinate multiple services for onboarding\n * - Handle onboarding flow logic\n * - Ensure proper sequencing of onboarding steps\n * - Maintain conversation context across messages\n */\nexport class OnboardingService {\n  private static instance: OnboardingService;\n  private fitnessPlanService: FitnessPlanService;\n  private messageService: MessageService;\n  private dailyMessageService: DailyMessageService;\n  private workoutInstanceService: WorkoutInstanceService;\n  private progressService: ProgressService;\n\n  private constructor() {\n    this.fitnessPlanService = FitnessPlanService.getInstance();\n    this.progressService = ProgressService.getInstance();\n    this.messageService = MessageService.getInstance();\n    this.dailyMessageService = DailyMessageService.getInstance();\n    this.workoutInstanceService = WorkoutInstanceService.getInstance();\n  }\n\n  public static getInstance(): OnboardingService {\n    if (!OnboardingService.instance) {\n      OnboardingService.instance = new OnboardingService();\n    }\n    return OnboardingService.instance;\n  }\n\n  /**\n   * Create fitness plan with pre-generated message\n   * Step 1 of onboarding entity creation\n   *\n   * @param user - The user to create plan for\n   * @throws Error if creation fails\n   */\n  public async createFitnessPlan(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating fitness plan for ${user.id}`);\n\n    try {\n      await this.fitnessPlanService.createFitnessPlan(user);\n      console.log(`[Onboarding] Successfully created fitness plan for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create fitness plan for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create first microcycle with pre-generated message\n   * Step 2 of onboarding entity creation\n   * Requires fitness plan to exist\n   *\n   * @param user - The user to create microcycle for\n   * @throws Error if creation fails\n   */\n  public async createFirstMicrocycle(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating first microcycle for ${user.id}`);\n\n    try {\n      const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n      if (!plan) {\n        throw new Error(`No fitness plan found for user ${user.id}`);\n      }\n\n      // Create first microcycle using date-based approach (for current week)\n      const currentDate = now(user.timezone).toJSDate();\n      const { microcycle } = await this.progressService.getOrCreateMicrocycleForDate(user.id, plan, currentDate, user.timezone);\n      if (!microcycle) {\n        throw new Error('Failed to create first microcycle');\n      }\n\n      console.log(`[Onboarding] Successfully created first microcycle for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create first microcycle for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create first workout with pre-generated message\n   * Step 3 of onboarding entity creation\n   * Requires fitness plan and microcycle to exist\n   *\n   * @param user - The user to create workout for\n   * @throws Error if creation fails\n   */\n  public async createFirstWorkout(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Creating first workout for ${user.id}`);\n\n    try {\n      const targetDate = now(user.timezone).startOf('day');\n      const workout = await this.workoutInstanceService.generateWorkoutForDate(user, targetDate);\n\n      if (!workout) {\n        throw new Error('Failed to create first workout');\n      }\n\n      console.log(`[Onboarding] Successfully created first workout for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to create first workout for ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Send onboarding messages (combined plan+week + workout)\n   * Called after both onboarding and payment are complete\n   *\n   * Sends two messages in order using queue system:\n   * 1. Combined plan summary + first week breakdown\n   * 2. First workout message\n   *\n   * @param user - The user to send messages to\n   * @throws Error if any step fails\n   */\n  public async sendOnboardingMessages(user: UserWithProfile): Promise<void> {\n    console.log(`[Onboarding] Sending onboarding messages to ${user.id}`);\n\n    try {\n      // Prepare both messages\n      const planMicrocycleMessage = await this.prepareCombinedPlanMicrocycleMessage(user);\n      const workoutMessage = await this.prepareWorkoutMessage(user);\n\n      // Enqueue both messages for ordered delivery\n      const messages: QueuedMessage[] = [\n        { content: planMicrocycleMessage },\n        { content: workoutMessage }\n      ];\n\n      await messageQueueService.enqueueMessages(\n        user.id,\n        messages,\n        'onboarding'\n      );\n\n      console.log(`[Onboarding] Successfully queued onboarding messages for ${user.id}`);\n    } catch (error) {\n      console.error(`[Onboarding] Failed to send onboarding messages to ${user.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Prepare combined plan + first week message\n   * Combines pre-generated plan and microcycle messages into a single onboarding message\n   */\n  private async prepareCombinedPlanMicrocycleMessage(user: UserWithProfile): Promise<string> {\n    const plan = await this.fitnessPlanService.getCurrentPlan(user.id);\n    if (!plan) {\n      throw new Error(`No fitness plan found for user ${user.id}`);\n    }\n\n    if (!plan.message) {\n      throw new Error(`No plan message found for user ${user.id}`);\n    }\n\n    // Get current microcycle using date-based approach\n    const currentDate = now(user.timezone).toJSDate();\n    const { microcycle } = await this.progressService.getOrCreateMicrocycleForDate(user.id, plan, currentDate, user.timezone);\n    if (!microcycle) {\n      throw new Error(`No microcycle found for user ${user.id}`);\n    }\n\n    if (!microcycle.message) {\n      throw new Error(`No microcycle message found for user ${user.id}`);\n    }\n\n    // Get current weekday for the user's timezone\n    const currentWeekday = getDayOfWeek(undefined, user.timezone);\n\n    // Generate combined message using messaging agent service\n    const message = await messagingAgentService.generatePlanMicrocycleCombinedMessage(\n      plan.message,\n      microcycle.message,\n      currentWeekday\n    );\n\n    console.log(`[Onboarding] Prepared combined plan+microcycle message for ${user.id}`);\n    return message;\n  }\n\n  /**\n   * Prepare workout message\n   */\n  private async prepareWorkoutMessage(user: UserWithProfile): Promise<string> {\n    const targetDate = startOfDay(now(user.timezone).toJSDate(), user.timezone);\n    const workout = await this.dailyMessageService.getTodaysWorkout(user.id, targetDate);\n\n    if (!workout) {\n      throw new Error(`No workout found for user ${user.id} on ${targetDate.toISOString()}`);\n    }\n\n    if (!workout.message) {\n      throw new Error(`No workout message found for ${workout.id}`);\n    }\n\n    console.log(`[Onboarding] Prepared workout message for ${user.id}`);\n    return workout.message;\n  }\n}\n\n// Export singleton instance\nexport const onboardingService = OnboardingService.getInstance();\n","import { OnboardingRepository, type OnboardingRecord, type SignupData, type OnboardingStatus } from '@/server/repositories/onboardingRepository';\n\n/**\n * OnboardingDataService\n *\n * Service layer for managing user onboarding state and signup data.\n * Wraps OnboardingRepository to provide clean service-level interface.\n *\n * Responsibilities:\n * - Manage onboarding lifecycle (pending → in_progress → completed/failed)\n * - Store and retrieve signup form data\n * - Track message sending status (idempotency)\n * - Coordinate cleanup after completion\n *\n * Architecture:\n * Routes/Inngest → OnboardingDataService → OnboardingRepository → Database\n */\nexport class OnboardingDataService {\n  private static instance: OnboardingDataService;\n  private repository: OnboardingRepository;\n\n  private constructor() {\n    this.repository = new OnboardingRepository();\n  }\n\n  public static getInstance(): OnboardingDataService {\n    if (!OnboardingDataService.instance) {\n      OnboardingDataService.instance = new OnboardingDataService();\n    }\n    return OnboardingDataService.instance;\n  }\n\n  /**\n   * Create a new onboarding record for a user\n   * Called during signup to initialize onboarding tracking\n   */\n  async createOnboardingRecord(userId: string, signupData?: SignupData): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Creating onboarding record for user ${userId}`);\n    return await this.repository.create(userId, signupData);\n  }\n\n  /**\n   * Mark onboarding as started (status: pending → in_progress)\n   */\n  async markStarted(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking onboarding started for user ${userId}`);\n    return await this.repository.markStarted(userId);\n  }\n\n  /**\n   * Update current step for progress tracking\n   */\n  async updateCurrentStep(userId: string, stepNumber: number): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Updating step to ${stepNumber} for user ${userId}`);\n    return await this.repository.updateCurrentStep(userId, stepNumber);\n  }\n\n  /**\n   * Mark onboarding as completed (status: in_progress → completed)\n   */\n  async markCompleted(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking onboarding completed for user ${userId}`);\n    return await this.repository.markCompleted(userId);\n  }\n\n  /**\n   * Update onboarding status with optional error message\n   * Used for marking as failed or updating status manually\n   */\n  async updateStatus(userId: string, status: OnboardingStatus, errorMessage?: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Updating status to '${status}' for user ${userId}`);\n    return await this.repository.updateStatus(userId, status, errorMessage);\n  }\n\n  /**\n   * Get onboarding status for a client\n   */\n  async getStatus(clientId: string): Promise<OnboardingStatus | null> {\n    const record = await this.repository.findByClientId(clientId);\n    return record ? (record.status as OnboardingStatus) : null;\n  }\n\n  /**\n   * Get complete onboarding record by client ID\n   */\n  async findByClientId(clientId: string): Promise<OnboardingRecord | null> {\n    return await this.repository.findByClientId(clientId);\n  }\n\n  /**\n   * Get signup data for a user\n   * Used during async onboarding to retrieve form data\n   */\n  async getSignupData(userId: string): Promise<SignupData | null> {\n    return await this.repository.getSignupData(userId);\n  }\n\n  /**\n   * Clear signup data after profile extraction\n   * Cleanup to remove temporary form data\n   */\n  async clearSignupData(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Clearing signup data for user ${userId}`);\n    return await this.repository.clearSignupData(userId);\n  }\n\n  /**\n   * Mark final program messages as sent\n   * Used for idempotency - ensures messages only sent once\n   */\n  async markMessagesSent(userId: string): Promise<OnboardingRecord> {\n    console.log(`[OnboardingDataService] Marking messages sent for user ${userId}`);\n    return await this.repository.markMessagesSent(userId);\n  }\n\n  /**\n   * Check if final messages have been sent\n   * Used to prevent duplicate message sending\n   */\n  async hasMessagesSent(userId: string): Promise<boolean> {\n    return await this.repository.hasMessagesSent(userId);\n  }\n\n  /**\n   * Delete onboarding record (full cleanup)\n   * Optional: can be used to clean up old records\n   */\n  async delete(userId: string): Promise<void> {\n    console.log(`[OnboardingDataService] Deleting onboarding record for user ${userId}`);\n    return await this.repository.delete(userId);\n  }\n}\n\n// Export singleton instance\nexport const onboardingDataService = OnboardingDataService.getInstance();\n","import { BaseRepository } from './baseRepository';\nimport type { Subscriptions } from '../models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type Subscription = Selectable<Subscriptions>;\nexport type NewSubscription = Insertable<Subscriptions>;\nexport type SubscriptionUpdate = Updateable<Subscriptions>;\n\nexport interface CreateSubscriptionData {\n  clientId: string;\n  stripeSubscriptionId: string;\n  status: string;\n  planType: string;\n  currentPeriodStart: Date;\n  currentPeriodEnd: Date;\n}\n\n/**\n * SubscriptionRepository\n *\n * Manages Stripe subscription records\n */\nexport class SubscriptionRepository extends BaseRepository {\n  /**\n   * Create a new subscription\n   */\n  async create(data: CreateSubscriptionData): Promise<Subscription> {\n    const subscription: NewSubscription = {\n      clientId: data.clientId,\n      stripeSubscriptionId: data.stripeSubscriptionId,\n      status: data.status,\n      planType: data.planType,\n      currentPeriodStart: data.currentPeriodStart,\n      currentPeriodEnd: data.currentPeriodEnd,\n    };\n\n    return await this.db\n      .insertInto('subscriptions')\n      .values(subscription)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Update subscription by Stripe subscription ID\n   */\n  async updateByStripeId(\n    stripeSubscriptionId: string,\n    data: SubscriptionUpdate\n  ): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set(data)\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find subscription by client ID\n   */\n  async findByClientId(clientId: string): Promise<Subscription[]> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .execute();\n  }\n\n  /**\n   * Find subscription by Stripe subscription ID\n   */\n  async findByStripeId(stripeSubscriptionId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Get active subscription for client\n   */\n  async getActiveSubscription(clientId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('status', '=', 'active')\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Check if client has active subscription\n   */\n  async hasActiveSubscription(clientId: string): Promise<boolean> {\n    const subscription = await this.getActiveSubscription(clientId);\n    return subscription !== null;\n  }\n\n  /**\n   * Cancel subscription\n   */\n  async cancel(stripeSubscriptionId: string, canceledAt: Date): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({\n        status: 'canceled',\n        canceledAt,\n      })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Schedule subscription for cancellation at period end\n   * Sets status to 'cancel_pending' - messages will stop immediately\n   */\n  async scheduleCancellation(stripeSubscriptionId: string): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({ status: 'cancel_pending' })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Reactivate subscription (clear pending cancellation)\n   * Sets status back to 'active'\n   */\n  async reactivate(stripeSubscriptionId: string): Promise<Subscription> {\n    return await this.db\n      .updateTable('subscriptions')\n      .set({ status: 'active' })\n      .where('stripeSubscriptionId', '=', stripeSubscriptionId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find active subscription eligible for messaging\n   * Only returns subscriptions with status 'active' (excludes 'cancel_pending')\n   */\n  async findActiveForMessaging(clientId: string): Promise<Subscription | null> {\n    return await this.db\n      .selectFrom('subscriptions')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .where('status', '=', 'active')\n      .orderBy('createdAt', 'desc')\n      .executeTakeFirst() ?? null;\n  }\n}\n","/**\n * Twilio Messaging Client\n *\n * Implements IMessagingClient for Twilio SMS delivery.\n * Wraps the Twilio API and provides a standardized messaging interface.\n */\n\nimport { twilioClient as twilioSdk } from '../twilio/twilio';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport class TwilioMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'twilio';\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    try {\n      const twilioResponse = await twilioSdk.sendSMS(user.phoneNumber, message, mediaUrls);\n\n      return {\n        messageId: twilioResponse.sid,\n        status: this.mapTwilioStatus(twilioResponse.status),\n        provider: this.provider,\n        to: twilioResponse.to,\n        from: twilioResponse.from,\n        timestamp: twilioResponse.dateCreated,\n        metadata: {\n          twilioSid: twilioResponse.sid,\n          twilioStatus: twilioResponse.status,\n          errorCode: twilioResponse.errorCode,\n          errorMessage: twilioResponse.errorMessage,\n          mediaUrls,\n        },\n      };\n    } catch (error) {\n      console.error('TwilioMessagingClient: Failed to send message', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Maps Twilio status to standardized message status\n   */\n  private mapTwilioStatus(\n    twilioStatus: string\n  ): MessageResult['status'] {\n    switch (twilioStatus) {\n      case 'sent':\n      case 'delivered':\n        return 'delivered';\n      case 'queued':\n      case 'accepted':\n      case 'sending':\n        return 'queued';\n      case 'failed':\n      case 'undelivered':\n        return 'failed';\n      default:\n        return 'sent';\n    }\n  }\n}\n\n// Export singleton instance\nexport const twilioMessagingClient = new TwilioMessagingClient();\n","/**\n * Local Messaging Client\n *\n * Implements IMessagingClient for local development and testing.\n * Uses EventEmitter to broadcast messages to connected SSE clients.\n * Does not actually send SMS - instead emits events for local consumption.\n */\n\nimport { EventEmitter } from 'events';\nimport type { IMessagingClient, MessageResult, MessagingProvider } from './types';\nimport type { UserWithProfile } from '@/server/models/user';\n\nexport interface LocalMessage {\n  messageId: string;\n  to: string;\n  from: string;\n  content: string;\n  timestamp: Date;\n}\n\nexport class LocalMessagingClient implements IMessagingClient {\n  public readonly provider: MessagingProvider = 'local';\n  private eventEmitter: EventEmitter;\n  private messageCounter = 0;\n\n  constructor() {\n    this.eventEmitter = new EventEmitter();\n    // Increase max listeners for SSE connections\n    this.eventEmitter.setMaxListeners(100);\n  }\n\n  async sendMessage(user: UserWithProfile, message?: string, mediaUrls?: string[]): Promise<MessageResult> {\n    const messageId = `local-${Date.now()}-${++this.messageCounter}`;\n    const timestamp = new Date();\n    const to = user.phoneNumber;\n\n    const localMessage: LocalMessage = {\n      messageId,\n      to,\n      from: 'local-system',\n      content: message || '[MMS only - no text]',\n      timestamp,\n    };\n\n    // Emit the message event for SSE listeners\n    this.eventEmitter.emit('message', localMessage);\n\n    console.log(`[LocalMessagingClient] Message sent (not actual SMS):`, {\n      messageId,\n      to,\n      userId: user.id,\n      preview: message ? message.substring(0, 50) : '[MMS only]',\n      mediaUrls,\n    });\n\n    return {\n      messageId,\n      status: 'sent',\n      provider: this.provider,\n      to,\n      from: 'local-system',\n      timestamp,\n      metadata: {\n        userId: user.id,\n        phoneNumber: to,\n        contentLength: message?.length || 0,\n        mediaUrls,\n      },\n    };\n  }\n\n  /**\n   * Subscribe to message events (for SSE connections)\n   */\n  onMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.on('message', listener);\n  }\n\n  /**\n   * Unsubscribe from message events\n   */\n  offMessage(listener: (message: LocalMessage) => void): void {\n    this.eventEmitter.off('message', listener);\n  }\n\n  /**\n   * Get current number of active listeners\n   */\n  getListenerCount(): number {\n    return this.eventEmitter.listenerCount('message');\n  }\n}\n\n// Export singleton instance\nexport const localMessagingClient = new LocalMessagingClient();\n","/**\n * Messaging Client Factory\n *\n * Provides a centralized way to get the appropriate messaging client\n * based on environment configuration.\n */\n\nimport type { IMessagingClient, MessagingProvider } from './types';\nimport { twilioMessagingClient } from './twilioClient';\nimport { localMessagingClient } from './localClient';\nimport { getMessagingConfig } from '@/shared/config';\n\n/**\n * Get the messaging client based on environment configuration\n * Defaults to Twilio in production, can be overridden with MESSAGING_PROVIDER env var\n */\nexport function getMessagingClient(): IMessagingClient {\n  const { provider } = getMessagingConfig();\n\n  switch (provider) {\n    case 'local':\n      console.log('[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)');\n      return localMessagingClient;\n    case 'twilio':\n    default:\n      return twilioMessagingClient;\n  }\n}\n\n/**\n * Get a specific messaging client by provider name\n * Useful for testing or when you need direct access to a specific provider\n */\nexport function getMessagingClientByProvider(provider: MessagingProvider): IMessagingClient {\n  switch (provider) {\n    case 'local':\n      return localMessagingClient;\n    case 'twilio':\n      return twilioMessagingClient;\n    default:\n      throw new Error(`Unknown messaging provider: ${provider}`);\n  }\n}\n\n// Export the default client as a singleton\nexport const messagingClient = getMessagingClient();\n","import { BaseRepository } from '@/server/repositories/baseRepository';\nimport type { \n  Message, \n  NewMessage, \n} from '@/server/models/message';\n\nexport class MessageRepository extends BaseRepository {\n  async create(message: NewMessage): Promise<Message> {\n    return await this.db\n      .insertInto('messages')\n      .values(message)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async findById(id: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('id', '=', id)\n      .executeTakeFirst();\n  }\n\n  async findByClientId(clientId: string, limit: number = 50, offset: number = 0): Promise<Message[]> {\n    // Return messages in DESC order (latest first) with pagination support\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .offset(offset)\n      .execute();\n  }\n\n  /**\n   * Find recent messages for a client, ordered oldest to newest\n   * This is the primary method for getting message history\n   */\n  async findRecentByClientId(clientId: string, limit: number = 10): Promise<Message[]> {\n    const messages = await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .orderBy('createdAt', 'desc')\n      .limit(limit)\n      .execute();\n\n    // Reverse to get oldest-to-newest order (for chat context)\n    return messages.reverse();\n  }\n\n  async countByClientId(clientId: string): Promise<number> {\n    const result = await this.db\n      .selectFrom('messages')\n      .select(({ fn }) => fn.count('id').as('count'))\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return Number(result?.count ?? 0);\n  }\n\n  async findByProviderMessageId(providerMessageId: string): Promise<Message | undefined> {\n    return await this.db\n      .selectFrom('messages')\n      .selectAll()\n      .where('providerMessageId', '=', providerMessageId)\n      .executeTakeFirst();\n  }\n\n  async updateDeliveryStatus(\n    messageId: string,\n    status: 'queued' | 'sent' | 'delivered' | 'failed' | 'undelivered',\n    error?: string\n  ): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryStatus: status,\n        deliveryError: error || null,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async incrementDeliveryAttempts(messageId: string): Promise<Message> {\n    const message = await this.findById(messageId);\n    if (!message) {\n      throw new Error(`Message ${messageId} not found`);\n    }\n\n    return await this.db\n      .updateTable('messages')\n      .set({\n        deliveryAttempts: (message.deliveryAttempts || 1) + 1,\n        lastDeliveryAttemptAt: new Date(),\n      })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  async updateProviderMessageId(messageId: string, providerMessageId: string): Promise<Message> {\n    return await this.db\n      .updateTable('messages')\n      .set({ providerMessageId })\n      .where('id', '=', messageId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find all messages with user info for admin view\n   * Supports filtering by direction, status, and search\n   */\n  async findAllWithUserInfo(params: {\n    limit?: number;\n    offset?: number;\n    direction?: 'inbound' | 'outbound';\n    status?: string;\n    search?: string;\n    clientId?: string;\n  }): Promise<{\n    messages: (Message & { userName: string | null; userPhone: string })[];\n    total: number;\n  }> {\n    let query = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select([\n        'messages.id',\n        'messages.clientId',\n        'messages.conversationId',\n        'messages.direction',\n        'messages.content',\n        'messages.phoneFrom',\n        'messages.phoneTo',\n        'messages.provider',\n        'messages.providerMessageId',\n        'messages.deliveryStatus',\n        'messages.deliveryAttempts',\n        'messages.lastDeliveryAttemptAt',\n        'messages.deliveryError',\n        'messages.metadata',\n        'messages.createdAt',\n        'users.name as userName',\n        'users.phoneNumber as userPhone',\n      ]);\n\n    // Apply filters\n    if (params.clientId) {\n      query = query.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      query = query.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      query = query.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      query = query.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    // Get total count with same filters\n    let countQuery = this.db\n      .selectFrom('messages')\n      .innerJoin('users', 'users.id', 'messages.clientId')\n      .select(({ fn }) => fn.count('messages.id').as('count'));\n\n    if (params.clientId) {\n      countQuery = countQuery.where('messages.clientId', '=', params.clientId);\n    }\n    if (params.direction) {\n      countQuery = countQuery.where('messages.direction', '=', params.direction);\n    }\n    if (params.status) {\n      countQuery = countQuery.where('messages.deliveryStatus', '=', params.status);\n    }\n    if (params.search) {\n      countQuery = countQuery.where((eb) =>\n        eb.or([\n          eb('messages.phoneFrom', 'ilike', `%${params.search}%`),\n          eb('messages.phoneTo', 'ilike', `%${params.search}%`),\n          eb('users.name', 'ilike', `%${params.search}%`),\n          eb('users.phoneNumber', 'ilike', `%${params.search}%`),\n        ])\n      );\n    }\n\n    const countResult = await countQuery.executeTakeFirst();\n    const total = Number(countResult?.count ?? 0);\n\n    // Get paginated results\n    const messages = await query\n      .orderBy('messages.createdAt', 'desc')\n      .limit(params.limit || 50)\n      .offset(params.offset || 0)\n      .execute();\n\n    return {\n      messages: messages as (Message & { userName: string | null; userPhone: string })[],\n      total,\n    };\n  }\n\n  /**\n   * Get message statistics for admin view\n   */\n  async getStats(clientId?: string): Promise<{\n    totalMessages: number;\n    inbound: number;\n    outbound: number;\n    pending: number;\n    failed: number;\n  }> {\n    let baseQuery = this.db.selectFrom('messages');\n\n    if (clientId) {\n      baseQuery = baseQuery.where('clientId', '=', clientId);\n    }\n\n    const [total, inbound, outbound, pending, failed] = await Promise.all([\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'inbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('direction', '=', 'outbound')\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['queued', 'sent'])\n        .executeTakeFirst(),\n      baseQuery\n        .select(({ fn }) => fn.count('id').as('count'))\n        .where('deliveryStatus', 'in', ['failed', 'undelivered'])\n        .executeTakeFirst(),\n    ]);\n\n    return {\n      totalMessages: Number(total?.count ?? 0),\n      inbound: Number(inbound?.count ?? 0),\n      outbound: Number(outbound?.count ?? 0),\n      pending: Number(pending?.count ?? 0),\n      failed: Number(failed?.count ?? 0),\n    };\n  }\n}"],"names":[],"mappings":"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"}