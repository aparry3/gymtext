module.exports=[166194,e=>{"use strict";var r=e.i(46308),s=e.i(705590);class t extends r.BaseRepository{async create(e,r){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:r,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,r){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:r,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let r=await this.db.selectFrom("referrals").select(s.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(r?.count||0)}async countByReferrer(e){let r=await this.db.selectFrom("referrals").select(s.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(r?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>t])},733897,e=>{"use strict";var r=e.i(46308);class s extends r.BaseRepository{async createAuthCode(e,r,s){await this.db.insertInto("userAuthCodes").values({phoneNumber:e,code:r,expiresAt:s,createdAt:new Date}).execute()}async findValidCode(e,r){return await this.db.selectFrom("userAuthCodes").select(["id","phoneNumber"]).where("phoneNumber","=",e).where("code","=",r).where("expiresAt",">",new Date).executeTakeFirst()||null}async deleteCodesForPhone(e){await this.db.deleteFrom("userAuthCodes").where("phoneNumber","=",e).execute()}async deleteExpiredCodes(){return Number((await this.db.deleteFrom("userAuthCodes").where("expiresAt","<",new Date).executeTakeFirst()).numDeletedRows||0)}async countRecentRequests(e,r){let s=await this.db.selectFrom("userAuthCodes").select(e=>e.fn.countAll().as("count")).where("phoneNumber","=",e).where("createdAt",">=",r).executeTakeFirst();return Number(s?.count||0)}}e.s(["UserAuthRepository",()=>s])},139765,e=>{"use strict";var r=e.i(46308);class s extends r.BaseRepository{async record(e){return await this.db.insertInto("pageVisits").values(e).returningAll().executeTakeFirstOrThrow()}async getVisitsByDateRange(e,r,s){let t=this.db.selectFrom("pageVisits").selectAll().where("createdAt",">=",e).where("createdAt","<=",r).orderBy("createdAt","desc");return s?.source&&(t=t.where("source","=",s.source)),s?.limit&&(t=t.limit(s.limit)),t.execute()}async getVisitCountsBySource(e,r){return(await this.db.selectFrom("pageVisits").select(["source"]).select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",r).groupBy("source").orderBy("count","desc").execute()).map(e=>({source:e.source,count:Number(e.count)}))}async getTotalVisits(e,r){let s=await this.db.selectFrom("pageVisits").select(e=>e.fn.count("id").as("count")).where("createdAt",">=",e).where("createdAt","<=",r).executeTakeFirst();return Number(s?.count??0)}}e.s(["PageVisitRepository",()=>s])},534821,e=>{"use strict";var r=e.i(80643),s=e.i(565431),t=e.i(201236),n=e.i(108436),o=e.i(763800),i=e.i(187070);e.i(249805);var a=e.i(884031),c=e.i(823525);class l{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=s.UserService.getInstance(),this.messageService=r.MessageService.getInstance(),this.progressService=n.ProgressService.getInstance(),this.microcycleService=o.MicrocycleService.getInstance(),this.fitnessPlanService=t.FitnessPlanService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async scheduleMessagesForHour(e){let r=Date.now(),s=[],t=0,n=0;try{let o=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${o.length} users to schedule for hour ${e} on Sunday`),0===o.length)return{scheduled:0,failed:0,duration:Date.now()-r,errors:[]};let a=o.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await i.inngest.send(a);t=e.length,console.log(`[WeeklyMessageService] Scheduled ${t} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),n=a.length,s.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:t,failed:n,duration:Date.now()-r,errors:s}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let r=await this.fitnessPlanService.getCurrentPlan(e.id);if(!r)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let s=(0,c.now)(e.timezone).toJSDate(),t=(0,c.getNextWeekStart)(s,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${t.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(r,t,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:n}=await this.progressService.getOrCreateMicrocycleForDate(e.id,r,t,e.timezone);if(!n)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let o=n.isDeload;o&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${n.absoluteWeek})`);let i=await a.messagingAgentService.generateWeeklyMessage(e,o,n.absoluteWeek),l=n.message;if(!l)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${n.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let d=[],u=await this.messageService.sendMessage(e,i);d.push(u.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let g=await this.messageService.sendMessage(e,l);return d.push(g.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:d}}catch(r){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,r),{success:!1,userId:e.id,error:r instanceof Error?r.message:"Unknown error"}}}}let d=l.getInstance();e.s(["WeeklyMessageService",()=>l,"weeklyMessageService",0,d])},994766,e=>{"use strict";var r=e.i(23250),s=e.i(961691),t=e.i(565431),n=e.i(898990);class o{static instance;subscriptionRepo;onboardingService;constructor(){this.subscriptionRepo=new s.SubscriptionRepository,this.onboardingService=n.OnboardingService.getInstance()}static getInstance(){return o.instance||(o.instance=new o),o.instance}async sendOnboardingMessages(e){console.log(`[OnboardingCoordinator] Checking if ready to send messages for user ${e}`);try{if(await r.onboardingDataService.hasMessagesSent(e))return console.log(`[OnboardingCoordinator] Messages already sent for user ${e}, skipping`),!1;let s=await r.onboardingDataService.findByClientId(e);if(!s||"completed"!==s.status)return console.log(`[OnboardingCoordinator] Onboarding not complete for user ${e} (status: ${s?.status}), waiting`),!1;if(!await this.subscriptionRepo.hasActiveSubscription(e))return console.log(`[OnboardingCoordinator] No active subscription for user ${e}, waiting`),!1;console.log(`[OnboardingCoordinator] All conditions met, sending onboarding messages to user ${e}`);let n=await t.userService.getUser(e);if(!n)throw Error(`User ${e} not found`);return await this.onboardingService.sendOnboardingMessages(n),await r.onboardingDataService.markMessagesSent(e),console.log(`[OnboardingCoordinator] Successfully sent onboarding messages to user ${e}`),!0}catch(r){throw console.error(`[OnboardingCoordinator] Error sending onboarding messages to user ${e}:`,r),r}}}let i=o.getInstance();e.s(["onboardingCoordinator",0,i])},5389,e=>{e.v(r=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(r=>e.l(r))).then(()=>r(478500)))},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(r=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(r=>e.l(r))).then(()=>r(706674)))},399164,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(r=>e.l(r))).then(()=>r(785605)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(r=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(r=>e.l(r))).then(()=>r(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__922b9705._.js.map