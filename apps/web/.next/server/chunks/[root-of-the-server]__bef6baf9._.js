module.exports=[166194,e=>{"use strict";var r=e.i(46308),t=e.i(705590);class o extends r.BaseRepository{async create(e,r){return await this.db.insertInto("referrals").values({referrerId:e,refereeId:r,creditApplied:!1,creditAmountCents:0,createdAt:new Date}).returningAll().executeTakeFirstOrThrow()}async findByRefereeId(e){return await this.db.selectFrom("referrals").selectAll().where("refereeId","=",e).executeTakeFirst()||null}async findByReferrerId(e){return await this.db.selectFrom("referrals").selectAll().where("referrerId","=",e).orderBy("createdAt","desc").execute()}async markCreditApplied(e,r){return await this.db.updateTable("referrals").set({creditApplied:!0,creditAmountCents:r,creditedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async countCreditsEarned(e){let r=await this.db.selectFrom("referrals").select(t.sql`count(*)`.as("count")).where("referrerId","=",e).where("creditApplied","=",!0).executeTakeFirst();return Number(r?.count||0)}async countByReferrer(e){let r=await this.db.selectFrom("referrals").select(t.sql`count(*)`.as("count")).where("referrerId","=",e).executeTakeFirst();return Number(r?.count||0)}async hasBeenReferred(e){return!!await this.db.selectFrom("referrals").select("id").where("refereeId","=",e).executeTakeFirst()}}e.s(["ReferralRepository",()=>o])},842576,e=>{"use strict";var r=e.i(336801),t=e.i(166194),o=e.i(297934);e.i(791146);var a=e.i(832821),n=e.i(875559);let{secretKey:s}=(0,a.getStripeSecrets)(),i=new r.default(s,{apiVersion:"2023-10-16"}),c="REFERRAL_FREE_MONTH";class l{static instance;referralRepo;userRepo;constructor(){this.referralRepo=new t.ReferralRepository,this.userRepo=new o.UserRepository}static getInstance(){return l.instance||(l.instance=new l),l.instance}async getOrCreateReferralCode(e){return this.userRepo.getOrCreateReferralCode(e)}async getReferralStats(e){let r=await this.userRepo.getOrCreateReferralCode(e);if(!r)return null;let{publicBaseUrl:t,baseUrl:o}=(0,n.getUrlsConfig)(),a=`${t||o}/r/${r}`,s=await this.referralRepo.countByReferrer(e),i=await this.referralRepo.countCreditsEarned(e),c=Math.max(0,12-i);return{referralCode:r,referralLink:a,completedReferrals:s,creditsEarned:i,creditsRemaining:c}}async validateReferralCode(e,r){if(!e||6!==e.length)return{valid:!1,error:"Invalid referral code format"};let t=await this.userRepo.findByReferralCode(e.toUpperCase());return t?r&&t.phoneNumber===r?{valid:!1,error:"Cannot use your own referral code"}:{valid:!0,referrerId:t.id,referrerName:t.name}:{valid:!1,error:"Referral code not found"}}async completeReferral(e,r){let t=await this.userRepo.findByReferralCode(e.toUpperCase());t?await this.referralRepo.hasBeenReferred(r)?console.log(`[ReferralService] User ${r} has already been referred, skipping`):(await this.referralRepo.create(t.id,r),console.log(`[ReferralService] Referral completed: ${t.id} -> ${r}`)):console.error(`[ReferralService] Cannot complete referral: code ${e} not found`)}async creditReferrer(e){let r=await this.referralRepo.findByRefereeId(e);if(!r)return console.log(`[ReferralService] No referral found for referee ${e}`),{success:!0};if(r.creditApplied)return console.log(`[ReferralService] Credit already applied for referral ${r.id}`),{success:!0};if(await this.referralRepo.countCreditsEarned(r.referrerId)>=12)return console.log(`[ReferralService] Referrer ${r.referrerId} has reached max credits (12)`),{success:!0};let t=await this.userRepo.findById(r.referrerId);if(!t?.stripeCustomerId)return console.error(`[ReferralService] Referrer ${r.referrerId} has no Stripe customer ID`),{success:!1,error:"Referrer has no Stripe customer"};try{let e=await i.customers.createBalanceTransaction(t.stripeCustomerId,{amount:-1999,currency:"usd",description:"Referral credit - 1 free month"});return await this.referralRepo.markCreditApplied(r.id,1999),console.log(`[ReferralService] Applied $19.99 credit to referrer ${t.id}`),{success:!0,creditId:e.id}}catch(e){return console.error("[ReferralService] Failed to apply credit:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async getRefereeCouponId(){try{return await i.coupons.retrieve(c),c}catch{return await i.coupons.create({id:c,amount_off:1999,currency:"usd",duration:"once",name:"Referral - First Month Free"}),console.log("[ReferralService] Created referral coupon in Stripe"),c}}async canEarnCredits(e){return await this.referralRepo.countCreditsEarned(e)<12}}let d=l.getInstance();e.s(["referralService",0,d],842576)},994766,e=>{"use strict";var r=e.i(23250),t=e.i(961691),o=e.i(565431),a=e.i(898990);class n{static instance;subscriptionRepo;onboardingService;constructor(){this.subscriptionRepo=new t.SubscriptionRepository,this.onboardingService=a.OnboardingService.getInstance()}static getInstance(){return n.instance||(n.instance=new n),n.instance}async sendOnboardingMessages(e){console.log(`[OnboardingCoordinator] Checking if ready to send messages for user ${e}`);try{if(await r.onboardingDataService.hasMessagesSent(e))return console.log(`[OnboardingCoordinator] Messages already sent for user ${e}, skipping`),!1;let t=await r.onboardingDataService.findByClientId(e);if(!t||"completed"!==t.status)return console.log(`[OnboardingCoordinator] Onboarding not complete for user ${e} (status: ${t?.status}), waiting`),!1;if(!await this.subscriptionRepo.hasActiveSubscription(e))return console.log(`[OnboardingCoordinator] No active subscription for user ${e}, waiting`),!1;console.log(`[OnboardingCoordinator] All conditions met, sending onboarding messages to user ${e}`);let a=await o.userService.getUser(e);if(!a)throw Error(`User ${e} not found`);return await this.onboardingService.sendOnboardingMessages(a),await r.onboardingDataService.markMessagesSent(e),console.log(`[OnboardingCoordinator] Successfully sent onboarding messages to user ${e}`),!0}catch(r){throw console.error(`[OnboardingCoordinator] Error sending onboarding messages to user ${e}:`,r),r}}}let s=n.getInstance();e.s(["onboardingCoordinator",0,s])},749197,e=>{"use strict";var r=e.i(553573),t=e.i(163459),o=e.i(342845),a=e.i(904973),n=e.i(818385),s=e.i(588303),i=e.i(583020),c=e.i(304941),l=e.i(370312),d=e.i(40504),u=e.i(802579),p=e.i(225915),f=e.i(150373),h=e.i(804342),g=e.i(259207),R=e.i(348684),b=e.i(193695);e.i(650048);var v=e.i(219407),w=e.i(982099),m=e.i(336801),S=e.i(961691),y=e.i(994766),C=e.i(842576);e.i(791146);let{secretKey:_,webhookSecret:k}=(0,e.i(832821).getStripeSecrets)(),E=new m.default(_,{apiVersion:"2023-10-16"});async function x(e){try{let r,t=await e.text(),o=e.headers.get("stripe-signature");if(!o)return console.error("[Stripe Webhook] Missing stripe-signature header"),w.NextResponse.json({error:"Missing stripe-signature header"},{status:400});try{r=E.webhooks.constructEvent(t,o,k)}catch(e){return console.error("[Stripe Webhook] Signature verification failed:",e),w.NextResponse.json({error:`Webhook signature verification failed: ${e instanceof Error?e.message:"Unknown error"}`},{status:400})}console.log(`[Stripe Webhook] Received event: ${r.type}`);let a=new S.SubscriptionRepository;switch(r.type){case"checkout.session.completed":{let e=r.data.object;console.log("[Stripe Webhook] Checkout session completed:",e.id);let t=e.metadata?.userId||e.client_reference_id;if(!t)return console.error("[Stripe Webhook] No userId in session metadata"),w.NextResponse.json({error:"No userId in metadata"},{status:400});if(!e.subscription)return console.error("[Stripe Webhook] No subscription in session"),w.NextResponse.json({error:"No subscription in session"},{status:400});let o=await E.subscriptions.retrieve(e.subscription);if(await a.create({clientId:t,stripeSubscriptionId:o.id,status:o.status,planType:"monthly",currentPeriodStart:new Date(1e3*o.current_period_start),currentPeriodEnd:new Date(1e3*o.current_period_end)}),console.log(`[Stripe Webhook] Subscription created for user ${t}`),e.metadata?.referralCode)try{let e=await C.referralService.creditReferrer(t);e.success?console.log(`[Stripe Webhook] Referrer credited for user ${t}`):e.error&&console.error(`[Stripe Webhook] Failed to credit referrer: ${e.error}`)}catch(e){console.error(`[Stripe Webhook] Error crediting referrer for user ${t}:`,e)}try{await y.onboardingCoordinator.sendOnboardingMessages(t)?console.log(`[Stripe Webhook] Onboarding messages sent to user ${t}`):console.log(`[Stripe Webhook] Waiting for onboarding to complete for user ${t}`)}catch(e){console.error(`[Stripe Webhook] Failed to send messages for user ${t}:`,e)}break}case"customer.subscription.updated":{let e=r.data.object;console.log("[Stripe Webhook] Subscription updated:",e.id);let t=e.status;"active"===e.status&&e.cancel_at_period_end&&(t="cancel_pending"),await a.updateByStripeId(e.id,{status:t,currentPeriodStart:new Date(1e3*e.current_period_start),currentPeriodEnd:new Date(1e3*e.current_period_end)}),console.log(`[Stripe Webhook] Subscription ${e.id} updated to status: ${t} (Stripe: ${e.status}, cancel_at_period_end: ${e.cancel_at_period_end})`);break}case"customer.subscription.deleted":{let e=r.data.object;console.log("[Stripe Webhook] Subscription deleted:",e.id),await a.cancel(e.id,new Date(1e3*e.canceled_at)),console.log(`[Stripe Webhook] Subscription ${e.id} marked as canceled`);break}default:console.log(`[Stripe Webhook] Unhandled event type: ${r.type}`)}return w.NextResponse.json({received:!0},{status:200})}catch(e){return console.error("[Stripe Webhook] Error processing webhook:",e),w.NextResponse.json({error:e instanceof Error?e.message:"Unknown error processing webhook"},{status:500})}}e.s(["POST",()=>x],540635);var A=e.i(540635);let I=new r.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:$,workUnitAsyncStorage:O,serverHooks:N}=I;function P(){return(0,o.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:O})}async function T(e,r,o){I.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/stripe/webhook/route";w=w.replace(/\/index$/,"")||"/";let m=await I.prepare(e,r,{srcPage:w,multiZoneDraftMode:!1});if(!m)return r.statusCode=400,r.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:S,params:y,nextConfig:C,parsedUrl:_,isDraftMode:k,prerenderManifest:E,routerServerContext:x,isOnDemandRevalidate:A,revalidateOnlyGenerated:$,resolvedPathname:O,clientReferenceManifest:N,serverActionsManifest:P}=m,T=(0,c.normalizeAppPath)(w),M=!!(E.dynamicRoutes[T]||E.routes[O]),U=async()=>((null==x?void 0:x.render404)?await x.render404(e,r,_,!1):r.end("This page could not be found"),null);if(M&&!k){let e=!!E.routes[O],r=E.dynamicRoutes[T];if(r&&!1===r.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new b.NoFallbackError}}let F=null;!M||I.isDev||k||(F="/index"===(F=O)?"/":F);let D=!0===I.isDev||!M,W=M&&!D;P&&N&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:P,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:P})});let j=e.method||"GET",B=(0,n.getTracer)(),H=B.getActiveScopeSpan(),q={params:y,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:o.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,t,o)=>I.onRequestError(e,r,o,x)},sharedContext:{buildId:S}},K=new l.NodeNextRequest(e),L=new l.NodeNextResponse(r),V=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(r));try{let s=async e=>I.handle(V,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let t=B.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=t.get("next.route");if(o){let r=`${j} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":r}),e.updateName(r)}else e.updateName(`${j} ${w}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var n,c;let l=async({previousCacheEntry:t})=>{try{if(!i&&A&&$&&!t)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let n=await s(a);e.fetchMetrics=q.renderOpts.fetchMetrics;let c=q.renderOpts.pendingWaitUntil;c&&o.waitUntil&&(o.waitUntil(c),c=void 0);let l=q.renderOpts.collectedTags;if(!M)return await (0,f.sendResponse)(K,L,n,q.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),r=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(r[R.NEXT_CACHE_TAGS_HEADER]=l),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let t=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,o=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:t,expire:o}}}}catch(r){throw(null==t?void 0:t.isStale)&&await I.onRequestError(e,r,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:A})},x),r}},d=await I.handleResponse({req:e,nextConfig:C,cacheKey:F,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:$,responseGenerator:l,waitUntil:o.waitUntil,isMinimalMode:i});if(!M)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||r.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),k&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&M||u.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||r.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(K,L,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};H?await c(H):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(r){if(r instanceof b.NoFallbackError||await I.onRequestError(e,r,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:W,isOnDemandRevalidate:A})}),M)throw r;return await (0,f.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>P,"routeModule",()=>I,"serverHooks",()=>N,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>O],749197)},485685,e=>{e.v(e=>Promise.resolve().then(()=>e(254799)))},316067,e=>{e.v(r=>Promise.all(["server/chunks/node_modules__pnpm_4edfb228._.js"].map(r=>e.l(r))).then(()=>r(706674)))},399164,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__91a202dd._.js","server/chunks/node_modules__pnpm_f8c52739._.js","server/chunks/3f000_node-fetch_src_index_0443a381.js"].map(r=>e.l(r))).then(()=>r(785605)))},5389,e=>{e.v(r=>Promise.all(["server/chunks/[externals]_node:async_hooks_b485b2a4._.js"].map(r=>e.l(r))).then(()=>r(478500)))},493820,e=>{e.v(e=>Promise.resolve().then(()=>e(125720)))},279524,e=>{e.v(e=>Promise.resolve().then(()=>e(38330)))},593853,e=>{e.v(e=>Promise.resolve().then(()=>e(80643)))},464245,e=>{e.v(e=>Promise.resolve().then(()=>e(565431)))},690342,e=>{e.v(r=>Promise.all(["server/chunks/packages_shared_src_server_services_agents_training_index_ts_c783fc21._.js"].map(r=>e.l(r))).then(()=>r(464752)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__bef6baf9._.js.map