module.exports=[918622,(e,s,t)=>{s.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,s,t)=>{s.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,s,t)=>{s.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,s,t)=>{s.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},224361,(e,s,t)=>{s.exports=e.x("util",()=>require("util"))},814747,(e,s,t)=>{s.exports=e.x("path",()=>require("path"))},193695,(e,s,t)=>{s.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},875559,452130,e=>{"use strict";e.i(454188);var s=e.i(331612);let t=s.z.object({messageHistoryLimit:s.z.number().int().positive().default(5),includeSystemMessages:s.z.boolean().default(!0),maxContextTokens:s.z.number().int().positive().default(1e3),reserveTokensForResponse:s.z.number().int().positive().default(1500),conversationGapMinutes:s.z.number().int().positive().default(30),enableCaching:s.z.boolean().default(!0),cacheTTLSeconds:s.z.number().int().nonnegative().default(600)}),r=s.z.object({smsMaxLength:s.z.number().int().positive().default(1600),contextMinutes:s.z.number().int().positive().default(10)}),n=s.z.enum(["twilio","local"]),i=s.z.object({provider:n.default("twilio")}),a=s.z.object({agentLogging:s.z.boolean().default(!1),enableConversationStorage:s.z.boolean().default(!0)}),o=s.z.object({timeoutMinutes:s.z.number().int().positive().default(30),maxLength:s.z.number().int().positive().default(100),inactiveThresholdDays:s.z.number().int().positive().default(7)}),c=s.z.object({defaultExpiryDays:s.z.number().int().positive().default(7),domain:s.z.string().optional()}),l=s.z.object({priceId:s.z.string().min(1)}),u=s.z.object({phoneNumbers:s.z.array(s.z.string()).default([]),maxRequestsPerWindow:s.z.number().int().positive().default(3),rateLimitWindowMinutes:s.z.number().int().positive().default(15),codeExpiryMinutes:s.z.number().int().positive().default(10),codeLength:s.z.number().int().positive().default(6),devBypassCode:s.z.string().optional()}),d=s.z.object({baseUrl:s.z.string().optional(),publicBaseUrl:s.z.string().optional()}),g=s.z.object({environment:s.z.enum(["development","staging","production"]),context:t,chat:r,messaging:i,features:a,conversation:o,shortLinks:c,stripe:l,admin:u,urls:d});function m(e){if(!e)return;let s=parseInt(e,10);return isNaN(s)?void 0:s}function p(e){if(void 0!==e)return"true"===e}let v=null;function h(){return v||(v=function(){var e;let s="staging"===process.env.APP_ENV?"staging":"production",t={environment:s,context:{messageHistoryLimit:m(process.env.CONTEXT_MESSAGE_HISTORY_LIMIT),includeSystemMessages:p(process.env.CONTEXT_INCLUDE_SYSTEM_MESSAGES),maxContextTokens:m(process.env.CONTEXT_MAX_TOKENS),reserveTokensForResponse:m(process.env.CONTEXT_RESERVE_TOKENS),conversationGapMinutes:m(process.env.CONTEXT_CONVERSATION_GAP_MINUTES),enableCaching:p(process.env.CONTEXT_ENABLE_CACHING),cacheTTLSeconds:m(process.env.CONTEXT_CACHE_TTL)},chat:{smsMaxLength:m(process.env.SMS_MAX_LENGTH),contextMinutes:m(process.env.CHAT_CONTEXT_MINUTES)},messaging:{provider:process.env.MESSAGING_PROVIDER},features:{agentLogging:p(process.env.AGENT_LOGGING),enableConversationStorage:p(process.env.ENABLE_CONVERSATION_STORAGE)},conversation:{timeoutMinutes:m(process.env.CONVERSATION_TIMEOUT_MINUTES),maxLength:m(process.env.MAX_CONVERSATION_LENGTH),inactiveThresholdDays:m(process.env.INACTIVE_THRESHOLD_DAYS)},shortLinks:{defaultExpiryDays:m(process.env.SHORT_LINK_DEFAULT_EXPIRY_DAYS),domain:process.env.SHORT_LINK_DOMAIN},stripe:{priceId:process.env.STRIPE_PRICE_ID},admin:{phoneNumbers:process.env.ADMIN_PHONE_NUMBERS?(e=process.env.ADMIN_PHONE_NUMBERS)?e.split(",").map(e=>e.trim()).filter(e=>e.length>0):[]:void 0,devBypassCode:process.env.DEV_BYPASS_CODE},urls:{baseUrl:process.env.BASE_URL,publicBaseUrl:"http://localhost:3000"}},r=g.safeParse(t);if(!r.success){let e=r.error.errors.map(e=>`  - ${e.path.join(".")}: ${e.message}`).join("\n");throw Error(`Configuration validation failed:
${e}

Environment: ${s}
Check your environment variables.`)}return r.data}()),v}function S(){return!0}s.z.object({NEXT_PUBLIC_BASE_URL:s.z.string().optional(),NEXT_PUBLIC_ANALYTICS_WRITE_KEY:s.z.string().optional(),NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:s.z.string().optional()}),e.s(["isProductionEnvironment",()=>S],452130);let f=null;function y(){return h().chat}function w(){return h().messaging}function b(){return h().features}function T(){return h().shortLinks}function M(){return h().stripe}function E(){return h().admin}function I(){return h().urls}new Proxy({},{get:(e,s)=>(!f&&(f=h()),f)[s]}),e.s(["getAdminConfig",()=>E,"getChatConfig",()=>y,"getFeatureFlags",()=>b,"getMessagingConfig",()=>w,"getShortLinksConfig",()=>T,"getStripeConfig",()=>M,"getUrlsConfig",()=>I],875559)},968387,32721,363690,e=>{"use strict";var s=e.i(681247);let t=new class{provider="twilio";async sendMessage(e,t,r){try{let n=await s.twilioClient.sendSMS(e.phoneNumber,t,r);return{messageId:n.sid,status:this.mapTwilioStatus(n.status),provider:this.provider,to:n.to,from:n.from,timestamp:n.dateCreated,metadata:{twilioSid:n.sid,twilioStatus:n.status,errorCode:n.errorCode,errorMessage:n.errorMessage,mediaUrls:r}}}catch(e){throw console.error("TwilioMessagingClient: Failed to send message",e),e}}mapTwilioStatus(e){switch(e){case"sent":case"delivered":return"delivered";case"queued":case"accepted":case"sending":return"queued";case"failed":case"undelivered":return"failed";default:return"sent"}}};var r=e.i(427699);let n=new class{provider="local";eventEmitter;messageCounter=0;constructor(){this.eventEmitter=new r.EventEmitter,this.eventEmitter.setMaxListeners(100)}async sendMessage(e,s,t){let r=`local-${Date.now()}-${++this.messageCounter}`,n=new Date,i=e.phoneNumber;return this.eventEmitter.emit("message",{messageId:r,to:i,from:"local-system",content:s||"[MMS only - no text]",timestamp:n}),console.log("[LocalMessagingClient] Message sent (not actual SMS):",{messageId:r,to:i,userId:e.id,preview:s?s.substring(0,50):"[MMS only]",mediaUrls:t}),{messageId:r,status:"sent",provider:this.provider,to:i,from:"local-system",timestamp:n,metadata:{userId:e.id,phoneNumber:i,contentLength:s?.length||0,mediaUrls:t}}}onMessage(e){this.eventEmitter.on("message",e)}offMessage(e){this.eventEmitter.off("message",e)}getListenerCount(){return this.eventEmitter.listenerCount("message")}};e.s(["localMessagingClient",0,n],32721);var i=e.i(875559);let a=function(){let{provider:e}=(0,i.getMessagingConfig)();return"local"===e?(console.log("[MessagingFactory] Using LocalMessagingClient (no SMS will be sent)"),n):t}();e.s(["messagingClient",0,a],363690),e.s([],968387)},501261,e=>{"use strict";var s=e.i(46308);class t extends s.BaseRepository{async create(e){return await this.db.insertInto("messages").values(e).returningAll().executeTakeFirstOrThrow()}async findById(e){return await this.db.selectFrom("messages").selectAll().where("id","=",e).executeTakeFirst()}async findByClientId(e,s=50,t=0){return await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(s).offset(t).execute()}async findRecentByClientId(e,s=10){return(await this.db.selectFrom("messages").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(s).execute()).reverse()}async countByClientId(e){let s=await this.db.selectFrom("messages").select(({fn:e})=>e.count("id").as("count")).where("clientId","=",e).executeTakeFirst();return Number(s?.count??0)}async findByProviderMessageId(e){return await this.db.selectFrom("messages").selectAll().where("providerMessageId","=",e).executeTakeFirst()}async updateDeliveryStatus(e,s,t){return await this.db.updateTable("messages").set({deliveryStatus:s,deliveryError:t||null,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async incrementDeliveryAttempts(e){let s=await this.findById(e);if(!s)throw Error(`Message ${e} not found`);return await this.db.updateTable("messages").set({deliveryAttempts:(s.deliveryAttempts||1)+1,lastDeliveryAttemptAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async updateProviderMessageId(e,s){return await this.db.updateTable("messages").set({providerMessageId:s}).where("id","=",e).returningAll().executeTakeFirstOrThrow()}async findAllWithUserInfo(e){let s=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(["messages.id","messages.clientId","messages.conversationId","messages.direction","messages.content","messages.phoneFrom","messages.phoneTo","messages.provider","messages.providerMessageId","messages.deliveryStatus","messages.deliveryAttempts","messages.lastDeliveryAttemptAt","messages.deliveryError","messages.metadata","messages.createdAt","users.name as userName","users.phoneNumber as userPhone"]);e.clientId&&(s=s.where("messages.clientId","=",e.clientId)),e.direction&&(s=s.where("messages.direction","=",e.direction)),e.status&&(s=s.where("messages.deliveryStatus","=",e.status)),e.search&&(s=s.where(s=>s.or([s("messages.phoneFrom","ilike",`%${e.search}%`),s("messages.phoneTo","ilike",`%${e.search}%`),s("users.name","ilike",`%${e.search}%`),s("users.phoneNumber","ilike",`%${e.search}%`)])));let t=this.db.selectFrom("messages").innerJoin("users","users.id","messages.clientId").select(({fn:e})=>e.count("messages.id").as("count"));e.clientId&&(t=t.where("messages.clientId","=",e.clientId)),e.direction&&(t=t.where("messages.direction","=",e.direction)),e.status&&(t=t.where("messages.deliveryStatus","=",e.status)),e.search&&(t=t.where(s=>s.or([s("messages.phoneFrom","ilike",`%${e.search}%`),s("messages.phoneTo","ilike",`%${e.search}%`),s("users.name","ilike",`%${e.search}%`),s("users.phoneNumber","ilike",`%${e.search}%`)])));let r=await t.executeTakeFirst(),n=Number(r?.count??0);return{messages:await s.orderBy("messages.createdAt","desc").limit(e.limit||50).offset(e.offset||0).execute(),total:n}}async getStats(e){let s=this.db.selectFrom("messages");e&&(s=s.where("clientId","=",e));let[t,r,n,i,a]=await Promise.all([s.select(({fn:e})=>e.count("id").as("count")).executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("direction","=","inbound").executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("direction","=","outbound").executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["queued","sent"]).executeTakeFirst(),s.select(({fn:e})=>e.count("id").as("count")).where("deliveryStatus","in",["failed","undelivered"]).executeTakeFirst()]);return{totalMessages:Number(t?.count??0),inbound:Number(r?.count??0),outbound:Number(n?.count??0),pending:Number(i?.count??0),failed:Number(a?.count??0)}}}e.s(["MessageRepository",()=>t])},534821,e=>{"use strict";var s=e.i(80643),t=e.i(565431),r=e.i(201236),n=e.i(108436),i=e.i(763800),a=e.i(187070);e.i(249805);var o=e.i(884031),c=e.i(823525);class l{static instance;userService;messageService;progressService;microcycleService;fitnessPlanService;constructor(){this.userService=t.UserService.getInstance(),this.messageService=s.MessageService.getInstance(),this.progressService=n.ProgressService.getInstance(),this.microcycleService=i.MicrocycleService.getInstance(),this.fitnessPlanService=r.FitnessPlanService.getInstance()}static getInstance(){return l.instance||(l.instance=new l),l.instance}async scheduleMessagesForHour(e){let s=Date.now(),t=[],r=0,n=0;try{let i=await this.userService.getUsersForWeeklyMessage(e);if(console.log(`[WeeklyMessageService] Found ${i.length} users to schedule for hour ${e} on Sunday`),0===i.length)return{scheduled:0,failed:0,duration:Date.now()-s,errors:[]};let o=i.map(e=>({name:"weekly/scheduled",data:{userId:e.id}}));try{let{ids:e}=await a.inngest.send(o);r=e.length,console.log(`[WeeklyMessageService] Scheduled ${r} Inngest jobs`)}catch(e){console.error("[WeeklyMessageService] Failed to schedule Inngest jobs:",e),n=o.length,t.push({userId:"batch",error:e instanceof Error?e.message:"Unknown error"})}return{scheduled:r,failed:n,duration:Date.now()-s,errors:t}}catch(e){throw console.error("[WeeklyMessageService] Error scheduling messages:",e),e}}async sendWeeklyMessage(e){try{console.log(`[WeeklyMessageService] Processing weekly message for user ${e.id}`);let s=await this.fitnessPlanService.getCurrentPlan(e.id);if(!s)return console.error(`[WeeklyMessageService] No fitness plan found for user ${e.id}`),{success:!1,userId:e.id,error:"No fitness plan found"};let t=(0,c.now)(e.timezone).toJSDate(),r=(0,c.getNextWeekStart)(t,e.timezone);if(console.log(`[WeeklyMessageService] Getting next week's plan for ${r.toISOString()} for user ${e.id}`),!await this.progressService.getProgressForDate(s,r,e.timezone))return console.error(`[WeeklyMessageService] Could not calculate progress for next week for user ${e.id}`),{success:!1,userId:e.id,error:"Could not determine next week's training progress"};let{microcycle:n}=await this.progressService.getOrCreateMicrocycleForDate(e.id,s,r,e.timezone);if(!n)return console.error(`[WeeklyMessageService] Failed to get/create next week's microcycle for user ${e.id}`),{success:!1,userId:e.id,error:"Could not generate next week's training pattern"};let i=n.isDeload;i&&console.log(`[WeeklyMessageService] User ${e.id} is entering a deload week (week ${n.absoluteWeek})`);let a=await o.messagingAgentService.generateWeeklyMessage(e,i,n.absoluteWeek),l=n.message;if(!l)return console.error(`[WeeklyMessageService] No breakdown message stored for microcycle ${n.id}`),{success:!1,userId:e.id,error:"No breakdown message found for next week's microcycle"};let u=[],d=await this.messageService.sendMessage(e,a);u.push(d.id),console.log(`[WeeklyMessageService] Sent feedback message to user ${e.id}`),await new Promise(e=>setTimeout(e,1e3));let g=await this.messageService.sendMessage(e,l);return u.push(g.id),console.log(`[WeeklyMessageService] Sent breakdown message to user ${e.id}`),console.log(`[WeeklyMessageService] Successfully sent weekly messages to user ${e.id}`),{success:!0,userId:e.id,messageIds:u}}catch(s){return console.error(`[WeeklyMessageService] Error sending weekly message to user ${e.id}:`,s),{success:!1,userId:e.id,error:s instanceof Error?s.message:"Unknown error"}}}}let u=l.getInstance();e.s(["WeeklyMessageService",()=>l,"weeklyMessageService",0,u])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__fafe2269._.js.map