module.exports=[13423,e=>{"use strict";var t=e.i(46308),r=e.i(705590);class s extends t.BaseRepository{async create(e,t){let r={clientId:e,signupData:t?JSON.parse(JSON.stringify(t)):null,status:"pending",programMessagesSent:!1};return await this.db.insertInto("userOnboarding").values(r).returningAll().executeTakeFirstOrThrow()}async findByClientId(e){return await this.db.selectFrom("userOnboarding").selectAll().where("clientId","=",e).executeTakeFirst()??null}async updateStatus(e,t,r){return await this.db.updateTable("userOnboarding").set({status:t,errorMessage:r??null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markStarted(e){return await this.db.updateTable("userOnboarding").set({status:"in_progress",startedAt:r.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async updateCurrentStep(e,t){return await this.db.updateTable("userOnboarding").set({currentStep:t}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markCompleted(e){return await this.db.updateTable("userOnboarding").set({status:"completed",completedAt:r.sql`CURRENT_TIMESTAMP`}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async markMessagesSent(e){return await this.db.updateTable("userOnboarding").set({programMessagesSent:!0}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async hasMessagesSent(e){let t=await this.db.selectFrom("userOnboarding").select("programMessagesSent").where("clientId","=",e).executeTakeFirst();return t?.programMessagesSent??!1}async getSignupData(e){let t=await this.db.selectFrom("userOnboarding").select("signupData").where("clientId","=",e).executeTakeFirst();return t?.signupData??null}async clearSignupData(e){return await this.db.updateTable("userOnboarding").set({signupData:null}).where("clientId","=",e).returningAll().executeTakeFirstOrThrow()}async delete(e){await this.db.deleteFrom("userOnboarding").where("clientId","=",e).execute()}}e.s(["OnboardingRepository",()=>s])},565431,39917,e=>{"use strict";var t,r=e.i(973559),s=e.i(297934),i=e.i(13423);(t={}).CLOSED="CLOSED",t.OPEN="OPEN",t.HALF_OPEN="HALF_OPEN";class a{state="CLOSED";failureCount=0;successCount=0;lastFailureTime=null;options;constructor(e={}){this.options={failureThreshold:e.failureThreshold||5,resetTimeout:e.resetTimeout||6e4,monitoringPeriod:e.monitoringPeriod||6e4}}async execute(e){if("OPEN"===this.state)if(!this.shouldAttemptReset())return console.warn("Circuit breaker is OPEN, skipping execution"),null;else this.state="HALF_OPEN";try{let t=await e();return this.onSuccess(),t}catch(e){throw this.onFailure(),e}}onSuccess(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=3&&(this.state="CLOSED",this.successCount=0,console.info("Circuit breaker is now CLOSED")))}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state?(this.state="OPEN",console.warn("Circuit breaker is now OPEN due to failure in HALF_OPEN state")):this.failureCount>=this.options.failureThreshold&&(this.state="OPEN",console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`))}shouldAttemptReset(){return null!==this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.options.resetTimeout}getState(){return this.state}getStats(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount,lastFailureTime:this.lastFailureTime}}}e.s(["CircuitBreaker",()=>a],39917);var n=e.i(823525);class o{static instance;userRepository;onboardingRepository;circuitBreaker;constructor(){this.userRepository=new s.UserRepository,this.onboardingRepository=new i.OnboardingRepository,this.circuitBreaker=new a({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4})}static getInstance(){return o.instance||(o.instance=new o),o.instance}async createUser(e){let t=await this.circuitBreaker.execute(async()=>{if(await this.userRepository.findByPhoneNumber(e.phoneNumber))throw Error("User already exists with this phone number");let t={name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null};r.UserModel.validateUserData(t);let s=await this.userRepository.create(t);if(!s)throw Error("Failed to create user");return s});if(!t)throw Error("Failed to create user");return t}async getUserById(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findById(e))||void 0}async getUserByPhone(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findByPhoneNumber(e))||void 0}async getUser(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findWithProfile(e))}async getUsersForHour(e){return await this.circuitBreaker.execute(async()=>await this.userRepository.findUsersForHour(e))||[]}async getUsersForWeeklyMessage(e){return await this.circuitBreaker.execute(async()=>{let t=new Date;t.setUTCHours(e,0,0,0);let r=(0,n.getTimezonesAtLocalTime)(t,17,7);return await this.userRepository.findUsersByTimezones(r)})||[]}async updateUser(e,t){let s=await this.circuitBreaker.execute(async()=>(r.UserModel.validateUserUpdates(t),await this.userRepository.update(e,t)));if(!s)throw Error("Failed to update user");return s}async updatePreferences(e,t){let r=await this.circuitBreaker.execute(async()=>await this.userRepository.updatePreferences(e,t));if(!r)throw Error("Failed to update preferences");return r}async listUsersForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let{page:t=1,pageSize:r=20,sort:s={field:"createdAt",direction:"desc"},...i}=e,a={q:i.search,hasProfile:i.hasProfile,createdFrom:i.createdAfter,createdTo:i.createdBefore,page:t,pageSize:r,sort:`${s.field}:${s.direction}`},{users:n,total:o}=await this.userRepository.list(a),u=n.map(e=>this.transformToAdminUser(e));return{users:u,pagination:{page:t,limit:r,total:o,totalPages:Math.ceil(o/r)},stats:await this.calculateUserStats()}});if(!t)throw Error("Failed to fetch users");return t}async getUserForAdmin(e){let t=await this.circuitBreaker.execute(async()=>{let t=await this.userRepository.findWithProfile(e);if(!t)throw Error("User not found");let r=this.transformToAdminUser(t),s=await this.onboardingRepository.getSignupData(e);return{user:r,profile:t.profile||null,signupData:s,recentActivity:{totalMessages:0,totalWorkouts:0}}});if(!t)throw Error("Failed to fetch user");return t}async deleteUser(e){return await this.circuitBreaker.execute(async()=>!!await this.userRepository.findById(e)&&await this.userRepository.delete(e))||!1}transformToAdminUser(e){let t=!!e.profile;return{...e,hasProfile:t,profileSummary:void 0,stats:{totalWorkouts:0,isActiveToday:!1}}}async calculateUserStats(){let e=(await this.userRepository.list({pageSize:1e3})).users,t=e.length,r=e.filter(e=>e.email).length;return{totalUsers:t,withEmail:r,withProfile:e.filter(e=>e.profile).length,activeToday:0}}}let u=o.getInstance();e.s(["UserService",()=>o,"userService",0,u],565431)}];

//# sourceMappingURL=packages_shared_src_server_ea6edf6f._.js.map