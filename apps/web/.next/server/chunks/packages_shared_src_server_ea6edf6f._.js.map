{"version":3,"sources":["../../../../../packages/shared/src/server/repositories/onboardingRepository.ts","../../../../../packages/shared/src/server/services/user/userService.ts","../../../../../packages/shared/src/server/utils/circuitBreaker.ts"],"sourcesContent":["import { BaseRepository } from './baseRepository';\nimport { sql } from 'kysely';\nimport type { UserOnboarding } from '../models/_types';\nimport type { Insertable, Selectable, Updateable } from 'kysely';\n\nexport type OnboardingRecord = Selectable<UserOnboarding>;\nexport type NewOnboardingRecord = Insertable<UserOnboarding>;\nexport type OnboardingUpdate = Updateable<UserOnboarding>;\n\nexport interface SignupData {\n  // Formatted text for LLM (backward compatible)\n  fitnessGoals?: string;\n  currentExercise?: string;\n  injuries?: string;\n  environment?: string;\n\n  // Structured data from MultiStepSignupForm (for analytics/reporting)\n  primaryGoals?: ('strength' | 'endurance' | 'weight_loss' | 'general_fitness')[];\n  goalsElaboration?: string;\n  experienceLevel?: 'beginner' | 'intermediate' | 'advanced';\n  desiredDaysPerWeek?: '3_per_week' | '4_per_week' | '5_per_week' | '6_per_week';\n  availabilityElaboration?: string;\n  trainingLocation?: 'home' | 'commercial_gym' | 'bodyweight';\n  equipment?: string[];\n  acceptedRisks?: boolean;\n}\n\nexport type OnboardingStatus = 'pending' | 'in_progress' | 'completed' | 'failed';\n\n/**\n * OnboardingRepository\n *\n * Manages user onboarding state and signup data\n */\nexport class OnboardingRepository extends BaseRepository {\n  /**\n   * Create an onboarding record for a client\n   */\n  async create(clientId: string, signupData?: SignupData): Promise<OnboardingRecord> {\n    const record: NewOnboardingRecord = {\n      clientId,\n      signupData: signupData ? JSON.parse(JSON.stringify(signupData)) : null,\n      status: 'pending',\n      programMessagesSent: false,\n    };\n\n    return await this.db\n      .insertInto('userOnboarding')\n      .values(record)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Find onboarding record by client ID\n   */\n  async findByClientId(clientId: string): Promise<OnboardingRecord | null> {\n    return await this.db\n      .selectFrom('userOnboarding')\n      .selectAll()\n      .where('clientId', '=', clientId)\n      .executeTakeFirst() ?? null;\n  }\n\n  /**\n   * Update onboarding status\n   */\n  async updateStatus(\n    clientId: string,\n    status: OnboardingStatus,\n    errorMessage?: string\n  ): Promise<OnboardingRecord> {\n    const update: OnboardingUpdate = {\n      status,\n      errorMessage: errorMessage ?? null,\n    };\n\n    return await this.db\n      .updateTable('userOnboarding')\n      .set(update)\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as started\n   */\n  async markStarted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'in_progress',\n        startedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Update current step (for progress tracking)\n   */\n  async updateCurrentStep(clientId: string, stepNumber: number): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ currentStep: stepNumber })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark onboarding as completed\n   */\n  async markCompleted(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({\n        status: 'completed',\n        completedAt: sql`CURRENT_TIMESTAMP`,\n      })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Mark final program messages as sent\n   */\n  async markMessagesSent(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ programMessagesSent: true })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Check if messages have been sent\n   */\n  async hasMessagesSent(clientId: string): Promise<boolean> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('programMessagesSent')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.programMessagesSent ?? false;\n  }\n\n  /**\n   * Get signup data\n   */\n  async getSignupData(clientId: string): Promise<SignupData | null> {\n    const result = await this.db\n      .selectFrom('userOnboarding')\n      .select('signupData')\n      .where('clientId', '=', clientId)\n      .executeTakeFirst();\n\n    return result?.signupData as SignupData ?? null;\n  }\n\n  /**\n   * Clear signup data (cleanup after profile creation)\n   */\n  async clearSignupData(clientId: string): Promise<OnboardingRecord> {\n    return await this.db\n      .updateTable('userOnboarding')\n      .set({ signupData: null })\n      .where('clientId', '=', clientId)\n      .returningAll()\n      .executeTakeFirstOrThrow();\n  }\n\n  /**\n   * Delete onboarding record (full cleanup)\n   */\n  async delete(clientId: string): Promise<void> {\n    await this.db\n      .deleteFrom('userOnboarding')\n      .where('clientId', '=', clientId)\n      .execute();\n  }\n}\n","import { UserModel, CreateUserData, UserWithProfile, User } from '@/server/models/user';\nimport { UserRepository } from '@/server/repositories/userRepository';\nimport { OnboardingRepository } from '@/server/repositories/onboardingRepository';\nimport { CircuitBreaker } from '@/server/utils/circuitBreaker';\nimport type { AdminUser, AdminUsersResponse, AdminUserDetailResponse, UserFilters, UserSort, Pagination } from '@/shared/types/admin';\nimport { getTimezonesAtLocalTime } from '@/shared/utils/date';\n\nexport interface CreateUserRequest {\n  name: string;\n  phoneNumber: string;\n  age?: number;\n  gender?: string;\n  timezone: string;\n  preferredSendHour: number;\n  email?: string;\n  stripeCustomerId?: string;\n}\n\nexport class UserService {\n  private static instance: UserService;\n  private userRepository: UserRepository;\n  private onboardingRepository: OnboardingRepository;\n  private circuitBreaker: CircuitBreaker;\n\n  private constructor() {\n    this.userRepository = new UserRepository();\n    this.onboardingRepository = new OnboardingRepository();\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeout: 60000, // 1 minute\n      monitoringPeriod: 60000 // 1 minute\n    });\n  }\n\n  public static getInstance(): UserService {\n    if (!UserService.instance) {\n      UserService.instance = new UserService();\n    }\n    return UserService.instance;\n  }\n\n  async createUser(request: CreateUserRequest): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute<UserWithProfile>(async (): Promise<UserWithProfile> => {\n      // Check if user already exists using repository\n      const existingUser = await this.userRepository.findByPhoneNumber(request.phoneNumber);\n      if (existingUser) {\n        throw new Error('User already exists with this phone number');\n      }\n\n      // Prepare user data\n      const userData: CreateUserData = {\n        name: request.name,\n        phoneNumber: request.phoneNumber,\n        age: request.age || null,\n        gender: request.gender || null,\n        timezone: request.timezone,\n        preferredSendHour: request.preferredSendHour,\n        email: request.email || null,\n        stripeCustomerId: request.stripeCustomerId || null,\n      };\n\n      // Validate user data using domain model\n      UserModel.validateUserData(userData);\n\n      // Create the user using repository\n      const user = await this.userRepository.create(userData);\n      if (!user) {\n        throw new Error('Failed to create user');\n      }\n\n      return user;\n    });\n    \n    if (!result) {\n      throw new Error('Failed to create user');\n    }\n    \n    return result;\n  }\n\n  async getUserById(id: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findById(id);\n    });\n    return result || undefined;\n  }\n\n  async getUserByPhone(phoneNumber: string): Promise<User | undefined> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findByPhoneNumber(phoneNumber);\n    });\n    return result || undefined;\n  }\n\n  async getUser(userId: string): Promise<UserWithProfile | undefined | null> {\n    return await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findWithProfile(userId);\n    });\n  }\n\n  async getUsersForHour(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.findUsersForHour(currentUtcHour);\n    });\n    return result || [];\n  }\n\n  async getUsersForWeeklyMessage(currentUtcHour: number): Promise<UserWithProfile[]> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Business logic: Weekly messages are sent at 5pm on Sundays\n      const targetLocalHour = 17; // 5pm\n      const sunday = 7; // Luxon weekday (7 = Sunday)\n\n      // Calculate current UTC date\n      const currentUtcDate = new Date();\n      currentUtcDate.setUTCHours(currentUtcHour, 0, 0, 0);\n\n      // Get all timezones that are currently at 5pm on Sunday\n      const matchingTimezones = getTimezonesAtLocalTime(\n        currentUtcDate,\n        targetLocalHour,\n        sunday\n      );\n\n      // Query users in those timezones\n      return await this.userRepository.findUsersByTimezones(matchingTimezones);\n    });\n    return result || [];\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Validate updates using domain model\n      UserModel.validateUserUpdates(updates);\n      \n      // Update using repository\n      return await this.userRepository.update(id, updates);\n    });\n    \n    if (!result) {\n      throw new Error('Failed to update user');\n    }\n    \n    return result;\n  }\n\n  async updatePreferences(userId: string, preferences: { preferredSendHour?: number; timezone?: string; name?: string }): Promise<UserWithProfile> {\n    const result = await this.circuitBreaker.execute(async () => {\n      return await this.userRepository.updatePreferences(userId, preferences);\n    });\n\n    if (!result) {\n      throw new Error('Failed to update preferences');\n    }\n\n    return result;\n  }\n\n  // Admin-specific methods\n  async listUsersForAdmin(filters: UserFilters & { page?: number; pageSize?: number; sort?: UserSort }): Promise<AdminUsersResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const { page = 1, pageSize = 20, sort = { field: 'createdAt', direction: 'desc' }, ...restFilters } = filters;\n      \n      // Convert admin filters to repository filters\n      const repoParams = {\n        q: restFilters.search,\n        hasProfile: restFilters.hasProfile,\n        createdFrom: restFilters.createdAfter,\n        createdTo: restFilters.createdBefore,\n        page,\n        pageSize,\n        sort: `${sort.field}:${sort.direction}`\n      };\n\n      const { users, total } = await this.userRepository.list(repoParams);\n      \n      // Transform users to AdminUser format\n      const adminUsers: AdminUser[] = users.map(user => this.transformToAdminUser(user));\n      \n      // Calculate stats\n      const stats = await this.calculateUserStats();\n\n      const pagination: Pagination = {\n        page,\n        limit: pageSize,\n        total,\n        totalPages: Math.ceil(total / pageSize)\n      };\n\n      return {\n        users: adminUsers,\n        pagination,\n        stats\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch users');\n    }\n\n    return result;\n  }\n\n  async getUserForAdmin(id: string): Promise<AdminUserDetailResponse> {\n    const result = await this.circuitBreaker.execute(async () => {\n      const user = await this.userRepository.findWithProfile(id);\n      if (!user) {\n        throw new Error('User not found');\n      }\n\n      const adminUser = this.transformToAdminUser(user);\n\n      // Fetch signup data from onboarding\n      const signupData = await this.onboardingRepository.getSignupData(id);\n\n      return {\n        user: adminUser,\n        profile: user.profile || null,\n        signupData,\n        recentActivity: {\n          totalMessages: 0,\n          totalWorkouts: 0\n        }\n      };\n    });\n\n    if (!result) {\n      throw new Error('Failed to fetch user');\n    }\n\n    return result;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await this.circuitBreaker.execute(async () => {\n      // Verify user exists first\n      const user = await this.userRepository.findById(id);\n      if (!user) {\n        return false;\n      }\n\n      // Delete user and all cascaded data\n      return await this.userRepository.delete(id);\n    });\n\n    return result || false;\n  }\n\n  private transformToAdminUser(user: UserWithProfile): AdminUser {\n    const hasProfile = Boolean(user.profile);\n\n    return {\n      ...user,\n      hasProfile,\n      profileSummary: undefined, // Profile summary now comes from markdown profile parsing if needed\n      stats: {\n        totalWorkouts: 0,\n        isActiveToday: false\n      }\n    };\n  }\n\n  private async calculateUserStats() {\n    // Get basic counts from repository\n    const allUsersResult = await this.userRepository.list({ pageSize: 1000 });\n    const users = allUsersResult.users;\n\n    const totalUsers = users.length;\n    const withEmail = users.filter(u => u.email).length;\n    // Count users with profiles by checking profile\n    const withProfile = users.filter(u => u.profile).length;\n    const activeToday = 0; // TODO: Implement active user tracking\n\n    return {\n      totalUsers,\n      withEmail,\n      withProfile,\n      activeToday\n    };\n  }\n}\n\n// Export singleton instance\nexport const userService = UserService.getInstance();","export enum CircuitState {\n  CLOSED = 'CLOSED',\n  OPEN = 'OPEN',\n  HALF_OPEN = 'HALF_OPEN'\n}\n\ninterface CircuitBreakerOptions {\n  failureThreshold: number;\n  resetTimeout: number;\n  monitoringPeriod: number;\n}\n\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failureCount: number = 0;\n  private successCount: number = 0;\n  private lastFailureTime: number | null = null;\n  private readonly options: CircuitBreakerOptions;\n\n  constructor(options: Partial<CircuitBreakerOptions> = {}) {\n    this.options = {\n      failureThreshold: options.failureThreshold || 5,\n      resetTimeout: options.resetTimeout || 60000, // 60 seconds\n      monitoringPeriod: options.monitoringPeriod || 60000 // 60 seconds\n    };\n  }\n\n  async execute<T>(fn: () => Promise<T>): Promise<T | null> {\n    if (this.state === CircuitState.OPEN) {\n      if (this.shouldAttemptReset()) {\n        this.state = CircuitState.HALF_OPEN;\n      } else {\n        console.warn('Circuit breaker is OPEN, skipping execution');\n        return null;\n      }\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.failureCount = 0;\n    if (this.state === CircuitState.HALF_OPEN) {\n      this.successCount++;\n      if (this.successCount >= 3) {\n        this.state = CircuitState.CLOSED;\n        this.successCount = 0;\n        console.info('Circuit breaker is now CLOSED');\n      }\n    }\n  }\n\n  private onFailure(): void {\n    this.failureCount++;\n    this.lastFailureTime = Date.now();\n    \n    if (this.state === CircuitState.HALF_OPEN) {\n      this.state = CircuitState.OPEN;\n      console.warn('Circuit breaker is now OPEN due to failure in HALF_OPEN state');\n    } else if (this.failureCount >= this.options.failureThreshold) {\n      this.state = CircuitState.OPEN;\n      console.warn(`Circuit breaker is now OPEN after ${this.failureCount} failures`);\n    }\n  }\n\n  private shouldAttemptReset(): boolean {\n    return (\n      this.lastFailureTime !== null &&\n      Date.now() - this.lastFailureTime >= this.options.resetTimeout\n    );\n  }\n\n  getState(): CircuitState {\n    return this.state;\n  }\n\n  getStats() {\n    return {\n      state: this.state,\n      failureCount: this.failureCount,\n      successCount: this.successCount,\n      lastFailureTime: this.lastFailureTime\n    };\n  }\n}"],"names":[],"mappings":"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"}