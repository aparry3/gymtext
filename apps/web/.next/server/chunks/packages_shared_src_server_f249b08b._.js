module.exports=[517670,e=>{"use strict";var t=e.i(46308);class r extends t.BaseRepository{async create(e){let t={...e,details:"string"==typeof e.details?e.details:JSON.stringify(e.details),structured:e.structured?"string"==typeof e.structured?e.structured:JSON.stringify(e.structured):null};return await this.db.insertInto("workoutInstances").values(t).returningAll().executeTakeFirstOrThrow()}async findByClientIdAndDateRange(e,t,r){return await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",t).where("date","<=",r).orderBy("date","asc").selectAll().execute()}async findByClientIdAndDate(e,t){let r=new Date(t),c=new Date(t);return c.setUTCDate(c.getUTCDate()+1),await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",r).where("date","<",c).selectAll().executeTakeFirst()}async getRecentWorkouts(e,t=10){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",e).orderBy("workoutInstances.date","desc").limit(t).execute()}async getRecentWorkoutsByDays(e,t=7){let r=new Date,c=new Date;return c.setDate(c.getDate()-t),await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("date",">=",c).where("date","<=",r).orderBy("date","desc").selectAll().execute()}async getWorkoutByDate(e,t){return this.findByClientIdAndDate(e,t)}async update(e,t){let r={...t,updatedAt:new Date};return t.details&&(r.details="string"==typeof t.details?t.details:JSON.stringify(t.details)),void 0!==t.structured&&(r.structured=t.structured?"string"==typeof t.structured?t.structured:JSON.stringify(t.structured):null),await this.db.updateTable("workoutInstances").set(r).where("id","=",e).returningAll().executeTakeFirst()}async deleteOldWorkouts(e=90){let t=new Date;return t.setDate(t.getDate()-e),Number((await this.db.deleteFrom("workoutInstances").where("date","<",t).executeTakeFirst()).numDeletedRows)}async getWorkoutById(e){return await this.db.selectFrom("workoutInstances").selectAll().where("id","=",e).executeTakeFirst()}async getWorkoutsByMicrocycle(e,t){return await this.db.selectFrom("workoutInstances").where("clientId","=",e).where("microcycleId","=",t).orderBy("date","asc").selectAll().execute()}async getWorkoutsByDateRange(e,t,r){return await this.db.selectFrom("workoutInstances").leftJoin("microcycles","workoutInstances.microcycleId","microcycles.id").select(["workoutInstances.id","workoutInstances.clientId","workoutInstances.microcycleId","workoutInstances.date","workoutInstances.sessionType","workoutInstances.goal","workoutInstances.details","workoutInstances.structured","workoutInstances.description","workoutInstances.message","workoutInstances.completedAt","workoutInstances.createdAt","workoutInstances.updatedAt","microcycles.absoluteWeek"]).where("workoutInstances.clientId","=",e).where("workoutInstances.date",">=",t).where("workoutInstances.date","<=",r).orderBy("workoutInstances.date","asc").execute()}async delete(e){return Number((await this.db.deleteFrom("workoutInstances").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}async findUserIdsWithWorkoutsForUserDates(e){return 0===e.length?new Set:new Set((await this.db.selectFrom("workoutInstances").select("clientId").where(t=>{let r=e.map(({userId:e,startOfDay:r,endOfDay:c})=>t.and([t("clientId","=",e),t("date",">=",r),t("date","<",c)]));return t.or(r)}).execute()).map(e=>e.clientId))}}e.s(["WorkoutInstanceRepository",()=>r])},201236,e=>{"use strict";var t=e.i(840936),r=e.i(76421);e.i(331950);var c=e.i(466405),s=e.i(36480);class o{static instance;fitnessPlanRepo;constructor(){this.fitnessPlanRepo=new t.FitnessPlanRepository(s.postgresDb)}static getInstance(){return o.instance||(o.instance=new o),o.instance}async createFitnessPlan(e){let t=await c.fitnessPlanAgentService.generateFitnessPlan(e),s=r.FitnessPlanModel.fromFitnessPlanOverview(e,t);return console.log("[FitnessPlanService] Created plan:",s.description?.substring(0,200)),await this.fitnessPlanRepo.insertFitnessPlan(s)}async getCurrentPlan(e){return await this.fitnessPlanRepo.getCurrentPlan(e)}async getPlanById(e){return await this.fitnessPlanRepo.getFitnessPlan(e)}async getPlanHistory(e){return await this.fitnessPlanRepo.getPlanHistory(e)}async updateFitnessPlan(e,t){return await this.fitnessPlanRepo.updateFitnessPlan(e,t)}async deleteFitnessPlan(e){return await this.fitnessPlanRepo.deleteFitnessPlan(e)}}let i=o.getInstance();e.s(["FitnessPlanService",()=>o,"fitnessPlanService",0,i])},125720,881640,763800,108436,e=>{"use strict";var t=e.i(517670),r=e.i(36480);e.i(331950);var c=e.i(520676),s=e.i(201236),o=e.i(823525),i=e.i(929492),a=e.i(995515);class n{db;constructor(e){this.db=e}async createMicrocycle(e){let t=await this.db.insertInto("microcycles").values({id:(0,i.v4)(),clientId:e.clientId,absoluteWeek:e.absoluteWeek,days:e.days,description:e.description,isDeload:e.isDeload,message:e.message,structured:e.structured?JSON.stringify(e.structured):null,startDate:e.startDate,endDate:e.endDate,isActive:e.isActive}).returningAll().executeTakeFirstOrThrow();return a.MicrocycleModel.fromDB(t)}async getActiveMicrocycle(e){let t=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("isActive","=",!0).orderBy("createdAt","desc").executeTakeFirst();return t?a.MicrocycleModel.fromDB(t):null}async getMicrocycleByAbsoluteWeek(e,t){let r=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("absoluteWeek","=",t).orderBy("updatedAt","desc").executeTakeFirst();return r?a.MicrocycleModel.fromDB(r):null}async deactivatePreviousMicrocycles(e){await this.db.updateTable("microcycles").set({isActive:!1}).where("clientId","=",e).where("isActive","=",!0).execute()}async updateMicrocycle(e,t){let r={};if(void 0!==t.days&&(r.days=t.days),void 0!==t.description&&(r.description=t.description),void 0!==t.isDeload&&(r.isDeload=t.isDeload),void 0!==t.message&&(r.message=t.message),void 0!==t.structured&&(r.structured=t.structured?JSON.stringify(t.structured):null),void 0!==t.isActive&&(r.isActive=t.isActive),void 0!==t.startDate&&(r.startDate=t.startDate),void 0!==t.endDate&&(r.endDate=t.endDate),void 0!==t.absoluteWeek&&(r.absoluteWeek=t.absoluteWeek),0===Object.keys(r).length)return this.getMicrocycleById(e);let c=await this.db.updateTable("microcycles").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirst();return c?a.MicrocycleModel.fromDB(c):null}async getMicrocycleById(e){let t=await this.db.selectFrom("microcycles").selectAll().where("id","=",e).executeTakeFirst();return t?a.MicrocycleModel.fromDB(t):null}async getRecentMicrocycles(e,t=5){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).orderBy("createdAt","desc").limit(t).execute()).map(e=>a.MicrocycleModel.fromDB(e))}async deleteMicrocycle(e){return(await this.db.deleteFrom("microcycles").where("id","=",e).executeTakeFirst()).numDeletedRows>0}async getAllMicrocycles(e){return(await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).orderBy("absoluteWeek","asc").execute()).map(e=>a.MicrocycleModel.fromDB(e))}async getMicrocycleByDate(e,t){let r=await this.db.selectFrom("microcycles").selectAll().where("clientId","=",e).where("startDate","<=",t).where("endDate",">=",t).orderBy("updatedAt","desc").executeTakeFirst();return r?a.MicrocycleModel.fromDB(r):null}}e.s(["MicrocycleRepository",()=>n],881640);var l=e.i(404650),u=e.i(565431);class d{static instance;microcycleRepo;userService;constructor(){this.microcycleRepo=new n(r.postgresDb),this.userService=u.UserService.getInstance()}static getInstance(){return d.instance||(d.instance=new d),d.instance}async getActiveMicrocycle(e){return await this.microcycleRepo.getActiveMicrocycle(e)}async isActiveMicrocycleCurrent(e,t="America/New_York"){let r=await this.microcycleRepo.getActiveMicrocycle(e);if(!r)return!1;let{startDate:c}=this.calculateWeekDates(t),s=new Date(c);s.setHours(0,0,0,0);let o=new Date(r.startDate);o.setHours(0,0,0,0);let i=new Date(r.endDate);return i.setHours(0,0,0,0),s>=o&&s<=i}async getAllMicrocycles(e){return await this.microcycleRepo.getAllMicrocycles(e)}async getMicrocycleByAbsoluteWeek(e,t){return await this.microcycleRepo.getMicrocycleByAbsoluteWeek(e,t)}async getMicrocycleByDate(e,t){return await this.microcycleRepo.getMicrocycleByDate(e,t)}async getMicrocycleById(e){return await this.microcycleRepo.getMicrocycleById(e)}async updateMicrocycleDays(e,t){return await this.microcycleRepo.updateMicrocycle(e,{days:t})}async updateMicrocycle(e,t){return await this.microcycleRepo.updateMicrocycle(e,t)}async createMicrocycleFromProgress(e,t,r){let c=await this.userService.getUser(e);if(!c)throw Error(`Client not found: ${e}`);let{days:s,description:o,isDeload:i,message:a,structure:n}=await this.generateMicrocycle(c,r.absoluteWeek),l=await this.microcycleRepo.createMicrocycle({clientId:e,absoluteWeek:r.absoluteWeek,days:s,description:o,isDeload:i,message:a,structured:n,startDate:r.weekStartDate,endDate:r.weekEndDate,isActive:!1});return console.log(`[MicrocycleService] Created microcycle for client ${e}, week ${r.absoluteWeek} (${r.weekStartDate.toISOString()} - ${r.weekEndDate.toISOString()})`),l}async generateMicrocycle(e,t){try{let r=await l.microcycleAgentService.generateMicrocycle(e,t);return console.log(`[MicrocycleService] Generated microcycle for week ${t}, isDeload=${r.isDeload}`),r}catch(e){throw console.error("[MicrocycleService] Failed to generate microcycle:",e),e}}calculateWeekDates(e="America/New_York"){let t=(0,o.now)(e).toJSDate();return{startDate:(0,o.startOfWeek)(t,e),endDate:(0,o.endOfWeek)(t,e)}}async deleteMicrocycleWithWorkouts(t){let r=await this.microcycleRepo.getMicrocycleById(t);if(!r)return{deleted:!1,deletedWorkoutsCount:0};let{workoutInstanceService:c}=await e.A(493820),s=await c.getWorkoutsByMicrocycle(r.clientId,t),o=0;for(let e of s)await c.deleteWorkout(e.id,r.clientId)&&o++;return{deleted:await this.microcycleRepo.deleteMicrocycle(t),deletedWorkoutsCount:o}}}let y=d.getInstance();e.s(["MicrocycleService",()=>d,"microcycleService",0,y],763800);class w{static instance;microcycleService;constructor(){this.microcycleService=d.getInstance()}static getInstance(){return w.instance||(w.instance=new w),w.instance}async getProgressForDate(e,t,r="America/New_York"){if(!e||!e.id)return null;let c=(0,o.parseDate)(e.startDate);if(!c)return null;let s=(0,o.startOfWeek)(c,r),i=(0,o.startOfWeek)(t,r),a=(0,o.diffInWeeks)(i,s,r)+1;if(a<1)return null;let n=await this.microcycleService.getMicrocycleByDate(e.clientId,t);return n||(n=await this.microcycleService.getMicrocycleByAbsoluteWeek(e.clientId,a)),{fitnessPlan:e,microcycle:n,absoluteWeek:a,dayOfWeek:(0,o.getWeekday)(t,r),weekStartDate:(0,o.startOfWeek)(t,r),weekEndDate:(0,o.endOfWeek)(t,r)}}async getCurrentProgress(e,t="America/New_York"){let r=(0,o.now)(t).toJSDate();return await this.getProgressForDate(e,r,t)}async getOrCreateMicrocycleForDate(e,t,r,c="America/New_York",s=!1){let o=await this.getProgressForDate(t,r,c);if(!o)throw Error(`Could not calculate progress for date ${r}`);if(o.microcycle&&!s)return{microcycle:o.microcycle,progress:o,wasCreated:!1};let i=await this.microcycleService.createMicrocycleFromProgress(e,t,o),a={...o,microcycle:i};return{microcycle:i,progress:a,wasCreated:!0}}}let k=w.getInstance();e.s(["ProgressService",()=>w,"progressService",0,k],108436);var g=e.i(11385);class h{static instance;workoutRepo;fitnessPlanService;progressService;microcycleService;constructor(){this.workoutRepo=new t.WorkoutInstanceRepository(r.postgresDb),this.fitnessPlanService=s.FitnessPlanService.getInstance(),this.progressService=w.getInstance(),this.microcycleService=d.getInstance()}static getInstance(){return h.instance||(h.instance=new h),h.instance}async getRecentWorkouts(e,t=10){return await this.workoutRepo.getRecentWorkouts(e,t)}async getWorkoutsByDateRange(e,t,r){return await this.workoutRepo.getWorkoutsByDateRange(e,t,r)}async getWorkoutById(e,t){let r=await this.workoutRepo.getWorkoutById(e);return r&&r.clientId===t?r:null}async getWorkoutByIdInternal(e){return await this.workoutRepo.getWorkoutById(e)}async getWorkoutByUserIdAndDate(e,t){return await this.workoutRepo.findByClientIdAndDate(e,t)}async updateWorkoutMessage(e,t){return await this.workoutRepo.update(e,{message:t})}async createWorkout(e){return await this.workoutRepo.create(e)}async updateWorkout(e,t){return await this.workoutRepo.update(e,t)}async generateWorkoutForDate(e,t,r){try{let s=await this.fitnessPlanService.getCurrentPlan(e.id);if(!s)return console.log(`No fitness plan found for user ${e.id}`),null;if(!await this.progressService.getProgressForDate(s,t.toJSDate(),e.timezone))return console.log(`No progress found for user ${e.id} on ${t.toISODate()}`),null;let i=r??null;if(i||(i=(await this.progressService.getOrCreateMicrocycleForDate(e.id,s,t.toJSDate(),e.timezone)).microcycle),!i)return console.log(`Could not get/create microcycle for user ${e.id}`),null;let a=(0,o.getWeekday)(t.toJSDate(),e.timezone)-1,n=i.days?.[a];if(!n||"string"!=typeof n)return console.log(`No overview found for day index ${a} in microcycle ${i.id}`),null;let l=i.structured?.days?.[a],u=l?.activityType,{response:d,message:y,structure:w}=await c.workoutAgentService.generateWorkout(e,n,i.isDeload??!1,u),k=w?.title||"Workout",h={clientId:e.id,microcycleId:i.id,date:t.toJSDate(),sessionType:"workout",goal:n.substring(0,100),details:JSON.parse(JSON.stringify({theme:k})),description:d,message:y,structured:w,completedAt:null,createdAt:new Date,updatedAt:new Date},m=await this.createWorkout(h);console.log(`Generated and saved workout for user ${e.id} on ${t.toISODate()}`);try{let r=await g.shortLinkService.createWorkoutLink(e.id,m.id),c=g.shortLinkService.getFullUrl(r.code);if(console.log(`Created short link for workout ${m.id}: ${c}`),m.message){let r=(0,o.getDayOfWeekName)(t.toJSDate(),e.timezone);m.message=`${r}

${m.message}

(More details: ${c})`.replace(/\n{3,}/g,"\n\n").trim(),await this.updateWorkoutMessage(m.id,m.message)}}catch(e){console.error(`Failed to create short link for workout ${m.id}:`,e)}return m}catch(t){throw console.error(`Error generating workout for user ${e.id}:`,t),t}}mapThemeToSessionType(e){let t=e.toLowerCase();return t.includes("run")||t.includes("running")?"run":t.includes("metcon")||t.includes("hiit")||t.includes("conditioning")||t.includes("cardio")?"metcon":t.includes("lift")||t.includes("strength")||t.includes("upper")||t.includes("lower")||t.includes("push")||t.includes("pull")?"lift":t.includes("mobility")||t.includes("flexibility")||t.includes("stretch")?"mobility":t.includes("rest")||t.includes("recovery")||t.includes("deload")?"rest":"other"}async deleteWorkout(e,t){let r=await this.workoutRepo.getWorkoutById(e);return!!r&&r.clientId===t&&await this.workoutRepo.delete(e)}async getWorkoutsByMicrocycle(e,t){return await this.workoutRepo.getWorkoutsByMicrocycle(e,t)}}let m=h.getInstance();e.s(["WorkoutInstanceService",()=>h,"workoutInstanceService",0,m],125720)}];

//# sourceMappingURL=packages_shared_src_server_f249b08b._.js.map