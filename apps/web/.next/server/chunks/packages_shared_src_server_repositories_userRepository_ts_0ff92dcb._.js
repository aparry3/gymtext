module.exports=[297934,490773,973559,301418,e=>{"use strict";var r=e.i(46308);e.i(454188);var t=e.i(331612);function i(e){if(!e||"string"!=typeof e)return null;let r=e.replace(/\D/g,"");if(!r)return null;if(10===r.length){if(r[0]>="2"&&r[0]<="9")return`+1${r}`}else if(11===r.length&&r.startsWith("1")){if(r[1]>="2"&&r[1]<="9")return`+${r}`}else if(e.startsWith("+1")&&11===r.length&&r.startsWith("1")&&r[1]>="2"&&r[1]<="9")return e;return null}function s(e){return!!e&&"string"==typeof e&&/^\+1[2-9]\d{2}[2-9]\d{6}$/.test(e)}e.s(["normalizeUSPhoneNumber",()=>i,"validateUSPhoneNumber",()=>s],490773),t.z.object({id:t.z.string().uuid(),name:t.z.string(),email:t.z.string().email().nullable(),phoneNumber:t.z.string().transform(i).refine(s,{message:"Must be a valid US phone number"}),age:t.z.number().int().min(1).max(120).nullable(),gender:t.z.string().nullable(),stripeCustomerId:t.z.string().nullable(),preferredSendHour:t.z.number().int().min(0).max(23),timezone:t.z.string(),createdAt:t.z.date(),updatedAt:t.z.date()});let n=t.z.object({summary:t.z.string().nullish(),daysPerWeek:t.z.number().int().min(1).max(7),minutesPerSession:t.z.number().int().min(15).max(240),preferredTimes:t.z.array(t.z.enum(["morning","afternoon","evening"])).nullish(),schedule:t.z.string().nullish()}),l=t.z.object({id:t.z.string(),description:t.z.string(),startDate:t.z.string(),endDate:t.z.string().nullish(),location:t.z.string().nullish(),equipmentAvailable:t.z.array(t.z.string()).nullish(),equipmentUnavailable:t.z.array(t.z.string()).nullish()}),a=t.z.object({summary:t.z.string().nullish(),gymAccess:t.z.boolean(),gymType:t.z.enum(["commercial","home","community","none"]).nullish(),homeEquipment:t.z.array(t.z.string()).nullish(),limitations:t.z.array(t.z.string()).nullish(),temporaryChanges:t.z.array(l).nullish()}),u=t.z.object({value:t.z.number().positive(),unit:t.z.enum(["lbs","kg"]),date:t.z.string().nullish()}),o=t.z.object({summary:t.z.string().nullish(),height:t.z.number().positive().nullish(),weight:u.nullish(),bodyComposition:t.z.number().min(1).max(50).nullish(),fitnessLevel:t.z.enum(["sedentary","lightly_active","moderately_active","very_active"]).nullish()}),m=t.z.object({id:t.z.string(),type:t.z.enum(["injury","mobility","medical","preference"]),description:t.z.string(),severity:t.z.enum(["mild","moderate","severe"]).nullish(),affectedMovements:t.z.array(t.z.string()).nullish(),status:t.z.enum(["active","resolved"]),startDate:t.z.string().nullish(),endDate:t.z.string().nullish(),isTemporary:t.z.boolean().default(!1)}),d=t.z.object({type:t.z.literal("strength"),summary:t.z.string().nullish(),experience:t.z.enum(["beginner","intermediate","advanced"]),currentProgram:t.z.string().nullish(),keyLifts:t.z.record(t.z.string(),t.z.number()).nullish(),preferences:t.z.object({workoutStyle:t.z.string().nullish(),likedExercises:t.z.array(t.z.string()).nullish(),dislikedExercises:t.z.array(t.z.string()).nullish()}).nullish(),trainingFrequency:t.z.number().int().min(1).max(7)}),c=t.z.object({type:t.z.literal("cardio"),summary:t.z.string().nullish(),experience:t.z.enum(["beginner","intermediate","advanced"]),primaryActivities:t.z.array(t.z.string()),keyMetrics:t.z.object({weeklyDistance:t.z.number().positive().nullish(),longestSession:t.z.number().positive().nullish(),averagePace:t.z.string().nullish(),preferredIntensity:t.z.enum(["low","moderate","high"]).nullish()}).nullish(),preferences:t.z.object({indoor:t.z.boolean().nullish(),outdoor:t.z.boolean().nullish(),groupVsIndividual:t.z.enum(["group","individual","both"]).nullish(),timeOfDay:t.z.array(t.z.string()).nullish()}).nullish(),frequency:t.z.number().int().min(1).max(7).nullish()}),h=t.z.array(t.z.union([d,c])),f=t.z.object({summary:t.z.string().nullish(),primary:t.z.string(),timeline:t.z.number().int().min(1).max(104).nullish(),specific:t.z.string().nullish(),motivation:t.z.string().nullish()}),z=t.z.object({goals:f,experienceLevel:t.z.enum(["beginner","intermediate","advanced"]).nullish(),equipmentAccess:a.nullish(),availability:n.nullish(),constraints:t.z.array(m).nullish(),metrics:o.nullish(),activities:h.nullish()});t.z.object({name:t.z.string().nullish(),email:t.z.string().email().nullish(),phoneNumber:t.z.string().transform(i).refine(s,{message:"Must be a valid US phone number"}),age:t.z.number().int().min(1).max(120).nullish(),gender:t.z.string().nullish(),isActive:t.z.boolean().nullish().default(!0),isAdmin:t.z.boolean().nullish().default(!1),stripeCustomerId:t.z.string().nullish(),preferredSendHour:t.z.number().int().min(0).max(23).nullish(),timezone:t.z.string().nullish()}).partial(),z.partial(),t.z.object({field:t.z.string(),oldValue:t.z.unknown().nullable(),newValue:t.z.unknown().nullable(),timestamp:t.z.date()}),t.z.object({updates:z.partial(),source:t.z.enum(["chat","form","admin","api","system"]),reason:t.z.string().optional().nullable()});class b{static fromDb(e){return e?{...e}:void 0}static fromDbWithProfile(e){let{profile:r,...t}=e;return{...t,profile:r||null}}static validateUserData(e){if(!e.name||e.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(!e.phoneNumber||!s(e.phoneNumber))throw Error("Valid US phone number is required");if(e.email&&!this.isValidEmail(e.email))throw Error("Invalid email format")}static validateUserUpdates(e){if(e.name&&e.name.trim().length<2)throw Error("User name must be at least 2 characters long");if(e.phoneNumber&&!s(e.phoneNumber))throw Error("Valid US phone number is required");if(e.email&&!this.isValidEmail(e.email))throw Error("Invalid email format");if(void 0!==e.preferredSendHour&&(e.preferredSendHour<0||e.preferredSendHour>23))throw Error("Preferred send hour must be between 0 and 23");if(void 0!==e.age&&null!==e.age&&(e.age<1||e.age>120))throw Error("Age must be between 1 and 120")}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}}e.s(["UserModel",()=>b],973559),e.i(943636);var p=e.i(68551),g=e.i(724826),w=e.i(823525);function y(e){return g.IANAZone.isValidZone(e)}function v(e,r){if(!y(r))throw Error(`Invalid IANA timezone: ${r}`);return p.DateTime.fromJSDate(e,{zone:"utc"}).setZone(r).hour}function A(e){if(!y(e))return e;try{let r=(0,w.now)(e).toFormat("ZZZ"),t=e.split("/"),i=t[t.length-1].replace(/_/g," ");return`${i} (${r})`}catch{return e}}e.s(["formatTimezoneForDisplay",()=>A,"getLocalHourForTimezone",()=>v,"isValidIANATimezone",()=>y],301418);class x extends r.BaseRepository{async list(e){let{q:r,createdFrom:t,createdTo:i,page:s=1,pageSize:n=20,sort:l="createdAt:desc"}=e,[a,u]=l.split(":"),o=this.db.selectFrom("users").selectAll("users");if(r){let e=`%${r}%`;o=o.where(r=>r.or([r("users.name","ilike",e),r("users.email","ilike",e),r("users.phoneNumber","ilike",e)]))}t&&(o=o.where("users.createdAt",">=",new Date(t))),i&&(o=o.where("users.createdAt","<=",new Date(i))),!0===e.hasProfile?o=o.where(e=>e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===e.hasProfile&&(o=o.where(e=>e.not(e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let m=this.db.selectFrom("users");if(r){let e=`%${r}%`;m=m.where(r=>r.or([r("users.name","ilike",e),r("users.email","ilike",e),r("users.phoneNumber","ilike",e)]))}t&&(m=m.where("users.createdAt",">=",new Date(t))),i&&(m=m.where("users.createdAt","<=",new Date(i))),!0===e.hasProfile?m=m.where(e=>e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id"))):!1===e.hasProfile&&(m=m.where(e=>e.not(e.exists(e.selectFrom("profiles").whereRef("profiles.clientId","=","users.id").select("profiles.id")))));let d=await m.select(e=>e.fn.countAll().as("count")).executeTakeFirst(),c=Number(d?.count||0);return{users:(await o.orderBy(`users.${a}`,"asc"===u?"asc":"desc").offset((s-1)*n).limit(n).execute()).map(e=>b.fromDb(e)).filter(e=>void 0!==e),total:c}}async create(e){let r=await this.db.insertInto("users").values({name:e.name,phoneNumber:e.phoneNumber,age:e.age||null,gender:e.gender||null,email:e.email||null,stripeCustomerId:e.stripeCustomerId||null,timezone:e.timezone,preferredSendHour:e.preferredSendHour,createdAt:new Date,updatedAt:new Date}).returningAll().executeTakeFirstOrThrow();return b.fromDb(r)}async findById(e){return b.fromDb(await this.db.selectFrom("users").where("id","=",e).selectAll().executeTakeFirst())}async findByPhoneNumber(e){return b.fromDb(await this.db.selectFrom("users").where("phoneNumber","=",e).selectAll().executeTakeFirst())}async findByEmail(e){return b.fromDb(await this.db.selectFrom("users").where("email","=",e).selectAll().executeTakeFirst())}async findByStripeCustomerId(e){return b.fromDb(await this.db.selectFrom("users").where("stripeCustomerId","=",e).selectAll().executeTakeFirst())}async update(e,r){return b.fromDb(await this.db.updateTable("users").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirst())}async findWithProfile(e){let r=await this.db.selectFrom("users").leftJoin("profiles",e=>e.onRef("profiles.clientId","=","users.id").on(e=>{let r=e.selectFrom("profiles as p2").select(e=>e.fn.max("p2.createdAt").as("maxCreated")).whereRef("p2.clientId","=","users.id");return e("profiles.createdAt","=",r)})).selectAll("users").select("profiles.profile").where("users.id","=",e).executeTakeFirst();if(r)return b.fromDbWithProfile(r)}async updatePreferences(e,r){return b.fromDb(await this.db.updateTable("users").set({...r,updatedAt:new Date}).where("id","=",e).returningAll().executeTakeFirstOrThrow())}async findUsersForHour(e){let r=await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute(),t=[],i=new Date;for(let s of(i.setUTCHours(e,0,0,0),r))try{v(i,s.timezone)>=s.preferredSendHour&&t.push(b.fromDb(s))}catch(e){console.error(`Error processing user ${s.id} timezone:`,e)}return t}async findUsersByTimezones(e){return 0===e.length?[]:(await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").where("timezone","in",e).selectAll("users").execute()).map(e=>b.fromDb(e)).filter(e=>void 0!==e)}async findActiveUsersWithPreferences(){return await this.db.selectFrom("users").innerJoin("subscriptions","users.id","subscriptions.clientId").where("subscriptions.status","=","active").selectAll("users").execute()}async delete(e){return await this.db.deleteFrom("adminActivityLogs").where(r=>r.or([r("targetClientId","=",e),r("actorClientId","=",e)])).execute(),Number((await this.db.deleteFrom("users").where("id","=",e).executeTakeFirst()).numDeletedRows)>0}generateReferralCode(){let e="ABCDEFGHJKMNPQRSTUVWXYZ23456789",r="";for(let t=0;t<6;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}async getOrCreateReferralCode(e){let r=await this.db.selectFrom("users").select(["id","referralCode"]).where("id","=",e).executeTakeFirst();if(!r)return null;if(r.referralCode)return r.referralCode;let t=0;for(;t<10;){let r=this.generateReferralCode();try{if(await this.db.updateTable("users").set({referralCode:r,updatedAt:new Date}).where("id","=",e).where("referralCode","is",null).returningAll().executeTakeFirst())return r;let t=await this.db.selectFrom("users").select("referralCode").where("id","=",e).executeTakeFirst();if(t?.referralCode)return t.referralCode}catch(e){if(++t>=10)throw console.error("Failed to generate unique referral code after 10 attempts"),e}}return null}async findByReferralCode(e){return b.fromDb(await this.db.selectFrom("users").where("referralCode","=",e.toUpperCase()).selectAll().executeTakeFirst())}}e.s(["UserRepository",()=>x],297934)}];

//# sourceMappingURL=packages_shared_src_server_repositories_userRepository_ts_0ff92dcb._.js.map