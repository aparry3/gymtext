module.exports=[180256,670864,306312,11206,739351,310752,650654,986904,e=>{"use strict";var t=e.i(201236),r=e.i(125720),s=e.i(763800),o=e.i(108436);e.i(684734);var i=e.i(880002),n=e.i(46308);class a extends n.BaseRepository{async getCurrentProfile(e){return await this.db.selectFrom("profiles").where("clientId","=",e).orderBy("createdAt","desc").limit(1).selectAll().executeTakeFirst()}async getCurrentProfileText(e){let t=await this.getCurrentProfile(e);return t?.profile??null}async createProfile(e){return await this.db.insertInto("profiles").values(e).returningAll().executeTakeFirstOrThrow()}async createProfileForUser(e,t){return this.createProfile({clientId:e,profile:t})}async getProfileHistory(e,t=10){return await this.db.selectFrom("profiles").where("clientId","=",e).orderBy("createdAt","desc").limit(t).selectAll().execute()}async getProfileAtDate(e,t){return await this.db.selectFrom("profiles").where("clientId","=",e).where("createdAt","<=",t).orderBy("createdAt","desc").limit(1).selectAll().executeTakeFirst()}async countProfileUpdates(e){return Number((await this.db.selectFrom("profiles").where("clientId","=",e).select(this.db.fn.count("id").as("count")).executeTakeFirstOrThrow()).count)}async getLastUpdateDate(e){let t=await this.getCurrentProfile(e);return t?.createdAt??null}async deleteAllProfilesForUser(e){return Number((await this.db.deleteFrom("profiles").where("clientId","=",e).executeTakeFirst()).numDeletedRows)}async getAllUsersWithProfiles(){return(await this.db.selectFrom("profiles").select("clientId").distinct().execute()).map(e=>e.clientId)}async hasProfile(e){return await this.countProfileUpdates(e)>0}async createProfileWithStructured(e,t,r){return await this.db.insertInto("profiles").values({clientId:e,profile:t,structured:r?JSON.stringify(r):null}).returningAll().executeTakeFirstOrThrow()}async getCurrentProfileWithStructured(e){let t=await this.getCurrentProfile(e);if(t)return{...t,structured:t.structured}}async getCurrentStructuredProfile(e){let t=await this.getCurrentProfileWithStructured(e);return t?.structured??null}}e.s(["ProfileRepository",()=>a],670864),e.i(574394);var c=e.i(351250),u=e.i(14006),l=e.i(80643),d=e.i(565431),p=e.i(39917);function m(e,t,r,s){return`## CONTEXT

**Current Date**: ${s}
**User Timezone**: ${r.timezone}
**User Name**: ${r.name}
**User Age**: ${r.age||"Unknown"}
**User Gender**: ${r.gender||"Unknown"}

---

## CURRENT PROFILE

${e||"_No profile exists yet. Create initial profile based on the message._"}

---

## USER'S MESSAGE

${t}

---

## YOUR TASK

1. Review the current profile.
2. **FIRST: Determine if this message contains PERMANENT profile information.**
   - If it's only a transient request (like "switch today to X", "can I do Y instead"), return wasUpdated: false.
   - Look for keywords: "today", "this time", "can we", "let's" = TRANSIENT (don't record)
   - Look for keywords: "I like", "I prefer", "I always", "from now on" = PERMANENT (do record)
3. Check for [ACTIVE] constraints that have expired and remove them.
4. Extract any PERMANENT preferences (scheduling, exercise, workout style).
5. Update EQUIPMENT details if the user mentions gym type, specific equipment, or limitations.
6. Update other sections based on the message. **Carefully distinguish between "Fixed Anchors" (Classes/Sports) and "Current Habits" (General routine).**
7. Return the COMPLETE updated profile (or unchanged if wasUpdated: false).
`}function g(e,t){return`## CURRENT DATE
${t}

## PROFILE TO PARSE

${e||"_No profile content - return empty arrays for all fields_"}

## YOUR TASK
Parse this profile into the structured format. Extract all relevant information following the rules above.`}e.i(454188);var f=e.i(331612);let y=f.z.object({updatedProfile:f.z.string().describe("The complete updated Markdown profile document"),wasUpdated:f.z.boolean().describe("Whether any changes were made to the profile"),updateSummary:f.z.string().describe("Brief summary of changes made. Empty string if nothing was updated.")}),h=f.z.object({timezone:f.z.enum(["America/New_York","America/Chicago","America/Denver","America/Los_Angeles","America/Toronto","America/Vancouver","America/Mexico_City","America/Sao_Paulo","Europe/London","Europe/Paris","Europe/Berlin","Europe/Madrid","Europe/Rome","Europe/Amsterdam","Europe/Stockholm","Europe/Moscow","Asia/Tokyo","Asia/Shanghai","Asia/Hong_Kong","Asia/Singapore","Asia/Seoul","Asia/Mumbai","Asia/Dubai","Australia/Sydney","Australia/Melbourne","Pacific/Auckland"]).nullable(),preferredSendHour:f.z.number().int().min(0).max(23).nullable(),name:f.z.string().nullable(),hasUpdates:f.z.boolean(),updateSummary:f.z.string()}),w=f.z.object({value:f.z.string().describe("Description of the constraint (injury, travel, temporary limitation, etc.)"),start:f.z.string().nullable().describe("ISO date string when constraint started, or null if permanent/unknown"),end:f.z.string().nullable().describe("ISO date string when constraint ends, or null if ongoing/permanent")}),S=f.z.enum(["beginner","intermediate","advanced"]),v=f.z.object({goals:f.z.array(f.z.string()).describe("User's stated fitness goals"),experienceLevel:S.nullable().describe("User's experience level (beginner, intermediate, advanced) or null if not stated"),preferences:f.z.array(f.z.string()).describe("Preferences including exercise likes/dislikes, scheduling preferences, and workout style preferences"),injuries:f.z.array(f.z.string()).describe("Permanent physical limitations or chronic injuries"),constraints:f.z.array(w).describe("Temporary constraints with optional start/end dates (travel, temporary injuries, etc.)"),equipmentAccess:f.z.array(f.z.string()).describe("Equipment access including gym type, available equipment, and limitations")});function k(e){return({strength:"Build strength and muscle",endurance:"Improve endurance and stamina",weight_loss:"Lose weight and improve body composition",general_fitness:"Improve overall fitness and health"})[e]||e}var I=e.i(823525);class E{static instance;circuitBreaker;profileRepository;constructor(){this.circuitBreaker=new p.CircuitBreaker({failureThreshold:5,resetTimeout:6e4,monitoringPeriod:6e4}),this.profileRepository=new a}static getInstance(){return E.instance||(E.instance=new E),E.instance}async getCurrentProfile(e){return await this.profileRepository.getCurrentProfileText(e)}async saveProfile(e,t){try{await this.profileRepository.createProfileForUser(e,t),console.log(`[FitnessProfileService] Saved profile for user ${e}`)}catch(t){throw console.error(`[FitnessProfileService] Error saving profile for user ${e}:`,t),t}}async createFitnessProfile(e,t){return this.circuitBreaker.execute(async()=>{try{var r,s;let o,i,n,a,l,d,p,f,h,w=(o=`My goals are: ${(t.primaryGoals||[]).map(k).join(", ")}`,i=t.goalsElaboration?.trim()?`${o}. Additional details: ${t.goalsElaboration.trim()}`:o,n=t.desiredDaysPerWeek?({"3_per_week":"Wants to train 3 days per week","4_per_week":"Wants to train 4 days per week","5_per_week":"Wants to train 5 days per week","6_per_week":"Wants to train 6 days per week"})[r=t.desiredDaysPerWeek]||r:"",a=t.experienceLevel?`Experience level: ${t.experienceLevel.charAt(0).toUpperCase()+t.experienceLevel.slice(1)}`:"",l=`***Desired Availability***:
  ${a}. ${n}.
  Additional Details: ${t.availabilityElaboration?.trim()||"None provided."}`,d=t.trainingLocation?`Training location: ${({home:"Home gym",commercial_gym:"Commercial gym",bodyweight:"Bodyweight/minimal equipment"})[s=t.trainingLocation]||s}`:"",p=t.equipment&&t.equipment.length>0?`Available equipment: ${t.equipment.map(e=>{var t;return({dumbbells:"Dumbbells",barbell:"Barbell",resistance_bands:"Resistance bands",pull_up_bar:"Pull-up bar",cardio_equipment:"Cardio equipment",full_gym:"Full gym access"})[t=e]||t}).join(", ")}`:"No specific equipment",{fitnessGoals:i,currentExercise:l,environment:`***Environment & Constraints***:
  ${d}. ${p}`,injuries:t.injuries}),S=[];w.fitnessGoals?.trim()&&S.push(`***Goals***:
${w.fitnessGoals.trim()}`),w.currentExercise?.trim()&&S.push(`***Current Activity***:
${w.currentExercise.trim()}`),w.environment?.trim()&&S.push(`***Training Environment***:
${w.environment.trim()}`),w.injuries?.trim()&&S.push(`***Injuries or Limitations***:
${w.injuries.trim()}`);let E=S.join("\n\n"),b=(f=[],h=["# IDENTITY"],e?.name&&h.push(`**Name:** ${e.name}`),e?.age&&h.push(`**Age:** ${e.age}`),f.push(h.join("\n")),f.join("\n\n")),P=(0,I.formatForAI)(new Date,e.timezone),T=async e=>{let t="string"==typeof e?JSON.parse(e):e,r=g(t.dossierText,t.currentDate),s=await (0,c.createAgent)({name:u.PROMPT_IDS.PROFILE_STRUCTURED,schema:v},{model:"gpt-5-nano",temperature:.3});return{structured:(await s.invoke(r)).response,success:!0}},R=m(b,E,e,P),A=await (0,c.createAgent)({name:u.PROMPT_IDS.PROFILE_FITNESS,schema:y,subAgents:[{structured:{agent:{name:u.PROMPT_IDS.PROFILE_STRUCTURED,invoke:T},condition:e=>e.wasUpdated,transform:e=>JSON.stringify({dossierText:e.updatedProfile,currentDate:P})}}]},{model:"gpt-5.1"}),U=await A.invoke(R),C=U.structured,O=C?.success?C.structured:null,M={updatedProfile:U.response.updatedProfile,wasUpdated:U.response.wasUpdated,updateSummary:U.response.updateSummary||"",structured:O};return console.log("[FitnessProfileService] Created initial profile:",{wasUpdated:M.wasUpdated,summary:M.updateSummary,hasStructured:null!==M.structured}),await this.profileRepository.createProfileWithStructured(e.id,M.updatedProfile,M.structured),M.updatedProfile}catch(e){throw console.error("[FitnessProfileService] Error creating profile:",e),e}})}async getProfileHistory(e,t=10){return await this.profileRepository.getProfileHistory(e,t)}async saveProfileWithStructured(e,t,r){try{await this.profileRepository.createProfileWithStructured(e,t,r),console.log(`[FitnessProfileService] Saved profile with structured data for user ${e}`)}catch(t){throw console.error(`[FitnessProfileService] Error saving profile for user ${e}:`,t),t}}async getCurrentStructuredProfile(e){return await this.profileRepository.getCurrentStructuredProfile(e)}}let b=E.getInstance();e.s(["FitnessProfileService",()=>E,"fitnessProfileService",0,b],306312);var P=e.i(187070);class T{messages=[];static toMessageArray(e){return e.map(e=>({role:"inbound"===e.direction?"user":"assistant",content:e.content}))}static filterMessagesForContext(e){return e&&0!==e.length?"inbound"===e[e.length-1].direction?e.slice(0,-1):e:[]}addMessage(e){Array.isArray(e)?this.messages.push(...e):this.messages.push(e)}getRecentMessages(e){return e?this.messages.slice(-e):[...this.messages]}toArray(e){return this.getRecentMessages(e).map(e=>({role:"inbound"===e.direction?"user":"assistant",content:e.content}))}toString(e){return this.getRecentMessages(e).map(e=>{let t="inbound"===e.direction?"User":"Assistant";return`${t}: ${e.content}`}).join("\n\n")}get length(){return this.messages.length}clear(){this.messages=[]}}class R{static async updateProfile(e,t,s){console.log("[PROFILE_SERVICE] Processing profile update:",{userId:e,message:t.substring(0,100)+(t.length>100?"...":"")});try{let o=await d.userService.getUser(e);if(!o)return console.warn("[PROFILE_SERVICE] User not found:",e),{toolType:"action",response:"User not found."};let i=await b.getCurrentProfile(e)??"",n=(0,I.formatForAI)(new Date,o.timezone),a=T.toMessageArray(s||[]).map(e=>({role:e.role,content:e.content})),l=async e=>{let t="string"==typeof e?JSON.parse(e):e,r=g(t.dossierText,t.currentDate),s=await (0,c.createAgent)({name:u.PROMPT_IDS.PROFILE_STRUCTURED,schema:v},{model:"gpt-5-nano",temperature:.3});return{structured:(await s.invoke(r)).response,success:!0}},[p,f]=await Promise.all([(async()=>{let e=m(i,t,o,n),r=await (0,c.createAgent)({name:u.PROMPT_IDS.PROFILE_FITNESS,previousMessages:a,schema:y,subAgents:[{structured:{agent:{name:u.PROMPT_IDS.PROFILE_STRUCTURED,invoke:l},condition:e=>e.wasUpdated,transform:e=>JSON.stringify({dossierText:e.updatedProfile,currentDate:n})}}]}),s=await r.invoke(e),d=s.structured,p=d?.success?d.structured:null;return{updatedProfile:s.response.updatedProfile,wasUpdated:s.response.wasUpdated,updateSummary:s.response.updateSummary||"",structured:p}})(),(async()=>{var e;let r=`## CURRENT USER SETTINGS
- Name: ${o.name||"Not set"}
- Timezone: ${o.timezone}
- Preferred Send Hour: ${o.preferredSendHour} (${(e=o.preferredSendHour,`${0===e?12:e>12?e-12:e}:00 ${e>=12?"PM":"AM"}`)})
- Current Date: ${n}

## USER MESSAGE
${t}

## TASK
Analyze the message above. Extract any requested changes to timezone, send time, or name.
Return null for fields not being changed.`,s=await (0,c.createAgent)({name:u.PROMPT_IDS.PROFILE_USER,previousMessages:a,schema:h},{model:"gpt-5-nano",temperature:.3}),i=await s.invoke(r);return{timezone:i.response.timezone,preferredSendHour:i.response.preferredSendHour,name:i.response.name,hasUpdates:i.response.hasUpdates,updateSummary:i.response.updateSummary||""}})()]);if(p.wasUpdated?(await b.saveProfileWithStructured(e,p.updatedProfile,p.structured),console.log("[PROFILE_SERVICE] Profile updated:",{summary:p.updateSummary,hasStructured:null!==p.structured})):console.log("[PROFILE_SERVICE] No profile updates detected"),f.hasUpdates){let t={};if(f.timezone&&(t.timezone=f.timezone,console.log("[PROFILE_SERVICE] Timezone update:",f.timezone)),null!=f.preferredSendHour&&-1!==f.preferredSendHour&&(t.preferredSendHour=f.preferredSendHour),f.name&&(t.name=f.name),Object.keys(t).length>0&&(await d.userService.updatePreferences(e,t),console.log("[PROFILE_SERVICE] User fields updated:",t),void 0!==t.timezone||void 0!==t.preferredSendHour)){let s=t.timezone??o.timezone,i=(0,I.now)(s),n=i.startOf("day").toJSDate();await r.workoutInstanceService.getWorkoutByUserIdAndDate(e,n)||(await P.inngest.send({name:"workout/scheduled",data:{userId:e,targetDate:i.startOf("day").toISO()}}),console.log("[PROFILE_SERVICE] Triggered immediate workout for missed send time"))}}let w=[];return p.wasUpdated&&w.push(`Profile: ${p.updateSummary}`),f.hasUpdates&&Object.keys(f).some(e=>"hasUpdates"!==e&&"updateSummary"!==e&&null!==f[e])&&w.push(`Settings: ${f.updateSummary}`),{toolType:"action",response:w.length>0?w.join("; "):"No updates detected."}}catch(t){console.error("[PROFILE_SERVICE] Error updating profile:",t);let e=t instanceof Error?t.message:"Unknown error";return{toolType:"action",response:`Profile update failed: ${e}`}}}}e.i(331950);var A=e.i(520676),U=e.i(404650);e.i(943636);var C=e.i(68551);class O{static instance;userService;microcycleService;workoutInstanceService;progressService;fitnessPlanService;constructor(){this.userService=d.UserService.getInstance(),this.microcycleService=s.MicrocycleService.getInstance(),this.workoutInstanceService=r.WorkoutInstanceService.getInstance(),this.progressService=o.ProgressService.getInstance(),this.fitnessPlanService=t.FitnessPlanService.getInstance()}static getInstance(){return O.instance||(O.instance=new O),O.instance}async modifyWorkout(e){try{let{userId:t,workoutDate:r,changeRequest:s}=e;console.log("Modifying workout",e);let o=await this.userService.getUser(t);if(!o)return{success:!1,messages:[],error:"User not found"};let i=r.toISOString().split("T")[0],n=C.DateTime.fromISO(i,{zone:o.timezone}).startOf("day").toJSDate(),a=await this.workoutInstanceService.getWorkoutByUserIdAndDate(t,n);if(!a)return{success:!1,messages:[],error:"No workout found for the specified date"};let c=await A.workoutAgentService.modifyWorkout(o,a,s),u=c.structure?.title||"Workout";return await this.workoutInstanceService.updateWorkout(a.id,{description:c.response.overview,message:c.message,structured:c.structure,details:{theme:u}}),{success:!0,workout:c,modifications:c.response.modifications,messages:c.message?[c.message]:[]}}catch(e){return console.error("Error modifying workout:",e),{success:!1,messages:[],error:e instanceof Error?e.message:"Unknown error occurred"}}}async modifyWeek(e){try{let{userId:t,changeRequest:r}=e,s=await this.userService.getUser(t);if(!s)return{success:!1,messages:[],error:"User not found"};let o=await this.fitnessPlanService.getCurrentPlan(t);if(!o)return{success:!1,messages:[],error:"No fitness plan found"};let i=await this.progressService.getCurrentProgress(o,s.timezone);if(!i)return{success:!1,messages:[],error:"No progress found"};let{microcycle:n}=i;if(!n)return{success:!1,messages:[],error:"No microcycle found"};console.log(`[MODIFY_WEEK] Using active microcycle ${n.id} (${new Date(n.startDate).toLocaleDateString()} - ${new Date(n.endDate).toLocaleDateString()})`);let a=(0,I.now)(s.timezone).toJSDate(),c=(0,I.getDayOfWeek)(void 0,s.timezone),u=I.DAY_NAMES.indexOf(c),l=n.days[u]||null,d=await U.microcycleAgentService.modifyMicrocycle(s,n,r);if(console.log("[MODIFY_WEEK] Microcycle modification result:",d),!d.wasModified)return console.log("[MODIFY_WEEK] No modifications needed - current plan already satisfies the request"),{success:!0,messages:[],modifications:"No changes needed - your current plan already matches your request"};{console.log("[MODIFY_WEEK] Microcycle was modified - updating database"),await this.microcycleService.updateMicrocycle(n.id,{days:d.days,description:d.description,isDeload:d.isDeload,structured:d.structure});let e=d.days[u]||null;if(l!==e){let r=d.structure?.days?.[u],o=r?.activityType,i=await A.workoutAgentService.generateWorkout(s,e||"",d.isDeload||!1,o),c=i.structure?.title||"Workout",l={theme:c},p=await this.workoutInstanceService.getWorkoutByUserIdAndDate(t,a);p?(await this.workoutInstanceService.updateWorkout(p.id,{details:l,description:i.response,message:i.message,structured:i.structure,goal:c,sessionType:this.mapThemeToSessionType(c)}),console.log("[MODIFY_WEEK] Updated today's workout")):(await this.workoutInstanceService.createWorkout({clientId:t,microcycleId:n.id,date:a,sessionType:this.mapThemeToSessionType(c),goal:c,details:l,description:i.response,message:i.message,structured:i.structure}),console.log("[MODIFY_WEEK] Created new workout for today"));let m=[];return i.message&&m.push(i.message),{success:!0,workout:i,messages:m,modifications:d.modifications}}return{success:!0,messages:[],modifications:d.modifications}}}catch(e){return console.error("Error modifying week:",e),{success:!1,messages:[],error:e instanceof Error?e.message:"Unknown error occurred"}}}mapThemeToSessionType(e){let t=e.toLowerCase();return t.includes("run")||t.includes("cardio")||t.includes("hiit")||t.includes("metcon")||t.includes("conditioning")?"cardio":t.includes("lift")||t.includes("strength")||t.includes("upper")||t.includes("lower")||t.includes("push")||t.includes("pull")?"strength":t.includes("mobility")||t.includes("flexibility")||t.includes("stretch")?"mobility":t.includes("rest")||t.includes("recovery")?"recovery":t.includes("assessment")||t.includes("test")?"assessment":t.includes("deload")?"deload":"strength"}}let M=O.getInstance();var D=e.i(466405),_=e.i(840936),N=e.i(36480);class F{static instance;userService;fitnessPlanService;fitnessPlanRepo;workoutModificationService;constructor(){this.userService=d.UserService.getInstance(),this.fitnessPlanService=t.FitnessPlanService.getInstance(),this.fitnessPlanRepo=new _.FitnessPlanRepository(N.postgresDb),this.workoutModificationService=O.getInstance()}static getInstance(){return F.instance||(F.instance=new F),F.instance}async modifyPlan(e){try{let{userId:t,changeRequest:r}=e;console.log("[MODIFY_PLAN] Starting plan modification",{userId:t,changeRequest:r});let s=await this.userService.getUser(t);if(!s)return{success:!1,messages:[],error:"User not found"};let o=await this.fitnessPlanService.getCurrentPlan(t);if(!o)return{success:!1,messages:[],error:"No fitness plan found. Please create a plan first."};let i=(0,I.now)(s.timezone),n=(0,I.getDayOfWeek)(i.toJSDate(),s.timezone);console.log("[MODIFY_PLAN] Running plan and week modifications in parallel");let[a,c]=await Promise.all([D.fitnessPlanAgentService.modifyFitnessPlan(s,o,r),this.workoutModificationService.modifyWeek({userId:t,targetDay:n,changeRequest:r})]);if(!a.wasModified)return console.log("[MODIFY_PLAN] No modifications needed - current plan already satisfies the request"),{success:!0,wasModified:!1,messages:[]};console.log("[MODIFY_PLAN] Plan was modified - saving new version");let u=await this.fitnessPlanRepo.insertFitnessPlan({clientId:t,description:a.description,structured:a.structure,startDate:new Date});return console.log(`[MODIFY_PLAN] Saved new plan version ${u.id}`),c.success?console.log("[MODIFY_PLAN] Week modification completed successfully"):c.error&&console.warn(`[MODIFY_PLAN] Week modification had issues: ${c.error}`),{success:!0,wasModified:!0,modifications:a.modifications,messages:c.messages||[]}}catch(e){return console.error("[MODIFY_PLAN] Error modifying plan:",e),{success:!1,messages:[],error:e instanceof Error?e.message:"Unknown error occurred"}}}}let x=F.getInstance();var W=e.i(703932);function z(e,t="action"){return e.success?{toolType:t,response:e.modifications?`Operation completed: ${e.modifications}`:"Operation completed successfully",messages:e.messages?.length?e.messages:void 0}:{toolType:t,response:`Operation failed: ${e.error||"Unknown error"}`,messages:e.messages?.length?e.messages:void 0}}let $=f.z.object({}),L=f.z.object({}),q=f.z.object({});class j{static async makeModification(e,t,s){console.log("[MODIFICATION_SERVICE] Processing modification request:",{userId:e,message:t.substring(0,100)+(t.length>100?"...":"")});try{var o,i;let n,a,l=await d.userService.getUser(e);if(!l)return console.warn("[MODIFICATION_SERVICE] User not found:",e),{toolType:"action",response:"User not found."};let p=(0,I.now)(l.timezone).toJSDate(),m=(0,I.getWeekday)(p,l.timezone),g=I.DAY_NAMES[m-1],f=await r.workoutInstanceService.getWorkoutByUserIdAndDate(e,p);console.log("[MODIFICATION_SERVICE] Context fetched:",{targetDay:g,workoutDate:p.toISOString(),hasWorkout:!!f,messageCount:s?.length??0});let y=(o={userId:e,message:t,workoutDate:p,targetDay:g},i={modifyWorkout:M.modifyWorkout.bind(M),modifyWeek:M.modifyWeek.bind(M),modifyPlan:x.modifyPlan.bind(x)},n=(0,W.tool)(async()=>z(await i.modifyWorkout({userId:o.userId,workoutDate:o.workoutDate,changeRequest:o.message})),{name:"modify_workout",description:`Regenerate today's workout keeping the SAME muscle group/focus but with different constraints.

NOTE: All parameters (userId, date, request) are automatically filled from context - no input needed.

Use ONLY when the user explicitly wants to keep the same muscle group/workout type but change HOW they do it:
- Same muscle group, different equipment (e.g., "Today is chest - can't make it to my gym, need a chest workout with just dumbbells")
- Same focus, different time (e.g., "Today is leg day but only have 30 min, can you adjust my leg workout?")
- Same workout, different constraints (e.g., "Today's shoulder workout but my shoulder hurts, can you modify it to be gentler?")

IMPORTANT: User must indicate they want to keep the SAME muscle group/workout type.
DO NOT use if user requests a DIFFERENT muscle group or doesn't specify - use modify_week instead.
This is the LEAST commonly used tool - default to modify_week when uncertain.`,schema:$}),a=(0,W.tool)(async()=>z(await i.modifyWeek({userId:o.userId,targetDay:o.targetDay,changeRequest:o.message})),{name:"modify_week",description:`Modify the weekly training pattern and regenerate workouts as needed. **This is the PRIMARY and MOST COMMON tool.**

NOTE: All parameters (userId, targetDay, request) are automatically filled from context - no input needed.

Use this for ANY request for a different workout type or muscle group:
- ANY different muscle group request (e.g., "can I have a leg workout", "chest workout please", "give me back instead")
- ANY different workout type (e.g., "I actually want to run today instead", "cardio today?", "full body workout")
- Rearranging the weekly schedule (e.g., "can we swap my rest days?", "move leg day to Friday")
- Multi-day constraints (e.g., "traveling this week with hotel gym", "only 30 min per day rest of week")

**DEFAULT TO THIS TOOL when user requests a workout change.** Even if they don't explicitly say "instead of" or mention multiple days.

Examples that should use modify_week:
- "Can I do legs today?" -> YES (different muscle group)
- "Chest workout please" -> YES (potentially different from scheduled)
- "I want to run instead" -> YES (different workout type)
- "Can't make it to gym this week" -> YES (multi-day change)

This intelligently updates the weekly pattern to maintain training balance and muscle group spacing.`,schema:L}),[n,a,(0,W.tool)(async()=>z(await i.modifyPlan({userId:o.userId,changeRequest:o.message})),{name:"modify_plan",description:`Modify the user's overall fitness plan/program structure.

NOTE: All parameters (userId, changeRequest) are automatically filled from context - no input needed.

Use when the user wants to change their PROGRAM-LEVEL settings:
- Training frequency changes (e.g., "change from 5 to 6 days a week", "I want to train 4 days instead of 3")
- Adding/removing fixed schedule items (e.g., "add yoga on Monday/Friday mornings", "I joined a spinning class on Wednesdays")
- Changing their training split (e.g., "switch to push/pull/legs", "I want an upper/lower split")
- Adjusting overall goals or focus (e.g., "more cardio", "focus on strength", "add more conditioning")
- Equipment/facility changes (e.g., "I joined a new gym with more equipment", "I only have dumbbells now")

DO NOT use for day-to-day or single week changes - use modify_week or modify_workout instead.
This tool is for STRUCTURAL/ARCHITECTURAL changes to the entire training program.

Examples that should use modify_plan:
- "Can we change to 6 days a week?" -> YES (frequency change)
- "I started yoga on Mondays and Fridays" -> YES (adding anchors)
- "Switch me to a PPL split" -> YES (program structure)
- "I want more cardio overall" -> YES (program balance)

Examples that should NOT use modify_plan:
- "Can I do legs today?" -> NO (use modify_week)
- "Skip today's workout" -> NO (use modify_week)`,schema:q})]),h=T.toMessageArray(s||[]).map(e=>({role:e.role,content:e.content})),w=(e=>{let{user:t}=e,r=new Date,s=(0,I.formatForAI)(r,t.timezone),o=(0,I.getDayOfWeekName)(r,t.timezone);return`## CONTEXT

**Todays Date**: ${s}
**Todays Day of Week**: ${o}
**User Name**: ${t.name}

### User Profile
${t.profile||"No profile available"}

---

**Users Message**: ${e.message}

---

Select the appropriate tool based on the user's request. All parameters (userId, date, targetDay, etc.) are automatically provided from context.`})({user:l,message:t}),S=await (0,c.createAgent)({name:u.PROMPT_IDS.MODIFICATIONS_ROUTER,previousMessages:h,tools:y},{model:"gpt-5-mini"}),v=await S.invoke(w);return console.log("[MODIFICATION_SERVICE] Agent returned:",{messageCount:v.messages?.length??0,response:v.response.substring(0,100)+(v.response.length>100?"...":"")}),{toolType:"action",response:v.response,messages:v.messages}}catch(t){console.error("[MODIFICATION_SERVICE] Error processing modification:",t);let e=t instanceof Error?t.message:"Unknown error occurred";return{toolType:"action",response:`Modification failed: ${e}`}}}}var Y=e.i(203068),B=e.i(875559);e.i(791146);var H=e.i(437234);let{smsMaxLength:V,contextMinutes:G}=(0,B.getChatConfig)();async function K(e,t){try{let s=(0,I.now)(t),o=s.toJSDate(),i=await r.workoutInstanceService.getWorkoutByUserIdAndDate(e,o);if(i)return console.log("[ChatService] Existing workout found for today"),{toolType:"query",response:`User's workout for today: ${i.sessionType||"Workout"} - ${i.description||"Custom workout"}`,messages:i.message?[i.message]:void 0};let n=await d.userService.getUser(e);if(!n)return{toolType:"query",response:"User not found."};console.log("[ChatService] Generating workout for today");let a=await r.workoutInstanceService.generateWorkoutForDate(n,s);if(!a)return{toolType:"query",response:"No workout scheduled for today. This could be a rest day based on the training plan, or the user may not have a fitness plan yet."};return{toolType:"query",response:`User's workout for today: ${a.sessionType||"Workout"} - ${a.description||"Custom workout"}`,messages:a.message?[a.message]:void 0}}catch(e){return console.error("[ChatService] Error getting/generating workout:",e),{toolType:"query",response:`Failed to get workout: ${e instanceof Error?e.message:"Unknown error"}`}}}class J{static async handleIncomingMessage(e){try{var t,r,s,o;let n,a,p=await l.messageService.getRecentMessages(e.id,20),{pending:m,context:g}=l.messageService.splitMessages(p,G);if(0===m.length)return console.log("[ChatService] No pending messages, skipping"),[];let y=m.map(e=>e.content).join("\n\n");console.log("[ChatService] Processing pending messages:",{pendingCount:m.length,contextCount:g.length,aggregatedContent:y.substring(0,100)+(y.length>100?"...":"")});let h=void 0!==e.profile?e:await d.userService.getUser(e.id)||e,w=async e=>{try{await l.messageService.sendMessage(h,e),console.log("[ChatService] Sent immediate message:",e)}catch(e){console.error("[ChatService] Failed to send immediate message:",e)}},S=(t={userId:h.id,message:y,previousMessages:g,timezone:h.timezone},r={makeModification:j.makeModification,getWorkout:K,updateProfile:R.updateProfile},n=(0,W.tool)(async()=>r.updateProfile(t.userId,t.message,t.previousMessages),{name:"update_profile",description:`Record permanent user preferences and profile information.

Use this tool when the user shares PERMANENT information:
- **Preferences**: "I like starting with legs", "I prefer barbells", "I hate lunges"
- **Constraints/Injuries**: "I hurt my knee", "I have a bad shoulder"
- **Schedule preferences**: "I prefer runs on Tuesdays", "I like morning workouts"
- **Goals**: "I want to lose 10lbs", "training for a marathon"
- **Equipment/Location**: "I go to Planet Fitness", "I have a home gym"
- **Settings**: timezone, send time, or name changes

DO NOT use for one-time requests ("switch today to legs") or questions.

IMPORTANT: If user wants BOTH a preference AND a workout change, call BOTH tools.
Example: "Add runs to my plan on Tues/Thurs" -> update_profile (preference) + make_modification (plan change)

All context is automatically provided - no parameters needed.`,schema:f.z.object({})}),s=`Make changes to the user's workout or training program.

Use this tool for:
- **Today's Workout**: Swap exercises, different constraints, different equipment
- **Weekly Schedule**: Change workout type, muscle group, or training day
- **Program-Level**: Frequency, training splits, overall focus

This tool handles WORKOUT CONTENT - not user settings like send time, timezone, or name.
All context (user, message, date, etc.) is automatically provided - no parameters needed.`,o=async()=>r.makeModification(t.userId,t.message,t.previousMessages),a=(0,W.tool)(async e=>{if(e.message)try{await w(e.message),console.log(`[toolWithMessage] Sent: ${e.message}`)}catch(e){console.error("[toolWithMessage] Failed to send:",e)}return o()},{name:"make_modification",description:s,schema:f.z.object({message:f.z.string().describe('REQUIRED. Brief acknowledgment to send immediately (1 sentence). Example: "Got it, switching to legs!"')})}),[n,a,(0,W.tool)(async()=>r.getWorkout(t.userId,t.timezone),{name:"get_workout",description:`Get the user's workout for today.

Use this tool when the user asks about their workout for today, such as:
- "What's my workout today?"
- "What am I doing today?"
- "Send me my workout"
- "What exercises do I have?"

This tool will:
1. Check if a workout already exists for today
2. If not, generate one based on their fitness plan
3. Return the full workout details and send the workout message

IMPORTANT: Only use this for TODAY's workout. Do not use for future dates.
If [CONTEXT: WORKOUT] says "No workout scheduled", use this tool to generate it.
All context is automatically provided - no parameters needed.`,schema:f.z.object({})})]),v=await i.ContextService.getInstance().getContext(h,[Y.ContextType.DATE_CONTEXT,Y.ContextType.CURRENT_WORKOUT]),k=T.toMessageArray(g||[]).map(e=>({role:e.role,content:e.content})),I=await (0,c.createAgent)({name:u.PROMPT_IDS.CHAT_GENERATE,context:v,previousMessages:k,tools:S}),E=await I.invoke(y);console.log(`[ChatService] Agent completed with response length: ${E.response.length}, accumulated messages: ${E.messages?.length||0}`);let b=[E.response,...E.messages||[]].filter(e=>e&&e.trim());if(!b||0===b.length)throw Error("Chat agent returned no messages");return b.filter(e=>e&&e.trim()).map(e=>{let t=e.trim();return t.length>V?t.substring(0,V-3)+"...":t})}catch(t){return console.error("[ChatService] Error handling message:",t),(0,H.getEnvironmentSettings)().isDevelopment&&console.error("Error details:",{userId:e.id,error:t instanceof Error?t.stack:t}),["Sorry, I'm having trouble processing that. Try asking about your workout or fitness goals!"]}}}e.s(["ChatService",()=>J],11206),e.i(172709),e.i(534821),e.i(898990),e.i(23250);var X=e.i(336801),Q=e.i(961691),Z=e.i(297934);let{secretKey:ee}=(0,e.i(832821).getStripeSecrets)(),et=new X.default(ee,{apiVersion:"2023-10-16"});class er{static instance;subscriptionRepo;userRepo;constructor(){this.subscriptionRepo=new Q.SubscriptionRepository,this.userRepo=new Z.UserRepository}static getInstance(){return er.instance||(er.instance=new er),er.instance}async cancelSubscription(e){try{let t=await this.subscriptionRepo.getActiveSubscription(e);if(!t){let t=(await this.subscriptionRepo.findByClientId(e)).find(e=>"cancel_pending"===e.status);if(t)return{success:!0,periodEndDate:new Date(t.currentPeriodEnd)};return{success:!1,error:"No active subscription found"}}let r=await et.subscriptions.update(t.stripeSubscriptionId,{cancel_at_period_end:!0});return await this.subscriptionRepo.scheduleCancellation(t.stripeSubscriptionId),console.log(`[SubscriptionService] Subscription ${t.stripeSubscriptionId} scheduled for cancellation`),{success:!0,periodEndDate:new Date(1e3*r.current_period_end)}}catch(e){return console.error("[SubscriptionService] Cancel failed:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async reactivateSubscription(e){try{let t=(await this.subscriptionRepo.findByClientId(e))[0];if(!t)return await this.createResubscriptionSession(e);if("active"===t.status)return{success:!0,reactivated:!1,requiresNewSubscription:!1};if("cancel_pending"===t.status)try{let e=await et.subscriptions.retrieve(t.stripeSubscriptionId);if("active"===e.status&&e.cancel_at_period_end)return await et.subscriptions.update(t.stripeSubscriptionId,{cancel_at_period_end:!1}),await this.subscriptionRepo.reactivate(t.stripeSubscriptionId),console.log(`[SubscriptionService] Subscription ${t.stripeSubscriptionId} reactivated`),{success:!0,reactivated:!0,requiresNewSubscription:!1}}catch(e){console.error("[SubscriptionService] Stripe reactivation failed:",e)}if("canceled"===t.status||"cancel_pending"===t.status)return await this.createResubscriptionSession(e);return{success:!1,reactivated:!1,requiresNewSubscription:!1,error:"Unknown subscription state"}}catch(e){return console.error("[SubscriptionService] Reactivate failed:",e),{success:!1,reactivated:!1,requiresNewSubscription:!1,error:e instanceof Error?e.message:"Unknown error"}}}async shouldReceiveMessages(e){return null!==await this.subscriptionRepo.findActiveForMessaging(e)}async createResubscriptionSession(e){try{let t=await this.userRepo.findById(e);if(!t)return{success:!1,reactivated:!1,requiresNewSubscription:!0,error:"User not found"};let{publicBaseUrl:r,baseUrl:s}=(0,B.getUrlsConfig)(),o=r||s,{priceId:i}=(0,B.getStripeConfig)(),n=await et.checkout.sessions.create({customer:t.stripeCustomerId||void 0,mode:"subscription",line_items:[{price:i,quantity:1}],success_url:`${o}/api/checkout/session?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${o}/`,metadata:{userId:e},client_reference_id:e});return console.log(`[SubscriptionService] Created resubscription checkout session for user ${e}`),{success:!0,reactivated:!1,requiresNewSubscription:!0,checkoutUrl:n.url||void 0}}catch(e){return console.error("[SubscriptionService] Create checkout session failed:",e),{success:!1,reactivated:!1,requiresNewSubscription:!0,error:e instanceof Error?e.message:"Unknown error"}}}}let es=er.getInstance();e.s(["subscriptionService",0,es],739351);var eo=e.i(13423);e.i(696950);var ei=e.i(501261),en=e.i(517670),ea=e.i(881640),ec=e.i(221078),eu=e.i(649815),el=e.i(94510),ed=e.i(52396),ep=e.i(166194),em=e.i(139765),eg=n;class ef extends eg.BaseRepository{async log(e){await this.db.insertInto("adminActivityLogs").values({actorClientId:e.actorClientId??null,targetClientId:e.targetClientId,action:e.action,payload:JSON.parse(JSON.stringify(e.payload??{})),result:e.result,errorMessage:e.errorMessage??null}).execute()}async listForClient(e,t={}){let r=t.page??1,s=t.pageSize??20;return await this.db.selectFrom("adminActivityLogs").selectAll().where("targetClientId","=",e).orderBy("createdAt","desc").offset((r-1)*s).limit(s).execute()}}e.s(["AdminActivityLogRepository",()=>ef],310752);var ey=e.i(332062),eh=n;class ew extends eh.BaseRepository{async create(e){return await this.db.insertInto("profileUpdates").values(e).returningAll().executeTakeFirstOrThrow()}async getClientUpdates(e,t=10){return await this.db.selectFrom("profileUpdates").where("clientId","=",e).orderBy("createdAt","desc").limit(t).selectAll().execute()}async getRecentUpdates(e=50){return await this.db.selectFrom("profileUpdates").orderBy("createdAt","desc").limit(e).selectAll().execute()}async getUpdatesBySource(e,t=50){return await this.db.selectFrom("profileUpdates").where("source","=",e).orderBy("createdAt","desc").limit(t).selectAll().execute()}async countClientUpdates(e){return Number((await this.db.selectFrom("profileUpdates").where("clientId","=",e).select(this.db.fn.count("id").as("count")).executeTakeFirstOrThrow()).count)}}e.s(["ProfileUpdateRepository",()=>ew],650654);var eS=e.i(733897);let ev=new WeakMap;function ek(e){let t=ev.get(e);if(t)return t;let r={user:new Z.UserRepository(e),message:new ei.MessageRepository(e),profile:new a(e),fitnessPlan:new _.FitnessPlanRepository(e),workoutInstance:new en.WorkoutInstanceRepository(e),microcycle:new ea.MicrocycleRepository(e),subscription:new Q.SubscriptionRepository(e),onboarding:new eo.OnboardingRepository(e),prompt:new ec.PromptRepository(e),dayConfig:new eu.DayConfigRepository(e),messageQueue:new el.MessageQueueRepository(e),shortLink:new ed.ShortLinkRepository(e),referral:new ep.ReferralRepository(e),pageVisit:new em.PageVisitRepository(e),adminActivityLog:new ef(e),uploadedImage:new ey.UploadedImageRepository(e),profileUpdate:new ew(e),userAuth:new eS.UserAuthRepository(e)};return ev.set(e,r),r}e.s(["createRepositories",()=>ek],986904),i.ContextService.initialize({fitnessPlanService:t.fitnessPlanService,workoutInstanceService:r.workoutInstanceService,microcycleService:s.microcycleService,profileRepository:new a}),e.s([],180256)}];

//# sourceMappingURL=packages_shared_src_server_services_index_ts_3cd89005._.js.map